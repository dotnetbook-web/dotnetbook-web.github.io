<!DOCTYPE html>
<html lang="ru">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>.NET Platform Architecture</title>
</head>
<body>
    <link rel="stylesheet" href="../../res/bootstrap.css">
    <link rel="stylesheet" href="../../res/awesome.css">
    <style>

body {
    font-family: PF Regal,Georgia,serif;
    font-size: 16pt;
    font-weight: 300;
    padding-top: 4em;
    background-color: #fdfdfd;
}

.book-title-container {
    width: 100%;
    text-align: center;
    margin: 73px 0 110px 0;
}

.book-title {
    font-size: 57pt;
    margin: 50px 0 70px 0;
    user-select: none;
}
.book-part-title-block {
    display: inline-block;
}
.book-part-title {
    font-size: 21pt;
    color: #656ab6;
    margin: 0 7px;
}

.book-part-title:hover {
    box-shadow: inset 0 -1px #007bff;
    text-decoration: none;
}

.book-superheading-title {
    font-size: 15pt;
    margin: 0 7px;
    color: #656ab6;
}

.article-container
{
    width: 62%;
}

strong {
    font-weight: 500;
}

p, li {
    margin: 0 0 1em;
    line-height: 1.5em;
    font-family: inherit;
}

ol, li {
    margin-top: 1em;
    margin-bottom: 1em;
}

ol {
    padding-left: 1.21em;
}

ul  {
    padding-left: 1em;
}

ol li, ul li {
    padding-left: 0.5em;	
    font-family: inherit;
    text-align: justify;
}

table {
    margin: 30px 0;
    width: 100%;
}

thead {
    background-color: aliceblue;
}

table th {
    font-weight: 400;
}

table td, table th {
    padding: 7px;
    border-top: solid darkgrey 1px;
    border-bottom: solid darkgrey 1px;
    border-right: dotted darkgray 1px;
    border-left: dotted darkgray 1px;
    font-size: smaller;
}

code, *[class*='lang-'] span, *[class*='lang-'] pre {
    font-family: JB Mono, monospace !important;
}

*[class*='lang-'] {
    padding: 0px 0px 25px 0px;
    font-size: 0.75em;
}


*[class*='lang-'] > div, pre > code {
    border-left-color: #eee;
    border-left-style: dotted;
    border-left-width: 3px;
    padding-left: 25px;
    display: block;
    padding-top: 20px;
    padding-bottom: 20px;
}

*[class*='lang-'] > div pre, pre > code pre {
    margin-bottom: 0;
}

p code:not(.highlight), li code:not(.highlight) {
    font-size: 0.7em;
    border: gainsboro;
    border-width: 1px;
    border-style: solid;
    padding: 3px;
    color: darkslateblue;
}

code.highlight {
    font-family: inherit !important;
    font-size: inherit;
    font-weight: inherit;
    color: inherit;
}

p code.highlight, li code.highlight {
    padding: 4px;
    background-color: #ffffa1;
}

.wide {
    width:140%;
}

p a, li a {
    text-decoration: none;
    color: inherit;
    box-shadow: inset 0 -1px #b88b59;
}

p a:hover, li a:hover {
    text-decoration: none;
    color: inherit;
    box-shadow: inset 0 -1px #0056b3;
}

blockquote h5 {
    background-color: aquamarine;
    margin: 16px 0 16px -20px;
    padding: 15px 30px 15px;
}

p img {
    width: 95%;
}

blockquote 
{
    padding-left: 0.4em;
    border-left: 0.5em solid rgba(0,0,0,.08);
    font-style: italic;
}

blockquote.big-quote, 
blockquote.breadcrumbs 
{
    background-color: transparent;
    padding: 0;
    border-left: none;
    font-style: normal;
}

blockquote.breadcrumbs, blockquote.breadcrumbs  p
{
    margin: 0;
    padding: 0;
}

blockquote p {
    padding: 1em 1em 1em 0.6em;
    font-family: inherit;
}

blockquote p code {
    font-family: consolas, monospace;
    font-size: 17px;
    padding: 4px 6px;
}

blockquote p em {
    font-weight: 400;
}

blockquote.big-quote > p {
    margin: 0.7em 0 0.7em 0;
    font-family: Charter;
    font-size: 2.5em;
    padding: 0;
    width: 130%;
    line-height: 1em;
}

h1, h2, h3, h4, h5, h6 {
    margin: 0;
    padding: 0;
    font-weight: 400;
    font-family: inherit;
}

h1 {
    font-size: 2.2em;
    font-family: Charter,Georgia,serif;
    font-weight: 300;
    margin: 1.8em 0 1.8em 0;
    text-align: center;
    width: 140%;
}

h2 {
    margin-top: 2em;
    font-family: Charter,Arial,Helvetica Neue,sans-serif;
    font-size: 1.25em;
    width: 70%;
}

h3 {
    margin: 30px 0 15px 0;
    font-size: 17pt;
    font-weight: 500;
}

h4 {
    margin: 20px 0 10px 0;
    font-size: 16pt;
    font-weight: 500;
    font-style: italic;
}

/* Sidenotes */

.aside-container {
    position: relative;
}
.aside-container p {
    position: relative;
    top: 9px;
}

.aside-container > .aside-side-container {
    display: block;
    position: absolute;
    top: 12px;
    left: 96%;
    width: 34%;
    font-size: 12pt;
    line-height: 20px;
    margin-left: 100px;
    z-index: 1000;
}

.aside-container > .aside-side-container p {
    line-height: 24px;
    font-size: 13pt;
    margin: 0 0 13px 0;
}

.side-regular-block p {
    top: 0;
}

/* Music side player */
.aside-side-container .music-player {
    width: 100%;
    height: 400px;
}

/* media block after h1 */
.aside-container h1 + .aside-side-container.side-media-block h2 {
    margin: 7em 0 1em 0;
    font-family: Proxima Nova,Arial,Helvetica Neue,sans-serif;
    font-weight: 600;
}

.aside-side-container > li {
    display: block;
    font-family: Charter;
}

.aside-side-container > li ul, .aside-side-container > li ol {
    padding-left: 30px;
    margin-top: 0.5em;
    margin-bottom: 0.5em;
}
.aside-side-container > li li {
    padding-left: 6px;
    margin: 0 0 6px;
    line-height: 22px;

    font-family: Charter;
}

.aside-side-container p {
    line-height: 25px;
    font-size: 13pt;
    margin: 0 0 15px 0;
}

.aside-side-container blockquote {
    border: aliceblue;
    border-left-style: solid;
}

/* Paragraphs numbering */
.paragraph-container {
    position: relative;
}
.paragraph-container p {
    position: relative;
    top: 9px;
}

.paragraph-container p, .aside-container > p {
    text-align: justify;
}

.paragraph-container > .paragraph-left-side, .paragraph-container > .paragraph-right-side  {
    font-family: JB Mono, consolas;
    display: block;
    position: absolute;
    top: 17px;
    font-size: 10pt;
    line-height: 20px;
    color: #86abc473;
    z-index: 1000;
}
.paragraph-container > .paragraph-left-side {
    display: none;
    left: -2.1cm;
    width: 35px;
    user-select: none;
}

.paragraph-container > .paragraph-right-side  {
    display: none;
    left: 100%;
    width: 35px;
    padding-left: 45px;
    user-select: none;
}

.article-container
{
    width: 70%;
}

/* X_MENU */
.menu-title {
    text-align: center;
    margin: 35px 50px 35px 50px;
    font-size: 24pt;
    font-family: Charter;
}

.menu-container ol {
    margin: 0;
    padding: 0;
}

.menu-container ol li {
    margin: 0;
    padding: 0;
}

.header {
    height: 4em;
    background-color: white;
    position: relative;
    z-index: 1500;
    width: 100%;
    display: flex;
    justify-content: space-between;
    transition: all 1s;
    top: 0;
    box-shadow: 1px -4px 20px rgba(0, 0, 0, .1);
}

.fixed {
    position: fixed !important;
}

.header > .menu {
    pointer-events: auto;
    float: right;
    height: 40px;
    font-family: Charter, 'Helvetica Neue', Arial, sans-serif;
    font-size: 1em;
    color: #fff;
    margin-top:40px;
    margin-right:40px;
}

.menu a {
    color: #fff;
}
.menu a:hover {
    text-decoration: none;
    color: #fff;
}

#menu__toggle {
    opacity: 0;
}

#menu__toggle:checked ~ .menu__btn > span {
    transform: rotate(45deg);
}
#menu__toggle:checked ~ .menu__btn > span::before {
    top: 0;
    transform: rotate(0);
    background-color: black
}
#menu__toggle:checked ~ .menu__btn > span::after {
    top: 0;
    transform: rotate(90deg);
    background-color: black
}
#menu__toggle:checked ~ .menu__box {
    visibility: visible;
    right: 0;
}

.menu__btn {
    display: flex;
    align-items: center;
    position: fixed;
    top: 0;
    right: 0;
    width: 1.4em;
    height: 1.0em;
    cursor: pointer;
    z-index: 1;
    margin: 1.5em;
}

.menu__btn > span,
.menu__btn > span::before,
.menu__btn > span::after {
    display: block;
    position: absolute;

    width: 100%;
    height: 1px;

    background-color: black;

    transition-duration: .25s;
}
.menu__btn > span::before {
    content: '';
    top: -8px;
}
.menu__btn > span::after {
    content: '';
    top: 8px;
}

.menu__box {
    display: block;
    position: fixed;
    visibility: hidden;
    top: 0;
    right: -100%;

    width: 100%;
    height: 100%;

    margin: 0;
    padding: 80px 0;

    list-style: none;

    background-color: white;
    box-shadow: 1px 0px 6px rgba(0, 0, 0, .2);

    transition-duration: .25s;
}
.menu__box li a:hover {
    text-decoration: none;
    color: inherit;
}
.menu__list {
    margin: 0 2em 0 2em;
}
.menu__list li {
    text-align: left;
}

/* X_HEADER */

.conflogo {
    height: 1.2em;
    margin: 0.95em 0 0 1em;
    font-size: 1.5em;
    font-family: Charter;
}

.invisible {
    display: none;
}

.header > .menu > div {
    display: inline;
    margin-left: 10px;
    margin-right: 10px;
}

.menu__header_current
{
    text-align: center;
    font-size: 2em;
    margin: 0 0 1em 0;
}

.menu__header_total
{
    text-align: center;
    font-size: 2em;
    margin: 1.5em 0 1em 0;
}

/* X_FOOTER */

footer {
    margin-top: 2em;
    background-color: black;
    height: 4em;
}

.footer-container {
    height: 100%;
}

.footer-wrap {
    color: #fff;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 25px 0;
}

.footer-wrap p {
    margin: 0;
    padding: 0px;
    line-height: 1em;
}

.footer-container img {
    height: 1.6em;
    margin-top: auto;
    margin-bottom: auto;
}

.footer-link {
    color: white;
    margin: 0 7px;
    font-size: 1em;
    box-shadow: none;
}

.footer-link:hover {
    color: salmon;
    box-shadow: none;
}

/* MEDIA */
/* XXL */
@media (min-width: 1601px) {
    .book-container
    {
        max-width: 1200px;
        margin-left: auto;
        margin-right: auto;
    }
}

/* XL */
@media (max-width: 1600px) {
    .book-container
    {
        margin-left: 4cm;
        margin-right: 4cm;
    }
}

/* LG */
@media (max-width: 1400px) {
    .book-container
    {
        margin-left: 4cm;
        margin-right: 4cm;
    }

    blockquote.big-quote > p {
        font-size: 2em;
    }
}

/* > MD */
@media (min-width: 992px) {
    .hamburger-menu {
        display: none;
    }
}

/* MD */
@media (max-width: 991px) {
    
    h2 {
        width:80%;
    }

    .book-container
    {
        margin-left: 3cm;
        margin-right: 3cm;
    }
    
    .book-title-container {
        margin: 73px 0 110px 0;
    }

    .book-title {
        font-size: 50pt;
        margin: 50px 0 70px 0;
    }

    .book-part-title {
        font-size: 19pt;
    }

    .book-part-title:hover {
        box-shadow: inset 0 -1px #007bff;
    }

    .book-superheading-title {
        font-size: 15pt;
    }                                     

    .article-container, h1 {
        width: 100%;
    }

    .aside-container p {
        top: 0;
    }

    .aside-container h1 + .aside-side-container.side-media-block h2 {
        display: none;
    }

    .wide {
        width: 100%;     
    }

    .side-regular-block {
        margin: 40px 10px;
        padding-left: 100px;
    }
    .aside-side-container .music-player {
        width: 100%;
        height: 100px;
    }
    .aside-side-container.side-media-block {
        padding: 17px 0;
    }
    .aside-side-container.side-media-block h2 {
        margin-top: 20px;
        font-size: 13pt;
        border: none;
    }

    .aside-container > .aside-side-container
    {
        position: relative;
        top: auto;
        left: auto;
        width: auto;
        height: auto;
        margin: 0;
        padding: 17px;
    }

    blockquote.big-quote > p {
        width: 100%;
        font-size: 2em;
    }

    .paragraph-container .paragraph-left-side {
        left: -55px;
    }

    body {
        font-size: 15pt;
    }

    p code:not(.highlight), li code:not(.highlight) {
        font-size: 11pt;
    }

    p, li {
        line-height: 30px;
    }
    
    li {
        margin: 0 0 10px 0;
    }

    .side-regular-block {
        border-radius: 5px;
        background-image: linear-gradient(180deg,hsla(0,0%,100%,0) 60%,#fff),linear-gradient(70deg,#dbedff 32%,#ebfff0);
        padding: 22px;
    }    

    .menu__list
    {
        margin: 0 auto 0 auto;
        max-width: 800px;
        width: 80%;
    }

    .book-container 
    {
        position: absolute;
        padding: 0 3cm 0 3cm;
        overflow: scroll;
        overflow-x: auto;
        top: 4em;
        bottom: 0;
        width: 100%;
        margin: 0;
    }

    footer {
        margin-top: 2em;
        background-color: black;
        height: 4em;
    }

    footer > div {
        position: relative;
        margin: 0 -3cm;
        background: black;
        padding: 0 3cm;
    }
}

/* Smartphone horizontal - SM */
@media (max-width: 767px) {
    .book-title-container {
        margin: 73px 0 110px 0;
    }

    h1 {
        margin: 1.8em 0em 1.8em 0.3em;
    }

    .book-title {
        font-size: 40pt;
        margin: 50px 0 70px 0;
    }

    .book-part-title {
        font-size: 19pt;
    }

    .book-part-title:hover {
        box-shadow: inset 0 -1px #007bff;
    }

    .book-superheading-title {
        font-size: 17pt;
    }

    .book-container {
        padding: 0 2.5cm;
    }
    ul {
        margin-left: 30px;
        margin-right: 30px;
        padding-left: 25px;
    }
    .paragraph-container > .paragraph-left-side {
	    display: block;
        top: 14px;
        font-size: 9pt;
    }
    .paragraph-container > .paragraph-right-side {
    	display: block;
        padding-left: 40px;
        top: 14px;
        font-size: 9pt;
    }
    .footer-container img {
        height: 1.3em;
    } 
}

@media (max-width: 630px) {
    .book-container {
        padding: 0 1.5cm;
    }
    .paragraph-container > .paragraph-left-side {
        left: -33px;
    }
    .paragraph-container > .paragraph-right-side {
        padding-left: 24px;
    }
}
/* Smartphone - XS */
@media (max-width: 575px) {
    .book-container {
        padding: 0 50px 0 30px;
    }
    ul {
        margin: 0;
        padding-left: 20px;
    }

    body {
        font-size: 13pt;
    }

    p code:not(.highlight), li code:not(.highlight) 
    {
        font-size: 10pt;
        padding: 3px;
    }
   
    p, li {
        line-height: 24px;
    }    
    
    .paragraph-container .paragraph-left-side 
    {
        display: none;        
    }
    .paragraph-container .paragraph-right-side 
    {
        padding-left: 21px;
        top: 14px;
	    font-size: 8pt;
    }
    .footer-container img {
        height: 1em;
    } 
    .menu__list {
        margin: 0 1em 0 1em;
    }
}

/* Fonts */

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-Bold.eot');
    src: local('../../res/fonts/PFRegalTextPro-Bold'),
        url('../../res/fonts/PFRegalTextPro-Bold.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-Bold.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-Bold.ttf') format('truetype');
    font-weight: bold;
    font-style: normal;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-Medium.eot');
    src: local('../../res/fonts/PFRegalTextPro-Medium'),
        url('../../res/fonts/PFRegalTextPro-Medium.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-Medium.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-Medium.ttf') format('truetype');
    font-weight: 500;
    font-style: normal;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-BlackItalic.eot');
    src: local('../../res/fonts/PFRegalTextPro-BlackItalic'),
        url('../../res/fonts/PFRegalTextPro-BlackItalic.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-BlackItalic.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-BlackItalic.ttf') format('truetype');
    font-weight: 900;
    font-style: italic;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-Black.eot');
    src: local('../../res/fonts/PFRegalTextPro-Black'),
        url('../../res/fonts/PFRegalTextPro-Black.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-Black.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-Black.ttf') format('truetype');
    font-weight: 900;
    font-style: normal;
}

@font-face {
    font-family: 'PF Regal UBlack';
    src: url('../../res/fonts/PFRegalTextPro-UBlack.eot');
    src: local('../../res/fonts/PFRegalTextPro-UBlack'),
        url('../../res/fonts/PFRegalTextPro-UBlack.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-UBlack.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-UBlack.ttf') format('truetype');
    font-weight: 900;
    font-style: normal;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-MediumItalic.eot');
    src: local('../../res/fonts/PFRegalTextPro-MediumItalic'),
        url('../../res/fonts/PFRegalTextPro-MediumItalic.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-MediumItalic.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-MediumItalic.ttf') format('truetype');
    font-weight: 500;
    font-style: italic;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-UBlackItalic.eot');
    src: local('../../res/fonts/PFRegalTextPro-UBlackItalic'),
        url('../../res/fonts/PFRegalTextPro-UBlackItalic.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-UBlackItalic.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-UBlackItalic.ttf') format('truetype');
    font-weight: 900;
    font-style: italic;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-RegularAItalic.eot');
    src: local('../../res/fonts/PFRegalTextPro-RegularAItalic'),
        url('../../res/fonts/PFRegalTextPro-RegularAItalic.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-RegularAItalic.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-RegularAItalic.ttf') format('truetype');
    font-weight: 300;
    font-style: italic;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-BoldItalic.eot');
    src: local('../../res/fonts/PFRegalTextPro-BoldItalic'),
        url('../../res/fonts/PFRegalTextPro-BoldItalic.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-BoldItalic.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-BoldItalic.ttf') format('truetype');
    font-weight: bold;
    font-style: italic;
}

@font-face {
    font-family: 'Charter';
    src: url('../../res/fonts/charter-regular.woff2') format('woff2');
    font-weight: normal;
    font-style: normal;
}

/*  Regular B */
@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-RegularBItalic.eot');
    src: local('../../res/fonts/PFRegalTextPro-RegularBItalic'),
        url('../../res/fonts/PFRegalTextPro-RegularBItalic.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-RegularBItalic.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-RegularBItalic.ttf') format('truetype');
    font-weight: 300;
    font-style: italic;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-RegularB.eot');
    src: local('../../res/fonts/PFRegalTextPro-RegularB'),
        url('../../res/fonts/PFRegalTextPro-RegularB.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-RegularB.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-RegularB.ttf') format('truetype');
    font-weight: 300;
    font-style: normal;
}

@font-face {
    font-family: 'JB Mono';
    src: url('../../res/fonts/JetBrainsMono-Regular.eot');
    src: local('../../res/fonts/JetBrainsMono-Regular'),
        url('../../res/fonts/JetBrainsMono-Regular.woff2') format('woff2'),
        url('../../res/fonts/JetBrainsMono-Regular.woff') format('woff'),
        url('../../res/fonts/JetBrainsMono-Regular.ttf') format('truetype');
    font-weight: 300;
    font-style: normal;
}
@font-face {
    font-family: 'JB Mono';
    src: url('../../res/fonts/JetBrainsMono-Italic.eot');
    src: local('../../res/fonts/JetBrainsMono-Italic'),
        url('../../res/fonts/JetBrainsMono-Italic.woff2') format('woff2'),
        url('../../res/fonts/JetBrainsMono-Italic.woff') format('woff'),
        url('../../res/fonts/JetBrainsMono-Italic.ttf') format('truetype');
    font-weight: 300;
    font-style: italic;
}

@font-face {
    font-family: 'JB Mono';
    src: url('../../res/fonts/JetBrainsMono-Medium.eot');
    src: local('../../res/fonts/JetBrainsMono-Medium'),
        url('../../res/fonts/JetBrainsMono-Medium.woff2') format('woff2'),
        url('../../res/fonts/JetBrainsMono-Medium.woff') format('woff'),
        url('../../res/fonts/JetBrainsMono-Medium.ttf') format('truetype');
    font-weight: 500;
    font-style: normal;
}
@font-face {
    font-family: 'JB Mono';
    src: url('../../res/fonts/JetBrainsMono-Medium-Italic.eot');
    src: local('../../res/fonts/JetBrainsMono-Medium-Italic'),
        url('../../res/fonts/JetBrainsMono-Medium-Italic.woff2') format('woff2'),
        url('../../res/fonts/JetBrainsMono-Medium-Italic.woff') format('woff'),
        url('../../res/fonts/JetBrainsMono-Medium-Italic.ttf') format('truetype');
    font-weight: 500;
    font-style: italic;
}
@font-face {
    font-family: 'Font Awesome 5 Free';
    font-style: normal;
    font-weight: 400;
    font-display: swap;
    src: url("../../res/fonts/webfonts/fa-regular-400.eot");
    src: url("../../res/fonts/webfonts/fa-regular-400.eot?#iefix") format("embedded-opentype"), 
         url("../../res/fonts/webfonts/fa-regular-400.woff2") format("woff2"), 
         url("../../res/fonts/webfonts/fa-regular-400.woff") format("woff"), 
         url("../../res/fonts/webfonts/fa-regular-400.ttf") format("truetype"), 
         url("../../res/fonts/webfonts/fa-regular-400.svg#fontawesome") format("svg"); 
    font-display: swap;
}
    
.fa {
    font-family: 'Font Awesome 5 Free';
    font-weight: 400;
    font-display: swap;
}
@font-face {
  font-family: 'Font Awesome 5 Brands';
  font-style: normal;
  font-weight: 400;
  font-display: auto;
  src: url("../../res/fonts/fa-brands-400.eot");
  src: url("../../res/fonts/fa-brands-400.eot?#iefix") format("embedded-opentype"), url("../../res/fonts/fa-brands-400.woff2") format("woff2"), url("../../res/fonts/fa-brands-400.woff") format("woff"), url("../../res/fonts/fa-brands-400.ttf") format("truetype"), url("../../res/fonts/fa-brands-400.svg#fontawesome") format("svg"); 
}

.fab {
  font-family: 'Font Awesome 5 Brands';
  font-weight: 400; 
}

@font-face {
  font-family: 'Font Awesome 5 Free';
  font-style: normal;
  font-weight: 400;
  font-display: auto;
  src: url("../../res/fonts/fa-regular-400.eot");
  src: url("../../res/fonts/fa-regular-400.eot?#iefix") format("embedded-opentype"), url("../../res/fonts/fa-regular-400.woff2") format("woff2"), url("../../res/fonts/fa-regular-400.woff") format("woff"), url("../../res/fonts/fa-regular-400.ttf") format("truetype"), url("../../res/fonts/fa-regular-400.svg#fontawesome") format("svg"); 
}

.far {
  font-family: 'Font Awesome 5 Free';
  font-weight: 400; 
}

@font-face {
  font-family: 'Font Awesome 5 Free';
  font-style: normal;
  font-weight: 900;
  font-display: auto;
  src: url("../../res/fonts/fa-solid-900.eot");
  src: url("../../res/fonts/fa-solid-900.eot?#iefix") format("embedded-opentype"), url("../../res/fonts/fa-solid-900.woff2") format("woff2"), url("../../res/fonts/fa-solid-900.woff") format("woff"), url("../../res/fonts/fa-solid-900.ttf") format("truetype"), url("../../res/fonts/fa-solid-900.svg#fontawesome") format("svg"); 
}
</style>  
    <!--
    <div class="book-title-container d-none d-md-block">
        <div class="book-title">Knowledge Base</div>
        <div class="book-part-title-block">pt.1 <a href="../..//ru/Memory/01-00-MemoryManagement-Intro.html" class="book-part-title">Управление памятью</a></div>
        <div class="book-part-title-block">pt.2 <a href="../..//ru/Execution/02-00-ExecutionFlow-Intro.html" class="book-part-title">Поток исполнения команд</a></div>
        <br><a href="#" class="book-superheading-title">Обоснование выбора</a>
        / <a href="#" class="book-superheading-title">Упрощенное описание</a>
        / <a href="#" class="book-superheading-title">Подробное описание</a>
    </div>
    -->
    <header class="header fixed">
        <p class="conflogo">KB</p> 
        <div class="menu">
            <div><a href="index.html">О конференции</a></div>
            <div><a href="mentor.html">Ментор</a></div>
            <div><a href="practice.html">Практика</a></div>
            <div><a href="matrix.html">Доклады</a></div>
            <a href="register.html" class="register_button">РЕГИСТРАЦИЯ</a>
        </div>

        <!-- mobile-menu -->

        <div class="hamburger-menu">
            <input id="menu__toggle" type="checkbox" />
            <label class="menu__btn" for="menu__toggle">
              <span></span>
            </label>
        
            <div class="menu__box">
                <p class="menu__header_current">На странице</p>
                <ol class="menu__list">
                    <li><a href="#overview">
Overview</a></li>
<li><a href="#return-codes-vs.exception">
Return codes vs. exception</a></li>
<li><a href="#try-catch-finally-in-brief">
Try-Catch-Finally in brief</a></li>

                </ol>
                <p class="menu__header_total">Содержание</p>
                <ul style="padding: 0;">
                    <li style="
                        display: inline-block;
                        width: 100%;
                        margin: 0;
                        text-align: center;
                        font-size: 1.2em;
                        font-family: charter;
                        ">
                        <p>Управление памятью</p>
                        <ul>
                            <li>A</li>
                            <li>B</li>
                            <li>C</li>
                        </ul>
                    </li>
                    <li style="
                        display: inline-block;
                        width: 100%;
                        margin: 0;
                        text-align: center;
                        font-family: charter;
                        font-size: 1.2em;
                        ">
                        <p>Поток исполнения команд</p>
                        <ul>
                            <li>A</li>
                            <li>B</li>
                            <li>C</li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </header>

    <div class="book-container">
        <div class="article-container">
            <!--<p class="d-xs-block d-sm-none">XS</p>
            <p class="d-none d-xs-block d-sm-none">SM</p>
            <p class="d-none d-sm-block d-md-none">MD</p>
            <p class="d-none d-lg-block d-xl-none">LG</p>
            <p class="d-none d-xl-block">XL</p> -->
            <h1 id="exceptions">Exceptions</h1>
<blockquote>
<p >
<a href="https://github.com/sidristij/dotnetbook/issues/51">A link to the discussion</a></p>
</blockquote>
<div class="paragraph-container">
<div class="paragraph-left-side">01</div>
<p >
It’s time to talk about exceptions or, rather, exceptional situations. Before we start, let’s look at the definition. What is an exceptional situation?</p>
<div class="paragraph-right-side">01</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">02</div>
<p >
This is a situation that makes the execution of current or subsequent code incorrect. I mean different from how it was designed or intended. Such a situation compromises the integrity of an application or its part, e.g. an object. It brings the application into an extraordinary or exceptional state.</p>
<div class="paragraph-right-side">02</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">03</div>
<p >
But why do we need to define this terminology? Because it will keep us in some boundaries. If we don’t follow the terminology, we can get too far from a designed concept which may result in many ambiguous situations. Let’s see some practical examples:</p>
<div class="paragraph-right-side">03</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
 <span style="color:Blue;">struct</span> Number
 {
     <span style="color:Blue;">public</span> <span style="color:Blue;">static</span> Number Parse(<span style="color:Blue;">string</span> source)
     {
         <span style="color:Green;">// ...</span>
         <span style="color:Blue;">if</span>(!parsed)
         {
             <span style="color:Blue;">throw</span> <span style="color:Blue;">new</span> ParsingException();
         }
         <span style="color:Green;">// ...</span>
     }

     <span style="color:Blue;">public</span> <span style="color:Blue;">static</span> <span style="color:Blue;">bool</span> TryParse(<span style="color:Blue;">string</span> source, <span style="color:Blue;">out</span> Number result)
     {
        <span style="color:Green;">// ..</span>
        <span style="color:Blue;">return</span> parsed;
     }
 }
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">04</div>
<p >
This example seems a little strange, and it is for a reason. I made this code slightly artificial to show the importance of problems appearing in it. First, let’s look at the <code>Parse</code> method. Why should it throw an exception?</p>
<div class="paragraph-right-side">04</div>
</div>
<ul>
<li>
<p >
Because the parameter it accepts is a string, but its output is a number, which is a value type. This number can’t indicate validity of calculations: it just exists. In other words, the method has no means in its interface to communicate a potential problem.</p>
</li>
<li>
<p >
On the other hand, the method expects a correct string that contains some number and no redundant characters. If it doesn’t contain, there is a problem in prerequisites to the method: the code which calls our method has passed wrong data.</p>
</li>
</ul>
<div class="paragraph-container">
<div class="paragraph-left-side">05</div>
<p >
Thus, the situation when this method gets a string with incorrect data is exceptional because the method can return neither a correct value nor anything.  Thus, the only way is to throw an exception.</p>
<div class="paragraph-right-side">05</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">06</div>
<p >
The second variant of the method can signal some problems with input data: the return value here is <code>boolean</code> which indicates successful execution of the method. This method doesn’t need to use exceptions to signal any problems: they are all covered by the <code>false</code> return value.</p>
<div class="paragraph-right-side">06</div>
</div>
<h2 id="overview">Overview</h2>
<div class="paragraph-container">
<div class="paragraph-left-side">07</div>
<p >
Exceptions handling might look as easy as ABC: we just need to place <code>try-catch</code> blocks and wait for corresponding events. However, this simplicity became possible due to the tremendous work of CLR and CoreCLR teams that unified all the errors that come from all directions and sources into the CLR. To understand what we are going to talk about next, let’s look at a diagram:</p>
<div class="paragraph-right-side">07</div>
</div>
<p >
<img src="./imgs/CommonScheme.png" alt="" /></p>
<div class="paragraph-container">
<div class="paragraph-left-side">08</div>
<p >
We can see that inside big .NET Framework there are two worlds: everything that belongs to CLR and everything that doesn’t, including all possible errors appearing in Windows and other parts of the unsafe world.</p>
<div class="paragraph-right-side">08</div>
</div>
<ul>
<li>
<p >
Structured Exception Handling (SEH) is a standard way Windows handles exceptions. When <code>unsafe</code> methods are called and exceptions are thrown, there is the unsafe <-> CLR conversion of exceptions in both directions: from unsafe to CLR and backward. This is because CLR can call an unsafe method which can call a CLR method in turn.</p>
</li>
<li>
<p >
Vectored Exception Handling (VEH) is a root of SEH and allows you to put your handlers in places where exceptions might be thrown. In particular, it used for placing <code>FirstChanceException</code>.</p>
</li>
<li>
<p >
COM+ exceptions appear when the source of a problem is a COM component. In this case, a layer between COM and a .NET method must convert a COM error into a .NET exception.</p>
</li>
<li>
<p >
And, of course, wrappers for HRESULT. They are introduced to convert a WinAPI model (an error code is contained in a return value, while return values are obtained using method parameters) into a model of exceptions because it is an exception that is standard for .NET.</p>
</li>
</ul>
<div class="paragraph-container">
<div class="paragraph-left-side">09</div>
<p >
On the other hand, there are languages above CLI each of which more or less have functions for handling exceptions. For example, recently VB.NET or F# had a richer exception handling functionality expressed in a number of filters that didn’t exist in C#.</p>
<div class="paragraph-right-side">09</div>
</div>
<h2 id="return-codes-vs.exception">Return codes vs. exception</h2>
<div class="paragraph-container">
<div class="paragraph-left-side">10</div>
<p >
Separately, I should mention a model of handling application errors using return codes. The idea of simply returning an error is plain and clear. Moreover, if we treat exceptions as a <code>goto</code> operator, the use of return codes becomes more reasonable: in this case, the user of a method sees the possibility of errors and can understand which errors may occur. However, let’s not guess what is better and for what, but discuss the problem of choice using a well reasoned theory.</p>
<div class="paragraph-right-side">10</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">11</div>
<p >
Let’s suppose that all methods have interfaces to deal with errors. Then all methods would look like:</p>
<div class="paragraph-right-side">11</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">public</span> <span style="color:Blue;">bool</span> TryParseInteger(<span style="color:Blue;">string</span> source, <span style="color:Blue;">out</span> <span style="color:Blue;">int</span> result);

<span style="color:Blue;">public</span> DialogBoxResult OpenDialogBox(...);
<span style="color:Blue;">public</span> WebServiceResult IWebService.GetClientsList(...);

<span style="color:Blue;">public</span> <span style="color:Blue;">class</span> DialogBoxResult : ResultBase { ... }
<span style="color:Blue;">public</span> <span style="color:Blue;">class</span> WebServiceResult : ResultBase { ... }
</pre></div>
</div>
<p >
And their use would look like:</p>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>

<span style="color:Blue;">public</span> ShowClientsResult ShowClients(<span style="color:Blue;">string</span> <span style="color:Blue;">group</span>)
{
    <span style="color:Blue;">if</span>(!TryParseInteger(<span style="color:Blue;">group</span>, <span style="color:Blue;">out</span> <span style="color:Blue;">var</span> clientsGroupId))
        <span style="color:Blue;">return</span> <span style="color:Blue;">new</span> ShowClientsResult { Reason = ShowClientsResult.Reason.ParsingFailed };

    <span style="color:Blue;">var</span> webResult = _service.GetClientsList(clientsGroupId);
    <span style="color:Blue;">if</span>(!webResult.Successful)
    {
        <span style="color:Blue;">return</span> <span style="color:Blue;">new</span> ShowClientsResult { Reason = ShowClientsResult.Reason.ServiceFailed, WebServiceResult = webResult };
    }

    <span style="color:Blue;">var</span> dialogResult = _dialogsService.OpenDialogBox(webResult.Result);
    <span style="color:Blue;">if</span>(!dialogResult.Successful)
    {
        <span style="color:Blue;">return</span> <span style="color:Blue;">new</span> ShowClientsResult { Reason = ShowClientsResult.Reason.DialogOpeningFailed, DialogServiceResult = dialogResult };
    }

    <span style="color:Blue;">return</span> ShowClientsResult.Success();
}
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">12</div>
<p >
You may think this code is overloaded with error handling. However, I would like you to reconsider your position: everything here is an emulation of a mechanism that throws and handles exceptions.</p>
<div class="paragraph-right-side">12</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">13</div>
<p >
How can a method report a problem? It can do it by using an interface for reporting errors. For example, in <code>TryParseInteger</code> method such interface is represented by a return value: if everything is OK, the method will return <code>true</code>. If it’s not OK, it will return <code>false</code>. However, there is a disadvantage here: the real value is returned via <code>out int result</code> parameter. The disadvantage is that on the one hand the return value is logically and by perception has more "return value” essence than that of <code>out</code> parameter. On the other hand, we don’t always care about errors. Indeed, if a string intended for parsing comes from a service that generated this string, we don’t need to check it for errors: the string will always be correct and good for parsing. However, suppose we take another implementation of the method:</p>
<div class="paragraph-right-side">13</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">public</span> <span style="color:Blue;">int</span> ParseInt(<span style="color:Blue;">string</span> source);
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">14</div>
<p >
Then, there is a question: if a string does have errors, what should the method do? Should it return zero? This won’t be correct: there is no zero in the string. In this case, we have a conflict of interests: the first variant has too much code, while the second variant has no means to report errors. However, it’s actually easy to decide when to use return codes and when to use exceptions.</p>
<div class="paragraph-right-side">14</div>
</div>
<blockquote>
<p >
If getting an error is a norm, choose a return code. For example, it is normal when a text parsing algorithm encounters errors in a text, but if another algorithm that works with a parsed string gets an error from a parser, it can be critical or, in other words, exceptional.</p>
</blockquote>
<h2 id="try-catch-finally-in-brief">Try-Catch-Finally in brief</h2>
<div class="paragraph-container">
<div class="paragraph-left-side">15</div>
<p >
A <code>try</code> block covers a section where a programmer expects to get a critical situation which is treated as a norm by external code. In other words, if some code considers its internal state inconsistent based on some rules and throws an exception, an external system, which has a broader view of the same situation, can catch this exception using a <code>catch</code> block and normalize the execution of application code. Thus, <em>you legalize exceptions in this section of code by catching them</em>. I think it is an important idea that justifies the ban on catching all <code>try-catch(Exception ex){ ...}</code> exceptions <em>just in case</em>.</p>
<div class="paragraph-right-side">15</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">16</div>
<p >
It doesn’t mean that catching exceptions contradicts some ideology. I say that you should catch only the errors that you expect from a particular section of code. For example, you can’t expect all types of exceptions inherited from <code>ArgumentException</code> or you can’t get <code>NullReferenceException</code>, because often it means that a problem is rather in <em>your</em> code than in a called one. But it’s appropriate to expect that you won’t be able to open an intended file. Even if you 200% sure you will be able, don’t forget to check.</p>
<div class="paragraph-right-side">16</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">17</div>
<p >
The <code>finally</code> block is also well known. It is suitable for all cases covered by <code>try-catch</code> blocks. Except for several rare <em>special</em> situations, this block will <em>always</em> work. Why was such a guarantee of performance introduced? To clean up those resources and groups of objects which were allocated or captured in <code>try</code> block and which this block has responsibility for.</p>
<div class="paragraph-right-side">17</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">18</div>
<p >
This block is often used without <code>catch</code> block when we don’t care which error broke an algorithm, but we need to clean up all resources allocated for this algorithm. Let’s look at a simple example: a file copying algorithm needs two open files and a memory range for a cash buffer. Imagine that we allocated memory and opened one file, but couldn’t open another one. To wrap everything in one "transaction” atomically we put all three operations in a single <code>try</code> block (as a variant of implementation) with resources cleaned in <code>finally</code>. It may seem like a simplified example but the most important is to show the essence.</p>
<div class="paragraph-right-side">18</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">19</div>
<p >
What C# actually lacks is a <code>fault</code> block which is activated whenever an error occurs. It’s like <code>finally</code> on steroids. If we had this, we could, for example, create a single entry point to log exceptional situations:</p>
<div class="paragraph-right-side">19</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">try</span> {
    <span style="color:Green;">//...</span>
} fault exception
{
    _logger.Warn(exception);
}

</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">20</div>
<p >
Another thing I should touch in this introduction is exception filters. It is not a new feature on the .NET platform but C# developers may be new to it: exception filtering appeared only in v. 6.0. Filters should normalize a situation when there is a single type of exception that combines several types of errors. It should help us when we want to deal with a particular scenario but have to catch the whole group of errors first and filter them later. Of course, I mean the code of the following type:</p>
<div class="paragraph-right-side">20</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">try</span> {
    <span style="color:Green;">//...</span>
}
<span style="color:Blue;">catch</span> (ParserException exception)
{
    <span style="color:Blue;">switch</span>(exception.ErrorCode)
    {
        <span style="color:Blue;">case</span> ErrorCode.MissingModifier:
            <span style="color:Green;">// ...</span>
            <span style="color:Blue;">break</span>;
        <span style="color:Blue;">case</span> ErrorCode.MissingBracket:
            <span style="color:Green;">// ...</span>
            <span style="color:Blue;">break</span>;
        <span style="color:Blue;">default</span>:
            <span style="color:Blue;">throw</span>;
    }
}
</pre></div>
</div>
<p >
Well, we can now rewrite this code properly:</p>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">try</span> {
    <span style="color:Green;">//...</span>
}
<span style="color:Blue;">catch</span> (ParserException exception) when (exception.ErrorCode == ErrorCode.MissingModifier)
{
    <span style="color:Green;">// ...</span>
}
<span style="color:Blue;">catch</span> (ParserException exception) when (exception.ErrorCode == ErrorCode.MissingBracket)
{
    <span style="color:Green;">// ...</span>
}
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">21</div>
<p >
The improvement here is not in the lack of <code>switch</code> construct. I believe this new construct is better in several things:</p>
<div class="paragraph-right-side">21</div>
</div>
<ul>
<li>
<p >
using <code>when</code> for filtering we catch exactly what we want and it’s right in terms of ideology;</p>
</li>
<li>
<p >
the code becomes more readable in this new form. Looking through code our brain can identify blocks for handling errors more easily as it initially searches for <code>catch</code> and not <code>switch-case</code>;</p>
</li>
<li>
<p >
the last but not least: a preliminary comparison is BEFORE entering the catch block. It means that if we make wrong guesses about potential situations, this construct will work faster than <code>switch</code> in the case of throwing an exception again.</p>
</li>
</ul>
<div class="paragraph-container">
<div class="paragraph-left-side">22</div>
<p >
Many sources say that the peculiar feature of this code is that filtering happens <em>before</em> stack unrolling. You can see this in situations when there are no other calls except usual between the place where an exception is thrown and the place where filtering check occurs.</p>
<div class="paragraph-right-side">22</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">static</span> <span style="color:Blue;">void</span> Main()
{
    <span style="color:Blue;">try</span>
    {
        Foo();
    }
    <span style="color:Blue;">catch</span> (Exception ex) when (Check(ex))
    {
        ;
    }
}

<span style="color:Blue;">static</span> <span style="color:Blue;">void</span> Foo()
{
    Boo();
}

<span style="color:Blue;">static</span> <span style="color:Blue;">void</span> Boo()
{
    <span style="color:Blue;">throw</span> <span style="color:Blue;">new</span> Exception(<span style="color:#A31515;">&quot;1&quot;</span>);
}

<span style="color:Blue;">static</span> <span style="color:Blue;">bool</span> Check(Exception ex)
{
    <span style="color:Blue;">return</span> ex.Message == <span style="color:#A31515;">&quot;1&quot;</span>;
}
</pre></div>
</div>
<p >
<img src="./imgs/StackWOutUnrolling.png" alt="Stack without unrolling" /></p>
<div class="paragraph-container">
<div class="paragraph-left-side">23</div>
<p >
You can see from the image that the stack trace contains not only the first call of <code>Main</code> as the point to catch an exception, but the whole stack before the point of throwing an exception plus the second entering into <code>Main</code> via unmanaged code. We can suppose that this code is exactly the code for throwing exceptions that is in the stage of filtering and choosing a final handler. However, <em>not all calls can be handled without stack unrolling</em>. I believe that excessive uniformity of the platform generates too much confidence in it. For example, when one domain calls a method from another domain it is absolutely transparent in terms of code. However, the way methods calls work is an absolutely different story. We are going to talk about them in the next part.</p>
<div class="paragraph-right-side">23</div>
</div>
<h3 id="serialization">Serialization</h3>
<div class="paragraph-container">
<div class="paragraph-left-side">24</div>
<p >
Let’s start by looking at the results of running the following code (I added the transfer of a call across the boundary between two application domains).</p>
<div class="paragraph-right-side">24</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
    <span style="color:Blue;">class</span> Program
    {
        <span style="color:Blue;">static</span> <span style="color:Blue;">void</span> Main()
        {
            <span style="color:Blue;">try</span>
            {
                ProxyRunner.Go();
            }
            <span style="color:Blue;">catch</span> (Exception ex) when (Check(ex))
            {
                ;
            }
        }

        <span style="color:Blue;">static</span> <span style="color:Blue;">bool</span> Check(Exception ex)
        {
            <span style="color:Blue;">var</span> domain = AppDomain.CurrentDomain.FriendlyName; <span style="color:Green;">// -&gt; TestApp.exe</span>
            <span style="color:Blue;">return</span> ex.Message == <span style="color:#A31515;">&quot;1&quot;</span>;
        }

        <span style="color:Blue;">public</span> <span style="color:Blue;">class</span> ProxyRunner : MarshalByRefObject
        {
            <span style="color:Blue;">private</span> <span style="color:Blue;">void</span> MethodInsideAppDomain()
            {
                <span style="color:Blue;">throw</span> <span style="color:Blue;">new</span> Exception(<span style="color:#A31515;">&quot;1&quot;</span>);
            }

            <span style="color:Blue;">public</span> <span style="color:Blue;">static</span> <span style="color:Blue;">void</span> Go()
            {
                <span style="color:Blue;">var</span> dom = AppDomain.CreateDomain(<span style="color:#A31515;">&quot;PseudoIsolated&quot;</span>, <span style="color:Blue;">null</span>, <span style="color:Blue;">new</span> AppDomainSetup
                {
                    ApplicationBase = AppDomain.CurrentDomain.BaseDirectory
                });
                <span style="color:Blue;">var</span> proxy = (ProxyRunner) dom.CreateInstanceAndUnwrap(<span style="color:Blue;">typeof</span>(ProxyRunner).Assembly.FullName, <span style="color:Blue;">typeof</span>(ProxyRunner).FullName);
                proxy.MethodInsideAppDomain();
            }
        }
    }

</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">25</div>
<p >
We can see that stack unrolling happens before we get to filtering. Let’s look at screenshots. The first is taken before the generation of an exception:</p>
<div class="paragraph-right-side">25</div>
</div>
<p >
<img src="./imgs/StackUnroll.png" alt="StackUnroll" /></p>
<p >
The second one is after it:</p>
<p >
<img src="./imgs/StackUnroll2.png" alt="StackUnroll2" /></p>
<div class="paragraph-container">
<div class="paragraph-left-side">26</div>
<p >
Let’s study call tracing before and after exceptions are filtered. What happens here? We can see that platform developers made something that at first glance looks like the protection of a subdomain. The tracing is cut after the last method in the call chain and then there is the transfer to another domain. But I think this looks strange. To understand why this happens let’s remember the main rule for types that organize the interaction between domains. These types should inherit <code>MarshalByRefObject</code> and be serializable. However, despite the strictness of C# exception types can be of any nature. What does it mean? This means that situations may occur when an exception inside a subdomain can be caught in a parent domain. Also, if a data object that can get into an exceptional situation has some methods that are dangerous in terms of security they can be called in a parent domain. To avoid this, the exception is first serialized and then it crosses the boundary between application domains and appears again with a new stack. Let’s check this theory:</p>
<div class="paragraph-right-side">26</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
[StructLayout(LayoutKind.Explicit)]
<span style="color:Blue;">class</span> Cast
{
    [FieldOffset(0)]
    <span style="color:Blue;">public</span> Exception Exception;

    [FieldOffset(0)]
    <span style="color:Blue;">public</span> <span style="color:Blue;">object</span> obj;
}

<span style="color:Blue;">static</span> <span style="color:Blue;">void</span> Main()
{
    <span style="color:Blue;">try</span>
    {
        ProxyRunner.Go();
        Console.ReadKey();
    }
    <span style="color:Blue;">catch</span> (RuntimeWrappedException ex) when (ex.WrappedException <span style="color:Blue;">is</span> Program)
    {
        ;
    }
}

<span style="color:Blue;">static</span> <span style="color:Blue;">bool</span> Check(Exception ex)
{
    <span style="color:Blue;">var</span> domain = AppDomain.CurrentDomain.FriendlyName; <span style="color:Green;">// -&gt; TestApp.exe</span>
    <span style="color:Blue;">return</span> ex.Message == <span style="color:#A31515;">&quot;1&quot;</span>;
}

<span style="color:Blue;">public</span> <span style="color:Blue;">class</span> ProxyRunner : MarshalByRefObject
{
    <span style="color:Blue;">private</span> <span style="color:Blue;">void</span> MethodInsideAppDomain()
    {
        <span style="color:Blue;">var</span> x = <span style="color:Blue;">new</span> Cast {obj = <span style="color:Blue;">new</span> Program()};
        <span style="color:Blue;">throw</span> x.Exception;
    }

    <span style="color:Blue;">public</span> <span style="color:Blue;">static</span> <span style="color:Blue;">void</span> Go()
    {
        <span style="color:Blue;">var</span> dom = AppDomain.CreateDomain(<span style="color:#A31515;">&quot;PseudoIsolated&quot;</span>, <span style="color:Blue;">null</span>, <span style="color:Blue;">new</span> AppDomainSetup
        {
            ApplicationBase = AppDomain.CurrentDomain.BaseDirectory
        });
        <span style="color:Blue;">var</span> proxy = (ProxyRunner)dom.CreateInstanceAndUnwrap(<span style="color:Blue;">typeof</span>(ProxyRunner).Assembly.FullName, <span style="color:Blue;">typeof</span>(ProxyRunner).FullName);
        proxy.MethodInsideAppDomain();
    }
}
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">27</div>
<p >
For C# code could throw an exception of any type (I don’t want to torture you with MSIL) I performed a trick in this example casting a type to a noncomparable one, so we could throw an exception of any type, but the translator would think that we use <code>Exception</code> type. We create an instance of the <code>Program</code> type, which is not serializable for sure, and throw an exception using this type as workload. The good news is that you get a wrapper for non-Exception exceptions of <code>RuntimeWrappedException</code> which will store an instance of our <code>Program</code> type object inside and we will be able to catch this exception. However, there is bad news that supports our idea: calling <code>proxy.MethodInsideAppDomain();</code> will generate <code>SerializationException</code>:</p>
<div class="paragraph-right-side">27</div>
</div>
<p >
<img src="./imgs/SerializationError.png" alt="" /></p>
<div class="paragraph-container">
<div class="paragraph-left-side">28</div>
<p >
Thus, you can’t transfer such an exception between domains as it is not possible to serialize it. This, in turn, means that using exception filters for wrapping methods calls in other domains will anyway lead to stack unrolling despite that the serialization seems to be unnecessary with <code>FullTrust</code> settings of a subdomain.</p>
<div class="paragraph-right-side">28</div>
</div>
<blockquote>
<p >
We should pay additional attention to the reason why serialization between domains is so necessary. In our artificial example, we create a subdomain which doesn’t have any settings. It means it works in FullTrust way. CLR fully trusts its content and doesn’t run any additional checks. However, when you insert at least one security setting, the full trust will disappear and CLR will start controlling everything that happens inside a subdomain. So, when you have a fully trusted domain you don’t need a serialization. Admit, we don’t need to protect ourselves. But serialization exists not only for protection. Each domain loads all necessary assemblies a second time and creates their copies. Thus, it creates copies of all types and all VMTs. Of course, when passing an object from domain to domain you will get the same object. But its VMTs won’t be its own and this object can’t be cast to another type. In other words, if we create an instance of a <code>Boo</code> type and get it in another domain the casting of <code>(Boo)boo</code> won’t work. In this case, serialization and deserialization will solve the problem as the object will exist in two domains simultaneously. It will exist with all its data where it was created and it will exist in the domain of usage as a proxy object, ensuring that methods of an original object are called.</p>
</blockquote>
<div class="paragraph-container">
<div class="paragraph-left-side">29</div>
<p >
By transferring a serialized object between domains you get a full copy of the object from one domain in another one while keeping some delimitation in memory. However, this delimitation is fictional. It is used only for those types that are not in <code>Shared AppDomain</code>. Thus, if you throw something non-serializable as an exception, but from <code>Shared AppDomain</code>, you won’t get an error of serialization (we can try throwing <code>Action</code> instead of <code>Program</code>). However, stack unrolling will anyway occur in this case: as both variants should work in a standard way. So that nobody will be confused.</p>
<div class="paragraph-right-side">29</div>
</div>

        </div>
        <footer>
            <div class="footer-container">
                <div class="footer-wrap">
                    <img src="../../res/img/logo-w-noindex.svg">
                    <p>
                        <a class="footer-link" target="_blank" href="mailto:sidristij@clrium.ru"><i class="far fa-envelope" aria-hidden="true"></i></a>
                        <a class="footer-link" target="_blank" href="https://vk.com/clrium"><i class="fab fa-vk" aria-hidden="true"></i></a>
                        <a class="footer-link" target="_blank" href="https://youtube.com/clrium"><i class="fab fa-youtube" aria-hidden="true"></i></a>
                        <a class="footer-link" target="_blank" href="https://github.com/clrium"><i class="fab fa-github" aria-hidden="true"></i></a>
                        <a class="footer-link" target="_blank" href="skype:stanislav.sidristyi"><i class="fab fa-skype" aria-hidden="true"></i></a>
                        <a class="footer-link" target="_blank" href="https://t.me/clrium_group"><i class="fab fa-telegram" aria-hidden="true"></i></a>
                    </p>
                </div>
            </div>
        </footer>
    </div>
</body>
</html>