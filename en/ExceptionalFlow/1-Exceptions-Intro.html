<!DOCTYPE html>
<html lang="ru">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>.NET Platform Architecture</title>
</head>
<body>
    <script src="../../res/jquery.js"></script>
    <link rel="stylesheet" href="../../res/bootstrap.css">
    <link rel="stylesheet" href="../../res/awesome.css">
    <style>

body {
    font-family: PF Regal,Georgia,serif;
    font-size: 16pt;
    font-weight: 300;
    padding-top: 4em;
    background-color: #fdfdfd;
}

.book-title-container {
    width: 100%;
    text-align: center;
    margin: 73px 0 110px 0;
}

.book-title {
    font-size: 57pt;
    margin: 50px 0 70px 0;
    user-select: none;
}
.book-part-title-block {
    display: inline-block;
}
.book-part-title {
    font-size: 21pt;
    color: #656ab6;
    margin: 0 7px;
}

.book-part-title:hover {
    box-shadow: inset 0 -1px #007bff;
    text-decoration: none;
}

.book-superheading-title {
    font-size: 15pt;
    margin: 0 7px;
    color: #656ab6;
}

.article-container
{
    width: 62%;
}

strong {
    font-weight: 500;
}

p, li {
    margin: 0 0 1em;
    line-height: 1.5em;
    font-family: inherit;
}

ol, li {
    margin-top: 1em;
    margin-bottom: 1em;
}

ol {
    padding-left: 1.21em;
}

ul  {
    padding-left: 1em;
}

ol li, ul li {
    padding-left: 0.5em;	
    font-family: inherit;
    text-align: justify;
}

table {
    margin: 30px 0;
    width: 100%;
}

thead {
    background-color: aliceblue;
}

table th {
    font-weight: 400;
}

table td, table th {
    padding: 7px;
    border-top: solid darkgrey 1px;
    border-bottom: solid darkgrey 1px;
    border-right: dotted darkgray 1px;
    border-left: dotted darkgray 1px;
    font-size: smaller;
}

code, *[class*='lang-'] span, *[class*='lang-'] pre {
    font-family: JB Mono, monospace !important;
}

*[class*='lang-'] {
    padding: 0px 0px 25px 0px;
    font-size: 0.75em;
}


*[class*='lang-'] > div, pre > code {
    border-left-color: #eee;
    border-left-style: dotted;
    border-left-width: 3px;
    padding-left: 25px;
    display: block;
    padding-top: 20px;
    padding-bottom: 20px;
}

*[class*='lang-'] > div pre, pre > code pre {
    margin-bottom: 0;
}

p code:not(.highlight), li code:not(.highlight) {
    font-size: 0.7em;
    color: darkslateblue;
}

/* style for manual selecting */
.box {
    padding: 3px;
    border: gainsboro;
    border-width: 1px;
    border-style: solid;
}

code.highlight {
    font-family: inherit !important;
    font-size: inherit;
    font-weight: inherit;
    color: inherit;
}

p code.highlight, li code.highlight {
    padding: 4px;
    background-color: #ffffa1;
}

.wide {
    width:140%;
}

p a, li a {
    text-decoration: none;
    color: inherit;
    box-shadow: inset 0 -1px #b88b59;
}

p a:hover, li a:hover {
    text-decoration: none;
    color: inherit;
    box-shadow: inset 0 -1px #0056b3;
}

blockquote h5 {
    background-color: aquamarine;
    margin: 16px 0 16px -20px;
    padding: 15px 30px 15px;
}

p img {
    width: 95%;
}

blockquote 
{
    padding-left: 0.4em;
    border-left: 0.5em solid rgba(0,0,0,.08);
    font-style: italic;
}

blockquote.big-quote, 
blockquote.breadcrumbs 
{
    background-color: transparent;
    padding: 0;
    border-left: none;
    font-style: normal;
}

blockquote.breadcrumbs, blockquote.breadcrumbs  p
{
    margin: 0;
    padding: 0;
}

blockquote p {
    padding: 1em 1em 1em 0.6em;
    font-family: inherit;
}

blockquote p code {
    font-family: consolas, monospace;
    font-size: 17px;
    padding: 4px 6px;
}

blockquote p em {
    font-weight: 400;
}

blockquote.big-quote > p {
    margin: 0.7em 0 0.7em 0;
    font-family: Charter;
    font-size: 2.5em;
    padding: 0;
    width: 130%;
    line-height: 1em;
}

h1, h2, h3, h4, h5, h6 {
    margin: 0;
    padding: 0;
    font-weight: 400;
    font-family: inherit;
    hyphens: none;
}

h1 {
    font-size: 2.2em;
    font-family: Charter,Georgia,serif;
    font-weight: 300;
    margin: 1.8em 0 1.8em 0;
    text-align: center;
    width: 140%;
}

h2 {
    padding-top: 1.5em;
    padding-left: 1.5em;
    padding-right: 1.5em;
    margin-bottom: 0.5em;
    font-family: Charter, Arial, Helvetica Neue, sans-serif;
    font-size: 1.4em;
    text-align: center;
}

h3 {
    padding-top: 1.2em;
    font-family: Charter, Arial, Helvetica Neue, sans-serif;
    font-size: 1.15em;
    width: 70%;
}

h4 {
    padding: 1em 0 0 0;
    font-size: 1.2em;
    font-weight: 300;
    font-style: italic;
}

h5 {
    padding: 0.6em 0 0 0;
    font-weight: 300;
    font-size: 1.1em;
}

/* Sidenotes */

.aside-container {
    position: relative;
}
.aside-container p {
    position: relative;
    top: 9px;
}

.aside-container > .aside-side-container {
    display: block;
    position: absolute;
    top: 12px;
    left: 96%;
    width: 34%;
    font-size: 12pt;
    line-height: 20px;
    margin-left: 100px;
    z-index: 1000;
}

.aside-container > .aside-side-container p {
    line-height: 24px;
    font-size: 13pt;
    margin: 0 0 13px 0;
}

.side-regular-block p {
    top: 0;
}

/* Music side player */
.aside-side-container .music-player {
    width: 100%;
    height: 400px;
}

/* media block after h1 */
.aside-container h1 + .aside-side-container.side-media-block h2 {
    margin: 7em 0 1em 0;
    font-family: Proxima Nova,Arial,Helvetica Neue,sans-serif;
    font-weight: 600;
}

.aside-side-container > li {
    display: block;
    font-family: Charter;
}

.aside-side-container > li ul, .aside-side-container > li ol {
    padding-left: 30px;
    margin-top: 0.5em;
    margin-bottom: 0.5em;
}
.aside-side-container > li li {
    padding-left: 6px;
    margin: 0 0 6px;
    line-height: 22px;

    font-family: Charter;
}

.aside-side-container p {
    line-height: 25px;
    font-size: 13pt;
    margin: 0 0 15px 0;
}

.aside-side-container blockquote {
    border: aliceblue;
    border-left-style: solid;
}

/* Paragraphs numbering */
.paragraph-container {
    position: relative;
}
.paragraph-container p {
    position: relative;
    top: 9px;
}

.paragraph-container p, .aside-container > p {
    text-align: justify;
}

.paragraph-container > .paragraph-left-side, .paragraph-container > .paragraph-right-side  {
    font-family: JB Mono, consolas;
    display: block;
    position: absolute;
    top: 17px;
    font-size: 10pt;
    line-height: 20px;
    color: #86abc473;
    z-index: 1000;
}
.paragraph-container > .paragraph-left-side {
    display: none;
    left: -2.1cm;
    width: 35px;
    user-select: none;
}

.paragraph-container > .paragraph-right-side  {
    display: none;
    left: 100%;
    width: 35px;
    padding-left: 45px;
    user-select: none;
}

.article-container
{
    width: 70%;
}

/* X_MENU */
.menu-title {
    text-align: center;
    margin: 35px 50px 35px 50px;
    font-size: 24pt;
    font-family: Charter;
}

.menu-container ol {
    margin: 0;
    padding: 0;
}

.menu-container ol li {
    margin: 0;
    padding: 0;
}

.header {
    height: 2.5em;
    background-color: white;
    position: relative;
    z-index: 1500;
    width: 100%;
    display: flex;
    justify-content: space-between;
    transition: all 1s;
    top: 0;
    box-shadow: 1px -4px 20px rgba(0, 0, 0, .1);
}

.fixed {
    position: fixed !important;
}

.header > .menu {
    pointer-events: auto;
    float: right;
    height: 40px;
    font-family: Charter, 'Helvetica Neue', Arial, sans-serif;
    font-size: 1em;
    color: #fff;
    margin-top:40px;
    margin-right:40px;
}

.menu a {
    color: #fff;
}
.menu a:hover {
    text-decoration: none;
    color: #fff;
}

#menu__toggle {
    opacity: 0;
}

#menu__toggle:checked ~ .menu__btn > span {
    transform: rotate(45deg);
}
#menu__toggle:checked ~ .menu__btn > span::before {
    top: 0;
    transform: rotate(0);
    background-color: black
}
#menu__toggle:checked ~ .menu__btn > span::after {
    top: 0;
    transform: rotate(90deg);
    background-color: black
}
#menu__toggle:checked ~ .menu__box {
    visibility: visible;
    right: 0;
}

.menu__btn {
    display: flex;
    align-items: center;
    position: fixed;
    top: 0;
    right: 0;
    width: 2.5em;
    height: 2.5em;
    cursor: pointer;
    z-index: 1;
    margin: 0;
    padding: 0.7em;
}

.menu__btn > span,
.menu__btn > span::before,
.menu__btn > span::after {
    display: block;
    position: absolute;

    width: 1.1em;
    height: 1px;

    border-bottom: 1px black solid;

    transition-duration: .25s;
}
.menu__btn > span::before {
    content: '';
    top: -7px;
}
.menu__btn > span::after {
    content: '';
    top: 7px;
}

.menu__box {
    display: block;
    position: fixed;
    visibility: hidden;
    top: 0;
    right: -100%;

    width: 100%;
    height: 100%;

    margin: 0;
    padding: 80px 0;

    list-style: none;

    background-color: white;
    box-shadow: 1px 0px 6px rgba(0, 0, 0, .2);

    transition-duration: .25s;

    overflow-y: auto;
}
.menu__box li a:hover {
    text-decoration: none;
    color: inherit;
}
.menu__list {
    font-size: 0.9em;
    margin: 0 2em 0 2em;
}
.menu__list li {
    text-align: left;
}

/* X_HEADER */

.conflogo {
    margin: 0.5em 0 0 0.8em;
    font-size: 1.1em;
    font-family: Charter;
    user-select: none;
}

.invisible {
    display: none;
}

.header > .menu > div {
    display: inline;
    margin-left: 10px;
    margin-right: 10px;
}

.menu__header_current
{
    text-align: center;
    font-size: 2em;
    margin: 0 0 1em 0;
}

.menu__header_total
{
    text-align: center;
    font-size: 2.4em;
    margin: 1.7em 0 0.3em 0;
}
.menu__header_list 
{
    padding: 0;
    margin-top: 0;
    margin-left: 0;
    margin-right: 0;
}
.menu__header_list > li 
{
    display: inline-block;
    width: 100%;
    margin: 0;
    text-align: center;
    font-family: charter;
}
.menu__header_total_sub
{
    font-size: 1.4em;
    margin: 2em 0 1em 0;
}
.menu__header_total_sub2
{
    font-size: 1.1em;
    margin: 1.5em 0 0.6em 1em;
    text-align: left;
}
/* X_FOOTER */

footer {
    margin-top: 2em;
    background-color: black;
    height: 4em;
}

footer > div {
    box-shadow: 0px 2px 2px rgb(0, 0, 0);
}

.footer-container {
    height: 100%;
}

.footer-wrap {
    color: #fff;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 25px 0;
}

.footer-wrap p {
    margin: 0;
    padding: 0px;
    line-height: 1em;
}

.footer-container img {
    height: 1.6em;
    margin-top: auto;
    margin-bottom: auto;
}

.footer-link {
    color: white;
    margin: 0 7px;
    font-size: 1em;
    box-shadow: none;
}

.footer-link:hover {
    color: salmon;
    box-shadow: none;
}

/* MEDIA */
/* XXL */
@media (min-width: 1601px) {
    .book-container
    {
        max-width: 1200px;
        margin-left: auto;
        margin-right: auto;
    }
}

/* XL */
@media (max-width: 1600px) {
    .book-container
    {
        margin-left: 4cm;
        margin-right: 4cm;
    }
}

/* LG */
@media (max-width: 1400px) {
    .book-container
    {
        margin-left: 4cm;
        margin-right: 4cm;
    }

    blockquote.big-quote > p {
        font-size: 2em;
    }
}

/* > MD */
@media (min-width: 992px) {
    .hamburger-menu {
        display: none;
    }
}

/* MD */
@media (max-width: 991px) {
    
    h3 {
        width:80%;
    }

    .book-container
    {
        margin-left: 3cm;
        margin-right: 3cm;
    }
    
    .book-title-container {
        margin: 73px 0 110px 0;
    }

    .book-title {
        font-size: 50pt;
        margin: 50px 0 70px 0;
    }

    .book-part-title {
        font-size: 19pt;
    }

    .book-part-title:hover {
        box-shadow: inset 0 -1px #007bff;
    }

    .book-superheading-title {
        font-size: 15pt;
    }                                     

    .article-container, h1 {
        width: 100%;
    }

    .aside-container p {
        top: 0;
    }

    .aside-container h1 + .aside-side-container.side-media-block h2 {
        display: none;
    }

    .wide {
        width: 100%;     
    }

    .side-regular-block {
        margin: 40px 10px;
        padding-left: 100px;
    }
    .aside-side-container .music-player {
        width: 100%;
        height: 100px;
    }
    .aside-side-container.side-media-block {
        padding: 17px 0;
    }
    .aside-side-container.side-media-block h2 {
        margin-top: 20px;
        font-size: 13pt;
        border: none;
    }

    .aside-container > .aside-side-container
    {
        position: relative;
        top: auto;
        left: auto;
        width: auto;
        height: auto;
        margin: 0;
        padding: 17px;
    }

    blockquote.big-quote > p {
        width: 100%;
        font-size: 2em;
    }

    .paragraph-container .paragraph-left-side {
        left: -55px;
    }

    body {
        font-size: 15pt;
    }

    p code:not(.highlight), li code:not(.highlight) {
        font-size: 11pt;
    }

    p, li {
        line-height: 30px;
    }
    
    li {
        margin: 0 0 10px 0;
    }

    .side-regular-block {
        border-radius: 5px;
        background-image: linear-gradient(180deg,hsla(0,0%,100%,0) 60%,#fff),linear-gradient(70deg,#dbedff 32%,#ebfff0);
        padding: 22px;
    }    

    .menu__list
    {
        margin-top: 0;
        margin-bottom: 0;
    }

    .menu__list, .menu__header_total_sub2
    {
        margin-left: auto;
        margin-right: auto;
        max-width: 800px;
        width: 80%;
    }

    .book-container 
    {
        position: absolute;
        padding: 0 3cm 0 3cm;
        overflow: scroll;
        overflow-x: auto;
        top: 2.5em;
        bottom: 0;
        width: 100%;
        margin: 0;
    }

    footer {
        margin-top: 2em;
        background-color: black;
        height: 4em;
    }

    footer > div {
        position: relative;
        margin: 0 -3cm;
        background: black;
        padding: 0 3cm;
    }
}

/* Smartphone horizontal - SM */
@media (max-width: 767px) {
    .book-title-container {
        margin: 73px 0 110px 0;
    }

    h1 {
        margin: 1.8em 0em 1.8em 0.3em;
    }

    .book-title {
        font-size: 40pt;
        margin: 50px 0 70px 0;
    }

    .book-part-title {
        font-size: 19pt;
    }

    .book-part-title:hover {
        box-shadow: inset 0 -1px #007bff;
    }

    .book-superheading-title {
        font-size: 17pt;
    }

    .book-container {
        padding: 0 2.5cm;
    }
    ul {
        margin-left: 30px;
        margin-right: 30px;
        padding-left: 25px;
    }
    .paragraph-container > .paragraph-left-side {
	    display: block;
        top: 14px;
        font-size: 9pt;
    }
    .paragraph-container > .paragraph-right-side {
    	display: block;
        padding-left: 40px;
        top: 14px;
        font-size: 9pt;
    }
    .footer-container img {
        height: 1.3em;
    } 
}

@media (max-width: 630px) {
    .book-container {
        padding: 0 1.5cm;
    }
    .paragraph-container > .paragraph-left-side {
        left: -33px;
    }
    .paragraph-container > .paragraph-right-side {
        padding-left: 24px;
    }
}
/* Smartphone - XS */
@media (max-width: 575px) {
    .book-container {
        padding: 0 50px 0 30px;
    }
    ul {
        margin: 0;
        padding-left: 20px;
    }

    body {
        font-size: 13pt;
    }

    p code:not(.highlight), li code:not(.highlight) 
    {
        font-size: 10pt;
        padding: 3px;
    }

    *[class*='lang-'] > div, pre > code {
        padding-left: 15px;
        padding-top: 15px;
        padding-bottom: 15px;
    }
    
    ol li, ul li {
        padding-left: 0.2em;	
    }
    
    p, li {
        line-height: 24px;
    }    
    
    .paragraph-container .paragraph-left-side 
    {
        display: none;        
    }
    .paragraph-container .paragraph-right-side 
    {
        padding-left: 21px;
        top: 14px;
	    font-size: 8pt;
    }
    .footer-container img {
        height: 1em;
    } 
    .menu__list {
        margin: 0 1em 0 1em;
    }
    .menu__header_total_sub2
    {
        margin: 1.5em 0 0.6em 1em;
    }
}

/* Fonts */

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-Bold.eot');
    src: local('../../res/fonts/PFRegalTextPro-Bold'),
        url('../../res/fonts/PFRegalTextPro-Bold.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-Bold.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-Bold.ttf') format('truetype');
    font-weight: bold;
    font-style: normal;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-Medium.eot');
    src: local('../../res/fonts/PFRegalTextPro-Medium'),
        url('../../res/fonts/PFRegalTextPro-Medium.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-Medium.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-Medium.ttf') format('truetype');
    font-weight: 500;
    font-style: normal;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-BlackItalic.eot');
    src: local('../../res/fonts/PFRegalTextPro-BlackItalic'),
        url('../../res/fonts/PFRegalTextPro-BlackItalic.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-BlackItalic.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-BlackItalic.ttf') format('truetype');
    font-weight: 900;
    font-style: italic;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-Black.eot');
    src: local('../../res/fonts/PFRegalTextPro-Black'),
        url('../../res/fonts/PFRegalTextPro-Black.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-Black.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-Black.ttf') format('truetype');
    font-weight: 900;
    font-style: normal;
}

@font-face {
    font-family: 'PF Regal UBlack';
    src: url('../../res/fonts/PFRegalTextPro-UBlack.eot');
    src: local('../../res/fonts/PFRegalTextPro-UBlack'),
        url('../../res/fonts/PFRegalTextPro-UBlack.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-UBlack.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-UBlack.ttf') format('truetype');
    font-weight: 900;
    font-style: normal;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-MediumItalic.eot');
    src: local('../../res/fonts/PFRegalTextPro-MediumItalic'),
        url('../../res/fonts/PFRegalTextPro-MediumItalic.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-MediumItalic.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-MediumItalic.ttf') format('truetype');
    font-weight: 500;
    font-style: italic;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-UBlackItalic.eot');
    src: local('../../res/fonts/PFRegalTextPro-UBlackItalic'),
        url('../../res/fonts/PFRegalTextPro-UBlackItalic.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-UBlackItalic.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-UBlackItalic.ttf') format('truetype');
    font-weight: 900;
    font-style: italic;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-RegularAItalic.eot');
    src: local('../../res/fonts/PFRegalTextPro-RegularAItalic'),
        url('../../res/fonts/PFRegalTextPro-RegularAItalic.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-RegularAItalic.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-RegularAItalic.ttf') format('truetype');
    font-weight: 300;
    font-style: italic;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-BoldItalic.eot');
    src: local('../../res/fonts/PFRegalTextPro-BoldItalic'),
        url('../../res/fonts/PFRegalTextPro-BoldItalic.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-BoldItalic.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-BoldItalic.ttf') format('truetype');
    font-weight: bold;
    font-style: italic;
}

@font-face {
    font-family: 'Charter';
    src: url('../../res/fonts/charter-regular.woff2') format('woff2');
    font-weight: normal;
    font-style: normal;
}

/*  Regular B */
@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-RegularBItalic.eot');
    src: local('../../res/fonts/PFRegalTextPro-RegularBItalic'),
        url('../../res/fonts/PFRegalTextPro-RegularBItalic.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-RegularBItalic.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-RegularBItalic.ttf') format('truetype');
    font-weight: 300;
    font-style: italic;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-RegularB.eot');
    src: local('../../res/fonts/PFRegalTextPro-RegularB'),
        url('../../res/fonts/PFRegalTextPro-RegularB.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-RegularB.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-RegularB.ttf') format('truetype');
    font-weight: 300;
    font-style: normal;
}

@font-face {
    font-family: 'JB Mono';
    src: url('../../res/fonts/JetBrainsMono-Regular.eot');
    src: local('../../res/fonts/JetBrainsMono-Regular'),
        url('../../res/fonts/JetBrainsMono-Regular.woff2') format('woff2'),
        url('../../res/fonts/JetBrainsMono-Regular.woff') format('woff'),
        url('../../res/fonts/JetBrainsMono-Regular.ttf') format('truetype');
    font-weight: 300;
    font-style: normal;
}
@font-face {
    font-family: 'JB Mono';
    src: url('../../res/fonts/JetBrainsMono-Italic.eot');
    src: local('../../res/fonts/JetBrainsMono-Italic'),
        url('../../res/fonts/JetBrainsMono-Italic.woff2') format('woff2'),
        url('../../res/fonts/JetBrainsMono-Italic.woff') format('woff'),
        url('../../res/fonts/JetBrainsMono-Italic.ttf') format('truetype');
    font-weight: 300;
    font-style: italic;
}

@font-face {
    font-family: 'JB Mono';
    src: url('../../res/fonts/JetBrainsMono-Medium.eot');
    src: local('../../res/fonts/JetBrainsMono-Medium'),
        url('../../res/fonts/JetBrainsMono-Medium.woff2') format('woff2'),
        url('../../res/fonts/JetBrainsMono-Medium.woff') format('woff'),
        url('../../res/fonts/JetBrainsMono-Medium.ttf') format('truetype');
    font-weight: 500;
    font-style: normal;
}
@font-face {
    font-family: 'JB Mono';
    src: url('../../res/fonts/JetBrainsMono-Medium-Italic.eot');
    src: local('../../res/fonts/JetBrainsMono-Medium-Italic'),
        url('../../res/fonts/JetBrainsMono-Medium-Italic.woff2') format('woff2'),
        url('../../res/fonts/JetBrainsMono-Medium-Italic.woff') format('woff'),
        url('../../res/fonts/JetBrainsMono-Medium-Italic.ttf') format('truetype');
    font-weight: 500;
    font-style: italic;
}
@font-face {
    font-family: 'Font Awesome 5 Free';
    font-style: normal;
    font-weight: 400;
    font-display: swap;
    src: url("../../res/fonts/webfonts/fa-regular-400.eot");
    src: url("../../res/fonts/webfonts/fa-regular-400.eot?#iefix") format("embedded-opentype"), 
         url("../../res/fonts/webfonts/fa-regular-400.woff2") format("woff2"), 
         url("../../res/fonts/webfonts/fa-regular-400.woff") format("woff"), 
         url("../../res/fonts/webfonts/fa-regular-400.ttf") format("truetype"), 
         url("../../res/fonts/webfonts/fa-regular-400.svg#fontawesome") format("svg"); 
    font-display: swap;
}
    
.fa {
    font-family: 'Font Awesome 5 Free';
    font-weight: 400;
    font-display: swap;
}
@font-face {
  font-family: 'Font Awesome 5 Brands';
  font-style: normal;
  font-weight: 400;
  font-display: auto;
  src: url("../../res/fonts/fa-brands-400.eot");
  src: url("../../res/fonts/fa-brands-400.eot?#iefix") format("embedded-opentype"), url("../../res/fonts/fa-brands-400.woff2") format("woff2"), url("../../res/fonts/fa-brands-400.woff") format("woff"), url("../../res/fonts/fa-brands-400.ttf") format("truetype"), url("../../res/fonts/fa-brands-400.svg#fontawesome") format("svg"); 
}

.fab {
  font-family: 'Font Awesome 5 Brands';
  font-weight: 400; 
}

@font-face {
  font-family: 'Font Awesome 5 Free';
  font-style: normal;
  font-weight: 400;
  font-display: auto;
  src: url("../../res/fonts/fa-regular-400.eot");
  src: url("../../res/fonts/fa-regular-400.eot?#iefix") format("embedded-opentype"), url("../../res/fonts/fa-regular-400.woff2") format("woff2"), url("../../res/fonts/fa-regular-400.woff") format("woff"), url("../../res/fonts/fa-regular-400.ttf") format("truetype"), url("../../res/fonts/fa-regular-400.svg#fontawesome") format("svg"); 
}

.far {
  font-family: 'Font Awesome 5 Free';
  font-weight: 400; 
}

@font-face {
  font-family: 'Font Awesome 5 Free';
  font-style: normal;
  font-weight: 900;
  font-display: auto;
  src: url("../../res/fonts/fa-solid-900.eot");
  src: url("../../res/fonts/fa-solid-900.eot?#iefix") format("embedded-opentype"), url("../../res/fonts/fa-solid-900.woff2") format("woff2"), url("../../res/fonts/fa-solid-900.woff") format("woff"), url("../../res/fonts/fa-solid-900.ttf") format("truetype"), url("../../res/fonts/fa-solid-900.svg#fontawesome") format("svg"); 
}
</style>  
    <div class="book-title-container d-none d-lg-block">
        <div class="book-title">Knowledge Base</div>
        <div class="book-part-title-block">pt.1 <a href="../..//ru/Memory/01-00-MemoryManagement-Intro.html" class="book-part-title">Управление памятью</a></div>
        <div class="book-part-title-block">pt.2 <a href="../..//ru/Execution/02-00-ExecutionFlow-Intro.html" class="book-part-title">Поток исполнения команд</a></div>
        <br><a href="#" class="book-superheading-title">Обоснование выбора</a>
        / <a href="#" class="book-superheading-title">Упрощенное описание</a>
        / <a href="#" class="book-superheading-title">Подробное описание</a>
    </div>
    <header class="header fixed d-block d-lg-none">
        <p class="conflogo">KB</p> 

        <!-- mobile-menu -->

        <div class="hamburger-menu">
            <input id="menu__toggle" type="checkbox" />
            <label class="menu__btn" for="menu__toggle">
              <span></span>
            </label>
        
            <div class="menu__box">
                <p class="menu__header_current">На странице</p>
                <ol class="menu__list">
                    <li><a href="#overview" onclick="$('#menu__toggle').click(); return true;">
Overview</a></li>
<li><a href="#return-codes-vs.exception" onclick="$('#menu__toggle').click(); return true;">
Return codes vs. exception</a></li>
<li><a href="#try-catch-finally-in-brief" onclick="$('#menu__toggle').click(); return true;">
Try-Catch-Finally in brief</a></li>

                </ol>
                <p class="menu__header_total">Содержание</p>
                <ul class="menu__header_list">
                    <li>
                        <p class="menu__header_total_sub">
                            Управление памятью
                        </p>
                        <p class="menu__header_total_sub2">
                            Теоретические вопросы:
                        </p>
                        <ol class="menu__list">
                            <li><p><a href="../../ru/Memory/01-00-MemoryManagement-Intro.html">
                                Общие слова
                            </a></p></li>
                            <li>
                                <p>
                                <a href="../../ru/Memory/01-02-MemoryManagement-Basics.html">Введение в управление памятью</a></p>
                            </li>
                            <li>
                                <p>
                                <a href="../../ru/Memory/01-04-MemoryManagement-ThreadStack.html">Стек потока</a></p>
                            </li>
                            <li>
                                <p>
                                <a href="../../ru/Memory/01-06-MemoryManagement-EntitiesLifetime.html">Время жизни сущности</a></p>
                            </li>
                            <li>
                                <p>
                                <a href="../../ru/Memory/01-08-MemoryManagement-RefVsValueTypes.html">RefTypes, ValueTypes, Boxing &amp; Unboxing</a></p>
                            </li>
                            <li>
                                <p>
                                <a href="../../ru/Memory/01-10-MemoryManagement-IDisposable.html">Шаблон IDisposable</a></p>
                            </li>
                            <li>
                                <p>
                                <a href="../../ru/Memory/01-12-MemoryManagement-Finalizer.html">Финализация</a></p>
                            </li>
                            <li>
                                <p>
                                <a href="../../ru/Memory/01-14-MemoryManagement-Results.html">Выводы</a></p>
                            </li>
                        </ol>
                        <p class="menu__header_total_sub2">
                            Практические вопросы:
                        </p>
                        <ol class="menu__list" start="9">
                            <li><p><a href="../../ru/Memory/02-02-MemoryManagement-MemorySpan.html">
                                Memory&lt;T&gt;, Span&lt;T&gt;
                            </a></p></li>
                        </ol> 
                    </li>
                    <li>
                        <p class="menu__header_total_sub">
                            Поток исполнения команд
                        </p>
                        <p class="menu__header_total_sub2">
                            Многопоточность:
                        </p>
                        <ol class="menu__list">
                            <li><p><a href="../../ru/Execution/1-Threads/1-OS/1-threadsScheduling.html">
                                Потоки и планирование потоков
                            </a></p></li>
                        </ol>
                        <p class="menu__header_total_sub2">
                            Искл­юч­ител­ьные си­ту­а­ции:
                        </p>
                        <ol class="menu__list" start="2">
                            <li><p><a href="../../ru/Execution/2-ExceptionalFlow/1-Exceptions-Intro.html">
                                Введение в исключительные ситуации
                            </a></p></li>
                            <li><p><a href="../../ru/Execution/2-ExceptionalFlow/2-Exceptions-Architecture.html">
                                Архитектура исключительной ситуации
                            </a></p></li>
                            <li><p><a href="../../ru/Execution/2-ExceptionalFlow/3-Exceptions-Events.html">
                                События об исключительных ситуациях
                            </a></p></li>
                            <li><p><a href="../../ru/Execution/2-ExceptionalFlow/4-Exceptions-Types.html">
                                Виды исключительных ситуаций
                            </a></p></li>
                        </ol>
                    </li>
                </ul>
            </div>
        </div>
    </header>

    <div class="book-container">
        <div class="article-container">
            <!--<p class="d-xs-block d-sm-none">XS</p>
            <p class="d-none d-xs-block d-sm-none">SM</p>
            <p class="d-none d-sm-block d-md-none">MD</p>
            <p class="d-none d-lg-block d-xl-none">LG</p>
            <p class="d-none d-xl-block">XL</p> -->
            <h1 id="exceptions">Excep&shy;tions</h1>
<blockquote>
<p><a href="https://github.com/sidristij/dotnetbook/issues/51">A link to the discus&shy;sion</a></p>
</blockquote>
<div class="paragraph-container">
<div class="paragraph-left-side">01</div>
<p>It’s time to talk about excep&shy;tions or, rather, excep&shy;ti&shy;onal situ&shy;a&shy;tions. Before we start, let’s look at the defi&shy;ni&shy;tion. What is an excep&shy;ti&shy;onal situ&shy;a&shy;tion?</p>
<div class="paragraph-right-side">01</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">02</div>
<p>This is a situ&shy;a&shy;tion that makes the exe&shy;cu&shy;tion of current or subse&shy;quent code incor&shy;rect. I mean diffe&shy;rent from how it was designed or intended. Such a situ&shy;a&shy;tion comp&shy;ro&shy;mises the integ&shy;rity of an appli&shy;ca&shy;tion or its part, e.g. an object. It brings the appli&shy;ca&shy;tion into an extra&shy;or&shy;di&shy;nary or excep&shy;ti&shy;onal state.</p>
<div class="paragraph-right-side">02</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">03</div>
<p>But why do we need to define this termi&shy;no&shy;logy? Because it will keep us in some boun&shy;da&shy;ries. If we don’t follow the termi&shy;no&shy;logy, we can get too far from a designed concept which may result in many ambi&shy;guous situ&shy;a&shy;tions. Let’s see some prac&shy;tical examples:</p>
<div class="paragraph-right-side">03</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
 <span style="color:Blue;">struct</span> Number
 {
     <span style="color:Blue;">public</span> <span style="color:Blue;">static</span> Number Parse(<span style="color:Blue;">string</span> source)
     {
         <span style="color:Green;">// ...</span>
         <span style="color:Blue;">if</span>(!parsed)
         {
             <span style="color:Blue;">throw</span> <span style="color:Blue;">new</span> ParsingException();
         }
         <span style="color:Green;">// ...</span>
     }

     <span style="color:Blue;">public</span> <span style="color:Blue;">static</span> <span style="color:Blue;">bool</span> TryParse(<span style="color:Blue;">string</span> source, <span style="color:Blue;">out</span> Number result)
     {
        <span style="color:Green;">// ..</span>
        <span style="color:Blue;">return</span> parsed;
     }
 }
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">04</div>
<p>This example seems a little strange, and it is for a reason. I made this code slightly arti&shy;fi&shy;cial to show the impor&shy;tance of prob&shy;lems appe&shy;a&shy;ring in it. First&shy;, let’s look at the <code>Parse</code> method. Why should it throw an excep&shy;tion?</p>
<div class="paragraph-right-side">04</div>
</div>
<ul>
<li>Because the para&shy;meter it accepts is a string, but its output is a number, which is a value type. This number can’t indi&shy;cate vali&shy;dity of calcu&shy;la&shy;tions: it just exists. In other words, the method has no means in its inter&shy;face to commu&shy;ni&shy;cate a poten&shy;tial problem.</li>
<li>On the other hand, the method expects a correct string that contains some number and no redun&shy;dant char&shy;acters. If it doesn’t contain, there is a problem in prere&shy;qu&shy;i&shy;sites to the method: the code which calls our method has passed wrong data.</li>
</ul>
<div class="paragraph-container">
<div class="paragraph-left-side">05</div>
<p>Thus&shy;, the situ&shy;a&shy;tion when this method gets a string with incor&shy;rect data is excep&shy;ti&shy;onal because the method can return neither a correct value nor anything.  Thus&shy;, the only way is to throw an excep&shy;tion.</p>
<div class="paragraph-right-side">05</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">06</div>
<p>The second variant of the method can signal some prob&shy;lems with input data: the return value here is <code>boo&shy;lean</code> which indi&shy;cates successful exe&shy;cu&shy;tion of the method. This method doesn’t need to use excep&shy;tions to signal any prob&shy;lems: they are all covered by the <code>false</code> return value.</p>
<div class="paragraph-right-side">06</div>
</div>
<h2 id="overview">Over&shy;view</h2>
<div class="paragraph-container">
<div class="paragraph-left-side">07</div>
<p>Excep&shy;tions han&shy;dling might look as easy as ABC: we just need to place <code>try-catch</code> blocks and wait for corres&shy;pon&shy;ding events. However&shy;, this simp&shy;li&shy;city became possible due to the tremen&shy;dous work of CLR and Core&shy;CLR teams that uni&shy;fied all the errors that come from all direc&shy;tions and sources into the CLR. To unders&shy;tand what we are going to talk about next, let’s look at a diagram:</p>
<div class="paragraph-right-side">07</div>
</div>
<p><img src="./imgs/CommonScheme.png" alt="" /></p>
<div class="paragraph-container">
<div class="paragraph-left-side">08</div>
<p>We can see that inside big .NET Frame&shy;work there are two worlds: everything that belongs to CLR and everything that doesn’t, inclu&shy;ding all possible errors appe&shy;a&shy;ring in Windows and other parts of the unsafe world.</p>
<div class="paragraph-right-side">08</div>
</div>
<ul>
<li>Struc&shy;tured Excep&shy;tion Hand&shy;ling (SEH) is a stan&shy;dard way Windows han&shy;dles excep&shy;tions. When <code>unsafe</code> methods are called and excep&shy;tions are thrown, there is the unsafe <-> CLR conver&shy;sion of excep&shy;tions in both direc&shy;tions: from unsafe to CLR and back&shy;ward. This is because CLR can call an unsafe method which can call a CLR method in turn.</li>
<li>Vectored Excep&shy;tion Hand&shy;ling (VEH) is a root of SEH and allows you to put your han&shy;dlers in places where excep&shy;tions might be thrown. In parti&shy;cular, it used for placing <code>First&shy;Chance&shy;Exception</code>.</li>
<li>COM+ excep&shy;tions appear when the source of a problem is a COM compo&shy;nent. In this case, a layer between COM and a .NET method must convert a COM error into a .NET excep&shy;tion.</li>
<li>And&shy;, of course, wrap&shy;pers for HRESULT. They are intro&shy;duced to convert a Win&shy;API model (an error code is conta&shy;ined in a return value, while return values are obta&shy;ined using method para&shy;me&shy;ters) into a model of excep&shy;tions because it is an excep&shy;tion that is stan&shy;dard for .NET.</li>
</ul>
<div class="paragraph-container">
<div class="paragraph-left-side">09</div>
<p>On the other hand, there are langu&shy;ages above CLI each of which more or less have functions for han&shy;dling excep&shy;tions. For example, recently VB.NET or F# had a richer excep&shy;tion han&shy;dling functi&shy;o&shy;na&shy;lity expressed in a number of filters that didn’t exist in C#.</p>
<div class="paragraph-right-side">09</div>
</div>
<h2 id="return-codes-vs.exception">Return codes vs. excep&shy;tion</h2>
<div class="paragraph-container">
<div class="paragraph-left-side">10</div>
<p>Separately&shy;, I should mention a model of han&shy;dling appli&shy;ca&shy;tion errors using return codes. The idea of simply retur&shy;ning an error is plain and clear. Moreover&shy;, if we treat excep&shy;tions as a <code>goto</code> ope&shy;rator, the use of return codes becomes more rea&shy;so&shy;nable: in this case, the user of a method sees the possi&shy;bi&shy;lity of errors and can unders&shy;tand which errors may occur. However&shy;, let’s not guess what is better and for what, but discuss the problem of choice using a well rea&shy;soned theory.</p>
<div class="paragraph-right-side">10</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">11</div>
<p>Let’s suppose that all methods have inter&shy;faces to deal with errors. Then all methods would look like:</p>
<div class="paragraph-right-side">11</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">public</span> <span style="color:Blue;">bool</span> TryParseInteger(<span style="color:Blue;">string</span> source, <span style="color:Blue;">out</span> <span style="color:Blue;">int</span> result);

<span style="color:Blue;">public</span> DialogBoxResult OpenDialogBox(...);
<span style="color:Blue;">public</span> WebServiceResult IWebService.GetClientsList(...);

<span style="color:Blue;">public</span> <span style="color:Blue;">class</span> DialogBoxResult : ResultBase { ... }
<span style="color:Blue;">public</span> <span style="color:Blue;">class</span> WebServiceResult : ResultBase { ... }
</pre></div>
</div>
<p>And their use would look like:</p>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>

<span style="color:Blue;">public</span> ShowClientsResult ShowClients(<span style="color:Blue;">string</span> <span style="color:Blue;">group</span>)
{
    <span style="color:Blue;">if</span>(!TryParseInteger(<span style="color:Blue;">group</span>, <span style="color:Blue;">out</span> <span style="color:Blue;">var</span> clientsGroupId))
        <span style="color:Blue;">return</span> <span style="color:Blue;">new</span> ShowClientsResult { Reason = ShowClientsResult.Reason.ParsingFailed };

    <span style="color:Blue;">var</span> webResult = _service.GetClientsList(clientsGroupId);
    <span style="color:Blue;">if</span>(!webResult.Successful)
    {
        <span style="color:Blue;">return</span> <span style="color:Blue;">new</span> ShowClientsResult { Reason = ShowClientsResult.Reason.ServiceFailed, WebServiceResult = webResult };
    }

    <span style="color:Blue;">var</span> dialogResult = _dialogsService.OpenDialogBox(webResult.Result);
    <span style="color:Blue;">if</span>(!dialogResult.Successful)
    {
        <span style="color:Blue;">return</span> <span style="color:Blue;">new</span> ShowClientsResult { Reason = ShowClientsResult.Reason.DialogOpeningFailed, DialogServiceResult = dialogResult };
    }

    <span style="color:Blue;">return</span> ShowClientsResult.Success();
}
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">12</div>
<p>You may think this code is over&shy;lo&shy;aded with error han&shy;dling. However&shy;, I would like you to recon&shy;sider your posi&shy;tion: everything here is an emu&shy;la&shy;tion of a mech&shy;anism that throws and han&shy;dles excep&shy;tions.</p>
<div class="paragraph-right-side">12</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">13</div>
<p>How can a method report a problem? It can do it by using an inter&shy;face for repor&shy;ting errors. For example, in <code>Try&shy;Parse&shy;Integer</code> method such inter&shy;face is repre&shy;sented by a return value: if everything is OK, the method will return <code>true</code>. If it’s not OK, it will return <code>false</code>. However&shy;, there is a disad&shy;van&shy;tage here: the real value is returned via <code>out int result</code> para&shy;meter. The disad&shy;van&shy;tage is that on the one hand the return value is logi&shy;cally and by percep&shy;tion has more "return value” essence than that of <code>out</code> para&shy;meter. On the other hand, we don’t always care about errors. Indeed&shy;, if a string intended for parsing comes from a service that gene&shy;rated this string, we don’t need to check it for errors: the string will always be correct and good for parsing. However&shy;, suppose we take another imple&shy;men&shy;ta&shy;tion of the method:</p>
<div class="paragraph-right-side">13</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">public</span> <span style="color:Blue;">int</span> ParseInt(<span style="color:Blue;">string</span> source);
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">14</div>
<p>Then&shy;, there is a ques&shy;tion: if a string does have errors, what should the method do? Should it return zero? This won’t be correct: there is no zero in the string. In this case, we have a conf&shy;lict of inte&shy;rests: the first variant has too much code, while the second variant has no means to report errors. However&shy;, it’s actu&shy;ally easy to decide when to use return codes and when to use excep&shy;tions.</p>
<div class="paragraph-right-side">14</div>
</div>
<blockquote>
<p>If getting an error is a norm, choose a return code. For example, it is normal when a text parsing algo&shy;rithm enco&shy;un&shy;ters errors in a text, but if another algo&shy;rithm that works with a parsed string gets an error from a parser, it can be critical or, in other words, excep&shy;ti&shy;onal.</p>
</blockquote>
<h2 id="try-catch-finally-in-brief">Try&shy;-Catch&shy;-Finally in brief</h2>
<div class="paragraph-container">
<div class="paragraph-left-side">15</div>
<p>A <code>try</code> block covers a section where a prog&shy;rammer expects to get a critical situ&shy;a&shy;tion which is treated as a norm by external code. In other words, if some code consi&shy;ders its internal state incon&shy;sis&shy;tent based on some rules and throws an excep&shy;tion, an external system, which has a broader view of the same situ&shy;a&shy;tion, can catch this excep&shy;tion using a <code>catch</code> block and norma&shy;lize the exe&shy;cu&shy;tion of appli&shy;ca&shy;tion code. Thus&shy;, <em>you lega&shy;lize excep&shy;tions in this section of code by catching them</em>. I think it is an impor&shy;tant idea that justi&shy;fies the ban on catching all <code>try-catch(Excep&shy;tion ex){ ...}</code> excep&shy;tions <em>just in case</em>.</p>
<div class="paragraph-right-side">15</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">16</div>
<p>It doesn’t mean that catching excep&shy;tions cont&shy;ra&shy;dicts some ide&shy;o&shy;logy. I say that you should catch only the errors that you expect from a parti&shy;cular section of code. For example, you can’t expect all types of excep&shy;tions inhe&shy;rited from <code>Argument&shy;Exception</code> or you can’t get <code>Null&shy;Reference&shy;Exception</code>, because often it means that a problem is rather in <em>your</em> code than in a called one. But it’s approp&shy;riate to expect that you won’t be able to open an intended file. Even if you 200% sure you will be able, don’t forget to check.</p>
<div class="paragraph-right-side">16</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">17</div>
<p>The <code>finally</code> block is also well known. It is suitable for all cases covered by <code>try-catch</code> blocks. Except for several rare <em>special</em> situ&shy;a&shy;tions, this block will <em>always</em> work. Why was such a guarantee of perfor&shy;mance intro&shy;duced? To clean up those reso&shy;urces and groups of objects which were allo&shy;cated or captured in <code>try</code> block and which this block has respon&shy;si&shy;bi&shy;lity for.</p>
<div class="paragraph-right-side">17</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">18</div>
<p>This block is often used without <code>catch</code> block when we don’t care which error broke an algo&shy;rithm, but we need to clean up all reso&shy;urces allo&shy;cated for this algo&shy;rithm. Let’s look at a simple example: a file copying algo&shy;rithm needs two open files and a memory range for a cash buffer. Imagine that we allo&shy;cated memory and opened one file, but couldn’t open another one. To wrap everything in one "tran&shy;sac&shy;tion” ato&shy;mi&shy;cally we put all three ope&shy;ra&shy;tions in a single <code>try</code> block (as a variant of imple&shy;men&shy;ta&shy;tion) with reso&shy;urces cleaned in <code>finally</code>. It may seem like a simp&shy;li&shy;fied example but the most impor&shy;tant is to show the essence.</p>
<div class="paragraph-right-side">18</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">19</div>
<p>What C# actu&shy;ally lacks is a <code>fault</code> block which is acti&shy;vated whe&shy;never an error occurs. It’s like <code>finally</code> on steroids. If we had this, we could, for example, create a single entry point to log excep&shy;ti&shy;onal situ&shy;a&shy;tions:</p>
<div class="paragraph-right-side">19</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">try</span> {
    <span style="color:Green;">//...</span>
} fault exception
{
    _logger.Warn(exception);
}

</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">20</div>
<p>Another thing I should touch in this intro&shy;duc&shy;tion is excep&shy;tion filters. It is not a new fea&shy;ture on the .NET plat&shy;form but C# deve&shy;lo&shy;pers may be new to it: excep&shy;tion filte&shy;ring appe&shy;ared only in v. 6.0. Filters should norma&shy;lize a situ&shy;a&shy;tion when there is a single type of excep&shy;tion that combines several types of errors. It should help us when we want to deal with a parti&shy;cular scenario but have to catch the whole group of errors first and filter them later. Of course, I mean the code of the follo&shy;wing type:</p>
<div class="paragraph-right-side">20</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">try</span> {
    <span style="color:Green;">//...</span>
}
<span style="color:Blue;">catch</span> (ParserException exception)
{
    <span style="color:Blue;">switch</span>(exception.ErrorCode)
    {
        <span style="color:Blue;">case</span> ErrorCode.MissingModifier:
            <span style="color:Green;">// ...</span>
            <span style="color:Blue;">break</span>;
        <span style="color:Blue;">case</span> ErrorCode.MissingBracket:
            <span style="color:Green;">// ...</span>
            <span style="color:Blue;">break</span>;
        <span style="color:Blue;">default</span>:
            <span style="color:Blue;">throw</span>;
    }
}
</pre></div>
</div>
<p>Well&shy;, we can now rewrite this code properly:</p>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">try</span> {
    <span style="color:Green;">//...</span>
}
<span style="color:Blue;">catch</span> (ParserException exception) when (exception.ErrorCode == ErrorCode.MissingModifier)
{
    <span style="color:Green;">// ...</span>
}
<span style="color:Blue;">catch</span> (ParserException exception) when (exception.ErrorCode == ErrorCode.MissingBracket)
{
    <span style="color:Green;">// ...</span>
}
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">21</div>
<p>The impro&shy;ve&shy;ment here is not in the lack of <code>switch</code> construct. I believe this new construct is better in several things:</p>
<div class="paragraph-right-side">21</div>
</div>
<ul>
<li>using <code>when</code> for filte&shy;ring we catch exactly what we want and it’s right in terms of ide&shy;o&shy;logy;</li>
<li>the code becomes more readable in this new form. Loo&shy;king through code our brain can iden&shy;tify blocks for han&shy;dling errors more easily as it ini&shy;ti&shy;ally searches for <code>catch</code> and not <code>switch-case</code>;</li>
<li>the last but not least: a preli&shy;mi&shy;nary compa&shy;rison is BEFORE ente&shy;ring the catch block. It means that if we make wrong guesses about poten&shy;tial situ&shy;a&shy;tions, this construct will work faster than <code>switch</code> in the case of throwing an excep&shy;tion again.</li>
</ul>
<div class="paragraph-container">
<div class="paragraph-left-side">22</div>
<p>Many sources say that the pecu&shy;liar fea&shy;ture of this code is that filte&shy;ring happens <em>before</em> stack unrol&shy;ling. You can see this in situ&shy;a&shy;tions when there are no other calls except usual between the place where an excep&shy;tion is thrown and the place where filte&shy;ring check occurs.</p>
<div class="paragraph-right-side">22</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">static</span> <span style="color:Blue;">void</span> Main()
{
    <span style="color:Blue;">try</span>
    {
        Foo();
    }
    <span style="color:Blue;">catch</span> (Exception ex) when (Check(ex))
    {
        ;
    }
}

<span style="color:Blue;">static</span> <span style="color:Blue;">void</span> Foo()
{
    Boo();
}

<span style="color:Blue;">static</span> <span style="color:Blue;">void</span> Boo()
{
    <span style="color:Blue;">throw</span> <span style="color:Blue;">new</span> Exception(<span style="color:#A31515;">&quot;1&quot;</span>);
}

<span style="color:Blue;">static</span> <span style="color:Blue;">bool</span> Check(Exception ex)
{
    <span style="color:Blue;">return</span> ex.Message == <span style="color:#A31515;">&quot;1&quot;</span>;
}
</pre></div>
</div>
<p><img src="./imgs/StackWOutUnrolling.png" alt="Stack without unrol&shy;ling" /></p>
<div class="paragraph-container">
<div class="paragraph-left-side">23</div>
<p>You can see from the image that the stack trace contains not only the first call of <code>Main</code> as the point to catch an excep&shy;tion, but the whole stack before the point of throwing an excep&shy;tion plus the second ente&shy;ring into <code>Main</code> via unma&shy;naged code. We can suppose that this code is exactly the code for throwing excep&shy;tions that is in the stage of filte&shy;ring and choosing a final han&shy;dler. However&shy;, <em>not all calls can be han&shy;dled without stack unrol&shy;ling</em>. I believe that exces&shy;sive uni&shy;for&shy;mity of the plat&shy;form gene&shy;rates too much confi&shy;dence in it. For example, when one domain calls a method from another domain it is abso&shy;lu&shy;tely trans&shy;pa&shy;rent in terms of code. However&shy;, the way methods calls work is an abso&shy;lu&shy;tely diffe&shy;rent story. We are going to talk about them in the next part.</p>
<div class="paragraph-right-side">23</div>
</div>
<h3 id="serialization">Seri&shy;a&shy;li&shy;za&shy;tion</h3>
<div class="paragraph-container">
<div class="paragraph-left-side">24</div>
<p>Let’s start by loo&shy;king at the results of running the follo&shy;wing code (I added the transfer of a call across the boun&shy;dary between two appli&shy;ca&shy;tion domains).</p>
<div class="paragraph-right-side">24</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
    <span style="color:Blue;">class</span> Program
    {
        <span style="color:Blue;">static</span> <span style="color:Blue;">void</span> Main()
        {
            <span style="color:Blue;">try</span>
            {
                ProxyRunner.Go();
            }
            <span style="color:Blue;">catch</span> (Exception ex) when (Check(ex))
            {
                ;
            }
        }

        <span style="color:Blue;">static</span> <span style="color:Blue;">bool</span> Check(Exception ex)
        {
            <span style="color:Blue;">var</span> domain = AppDomain.CurrentDomain.FriendlyName; <span style="color:Green;">// -&gt; TestApp.exe</span>
            <span style="color:Blue;">return</span> ex.Message == <span style="color:#A31515;">&quot;1&quot;</span>;
        }

        <span style="color:Blue;">public</span> <span style="color:Blue;">class</span> ProxyRunner : MarshalByRefObject
        {
            <span style="color:Blue;">private</span> <span style="color:Blue;">void</span> MethodInsideAppDomain()
            {
                <span style="color:Blue;">throw</span> <span style="color:Blue;">new</span> Exception(<span style="color:#A31515;">&quot;1&quot;</span>);
            }

            <span style="color:Blue;">public</span> <span style="color:Blue;">static</span> <span style="color:Blue;">void</span> Go()
            {
                <span style="color:Blue;">var</span> dom = AppDomain.CreateDomain(<span style="color:#A31515;">&quot;PseudoIsolated&quot;</span>, <span style="color:Blue;">null</span>, <span style="color:Blue;">new</span> AppDomainSetup
                {
                    ApplicationBase = AppDomain.CurrentDomain.BaseDirectory
                });
                <span style="color:Blue;">var</span> proxy = (ProxyRunner) dom.CreateInstanceAndUnwrap(<span style="color:Blue;">typeof</span>(ProxyRunner).Assembly.FullName, <span style="color:Blue;">typeof</span>(ProxyRunner).FullName);
                proxy.MethodInsideAppDomain();
            }
        }
    }

</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">25</div>
<p>We can see that stack unrol&shy;ling happens before we get to filte&shy;ring. Let’s look at screenshots. The first is taken before the gene&shy;ra&shy;tion of an excep&shy;tion:</p>
<div class="paragraph-right-side">25</div>
</div>
<p><img src="./imgs/StackUnroll.png" alt="Stack&shy;Unroll" /></p>
<p>The second one is after it:</p>
<p><img src="./imgs/StackUnroll2.png" alt="Stack&shy;Unroll2" /></p>
<div class="paragraph-container">
<div class="paragraph-left-side">26</div>
<p>Let’s study call tracing before and after excep&shy;tions are filtered. What happens here? We can see that plat&shy;form deve&shy;lo&shy;pers made something that at first glance looks like the protec&shy;tion of a subdo&shy;main. The tracing is cut after the last method in the call chain and then there is the transfer to another domain. But I think this looks strange. To unders&shy;tand why this happens let’s remember the main rule for types that orga&shy;nize the inte&shy;rac&shy;tion between domains. These types should inherit <code>Marshal&shy;By&shy;Ref&shy;Object</code> and be seri&shy;a&shy;li&shy;zable. However&shy;, despite the stric&shy;tness of C# excep&shy;tion types can be of any nature. What does it mean? This means that situ&shy;a&shy;tions may occur when an excep&shy;tion inside a subdo&shy;main can be caught in a parent domain. Also&shy;, if a data object that can get into an excep&shy;ti&shy;onal situ&shy;a&shy;tion has some methods that are dange&shy;rous in terms of secu&shy;rity they can be called in a parent domain. To avoid this, the excep&shy;tion is first seri&shy;a&shy;lized and then it crosses the boun&shy;dary between appli&shy;ca&shy;tion domains and appears again with a new stack. Let’s check this theory:</p>
<div class="paragraph-right-side">26</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
[StructLayout(LayoutKind.Explicit)]
<span style="color:Blue;">class</span> Cast
{
    [FieldOffset(0)]
    <span style="color:Blue;">public</span> Exception Exception;

    [FieldOffset(0)]
    <span style="color:Blue;">public</span> <span style="color:Blue;">object</span> obj;
}

<span style="color:Blue;">static</span> <span style="color:Blue;">void</span> Main()
{
    <span style="color:Blue;">try</span>
    {
        ProxyRunner.Go();
        Console.ReadKey();
    }
    <span style="color:Blue;">catch</span> (RuntimeWrappedException ex) when (ex.WrappedException <span style="color:Blue;">is</span> Program)
    {
        ;
    }
}

<span style="color:Blue;">static</span> <span style="color:Blue;">bool</span> Check(Exception ex)
{
    <span style="color:Blue;">var</span> domain = AppDomain.CurrentDomain.FriendlyName; <span style="color:Green;">// -&gt; TestApp.exe</span>
    <span style="color:Blue;">return</span> ex.Message == <span style="color:#A31515;">&quot;1&quot;</span>;
}

<span style="color:Blue;">public</span> <span style="color:Blue;">class</span> ProxyRunner : MarshalByRefObject
{
    <span style="color:Blue;">private</span> <span style="color:Blue;">void</span> MethodInsideAppDomain()
    {
        <span style="color:Blue;">var</span> x = <span style="color:Blue;">new</span> Cast {obj = <span style="color:Blue;">new</span> Program()};
        <span style="color:Blue;">throw</span> x.Exception;
    }

    <span style="color:Blue;">public</span> <span style="color:Blue;">static</span> <span style="color:Blue;">void</span> Go()
    {
        <span style="color:Blue;">var</span> dom = AppDomain.CreateDomain(<span style="color:#A31515;">&quot;PseudoIsolated&quot;</span>, <span style="color:Blue;">null</span>, <span style="color:Blue;">new</span> AppDomainSetup
        {
            ApplicationBase = AppDomain.CurrentDomain.BaseDirectory
        });
        <span style="color:Blue;">var</span> proxy = (ProxyRunner)dom.CreateInstanceAndUnwrap(<span style="color:Blue;">typeof</span>(ProxyRunner).Assembly.FullName, <span style="color:Blue;">typeof</span>(ProxyRunner).FullName);
        proxy.MethodInsideAppDomain();
    }
}
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">27</div>
<p>For C# code could throw an excep&shy;tion of any type (I don’t want to torture you with MSIL) I performed a trick in this example casting a type to a noncom&shy;pa&shy;rable one, so we could throw an excep&shy;tion of any type, but the trans&shy;lator would think that we use <code>Excep&shy;tion</code> type. We create an instance of the <code>Program</code> type, which is not seri&shy;a&shy;li&shy;zable for sure, and throw an excep&shy;tion using this type as workload. The good news is that you get a wrapper for non-Excep&shy;tion excep&shy;tions of <code>Runtime&shy;Wrapped&shy;Exception</code> which will store an instance of our <code>Program</code> type object inside and we will be able to catch this excep&shy;tion. However&shy;, there is bad news that supports our idea: calling <code>proxy.Method&shy;Inside&shy;App&shy;Domain&shy;();</code> will gene&shy;rate <code>Serialization&shy;Exception</code>:</p>
<div class="paragraph-right-side">27</div>
</div>
<p><img src="./imgs/SerializationError.png" alt="" /></p>
<div class="paragraph-container">
<div class="paragraph-left-side">28</div>
<p>Thus&shy;, you can’t transfer such an excep&shy;tion between domains as it is not possible to seri&shy;a&shy;lize it. This&shy;, in turn, means that using excep&shy;tion filters for wrap&shy;ping methods calls in other domains will anyway lead to stack unrol&shy;ling despite that the seri&shy;a&shy;li&shy;za&shy;tion seems to be unne&shy;ces&shy;sary with <code>Full&shy;Trust</code> settings of a subdo&shy;main.</p>
<div class="paragraph-right-side">28</div>
</div>
<blockquote>
<p>We should pay addi&shy;ti&shy;onal atten&shy;tion to the reason why seri&shy;a&shy;li&shy;za&shy;tion between domains is so neces&shy;sary. In our arti&shy;fi&shy;cial example, we create a subdo&shy;main which doesn’t have any settings. It means it works in Full&shy;Trust way. CLR fully trusts its content and doesn’t run any addi&shy;ti&shy;onal checks. However&shy;, when you insert at least one secu&shy;rity setting, the full trust will disap&shy;pear and CLR will start cont&shy;rol&shy;ling everything that happens inside a subdo&shy;main. So&shy;, when you have a fully trusted domain you don’t need a seri&shy;a&shy;li&shy;za&shy;tion. Admit&shy;, we don’t need to protect ourse&shy;lves. But seri&shy;a&shy;li&shy;za&shy;tion exists not only for protec&shy;tion. Each domain loads all neces&shy;sary assem&shy;blies a second time and creates their copies. Thus&shy;, it creates copies of all types and all VMTs&shy;. Of course, when passing an object from domain to domain you will get the same object. But its VMTs won’t be its own and this object can’t be cast to another type. In other words, if we create an instance of a <code>Boo</code> type and get it in another domain the casting of <code>(Boo&shy;)boo</code> won’t work. In this case, seri&shy;a&shy;li&shy;za&shy;tion and dese&shy;ri&shy;a&shy;li&shy;za&shy;tion will solve the problem as the object will exist in two domains simul&shy;ta&shy;neously. It will exist with all its data where it was created and it will exist in the domain of usage as a proxy object, ensu&shy;ring that methods of an ori&shy;ginal object are called.</p>
</blockquote>
<div class="paragraph-container">
<div class="paragraph-left-side">29</div>
<p>By trans&shy;fer&shy;ring a seri&shy;a&shy;lized object between domains you get a full copy of the object from one domain in another one while kee&shy;ping some deli&shy;mi&shy;ta&shy;tion in memory. However&shy;, this deli&shy;mi&shy;ta&shy;tion is ficti&shy;onal. It is used only for those types that are not in <code>Shared App&shy;Domain</code>. Thus&shy;, if you throw something non-seri&shy;a&shy;li&shy;zable as an excep&shy;tion, but from <code>Shared App&shy;Domain</code>, you won’t get an error of seri&shy;a&shy;li&shy;za&shy;tion (we can try throwing <code>Action</code> instead of <code>Program</code>). However&shy;, stack unrol&shy;ling will anyway occur in this case: as both vari&shy;ants should work in a stan&shy;dard way. So that nobody will be confused.</p>
<div class="paragraph-right-side">29</div>
</div>

        </div>
        <footer>
            <div class="footer-container">
                <div class="footer-wrap">
                    <img src="../../res/img/logo-w-noindex.svg">
                    <p>
                        <a class="footer-link" target="_blank" href="mailto:sidristij@clrium.ru"><i class="far fa-envelope" aria-hidden="true"></i></a>
                        <a class="footer-link" target="_blank" href="https://vk.com/clrium"><i class="fab fa-vk" aria-hidden="true"></i></a>
                        <a class="footer-link" target="_blank" href="https://youtube.com/clrium"><i class="fab fa-youtube" aria-hidden="true"></i></a>
                        <a class="footer-link" target="_blank" href="https://github.com/clrium"><i class="fab fa-github" aria-hidden="true"></i></a>
                        <a class="footer-link" target="_blank" href="skype:stanislav.sidristyi"><i class="fab fa-skype" aria-hidden="true"></i></a>
                        <a class="footer-link" target="_blank" href="https://t.me/clrium_group"><i class="fab fa-telegram" aria-hidden="true"></i></a>
                    </p>
                </div>
            </div>
        </footer>
    </div>
</body>
</html>