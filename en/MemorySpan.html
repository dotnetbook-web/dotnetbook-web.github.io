<!DOCTYPE html>
<html lang="ru">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>.NET Platform Architecture</title>
</head>
<body>
    <script src="../res/jquery.js"></script>
    <link rel="stylesheet" href="../res/bootstrap.css">
    <link rel="stylesheet" href="../res/awesome.css">
    <style>

body {
    font-family: PF Regal,Georgia,serif;
    font-size: 16pt;
    font-weight: 300;
    padding-top: 4em;
    background-color: #fdfdfd;
}

.book-title-container {
    width: 100%;
    text-align: center;
    margin: 73px 0 110px 0;
}

.book-title {
    font-size: 57pt;
    margin: 50px 0 70px 0;
    user-select: none;
}
.book-part-title-block {
    display: inline-block;
}
.book-part-title {
    font-size: 21pt;
    color: #656ab6;
    margin: 0 7px;
}

.book-part-title:hover {
    box-shadow: inset 0 -1px #007bff;
    text-decoration: none;
}

.book-superheading-title {
    font-size: 15pt;
    margin: 0 7px;
    color: #656ab6;
}

.article-container
{
    width: 62%;
}

strong {
    font-weight: 500;
}

p, li {
    margin: 0 0 1em;
    line-height: 1.5em;
    font-family: inherit;
}

ol, li {
    margin-top: 1em;
    margin-bottom: 1em;
}

ol {
    padding-left: 1.21em;
}

ul  {
    padding-left: 1em;
}

ol li, ul li {
    padding-left: 0.5em;	
    font-family: inherit;
    text-align: justify;
}

.table-container {
    display: block;
    margin-top: 2.1em;
    width: 100%;
}

.table-container + p.description {
    font-size: 0.8em;
    font-style: italic;
    text-align: center;
    margin-top: 0.5em;
}

.table-width-6 
{
    margin-left: 25%;
    margin-right: 25%;
}

.table-width-8 
{
    margin-left: 12.5%;
    margin-right: 12.5%;
}

.table-width-10 
{
    margin-left: 6.25%;
    margin-right: 6.25%;
}

.table-width-12 
{
    margin-left: 0;
    margin-right: 0;
}

table {
    width: 100%;
}

thead {
    background-color: aliceblue;
}

table th {
    font-weight: 400;
}

table td, table th {
    padding: 7px;
    border-top: solid darkgrey 1px;
    border-bottom: solid darkgrey 1px;
    border-right: dotted darkgray 1px;
    border-left: dotted darkgray 1px;
    font-size: smaller;
}

code, *[class*='lang-'] span, *[class*='lang-'] pre {
    font-family: JB Mono, monospace !important;
}

*[class*='lang-'] {
    padding: 0px 0px 25px 0px;
    font-size: 0.75em;
}


*[class*='lang-'] > div, pre > code {
    border-left-color: #eee;
    border-left-style: dotted;
    border-left-width: 3px;
    padding-left: 25px;
    display: block;
    padding-top: 20px;
    padding-bottom: 20px;
}

*[class*='lang-'] > div pre, pre > code pre {
    margin-bottom: 0;
}

p code:not(.highlight), li code:not(.highlight) {
    font-size: 0.7em;
    color: darkslateblue;
}

/* style for manual selecting */
.box {
    padding: 3px;
    border: gainsboro;
    border-width: 1px;
    border-style: solid;
}

code.highlight {
    font-family: inherit !important;
    font-size: inherit;
    font-weight: inherit;
    color: inherit;
}

p code.highlight, li code.highlight {
    padding: 4px;
    background-color: #ffffa1;
}

.wide {
    width:140%;
}

p a, li a {
    text-decoration: none;
    color: inherit;
    box-shadow: inset 0 -1px #b88b59;
}

p a:hover, li a:hover {
    text-decoration: none;
    color: inherit;
    box-shadow: inset 0 -1px #0056b3;
}

blockquote h5 {
    background-color: aquamarine;
    margin: 16px 0 16px -20px;
    padding: 15px 30px 15px;
}

p img {
    width: 95%;
}

blockquote 
{
    padding-left: 0.4em;
    border-left: 0.5em solid rgba(0,0,0,.08);
    font-style: italic;
}

blockquote.big-quote, 
blockquote.breadcrumbs 
{
    background-color: transparent;
    padding: 0;
    border-left: none;
    font-style: normal;
}

blockquote.breadcrumbs, blockquote.breadcrumbs  p
{
    margin: 0;
    padding: 0;
}

blockquote p {
    padding: 1em 1em 1em 0.6em;
    font-family: inherit;
}

blockquote p code {
    font-family: consolas, monospace;
    font-size: 17px;
    padding: 4px 6px;
}

blockquote p em {
    font-weight: 400;
}

blockquote.big-quote > p {
    margin: 0.7em 0 0.7em 0;
    font-family: Charter;
    font-size: 2.5em;
    padding: 0;
    width: 130%;
    line-height: 1em;
}

h1, h2, h3, h4, h5, h6 {
    margin: 0;
    padding: 0;
    font-weight: 400;
    font-family: inherit;
    hyphens: none;
}

h1 {
    font-size: 2.2em;
    font-family: Charter,Georgia,serif;
    font-weight: 300;
    margin: 1.8em 0 1.8em 0;
    text-align: center;
    width: 140%;
}

h2 {
    padding-top: 1.5em;
    padding-left: 1.5em;
    padding-right: 1.5em;
    margin-bottom: 0.5em;
    font-family: Charter, Arial, Helvetica Neue, sans-serif;
    font-size: 1.4em;
    text-align: center;
}

h3 {
    padding-top: 1.2em;
    font-family: Charter, Arial, Helvetica Neue, sans-serif;
    font-size: 1.15em;
    width: 70%;
}

h4 {
    padding: 1em 0 0 0;
    font-size: 1.2em;
    font-weight: 300;
    font-style: italic;
}

h5 {
    padding: 0.6em 0 0 0;
    font-weight: 300;
    font-size: 1.1em;
}

/* Sidenotes */

.aside-container {
    position: relative;
}
.aside-container p {
    position: relative;
    top: 9px;
}

.aside-container > .aside-side-container {
    display: block;
    position: absolute;
    top: 12px;
    left: 96%;
    width: 34%;
    font-size: 12pt;
    line-height: 20px;
    margin-left: 100px;
    z-index: 1000;
}

.aside-container > .aside-side-container p {
    line-height: 24px;
    font-size: 13pt;
    margin: 0 0 13px 0;
}

.side-regular-block p {
    top: 0;
}

/* Music side player */
.aside-side-container .music-player {
    width: 100%;
    height: 400px;
}

/* media block after h1 */
.aside-container h1 + .aside-side-container.side-media-block h2 {
    margin: 7em 0 1em 0;
    font-family: Proxima Nova,Arial,Helvetica Neue,sans-serif;
    font-weight: 600;
}

.aside-side-container > li {
    display: block;
    font-family: Charter;
}

.aside-side-container > li ul, .aside-side-container > li ol {
    padding-left: 30px;
    margin-top: 0.5em;
    margin-bottom: 0.5em;
}
.aside-side-container > li li {
    padding-left: 6px;
    margin: 0 0 6px;
    line-height: 22px;

    font-family: Charter;
}

.aside-side-container p {
    line-height: 25px;
    font-size: 13pt;
    margin: 0 0 15px 0;
}

.aside-side-container blockquote {
    border: aliceblue;
    border-left-style: solid;
}

/* Paragraphs numbering */
.paragraph-container {
    position: relative;
}
.paragraph-container p {
    position: relative;
    top: 9px;
}

.paragraph-container p, .aside-container > p {
    text-align: justify;
}

.paragraph-container > .paragraph-left-side, .paragraph-container > .paragraph-right-side  {
    font-family: JB Mono, consolas;
    display: block;
    position: absolute;
    top: 17px;
    font-size: 10pt;
    line-height: 20px;
    color: #86abc473;
    z-index: 1000;
}
.paragraph-container > .paragraph-left-side {
    display: none;
    left: -2.1cm;
    width: 35px;
    user-select: none;
}

.paragraph-container > .paragraph-right-side  {
    display: none;
    left: 100%;
    width: 35px;
    padding-left: 45px;
    user-select: none;
}

.article-container
{
    width: 70%;
}

/* X_MENU */
.menu-title {
    text-align: center;
    margin: 35px 50px 35px 50px;
    font-size: 24pt;
    font-family: Charter;
}

.menu-container ol {
    margin: 0;
    padding: 0;
}

.menu-container ol li {
    margin: 0;
    padding: 0;
}

.header {
    height: 2.5em;
    background-color: white;
    position: relative;
    z-index: 1500;
    width: 100%;
    display: flex;
    justify-content: space-between;
    transition: all 1s;
    top: 0;
    box-shadow: 1px -4px 20px rgba(0, 0, 0, .1);
}

.fixed {
    position: fixed !important;
}

.header > .menu {
    pointer-events: auto;
    float: right;
    height: 40px;
    font-family: Charter, 'Helvetica Neue', Arial, sans-serif;
    font-size: 1em;
    color: #fff;
    margin-top:40px;
    margin-right:40px;
}

.menu a {
    color: #fff;
}
.menu a:hover {
    text-decoration: none;
    color: #fff;
}

#menu__toggle {
    opacity: 0;
}

#menu__toggle:checked ~ .menu__btn > span {
    transform: rotate(45deg);
}
#menu__toggle:checked ~ .menu__btn > span::before {
    top: 0;
    transform: rotate(0);
    background-color: black
}
#menu__toggle:checked ~ .menu__btn > span::after {
    top: 0;
    transform: rotate(90deg);
    background-color: black
}
#menu__toggle:checked ~ .menu__box {
    visibility: visible;
    right: 0;
}

.menu__btn {
    display: flex;
    align-items: center;
    position: fixed;
    top: 0;
    right: 0;
    width: 2.5em;
    height: 2.5em;
    cursor: pointer;
    z-index: 1;
    margin: 0;
    padding: 0.7em;
}

.menu__btn > span,
.menu__btn > span::before,
.menu__btn > span::after {
    display: block;
    position: absolute;

    width: 1.1em;
    height: 1px;

    border-bottom: 1px black solid;

    transition-duration: .25s;
}
.menu__btn > span::before {
    content: '';
    top: -7px;
}
.menu__btn > span::after {
    content: '';
    top: 7px;
}

.menu__box {
    display: block;
    position: fixed;
    visibility: hidden;
    top: 0;
    right: -100%;

    width: 100%;
    height: 100%;

    margin: 0;
    padding: 80px 0;

    list-style: none;

    background-color: white;
    box-shadow: 1px 0px 6px rgba(0, 0, 0, .2);

    transition-duration: .25s;

    overflow-y: auto;
}
.menu__box li a:hover {
    text-decoration: none;
    color: inherit;
}
.menu__list {
    font-size: 0.9em;
    margin: 0 2em 0 2em;
}
.menu__list li {
    text-align: left;
}

/* X_HEADER */

.conflogo {
    margin: 0.5em 0 0 0.8em;
    font-size: 1.1em;
    font-family: Charter;
    user-select: none;
}

.invisible {
    display: none;
}

.header > .menu > div {
    display: inline;
    margin-left: 10px;
    margin-right: 10px;
}

.menu__header_current
{
    text-align: center;
    font-size: 2em;
    margin: 0 0 1em 0;
}

.menu__header_total
{
    text-align: center;
    font-size: 2.4em;
    margin: 1.7em 0 0.3em 0;
}
.menu__header_list 
{
    padding: 0;
    margin-top: 0;
    margin-left: 0;
    margin-right: 0;
}
.menu__header_list > li 
{
    display: inline-block;
    width: 100%;
    margin: 0;
    text-align: center;
    font-family: charter;
}
.menu__header_total_sub
{
    font-size: 1.4em;
    margin: 2em 0 1em 0;
}
.menu__header_total_sub2
{
    font-size: 1.1em;
    margin: 1.5em 0 0.6em 1em;
    text-align: left;
}
/* X_FOOTER */

footer {
    margin-top: 2em;
    background-color: black;
    height: 4em;
}

footer > div {
    box-shadow: 0px 2px 2px rgb(0, 0, 0);
}

.footer-container {
    height: 100%;
}

.footer-wrap {
    color: #fff;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 25px 0;
}

.footer-wrap p {
    margin: 0;
    padding: 0px;
    line-height: 1em;
}

.footer-container img {
    height: 1.6em;
    margin-top: auto;
    margin-bottom: auto;
}

.footer-link {
    color: white;
    margin: 0 7px;
    font-size: 1em;
    box-shadow: none;
}

.footer-link:hover {
    color: salmon;
    box-shadow: none;
}

/* MEDIA */
/* XXL */
@media (min-width: 1601px) {
    .book-container
    {
        max-width: 1200px;
        margin-left: auto;
        margin-right: auto;
    }
}

/* XL */
@media (max-width: 1600px) {
    .book-container
    {
        margin-left: 4cm;
        margin-right: 4cm;
    }
}

/* LG */
@media (max-width: 1400px) {
    .book-container
    {
        margin-left: 4cm;
        margin-right: 4cm;
    }

    blockquote.big-quote > p {
        font-size: 2em;
    }
    
    .table-width-6 
    {
        margin-left: 20%;
        margin-right: 20%;
    }

    .table-width-8 
    {
        margin-left: 10%;
        margin-right: 10%;
    }

    .table-width-10 
    {
        margin-left: 5%;
        margin-right: 5%;
    }
}

/* > MD */
@media (min-width: 992px) {
    .hamburger-menu {
        display: none;
    }
}

/* MD */
@media (max-width: 991px) {
    
    h3 {
        width:80%;
    }

    .book-container
    {
        margin-left: 3cm;
        margin-right: 3cm;
    }
    
    .book-title-container {
        margin: 73px 0 110px 0;
    }

    .book-title {
        font-size: 50pt;
        margin: 50px 0 70px 0;
    }

    .book-part-title {
        font-size: 19pt;
    }

    .book-part-title:hover {
        box-shadow: inset 0 -1px #007bff;
    }

    .book-superheading-title {
        font-size: 15pt;
    }                                     

    .article-container, h1 {
        width: 100%;
    }

    .aside-container p {
        top: 0;
    }

    .aside-container h1 + .aside-side-container.side-media-block h2 {
        display: none;
    }

    .wide {
        width: 100%;     
    }

    .side-regular-block {
        margin: 40px 10px;
        padding-left: 100px;
    }
    .aside-side-container .music-player {
        width: 100%;
        height: 100px;
    }
    .aside-side-container.side-media-block {
        padding: 17px 0;
    }
    .aside-side-container.side-media-block h2 {
        margin-top: 20px;
        font-size: 13pt;
        border: none;
    }

    .aside-container > .aside-side-container
    {
        position: relative;
        top: auto;
        left: auto;
        width: auto;
        height: auto;
        margin: 0;
        padding: 17px;
    }

    blockquote.big-quote > p {
        width: 100%;
        font-size: 2em;
    }

    .paragraph-container .paragraph-left-side {
        left: -55px;
    }

    body {
        font-size: 15pt;
    }

    p code:not(.highlight), li code:not(.highlight) {
        font-size: 11pt;
    }

    p, li {
        line-height: 30px;
    }
    
    li {
        margin: 0 0 10px 0;
    }

    .table-width-6 
    {
        margin-left: 25%;
        margin-right: 25%;
    }

    .table-width-8 
    {
        margin-left: 12.5%;
        margin-right: 12.5%;
    }

    .table-width-10 
    {
        margin-left: 6.25%;
        margin-right: 6.25%;
    }

    .side-regular-block {
        border-radius: 5px;
        background-image: linear-gradient(180deg,hsla(0,0%,100%,0) 60%,#fff),linear-gradient(70deg,#dbedff 32%,#ebfff0);
        padding: 22px;
    }    

    .menu__list
    {
        margin-top: 0;
        margin-bottom: 0;
    }

    .menu__list, .menu__header_total_sub2
    {
        margin-left: auto;
        margin-right: auto;
        max-width: 800px;
        width: 80%;
    }

    .book-container 
    {
        position: absolute;
        padding: 0 3cm 0 3cm;
        overflow: scroll;
        overflow-x: auto;
        top: 2.5em;
        bottom: 0;
        width: 100%;
        margin: 0;
    }

    footer {
        margin-top: 2em;
        background-color: black;
        height: 4em;
    }

    footer > div {
        position: relative;
        margin: 0 -3cm;
        background: black;
        padding: 0 3cm;
    }
}

/* Smartphone horizontal - SM */
@media (max-width: 767px) {
    .book-title-container {
        margin: 73px 0 110px 0;
    }

    h1 {
        margin: 1.8em 0em 1.8em 0.3em;
    }

    .book-title {
        font-size: 40pt;
        margin: 50px 0 70px 0;
    }

    .book-part-title {
        font-size: 19pt;
    }

    .book-part-title:hover {
        box-shadow: inset 0 -1px #007bff;
    }

    .book-superheading-title {
        font-size: 17pt;
    }

    .book-container {
        padding: 0 2.5cm;
    }
    ul {
        margin-left: 30px;
        margin-right: 30px;
        padding-left: 25px;
    }
    
    .table-width-6 
    {
        margin-left: 20%;
        margin-right: 20%;
    }

    .table-width-8 
    {
        margin-left: 10%;
        margin-right: 10%;
    }

    .table-width-10 
    {
        margin-left: 0%;
        margin-right: 0%;
    }
    
    .paragraph-container > .paragraph-left-side {
	    display: block;
        top: 14px;
        font-size: 9pt;
    }
    .paragraph-container > .paragraph-right-side {
    	display: block;
        padding-left: 40px;
        top: 14px;
        font-size: 9pt;
    }
    .footer-container img {
        height: 1.3em;
    } 
}

@media (max-width: 630px) {
    .book-container {
        padding: 0 1.5cm;
    }
    .paragraph-container > .paragraph-left-side {
        left: -33px;
    }
    .paragraph-container > .paragraph-right-side {
        padding-left: 24px;
    }
}
/* Smartphone - XS */
@media (max-width: 575px) {
    .book-container {
        padding: 0 50px 0 30px;
    }
    ul {
        margin: 0;
        padding-left: 20px;
    }

    body {
        font-size: 13pt;
    }

    p code:not(.highlight), li code:not(.highlight) 
    {
        font-size: 10pt;
        padding: 3px;
    }

    *[class*='lang-'] > div, pre > code {
        padding-left: 15px;
        padding-top: 15px;
        padding-bottom: 15px;
    }
    
    ol li, ul li {
        padding-left: 0.2em;	
    }
    
    p, li {
        line-height: 24px;
    }    

    .table-width-6 
    {
        margin-left: 0;
        margin-right: 0;
    }

    .table-width-8 
    {
        margin-left: 0%;
        margin-right: 0%;
    }

    .table-width-10 
    {
        margin-left: 0%;
        margin-right: 0%;
    }
    
    .paragraph-container .paragraph-left-side 
    {
        display: none;        
    }
    .paragraph-container .paragraph-right-side 
    {
        padding-left: 21px;
        top: 14px;
	    font-size: 8pt;
    }
    .footer-container img {
        height: 1em;
    } 
    .menu__list {
        margin: 0 1em 0 1em;
    }
    .menu__header_total_sub2
    {
        margin: 1.5em 0 0.6em 1em;
    }
}

/* Fonts */

@font-face {
    font-family: 'PF Regal';
    src: url('../res/fonts/PFRegalTextPro-Bold.eot');
    src: local('../res/fonts/PFRegalTextPro-Bold'),
        url('../res/fonts/PFRegalTextPro-Bold.woff2') format('woff2'),
        url('../res/fonts/PFRegalTextPro-Bold.woff') format('woff'),
        url('../res/fonts/PFRegalTextPro-Bold.ttf') format('truetype');
    font-weight: bold;
    font-style: normal;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../res/fonts/PFRegalTextPro-Medium.eot');
    src: local('../res/fonts/PFRegalTextPro-Medium'),
        url('../res/fonts/PFRegalTextPro-Medium.woff2') format('woff2'),
        url('../res/fonts/PFRegalTextPro-Medium.woff') format('woff'),
        url('../res/fonts/PFRegalTextPro-Medium.ttf') format('truetype');
    font-weight: 500;
    font-style: normal;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../res/fonts/PFRegalTextPro-BlackItalic.eot');
    src: local('../res/fonts/PFRegalTextPro-BlackItalic'),
        url('../res/fonts/PFRegalTextPro-BlackItalic.woff2') format('woff2'),
        url('../res/fonts/PFRegalTextPro-BlackItalic.woff') format('woff'),
        url('../res/fonts/PFRegalTextPro-BlackItalic.ttf') format('truetype');
    font-weight: 900;
    font-style: italic;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../res/fonts/PFRegalTextPro-Black.eot');
    src: local('../res/fonts/PFRegalTextPro-Black'),
        url('../res/fonts/PFRegalTextPro-Black.woff2') format('woff2'),
        url('../res/fonts/PFRegalTextPro-Black.woff') format('woff'),
        url('../res/fonts/PFRegalTextPro-Black.ttf') format('truetype');
    font-weight: 900;
    font-style: normal;
}

@font-face {
    font-family: 'PF Regal UBlack';
    src: url('../res/fonts/PFRegalTextPro-UBlack.eot');
    src: local('../res/fonts/PFRegalTextPro-UBlack'),
        url('../res/fonts/PFRegalTextPro-UBlack.woff2') format('woff2'),
        url('../res/fonts/PFRegalTextPro-UBlack.woff') format('woff'),
        url('../res/fonts/PFRegalTextPro-UBlack.ttf') format('truetype');
    font-weight: 900;
    font-style: normal;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../res/fonts/PFRegalTextPro-MediumItalic.eot');
    src: local('../res/fonts/PFRegalTextPro-MediumItalic'),
        url('../res/fonts/PFRegalTextPro-MediumItalic.woff2') format('woff2'),
        url('../res/fonts/PFRegalTextPro-MediumItalic.woff') format('woff'),
        url('../res/fonts/PFRegalTextPro-MediumItalic.ttf') format('truetype');
    font-weight: 500;
    font-style: italic;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../res/fonts/PFRegalTextPro-UBlackItalic.eot');
    src: local('../res/fonts/PFRegalTextPro-UBlackItalic'),
        url('../res/fonts/PFRegalTextPro-UBlackItalic.woff2') format('woff2'),
        url('../res/fonts/PFRegalTextPro-UBlackItalic.woff') format('woff'),
        url('../res/fonts/PFRegalTextPro-UBlackItalic.ttf') format('truetype');
    font-weight: 900;
    font-style: italic;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../res/fonts/PFRegalTextPro-RegularAItalic.eot');
    src: local('../res/fonts/PFRegalTextPro-RegularAItalic'),
        url('../res/fonts/PFRegalTextPro-RegularAItalic.woff2') format('woff2'),
        url('../res/fonts/PFRegalTextPro-RegularAItalic.woff') format('woff'),
        url('../res/fonts/PFRegalTextPro-RegularAItalic.ttf') format('truetype');
    font-weight: 300;
    font-style: italic;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../res/fonts/PFRegalTextPro-BoldItalic.eot');
    src: local('../res/fonts/PFRegalTextPro-BoldItalic'),
        url('../res/fonts/PFRegalTextPro-BoldItalic.woff2') format('woff2'),
        url('../res/fonts/PFRegalTextPro-BoldItalic.woff') format('woff'),
        url('../res/fonts/PFRegalTextPro-BoldItalic.ttf') format('truetype');
    font-weight: bold;
    font-style: italic;
}

@font-face {
    font-family: 'Charter';
    src: url('../res/fonts/charter-regular.woff2') format('woff2');
    font-weight: normal;
    font-style: normal;
}

/*  Regular B */
@font-face {
    font-family: 'PF Regal';
    src: url('../res/fonts/PFRegalTextPro-RegularBItalic.eot');
    src: local('../res/fonts/PFRegalTextPro-RegularBItalic'),
        url('../res/fonts/PFRegalTextPro-RegularBItalic.woff2') format('woff2'),
        url('../res/fonts/PFRegalTextPro-RegularBItalic.woff') format('woff'),
        url('../res/fonts/PFRegalTextPro-RegularBItalic.ttf') format('truetype');
    font-weight: 300;
    font-style: italic;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../res/fonts/PFRegalTextPro-RegularB.eot');
    src: local('../res/fonts/PFRegalTextPro-RegularB'),
        url('../res/fonts/PFRegalTextPro-RegularB.woff2') format('woff2'),
        url('../res/fonts/PFRegalTextPro-RegularB.woff') format('woff'),
        url('../res/fonts/PFRegalTextPro-RegularB.ttf') format('truetype');
    font-weight: 300;
    font-style: normal;
}

@font-face {
    font-family: 'JB Mono';
    src: url('../res/fonts/JetBrainsMono-Regular.eot');
    src: local('../res/fonts/JetBrainsMono-Regular'),
        url('../res/fonts/JetBrainsMono-Regular.woff2') format('woff2'),
        url('../res/fonts/JetBrainsMono-Regular.woff') format('woff'),
        url('../res/fonts/JetBrainsMono-Regular.ttf') format('truetype');
    font-weight: 300;
    font-style: normal;
}
@font-face {
    font-family: 'JB Mono';
    src: url('../res/fonts/JetBrainsMono-Italic.eot');
    src: local('../res/fonts/JetBrainsMono-Italic'),
        url('../res/fonts/JetBrainsMono-Italic.woff2') format('woff2'),
        url('../res/fonts/JetBrainsMono-Italic.woff') format('woff'),
        url('../res/fonts/JetBrainsMono-Italic.ttf') format('truetype');
    font-weight: 300;
    font-style: italic;
}

@font-face {
    font-family: 'JB Mono';
    src: url('../res/fonts/JetBrainsMono-Medium.eot');
    src: local('../res/fonts/JetBrainsMono-Medium'),
        url('../res/fonts/JetBrainsMono-Medium.woff2') format('woff2'),
        url('../res/fonts/JetBrainsMono-Medium.woff') format('woff'),
        url('../res/fonts/JetBrainsMono-Medium.ttf') format('truetype');
    font-weight: 500;
    font-style: normal;
}
@font-face {
    font-family: 'JB Mono';
    src: url('../res/fonts/JetBrainsMono-Medium-Italic.eot');
    src: local('../res/fonts/JetBrainsMono-Medium-Italic'),
        url('../res/fonts/JetBrainsMono-Medium-Italic.woff2') format('woff2'),
        url('../res/fonts/JetBrainsMono-Medium-Italic.woff') format('woff'),
        url('../res/fonts/JetBrainsMono-Medium-Italic.ttf') format('truetype');
    font-weight: 500;
    font-style: italic;
}
@font-face {
    font-family: 'Font Awesome 5 Free';
    font-style: normal;
    font-weight: 400;
    font-display: swap;
    src: url("../res/fonts/webfonts/fa-regular-400.eot");
    src: url("../res/fonts/webfonts/fa-regular-400.eot?#iefix") format("embedded-opentype"), 
         url("../res/fonts/webfonts/fa-regular-400.woff2") format("woff2"), 
         url("../res/fonts/webfonts/fa-regular-400.woff") format("woff"), 
         url("../res/fonts/webfonts/fa-regular-400.ttf") format("truetype"), 
         url("../res/fonts/webfonts/fa-regular-400.svg#fontawesome") format("svg"); 
    font-display: swap;
}
    
.fa {
    font-family: 'Font Awesome 5 Free';
    font-weight: 400;
    font-display: swap;
}
@font-face {
  font-family: 'Font Awesome 5 Brands';
  font-style: normal;
  font-weight: 400;
  font-display: auto;
  src: url("../res/fonts/fa-brands-400.eot");
  src: url("../res/fonts/fa-brands-400.eot?#iefix") format("embedded-opentype"), url("../res/fonts/fa-brands-400.woff2") format("woff2"), url("../res/fonts/fa-brands-400.woff") format("woff"), url("../res/fonts/fa-brands-400.ttf") format("truetype"), url("../res/fonts/fa-brands-400.svg#fontawesome") format("svg"); 
}

.fab {
  font-family: 'Font Awesome 5 Brands';
  font-weight: 400; 
}

@font-face {
  font-family: 'Font Awesome 5 Free';
  font-style: normal;
  font-weight: 400;
  font-display: auto;
  src: url("../res/fonts/fa-regular-400.eot");
  src: url("../res/fonts/fa-regular-400.eot?#iefix") format("embedded-opentype"), url("../res/fonts/fa-regular-400.woff2") format("woff2"), url("../res/fonts/fa-regular-400.woff") format("woff"), url("../res/fonts/fa-regular-400.ttf") format("truetype"), url("../res/fonts/fa-regular-400.svg#fontawesome") format("svg"); 
}

.far {
  font-family: 'Font Awesome 5 Free';
  font-weight: 400; 
}

@font-face {
  font-family: 'Font Awesome 5 Free';
  font-style: normal;
  font-weight: 900;
  font-display: auto;
  src: url("../res/fonts/fa-solid-900.eot");
  src: url("../res/fonts/fa-solid-900.eot?#iefix") format("embedded-opentype"), url("../res/fonts/fa-solid-900.woff2") format("woff2"), url("../res/fonts/fa-solid-900.woff") format("woff"), url("../res/fonts/fa-solid-900.ttf") format("truetype"), url("../res/fonts/fa-solid-900.svg#fontawesome") format("svg"); 
}
</style>  
    <div class="book-title-container d-none d-lg-block">
        <div class="book-title">Knowledge Base</div>
        <div class="book-part-title-block">pt.1 <a href="..//ru/Memory/01-00-MemoryManagement-Intro.html" class="book-part-title">Управление памятью</a></div>
        <div class="book-part-title-block">pt.2 <a href="..//ru/Execution/02-00-ExecutionFlow-Intro.html" class="book-part-title">Поток исполнения команд</a></div>
        <br><a href="#" class="book-superheading-title">Обоснование выбора</a>
        / <a href="#" class="book-superheading-title">Упрощенное описание</a>
        / <a href="#" class="book-superheading-title">Подробное описание</a>
    </div>
    <header class="header fixed d-block d-lg-none">
        <p class="conflogo">KB</p> 

        <!-- mobile-menu -->

        <div class="hamburger-menu">
            <input id="menu__toggle" type="checkbox" />
            <label class="menu__btn" for="menu__toggle">
              <span></span>
            </label>
        
            <div class="menu__box">
                <p class="menu__header_current">На странице</p>
                <ol class="menu__list">
                    <li><a href="#spant-readonlyspant" onclick="$('#menu__toggle').click(); return true;">
Span</a></li>
<li><a href="#memoryt-and-readonlymemoryt" onclick="$('#menu__toggle').click(); return true;">
Memory</a></li>
<li><a href="#memorymanager-imemoryowner-memorypool" onclick="$('#menu__toggle').click(); return true;">
MemoryManager, IMemoryOwner, MemoryPool</a></li>
<li><a href="#performance" onclick="$('#menu__toggle').click(); return true;">
Performance</a></li>

                </ol>
                <p class="menu__header_total">Содержание</p>
                <ul class="menu__header_list">
                    <li>
                        <p class="menu__header_total_sub">
                            Управление памятью
                        </p>
                        <p class="menu__header_total_sub2">
                            Теоретические вопросы:
                        </p>
                        <ol class="menu__list">
                            <li><p><a href="../ru/Memory/01-00-MemoryManagement-Intro.html">
                                Общие слова
                            </a></p></li>
                            <li>
                                <p>
                                <a href="../ru/Memory/01-02-MemoryManagement-Basics.html">Введение в управление памятью</a></p>
                            </li>
                            <li>
                                <p>
                                <a href="../ru/Memory/01-04-MemoryManagement-ThreadStack.html">Стек потока</a></p>
                            </li>
                            <li>
                                <p>
                                <a href="../ru/Memory/01-06-MemoryManagement-EntitiesLifetime.html">Время жизни сущности</a></p>
                            </li>
                            <li>
                                <p>
                                <a href="../ru/Memory/01-08-MemoryManagement-RefVsValueTypes.html">RefTypes, ValueTypes, Boxing &amp; Unboxing</a></p>
                            </li>
                            <li>
                                <p>
                                <a href="../ru/Memory/01-10-MemoryManagement-IDisposable.html">Шаблон IDisposable</a></p>
                            </li>
                            <li>
                                <p>
                                <a href="../ru/Memory/01-12-MemoryManagement-Finalizer.html">Финализация</a></p>
                            </li>
                            <li>
                                <p>
                                <a href="../ru/Memory/01-14-MemoryManagement-Results.html">Выводы</a></p>
                            </li>
                        </ol>
                        <p class="menu__header_total_sub2">
                            Практические вопросы:
                        </p>
                        <ol class="menu__list" start="9">
                            <li><p><a href="../ru/Memory/02-02-MemoryManagement-MemorySpan.html">
                                Memory&lt;T&gt;, Span&lt;T&gt;
                            </a></p></li>
                        </ol> 
                    </li>
                    <li>
                        <p class="menu__header_total_sub">
                            Поток исполнения команд
                        </p>
                        <p class="menu__header_total_sub2">
                            Многопоточность:
                        </p>
                        <ol class="menu__list">
                            <li><p><a href="../ru/Execution/1-Threads/1-OS/1-threadsScheduling.html">
                                Потоки и планирование потоков
                            </a></p></li>
                        </ol>
                        <p class="menu__header_total_sub2">
                            Искл­юч­ител­ьные си­ту­а­ции:
                        </p>
                        <ol class="menu__list" start="2">
                            <li><p><a href="../ru/Execution/2-ExceptionalFlow/1-Exceptions-Intro.html">
                                Введение в исключительные ситуации
                            </a></p></li>
                            <li><p><a href="../ru/Execution/2-ExceptionalFlow/2-Exceptions-Architecture.html">
                                Архитектура исключительной ситуации
                            </a></p></li>
                            <li><p><a href="../ru/Execution/2-ExceptionalFlow/3-Exceptions-Events.html">
                                События об исключительных ситуациях
                            </a></p></li>
                            <li><p><a href="../ru/Execution/2-ExceptionalFlow/4-Exceptions-Types.html">
                                Виды исключительных ситуаций
                            </a></p></li>
                        </ol>
                    </li>
                </ul>
            </div>
        </div>
    </header>

    <div class="book-container">
        <div class="article-container">
            <!--<p class="d-xs-block d-sm-none">XS</p>
            <p class="d-none d-xs-block d-sm-none">SM</p>
            <p class="d-none d-sm-block d-md-none">MD</p>
            <p class="d-none d-lg-block d-xl-none">LG</p>
            <p class="d-none d-xl-block">XL</p> -->
            <h1 id="memoryt-and-spant">Memory<T> and Span<T></h1>
<blockquote>
<p><a href="https://github.com/sidristij/dotnetbook/issues/55">A link to the discus&shy;sion</a></p>
</blockquote>
<div class="paragraph-container">
<div class="paragraph-left-side">01</div>
<p>Star&shy;ting from .NET Core 2.0 and .NET Frame&shy;work 4.5 we can use new data types:  <code>Span</code> and <code>Memory</code>. To use them, you just need to ins&shy;tall the <code>System&shy;.Memory</code> nuget package:</p>
<div class="paragraph-right-side">01</div>
</div>
<ul>
<li><code>PM> Install&shy;-Package System&shy;.Memory</code></li>
</ul>
<div class="paragraph-container">
<div class="paragraph-left-side">02</div>
<p>These data types are notable because the CLR team has done a great job to imple&shy;ment their special support inside the code of .NET Core 2.1+ JIT compiler by embed&shy;ding these data types right into the core. What kind of data types are these and why are they worth a whole chapter?</p>
<div class="paragraph-right-side">02</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">03</div>
<p>If we talk about prob&shy;lems that made these types appear, I should name three of them. The first one is unma&shy;naged code.</p>
<div class="paragraph-right-side">03</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">04</div>
<p>Both the language and the plat&shy;form have existed for many years along with means to work with unma&shy;naged code. So&shy;, why release another API to work with unma&shy;naged code if the former basi&shy;cally existed for many years? To answer this ques&shy;tion, we should unders&shy;tand what we lacked before.</p>
<div class="paragraph-right-side">04</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">05</div>
<p>The plat&shy;form deve&shy;lo&shy;pers already tried to faci&shy;li&shy;tate the use of unma&shy;naged reso&shy;urces for us. They imple&shy;mented auto wrap&shy;pers for imported methods and marshaling that works aut&shy;om&shy;at&shy;ically in most cases. Here also belongs <code>stac&shy;kalloc</code>, menti&shy;oned in the chapter about a thread stack. However&shy;, as I see it, the first C# deve&shy;lo&shy;pers came from C++ world (my case), but now they shift from more high-level langu&shy;ages (I know a deve&shy;loper who wrote in Java&shy;Script before). This means people are getting more suspi&shy;cious to unma&shy;naged code and C/C+ constructs, so much the more to Assembler&shy;.</p>
<div class="paragraph-right-side">05</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">06</div>
<p>As a result, projects contain less and less unsafe code and the confi&shy;dence in the plat&shy;form API grows more and more. This is easy to check if we search for <code>stac&shy;kalloc</code> use cases in public repo&shy;si&shy;to&shy;ries  — they are scarce. However&shy;, let’s take any code that uses it:</p>
<div class="paragraph-right-side">06</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">07</div>
<p><strong>Interop&shy;.Read&shy;Dir class</strong>
<a href="https://github.com/dotnet/coreclr/blob/b29f6328510207970763580d6f4db864e4b198af/src/mscorlib/shared/Interop/Unix/System.Native/Interop.ReadDir.cs#L71-L83">/src/mscorlib/shared/Interop&shy;/Unix&shy;/System&shy;.Native&shy;/Interop&shy;.Read&shy;Dir&shy;.cs</a></p>
<div class="paragraph-right-side">07</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">unsafe</span>
{
    <span style="color:Green;">// s_readBufferSize is zero when the native implementation does not support reading into a buffer.</span>
    <span style="color:Blue;">byte</span>* buffer = <span style="color:Blue;">stackalloc</span> <span style="color:Blue;">byte</span>[s_readBufferSize];
    InternalDirectoryEntry temp;
    <span style="color:Blue;">int</span> ret = ReadDirR(dir.DangerousGetHandle(), buffer, s_readBufferSize, <span style="color:Blue;">out</span> temp);
    <span style="color:Green;">// We copy data into DirectoryEntry to ensure there are no dangling references.</span>
    outputEntry = ret == 0 ?
                <span style="color:Blue;">new</span> DirectoryEntry() { InodeName = GetDirectoryEntryName(temp), InodeType = temp.InodeType } :
                <span style="color:Blue;">default</span>(DirectoryEntry);

    <span style="color:Blue;">return</span> ret;
}
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">08</div>
<p>We can see why it is not popular. Just skim this code and ques&shy;tion your&shy;self  whether you trust it. I guess the answer is ‘No’. Then&shy;, ask your&shy;self why. It is obvious: not only do we see the word <code>Dange&shy;rous</code>, which kind of suggests that something may go wrong, but there is the <code>unsafe</code> keyword and <code>byte* buffer = stac&shy;kalloc byte[s_read&shy;Buf&shy;fer&shy;Size];</code> line (speci&shy;fi&shy;cally — <code>byte*</code>) that change our atti&shy;tude. This is a trigger for you to think: “Wasn’t there another way to do it”? So&shy;, let’s get deeper into psych&shy;oanalysis: why might you think that way? On the one hand, we use language constructs and the syntax offered here is far from, for example, C++/CLI, which allows anything (even inser&shy;ting pure Assem&shy;bler code). On the other hand, this syntax looks unu&shy;sual.</p>
<div class="paragraph-right-side">08</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">09</div>
<p>The second issue deve&shy;lo&shy;pers thought of impli&shy;citly or expli&shy;citly is incom&shy;pa&shy;ti&shy;bi&shy;lity of  string and char[] types. Although&shy;, logi&shy;cally a string is an array of char&shy;acters, but you can’t cast a string to char[]: you can only create a new object and copy the content of a string to an array. This incom&shy;pa&shy;ti&shy;bi&shy;lity is intro&shy;duced to opti&shy;mize strings in terms of storage (there are no rea&shy;donly arrays). However&shy;, prob&shy;lems appear when you start working with files. How to read them? As a string or as an array? If you choose an array you cannot use some methods designed to work with strings. What about rea&shy;ding as a string? It may be too long. If you need to parse it then, what parser should you choose for primi&shy;tive data types: you don’t always want to parse them manu&shy;ally (inte&shy;gers, floats, given in diffe&shy;rent formats). We have a lot of proven algo&shy;rithms that do it quicker and more effi&shy;ci&shy;ently, don’t we? However&shy;, such algo&shy;rithms often work with strings that contain nothing but a primi&shy;tive type itself. So&shy;, there is a dilemma.</p>
<div class="paragraph-right-side">09</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">10</div>
<p>The third problem is that the data requ&shy;ired by an algo&shy;rithm rarely make a conti&shy;nuous, solid data slice within a section of an array read from some source.  For example, in case of files or data read from a socket, we have some part of  those already processed by an algo&shy;rithm, followed by a part of data that must be processed by our method, and then by not yet processed data.  Ideally&shy;, our method wants only the data for which this method was designed. For example, a method that parses inte&shy;gers won’t be happy with a string that contains some words with an expected number somew&shy;here among them. This method wants a number and nothing else. Or&shy;, if we pass an entire array, there is a requ&shy;i&shy;re&shy;ment to indi&shy;cate, for example, the offset for a number from the begin&shy;ning of the array.</p>
<div class="paragraph-right-side">10</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">int</span> ParseInt(<span style="color:Blue;">char</span>[] input, <span style="color:Blue;">int</span> index)
{
    <span style="color:Blue;">while</span>(<span style="color:Blue;">char</span>.IsDigit(input[index]))
    {
        <span style="color:Green;">// ...</span>
        index++;
    }
}
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">11</div>
<p>However&shy;, this approach is poor, as this method gets unne&shy;ces&shy;sary data. In other words <em>the method is called for contexts it was not designed for</em>, and has to solve some external tasks. This is a bad design. How to avoid these prob&shy;lems? As an option we can use the <code>Array&shy;Segment&shy;<T></code> type that can give access to a section of an array:</p>
<div class="paragraph-right-side">11</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">int</span> ParseInt(IList&lt;<span style="color:Blue;">char</span>&gt;[] input)
{
    <span style="color:Blue;">while</span>(<span style="color:Blue;">char</span>.IsDigit(input.Array[index]))
    {
        <span style="color:Green;">// ...</span>
        index++;
    }
}

<span style="color:Blue;">var</span> arraySegment = <span style="color:Blue;">new</span> ArraySegment(array, <span style="color:Blue;">from</span>, length);
<span style="color:Blue;">var</span> res = ParseInt((IList&lt;<span style="color:Blue;">char</span>&gt;)arraySegment);
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">12</div>
<p>However&shy;, I think this is too much both in terms of logic and a decrease in perfor&shy;mance. <code>Array&shy;Segment</code> is poorly designed and slows the access to ele&shy;ments 7 times more in compa&shy;rison with the same ope&shy;ra&shy;tions done with an array.</p>
<div class="paragraph-right-side">12</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">13</div>
<p>So how do we solve these prob&shy;lems? How do we get deve&shy;lo&shy;pers back to using unma&shy;naged code and give them a uni&shy;fied and quick tool to work with het&shy;er&shy;og&shy;eneous data sources:  arrays, strings and unma&shy;naged memory. It was neces&shy;sary to give them a sense of confi&shy;dence that they can’t do a mistake unkno&shy;wingly. It was neces&shy;sary to give them an inst&shy;rument that doesn’t dimi&shy;nish native data types in terms of perfor&shy;mance but solves the listed prob&shy;lems. <code>Span&shy;<T></code> and <code>Memory&shy;<T></code> types are exactly these inst&shy;ruments.</p>
<div class="paragraph-right-side">13</div>
</div>
<h2 id="spant-readonlyspant">Span<T>, Read&shy;Only&shy;Span<T></h2>
<div class="paragraph-container">
<div class="paragraph-left-side">14</div>
<p><code>Span</code> type is an inst&shy;rument to work with data within a section of a data array or with a subrange of its values. As in case of an array it allows both rea&shy;ding and writing to the ele&shy;ments of this subrange, but with one impor&shy;tant constraint: you get or create a <code>Span&shy;<T></code> only for a <em>tempo&shy;rary</em> work with an array, Just to  call a group of methods. However&shy;, to get a general unders&shy;tan&shy;ding let’s compare the types of data which <code>Span</code> is designed for and look at its possible use scena&shy;rios.</p>
<div class="paragraph-right-side">14</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">15</div>
<p>The first type of data is a usual array. Arrays work with <code>Span</code> in the follo&shy;wing way:</p>
<div class="paragraph-right-side">15</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
    <span style="color:Blue;">var</span> array = <span style="color:Blue;">new</span> [] {1,2,3,4,5,6};
    <span style="color:Blue;">var</span> span = <span style="color:Blue;">new</span> Span&lt;<span style="color:Blue;">int</span>&gt;(array, 1, 3);
    <span style="color:Blue;">var</span> position = span.BinarySearch(3);
    Console.WriteLine(span[position]);  <span style="color:Green;">// -&gt; 3</span>
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">16</div>
<p>At first, we create an array of data, as shown by this example. Next&shy;, we create <code>Span</code> (or a subset) which refe&shy;rences to the array, and makes a previously ini&shy;ti&shy;a&shy;lized value range acces&shy;sible to code that uses the array.</p>
<div class="paragraph-right-side">16</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">17</div>
<p>Here we see the first fea&shy;ture of this type of data  i.e. the abi&shy;lity to create a certain context. Let’s expand our idea of contexts:</p>
<div class="paragraph-right-side">17</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">void</span> Main()
{
    <span style="color:Blue;">var</span> array = <span style="color:Blue;">new</span> [] {<span style="color:#A31515;">&#39;1&#39;</span>,<span style="color:#A31515;">&#39;2&#39;</span>,<span style="color:#A31515;">&#39;3&#39;</span>,<span style="color:#A31515;">&#39;4&#39;</span>,<span style="color:#A31515;">&#39;5&#39;</span>,<span style="color:#A31515;">&#39;6&#39;</span>};
    <span style="color:Blue;">var</span> span = <span style="color:Blue;">new</span> Span&lt;<span style="color:Blue;">char</span>&gt;(array, 1, 3);
    <span style="color:Blue;">if</span>(TryParseInt32(span, <span style="color:Blue;">out</span> <span style="color:Blue;">var</span> res))
    {
        Console.WriteLine(res);
    }
    <span style="color:Blue;">else</span>
    {
        Console.WriteLine(<span style="color:#A31515;">&quot;Failed to parse&quot;</span>);
    }
}

<span style="color:Blue;">public</span> <span style="color:Blue;">bool</span> TryParseInt32(Span&lt;<span style="color:Blue;">char</span>&gt; input, <span style="color:Blue;">out</span> <span style="color:Blue;">int</span> result)
{
    result = 0;
    <span style="color:Blue;">for</span> (<span style="color:Blue;">int</span> i = 0; i &lt; input.Length; i++)
    {
        <span style="color:Blue;">if</span>(input[i] &lt; <span style="color:#A31515;">&#39;0&#39;</span> || input[i] &gt; <span style="color:#A31515;">&#39;9&#39;</span>)
            <span style="color:Blue;">return</span> <span style="color:Blue;">false</span>;
    result = result * 10 + ((<span style="color:Blue;">int</span>)input[i] - <span style="color:#A31515;">&#39;0&#39;</span>);
    }
    <span style="color:Blue;">return</span> <span style="color:Blue;">true</span>;
}

-----
234
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">18</div>
<p>As we see <code>Span&shy;<T></code> provides abstract access to a memory range both for rea&shy;ding and writing. What does it give us? If we remember what else we can use <code>Span</code> for, we will think about unma&shy;naged reso&shy;urces and strings:</p>
<div class="paragraph-right-side">18</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Green;">// Managed array</span>
<span style="color:Blue;">var</span> array = <span style="color:Blue;">new</span>[] { <span style="color:#A31515;">&#39;1&#39;</span>, <span style="color:#A31515;">&#39;2&#39;</span>, <span style="color:#A31515;">&#39;3&#39;</span>, <span style="color:#A31515;">&#39;4&#39;</span>, <span style="color:#A31515;">&#39;5&#39;</span>, <span style="color:#A31515;">&#39;6&#39;</span> };
<span style="color:Blue;">var</span> arrSpan = <span style="color:Blue;">new</span> Span&lt;<span style="color:Blue;">char</span>&gt;(array, 1, 3);
<span style="color:Blue;">if</span> (TryParseInt32(arrSpan, <span style="color:Blue;">out</span> <span style="color:Blue;">var</span> res1))
{
    Console.WriteLine(res1);
}

<span style="color:Green;">// String</span>
<span style="color:Blue;">var</span> srcString = <span style="color:#A31515;">&quot;123456&quot;</span>;
<span style="color:Blue;">var</span> strSpan = srcString.AsSpan();
<span style="color:Blue;">if</span> (TryParseInt32(strSpan, <span style="color:Blue;">out</span> <span style="color:Blue;">var</span> res2))
{
    Console.WriteLine(res2);
}

<span style="color:Green;">// void *</span>
Span&lt;<span style="color:Blue;">char</span>&gt; buf = <span style="color:Blue;">stackalloc</span> <span style="color:Blue;">char</span>[6];
buf[0] = <span style="color:#A31515;">&#39;1&#39;</span>; buf[1] = <span style="color:#A31515;">&#39;2&#39;</span>; buf[2] = <span style="color:#A31515;">&#39;3&#39;</span>;
buf[3] = <span style="color:#A31515;">&#39;4&#39;</span>; buf[4] = <span style="color:#A31515;">&#39;5&#39;</span>; buf[5] = <span style="color:#A31515;">&#39;6&#39;</span>;

<span style="color:Blue;">if</span> (TryParseInt32(buf, <span style="color:Blue;">out</span> <span style="color:Blue;">var</span> res3))
{
    Console.WriteLine(res3);
}

-----
234
234
234
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">19</div>
<p>That means <code>Span&shy;<T></code> is a tool to unify ways of working with memory,  both managed and unma&shy;naged. It ensures safety while working with such data during Garbage Collection&shy;.  That is if memory ranges with unma&shy;naged reso&shy;urces start to move, it will be safe.</p>
<div class="paragraph-right-side">19</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">20</div>
<p>However&shy;, should we be so excited? Could we achieve this earlier? For example, in case of managed arrays there is no doubt about it:  you just need to wrap an array in one more class (e.g. long-exis&shy;ting [Array&shy;Segment&shy;] (<a href="https://referencesource.microsoft.com/#mscorlib/system/arraysegment.cs,31">https://refe&shy;ren&shy;ce&shy;so&shy;urce.micro&shy;soft.com/#mscorlib/system/array&shy;seg&shy;ment.cs,31</a>)) thus giving a similar inter&shy;face and that is it. Moreover&shy;, you can do the same with strings  — they have neces&shy;sary methods.  Again&shy;, you just need to wrap a string in the same type and provide methods to work with it. However&shy;, to store a string, a buffer and an array in one type you will have much to do with kee&shy;ping refe&shy;rences to each possible variant in a single instance (with only one active variant, obviously).</p>
<div class="paragraph-right-side">20</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">public</span> <span style="color:Blue;">readonly</span> <span style="color:Blue;">ref</span> <span style="color:Blue;">struct</span> OurSpan&lt;T&gt;
{
    <span style="color:Blue;">private</span> T[] _array;
    <span style="color:Blue;">private</span> <span style="color:Blue;">string</span> _str;
    <span style="color:Blue;">private</span> T * _buffer;

    <span style="color:Green;">// ...</span>
}
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">21</div>
<p>Or&shy;, based on arch&shy;it&shy;ecture you can create three types that imple&shy;ment a uni&shy;form inter&shy;face. Thus&shy;, it is not possible to create a uni&shy;form inter&shy;face between these data types that is diffe&shy;rent from <code>Span&shy;<T></code> and keep the maximum perfor&shy;mance.</p>
<div class="paragraph-right-side">21</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">22</div>
<p>Next&shy;, there is a ques&shy;tion of what is <code>ref struct</code> in respect to <code>Span</code>? These are exactly those “struc&shy;tures exis&shy;ting only on stack” that we hear about during job inter&shy;views so often. It means this data type can be allo&shy;cated on the stack only and cannot go to the heap. This is why <code>Span</code>, which is a ref struc&shy;ture, is a context data type that enables work of methods but not that of objects in memory. That is what we need to base on when trying to unders&shy;tand it.</p>
<div class="paragraph-right-side">22</div>
</div>
<p>Now we can define the <code>Span</code> type and the related <code>Read&shy;Only&shy;Span</code> type:</p>
<blockquote>
<p>Span is a data type that imple&shy;ments a uni&shy;form inter&shy;face to work with het&shy;er&shy;og&shy;eneous types of data arrays and enables passing a subset of an array to a method so that the speed of access to the ori&shy;ginal array would be cons&shy;tant and highest regard&shy;less of the depth of the context.</p>
</blockquote>
<p>Indeed&shy;,  if we have a code like</p>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">public</span> <span style="color:Blue;">void</span> Method1(Span&lt;<span style="color:Blue;">byte</span>&gt; buffer)
{
    buffer[0] = 0;
    Method2(buffer.Slice(1,2));
}
Method2(Span&lt;<span style="color:Blue;">byte</span>&gt; buffer)
{
    buffer[0] = 0;
    Method3(buffer.Slice(1,1));
}
Method3(Span&lt;<span style="color:Blue;">byte</span>&gt; buffer)
{
    buffer[0] = 0;
}
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">23</div>
<p>the speed of access to the ori&shy;ginal buffer will be the highest as you work with a managed pointer and not a managed object. That means you work with an unsafe type in a managed wrapper, but not with a .NET managed type.</p>
<div class="paragraph-right-side">23</div>
</div>
<h3 id="spant-usage-examples">Span<T> usage examples</h3>
<div class="paragraph-container">
<div class="paragraph-left-side">24</div>
<p>A human by nature cannot fully unders&shy;tand the purpose of a certain inst&shy;rument until he or she gets some expe&shy;ri&shy;ence. So&shy;, let’s turn to some examples.</p>
<div class="paragraph-right-side">24</div>
</div>
<h4 id="valuestringbuilder">Value&shy;String&shy;Builder</h4>
<div class="paragraph-container">
<div class="paragraph-left-side">25</div>
<p>One of the most inte&shy;res&shy;ting examples in respect to algo&shy;rithms is the <code>Value&shy;String&shy;Builder</code> type. However&shy;, it is buried deep inside mscorlib and marked with the <code>internal</code> modi&shy;fier as many other very inte&shy;res&shy;ting data types. This means we would not find this remar&shy;kable inst&shy;rument for opti&shy;mi&shy;za&shy;tion if we haven’t rese&shy;arched the mscorlib source code.</p>
<div class="paragraph-right-side">25</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">26</div>
<p>What is the main disad&shy;van&shy;tage of the <code>String&shy;Builder</code> system type? Its main draw&shy;back is  the type and its basis — it is a refe&shy;rence type and is based on <code>char[]</code>, i.e. a char&shy;acter array. At least, this means two things: we use the heap (though not much) anyway and increase the chances to miss the CPU cash.</p>
<div class="paragraph-right-side">26</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">27</div>
<p>Another issue with <code>String&shy;Builder</code> that I faced is the const&shy;ru&shy;ction of small strings,  that is when the resul&shy;ting string must be short  e.g. less than 100 char&shy;acters. Short format&shy;ting raises issues on perfor&shy;mance.</p>
<div class="paragraph-right-side">27</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
    $<span style="color:#A31515;">&quot;{x} is in range [{min};{max}]&quot;</span>
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">28</div>
<p>To what extent is this variant worse than manual const&shy;ru&shy;ction through <code>String&shy;Builder</code>? The answer is not always obvious.  It depends on the place of const&shy;ru&shy;ction  and the frequ&shy;ency of calling this method. Initially&shy;, <code>string.Format</code> allo&shy;cates memory for internal <code>String&shy;Builder</code> that will create an array of char&shy;acters (Source&shy;String&shy;.Length + args.Length * 8). If during array const&shy;ru&shy;ction it turns out that the length was incor&shy;rectly deter&shy;mined, another <code>String&shy;Builder</code> will be created to construct the rest. This will lead to the crea&shy;tion of a single linked list. As a result, it must return the const&shy;ructed string  which means another copying. That is a waste. It would be great if we could get rid of allo&shy;ca&shy;ting the array of a formed string on the heap: this would solve one of our prob&shy;lems.</p>
<div class="paragraph-right-side">28</div>
</div>
<p>Let’s look at this type from the depth of <code>mscorlib</code>:</p>
<div class="paragraph-container">
<div class="paragraph-left-side">29</div>
<p><strong>Value&shy;String&shy;Builder class</strong>
<a href="https://github.com/dotnet/coreclr/blob/efebb38f3c18425c57f94ff910a50e038d13c848/src/mscorlib/shared/System/Text/ValueStringBuilder.cs">/src/mscorlib/shared/System&shy;/Text&shy;/Value&shy;String&shy;Builder</a></p>
<div class="paragraph-right-side">29</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
    <span style="color:Blue;">internal</span> <span style="color:Blue;">ref</span> <span style="color:Blue;">struct</span> ValueStringBuilder
    {
        <span style="color:Green;">// this field will be active if we have too many characters</span>
        <span style="color:Blue;">private</span> <span style="color:Blue;">char</span>[] _arrayToReturnToPool;
        <span style="color:Green;">// this field will be the main</span>
        <span style="color:Blue;">private</span> Span&lt;<span style="color:Blue;">char</span>&gt; _chars;
        <span style="color:Blue;">private</span> <span style="color:Blue;">int</span> _pos;
        <span style="color:Green;">// the type accepts the buffer from the outside, delegating the choice of its size to a calling party</span>
        <span style="color:Blue;">public</span> ValueStringBuilder(Span&lt;<span style="color:Blue;">char</span>&gt; initialBuffer)
        {
            _arrayToReturnToPool = <span style="color:Blue;">null</span>;
            _chars = initialBuffer;
            _pos = 0;
        }

        <span style="color:Blue;">public</span> <span style="color:Blue;">int</span> Length
        {
            <span style="color:Blue;">get</span> =&gt; _pos;
            <span style="color:Blue;">set</span>
            {
                <span style="color:Blue;">int</span> delta = value - _pos;
                <span style="color:Blue;">if</span> (delta &gt; 0)
                {
                    Append(<span style="color:#A31515;">&#39;\0&#39;</span>, delta);
                }
                <span style="color:Blue;">else</span>
                {
                    _pos = value;
                }
            }
        }

        <span style="color:Green;">// Here we get the string by copying characters from the array into another array</span>
        <span style="color:Blue;">public</span> <span style="color:Blue;">override</span> <span style="color:Blue;">string</span> ToString()
        {
            <span style="color:Blue;">var</span> s = <span style="color:Blue;">new</span> <span style="color:Blue;">string</span>(_chars.Slice(0, _pos));
            Clear();
            <span style="color:Blue;">return</span> s;
        }

        <span style="color:Green;">// To insert a required character into the middle of the string</span>
        <span style="color:Green;">//you should add space into the characters of that string and then copy that character</span>
        <span style="color:Blue;">public</span> <span style="color:Blue;">void</span> Insert(<span style="color:Blue;">int</span> index, <span style="color:Blue;">char</span> value, <span style="color:Blue;">int</span> count)
        {
            <span style="color:Blue;">if</span> (_pos &gt; _chars.Length - count)
            {
                Grow(count);
            }

            <span style="color:Blue;">int</span> remaining = _pos - index;
            _chars.Slice(index, remaining).CopyTo(_chars.Slice(index + count));
            _chars.Slice(index, count).Fill(value);
            _pos += count;
        }

        [MethodImpl(MethodImplOptions.AggressiveInlining)]
        <span style="color:Blue;">public</span> <span style="color:Blue;">void</span> Append(<span style="color:Blue;">char</span> c)
        {
            <span style="color:Blue;">int</span> pos = _pos;
            <span style="color:Blue;">if</span> (pos &lt; _chars.Length)
            {
                _chars[pos] = c;
                _pos = pos + 1;
            }
            <span style="color:Blue;">else</span>
            {
                GrowAndAppend(c);
            }
        }

        [MethodImpl(MethodImplOptions.NoInlining)]
        <span style="color:Blue;">private</span> <span style="color:Blue;">void</span> GrowAndAppend(<span style="color:Blue;">char</span> c)
        {
            Grow(1);
            Append(c);
        }

        <span style="color:Green;">// If the original array passed by the constructor wasn’t enough</span>
        <span style="color:Green;">// we allocate an array of a necessary size from the pool of free arrays</span>
        <span style="color:Green;">// It would be ideal if the algorithm considered</span>
        <span style="color:Green;">// discreteness of array size to avoid pool fragmentation. </span>
        [MethodImpl(MethodImplOptions.NoInlining)]
        <span style="color:Blue;">private</span> <span style="color:Blue;">void</span> Grow(<span style="color:Blue;">int</span> requiredAdditionalCapacity)
        {
            Debug.Assert(requiredAdditionalCapacity &gt; _chars.Length - _pos);

            <span style="color:Blue;">char</span>[] poolArray = ArrayPool&lt;<span style="color:Blue;">char</span>&gt;.Shared.Rent(Math.Max(_pos + requiredAdditionalCapacity, _chars.Length * 2));

            _chars.CopyTo(poolArray);

            <span style="color:Blue;">char</span>[] toReturn = _arrayToReturnToPool;
            _chars = _arrayToReturnToPool = poolArray;
            <span style="color:Blue;">if</span> (toReturn != <span style="color:Blue;">null</span>)
            {
                ArrayPool&lt;<span style="color:Blue;">char</span>&gt;.Shared.Return(toReturn);
            }
        }

        [MethodImpl(MethodImplOptions.AggressiveInlining)]
        <span style="color:Blue;">private</span> <span style="color:Blue;">void</span> Clear()
        {
            <span style="color:Blue;">char</span>[] toReturn = _arrayToReturnToPool;
            <span style="color:Blue;">this</span> = <span style="color:Blue;">default</span>; <span style="color:Green;">// for safety, to avoid using pooled array if this instance is erroneously appended to again</span>
            <span style="color:Blue;">if</span> (toReturn != <span style="color:Blue;">null</span>)
            {
                ArrayPool&lt;<span style="color:Blue;">char</span>&gt;.Shared.Return(toReturn);
            }
        }

        <span style="color:Green;">// Missing methods:  the situation is crystal clear</span>
        <span style="color:Blue;">private</span> <span style="color:Blue;">void</span> AppendSlow(<span style="color:Blue;">string</span> s);
        <span style="color:Blue;">public</span> <span style="color:Blue;">bool</span> TryCopyTo(Span&lt;<span style="color:Blue;">char</span>&gt; destination, <span style="color:Blue;">out</span> <span style="color:Blue;">int</span> charsWritten);
        <span style="color:Blue;">public</span> <span style="color:Blue;">void</span> Append(<span style="color:Blue;">string</span> s);
        <span style="color:Blue;">public</span> <span style="color:Blue;">void</span> Append(<span style="color:Blue;">char</span> c, <span style="color:Blue;">int</span> count);
        <span style="color:Blue;">public</span> <span style="color:Blue;">unsafe</span> <span style="color:Blue;">void</span> Append(<span style="color:Blue;">char</span>* value, <span style="color:Blue;">int</span> length);
        <span style="color:Blue;">public</span> Span&lt;<span style="color:Blue;">char</span>&gt; AppendSpan(<span style="color:Blue;">int</span> length);
    }
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">30</div>
<p>This class is functi&shy;o&shy;nally similar to its senior fellow <code>String&shy;Builder</code>, although having one inte&shy;res&shy;ting and very impor&shy;tant fea&shy;ture:  it is a value type. That means it is stored and passed enti&shy;rely by value. Also&shy;, a new <code>ref</code> type modi&shy;fier, which is a part of a type decla&shy;ra&shy;tion signa&shy;ture, indi&shy;cates that this type has an addi&shy;ti&shy;onal constraint: it can be allo&shy;cated only on the stack. I mean passing its instances to class fields will produce an error. What is all this stuff for? To answer this ques&shy;tion, you just need to look at the <code>String&shy;Builder</code> class, the essence of which we have just desc&shy;ribed:</p>
<div class="paragraph-right-side">30</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">31</div>
<p><strong>String&shy;Builder class</strong> <a href="https://github.com/dotnet/coreclr/blob/68f72dd2587c3365a9fe74d1991f93612c3bc62a/src/mscorlib/src/System/Text/StringBuilder.cs#L47-L62">/src/mscorlib/src/System&shy;/Text&shy;/String&shy;Builder&shy;.cs</a></p>
<div class="paragraph-right-side">31</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">public</span> <span style="color:Blue;">sealed</span> <span style="color:Blue;">class</span> StringBuilder : ISerializable
{
    <span style="color:Green;">// A StringBuilder is internally represented as a linked list of blocks each of which holds</span>
    <span style="color:Green;">// a chunk of the string.  It turns out string as a whole can also be represented as just a chunk,</span>
    <span style="color:Green;">// so that is what we do.</span>
    <span style="color:Blue;">internal</span> <span style="color:Blue;">char</span>[] m_ChunkChars;                <span style="color:Green;">// The characters in this block</span>
    <span style="color:Blue;">internal</span> StringBuilder m_ChunkPrevious;      <span style="color:Green;">// Link to the block logically before this block</span>
    <span style="color:Blue;">internal</span> <span style="color:Blue;">int</span> m_ChunkLength;                  <span style="color:Green;">// The index in m_ChunkChars that represent the end of the block</span>
    <span style="color:Blue;">internal</span> <span style="color:Blue;">int</span> m_ChunkOffset;                  <span style="color:Green;">// The logical offset (sum of all characters in previous blocks)</span>
    <span style="color:Blue;">internal</span> <span style="color:Blue;">int</span> m_MaxCapacity = 0;

    <span style="color:Green;">// ...</span>

    <span style="color:Blue;">internal</span> <span style="color:Blue;">const</span> <span style="color:Blue;">int</span> DefaultCapacity = 16;
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">32</div>
<p><code>String&shy;Builder</code> is a class that contains a refe&shy;rence to an array of char&shy;acters. Thus&shy;, when you create it, there appear two objects in fact:  <code>String&shy;Builder</code> and an array of char&shy;acters which is at least 16 char&shy;acters in size. This is why it is essen&shy;tial to set the expected length of a string: it will be built by gene&shy;ra&shy;ting a single linked list of arrays with 16 char&shy;acters each. Admit&shy;, that is a waste. In terms of <code>Value&shy;String&shy;Builder</code> type, it means no default <code>capa&shy;city</code>, as it borrows external memory. Also&shy;, it is a value type, and it makes a user allo&shy;cate a buffer for char&shy;acters on the stack.  Thus&shy;, the whole instance of a type is put on the stack together with its contents and the issue of opti&shy;mi&shy;za&shy;tion is solved. As there is no need to allo&shy;cate memory on the heap, there are no prob&shy;lems with a decrease in perfor&shy;mance when dea&shy;ling with the heap. So&shy;, you might have a ques&shy;tion:  why don’t we always use <code>Value&shy;String&shy;Builder</code> (or its custom analog as we cannot use the ori&shy;ginal because it is internal)? The answer is:  it depends on a task. Will a resul&shy;ting string have a defi&shy;nite size? Will it have a known maximum length? If you answer “yes” and if the string doesn’t exceed rea&shy;so&shy;nable boun&shy;da&shy;ries, you can use the value version of <code>String&shy;Builder</code>. However&shy;, if you expect lengthy strings, use the usual version.</p>
<div class="paragraph-right-side">32</div>
</div>
<h4 id="valuelistbuilder">Value&shy;List&shy;Builder</h4>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">internal</span> <span style="color:Blue;">ref</span> <span style="color:Blue;">partial</span> <span style="color:Blue;">struct</span> ValueListBuilder&lt;T&gt;
{
    <span style="color:Blue;">private</span> Span&lt;T&gt; _span;
    <span style="color:Blue;">private</span> T[] _arrayFromPool;
    <span style="color:Blue;">private</span> <span style="color:Blue;">int</span> _pos;

    <span style="color:Blue;">public</span> ValueListBuilder(Span&lt;T&gt; initialSpan)
    {
        _span = initialSpan;
        _arrayFromPool = <span style="color:Blue;">null</span>;
        _pos = 0;
    }

    <span style="color:Blue;">public</span> <span style="color:Blue;">int</span> Length { <span style="color:Blue;">get</span>; <span style="color:Blue;">set</span>; }

    <span style="color:Blue;">public</span> <span style="color:Blue;">ref</span> T <span style="color:Blue;">this</span>[<span style="color:Blue;">int</span> index] { <span style="color:Blue;">get</span>; }

    [MethodImpl(MethodImplOptions.AggressiveInlining)]
    <span style="color:Blue;">public</span> <span style="color:Blue;">void</span> Append(T item);

    <span style="color:Blue;">public</span> ReadOnlySpan&lt;T&gt; AsSpan();

    [MethodImpl(MethodImplOptions.AggressiveInlining)]
    <span style="color:Blue;">public</span> <span style="color:Blue;">void</span> Dispose();

    <span style="color:Blue;">private</span> <span style="color:Blue;">void</span> Grow();
}
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">33</div>
<p>The second type of data that I espe&shy;ci&shy;ally want to note is the <code>Value&shy;List&shy;Builder</code> type. It is used when you need to create a collec&shy;tion of ele&shy;ments for a short time and pass it to an algo&shy;rithm for proces&shy;sing.</p>
<div class="paragraph-right-side">33</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">34</div>
<p>Admit&shy;,  this task looks pretty similar to the <code>Value&shy;String&shy;Builder</code> task. And it is solved in a similar way:</p>
<div class="paragraph-right-side">34</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">35</div>
<p>** File [Value&shy;List&shy;Builder&shy;.cs (https://github.com/dotnet/coreclr/blob/dbaf2957387c5290a680c8918779683194137b1d/src/System&shy;.Private&shy;.Core&shy;Lib&shy;/shared&shy;/System&shy;/Collections&shy;/Generic&shy;/Value&shy;List&shy;Builder&shy;.cs&shy;)**</p>
<div class="paragraph-right-side">35</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">36</div>
<p>To put it clearly, these situ&shy;a&shy;tions are often. However&shy;, previously we solved the issue another way. We used to create a <code>List</code>, fill it with data and lose the refe&shy;rence to it. If the method is called frequ&shy;ently, this will lead to a sad situ&shy;a&shy;tion: many <code>List</code> instances (and asso&shy;ci&shy;ated arrays) get suspended on the heap. Now this problem is solved: no addi&shy;ti&shy;onal objects will be created. However&shy;, as in case of <code>Value&shy;String&shy;Builder</code> it is solved only for Micro&shy;soft prog&shy;ram&shy;mers:  this class has the <code>internal</code> modi&shy;fier.</p>
<div class="paragraph-right-side">36</div>
</div>
<h3 id="rules-and-use-practice">Rules and use prac&shy;tice</h3>
<div class="paragraph-container">
<div class="paragraph-left-side">37</div>
<p>To fully unders&shy;tand the new type of data you need to play with it by writing two or three or better more methods that use it. However&shy;, it is possible to learn main rules right now:</p>
<div class="paragraph-right-side">37</div>
</div>
<ul>
<li>If your method processes some input dataset without changing its size, you may try to stick to the <code>Span</code> type. If you are not going to modify buffer, choose the <code>Read&shy;Only&shy;Span</code> type;</li>
<li>If your method han&shy;dles strings calcu&shy;la&shy;ting some statis&shy;tics or parsing these strings, it <em>must</em> accept <code>Read&shy;Only&shy;Span&shy;<char&shy;></code>. Must is a new rule. Because when you accept a string, you make some&shy;body create a substring for you;</li>
<li>If you need to create a short data array (no more than 10 kB) for a method, you can easily arrange that using <code>Span&shy;<TType&shy;> buf = stac&shy;kalloc TType&shy;[size&shy;]</code>. Note that TType should be a value type as <code>stac&shy;kalloc</code> works with value types only.</li>
</ul>
<p>In other cases, you’d better look closer at <code>Memory</code> or use classic data types.</p>
<h3 id="how-does-span-work">How does Span work?</h3>
<div class="paragraph-container">
<div class="paragraph-left-side">38</div>
<p>I would like to say a few addi&shy;ti&shy;onal words on how <code>Span</code> functions and why it is that notable. And there is something to talk about. This type of data has two versions:  one for .NET Core 2.0+ and the other for the rest.</p>
<div class="paragraph-right-side">38</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">39</div>
<p><strong>File [Span&shy;.Fast&shy;.cs&shy;, .NET Core 2.0] (<a href="https://github.com/dotnet/coreclr/blob/38403e661a4202ca4c8a72e4bbd9a263bddeb891/src/System.Private.CoreLib/shared/System/Span.Fast.cs">https://github.com/dotnet/coreclr/blob/38403e661a4202ca4c8a72e4bbd9a263bddeb891/src/System&shy;.Private&shy;.Core&shy;Lib&shy;/shared&shy;/System&shy;/Span&shy;.Fast&shy;.cs</a>)</strong></p>
<div class="paragraph-right-side">39</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">public</span> <span style="color:Blue;">readonly</span> <span style="color:Blue;">ref</span> <span style="color:Blue;">partial</span> <span style="color:Blue;">struct</span> Span&lt;T&gt;
{
    <span style="color:Gray;">///</span><span style="color:Green;"> A reference to a .NET object or a pure pointer</span>
    <span style="color:Blue;">internal</span> <span style="color:Blue;">readonly</span> ByReference&lt;T&gt; _pointer;
    <span style="color:Gray;">///</span><span style="color:Green;"> The length of the buffer based on the pointer</span>
    <span style="color:Blue;">private</span> <span style="color:Blue;">readonly</span> <span style="color:Blue;">int</span> _length;
    <span style="color:Green;">// ...</span>
}
</pre></div>
</div>
<p><strong>File ??? [decom&shy;piled]</strong></p>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">public</span> <span style="color:Blue;">ref</span> <span style="color:Blue;">readonly</span> <span style="color:Blue;">struct</span> Span&lt;T&gt;
{
    <span style="color:Blue;">private</span> <span style="color:Blue;">readonly</span> System.Pinnable&lt;T&gt; _pinnable;
    <span style="color:Blue;">private</span> <span style="color:Blue;">readonly</span> IntPtr _byteOffset;
    <span style="color:Blue;">private</span> <span style="color:Blue;">readonly</span> <span style="color:Blue;">int</span> _length;
    <span style="color:Green;">// ...</span>
}
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">40</div>
<p>The thing is that <em>huge</em> .NET Frame&shy;work and .NET Core 1.* don’t have a garbage collector updated in a special way (unlike .NET Core 2.0+) and they have to use an addi&shy;ti&shy;onal pointer  to the begin&shy;ning of a buffer in use. That means, that inter&shy;nally <code>Span</code> han&shy;dles managed .NET objects as though they are unma&shy;naged. Just look into the second variant of the struc&shy;ture: it has three fields. The first one is a refe&shy;rence to a manged object. The second one is the offset in bytes from the begin&shy;ning of this object, used to define the begin&shy;ning of the data buffer (in strings this buffer contains <code>char</code> char&shy;acters while in arrays it contains the data of an array). Finally&shy;, the third field contains the quan&shy;tity of ele&shy;ments in the buffer laid in a row.</p>
<div class="paragraph-right-side">40</div>
</div>
<p>Let’s see how <code>Span</code> han&shy;dles strings, for example:</p>
<div class="paragraph-container">
<div class="paragraph-left-side">41</div>
<p><strong>File [coreclr::src/System&shy;.Private&shy;.Core&shy;Lib&shy;/shared&shy;/System&shy;/Memory&shy;Extensions&shy;.Fast&shy;.cs] (<a href="https://github.com/dotnet/coreclr/blob/2b50bba8131acca2ab535e144796941ad93487b7/src/System.Private.CoreLib/shared/System/MemoryExtensions.Fast.cs#L409-L416">https://github.com/dotnet/coreclr/blob/2b50bba8131acca2ab535e144796941ad93487b7/src/System&shy;.Private&shy;.Core&shy;Lib&shy;/shared&shy;/System&shy;/Memory&shy;Extensions&shy;.Fast&shy;.cs&shy;#L409-L416</a>)</strong></p>
<div class="paragraph-right-side">41</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">public</span> <span style="color:Blue;">static</span> ReadOnlySpan&lt;<span style="color:Blue;">char</span>&gt; AsSpan(<span style="color:Blue;">this</span> <span style="color:Blue;">string</span> text)
{
    <span style="color:Blue;">if</span> (text == <span style="color:Blue;">null</span>)
        <span style="color:Blue;">return</span> <span style="color:Blue;">default</span>;

    <span style="color:Blue;">return</span> <span style="color:Blue;">new</span> ReadOnlySpan&lt;<span style="color:Blue;">char</span>&gt;(<span style="color:Blue;">ref</span> text.GetRawStringData(), text.Length);
}
</pre></div>
</div>
<p>Where <code>string.Get&shy;Raw&shy;String&shy;Data&shy;()</code> looks the follo&shy;wing way:</p>
<div class="paragraph-container">
<div class="paragraph-left-side">42</div>
<p><strong>A file with the defi&shy;ni&shy;tion of fields <a href="https://github.com/dotnet/coreclr/blob/2b50bba8131acca2ab535e144796941ad93487b7/src/System.Private.CoreLib/src/System/String.CoreCLR.cs#L16-L23">coreclr::src/System&shy;.Private&shy;.Core&shy;Lib&shy;/src&shy;/System&shy;/String&shy;.Core&shy;CLR.cs</a></strong></p>
<div class="paragraph-right-side">42</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">43</div>
<p><strong>A file with the defi&shy;ni&shy;tion of Get&shy;Raw&shy;String&shy;Data <a href="https://github.com/dotnet/coreclr/blob/2b50bba8131acca2ab535e144796941ad93487b7/src/System.Private.CoreLib/shared/System/String.cs#L462">coreclr::src/System&shy;.Private&shy;.Core&shy;Lib&shy;/shared&shy;/System&shy;/String&shy;.cs</a></strong></p>
<div class="paragraph-right-side">43</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">public</span> <span style="color:Blue;">sealed</span> <span style="color:Blue;">partial</span> <span style="color:Blue;">class</span> String :
    IComparable, IEnumerable, IConvertible, IEnumerable&lt;<span style="color:Blue;">char</span>&gt;,
    IComparable&lt;<span style="color:Blue;">string</span>&gt;, IEquatable&lt;<span style="color:Blue;">string</span>&gt;, ICloneable
{

    <span style="color:Green;">//</span>
    <span style="color:Green;">// These fields map directly onto the fields in an EE StringObject.  See object.h for the layout.</span>
    <span style="color:Green;">//</span>
    [NonSerialized] <span style="color:Blue;">private</span> <span style="color:Blue;">int</span> _stringLength;

    <span style="color:Green;">// For empty strings, this will be &#39;\0&#39; since</span>
    <span style="color:Green;">// strings are both null-terminated and length prefixed</span>
    [NonSerialized] <span style="color:Blue;">private</span> <span style="color:Blue;">char</span> _firstChar;


    <span style="color:Blue;">internal</span> <span style="color:Blue;">ref</span> <span style="color:Blue;">char</span> GetRawStringData() =&gt; <span style="color:Blue;">ref</span> _firstChar;
}
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">44</div>
<p>It turns out the method directly accesses the inside of the string, while the <code>ref char</code> speci&shy;fi&shy;ca&shy;tion allows GC to track an unma&shy;naged refe&shy;rence to that inside of the string by moving it together with the string when GC is active.</p>
<div class="paragraph-right-side">44</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">45</div>
<p>The same thing is with arrays:  when <code>Span</code> is created, some internal JIT code calcu&shy;lates the offset for the begin&shy;ning of the data array and ini&shy;ti&shy;a&shy;lizes <code>Span</code> with this offset. The way you can calcu&shy;late the offset for strings and arrays was discussed in the chapter about the struc&shy;ture of objects in memory (.\Objects&shy;Structure&shy;.md&shy;).</p>
<div class="paragraph-right-side">45</div>
</div>
<h3 id="spant-as-a-returned-value">Span<T> as a returned value</h3>
<div class="paragraph-container">
<div class="paragraph-left-side">46</div>
<p>Despite all the harmony, <code>Span</code> has some logical but unex&shy;pected constraints on its return from a method. If we look at the follo&shy;wing code:</p>
<div class="paragraph-right-side">46</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">unsafe</span> <span style="color:Blue;">void</span> Main()
{
    <span style="color:Blue;">var</span> x = GetSpan();
}

<span style="color:Blue;">public</span> Span&lt;<span style="color:Blue;">byte</span>&gt; GetSpan()
{
    Span&lt;<span style="color:Blue;">byte</span>&gt; reff = <span style="color:Blue;">new</span> <span style="color:Blue;">byte</span>[100];
    <span style="color:Blue;">return</span> reff;
}
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">47</div>
<p>we can see it is logical and good. However&shy;, if we replace one instr&shy;uc&shy;tion with another:</p>
<div class="paragraph-right-side">47</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">unsafe</span> <span style="color:Blue;">void</span> Main()
{
    <span style="color:Blue;">var</span> x = GetSpan();
}

<span style="color:Blue;">public</span> Span&lt;<span style="color:Blue;">byte</span>&gt; GetSpan()
{
    Span&lt;<span style="color:Blue;">byte</span>&gt; reff = <span style="color:Blue;">stackalloc</span> <span style="color:Blue;">byte</span>[100];
    <span style="color:Blue;">return</span> reff;
}
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">48</div>
<p>a compiler will pr&shy;ohibit it. Before I say why, I would like you to guess which prob&shy;lems this construct brings.</p>
<div class="paragraph-right-side">48</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">49</div>
<p>Well&shy;, I hope you thought, guessed and maybe even under&shy;stood the reason. If yes, my efforts to writing a deta&shy;iled chapter about a [thread stack] (./Thread&shy;Stack&shy;.md&shy;) paid off. Because when you return a refe&shy;rence to local vari&shy;ables from a method that finishes its work, you can call another method, wait until it finishes its work too, and then read values of those local vari&shy;ables using x[0.99].</p>
<div class="paragraph-right-side">49</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">50</div>
<p>Fortunately&shy;, when we attempt to write such code a compiler slaps on our wrists by warning: <code>CS8352 Cannot use local 'reff' in this context because it may expose refe&shy;renced vari&shy;ables outside of their decla&shy;ra&shy;tion scope</code>. The compiler is right because if you bypass this error, there will be a chance, while in a plug-in, to steal the pass&shy;words of others or to ele&shy;vate  privi&shy;leges for running our plug-in.</p>
<div class="paragraph-right-side">50</div>
</div>
<h2 id="memoryt-and-readonlymemoryt">Memory<T> and Read&shy;Only&shy;Memory<T></h2>
<div class="paragraph-container">
<div class="paragraph-left-side">51</div>
<p>There are two visual diffe&shy;rences between <code>Memory&shy;<T></code> and <code>Span&shy;<T></code>. The first one is that <code>Memory&shy;<T></code> type doesn’t contain <code>ref</code> modi&shy;fier in the header of the type. In other words, the <code>Memory&shy;<T></code> type can be allo&shy;cated both on the stack while being either a local vari&shy;able, or a method para&shy;meter, or its returned value and on the heap, refe&shy;ren&shy;cing some data in memory from there. However&shy;, this small diffe&shy;rence creates a huge distin&shy;ction in the beh&shy;avior and capa&shy;bi&shy;li&shy;ties of <code>Memory&shy;<T></code> compared to <code>Span&shy;<T></code>. Unlike <code>Span&shy;<T></code> that is an <em>inst&shy;rument</em> for some methods to use some data buffer, the <code>Memory&shy;<T></code> type is designed to store infor&shy;ma&shy;tion about the buffer, but not to handle it. Thus&shy;, there is the diffe&shy;rence in API.</p>
<div class="paragraph-right-side">51</div>
</div>
<ul>
<li><code>Memory&shy;<T></code> doesn’t have methods to access the data that it is respon&shy;sible for. Instead&shy;, it has the <code>Span</code> property and the <code>Slice</code> method that return an instance of the <code>Span</code> type.</li>
<li>Additionally&shy;, <code>Memory&shy;<T></code> contains the <code>Pin&shy;()</code> method used for scena&shy;rios when a stored buffer data should be passed to <code>unsafe</code> code. If this method is called when memory is allo&shy;cated in .NET, the buffer will be pinned and will not move when GC is active. This method will return an instance of the <code>Memory&shy;Handle</code> struc&shy;ture, which encap&shy;su&shy;lates <code>GCHa&shy;ndle</code> to indi&shy;cate a segment of a life&shy;time and to pin array buffer in memory.</li>
</ul>
<div class="paragraph-container">
<div class="paragraph-left-side">52</div>
<p>However&shy;, I suggest we get fami&shy;liar with the whole set of classes. First&shy;, let’s look at the <code>Memory&shy;<T></code> struc&shy;ture itself (here I show only those type members that I found most impor&shy;tant):</p>
<div class="paragraph-right-side">52</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
    <span style="color:Blue;">public</span> <span style="color:Blue;">readonly</span> <span style="color:Blue;">struct</span> Memory&lt;T&gt;
    {
        <span style="color:Blue;">private</span> <span style="color:Blue;">readonly</span> <span style="color:Blue;">object</span> _object;
        <span style="color:Blue;">private</span> <span style="color:Blue;">readonly</span> <span style="color:Blue;">int</span> _index, _length;

        <span style="color:Blue;">public</span> Memory(T[] array) { ... }
        <span style="color:Blue;">public</span> Memory(T[] array, <span style="color:Blue;">int</span> start, <span style="color:Blue;">int</span> length) { ... }
        <span style="color:Blue;">internal</span> Memory(MemoryManager&lt;T&gt; manager, <span style="color:Blue;">int</span> length) { ... }
        <span style="color:Blue;">internal</span> Memory(MemoryManager&lt;T&gt; manager, <span style="color:Blue;">int</span> start, <span style="color:Blue;">int</span> length) { ... }

        <span style="color:Blue;">public</span> <span style="color:Blue;">int</span> Length =&gt; _length &amp; RemoveFlagsBitMask;
        <span style="color:Blue;">public</span> <span style="color:Blue;">bool</span> IsEmpty =&gt; (_length &amp; RemoveFlagsBitMask) == 0;

        <span style="color:Blue;">public</span> Memory&lt;T&gt; Slice(<span style="color:Blue;">int</span> start, <span style="color:Blue;">int</span> length);
        <span style="color:Blue;">public</span> <span style="color:Blue;">void</span> CopyTo(Memory&lt;T&gt; destination) =&gt; Span.CopyTo(destination.Span);
        <span style="color:Blue;">public</span> <span style="color:Blue;">bool</span> TryCopyTo(Memory&lt;T&gt; destination) =&gt; Span.TryCopyTo(destination.Span);

        <span style="color:Blue;">public</span> Span&lt;T&gt; Span { <span style="color:Blue;">get</span>; }
        <span style="color:Blue;">public</span> <span style="color:Blue;">unsafe</span> MemoryHandle Pin();
    }
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">53</div>
<p>As we see the struc&shy;ture contains the const&shy;ructor based on arrays, but stores data in the object. This is to addi&shy;ti&shy;o&shy;nally refe&shy;rence  strings that don’t have a const&shy;ructor designed for them, but can be used with the <code>As&shy;Memory&shy;()</code> <code>string</code> method, it returns <code>Read&shy;Only&shy;Memory</code>. However&shy;, as both types should be binary similar, <code>Object</code> is the type of the <code>_object</code> field.</p>
<div class="paragraph-right-side">53</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">54</div>
<p>Next&shy;, we see two const&shy;ructors based on <code>Memory&shy;Manager</code>. We will talk about them later. The proper&shy;ties of obta&shy;i&shy;ning <code>Length</code> (size) and <code>Is&shy;Empty</code> check for an empty set. Also&shy;, there is the <code>Slice</code> method for getting a subset as well as <code>Copy&shy;To</code> and <code>Try&shy;Copy&shy;To</code> methods of copying.</p>
<div class="paragraph-right-side">54</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">55</div>
<p>Talking about <code>Memory</code> I want to desc&shy;ribe two methods of this type in detail:  the <code>Span</code> property and the <code>Pin</code> method.</p>
<div class="paragraph-right-side">55</div>
</div>
<h3 id="memoryt.span">Memory<T>.Span</h3>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">public</span> Span&lt;T&gt; Span
{
    <span style="color:Blue;">get</span>
    {
        <span style="color:Blue;">if</span> (_index &lt; 0)
        {
            <span style="color:Blue;">return</span> ((MemoryManager&lt;T&gt;)_object).GetSpan().Slice(_index &amp; RemoveFlagsBitMask, _length);
        }
        <span style="color:Blue;">else</span> <span style="color:Blue;">if</span> (<span style="color:Blue;">typeof</span>(T) == <span style="color:Blue;">typeof</span>(<span style="color:Blue;">char</span>) &amp;&amp; _object <span style="color:Blue;">is</span> <span style="color:Blue;">string</span> s)
        {
            <span style="color:Green;">// This is dangerous, returning a writable span for a string that should be immutable.</span>
            <span style="color:Green;">// However, we need to handle the case where a ReadOnlyMemory&lt;char&gt; was created from a string</span>
            <span style="color:Green;">// and then cast to a Memory&lt;T&gt;. Such a cast can only be done with unsafe or marshaling code,</span>
            <span style="color:Green;">// in which case that&#39;s the dangerous operation performed by the dev, and we&#39;re just following</span>
            <span style="color:Green;">// suit here to make it work as best as possible.</span>
            <span style="color:Blue;">return</span> <span style="color:Blue;">new</span> Span&lt;T&gt;(<span style="color:Blue;">ref</span> Unsafe.As&lt;<span style="color:Blue;">char</span>, T&gt;(<span style="color:Blue;">ref</span> s.GetRawStringData()), s.Length).Slice(_index, _length);
        }
        <span style="color:Blue;">else</span> <span style="color:Blue;">if</span> (_object != <span style="color:Blue;">null</span>)
        {
            <span style="color:Blue;">return</span> <span style="color:Blue;">new</span> Span&lt;T&gt;((T[])_object, _index, _length &amp; RemoveFlagsBitMask);
        }
        <span style="color:Blue;">else</span>
        {
            <span style="color:Blue;">return</span> <span style="color:Blue;">default</span>;
        }
    }
}
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">56</div>
<p>Namely&shy;, the lines that handle strings mana&shy;ge&shy;ment. They say that if we convert <code>Read&shy;Only&shy;Memory&shy;<T></code> to <code>Memory&shy;<T></code> (these things are the same in binary repre&shy;sen&shy;ta&shy;tion and there is even a comment these types must coin&shy;cide in a binary way as one is produced from another by calling <code>Unsafe&shy;.As</code>) we will get an <sub>access to a secret chamber</sub> with an oppor&shy;tu&shy;nity to change strings. This is an extre&shy;mely dange&shy;rous mech&shy;anism:</p>
<div class="paragraph-right-side">56</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">unsafe</span> <span style="color:Blue;">void</span> Main()
{
    <span style="color:Blue;">var</span> str = <span style="color:#A31515;">&quot;Hello!&quot;</span>;
    ReadOnlyMemory&lt;<span style="color:Blue;">char</span>&gt; ronly = str.AsMemory();
    Memory&lt;<span style="color:Blue;">char</span>&gt; mem = (Memory&lt;<span style="color:Blue;">char</span>&gt;)Unsafe.As&lt;ReadOnlyMemory&lt;<span style="color:Blue;">char</span>&gt;, Memory&lt;<span style="color:Blue;">char</span>&gt;&gt;(<span style="color:Blue;">ref</span> ronly);
    mem.Span[5] = <span style="color:#A31515;">&#39;?&#39;</span>;

    Console.WriteLine(str);
}
---
Hello?
</pre></div>
</div>
<p>This mech&shy;anism combined with string inter&shy;ning can produce dire conse&shy;qu&shy;ences.</p>
<h3 id="memoryt.pin">Memory<T>.Pin</h3>
<p>The second method that draws strong atten&shy;tion is <code>Pin</code>:</p>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">public</span> <span style="color:Blue;">unsafe</span> MemoryHandle Pin()
{
    <span style="color:Blue;">if</span> (_index &lt; 0)
    {
        <span style="color:Blue;">return</span> ((MemoryManager&lt;T&gt;)_object).Pin((_index &amp; RemoveFlagsBitMask));
    }
    <span style="color:Blue;">else</span> <span style="color:Blue;">if</span> (<span style="color:Blue;">typeof</span>(T) == <span style="color:Blue;">typeof</span>(<span style="color:Blue;">char</span>) &amp;&amp; _object <span style="color:Blue;">is</span> <span style="color:Blue;">string</span> s)
    {
        <span style="color:Green;">// This case can only happen if a ReadOnlyMemory&lt;char&gt; was created around a string</span>
        <span style="color:Green;">// and then that was cast to a Memory&lt;char&gt; using unsafe / marshaling code.  This needs</span>
        <span style="color:Green;">// to work, however, so that code that uses a single Memory&lt;char&gt; field to store either</span>
        <span style="color:Green;">// a readable ReadOnlyMemory&lt;char&gt; or a writable Memory&lt;char&gt; can still be pinned and</span>
        <span style="color:Green;">// used for interop purposes.</span>
        GCHandle handle = GCHandle.Alloc(s, GCHandleType.Pinned);
        <span style="color:Blue;">void</span>* pointer = Unsafe.Add&lt;T&gt;(Unsafe.AsPointer(<span style="color:Blue;">ref</span> s.GetRawStringData()), _index);
        <span style="color:Blue;">return</span> <span style="color:Blue;">new</span> MemoryHandle(pointer, handle);
    }
    <span style="color:Blue;">else</span> <span style="color:Blue;">if</span> (_object <span style="color:Blue;">is</span> T[] array)
    {
        <span style="color:Green;">// Array is already pre-pinned</span>
        <span style="color:Blue;">if</span> (_length &lt; 0)
        {
            <span style="color:Blue;">void</span>* pointer = Unsafe.Add&lt;T&gt;(Unsafe.AsPointer(<span style="color:Blue;">ref</span> array.GetRawSzArrayData()), _index);
            <span style="color:Blue;">return</span> <span style="color:Blue;">new</span> MemoryHandle(pointer);
        }
        <span style="color:Blue;">else</span>
        {
            GCHandle handle = GCHandle.Alloc(array, GCHandleType.Pinned);
            <span style="color:Blue;">void</span>* pointer = Unsafe.Add&lt;T&gt;(Unsafe.AsPointer(<span style="color:Blue;">ref</span> array.GetRawSzArrayData()), _index);
            <span style="color:Blue;">return</span> <span style="color:Blue;">new</span> MemoryHandle(pointer, handle);
        }
    }
    <span style="color:Blue;">return</span> <span style="color:Blue;">default</span>;
}
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">57</div>
<p>It is also an impor&shy;tant inst&shy;rument for uni&shy;fi&shy;ca&shy;tion  because if we want to pass a buffer to unma&shy;naged code, we just need to call the <code>Pin&shy;()</code> method and pass a pointer to this code no matter what type of data <code>Memory&shy;<T></code> refers to. This pointer will be stored in the property of a resul&shy;ting struc&shy;ture.</p>
<div class="paragraph-right-side">57</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">void</span> PinSample(Memory&lt;<span style="color:Blue;">byte</span>&gt; memory)
{
    <span style="color:Blue;">using</span>(<span style="color:Blue;">var</span> handle = memory.Pin())
    {
        WinApi.SomeApiMethod(handle.Pointer);
    }
}
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">58</div>
<p>It doesn’t matter what <code>Pin&shy;()</code> was called for in this code: it can be <code>Memory</code> that repre&shy;sents either <code>T[]</code>, or a <code>string</code> or a buffer of unma&shy;naged memory. Merely arrays and string will get a real <code>GCHandle&shy;.Alloc&shy;(array&shy;, GCHandle&shy;Type&shy;.Pinned&shy;)</code> and in case of unma&shy;naged memory nothing will happen.</p>
<div class="paragraph-right-side">58</div>
</div>
<h2 id="memorymanager-imemoryowner-memorypool">Memory&shy;Manager&shy;, IMemory&shy;Owner&shy;, Memory&shy;Pool</h2>
<div class="paragraph-container">
<div class="paragraph-left-side">59</div>
<p>Besides indi&shy;ca&shy;ting struc&shy;ture fields, I want to note that there are two other <code>internal</code> type const&shy;ructors based on an other entity – <code>Memory&shy;Manager</code>. This is not a classic memory manager that you might have thought of and we are going to talk about it later. classic memory manager that you might have thought of and we are going to talk about it later. Like <code>Span</code>, <code>Memory</code> has a refe&shy;rence to a navi&shy;gated object, an offset, and a size of an internal buffer. Note that you can use the <code>new</code> ope&shy;rator to create <code>Memory</code> from an array only. Or&shy;, you can use exten&shy;sion methods to create <code>Memory</code> from a string, an array or <code>Array&shy;Segment</code>. I mean it is not designed to be created from unma&shy;naged memory manu&shy;ally. However&shy;, we can see that there is an internal method to create this struc&shy;ture using <code>Memory&shy;Manager</code>.</p>
<div class="paragraph-right-side">59</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">60</div>
<p><strong>File <a href="https://github.com/dotnet/corefx/blob/master/src/Common/src/CoreLib/System/Buffers/MemoryManager.cs">Memory&shy;Manager&shy;.cs</a></strong></p>
<div class="paragraph-right-side">60</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">public</span> <span style="color:Blue;">abstract</span> <span style="color:Blue;">class</span> MemoryManager&lt;T&gt; : IMemoryOwner&lt;T&gt;, IPinnable
{
    <span style="color:Blue;">public</span> <span style="color:Blue;">abstract</span> MemoryHandle Pin(<span style="color:Blue;">int</span> elementIndex = 0);
    <span style="color:Blue;">public</span> <span style="color:Blue;">abstract</span> <span style="color:Blue;">void</span> Unpin();

    <span style="color:Blue;">public</span> <span style="color:Blue;">virtual</span> Memory&lt;T&gt; Memory =&gt; <span style="color:Blue;">new</span> Memory&lt;T&gt;(<span style="color:Blue;">this</span>, GetSpan().Length);
    <span style="color:Blue;">public</span> <span style="color:Blue;">abstract</span> Span&lt;T&gt; GetSpan();
    <span style="color:Blue;">protected</span> Memory&lt;T&gt; CreateMemory(<span style="color:Blue;">int</span> length) =&gt; <span style="color:Blue;">new</span> Memory&lt;T&gt;(<span style="color:Blue;">this</span>, length);
    <span style="color:Blue;">protected</span> Memory&lt;T&gt; CreateMemory(<span style="color:Blue;">int</span> start, <span style="color:Blue;">int</span> length) =&gt; <span style="color:Blue;">new</span> Memory&lt;T&gt;(<span style="color:Blue;">this</span>, start, length);

    <span style="color:Blue;">void</span> IDisposable.Dispose()
    <span style="color:Blue;">protected</span> <span style="color:Blue;">abstract</span> <span style="color:Blue;">void</span> Dispose(<span style="color:Blue;">bool</span> disposing);
}
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">61</div>
<p>This struc&shy;ture indi&shy;cates the owner of a memory range. In other words, <code>Span</code> is an inst&shy;rument to work with memory, <code>Memory</code> is a tool to store the infor&shy;ma&shy;tion about a parti&shy;cular memory range and <code>Memory&shy;Manager</code> is a tool to control the life&shy;time of this range, i.e. its owner. For example, we can look at <code>Native&shy;Memory&shy;Manager&shy;<T></code> type. Although it is used for tests, this type clearly repre&shy;sents the concept of “ownership”.</p>
<div class="paragraph-right-side">61</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">62</div>
<p><strong>File <a href="https://github.com/dotnet/corefx/blob/888088448ac5dd1053d88434dfd819dcbc0fd9a1/src/Common/tests/System/Buffers/NativeMemoryManager.cs">Native&shy;Memory&shy;Manager&shy;.cs</a></strong></p>
<div class="paragraph-right-side">62</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">internal</span> <span style="color:Blue;">sealed</span> <span style="color:Blue;">class</span> NativeMemoryManager : MemoryManager&lt;<span style="color:Blue;">byte</span>&gt;
{
    <span style="color:Blue;">private</span> <span style="color:Blue;">readonly</span> <span style="color:Blue;">int</span> _length;
    <span style="color:Blue;">private</span> IntPtr _ptr;
    <span style="color:Blue;">private</span> <span style="color:Blue;">int</span> _retainedCount;
    <span style="color:Blue;">private</span> <span style="color:Blue;">bool</span> _disposed;

    <span style="color:Blue;">public</span> NativeMemoryManager(<span style="color:Blue;">int</span> length)
    {
        _length = length;
        _ptr = Marshal.AllocHGlobal(length);
    }

    <span style="color:Blue;">public</span> <span style="color:Blue;">override</span> <span style="color:Blue;">void</span> Pin() { ... }

    <span style="color:Blue;">public</span> <span style="color:Blue;">override</span> <span style="color:Blue;">void</span> Unpin()
    {
        <span style="color:Blue;">lock</span> (<span style="color:Blue;">this</span>)
        {
            <span style="color:Blue;">if</span> (_retainedCount &gt; 0)
            {
                _retainedCount--;
                <span style="color:Blue;">if</span> (_retainedCount== 0)
                {
                    <span style="color:Blue;">if</span> (_disposed)
                    {
                        Marshal.FreeHGlobal(_ptr);
                        _ptr = IntPtr.Zero;
                    }
                }
            }
        }
    }

    <span style="color:Green;">// Other methods</span>
}
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">63</div>
<p>That means the class allows for nested calls of the <code>Pin&shy;()</code> method, thus coun&shy;ting gene&shy;rated refe&shy;rences from the <code>unsafe</code> world.</p>
<div class="paragraph-right-side">63</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">64</div>
<p>Another entity closely tied with <code>Memory</code> is <code>Memory&shy;Pool</code> that pools <code>Memory&shy;Manager</code> instances (<code>IMemory&shy;Owner</code> in fact):</p>
<div class="paragraph-right-side">64</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">65</div>
<p><strong>File <a href="https://github.com/dotnet/corefx/blob/f592e887e2349ed52af6a83070c42adb9d26408c/src/System.Memory/src/System/Buffers/MemoryPool.cs">Memory&shy;Pool&shy;.cs</a></strong></p>
<div class="paragraph-right-side">65</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">public</span> <span style="color:Blue;">abstract</span> <span style="color:Blue;">class</span> MemoryPool&lt;T&gt; : IDisposable
{
    <span style="color:Blue;">public</span> <span style="color:Blue;">static</span> MemoryPool&lt;T&gt; Shared =&gt; s_shared;

    <span style="color:Blue;">public</span> <span style="color:Blue;">abstract</span> IMemoryOwner&lt;T&gt; Rent(<span style="color:Blue;">int</span> minBufferSize = -1);

    <span style="color:Blue;">public</span> <span style="color:Blue;">void</span> Dispose() { ... }
}
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">66</div>
<p>It is used to lease buffers of a neces&shy;sary size for tempo&shy;rary use. The leased instances with imple&shy;mented <code>IMemory&shy;Owner&shy;<T></code> inter&shy;face have the <code>Dispose&shy;()</code> method to return the leased array back to the pool of arrays. By default, you can use the sha&shy;re&shy;able pool of buffers built on <code>Array&shy;Memory&shy;Pool</code>:</p>
<div class="paragraph-right-side">66</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">67</div>
<p><strong>File <a href="https://github.com/dotnet/corefx/blob/56dfb8834fa50f3bc61ea9b4bfdc9dcc759b6ec9/src/System.Memory/src/System/Buffers/ArrayMemoryPool.cs">Array&shy;Memory&shy;Pool&shy;.cs</a></strong></p>
<div class="paragraph-right-side">67</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">internal</span> <span style="color:Blue;">sealed</span> <span style="color:Blue;">partial</span> <span style="color:Blue;">class</span> ArrayMemoryPool&lt;T&gt; : MemoryPool&lt;T&gt;
{
    <span style="color:Blue;">private</span> <span style="color:Blue;">const</span> <span style="color:Blue;">int</span> MaximumBufferSize = <span style="color:Blue;">int</span>.MaxValue;
    <span style="color:Blue;">public</span> <span style="color:Blue;">sealed</span> <span style="color:Blue;">override</span> <span style="color:Blue;">int</span> MaxBufferSize =&gt; MaximumBufferSize;
    <span style="color:Blue;">public</span> <span style="color:Blue;">sealed</span> <span style="color:Blue;">override</span> IMemoryOwner&lt;T&gt; Rent(<span style="color:Blue;">int</span> minimumBufferSize = -1)
    {
        <span style="color:Blue;">if</span> (minimumBufferSize == -1)
            minimumBufferSize = 1 + (4095 / Unsafe.SizeOf&lt;T&gt;());
        <span style="color:Blue;">else</span> <span style="color:Blue;">if</span> (((<span style="color:Blue;">uint</span>)minimumBufferSize) &gt; MaximumBufferSize)
            ThrowHelper.ThrowArgumentOutOfRangeException(ExceptionArgument.minimumBufferSize);

        <span style="color:Blue;">return</span> <span style="color:Blue;">new</span> ArrayMemoryPoolBuffer(minimumBufferSize);
    }
    <span style="color:Blue;">protected</span> <span style="color:Blue;">sealed</span> <span style="color:Blue;">override</span> <span style="color:Blue;">void</span> Dispose(<span style="color:Blue;">bool</span> disposing) { }
}
</pre></div>
</div>
<p>Based on this arch&shy;it&shy;ecture, we have the follo&shy;wing picture:</p>
<div class="paragraph-container">
<div class="paragraph-left-side">68</div>
<p>– <code>Span</code> data type should be used as a method para&shy;meter if you want to read data (<code>Read&shy;Only&shy;Span</code>) or read and write data (<code>Span</code>). However&shy;, it is not supposed to be stored in a field of a class for future use.
– If you need to store a refe&shy;rence from a field of a class to a data buffer, you need to use <code>Memory&shy;<T></code> or <code>Read&shy;Only&shy;Memory&shy;<T></code> depen&shy;ding on your goals.
– <code>Memory&shy;Manager&shy;<T></code> is the owner of a data buffer (opti&shy;onal ). It may be neces&shy;sary if you need to count <code>Pin&shy;()</code> calls for example. Or&shy;, if you need to know how to release memory.
– If <code>Memory</code> is built around an unma&shy;naged memory range, <code>Pin&shy;()</code> can do nothing. However&shy;, this uni&shy;forms working with diffe&shy;rent types of buffers:  for both managed and unma&shy;naged code the inte&shy;rac&shy;tion inter&shy;face will be the same.<br />
– Every type has public const&shy;ructors. That means you can use <code>Span</code> directly or get its instance from <code>Memory</code>. For <code>Memory</code> as such, you can create it indi&shy;vi&shy;du&shy;ally or you can create a memory range owned by <code>IMemory&shy;Owner</code> and refe&shy;renced by <code>Memory</code>. Any type based on <code>Memory&shy;Manger</code> can be regarded as a specific case which it owns some local memory range (e.g. accom&shy;pa&shy;nied by coun&shy;ting the refe&shy;rences from the <code>unsafe</code> world). In addi&shy;tion, if you need to pool such buffers (the frequent traffic of almost equ&shy;ally sized buffers is expected) you can use the <code>Memory&shy;Pool</code> type.
– If you intend to work with <code>unsafe</code> code by passing a data buffer there, you should use the <code>Memory</code> type which has the <code>Pin&shy;()</code> method that aut&shy;om&shy;at&shy;ically pins a buffer on the .NET heap if it was created there.
– If you have some traffic of buffers (for example you parse a text of a program or DSL), it is better to use the <code>Memory&shy;Pool</code> type. You can properly imple&shy;ment it to output the buffers of a neces&shy;sary size from a pool (for example a slightly bigger buffer if there is no suitable one, but using <code>ori&shy;gi&shy;nal&shy;Me&shy;mory.Slice&shy;(required&shy;Size&shy;)</code> to avoid pool frag&shy;men&shy;ta&shy;tion).</p>
<div class="paragraph-right-side">68</div>
</div>
<h2 id="performance">Perfor&shy;mance</h2>
<div class="paragraph-container">
<div class="paragraph-left-side">69</div>
<p>To mea&shy;sure the perfor&shy;mance of new data types I decided to use a library that has already become stan&shy;dard <a href="https://github.com/dotnet/BenchmarkDotNet">Benchmark&shy;Dot&shy;Net</a>:</p>
<div class="paragraph-right-side">69</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
[Config(<span style="color:Blue;">typeof</span>(MultipleRuntimesConfig))]
<span style="color:Blue;">public</span> <span style="color:Blue;">class</span> SpanIndexer
{
    <span style="color:Blue;">private</span> <span style="color:Blue;">const</span> <span style="color:Blue;">int</span> Count = 100;
    <span style="color:Blue;">private</span> <span style="color:Blue;">char</span>[] arrayField;
    <span style="color:Blue;">private</span> ArraySegment&lt;<span style="color:Blue;">char</span>&gt; segment;
    <span style="color:Blue;">private</span> <span style="color:Blue;">string</span> str;

    [GlobalSetup]
    <span style="color:Blue;">public</span> <span style="color:Blue;">void</span> Setup()
    {
        str = <span style="color:Blue;">new</span> <span style="color:Blue;">string</span>(Enumerable.Repeat(<span style="color:#A31515;">&#39;a&#39;</span>, Count).ToArray());
        arrayField = str.ToArray();
        segment = <span style="color:Blue;">new</span> ArraySegment&lt;<span style="color:Blue;">char</span>&gt;(arrayField);
    }

    [Benchmark(Baseline = <span style="color:Blue;">true</span>, OperationsPerInvoke = Count)]
    <span style="color:Blue;">public</span> <span style="color:Blue;">int</span> ArrayIndexer_Get()
    {
        <span style="color:Blue;">var</span> tmp = 0;
        <span style="color:Blue;">for</span> (<span style="color:Blue;">int</span> index = 0, len = arrayField.Length; index &lt; len; index++)
        {
            tmp = arrayField[index];
        }
        <span style="color:Blue;">return</span> tmp;
    }

    [Benchmark(OperationsPerInvoke = Count)]
    <span style="color:Blue;">public</span> <span style="color:Blue;">void</span> ArrayIndexer_Set()
    {
        <span style="color:Blue;">for</span> (<span style="color:Blue;">int</span> index = 0, len = arrayField.Length; index &lt; len; index++)
        {
            arrayField[index] = <span style="color:#A31515;">&#39;0&#39;</span>;
        }
    }

    [Benchmark(OperationsPerInvoke = Count)]
    <span style="color:Blue;">public</span> <span style="color:Blue;">int</span> ArraySegmentIndexer_Get()
    {
        <span style="color:Blue;">var</span> tmp = 0;
        <span style="color:Blue;">var</span> accessor = (IList&lt;<span style="color:Blue;">char</span>&gt;)segment;
        <span style="color:Blue;">for</span> (<span style="color:Blue;">int</span> index = 0, len = accessor.Count; index &lt; len; index++)
        {
            tmp = accessor[index];
        }
        <span style="color:Blue;">return</span> tmp;
    }

    [Benchmark(OperationsPerInvoke = Count)]
    <span style="color:Blue;">public</span> <span style="color:Blue;">void</span> ArraySegmentIndexer_Set()
    {
        <span style="color:Blue;">var</span> accessor = (IList&lt;<span style="color:Blue;">char</span>&gt;)segment;
        <span style="color:Blue;">for</span> (<span style="color:Blue;">int</span> index = 0, len = accessor.Count; index &lt; len; index++)
        {
            accessor[index] = <span style="color:#A31515;">&#39;0&#39;</span>;
        }
    }

    [Benchmark(OperationsPerInvoke = Count)]
    <span style="color:Blue;">public</span> <span style="color:Blue;">int</span> StringIndexer_Get()
    {
        <span style="color:Blue;">var</span> tmp = 0;
        <span style="color:Blue;">for</span> (<span style="color:Blue;">int</span> index = 0, len = str.Length; index &lt; len; index++)
        {
            tmp = str[index];
        }

        <span style="color:Blue;">return</span> tmp;
    }

    [Benchmark(OperationsPerInvoke = Count)]
    <span style="color:Blue;">public</span> <span style="color:Blue;">int</span> SpanArrayIndexer_Get()
    {
        <span style="color:Blue;">var</span> span = arrayField.AsSpan();
        <span style="color:Blue;">var</span> tmp = 0;
        <span style="color:Blue;">for</span> (<span style="color:Blue;">int</span> index = 0, len = span.Length; index &lt; len; index++)
        {
            tmp = span[index];
        }
        <span style="color:Blue;">return</span> tmp;
    }

    [Benchmark(OperationsPerInvoke = Count)]
    <span style="color:Blue;">public</span> <span style="color:Blue;">int</span> SpanArraySegmentIndexer_Get()
    {
        <span style="color:Blue;">var</span> span = segment.AsSpan();
        <span style="color:Blue;">var</span> tmp = 0;
        <span style="color:Blue;">for</span> (<span style="color:Blue;">int</span> index = 0, len = span.Length; index &lt; len; index++)
        {
            tmp = span[index];
        }
        <span style="color:Blue;">return</span> tmp;
    }

    [Benchmark(OperationsPerInvoke = Count)]
    <span style="color:Blue;">public</span> <span style="color:Blue;">int</span> SpanStringIndexer_Get()
    {
        <span style="color:Blue;">var</span> span = str.AsSpan();
        <span style="color:Blue;">var</span> tmp = 0;
        <span style="color:Blue;">for</span> (<span style="color:Blue;">int</span> index = 0, len = span.Length; index &lt; len; index++)
        {
            tmp = span[index];
        }
        <span style="color:Blue;">return</span> tmp;
    }

    [Benchmark(OperationsPerInvoke = Count)]
    <span style="color:Blue;">public</span> <span style="color:Blue;">void</span> SpanArrayIndexer_Set()
    {
        <span style="color:Blue;">var</span> span = arrayField.AsSpan();
        <span style="color:Blue;">for</span> (<span style="color:Blue;">int</span> index = 0, len = span.Length; index &lt; len; index++)
        {
            span[index] = <span style="color:#A31515;">&#39;0&#39;</span>;
        }
    }

    [Benchmark(OperationsPerInvoke = Count)]
    <span style="color:Blue;">public</span> <span style="color:Blue;">void</span> SpanArraySegmentIndexer_Set()
    {
        <span style="color:Blue;">var</span> span = segment.AsSpan();
        <span style="color:Blue;">for</span> (<span style="color:Blue;">int</span> index = 0, len = span.Length; index &lt; len; index++)
        {
            span[index] = <span style="color:#A31515;">&#39;0&#39;</span>;
        }
    }
}

<span style="color:Blue;">public</span> <span style="color:Blue;">class</span> MultipleRuntimesConfig : ManualConfig
{
    <span style="color:Blue;">public</span> MultipleRuntimesConfig()
    {
        Add(Job.Default
            .With(CsProjClassicNetToolchain.Net471) <span style="color:Green;">// Span not supported by CLR</span>
            .WithId(<span style="color:#A31515;">&quot;.NET 4.7.1&quot;</span>));

        Add(Job.Default
            .With(CsProjCoreToolchain.NetCoreApp20) <span style="color:Green;">// Span supported by CLR</span>
            .WithId(<span style="color:#A31515;">&quot;.NET Core 2.0&quot;</span>));

        Add(Job.Default
            .With(CsProjCoreToolchain.NetCoreApp21) <span style="color:Green;">// Span supported by CLR</span>
            .WithId(<span style="color:#A31515;">&quot;.NET Core 2.1&quot;</span>));

        Add(Job.Default
            .With(CsProjCoreToolchain.NetCoreApp22) <span style="color:Green;">// Span supported by CLR</span>
            .WithId(<span style="color:#A31515;">&quot;.NET Core 2.2&quot;</span>));
    }
}
</pre></div>
</div>
<p>Now&shy;, let’s see the results.</p>
<p><img src="./imgs/Span/Performance.png" alt="Perfor&shy;mance chart" /></p>
<p>Loo&shy;king at them we can get the follo&shy;wing infor&shy;ma&shy;tion:</p>
<ul>
<li><code>Array&shy;Segment</code> is awful. But if you wrap it in <code>Span</code> you can make it less awful. In this case, perfor&shy;mance will increase 7 times.</li>
<li>If we consider .NET Frame&shy;work 4.7.1 (the same thing is for 4.5), the use of <code>Span</code> will signi&shy;fi&shy;cantly lower the perfor&shy;mance when working with data buffers. It will decrease by 30–35 %.</li>
<li>However&shy;, if we look at .NET Core 2.1+ the perfor&shy;mance remains similar or even incre&shy;ases given that <code>Span</code> can use a part of a data buffer, crea&shy;ting the context.  The same functi&shy;o&shy;na&shy;lity can be found in <code>Array&shy;Segment</code>, but it works very slowly.</li>
</ul>
<p>Thus&shy;, we can draw simple conc&shy;lu&shy;sions regar&shy;ding the use of these data types:</p>
<ul>
<li>for <code>.NET Frame&shy;work 4.5+</code> и <code>.NET Core</code> they have the only advan&shy;tage:  they are faster than <code>Array&shy;Segment</code> when dea&shy;ling with a subset of an ori&shy;ginal array;</li>
<li>in <code>.NET Core 2.1+</code> their use gives an unde&shy;ni&shy;able advan&shy;tage over both <code>Array&shy;Segment</code> and any manual imple&shy;men&shy;ta&shy;tion of <code>Slice</code>;</li>
<li>all three ways are as produc&shy;tive as possible and that cannot be achieved with any tool to unify arrays.</li>
</ul>

        </div>
        <footer>
            <div class="footer-container">
                <div class="footer-wrap">
                    <img src="../res/img/logo-w-noindex.svg">
                    <p>
                        <a class="footer-link" target="_blank" href="mailto:sidristij@clrium.ru"><i class="far fa-envelope" aria-hidden="true"></i></a>
                        <a class="footer-link" target="_blank" href="https://vk.com/clrium"><i class="fab fa-vk" aria-hidden="true"></i></a>
                        <a class="footer-link" target="_blank" href="https://youtube.com/clrium"><i class="fab fa-youtube" aria-hidden="true"></i></a>
                        <a class="footer-link" target="_blank" href="https://github.com/clrium"><i class="fab fa-github" aria-hidden="true"></i></a>
                        <a class="footer-link" target="_blank" href="skype:stanislav.sidristyi"><i class="fab fa-skype" aria-hidden="true"></i></a>
                        <a class="footer-link" target="_blank" href="https://t.me/clrium_group"><i class="fab fa-telegram" aria-hidden="true"></i></a>
                    </p>
                </div>
            </div>
        </footer>
    </div>
</body>
</html>