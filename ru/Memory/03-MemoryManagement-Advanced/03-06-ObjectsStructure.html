<!DOCTYPE html>
<html lang="ru">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>.NET Platform Architecture</title>
</head>
<body>
    <script src="../../../ru/res/jquery.js"></script>
    <link rel="stylesheet" href="../../../ru/res/bootstrap.css">
    <link rel="stylesheet" href="../../../ru/res/awesome.css">
    <link rel="stylesheet" href="../../../ru/res/default.css">
   
    <header class="header fixed d-block d-lg-none">
        <p class="conflogo">KB</p> 

        <!-- mobile-menu -->

        <div class="hamburger-menu">
            <input id="menu__toggle" type="checkbox" />
            <label class="menu__btn" for="menu__toggle">
              <span></span>
            </label>
        
            <div class="menu__box">
                <p class="menu__header_current">На странице</p>
                <ol class="menu__list">
                    <li><a href="#section-1" onclick="$('#menu__toggle').click(); return true;">
Внутренняя структура экземпляров типов</a></li>
<li><a href="#virtual-methods-table-vmt" onclick="$('#menu__toggle').click(); return true;">
Таблица методов в Virtual Methods Table (VMT)</a></li>
<li><a href="#virtual-stub-dispatch-vsd-in-progress" onclick="$('#menu__toggle').click(); return true;">
Virtual Stub Dispatch (VSD) </a></li>
<li><a href="#section-5" onclick="$('#menu__toggle').click(); return true;">
Раздел вопросов по теме</a></li>
<li><a href="#section-6" onclick="$('#menu__toggle').click(); return true;">
Что плохого в неявных и множественных реализациях интерфейсов?</a></li>

                </ol>
                <p class="menu__header_total">Содержание</p>
                <ul class="menu__header_list">
                    <li>
                        <p class="menu__header_total_sub">
                            Управление памятью
                        </p>
                        <p class="menu__header_total_sub2">
                            Теоретические вопросы:
                        </p>
                        <ol class="menu__list">
                            <li><p><a href="../../../ruru/Memory/01-00-MemoryManagement-Intro.html">
                                Общие слова
                            </a></p></li>
                            <li>
                                <p>
                                <a href="../../../ruru/Memory/01-02-MemoryManagement-Basics.html">Введение в управление памятью</a></p>
                            </li>
                            <li>
                                <p>
                                <a href="../../../ruru/Memory/01-04-MemoryManagement-ThreadStack.html">Стек потока</a></p>
                            </li>
                            <li>
                                <p>
                                <a href="../../../ruru/Memory/01-06-MemoryManagement-EntitiesLifetime.html">Время жизни сущности</a></p>
                            </li>
                            <li>
                                <p>
                                <a href="../../../ruru/Memory/01-08-MemoryManagement-RefVsValueTypes.html">RefTypes, ValueTypes, Boxing &amp; Unboxing</a></p>
                            </li>
                            <li>
                                <p>
                                <a href="../../../ruru/Memory/01-10-MemoryManagement-IDisposable.html">Шаблон IDisposable</a></p>
                            </li>
                            <li>
                                <p>
                                <a href="../../../ruru/Memory/01-12-MemoryManagement-Finalizer.html">Финализация</a></p>
                            </li>
                            <li>
                                <p>
                                <a href="../../../ruru/Memory/01-14-MemoryManagement-Results.html">Выводы</a></p>
                            </li>
                        </ol>
                        <p class="menu__header_total_sub2">
                            Практические вопросы:
                        </p>
                        <ol class="menu__list" start="9">
                            <li><p><a href="../../../ruru/Memory/02-02-MemoryManagement-MemorySpan.html">
                                Memory&lt;T&gt;, Span&lt;T&gt;
                            </a></p></li>
                        </ol> 
                    </li>
                    <li>
                        <p class="menu__header_total_sub">
                            Поток исполнения команд
                        </p>
                        <p class="menu__header_total_sub2">
                            Многопоточность:
                        </p>
                        <ol class="menu__list">
                            <li><p><a href="../../../ruru/Execution/1-Threads/1-OS/1-threadsScheduling.html">
                                Потоки и планирование потоков
                            </a></p></li>
                        </ol>
                        <p class="menu__header_total_sub2">
                            Искл­юч­ител­ьные си­ту­а­ции:
                        </p>
                        <ol class="menu__list" start="2">
                            <li><p><a href="../../../ruru/Execution/2-ExceptionalFlow/1-Exceptions-Intro.html">
                                Введение в исключительные ситуации
                            </a></p></li>
                            <li><p><a href="../../../ruru/Execution/2-ExceptionalFlow/2-Exceptions-Architecture.html">
                                Архитектура исключительной ситуации
                            </a></p></li>
                            <li><p><a href="../../../ruru/Execution/2-ExceptionalFlow/3-Exceptions-Events.html">
                                События об исключительных ситуациях
                            </a></p></li>
                            <li><p><a href="../../../ruru/Execution/2-ExceptionalFlow/4-Exceptions-Types.html">
                                Виды исключительных ситуаций
                            </a></p></li>
                        </ol>
                    </li>
                </ul>
            </div>
        </div>
    </header>

    <div class="book-container">
        <div class="article-container">
            <!--<p class="d-xs-block d-sm-none">XS</p>
            <p class="d-none d-xs-block d-sm-none">SM</p>
            <p class="d-none d-sm-block d-md-none">MD</p>
            <p class="d-none d-lg-block d-xl-none">LG</p>
            <p class="d-none d-xl-block">XL</p> -->
            <h1 id="section">Струк&shy;ту&shy;ра<span class="spacer"> </span>объе&shy;к&shy;тов<span class="spacer"> </span>в<span class="spacer"> </span>па&shy;мя&shy;ти</h1>
<div class="paragraph-container">
<div class="paragraph-left-side">01</div>
<p>До<span class="spacer"> </span>се&shy;го<span class="spacer"> </span>мом&shy;ен&shy;та,<span class="spacer"> </span>го&shy;во&shy;ря<span class="spacer"> </span>про<span class="spacer"> </span>раз&shy;ни&shy;цу<span class="spacer"> </span>меж&shy;ду<span class="spacer"> </span>зна&shy;чи&shy;мы&shy;ми<span class="spacer"> </span>и<span class="spacer"> </span>ссы&shy;лоч&shy;ны&shy;ми<span class="spacer"> </span>ти&shy;па&shy;ми,<span class="spacer"> </span>мы<span class="spacer"> </span>зат&shy;ра&shy;ги&shy;ва&shy;ли<span class="spacer"> </span>эту<span class="spacer"> </span>те&shy;му<span class="spacer"> </span>с<span class="spacer"> </span>вы&shy;со&shy;ты<span class="spacer"> </span>кон&shy;еч&shy;но&shy;го<span class="spacer"> </span>раз&shy;раб&shy;от&shy;чи&shy;ка.<span class="spacer"> </span>Т.е.<span class="spacer"> </span>мы<span class="spacer"> </span>ник&shy;ог&shy;да<span class="spacer"> </span>не<span class="spacer"> </span>смот&shy;ре&shy;ли<span class="spacer"> </span>на<span class="spacer"> </span>то,<span class="spacer"> </span>как<span class="spacer"> </span>они<span class="spacer"> </span>в<span class="spacer"> </span>ре&shy;аль&shy;нос&shy;ти<span class="spacer"> </span>ус&shy;тро&shy;е&shy;ны<span class="spacer"> </span>и<span class="spacer"> </span>ка&shy;кие<span class="spacer"> </span>при&shy;е&shy;мы<span class="spacer"> </span>ре&shy;а&shy;ли&shy;зо&shy;ва&shy;ны<span class="spacer"> </span>в<span class="spacer"> </span>них<span class="spacer"> </span>на<span class="spacer"> </span>уровне<span class="spacer"> </span>CLR.<span class="spacer"> </span>Мы<span class="spacer"> </span>смот&shy;ре&shy;ли,<span class="spacer"> </span>фак&shy;тич&shy;ес&shy;ки,<span class="spacer"> </span>на<span class="spacer"> </span>кон&shy;еч&shy;ный<span class="spacer"> </span>рез&shy;уль&shy;тат<span class="spacer"> </span>и<span class="spacer"> </span>рас&shy;суж&shy;да&shy;ли<span class="spacer"> </span>с<span class="spacer"> </span>точ&shy;ки<span class="spacer"> </span>зре&shy;ния<span class="spacer"> </span>изу&shy;че&shy;ния<span class="spacer"> </span>чер&shy;но&shy;го<span class="spacer"> </span>ящика.<span class="spacer"> </span>Одна&shy;ко,<span class="spacer"> </span>что&shy;бы<span class="spacer"> </span>по&shy;ни&shy;мать<span class="spacer"> </span>суть<span class="spacer"> </span>ве&shy;щей<span class="spacer"> </span>глуб&shy;же<span class="spacer"> </span>и<span class="spacer"> </span>что&shy;бы<span class="spacer"> </span>от&shy;бро&shy;сить<span class="spacer"> </span>в<span class="spacer"> </span>сто&shy;ро&shy;ну<span class="spacer"> </span>пос&shy;лед&shy;ние<span class="spacer"> </span>ос&shy;тав&shy;ши&shy;е&shy;ся<span class="spacer"> </span>мыс&shy;ли<span class="spacer"> </span>о<span class="spacer"> </span>ка&shy;кой-ли&shy;бо<span class="spacer"> </span>ма&shy;гии,<span class="spacer"> </span>про&shy;ис&shy;хо&shy;дя&shy;щей<span class="spacer"> </span>внут&shy;ри<span class="spacer"> </span>CLR,<span class="spacer"> </span>сто&shy;ит<span class="spacer"> </span>заг&shy;ля&shy;нуть<span class="spacer"> </span>в<span class="spacer"> </span>са&shy;мые<span class="spacer"> </span>ее<span class="spacer"> </span>пот&shy;ро&shy;ха<span class="spacer"> </span>и<span class="spacer"> </span>изу&shy;чить<span class="spacer"> </span>те<span class="spacer"> </span>ал&shy;гор&shy;ит&shy;мы,<span class="spacer"> </span>ко&shy;то&shy;рые<span class="spacer"> </span>сис&shy;те&shy;му<span class="spacer"> </span>ти&shy;пов<span class="spacer"> </span>ре&shy;гу&shy;ли&shy;ру&shy;ют.</p>
<div class="paragraph-right-side">01</div>
</div>
<h2 id="section-1">Внут&shy;рен&shy;няя<span class="spacer"> </span>струк&shy;ту&shy;ра<span class="spacer"> </span>эк&shy;земп&shy;ля&shy;ров<span class="spacer"> </span>ти&shy;пов</h2>
<div class="paragraph-container">
<div class="paragraph-left-side">02</div>
<p>Пе&shy;ред<span class="spacer"> </span>тем<span class="spacer"> </span>как<span class="spacer"> </span>на&shy;чи&shy;нать<span class="spacer"> </span>рас&shy;суж&shy;де&shy;ние<span class="spacer"> </span>о<span class="spacer"> </span>стр&shy;о&shy;ении<span class="spacer"> </span>уп&shy;рав&shy;ля&shy;ю&shy;щих<span class="spacer"> </span>бло&shy;ков<span class="spacer"> </span>сис&shy;те&shy;мы<span class="spacer"> </span>ти&shy;пов<span class="spacer"> </span>дав&shy;ай&shy;те<span class="spacer"> </span>пос&shy;мот&shy;рим<span class="spacer"> </span>на<span class="spacer"> </span>сам<span class="spacer"> </span>объект,<span class="spacer"> </span>на<span class="spacer"> </span>эк&shy;земп&shy;ляр<span class="spacer"> </span>лю&shy;бо&shy;го<span class="spacer"> </span>клас&shy;са.<span class="spacer"> </span>Если<span class="spacer"> </span>мы<span class="spacer"> </span>соз&shy;да&shy;дим<span class="spacer"> </span>в<span class="spacer"> </span>па&shy;мя&shy;ти<span class="spacer"> </span>эк&shy;земп&shy;ляр<span class="spacer"> </span>лю&shy;бо&shy;го<span class="spacer"> </span>ссы&shy;лоч&shy;но&shy;го<span class="spacer"> </span>ти&shy;па,<span class="spacer"> </span>будь<span class="spacer"> </span>то<span class="spacer"> </span>класс<span class="spacer"> </span>или<span class="spacer"> </span>же<span class="spacer"> </span>упа&shy;ков&shy;ан&shy;ная<span class="spacer"> </span>струк&shy;ту&shy;ра,<span class="spacer"> </span>то<span class="spacer"> </span>сос&shy;то&shy;ять<span class="spacer"> </span>он<span class="spacer"> </span>бу&shy;дет<span class="spacer"> </span>все&shy;го<span class="spacer"> </span>из<span class="spacer"> </span>трёх<span class="spacer"> </span>по&shy;лей:<span class="spacer"> </span>Sync&shy;Block&shy;Index<span class="spacer"> </span>(ко&shy;то&shy;рый<span class="spacer"> </span>на<span class="spacer"> </span>са&shy;мом<span class="spacer"> </span>де&shy;ле<span class="spacer"> </span>не<span class="spacer"> </span>толь&shy;ко<span class="spacer"> </span>он),<span class="spacer"> </span>ука&shy;за&shy;тель<span class="spacer"> </span>на<span class="spacer"> </span>опи&shy;са&shy;тель<span class="spacer"> </span>ти&shy;па<span class="spacer"> </span>и<span class="spacer"> </span>дан&shy;ные.<span class="spacer"> </span>Область<span class="spacer"> </span>дан&shy;ных<span class="spacer"> </span>мо&shy;жет<span class="spacer"> </span>сод&shy;ер&shy;жать<span class="spacer"> </span>очень<span class="spacer"> </span>мно&shy;го<span class="spacer"> </span>по&shy;лей,<span class="spacer"> </span>но,<span class="spacer"> </span>не<span class="spacer"> </span>ума&shy;ляя<span class="spacer"> </span>об&shy;щнос&shy;ти,<span class="spacer"> </span>ни&shy;же<span class="spacer"> </span>в<span class="spacer"> </span>при&shy;ме&shy;ре<span class="spacer"> </span>по&shy;ла&shy;га&shy;ем,<span class="spacer"> </span>что<span class="spacer"> </span>в<span class="spacer"> </span>дан&shy;ных<span class="spacer"> </span>сод&shy;ер&shy;жит&shy;ся<span class="spacer"> </span>од&shy;но<span class="spacer"> </span>по&shy;ле.<span class="spacer"> </span>Так,<span class="spacer"> </span>ес&shy;ли<span class="spacer"> </span>предс&shy;та&shy;вить<span class="spacer"> </span>эту<span class="spacer"> </span>струк&shy;ту&shy;ру<span class="spacer"> </span>гра&shy;фич&shy;ес&shy;ки,<span class="spacer"> </span>то<span class="spacer"> </span>мы<span class="spacer"> </span>по&shy;лу&shy;чим<span class="spacer"> </span>сле&shy;ду&shy;ю&shy;щее:</p>
<div class="paragraph-right-side">02</div>
</div>
<p><strong>System&shy;.Object</strong></p>
<pre><code>  ----------------------------------------------
  |  SyncBlkIndx |   VMT_Ptr    |     Data     |
  ----------------------------------------------
  |  4 / 8 байт  |  4 / 8 байт  |  4 / 8 байт  |
  ----------------------------------------------
  |  0xFFF..FFF  |  0xXXX..XXX  |      0       |
  ----------------------------------------------
                 ^
                 | Сюда ведут ссылки на объект. Т.е. не в начало, а на VMT

  Sum size = 12 (x86) | 24 (x64)
</code></pre>
<div class="paragraph-container">
<div class="paragraph-left-side">03</div>
<p>Т.е.<span class="spacer"> </span>фак&shy;тич&shy;ес&shy;ки<span class="spacer"> </span>раз&shy;мер<span class="spacer"> </span>эк&shy;земп&shy;ля&shy;ра<span class="spacer"> </span>ти&shy;па<span class="spacer"> </span>за&shy;ви&shy;сит<span class="spacer"> </span>от<span class="spacer"> </span>кон&shy;еч&shy;ной<span class="spacer"> </span>плат&shy;фор&shy;мы,<span class="spacer"> </span>на<span class="spacer"> </span>ко&shy;то&shy;рой<span class="spacer"> </span>бу&shy;дет<span class="spacer"> </span>ра&shy;бо&shy;тать<span class="spacer"> </span>при&shy;ло&shy;же&shy;ние.</p>
<div class="paragraph-right-side">03</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">04</div>
<p>Да&shy;лее<span class="spacer"> </span>дав&shy;ай&shy;те<span class="spacer"> </span>прос&shy;ле&shy;ду&shy;ем<span class="spacer"> </span>по<span class="spacer"> </span>ука&shy;за&shy;телю<span class="spacer"> </span><code>VMT_Ptr</code><span class="spacer"> </span>и<span class="spacer"> </span>пос&shy;мот&shy;рим,<span class="spacer"> </span>ка&shy;кая<span class="spacer"> </span>струк&shy;ту&shy;ра<span class="spacer"> </span>дан&shy;ных<span class="spacer"> </span>ле&shy;жит<span class="spacer"> </span>по<span class="spacer"> </span>этому<span class="spacer"> </span>ад&shy;ре&shy;су.<span class="spacer"> </span>Для<span class="spacer"> </span>всей<span class="spacer"> </span>сис&shy;те&shy;мы<span class="spacer"> </span>ти&shy;пов<span class="spacer"> </span>этот<span class="spacer"> </span>ука&shy;за&shy;тель<span class="spacer"> </span>яв&shy;ля&shy;ет&shy;ся<span class="spacer"> </span>са&shy;мым<span class="spacer"> </span>глав&shy;ным:<span class="spacer"> </span>именно<span class="spacer"> </span>че&shy;рез<span class="spacer"> </span>не&shy;го<span class="spacer"> </span>ра&shy;бо&shy;та&shy;ет<span class="spacer"> </span>и<span class="spacer"> </span>нас&shy;ле&shy;до&shy;ва&shy;ние,<span class="spacer"> </span>и<span class="spacer"> </span>ре&shy;а&shy;ли&shy;за&shy;ция<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;сов,<span class="spacer"> </span>и<span class="spacer"> </span>при&shy;ве&shy;де&shy;ние<span class="spacer"> </span>ти&shy;пов,<span class="spacer"> </span>и<span class="spacer"> </span>мно&shy;го<span class="spacer"> </span>че&shy;го<span class="spacer"> </span>ещё.<span class="spacer"> </span>Этот<span class="spacer"> </span>ука&shy;за&shy;тель<span class="spacer"> </span> &mdash; <span class="spacer"> </span>от&shy;сыл&shy;ка<span class="spacer"> </span>в<span class="spacer"> </span>сис&shy;те&shy;му<span class="spacer"> </span>ти&shy;пов<span class="spacer"> </span>.NET<span class="spacer"> </span>CLR,<span class="spacer"> </span>пас&shy;порт<span class="spacer"> </span>объе&shy;кта,<span class="spacer"> </span>по<span class="spacer"> </span>ко&shy;то&shy;ро&shy;му<span class="spacer"> </span>CLR<span class="spacer"> </span>осущ&shy;ест&shy;вляет<span class="spacer"> </span>при&shy;ве&shy;де&shy;ние<span class="spacer"> </span>ти&shy;пов,<span class="spacer"> </span>по&shy;ни&shy;ма&shy;ет<span class="spacer"> </span>объем<span class="spacer"> </span>па&shy;мя&shy;ти,<span class="spacer"> </span>за&shy;ни&shy;ма&shy;е&shy;мый<span class="spacer"> </span>объе&shy;к&shy;том,<span class="spacer"> </span>именно<span class="spacer"> </span>при<span class="spacer"> </span>по&shy;мо&shy;щи<span class="spacer"> </span>не&shy;го<span class="spacer"> </span>GC<span class="spacer"> </span>так<span class="spacer"> </span>ли&shy;хо<span class="spacer"> </span>об&shy;хо&shy;дит<span class="spacer"> </span>объект,<span class="spacer"> </span>оп&shy;ре&shy;де&shy;ляя,<span class="spacer"> </span>по<span class="spacer"> </span>ка&shy;ким<span class="spacer"> </span>ад&shy;ре&shy;сам<span class="spacer"> </span>ле&shy;жат<span class="spacer"> </span>ука&shy;за&shy;тели<span class="spacer"> </span>на<span class="spacer"> </span>объе&shy;кты,<span class="spacer"> </span>а<span class="spacer"> </span>по<span class="spacer"> </span>ка&shy;ким<span class="spacer"> </span> &mdash; <span class="spacer"> </span>прос&shy;то<span class="spacer"> </span>чис&shy;ла.<span class="spacer"> </span>Имен&shy;но<span class="spacer"> </span>че&shy;рез<span class="spacer"> </span>не&shy;го<span class="spacer"> </span>мож&shy;но<span class="spacer"> </span>уз&shy;нать<span class="spacer"> </span>во&shy;об&shy;ще<span class="spacer"> </span>все<span class="spacer"> </span>об<span class="spacer"> </span>объе&shy;кте<span class="spacer"> </span>и<span class="spacer"> </span>зас&shy;та&shy;вить<span class="spacer"> </span>CLR<span class="spacer"> </span>от&shy;ра&shy;ба&shy;ты&shy;вать<span class="spacer"> </span>его<span class="spacer"> </span>по-дру&shy;го&shy;му.<span class="spacer"> </span>А<span class="spacer"> </span>по&shy;то&shy;му<span class="spacer"> </span>именно<span class="spacer"> </span>им<span class="spacer"> </span>и<span class="spacer"> </span>займёмся.</p>
<div class="paragraph-right-side">04</div>
</div>
<h3 id="virtual-methods-table">Струк&shy;ту&shy;ра<span class="spacer"> </span>Virtual<span class="spacer"> </span>Methods<span class="spacer"> </span>Table</h3>
<div class="paragraph-container">
<div class="paragraph-left-side">05</div>
<p>Опи&shy;са&shy;ние<span class="spacer"> </span>са&shy;мой<span class="spacer"> </span>таб&shy;ли&shy;цы<span class="spacer"> </span>дос&shy;туп&shy;но<span class="spacer"> </span>по<span class="spacer"> </span>ад&shy;ре&shy;су<span class="spacer"> </span>в<span class="spacer"> </span><a href="https://github.com/dotnet/coreclr/blob/master/src/vm/methodtable.h">Git&shy;Hub<span class="spacer"> </span>Core&shy;CLR</a>,<span class="spacer"> </span>и<span class="spacer"> </span>ес&shy;ли<span class="spacer"> </span>от&shy;бро&shy;сить<span class="spacer"> </span>все<span class="spacer"> </span>лиш&shy;нее<span class="spacer"> </span>(а<span class="spacer"> </span>там<span class="spacer"> </span>4381<span class="spacer"> </span>стро&shy;ка),<span class="spacer"> </span><a href="https://github.com/dotnet/coreclr/blob/master/src/vm/methodtable.h#L4099-L4114">выг&shy;ля&shy;дит<span class="spacer"> </span>она<span class="spacer"> </span>сле&shy;ду&shy;ю&shy;щим<span class="spacer"> </span>об&shy;ра&shy;зом</a>:</p>
<div class="paragraph-right-side">05</div>
</div>
<blockquote>
<p>Это<span class="spacer"> </span>вер&shy;сия<span class="spacer"> </span>из<span class="spacer"> </span>Core&shy;CLR.<span class="spacer"> </span>Если<span class="spacer"> </span>смот&shy;реть<span class="spacer"> </span>на<span class="spacer"> </span>струк&shy;ту&shy;ру<span class="spacer"> </span>по&shy;лей<span class="spacer"> </span>в<span class="spacer"> </span>.NET<span class="spacer"> </span>Framework&shy;,<span class="spacer"> </span>то<span class="spacer"> </span>она<span class="spacer"> </span>бу&shy;дет<span class="spacer"> </span>от&shy;лич&shy;ать&shy;ся<span class="spacer"> </span>рас&shy;по&shy;ло&shy;же&shy;ни&shy;ем<span class="spacer"> </span>по&shy;лей<span class="spacer"> </span>и<span class="spacer"> </span>рас&shy;по&shy;ло&shy;же&shy;ни&shy;ем<span class="spacer"> </span>от&shy;дель&shy;ных<span class="spacer"> </span>би&shy;тов<span class="spacer"> </span>сис&shy;тем&shy;ной<span class="spacer"> </span>ин&shy;фор&shy;ма&shy;ции<span class="spacer"> </span>из<span class="spacer"> </span>двух<span class="spacer"> </span>би&shy;то&shy;вых<span class="spacer"> </span>по&shy;лей<span class="spacer"> </span><code>m_wFlags</code><span class="spacer"> </span>и<span class="spacer"> </span><code>m_wFlags2</code>.</p>
</blockquote>
<div class="lang-cpp editor-colors"><div style="color:Black;background-color:White;"><pre>
    <span style="color:Green;">// Low WORD is component size for array and string types (HasComponentSize() returns true).</span>
    <span style="color:Green;">// Used for flags otherwise.</span>
    DWORD m_dwFlags;

    <span style="color:Green;">// Base size of instance of this class when allocated on the heap</span>
    DWORD m_BaseSize;

    WORD  m_wFlags2;

    <span style="color:Green;">// Class token if it fits into 16-bits. If this is (WORD)-1, the class token is stored in the TokenOverflow optional member.</span>
    WORD  m_wToken;

    <span style="color:Green;">// &lt;NICE&gt; In the normal cases we shouldn&#39;t need a full word for each of these &lt;/NICE&gt;</span>
    WORD  m_wNumVirtuals;
    WORD  m_wNumInterfaces;
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">06</div>
<p>Сог&shy;ла&shy;си&shy;тесь,<span class="spacer"> </span>выг&shy;ля&shy;дит<span class="spacer"> </span>нес&shy;коль&shy;ко<span class="spacer"> </span>пу&shy;га&shy;ю&shy;ще.<span class="spacer"> </span>Причём<span class="spacer"> </span>пу&shy;га&shy;ю&shy;ще<span class="spacer"> </span>выг&shy;ля&shy;дит<span class="spacer"> </span>не<span class="spacer"> </span>то,<span class="spacer"> </span>что<span class="spacer"> </span>тут<span class="spacer"> </span>все&shy;го<span class="spacer"> </span>6<span class="spacer"> </span>по&shy;лей<span class="spacer"> </span>(а<span class="spacer"> </span>где<span class="spacer"> </span>все<span class="spacer"> </span>ос&shy;таль&shy;ные?),<span class="spacer"> </span>а<span class="spacer"> </span>то,<span class="spacer"> </span>что<span class="spacer"> </span>для<span class="spacer"> </span>дос&shy;ти&shy;же&shy;ния<span class="spacer"> </span>этих<span class="spacer"> </span>по&shy;лей,<span class="spacer"> </span>не&shy;об&shy;хо&shy;ди&shy;мо<span class="spacer"> </span>про&shy;пус&shy;тить<span class="spacer"> </span>4,100<span class="spacer"> </span>строк<span class="spacer"> </span>ло&shy;ги&shy;ки.<span class="spacer"> </span>Я<span class="spacer"> </span>лич&shy;но<span class="spacer"> </span>ожи&shy;дал<span class="spacer"> </span>тут<span class="spacer"> </span>уви&shy;деть<span class="spacer"> </span>что-то<span class="spacer"> </span>го&shy;то&shy;вое,<span class="spacer"> </span>че&shy;го<span class="spacer"> </span>не<span class="spacer"> </span>на&shy;до<span class="spacer"> </span>доп&shy;ол&shy;нит&shy;ель&shy;но<span class="spacer"> </span>выч&shy;ис&shy;лять.<span class="spacer"> </span>Одна&shy;ко,<span class="spacer"> </span>тут<span class="spacer"> </span>все<span class="spacer"> </span>сов&shy;сем<span class="spacer"> </span>не<span class="spacer"> </span>так<span class="spacer"> </span>прос&shy;то:<span class="spacer"> </span>пос&shy;коль&shy;ку<span class="spacer"> </span>ме&shy;то&shy;дов<span class="spacer"> </span>и<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;сов<span class="spacer"> </span>в<span class="spacer"> </span>лю&shy;бом<span class="spacer"> </span>ти&shy;пе<span class="spacer"> </span>мо&shy;жет<span class="spacer"> </span>быть<span class="spacer"> </span>раз&shy;лич&shy;ное<span class="spacer"> </span>ко&shy;лич&shy;ес&shy;т&shy;во,<span class="spacer"> </span>то<span class="spacer"> </span>и<span class="spacer"> </span>са&shy;ма<span class="spacer"> </span>таб&shy;ли&shy;ца<span class="spacer"> </span>VMT<span class="spacer"> </span>по&shy;лу&shy;ча&shy;ет&shy;ся<span class="spacer"> </span>пе&shy;рем&shy;ен&shy;но&shy;го<span class="spacer"> </span>раз&shy;ме&shy;ра.<span class="spacer"> </span>А<span class="spacer"> </span>это<span class="spacer"> </span>в<span class="spacer"> </span>свою<span class="spacer"> </span>оче&shy;редь<span class="spacer"> </span>оз&shy;на&shy;ча&shy;ет,<span class="spacer"> </span>что<span class="spacer"> </span>для<span class="spacer"> </span>дос&shy;ти&shy;же&shy;ния<span class="spacer"> </span>её<span class="spacer"> </span>нап&shy;ол&shy;не&shy;ния<span class="spacer"> </span>на&shy;до<span class="spacer"> </span>выч&shy;ис&shy;лять,<span class="spacer"> </span>где<span class="spacer"> </span>на&shy;ход&shy;ят&shy;ся<span class="spacer"> </span>все<span class="spacer"> </span>её<span class="spacer"> </span>ос&shy;тав&shy;ши&shy;е&shy;ся<span class="spacer"> </span>по&shy;ля.<span class="spacer"> </span>Но<span class="spacer"> </span>дав&shy;ай&shy;те<span class="spacer"> </span>не<span class="spacer"> </span>бу&shy;дем<span class="spacer"> </span>уны&shy;вать<span class="spacer"> </span>и<span class="spacer"> </span>по&shy;пы&shy;та&shy;ем&shy;ся<span class="spacer"> </span>сра&shy;зу<span class="spacer"> </span>по&shy;лу&shy;чить<span class="spacer"> </span>вы&shy;го&shy;ду<span class="spacer"> </span>из<span class="spacer"> </span>то&shy;го,<span class="spacer"> </span>что<span class="spacer"> </span>мы<span class="spacer"> </span>уже<span class="spacer"> </span>имеем:<span class="spacer"> </span>мы,<span class="spacer"> </span>по&shy;ка<span class="spacer"> </span>что,<span class="spacer"> </span>по&shy;ня&shy;тия<span class="spacer"> </span>не<span class="spacer"> </span>имеем,<span class="spacer"> </span>что<span class="spacer"> </span>име&shy;ется<span class="spacer"> </span>вви&shy;ду<span class="spacer"> </span>под<span class="spacer"> </span>дру&shy;ги&shy;ми<span class="spacer"> </span>по&shy;ля&shy;ми<span class="spacer"> </span>(раз&shy;ве<span class="spacer"> </span>что<span class="spacer"> </span>два<span class="spacer"> </span>пос&shy;лед&shy;них),<span class="spacer"> </span>за&shy;то<span class="spacer"> </span>по&shy;ле<span class="spacer"> </span><code>m_Base&shy;Size</code><span class="spacer"> </span>выг&shy;ля&shy;дит<span class="spacer"> </span>зам&shy;ан&shy;чи&shy;во.<span class="spacer"> </span>Как<span class="spacer"> </span>подс&shy;ка&shy;зы&shy;ва&shy;ет<span class="spacer"> </span>нам<span class="spacer"> </span>ком&shy;мен&shy;та&shy;рий,<span class="spacer"> </span>это<span class="spacer"> </span> &mdash; <span class="spacer"> </span>фак&shy;тич&shy;ес&shy;кий<span class="spacer"> </span>раз&shy;мер<span class="spacer"> </span>для<span class="spacer"> </span>эк&shy;земп&shy;ля&shy;ра<span class="spacer"> </span>ти&shy;па.<span class="spacer"> </span>Мы<span class="spacer"> </span>толь&shy;ко<span class="spacer"> </span>что<span class="spacer"> </span>наш&shy;ли<span class="spacer"> </span><code>sizeof</code><span class="spacer"> </span>для<span class="spacer"> </span>клас&shy;сов!<span class="spacer"> </span>Поп&shy;ро&shy;бу&shy;ем<span class="spacer"> </span>в<span class="spacer"> </span>бою?</p>
<div class="paragraph-right-side">06</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">07</div>
<p>Итак,<span class="spacer"> </span>что&shy;бы<span class="spacer"> </span>по&shy;лу&shy;чить<span class="spacer"> </span>ад&shy;рес<span class="spacer"> </span>VMT<span class="spacer"> </span>мы<span class="spacer"> </span>мо&shy;жем<span class="spacer"> </span>пой&shy;ти<span class="spacer"> </span>дву&shy;мя<span class="spacer"> </span>пу&shy;тя&shy;ми:<span class="spacer"> </span>ли&shy;бо<span class="spacer"> </span>слож&shy;ным,<span class="spacer"> </span>по&shy;лу&shy;чив<span class="spacer"> </span>ад&shy;рес<span class="spacer"> </span>объе&shy;кта,<span class="spacer"> </span>а<span class="spacer"> </span>зна&shy;чит<span class="spacer"> </span>и<span class="spacer"> </span>VMT:</p>
<div class="paragraph-right-side">07</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">class</span> Program
{
    <span style="color:Blue;">public</span> <span style="color:Blue;">static</span> <span style="color:Blue;">unsafe</span> <span style="color:Blue;">void</span> Main()
    {
        Union x = <span style="color:Blue;">new</span> Union();
        x.Reference.Value = <span style="color:#A31515;">&quot;Hello!&quot;</span>;

        <span style="color:Green;">// Первым полем лежит указатель на место, где лежит указатель на VMT</span>
        <span style="color:Green;">// - (IntPtr*)x.Value.Value - преобразовали число в указатель (сменили тип для компилятора)</span>
        <span style="color:Green;">// - *(IntPtr*)x.Value.Value - взяли по адресу объекта адрес VMT</span>
        <span style="color:Green;">// - (void *)*(IntPtr*)x.Value.Value - преобразовали в указатель</span>
        <span style="color:Blue;">void</span> *vmt = (<span style="color:Blue;">void</span> *)*(IntPtr*)x.Value.Value;

        <span style="color:Green;">// вывели в консоль адрес VMT;</span>
        Console.WriteLine((<span style="color:Blue;">ulong</span>)vmt);
    }

    [StructLayout(LayoutKind.Explicit)]
    <span style="color:Blue;">public</span> <span style="color:Blue;">class</span> Union
    {
        <span style="color:Blue;">public</span> Union()
        {
            Value = <span style="color:Blue;">new</span> Holder&lt;IntPtr&gt;();
            Reference = <span style="color:Blue;">new</span> Holder&lt;<span style="color:Blue;">object</span>&gt;();
        }

        [FieldOffset(0)]
        <span style="color:Blue;">public</span> Holder&lt;IntPtr&gt; Value;

        [FieldOffset(0)]
        <span style="color:Blue;">public</span> Holder&lt;<span style="color:Blue;">object</span>&gt; Reference;
    }

    <span style="color:Blue;">public</span> <span style="color:Blue;">class</span> Holder&lt;T&gt;
    {
        <span style="color:Blue;">public</span> T Value;
    }
}
</pre></div>
</div>
<p>Ли&shy;бо<span class="spacer"> </span>прос&shy;тым,<span class="spacer"> </span>ис&shy;поль&shy;зуя<span class="spacer"> </span>.NET<span class="spacer"> </span>FCL<span class="spacer"> </span>API:</p>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
    <span style="color:Blue;">var</span> vmt = <span style="color:Blue;">typeof</span>(<span style="color:Blue;">string</span>).TypeHandle.Value;
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">08</div>
<p>Вто&shy;рой<span class="spacer"> </span>путь,<span class="spacer"> </span>кон&shy;еч&shy;но<span class="spacer"> </span>же,<span class="spacer"> </span>про&shy;ще<span class="spacer"> </span>(хоть<span class="spacer"> </span>и<span class="spacer"> </span>доль&shy;ше<span class="spacer"> </span>ра&shy;бо&shy;та&shy;ет).<span class="spacer"> </span>Одна&shy;ко<span class="spacer"> </span>зна&shy;ние<span class="spacer"> </span>пер&shy;во&shy;го<span class="spacer"> </span>очень<span class="spacer"> </span>важ&shy;но<span class="spacer"> </span>с<span class="spacer"> </span>точ&shy;ки<span class="spacer"> </span>зре&shy;ния<span class="spacer"> </span>по&shy;ни&shy;ма&shy;ния<span class="spacer"> </span>струк&shy;ту&shy;ры<span class="spacer"> </span>эк&shy;земп&shy;ля&shy;ра<span class="spacer"> </span>ти&shy;па.<span class="spacer"> </span>Исполь&shy;зо&shy;ва&shy;ние<span class="spacer"> </span>вто&shy;ро&shy;го<span class="spacer"> </span>спо&shy;со&shy;ба<span class="spacer"> </span>доб&shy;ав&shy;ля&shy;ет<span class="spacer"> </span>чувство<span class="spacer"> </span>увер&shy;ен&shy;ности:<span class="spacer"> </span>ес&shy;ли<span class="spacer"> </span>мы<span class="spacer"> </span>вы&shy;зы&shy;ва&shy;ем<span class="spacer"> </span>ме&shy;тод<span class="spacer"> </span>API,<span class="spacer"> </span>то<span class="spacer"> </span>вро&shy;де<span class="spacer"> </span>как<span class="spacer"> </span>поль&shy;зу&shy;ем&shy;ся<span class="spacer"> </span>за&shy;до&shy;кум&shy;ен&shy;ти&shy;ров&shy;ан&shy;ным<span class="spacer"> </span>спо&shy;со&shy;бом<span class="spacer"> </span>ра&shy;бо&shy;ты<span class="spacer"> </span>с<span class="spacer"> </span>VMT,<span class="spacer"> </span>а<span class="spacer"> </span>ес&shy;ли<span class="spacer"> </span>дос&shy;таём<span class="spacer"> </span>че&shy;рез<span class="spacer"> </span>ука&shy;за&shy;тели,<span class="spacer"> </span>то<span class="spacer"> </span>нет.<span class="spacer"> </span>Одна&shy;ко<span class="spacer"> </span>не<span class="spacer"> </span>сто&shy;ит<span class="spacer"> </span>за&shy;бы&shy;вать,<span class="spacer"> </span>что<span class="spacer"> </span>хра&shy;не&shy;ние<span class="spacer"> </span><code>VMT<span class="spacer"> </span>*</code><span class="spacer"> </span> &mdash; <span class="spacer"> </span>стан&shy;дар&shy;т&shy;но<span class="spacer"> </span>для<span class="spacer"> </span>прак&shy;тич&shy;ес&shy;ки<span class="spacer"> </span>лю&shy;бо&shy;го<span class="spacer"> </span>ООП<span class="spacer"> </span>языка<span class="spacer"> </span>и<span class="spacer"> </span>для<span class="spacer"> </span>.NET<span class="spacer"> </span>плат&shy;фор&shy;мы<span class="spacer"> </span>в<span class="spacer"> </span>це&shy;лом:<span class="spacer"> </span>эта<span class="spacer"> </span>ссыл&shy;ка<span class="spacer"> </span>всег&shy;да<span class="spacer"> </span>на&shy;ход&shy;ит&shy;ся<span class="spacer"> </span>на<span class="spacer"> </span>од&shy;ном<span class="spacer"> </span>и<span class="spacer"> </span>том<span class="spacer"> </span>же<span class="spacer"> </span>мес&shy;те,<span class="spacer"> </span>как<span class="spacer"> </span>са&shy;мое<span class="spacer"> </span>час&shy;то<span class="spacer"> </span>ис&shy;поль&shy;зу&shy;е&shy;мое<span class="spacer"> </span>по&shy;ле<span class="spacer"> </span>клас&shy;са.<span class="spacer"> </span>А<span class="spacer"> </span>са&shy;мое<span class="spacer"> </span>час&shy;то<span class="spacer"> </span>ис&shy;поль&shy;зу&shy;е&shy;мое<span class="spacer"> </span>по&shy;ле<span class="spacer"> </span>клас&shy;са<span class="spacer"> </span>дол&shy;ж&shy;но<span class="spacer"> </span>ид&shy;ти<span class="spacer"> </span>пер&shy;вым,<span class="spacer"> </span>что&shy;бы<span class="spacer"> </span>ад&shy;ре&shy;са&shy;ция<span class="spacer"> </span>бы&shy;ла<span class="spacer"> </span>без<span class="spacer"> </span>сме&shy;ще&shy;ния<span class="spacer"> </span>и,<span class="spacer"> </span>как<span class="spacer"> </span>рез&shy;уль&shy;тат,<span class="spacer"> </span>бы&shy;ла<span class="spacer"> </span>быст&shy;рей.<span class="spacer"> </span>Отсю&shy;да<span class="spacer"> </span>де&shy;ла&shy;ем<span class="spacer"> </span>вы&shy;вод,<span class="spacer"> </span>что<span class="spacer"> </span>в<span class="spacer"> </span>слу&shy;чае<span class="spacer"> </span>клас&shy;сов<span class="spacer"> </span>по&shy;ло&shy;же&shy;ние<span class="spacer"> </span>по&shy;лей<span class="spacer"> </span>на<span class="spacer"> </span>ско&shy;рость<span class="spacer"> </span>вли&shy;ять<span class="spacer"> </span>не<span class="spacer"> </span>бу&shy;дет,<span class="spacer"> </span>а<span class="spacer"> </span>вот<span class="spacer"> </span>у<span class="spacer"> </span>струк&shy;тур<span class="spacer"> </span> &mdash; <span class="spacer"> </span>са&shy;мое<span class="spacer"> </span>час&shy;то<span class="spacer"> </span>ис&shy;поль&shy;зу&shy;е&shy;мое<span class="spacer"> </span>по&shy;ле<span class="spacer"> </span>мож&shy;но<span class="spacer"> </span>пос&shy;та&shy;вить<span class="spacer"> </span>пер&shy;вым.<span class="spacer"> </span>Хо&shy;тя,<span class="spacer"> </span>кон&shy;еч&shy;но<span class="spacer"> </span>же,<span class="spacer"> </span>для<span class="spacer"> </span>аб&shy;сол&shy;ют&shy;но&shy;го<span class="spacer"> </span>боль&shy;ш&shy;инства<span class="spacer"> </span>.NET<span class="spacer"> </span>при&shy;ло&shy;же&shy;ний<span class="spacer"> </span>это<span class="spacer"> </span>не<span class="spacer"> </span>даст<span class="spacer"> </span>во&shy;об&shy;ще<span class="spacer"> </span>ни&shy;ка&shy;ко&shy;го<span class="spacer"> </span>эф&shy;фек&shy;та:<span class="spacer"> </span>не<span class="spacer"> </span>для<span class="spacer"> </span>та&shy;ких<span class="spacer"> </span>за&shy;дач<span class="spacer"> </span>соз&shy;да&shy;ва&shy;лась<span class="spacer"> </span>эта<span class="spacer"> </span>плат&shy;фор&shy;ма.</p>
<div class="paragraph-right-side">08</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">09</div>
<p>Дав&shy;ай&shy;те<span class="spacer"> </span>изу&shy;чим<span class="spacer"> </span>воп&shy;рос<span class="spacer"> </span>струк&shy;ту&shy;ры<span class="spacer"> </span>ти&shy;пов<span class="spacer"> </span>с<span class="spacer"> </span>точ&shy;ки<span class="spacer"> </span>зре&shy;ния<span class="spacer"> </span>раз&shy;ме&shy;ра<span class="spacer"> </span>их<span class="spacer"> </span>эк&shy;земп&shy;ля&shy;ра.<span class="spacer"> </span>Нам<span class="spacer"> </span>же<span class="spacer"> </span>на&shy;до<span class="spacer"> </span>не<span class="spacer"> </span>прос&shy;то<span class="spacer"> </span>абст&shy;р&shy;актно<span class="spacer"> </span>изу&shy;чать<span class="spacer"> </span>их<span class="spacer"> </span>(это<span class="spacer"> </span>прос&shy;то-нап&shy;рос&shy;то<span class="spacer"> </span>скуч&shy;но),<span class="spacer"> </span>но<span class="spacer"> </span>доп&shy;ол&shy;нит&shy;ель&shy;но<span class="spacer"> </span>поп&shy;ро&shy;бу&shy;ем<span class="spacer"> </span>из&shy;в&shy;лечь<span class="spacer"> </span>из<span class="spacer"> </span>этого<span class="spacer"> </span>та&shy;кую<span class="spacer"> </span>вы&shy;го&shy;ду,<span class="spacer"> </span>ка&shy;кую<span class="spacer"> </span>не<span class="spacer"> </span>из&shy;в&shy;лечь<span class="spacer"> </span>обыч&shy;ным<span class="spacer"> </span>спо&shy;со&shy;бом.</p>
<div class="paragraph-right-side">09</div>
</div>
<blockquote>
<h5 id="sizeof-value-type-reference-type">По&shy;че&shy;му<span class="spacer"> </span>sizeof<span class="spacer"> </span>есть<span class="spacer"> </span>для<span class="spacer"> </span>Value<span class="spacer"> </span>Type&shy;,<span class="spacer"> </span>но<span class="spacer"> </span>нет<span class="spacer"> </span>для<span class="spacer"> </span>Refer&shy;ence<span class="spacer"> </span>Type&shy;?</h5>
<p>На<span class="spacer"> </span>са&shy;мом<span class="spacer"> </span>де&shy;ле<span class="spacer"> </span>воп&shy;рос,<span class="spacer"> </span>от&shy;кры&shy;тый<span class="spacer"> </span>т.к.<span class="spacer"> </span>ник&shy;то<span class="spacer"> </span>не<span class="spacer"> </span>ме&shy;ша&shy;ет<span class="spacer"> </span>расс&shy;чи&shy;тать<span class="spacer"> </span>раз&shy;мер<span class="spacer"> </span>ссы&shy;лоч&shy;но&shy;го<span class="spacer"> </span>ти&shy;па.<span class="spacer"> </span>Един&shy;ствен&shy;ное<span class="spacer"> </span>обо<span class="spacer"> </span>что<span class="spacer"> </span>мож&shy;но<span class="spacer"> </span>спотк&shy;нуться<span class="spacer"> </span> &mdash; <span class="spacer"> </span>это<span class="spacer"> </span>не<span class="spacer"> </span>фик&shy;си&shy;ров&shy;ан&shy;ный<span class="spacer"> </span>раз&shy;мер<span class="spacer"> </span>двух<span class="spacer"> </span>ссы&shy;лоч&shy;ных<span class="spacer"> </span>ти&shy;пов:<span class="spacer"> </span><code>Array</code><span class="spacer"> </span>и<span class="spacer"> </span><code>String</code>.<span class="spacer"> </span>А<span class="spacer"> </span>так&shy;же<span class="spacer"> </span><code>Generic</code><span class="spacer"> </span>груп&shy;пы,<span class="spacer"> </span>ко&shy;то&shy;рая<span class="spacer"> </span>за&shy;ви&shy;сит<span class="spacer"> </span>це&shy;ли&shy;ком<span class="spacer"> </span>и<span class="spacer"> </span>пол&shy;нос&shy;тью<span class="spacer"> </span>от<span class="spacer"> </span>конк&shy;рет&shy;ных<span class="spacer"> </span>ва&shy;ри&shy;ан&shy;тов.<span class="spacer"> </span>Т.е.<span class="spacer"> </span>опе&shy;ра&shy;то&shy;ром<span class="spacer"> </span><code>sizeof(..)</code><span class="spacer"> </span>мы<span class="spacer"> </span>обой&shy;тись<span class="spacer"> </span>не<span class="spacer"> </span>смог&shy;ли<span class="spacer"> </span>бы:<span class="spacer"> </span>не&shy;об&shy;хо&shy;ди&shy;мо<span class="spacer"> </span>ра&shy;бо&shy;тать<span class="spacer"> </span>с<span class="spacer"> </span>конк&shy;рет&shy;ны&shy;ми<span class="spacer"> </span>эк&shy;земп&shy;ля&shy;ра&shy;ми.<span class="spacer"> </span>Одна&shy;ко<span class="spacer"> </span>ник&shy;то<span class="spacer"> </span>не<span class="spacer"> </span>ме&shy;ша&shy;ет<span class="spacer"> </span>ком&shy;ан&shy;де<span class="spacer"> </span>CLR<span class="spacer"> </span>сде&shy;лать<span class="spacer"> </span>ме&shy;тод<span class="spacer"> </span>ви&shy;да<span class="spacer"> </span><code>sta&shy;tic<span class="spacer"> </span>int<span class="spacer"> </span>System&shy;.Object&shy;.Size&shy;Of&shy;(object<span class="spacer"> </span>obj)</code>,<span class="spacer"> </span>ко&shy;то&shy;рый<span class="spacer"> </span>бы<span class="spacer"> </span>лег&shy;ко<span class="spacer"> </span>и<span class="spacer"> </span>прос&shy;то<span class="spacer"> </span>возв&shy;ра&shy;щал<span class="spacer"> </span>бы<span class="spacer"> </span>нам<span class="spacer"> </span>то,<span class="spacer"> </span>что<span class="spacer"> </span>на&shy;до.<span class="spacer"> </span>Так<span class="spacer"> </span>по&shy;че&shy;му<span class="spacer"> </span>же<span class="spacer"> </span>Microsoft<span class="spacer"> </span>не<span class="spacer"> </span>ре&shy;а&shy;ли&shy;зо&shy;ва&shy;ла<span class="spacer"> </span>этот<span class="spacer"> </span>ме&shy;тод?<span class="spacer"> </span>Есть<span class="spacer"> </span>мысль,<span class="spacer"> </span>что<span class="spacer"> </span>плат&shy;фор&shy;ма<span class="spacer"> </span>.NET<span class="spacer"> </span>в<span class="spacer"> </span>их<span class="spacer"> </span>по&shy;ни&shy;ма&shy;нии<span class="spacer"> </span>опять<span class="spacer"> </span>же<span class="spacer"> </span> &mdash; <span class="spacer"> </span>не<span class="spacer"> </span>та<span class="spacer"> </span>плат&shy;фор&shy;ма,<span class="spacer"> </span>где<span class="spacer"> </span>раз&shy;раб&shy;от&shy;чик<span class="spacer"> </span>бу&shy;дет<span class="spacer"> </span>силь&shy;но<span class="spacer"> </span>пе&shy;ре&shy;жи&shy;вать<span class="spacer"> </span>за<span class="spacer"> </span>конк&shy;рет&shy;ные<span class="spacer"> </span>бай&shy;ты.<span class="spacer"> </span>В<span class="spacer"> </span>слу&shy;чае<span class="spacer"> </span>че&shy;го<span class="spacer"> </span>мож&shy;но<span class="spacer"> </span>прос&shy;то<span class="spacer"> </span>дос&shy;та&shy;вить<span class="spacer"> </span>пла&shy;нок<span class="spacer"> </span>в<span class="spacer"> </span>ма&shy;тер&shy;ин&shy;с&shy;кую<span class="spacer"> </span>пла&shy;ту.<span class="spacer"> </span>Тем<span class="spacer"> </span>бо&shy;лее<span class="spacer"> </span>что<span class="spacer"> </span>боль&shy;ш&shy;инство<span class="spacer"> </span>ти&shy;пов<span class="spacer"> </span>дан&shy;ных,<span class="spacer"> </span>ко&shy;то&shy;рые<span class="spacer"> </span>мы<span class="spacer"> </span>ре&shy;а&shy;ли&shy;зу&shy;ем,<span class="spacer"> </span>не<span class="spacer"> </span>за&shy;ни&shy;ма&shy;ют<span class="spacer"> </span>та&shy;кие<span class="spacer"> </span>боль&shy;шие<span class="spacer"> </span>объёмы.</p>
</blockquote>
<div class="paragraph-container">
<div class="paragraph-left-side">10</div>
<p>Но<span class="spacer"> </span>не<span class="spacer"> </span>бу&shy;дем<span class="spacer"> </span>от&shy;вле&shy;кать&shy;ся.<span class="spacer"> </span>Итак,<span class="spacer"> </span>что&shy;бы<span class="spacer"> </span>по&shy;лу&shy;чить<span class="spacer"> </span>раз&shy;мер<span class="spacer"> </span>эк&shy;земп&shy;ля&shy;ра<span class="spacer"> </span>клас&shy;са,<span class="spacer"> </span>чей<span class="spacer"> </span>раз&shy;мер<span class="spacer"> </span>фик&shy;си&shy;ро&shy;ван,<span class="spacer"> </span>дос&shy;тат&shy;оч&shy;но<span class="spacer"> </span>на&shy;пи&shy;сать<span class="spacer"> </span>сле&shy;ду&shy;ю&shy;щий<span class="spacer"> </span>код:</p>
<div class="paragraph-right-side">10</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">unsafe</span> <span style="color:Blue;">int</span> SizeOf(Type type)
{
    MethodTable *pvmt = (MethodTable *)type.TypeHandle.Value.ToPointer();
    <span style="color:Blue;">return</span> pvmt-&gt;Size;
}

[StructLayout(LayoutKind.Explicit)]
<span style="color:Blue;">public</span> <span style="color:Blue;">struct</span> MethodTable
{
    [FieldOffset(4)]
    <span style="color:Blue;">public</span> <span style="color:Blue;">int</span> Size;
}

<span style="color:Blue;">class</span> Sample
{
    <span style="color:Blue;">int</span> x;
}

<span style="color:Green;">// ...</span>

Console.WriteLine(SizeOf(<span style="color:Blue;">typeof</span>(Sample)));
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">11</div>
<p>Итак,<span class="spacer"> </span>что<span class="spacer"> </span>мы<span class="spacer"> </span>толь&shy;ко<span class="spacer"> </span>что<span class="spacer"> </span>сде&shy;ла&shy;ли?<span class="spacer"> </span>Пер&shy;вым<span class="spacer"> </span>ша&shy;гом<span class="spacer"> </span>мы<span class="spacer"> </span>по&shy;лу&shy;чи&shy;ли<span class="spacer"> </span>ука&shy;за&shy;тель<span class="spacer"> </span>на<span class="spacer"> </span>таб&shy;ли&shy;цу<span class="spacer"> </span>вир&shy;ту&shy;аль&shy;ных<span class="spacer"> </span>ме&shy;то&shy;дов.<span class="spacer"> </span>Пос&shy;ле<span class="spacer"> </span>че&shy;го<span class="spacer"> </span>мы<span class="spacer"> </span>счи&shy;ты&shy;ва&shy;ем<span class="spacer"> </span>раз&shy;мер<span class="spacer"> </span>и<span class="spacer"> </span>по&shy;лу&shy;ча&shy;ем<span class="spacer"> </span><code>12</code><span class="spacer"> </span> &mdash; <span class="spacer"> </span>это<span class="spacer"> </span>сум&shy;ма<span class="spacer"> </span>раз&shy;ме&shy;ров<span class="spacer"> </span>по&shy;лей<span class="spacer"> </span><code>Sync&shy;Block&shy;Index<span class="spacer"> </span>+<span class="spacer"> </span>VMT_Ptr<span class="spacer"> </span>+<span class="spacer"> </span>по&shy;ле<span class="spacer"> </span>x</code><span class="spacer"> </span>для<span class="spacer"> </span>32-раз&shy;ряд&shy;ной<span class="spacer"> </span>плат&shy;фор&shy;мы.<span class="spacer"> </span>Если<span class="spacer"> </span>мы<span class="spacer"> </span>по&shy;иг&shy;ра&shy;ем&shy;ся<span class="spacer"> </span>с<span class="spacer"> </span>раз&shy;ны&shy;ми<span class="spacer"> </span>ти&shy;па&shy;ми,<span class="spacer"> </span>то<span class="spacer"> </span>по&shy;лу&shy;чим<span class="spacer"> </span>при&shy;мер&shy;но<span class="spacer"> </span>сле&shy;ду&shy;ю&shy;щую<span class="spacer"> </span>таб&shy;ли&shy;цу<span class="spacer"> </span>для<span class="spacer"> </span>x86:</p>
<div class="paragraph-right-side">11</div>
</div>
<div class="table-container">
<div class="table-width-10 table-cols-3">
<table>
<thead>
<tr>
<th>Тип<span class="spacer"> </span>или<span class="spacer"> </span>его<span class="spacer"> </span>оп&shy;ре&shy;де&shy;ле&shy;ние</th>
<th>Раз&shy;мер</th>
<th>Ком&shy;мен&shy;та&shy;рий</th>
</tr>
</thead>
<tbody>
<tr>
<td>Object</td>
<td>12</td>
<td>Sync&shy;Blk<span class="spacer"> </span>+<span class="spacer"> </span>VMT<span class="spacer"> </span>+<span class="spacer"> </span>пус&shy;тое<span class="spacer"> </span>по&shy;ле</td>
</tr>
<tr>
<td>Int16</td>
<td>12</td>
<td>Boxed<span class="spacer"> </span>Int16:<span class="spacer"> </span>Sync&shy;Blk<span class="spacer"> </span>+<span class="spacer"> </span>VMT<span class="spacer"> </span>+<span class="spacer"> </span>дан&shy;ные<span class="spacer"> </span>(выр&shy;ов&shy;не&shy;но<span class="spacer"> </span>по<span class="spacer"> </span>4<span class="spacer"> </span>бай&shy;та)</td>
</tr>
<tr>
<td>Int32</td>
<td>12</td>
<td>Boxed<span class="spacer"> </span>Int32:<span class="spacer"> </span>Sync&shy;Blk<span class="spacer"> </span>+<span class="spacer"> </span>VMT<span class="spacer"> </span>+<span class="spacer"> </span>дан&shy;ные</td>
</tr>
<tr>
<td>Int64</td>
<td>16</td>
<td>Boxed<span class="spacer"> </span>Int64:<span class="spacer"> </span>Sync&shy;Blk<span class="spacer"> </span>+<span class="spacer"> </span>VMT<span class="spacer"> </span>+<span class="spacer"> </span>дан&shy;ные</td>
</tr>
<tr>
<td>Char</td>
<td>12</td>
<td>Boxed<span class="spacer"> </span>Char&shy;:<span class="spacer"> </span>Sync&shy;Blk<span class="spacer"> </span>+<span class="spacer"> </span>VMT<span class="spacer"> </span>+<span class="spacer"> </span>дан&shy;ные<span class="spacer"> </span>(выр&shy;ов&shy;не&shy;но<span class="spacer"> </span>по<span class="spacer"> </span>4<span class="spacer"> </span>бай&shy;та)</td>
</tr>
<tr>
<td>Double</td>
<td>16</td>
<td>Boxed<span class="spacer"> </span>Double&shy;:<span class="spacer"> </span>Sync&shy;Blk<span class="spacer"> </span>+<span class="spacer"> </span>VMT<span class="spacer"> </span>+<span class="spacer"> </span>дан&shy;ные</td>
</tr>
<tr>
<td>IEnumer&shy;able</td>
<td>0</td>
<td>Интер&shy;фейс<span class="spacer"> </span>не<span class="spacer"> </span>имеет<span class="spacer"> </span>раз&shy;ме&shy;ра:<span class="spacer"> </span>на&shy;до<span class="spacer"> </span>брать<span class="spacer"> </span>obj.Get&shy;Type&shy;()</td>
</tr>
<tr>
<td>List<T></td>
<td>24</td>
<td>Не<span class="spacer"> </span>важ&shy;но<span class="spacer"> </span>сколь&shy;ко<span class="spacer"> </span>элем&shy;ен&shy;тов<span class="spacer"> </span>в<span class="spacer"> </span>List<T>,<span class="spacer"> </span>за&shy;ни&shy;мать<span class="spacer"> </span>он<span class="spacer"> </span>бу&shy;дет<span class="spacer"> </span>оди&shy;на&shy;ково<span class="spacer"> </span>т.к.<span class="spacer"> </span>хра&shy;нит<span class="spacer"> </span>дан&shy;ные<span class="spacer"> </span>он<span class="spacer"> </span>в<span class="spacer"> </span>array,<span class="spacer"> </span>ко&shy;то&shy;рый<span class="spacer"> </span>не<span class="spacer"> </span>учи&shy;ты&shy;ва&shy;ется</td>
</tr>
<tr>
<td>Generic&shy;Sample<int></td>
<td>12</td>
<td>Как<span class="spacer"> </span>ви&shy;ди&shy;те,<span class="spacer"> </span>generics<span class="spacer"> </span>прек&shy;рас&shy;но<span class="spacer"> </span>счи&shy;та&shy;ют&shy;ся.<span class="spacer"> </span>Раз&shy;мер<span class="spacer"> </span>не<span class="spacer"> </span>по&shy;мен&shy;ял&shy;ся,<span class="spacer"> </span>т.к.<span class="spacer"> </span>дан&shy;ные<span class="spacer"> </span>на&shy;ход&shy;ят&shy;ся<span class="spacer"> </span>на<span class="spacer"> </span>том<span class="spacer"> </span>же<span class="spacer"> </span>мес&shy;те,<span class="spacer"> </span>что<span class="spacer"> </span>и<span class="spacer"> </span>у<span class="spacer"> </span>boxed<span class="spacer"> </span>int.<span class="spacer"> </span>Итог:<span class="spacer"> </span>Sync&shy;Blk<span class="spacer"> </span>+<span class="spacer"> </span>VMT<span class="spacer"> </span>+<span class="spacer"> </span>дан&shy;ные</td>
</tr>
<tr>
<td>Generic&shy;Sample<Int64></td>
<td>16</td>
<td>Ана&shy;лог&shy;ич&shy;но</td>
</tr>
<tr>
<td>Generic&shy;Sample<IEnumerable&shy;></td>
<td>12</td>
<td>Ана&shy;лог&shy;ич&shy;но</td>
</tr>
<tr>
<td>Generic&shy;Sample<Date&shy;Time&shy;></td>
<td>16</td>
<td>Ана&shy;лог&shy;ич&shy;но</td>
</tr>
<tr>
<td>string</td>
<td>14</td>
<td>Это<span class="spacer"> </span>зна&shy;че&shy;ние<span class="spacer"> </span>бу&shy;дет<span class="spacer"> </span>возв&shy;ра&shy;ще&shy;но<span class="spacer"> </span>для<span class="spacer"> </span>лю&shy;бой<span class="spacer"> </span>стро&shy;ки,<span class="spacer"> </span>т.к.<span class="spacer"> </span>ре&shy;аль&shy;ный<span class="spacer"> </span>раз&shy;мер<span class="spacer"> </span>дол&shy;жен<span class="spacer"> </span>счи&shy;тать&shy;ся<span class="spacer"> </span>ди&shy;на&shy;мич&shy;ес&shy;ки.<span class="spacer"> </span>Одна&shy;ко<span class="spacer"> </span>он<span class="spacer"> </span>под&shy;хо&shy;дит<span class="spacer"> </span>для<span class="spacer"> </span>раз&shy;ме&shy;ра<span class="spacer"> </span>под<span class="spacer"> </span>пус&shy;тую<span class="spacer"> </span>стро&shy;ку.<span class="spacer"> </span>Про&shy;шу<span class="spacer"> </span>за&shy;ме&shy;тить,<span class="spacer"> </span>что<span class="spacer"> </span>раз&shy;мер<span class="spacer"> </span>не<span class="spacer"> </span>выр&shy;ов&shy;нен<span class="spacer"> </span>по<span class="spacer"> </span>раз&shy;ряд&shy;нос&shy;ти:<span class="spacer"> </span>по<span class="spacer"> </span>су&shy;ти,<span class="spacer"> </span>это<span class="spacer"> </span>по&shy;ле<span class="spacer"> </span>ис&shy;поль&shy;зов&shy;ать&shy;ся<span class="spacer"> </span>не<span class="spacer"> </span>дол&shy;ж&shy;но</td>
</tr>
<tr>
<td>int[]{1}</td>
<td>24554</td>
<td>Для<span class="spacer"> </span>мас&shy;си&shy;вов<span class="spacer"> </span>в<span class="spacer"> </span>дан&shy;ном<span class="spacer"> </span>мес&shy;те<span class="spacer"> </span>ле&shy;жат<span class="spacer"> </span>сов&shy;сем<span class="spacer"> </span>дру&shy;гие<span class="spacer"> </span>дан&shy;ные,<span class="spacer"> </span>так&shy;же<span class="spacer"> </span>их<span class="spacer"> </span>раз&shy;мер<span class="spacer"> </span>не<span class="spacer"> </span>яв&shy;ля&shy;ет&shy;ся<span class="spacer"> </span>фик&shy;си&shy;ров&shy;ан&shy;ным,<span class="spacer"> </span>по&shy;то&shy;му<span class="spacer"> </span>его<span class="spacer"> </span>не&shy;об&shy;хо&shy;ди&shy;мо<span class="spacer"> </span>счи&shy;тать<span class="spacer"> </span>от&shy;дель&shy;но</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">12</div>
<p>Как<span class="spacer"> </span>ви&shy;ди&shy;те,<span class="spacer"> </span>ког&shy;да<span class="spacer"> </span>сис&shy;те&shy;ма<span class="spacer"> </span>хра&shy;нит<span class="spacer"> </span>дан&shy;ные<span class="spacer"> </span>о<span class="spacer"> </span>раз&shy;ме&shy;ре<span class="spacer"> </span>эк&shy;земп&shy;ля&shy;ра<span class="spacer"> </span>ти&shy;па,<span class="spacer"> </span>то<span class="spacer"> </span>она<span class="spacer"> </span>фак&shy;тич&shy;ес&shy;ки<span class="spacer"> </span>хра&shy;нит<span class="spacer"> </span>дан&shy;ные<span class="spacer"> </span>для<span class="spacer"> </span>ссы&shy;лоч&shy;но&shy;го<span class="spacer"> </span>ви&shy;да<span class="spacer"> </span>этого<span class="spacer"> </span>ти&shy;па<span class="spacer"> </span>(т.е.<span class="spacer"> </span>в<span class="spacer"> </span>том<span class="spacer"> </span>чис&shy;ле<span class="spacer"> </span>для<span class="spacer"> </span>ссы&shy;лоч&shy;но&shy;го<span class="spacer"> </span>ва&shy;ри&shy;ан&shy;та<span class="spacer"> </span>зна&shy;чи&shy;мо&shy;го).<span class="spacer"> </span>Дав&shy;ай&shy;те<span class="spacer"> </span>сде&shy;ла&shy;ем<span class="spacer"> </span>не&shy;ко&shy;то&shy;рые<span class="spacer"> </span>вы&shy;во&shy;ды:</p>
<div class="paragraph-right-side">12</div>
</div>
<ol>
<li>Если<span class="spacer"> </span>вы<span class="spacer"> </span>хо&shy;ти&shy;те<span class="spacer"> </span>знать,<span class="spacer"> </span>сколь&shy;ко<span class="spacer"> </span>займёт<span class="spacer"> </span>зна&shy;чи&shy;мый<span class="spacer"> </span>тип<span class="spacer"> </span>как<span class="spacer"> </span>зна&shy;че&shy;ние,<span class="spacer"> </span>ис&shy;поль&shy;зуй&shy;те<span class="spacer"> </span><code>sizeof(TType&shy;)</code></li>
<li>Если<span class="spacer"> </span>вы<span class="spacer"> </span>хо&shy;ти&shy;те<span class="spacer"> </span>расс&shy;чи&shy;тать,<span class="spacer"> </span>че&shy;го<span class="spacer"> </span>вам<span class="spacer"> </span>бу&shy;дет<span class="spacer"> </span>сто&shy;ить<span class="spacer"> </span>бок&shy;синг,<span class="spacer"> </span>то<span class="spacer"> </span>вы<span class="spacer"> </span>мо&shy;же&shy;те<span class="spacer"> </span>ок&shy;руг&shy;лить<span class="spacer"> </span><code>sizeof(TType&shy;)</code><span class="spacer"> </span>в<span class="spacer"> </span>боль&shy;шую<span class="spacer"> </span>сто&shy;ро&shy;ну<span class="spacer"> </span>до<span class="spacer"> </span>раз&shy;ме&shy;ра<span class="spacer"> </span>сло&shy;ва<span class="spacer"> </span>про&shy;цес&shy;со&shy;ра<span class="spacer"> </span>(4<span class="spacer"> </span>или<span class="spacer"> </span>8<span class="spacer"> </span>байт)<span class="spacer"> </span>и<span class="spacer"> </span>при&shy;ба&shy;вить<span class="spacer"> </span>ещё<span class="spacer"> </span>2<span class="spacer"> </span>сло&shy;ва<span class="spacer"> </span>(<code>2<span class="spacer"> </span>*<span class="spacer"> </span>sizeof(Int&shy;Ptr&shy;)</code>).<span class="spacer"> </span>Или<span class="spacer"> </span>же<span class="spacer"> </span>взять<span class="spacer"> </span>это<span class="spacer"> </span>зна&shy;че&shy;ние<span class="spacer"> </span>из<span class="spacer"> </span><code>VMT</code><span class="spacer"> </span>ти&shy;па.</li>
<li>Расчёт<span class="spacer"> </span>вы&shy;дел&shy;ен&shy;но&shy;го<span class="spacer"> </span>объем<span class="spacer"> </span>па&shy;мя&shy;ти<span class="spacer"> </span>в<span class="spacer"> </span>ку&shy;че<span class="spacer"> </span>предс&shy;тав&shy;лен<span class="spacer"> </span>для<span class="spacer"> </span>сле&shy;ду&shy;ю&shy;щих<span class="spacer"> </span>ти&shy;пов:
<ol>
<li>Обыч&shy;ный<span class="spacer"> </span>ссы&shy;лоч&shy;ный<span class="spacer"> </span>тип<span class="spacer"> </span>фик&shy;си&shy;ров&shy;ан&shy;но&shy;го<span class="spacer"> </span>раз&shy;ме&shy;ра:<span class="spacer"> </span>мы<span class="spacer"> </span>мо&shy;жем<span class="spacer"> </span>заб&shy;рать<span class="spacer"> </span>раз&shy;мер<span class="spacer"> </span>эк&shy;земп&shy;ля&shy;ра<span class="spacer"> </span>из<span class="spacer"> </span><code>VMT</code>;</li>
<li>Cтро&shy;ка,<span class="spacer"> </span>не&shy;об&shy;хо&shy;ди&shy;мо<span class="spacer"> </span>вруч&shy;ную<span class="spacer"> </span>счи&shy;тать<span class="spacer"> </span>её<span class="spacer"> </span>раз&shy;мер<span class="spacer"> </span>(это<span class="spacer"> </span>во&shy;об&shy;ще<span class="spacer"> </span>ред&shy;ко<span class="spacer"> </span>ког&shy;да<span class="spacer"> </span>мо&shy;жет<span class="spacer"> </span>по&shy;на&shy;доб&shy;ить&shy;ся,<span class="spacer"> </span>но,<span class="spacer"> </span>сог&shy;ла&shy;си&shy;тесь,<span class="spacer"> </span>ин&shy;тер&shy;ес&shy;но)</li>
<li>Мас&shy;сив,<span class="spacer"> </span>то<span class="spacer"> </span>его<span class="spacer"> </span>раз&shy;мер<span class="spacer"> </span>так&shy;же<span class="spacer"> </span>расс&shy;чи&shy;ты&shy;ва&shy;ет&shy;ся<span class="spacer"> </span>от&shy;дель&shy;но:<span class="spacer"> </span>на<span class="spacer"> </span>ос&shy;но&shy;ва&shy;нии<span class="spacer"> </span>раз&shy;ме&shy;ра<span class="spacer"> </span>его<span class="spacer"> </span>элем&shy;ен&shy;тов<span class="spacer"> </span>и<span class="spacer"> </span>их<span class="spacer"> </span>ко&shy;лич&shy;ес&shy;т&shy;ва.<span class="spacer"> </span>Эта<span class="spacer"> </span>зад&shy;ач&shy;ка<span class="spacer"> </span>мо&shy;жет<span class="spacer"> </span>оказ&shy;аться<span class="spacer"> </span>ку&shy;да<span class="spacer"> </span>бо&shy;лее<span class="spacer"> </span>пол&shy;ез&shy;ной:<span class="spacer"> </span>ведь<span class="spacer"> </span>именно<span class="spacer"> </span>мас&shy;си&shy;вы<span class="spacer"> </span>пер&shy;вые<span class="spacer"> </span>в<span class="spacer"> </span>оче&shy;реди<span class="spacer"> </span>на<span class="spacer"> </span>по&shy;па&shy;да&shy;ние<span class="spacer"> </span>в<span class="spacer"> </span><code>LOH</code></li>
</ol>
</li>
</ol>
<h3 id="system.string">System&shy;.String</h3>
<div class="paragraph-container">
<div class="paragraph-left-side">13</div>
<p>Про<span class="spacer"> </span>стро&shy;ки<span class="spacer"> </span>в<span class="spacer"> </span>воп&shy;ро&shy;сах<span class="spacer"> </span>прак&shy;ти&shy;ки<span class="spacer"> </span>мы<span class="spacer"> </span>по&shy;го&shy;во&shy;рим<span class="spacer"> </span>от&shy;дель&shy;но:<span class="spacer"> </span>этому,<span class="spacer"> </span>от&shy;но&shy;сит&shy;ель&shy;но<span class="spacer"> </span>неб&shy;оль&shy;шо&shy;му,<span class="spacer"> </span>клас&shy;су<span class="spacer"> </span>мож&shy;но<span class="spacer"> </span>вы&shy;де&shy;лить<span class="spacer"> </span>це&shy;лую<span class="spacer"> </span>гла&shy;ву.<span class="spacer"> </span>А<span class="spacer"> </span>в<span class="spacer"> </span>рам&shy;ках<span class="spacer"> </span>гла&shy;вы<span class="spacer"> </span>про<span class="spacer"> </span>стр&shy;о&shy;ение<span class="spacer"> </span>VMT<span class="spacer"> </span>мы<span class="spacer"> </span>по&shy;го&shy;во&shy;рим<span class="spacer"> </span>про<span class="spacer"> </span>стр&shy;о&shy;ение<span class="spacer"> </span>строк<span class="spacer"> </span>на<span class="spacer"> </span>низ&shy;ком<span class="spacer"> </span>уровне.<span class="spacer"> </span>Для<span class="spacer"> </span>хра&shy;не&shy;ния<span class="spacer"> </span>строк<span class="spacer"> </span>при&shy;ме&shy;ня&shy;ет&shy;ся<span class="spacer"> </span>стан&shy;дарт<span class="spacer"> </span>UTF16.<span class="spacer"> </span>Это<span class="spacer"> </span>зна&shy;чит,<span class="spacer"> </span>что<span class="spacer"> </span>каж&shy;дый<span class="spacer"> </span>сим&shy;вол<span class="spacer"> </span>за&shy;ни&shy;ма&shy;ет<span class="spacer"> </span>2<span class="spacer"> </span>бай&shy;та.<span class="spacer"> </span>Доп&shy;ол&shy;нит&shy;ель&shy;но<span class="spacer"> </span>в<span class="spacer"> </span>кон&shy;це<span class="spacer"> </span>каж&shy;дой<span class="spacer"> </span>стро&shy;ки<span class="spacer"> </span>хра&shy;нит&shy;ся<span class="spacer"> </span>null-тер&shy;ми&shy;на&shy;тор<span class="spacer"> </span>–<span class="spacer"> </span>зна&shy;че&shy;ние,<span class="spacer"> </span>ко&shy;то&shy;рое<span class="spacer"> </span>иден&shy;ти&shy;фи&shy;ци&shy;рует<span class="spacer"> </span>окон&shy;ча&shy;ние<span class="spacer"> </span>стро&shy;ки.<span class="spacer"> </span>Так&shy;же<span class="spacer"> </span>в<span class="spacer"> </span>эк&shy;земп&shy;ля&shy;ре<span class="spacer"> </span>хра&shy;нит&shy;ся<span class="spacer"> </span>дли&shy;на<span class="spacer"> </span>стро&shy;ки<span class="spacer"> </span>в<span class="spacer"> </span>ви&shy;де<span class="spacer"> </span><code>Int32</code><span class="spacer"> </span>чис&shy;ла<span class="spacer"> </span> &mdash; <span class="spacer"> </span>что&shy;бы<span class="spacer"> </span>не<span class="spacer"> </span>счи&shy;тать<span class="spacer"> </span>дли&shy;ну<span class="spacer"> </span>каж&shy;дый<span class="spacer"> </span>раз,<span class="spacer"> </span>ког&shy;да<span class="spacer"> </span>она<span class="spacer"> </span>по&shy;на&shy;доб&shy;ит&shy;ся<span class="spacer"> </span>(про<span class="spacer"> </span>ко&shy;дир&shy;ов&shy;ки<span class="spacer"> </span>мы<span class="spacer"> </span>по&shy;го&shy;во&shy;рим<span class="spacer"> </span>от&shy;дель&shy;но).<span class="spacer"> </span>На<span class="spacer"> </span>схе&shy;ме<span class="spacer"> </span>ни&shy;же<span class="spacer"> </span>предс&shy;тав&shy;лена<span class="spacer"> </span>ин&shy;фор&shy;ма&shy;ция<span class="spacer"> </span>о<span class="spacer"> </span>за&shy;ни&shy;ма&shy;е&shy;мой<span class="spacer"> </span>па&shy;мя&shy;ти<span class="spacer"> </span>стро&shy;кой:</p>
<div class="paragraph-right-side">13</div>
</div>
<pre><code>  // Для .NET Framework 3.5 и младше
  ----------------------------------------------------------------------------------------------------
  |  SyncBlkIndx |    VMTPtr     |  ArrayLength   |     Length     |   char   |   char   |   Term    |
  ----------------------------------------------------------------------------------------------------
  |  4 / 8 байт  |  4 / 8 байт   |    4 байта     |    4 байта     |  2 байта |  2 байта |  2 байта  |
  ----------------------------------------------------------------------------------------------------
  |      -1      |  0xXXXXXXXX   |        3       |        2       |     a    |     b    |   &lt;nil&gt;   |
  ----------------------------------------------------------------------------------------------------

  Term – null terminator
  Sum size = (8|16) + 2 * 4 + Count * 2 + 2 -&gt; округлить в большую сторону по разрядности. (24 байта в примере)
  Count – количество символов в строке, не считая терминальный
  
  // Для .NET Framework 4 и старше
  -----------------------------------------------------------------------------------
  |  SyncBlkIndx |    VMTPtr     |     Length     |   char   |   char   |   Term    |
  -----------------------------------------------------------------------------------
  |  4 / 8 байт  |  4 / 8 байт   |    4 байта     |  2 байта |  2 байта |  2 байта  |
  -----------------------------------------------------------------------------------
  |      -1      |  0xXXXXXXXX   |        2       |     a    |     b    |   &lt;nil&gt;   |
  -----------------------------------------------------------------------------------
  Term - null terminator
  Sum size = (8|16) + 4 + Count * 2 + 2) -&gt; округлить в большую сторону по разрядности. (20 байт в примере)
  Count – количество символов в строке, не считая терминальный
</code></pre>
<p>Пе&shy;ре&shy;пи&shy;шем<span class="spacer"> </span>наш<span class="spacer"> </span>ме&shy;тод,<span class="spacer"> </span>что&shy;бы<span class="spacer"> </span>на&shy;у&shy;чить<span class="spacer"> </span>его<span class="spacer"> </span>счи&shy;тать<span class="spacer"> </span>раз&shy;мер<span class="spacer"> </span>строк:</p>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">unsafe</span> <span style="color:Blue;">int</span> SizeOf(<span style="color:Blue;">object</span> obj)
{
   <span style="color:Blue;">var</span> majorNetVersion = Environment.Version.Major;
   <span style="color:Blue;">var</span> type = obj.GetType();
   <span style="color:Blue;">var</span> href = Union.GetRef(obj).ToInt64();
   <span style="color:Blue;">var</span> DWORD = <span style="color:Blue;">sizeof</span>(IntPtr);
   <span style="color:Blue;">var</span> baseSize = 3 * DWORD;

   <span style="color:Blue;">if</span> (type == <span style="color:Blue;">typeof</span>(<span style="color:Blue;">string</span>))
   {
       <span style="color:Blue;">if</span> (majorNetVersion &gt;= 4)
       {
           <span style="color:Blue;">var</span> length = (<span style="color:Blue;">int</span>)*(<span style="color:Blue;">int</span>*)(href + DWORD <span style="color:Green;">/* skip vmt */</span>);
           <span style="color:Blue;">return</span> DWORD * ((baseSize + 2 + 2 * length + (DWORD-1)) / DWORD);
       }
       <span style="color:Blue;">else</span>
       {
           <span style="color:Green;">// on 1.0 -&gt; 3.5 string have additional RealLength field</span>
           <span style="color:Blue;">var</span> arrlength = *(<span style="color:Blue;">int</span>*)(href + DWORD <span style="color:Green;">/* skip vmt */</span>);
           <span style="color:Blue;">var</span> length = *(<span style="color:Blue;">int</span>*)(href + DWORD <span style="color:Green;">/* skip vmt */</span> + 4 <span style="color:Green;">/* skip length */</span>);
           <span style="color:Blue;">return</span> DWORD * ((baseSize + 4 + 2 * length + (DWORD-1)) / DWORD);
       }
   }
   <span style="color:Blue;">else</span>
   <span style="color:Blue;">if</span> (type.BaseType == <span style="color:Blue;">typeof</span>(Array) || type == <span style="color:Blue;">typeof</span>(Array))
   {
       <span style="color:Blue;">return</span> ((ArrayInfo*)href)-&gt;SizeOf();
   }
   <span style="color:Blue;">return</span> SizeOf(type);
}
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">14</div>
<p>Где<span class="spacer"> </span><code>Size&shy;Of&shy;(type&shy;)</code><span class="spacer"> </span>бу&shy;дет<span class="spacer"> </span>вы&shy;зы&shy;вать<span class="spacer"> </span>ста&shy;рую<span class="spacer"> </span>ре&shy;а&shy;ли&shy;за&shy;цию<span class="spacer"> </span> &mdash; <span class="spacer"> </span>для<span class="spacer"> </span>фик&shy;си&shy;ров&shy;ан&shy;ных<span class="spacer"> </span>по<span class="spacer"> </span>дли&shy;не<span class="spacer"> </span>ссы&shy;лоч&shy;ных<span class="spacer"> </span>ти&shy;пов.</p>
<div class="paragraph-right-side">14</div>
</div>
<p>Дав&shy;ай&shy;те<span class="spacer"> </span>про&shy;ве&shy;рим<span class="spacer"> </span>код<span class="spacer"> </span>на<span class="spacer"> </span>прак&shy;ти&shy;ке:</p>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
    Action&lt;<span style="color:Blue;">string</span>&gt; stringWriter = (arg) =&gt;
    {
        Console.WriteLine($<span style="color:#A31515;">&quot;Length of `{arg}` string: {SizeOf(arg)}&quot;</span>);
    };

    stringWriter(<span style="color:#A31515;">&quot;a&quot;</span>);
    stringWriter(<span style="color:#A31515;">&quot;ab&quot;</span>);
    stringWriter(<span style="color:#A31515;">&quot;abc&quot;</span>);
    stringWriter(<span style="color:#A31515;">&quot;abcd&quot;</span>);
    stringWriter(<span style="color:#A31515;">&quot;abcde&quot;</span>);
    stringWriter(<span style="color:#A31515;">&quot;abcdef&quot;</span>);
}

-----

Length of `a` <span style="color:Blue;">string</span>: 16
Length of `ab` <span style="color:Blue;">string</span>: 20
Length of `abc` <span style="color:Blue;">string</span>: 20
Length of `abcd` <span style="color:Blue;">string</span>: 24
Length of `abcde` <span style="color:Blue;">string</span>: 24
Length of `abcdef` <span style="color:Blue;">string</span>: 28
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">15</div>
<p>Расчёты<span class="spacer"> </span>по&shy;ка&shy;зы&shy;ва&shy;ют,<span class="spacer"> </span>что<span class="spacer"> </span>раз&shy;мер<span class="spacer"> </span>стро&shy;ки<span class="spacer"> </span>уве&shy;ли&shy;чи&shy;ва&shy;ется<span class="spacer"> </span>не<span class="spacer"> </span>лин&shy;ей&shy;но,<span class="spacer"> </span>а<span class="spacer"> </span>сту&shy;пен&shy;ча&shy;то<span class="spacer"> </span>на<span class="spacer"> </span>каж&shy;дые<span class="spacer"> </span>два<span class="spacer"> </span>сим&shy;во&shy;ла.<span class="spacer"> </span>Это<span class="spacer"> </span>про&shy;ис&shy;хо&shy;дит<span class="spacer"> </span>по&shy;то&shy;му,<span class="spacer"> </span>что<span class="spacer"> </span>раз&shy;мер<span class="spacer"> </span>каж&shy;до&shy;го<span class="spacer"> </span>сим&shy;во&shy;ла<span class="spacer"> </span> &mdash; <span class="spacer"> </span>2<span class="spacer"> </span>бай&shy;та,<span class="spacer"> </span>а<span class="spacer"> </span>кон&shy;еч&shy;ный<span class="spacer"> </span>раз&shy;мер<span class="spacer"> </span>дол&shy;жен<span class="spacer"> </span>без<span class="spacer"> </span>ос&shy;тат&shy;ка<span class="spacer"> </span>дел&shy;ить&shy;ся<span class="spacer"> </span>на<span class="spacer"> </span>раз&shy;ряд&shy;ность<span class="spacer"> </span>про&shy;цес&shy;со&shy;ра<span class="spacer"> </span>(в<span class="spacer"> </span>при&shy;ме&shy;ре<span class="spacer"> </span>x86),<span class="spacer"> </span>по&shy;че&shy;му<span class="spacer"> </span>про&shy;ис&shy;хо&shy;дит<span class="spacer"> </span>со&shy;от&shy;вет&shy;с&shy;твующее<span class="spacer"> </span>выр&shy;ав&shy;ни&shy;ва&shy;ние<span class="spacer"> </span>раз&shy;ме&shy;ра<span class="spacer"> </span>стро&shy;ки<span class="spacer"> </span>на<span class="spacer"> </span>2<span class="spacer"> </span>бай&shy;та.<span class="spacer"> </span>Рез&shy;уль&shy;тат<span class="spacer"> </span>на&shy;шей<span class="spacer"> </span>ра&shy;бо&shy;ты<span class="spacer"> </span>прек&shy;ра&shy;сен:<span class="spacer"> </span>мы<span class="spacer"> </span>мо&shy;жем<span class="spacer"> </span>пос&shy;чи&shy;тать,<span class="spacer"> </span>во<span class="spacer"> </span>что<span class="spacer"> </span>нам<span class="spacer"> </span>обош&shy;лась<span class="spacer"> </span>та<span class="spacer"> </span>или<span class="spacer"> </span>иная<span class="spacer"> </span>стро&shy;ка.<span class="spacer"> </span>Пос&shy;лед&shy;ним<span class="spacer"> </span>эта&shy;пом<span class="spacer"> </span>нам<span class="spacer"> </span>ос&shy;та&shy;лось<span class="spacer"> </span>уз&shy;нать,<span class="spacer"> </span>как<span class="spacer"> </span>расс&shy;чи&shy;тать<span class="spacer"> </span>раз&shy;мер<span class="spacer"> </span>мас&shy;си&shy;вов<span class="spacer"> </span>в<span class="spacer"> </span>па&shy;мя&shy;ти.</p>
<div class="paragraph-right-side">15</div>
</div>
<h3 id="section-2">Мас&shy;си&shy;вы</h3>
<div class="paragraph-container">
<div class="paragraph-left-side">16</div>
<p>Стр&shy;о&shy;ение<span class="spacer"> </span>мас&shy;си&shy;вов<span class="spacer"> </span>нес&shy;коль&shy;ко<span class="spacer"> </span>слож&shy;нее:<span class="spacer"> </span>ведь<span class="spacer"> </span>у<span class="spacer"> </span>мас&shy;си&shy;вов<span class="spacer"> </span>мо&shy;гут<span class="spacer"> </span>быть<span class="spacer"> </span>ва&shy;ри&shy;ан&shy;ты<span class="spacer"> </span>их<span class="spacer"> </span>стр&shy;о&shy;ения:</p>
<div class="paragraph-right-side">16</div>
</div>
<ol>
<li>Они<span class="spacer"> </span>мо&shy;гут<span class="spacer"> </span>хра&shy;нить<span class="spacer"> </span>зна&shy;чи&shy;мые<span class="spacer"> </span>ти&shy;пы,<span class="spacer"> </span>а<span class="spacer"> </span>мо&shy;гут<span class="spacer"> </span>хра&shy;нить<span class="spacer"> </span>ссы&shy;лоч&shy;ные</li>
<li>Мас&shy;си&shy;вы<span class="spacer"> </span>мо&shy;гут<span class="spacer"> </span>быть<span class="spacer"> </span>как<span class="spacer"> </span>од&shy;ном&shy;ер&shy;ны&shy;ми,<span class="spacer"> </span>так<span class="spacer"> </span>и<span class="spacer"> </span>мно&shy;гом&shy;ер&shy;ны&shy;ми</li>
<li>Каж&shy;дое<span class="spacer"> </span>из&shy;ме&shy;ре&shy;ние<span class="spacer"> </span>(ме&shy;ра)<span class="spacer"> </span>мо&shy;жет<span class="spacer"> </span>на&shy;чин&shy;ать&shy;ся<span class="spacer"> </span>как<span class="spacer"> </span>с<span class="spacer"> </span><code>0</code>,<span class="spacer"> </span>так<span class="spacer"> </span>и<span class="spacer"> </span>с<span class="spacer"> </span>лю&shy;бо&shy;го<span class="spacer"> </span>дру&shy;го&shy;го<span class="spacer"> </span>чис&shy;ла<span class="spacer"> </span>(это,<span class="spacer"> </span>на<span class="spacer"> </span>мой<span class="spacer"> </span>взгляд,<span class="spacer"> </span>очень<span class="spacer"> </span>спор&shy;ная<span class="spacer"> </span>воз&shy;мож&shy;ность,<span class="spacer"> </span>из&shy;бав&shy;ля&shy;ю&shy;щая<span class="spacer"> </span>прог&shy;рам&shy;мис&shy;та<span class="spacer"> </span>от<span class="spacer"> </span>не&shy;об&shy;хо&shy;дим&shy;ос&shy;ти<span class="spacer"> </span>в<span class="spacer"> </span>на&shy;пи&shy;са&shy;нии<span class="spacer"> </span><code>arr[i<span class="spacer"> </span>--<span class="spacer"> </span>startIndex]</code><span class="spacer"> </span>на<span class="spacer"> </span>уровне<span class="spacer"> </span>FCL).<span class="spacer"> </span>Сде&shy;ла&shy;но<span class="spacer"> </span>это,<span class="spacer"> </span>вро&shy;де<span class="spacer"> </span>как,<span class="spacer"> </span>для<span class="spacer"> </span>сов&shy;мес&shy;тим&shy;ос&shy;ти<span class="spacer"> </span>с<span class="spacer"> </span>дру&shy;ги&shy;ми<span class="spacer"> </span>язы&shy;ками,<span class="spacer"> </span>к<span class="spacer"> </span>при&shy;ме&shy;ру,<span class="spacer"> </span>в<span class="spacer"> </span>Pascal<span class="spacer"> </span>ин&shy;дек&shy;са&shy;ция<span class="spacer"> </span>мас&shy;си&shy;ва<span class="spacer"> </span>мо&shy;жет<span class="spacer"> </span>на&shy;чин&shy;ать&shy;ся<span class="spacer"> </span>не<span class="spacer"> </span>с<span class="spacer"> </span><code>0</code>,<span class="spacer"> </span>а<span class="spacer"> </span>с<span class="spacer"> </span>лю&shy;бо&shy;го<span class="spacer"> </span>чис&shy;ла,<span class="spacer"> </span>од&shy;на&shy;ко<span class="spacer"> </span>мне<span class="spacer"> </span>каж&shy;ет&shy;ся,<span class="spacer"> </span>что<span class="spacer"> </span>это<span class="spacer"> </span>лиш&shy;нее.</li>
</ol>
<div class="paragraph-container">
<div class="paragraph-left-side">17</div>
<p>Отсю&shy;да<span class="spacer"> </span>воз&shy;ни&shy;ка&shy;ет<span class="spacer"> </span>не&shy;ко&shy;то&shy;рая<span class="spacer"> </span>пу&shy;тан&shy;ость<span class="spacer"> </span>в<span class="spacer"> </span>ре&shy;а&shy;ли&shy;за&shy;ции<span class="spacer"> </span>мас&shy;си&shy;вов<span class="spacer"> </span>и<span class="spacer"> </span>нев&shy;оз&shy;мож&shy;ность<span class="spacer"> </span>точ&shy;но<span class="spacer"> </span>предс&shy;ка&shy;зать<span class="spacer"> </span>раз&shy;мер<span class="spacer"> </span>кон&shy;еч&shy;но&shy;го<span class="spacer"> </span>мас&shy;си&shy;ва:<span class="spacer"> </span>ма&shy;ло<span class="spacer"> </span>пер&shy;ем&shy;но&shy;жить<span class="spacer"> </span>ко&shy;лич&shy;ес&shy;т&shy;во<span class="spacer"> </span>элем&shy;ен&shy;тов<span class="spacer"> </span>на<span class="spacer"> </span>их<span class="spacer"> </span>раз&shy;мер.<span class="spacer"> </span>Хо&shy;тя,<span class="spacer"> </span>кон&shy;еч&shy;но,<span class="spacer"> </span>для<span class="spacer"> </span>боль&shy;ш&shy;инства<span class="spacer"> </span>слу&shy;ча&shy;ев<span class="spacer"> </span>этого<span class="spacer"> </span>бу&shy;дет<span class="spacer"> </span>дос&shy;тат&shy;оч&shy;но.<span class="spacer"> </span>Важ&shy;ным<span class="spacer"> </span>раз&shy;мер<span class="spacer"> </span>ста&shy;нов&shy;ит&shy;ся,<span class="spacer"> </span>ког&shy;да<span class="spacer"> </span>мы<span class="spacer"> </span>бо&shy;им&shy;ся<span class="spacer"> </span>поп&shy;асть<span class="spacer"> </span>в<span class="spacer"> </span>LOH.<span class="spacer"> </span>Одна&shy;ко<span class="spacer"> </span>у<span class="spacer"> </span>нас<span class="spacer"> </span>и<span class="spacer"> </span>тут<span class="spacer"> </span>воз&shy;ни&shy;ка&shy;ют<span class="spacer"> </span>ва&shy;ри&shy;ан&shy;ты:<span class="spacer"> </span>мы<span class="spacer"> </span>мо&shy;жем<span class="spacer"> </span>прос&shy;то<span class="spacer"> </span>на&shy;ки&shy;нуть<span class="spacer"> </span>к<span class="spacer"> </span>раз&shy;ме&shy;ру,<span class="spacer"> </span>подс&shy;чит&shy;ан&shy;но&shy;му<span class="spacer"> </span>&laquo;на<span class="spacer"> </span>кол&shy;ен&shy;ке&raquo;,<span class="spacer"> </span>ка&shy;кую-то<span class="spacer"> </span>конс&shy;тан&shy;ту<span class="spacer"> </span>свер&shy;ху<span class="spacer"> </span>(нап&shy;ри&shy;мер,<span class="spacer"> </span>100),<span class="spacer"> </span>что&shy;бы<span class="spacer"> </span>по&shy;нять,<span class="spacer"> </span>пе&shy;реш&shy;аг&shy;ну&shy;ли<span class="spacer"> </span>мы<span class="spacer"> </span>гра&shy;ни&shy;цу<span class="spacer"> </span>в<span class="spacer"> </span>85000<span class="spacer"> </span>или<span class="spacer"> </span>нет.<span class="spacer"> </span>Одна&shy;ко,<span class="spacer"> </span>в<span class="spacer"> </span>рам&shy;ках<span class="spacer"> </span>дан&shy;но&shy;го<span class="spacer"> </span>раз&shy;де&shy;ла<span class="spacer"> </span>за&shy;да&shy;ча<span class="spacer"> </span>нес&shy;коль&shy;ко<span class="spacer"> </span>дру&shy;гая:<span class="spacer"> </span>по&shy;нять<span class="spacer"> </span>струк&shy;ту&shy;ру<span class="spacer"> </span>ти&shy;пов.<span class="spacer"> </span>На<span class="spacer"> </span>неё<span class="spacer"> </span>и<span class="spacer"> </span>пос&shy;мот&shy;рим:</p>
<div class="paragraph-right-side">17</div>
</div>
<pre><code>  // Заголовок
  ----------------------------------------------------------------------------------------
  |   SBI   |  VMT_Ptr |  Total  |  Len_1  |  Len_2  | .. |  Len_N  |  Term   | VMT_Child |
  ----------------------------------opt-------opt------------opt-------opt--------opt-----
  |  4 / 8  |  4 / 8   |    4    |    4    |    4    |    |    4    |    4    |    4/8    |
  ----------------------------------------------------------------------------------------
  | 0xFF.FF | 0xXX.XX  |    ?    |    ?    |    ?    |    |    ?    | 0x00.00 | 0xXX.XX  |
  ----------------------------------------------------------------------------------------

  - opt: опционально
  - SBI: Sync Block Index
  - VMT_Child: присутствует, только если массив хранит данные ссылочного типа
  - Total: присутствует для оптимизации. Общее количество элементов массива с учётом всех размерностей
  - Len_2..Len_N, Term: присутствуют, только если размерность массива более 1 (регулируется битами в VMT-&gt;Flags)
</code></pre>
<div class="paragraph-container">
<div class="paragraph-left-side">18</div>
<p>Как<span class="spacer"> </span>мы<span class="spacer"> </span>ви&shy;дим,<span class="spacer"> </span>за&shy;го&shy;ло&shy;вок<span class="spacer"> </span>ти&shy;па<span class="spacer"> </span>хра&shy;нит<span class="spacer"> </span>дан&shy;ные<span class="spacer"> </span>об<span class="spacer"> </span>из&shy;ме&shy;ре&shy;ни&shy;ях<span class="spacer"> </span>мас&shy;си&shy;ва:<span class="spacer"> </span>их<span class="spacer"> </span>чис&shy;ло<span class="spacer"> </span>мо&shy;жет<span class="spacer"> </span>быть<span class="spacer"> </span>как<span class="spacer"> </span>1,<span class="spacer"> </span>так<span class="spacer"> </span>и<span class="spacer"> </span>дос&shy;тат&shy;оч&shy;но<span class="spacer"> </span>боль&shy;шим:<span class="spacer"> </span>фак&shy;тич&shy;ес&shy;ки<span class="spacer"> </span>их<span class="spacer"> </span>раз&shy;мер<span class="spacer"> </span>ог&shy;ра&shy;ни&shy;чи&shy;ва&shy;ет&shy;ся<span class="spacer"> </span>толь&shy;ко<span class="spacer"> </span>null-тер&shy;ми&shy;на&shy;то&shy;ром,<span class="spacer"> </span>оз&shy;на&shy;ча&shy;ю&shy;щим,<span class="spacer"> </span>что<span class="spacer"> </span>пе&shy;реч&shy;ис&shy;ле&shy;ние<span class="spacer"> </span>зак&shy;он&shy;че&shy;но.<span class="spacer"> </span>Дан&shy;ный<span class="spacer"> </span>при&shy;мер<span class="spacer"> </span>дос&shy;ту&shy;пен<span class="spacer"> </span>пол&shy;нос&shy;тью<span class="spacer"> </span>в<span class="spacer"> </span>фай&shy;ле<span class="spacer"> </span><a href="./samples/GettingInstanceSize.linq">Getting&shy;Instance&shy;Size</a>,<span class="spacer"> </span>а<span class="spacer"> </span>ни&shy;же<span class="spacer"> </span>я<span class="spacer"> </span>при&shy;ве&shy;ду<span class="spacer"> </span>толь&shy;ко<span class="spacer"> </span>его<span class="spacer"> </span>са&shy;мую<span class="spacer"> </span>важ&shy;ную<span class="spacer"> </span>часть:</p>
<div class="paragraph-right-side">18</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">public</span> <span style="color:Blue;">int</span> SizeOf()
{
    <span style="color:Blue;">var</span> total = 0;
    <span style="color:Blue;">int</span> elementsize;

    <span style="color:Blue;">fixed</span> (<span style="color:Blue;">void</span>* entity = &amp;MethodTable)
    {
        <span style="color:Blue;">var</span> arr = Union.GetObj&lt;Array&gt;((IntPtr)entity);
        <span style="color:Blue;">var</span> elementType = arr.GetType().GetElementType();

        <span style="color:Blue;">if</span> (elementType.IsValueType)
        {
            <span style="color:Blue;">var</span> typecode = Type.GetTypeCode(elementType);

            <span style="color:Blue;">switch</span> (typecode)
            {
                <span style="color:Blue;">case</span> TypeCode.Byte:
                <span style="color:Blue;">case</span> TypeCode.SByte:
                <span style="color:Blue;">case</span> TypeCode.Boolean:
                    elementsize = 1;
                    <span style="color:Blue;">break</span>;
                <span style="color:Blue;">case</span> TypeCode.Int16:
                <span style="color:Blue;">case</span> TypeCode.UInt16:
                <span style="color:Blue;">case</span> TypeCode.Char:
                    elementsize = 2;
                    <span style="color:Blue;">break</span>;
                <span style="color:Blue;">case</span> TypeCode.Int32:
                <span style="color:Blue;">case</span> TypeCode.UInt32:
                <span style="color:Blue;">case</span> TypeCode.Single:
                    elementsize = 4;
                    <span style="color:Blue;">break</span>;
                <span style="color:Blue;">case</span> TypeCode.Int64:
                <span style="color:Blue;">case</span> TypeCode.UInt64:
                <span style="color:Blue;">case</span> TypeCode.Double:
                    elementsize = 8;
                    <span style="color:Blue;">break</span>;
                <span style="color:Blue;">case</span> TypeCode.Decimal:
                    elementsize = 12;
                    <span style="color:Blue;">break</span>;
                <span style="color:Blue;">default</span>:
                    <span style="color:Blue;">var</span> info = (MethodTable*)elementType.TypeHandle.Value;
                    elementsize = info-&gt;Size - 2 * <span style="color:Blue;">sizeof</span>(IntPtr); <span style="color:Green;">// sync blk + vmt ptr</span>
                    <span style="color:Blue;">break</span>;
            }
        }
        <span style="color:Blue;">else</span>
        {
            elementsize = IntPtr.Size;
        }

        <span style="color:Green;">// Header</span>
        total += 3 * <span style="color:Blue;">sizeof</span>(IntPtr); <span style="color:Green;">// sync blk + vmt ptr + total length</span>
        total += elementType.IsValueType ? 0 : <span style="color:Blue;">sizeof</span>(IntPtr); <span style="color:Green;">// MethodsTable for refTypes</span>
        total += IsMultidimensional ? Dimensions * <span style="color:Blue;">sizeof</span>(<span style="color:Blue;">int</span>) : 0;
    }

    <span style="color:Green;">// Contents</span>
    total += (<span style="color:Blue;">int</span>)TotalLength * elementsize;

    <span style="color:Green;">// align size to IntPtr</span>
    <span style="color:Blue;">if</span> ((total % <span style="color:Blue;">sizeof</span>(IntPtr)) != 0)
    {
        total += <span style="color:Blue;">sizeof</span>(IntPtr) - total % (<span style="color:Blue;">sizeof</span>(IntPtr));
    }
    <span style="color:Blue;">return</span> total;
}
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">19</div>
<p>Этот<span class="spacer"> </span>код<span class="spacer"> </span>учи&shy;ты&shy;вает<span class="spacer"> </span>все<span class="spacer"> </span>ва&shy;ри&shy;а&shy;ции<span class="spacer"> </span>ти&shy;пов<span class="spacer"> </span>мас&shy;си&shy;вов,<span class="spacer"> </span>и<span class="spacer"> </span>мо&shy;жет<span class="spacer"> </span>быть<span class="spacer"> </span>ис&shy;поль&shy;зо&shy;ван<span class="spacer"> </span>для<span class="spacer"> </span>расчёта<span class="spacer"> </span>его<span class="spacer"> </span>раз&shy;ме&shy;ра:</p>
<div class="paragraph-right-side">19</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
Console.WriteLine($<span style="color:#A31515;">&quot;size of int[]{{1,2}}: {SizeOf(new int[2])}&quot;</span>);
Console.WriteLine($<span style="color:#A31515;">&quot;size of int[2,1]{{1,2}}: {SizeOf(new int[1,2])}&quot;</span>);
Console.WriteLine($<span style="color:#A31515;">&quot;size of int[2,3,4,5]{{...}}: {SizeOf(new int[2, 3, 4, 5])}&quot;</span>);

---
size of <span style="color:Blue;">int</span>[]{1,2}: 20
size of <span style="color:Blue;">int</span>[2,1]{1,2}: 32
size of <span style="color:Blue;">int</span>[2,3,4,5]{...}: 512
</pre></div>
</div>
<h3 id="section-3">Вы&shy;во&shy;ды<span class="spacer"> </span>к<span class="spacer"> </span>раз&shy;де&shy;лу</h3>
<div class="paragraph-container">
<div class="paragraph-left-side">20</div>
<p>На<span class="spacer"> </span>дан&shy;ном<span class="spacer"> </span>этапе<span class="spacer"> </span>мы<span class="spacer"> </span>на&shy;у&shy;чи&shy;лись<span class="spacer"> </span>нес&shy;коль&shy;ким<span class="spacer"> </span>дос&shy;тат&shy;оч&shy;но<span class="spacer"> </span>важ&shy;ным<span class="spacer"> </span>ве&shy;щам.<span class="spacer"> </span>Пер&shy;вое<span class="spacer"> </span> &mdash; <span class="spacer"> </span>мы<span class="spacer"> </span>раз&shy;де&shy;ли&shy;ли<span class="spacer"> </span>для<span class="spacer"> </span>се&shy;бя<span class="spacer"> </span>ссы&shy;лоч&shy;ные<span class="spacer"> </span>ти&shy;пы<span class="spacer"> </span>на<span class="spacer"> </span>три<span class="spacer"> </span>груп&shy;пы:<span class="spacer"> </span>ссы&shy;лоч&shy;ные<span class="spacer"> </span>ти&shy;пы<span class="spacer"> </span>фик&shy;си&shy;ров&shy;ан&shy;но&shy;го<span class="spacer"> </span>раз&shy;ме&shy;ра,<span class="spacer"> </span>generic<span class="spacer"> </span>ти&shy;пы<span class="spacer"> </span>и<span class="spacer"> </span>ссы&shy;лоч&shy;ные<span class="spacer"> </span>ти&shy;пы<span class="spacer"> </span>пе&shy;рем&shy;ен&shy;но&shy;го<span class="spacer"> </span>раз&shy;ме&shy;ра.<span class="spacer"> </span>Так&shy;же<span class="spacer"> </span>мы<span class="spacer"> </span>на&shy;у&shy;чи&shy;лись<span class="spacer"> </span>по&shy;ни&shy;мать<span class="spacer"> </span>струк&shy;ту&shy;ру<span class="spacer"> </span>кон&shy;еч&shy;но&shy;го<span class="spacer"> </span>эк&shy;земп&shy;ля&shy;ра<span class="spacer"> </span>лю&shy;бо&shy;го<span class="spacer"> </span>ти&shy;па<span class="spacer"> </span>(про<span class="spacer"> </span>струк&shy;ту&shy;ру<span class="spacer"> </span>VMT<span class="spacer"> </span>я<span class="spacer"> </span>по&shy;ка<span class="spacer"> </span>мол&shy;чу.<span class="spacer"> </span>Мы<span class="spacer"> </span>там<span class="spacer"> </span>по&shy;ня&shy;ли<span class="spacer"> </span>це&shy;ли&shy;ком<span class="spacer"> </span>по&shy;ка<span class="spacer"> </span>что<span class="spacer"> </span>толь&shy;ко<span class="spacer"> </span>од&shy;но<span class="spacer"> </span>по&shy;ле:<span class="spacer"> </span>а<span class="spacer"> </span>это<span class="spacer"> </span>то&shy;же<span class="spacer"> </span>боль&shy;шое<span class="spacer"> </span>дос&shy;ти&shy;же&shy;ние).<span class="spacer"> </span>Будь<span class="spacer"> </span>то<span class="spacer"> </span>ссы&shy;лоч&shy;ный<span class="spacer"> </span>тип<span class="spacer"> </span>фик&shy;си&shy;ров&shy;ан&shy;но&shy;го<span class="spacer"> </span>раз&shy;ме&shy;ра<span class="spacer"> </span>(там<span class="spacer"> </span>все<span class="spacer"> </span>пре&shy;дель&shy;но<span class="spacer"> </span>прос&shy;то)<span class="spacer"> </span>или<span class="spacer"> </span>не&shy;оп&shy;ре&shy;делённо&shy;го<span class="spacer"> </span>раз&shy;ме&shy;ра:<span class="spacer"> </span>мас&shy;сив<span class="spacer"> </span>или<span class="spacer"> </span>стро&shy;ка.<span class="spacer"> </span>Не&shy;оп&shy;ре&shy;делённо&shy;го<span class="spacer"> </span>по&shy;то&shy;му,<span class="spacer"> </span>что<span class="spacer"> </span>его<span class="spacer"> </span>раз&shy;мер<span class="spacer"> </span>бу&shy;дет<span class="spacer"> </span>оп&shy;ре&shy;делён<span class="spacer"> </span>при<span class="spacer"> </span>соз&shy;да&shy;нии.<span class="spacer"> </span>С<span class="spacer"> </span>generic<span class="spacer"> </span>ти&shy;па&shy;ми<span class="spacer"> </span>на<span class="spacer"> </span>са&shy;мом<span class="spacer"> </span>де&shy;ле<span class="spacer"> </span>все<span class="spacer"> </span>прос&shy;то:<span class="spacer"> </span>для<span class="spacer"> </span>каж&shy;до&shy;го<span class="spacer"> </span>конк&shy;рет&shy;но&shy;го<span class="spacer"> </span>generic<span class="spacer"> </span>ти&shy;па<span class="spacer"> </span>соз&shy;даётся<span class="spacer"> </span>своя<span class="spacer"> </span>VMT,<span class="spacer"> </span>в<span class="spacer"> </span>ко&shy;то&shy;рой<span class="spacer"> </span>бу&shy;дет<span class="spacer"> </span>прос&shy;тав&shy;лен<span class="spacer"> </span>конк&shy;рет&shy;ный<span class="spacer"> </span>раз&shy;мер.</p>
<div class="paragraph-right-side">20</div>
</div>
<h2 id="virtual-methods-table-vmt">Таб&shy;ли&shy;ца<span class="spacer"> </span>ме&shy;то&shy;дов<span class="spacer"> </span>в<span class="spacer"> </span>Virtual<span class="spacer"> </span>Methods<span class="spacer"> </span>Table<span class="spacer"> </span>(VMT)</h2>
<div class="paragraph-container">
<div class="paragraph-left-side">21</div>
<p>Объя&shy;сне&shy;ние<span class="spacer"> </span>ра&shy;бо&shy;ты<span class="spacer"> </span>Methods<span class="spacer"> </span>Table&shy;,<span class="spacer"> </span>по<span class="spacer"> </span>боль&shy;шей<span class="spacer"> </span>час&shy;ти<span class="spacer"> </span>но&shy;сит<span class="spacer"> </span>ака&shy;де&shy;мич&shy;ес&shy;кий<span class="spacer"> </span>хар&shy;ак&shy;тер:<span class="spacer"> </span>ведь<span class="spacer"> </span>в<span class="spacer"> </span>та&shy;кие<span class="spacer"> </span>деб&shy;ри<span class="spacer"> </span>лезть<span class="spacer"> </span> &mdash; <span class="spacer"> </span>это<span class="spacer"> </span>как<span class="spacer"> </span>са&shy;мо&shy;му<span class="spacer"> </span>се&shy;бе<span class="spacer"> </span>мо&shy;ги&shy;лу<span class="spacer"> </span>рыть.<span class="spacer"> </span>С<span class="spacer"> </span>од&shy;ной<span class="spacer"> </span>сто&shy;ро&shy;ны,<span class="spacer"> </span>та&shy;кие<span class="spacer"> </span>зак&shy;ро&shy;ма<span class="spacer"> </span>та&shy;ят<span class="spacer"> </span>что-то<span class="spacer"> </span>бу&shy;до&shy;ра&shy;жа&shy;щее<span class="spacer"> </span>и<span class="spacer"> </span>ин&shy;тер&shy;ес&shy;ное,<span class="spacer"> </span>хра&shy;нят<span class="spacer"> </span>не&shy;кие<span class="spacer"> </span>дан&shy;ные,<span class="spacer"> </span>ко&shy;то&shy;рые<span class="spacer"> </span>ещё<span class="spacer"> </span>боль&shy;ше<span class="spacer"> </span>раск&shy;ры&shy;ва&shy;ют<span class="spacer"> </span>по&shy;ни&shy;ма&shy;ние<span class="spacer"> </span>о<span class="spacer"> </span>про&shy;ис&shy;хо&shy;дя&shy;щем.<span class="spacer"> </span>Одна&shy;ко,<span class="spacer"> </span>с<span class="spacer"> </span>дру&shy;гой<span class="spacer"> </span>сто&shy;ро&shy;ны,<span class="spacer"> </span>все<span class="spacer"> </span>мы<span class="spacer"> </span>по&shy;ни&shy;ма&shy;ем,<span class="spacer"> </span>что<span class="spacer"> </span>Microsoft<span class="spacer"> </span>не<span class="spacer"> </span>бу&shy;дет<span class="spacer"> </span>нам<span class="spacer"> </span>да&shy;вать<span class="spacer"> </span>ни&shy;ка&shy;ких<span class="spacer"> </span>гар&shy;ан&shy;тий,<span class="spacer"> </span>что<span class="spacer"> </span>они<span class="spacer"> </span>ос&shy;та&shy;вят<span class="spacer"> </span>свой<span class="spacer"> </span>ран&shy;тайм<span class="spacer"> </span>без<span class="spacer"> </span>из&shy;ме&shy;не&shy;ний<span class="spacer"> </span>и,<span class="spacer"> </span>нап&shy;ри&shy;мер,<span class="spacer"> </span>вдруг<span class="spacer"> </span>не<span class="spacer"> </span>пер&shy;ед&shy;ви&shy;нут<span class="spacer"> </span>таб&shy;ли&shy;цу<span class="spacer"> </span>ме&shy;то&shy;дов<span class="spacer"> </span>на<span class="spacer"> </span>од&shy;но<span class="spacer"> </span>по&shy;ле<span class="spacer"> </span>вперёд.<span class="spacer"> </span>По&shy;э&shy;то&shy;му,<span class="spacer"> </span>ого&shy;во&shy;рюсь<span class="spacer"> </span>сра&shy;зу:</p>
<div class="paragraph-right-side">21</div>
</div>
<blockquote>
<p>Инфор&shy;ма&shy;ция,<span class="spacer"> </span>предс&shy;тав&shy;лен&shy;ная<span class="spacer"> </span>в<span class="spacer"> </span>дан&shy;ном<span class="spacer"> </span>раз&shy;де&shy;ле,<span class="spacer"> </span>да&shy;на<span class="spacer"> </span>вам<span class="spacer"> </span>ис&shy;клю&shy;чит&shy;ель&shy;но<span class="spacer"> </span>для<span class="spacer"> </span>то&shy;го,<span class="spacer"> </span>что&shy;бы<span class="spacer"> </span>вы<span class="spacer"> </span>по&shy;ни&shy;ма&shy;ли,<span class="spacer"> </span>как<span class="spacer"> </span>ра&shy;бо&shy;та&shy;ет<span class="spacer"> </span>при&shy;ло&shy;же&shy;ние,<span class="spacer"> </span>ос&shy;нов&shy;ан&shy;ное<span class="spacer"> </span>на<span class="spacer"> </span>CLR,<span class="spacer"> </span>и<span class="spacer"> </span>руч&shy;ное<span class="spacer"> </span>вме&shy;шат&shy;ель&shy;с&shy;тво<span class="spacer"> </span>в<span class="spacer"> </span>её<span class="spacer"> </span>ра&shy;бо&shy;ту<span class="spacer"> </span>не<span class="spacer"> </span>даёт<span class="spacer"> </span>ни&shy;ка&shy;ких<span class="spacer"> </span>гар&shy;ан&shy;тий.<span class="spacer"> </span>Одна&shy;ко,<span class="spacer"> </span>это<span class="spacer"> </span>нас&shy;толь&shy;ко<span class="spacer"> </span>ин&shy;тер&shy;ес&shy;но,<span class="spacer"> </span>что<span class="spacer"> </span>я<span class="spacer"> </span>не<span class="spacer"> </span>мо&shy;гу<span class="spacer"> </span>вас<span class="spacer"> </span>от&shy;го&shy;во&shy;рить.<span class="spacer"> </span>На&shy;о&shy;бо&shy;рот,<span class="spacer"> </span>мой<span class="spacer"> </span>со&shy;вет<span class="spacer"> </span> &mdash; <span class="spacer"> </span>по&shy;иг&shy;рай&shy;тесь<span class="spacer"> </span>с<span class="spacer"> </span>этими<span class="spacer"> </span>струк&shy;ту&shy;ра&shy;ми<span class="spacer"> </span>дан&shy;ных<span class="spacer"> </span>и,<span class="spacer"> </span>воз&shy;мож&shy;но,<span class="spacer"> </span>вы<span class="spacer"> </span>по&shy;лу&shy;чи&shy;те<span class="spacer"> </span>один<span class="spacer"> </span>из<span class="spacer"> </span>са&shy;мых<span class="spacer"> </span>за&shy;по&shy;ми&shy;на&shy;ю&shy;щих&shy;ся<span class="spacer"> </span>опы&shy;тов<span class="spacer"> </span>в<span class="spacer"> </span>раз&shy;раб&shy;от&shy;ке<span class="spacer"> </span>ПО.</p>
</blockquote>
<div class="paragraph-container">
<div class="paragraph-left-side">22</div>
<p>Ну,<span class="spacer"> </span>все:<span class="spacer"> </span>пре&shy;дуп&shy;ре&shy;дил.<span class="spacer"> </span>Те&shy;перь<span class="spacer"> </span>дав&shy;ай&shy;те<span class="spacer"> </span>окунёмся<span class="spacer"> </span>в<span class="spacer"> </span>мир<span class="spacer"> </span>как<span class="spacer"> </span>го&shy;вор&shy;ит&shy;ся<span class="spacer"> </span>заз&shy;ер&shy;ка&shy;лья.<span class="spacer"> </span>Ведь<span class="spacer"> </span>до<span class="spacer"> </span>сих<span class="spacer"> </span>пор<span class="spacer"> </span>всё<span class="spacer"> </span>заз&shy;ер&shy;ка&shy;лье<span class="spacer"> </span>сво&shy;ди&shy;лось<span class="spacer"> </span>к<span class="spacer"> </span>зна&shy;ни&shy;ям<span class="spacer"> </span>струк&shy;ту&shy;ры<span class="spacer"> </span>объе&shy;к&shy;тов:<span class="spacer"> </span>а<span class="spacer"> </span>её<span class="spacer"> </span>по<span class="spacer"> </span>идее<span class="spacer"> </span>мы<span class="spacer"> </span>и<span class="spacer"> </span>так<span class="spacer"> </span>дол&shy;ж&shy;ны<span class="spacer"> </span>знать<span class="spacer"> </span>хо&shy;тя<span class="spacer"> </span>бы<span class="spacer"> </span>при&shy;мер&shy;но.<span class="spacer"> </span>И<span class="spacer"> </span>по<span class="spacer"> </span>сво&shy;ей<span class="spacer"> </span>су&shy;ти<span class="spacer"> </span>эти<span class="spacer"> </span>зна&shy;ния<span class="spacer"> </span>заз&shy;ер&shy;каль&shy;ем<span class="spacer"> </span>не<span class="spacer"> </span>яв&shy;ля&shy;ют&shy;ся,<span class="spacer"> </span>а<span class="spacer"> </span>яв&shy;ля&shy;ют&shy;ся<span class="spacer"> </span>ско&shy;рее<span class="spacer"> </span>вхо&shy;дом<span class="spacer"> </span>в<span class="spacer"> </span>заз&shy;ер&shy;ка&shy;лье.<span class="spacer"> </span>А<span class="spacer"> </span>по&shy;то&shy;му<span class="spacer"> </span>вернёмся<span class="spacer"> </span>к<span class="spacer"> </span>струк&shy;ту&shy;ре<span class="spacer"> </span><code>Method&shy;Table</code>,<span class="spacer"> </span><a href="https://github.com/dotnet/coreclr/blob/master/src/vm/methodtable.h#L4099-L4114">опис&shy;ан&shy;ной<span class="spacer"> </span>в<span class="spacer"> </span>Core&shy;CLR</a>:</p>
<div class="paragraph-right-side">22</div>
</div>
<div class="lang-cpp editor-colors"><div style="color:Black;background-color:White;"><pre>
   <span style="color:Green;">// Low WORD is component size for array and string types (HasComponentSize() returns true).</span>
   <span style="color:Green;">// Used for flags otherwise.</span>
   DWORD m_dwFlags;

   <span style="color:Green;">// Base size of instance of this class when allocated on the heap</span>
   DWORD m_BaseSize;

   WORD  m_wFlags2;

   <span style="color:Green;">// Class token if it fits into 16-bits. If this is (WORD)-1, the class token is stored in the TokenOverflow optional member.</span>
   WORD  m_wToken;

   <span style="color:Green;">// &lt;NICE&gt; In the normal cases we shouldn&#39;t need a full word for each of these &lt;/NICE&gt;</span>
   WORD  m_wNumVirtuals;
   WORD  m_wNumInterfaces;
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">23</div>
<p>А<span class="spacer"> </span>именно<span class="spacer"> </span>к<span class="spacer"> </span>по&shy;лям<span class="spacer"> </span><code>m_wNum&shy;Vir&shy;tu&shy;als</code><span class="spacer"> </span>и<span class="spacer"> </span><code>m_wNum&shy;Inter&shy;fa&shy;ces</code>.<span class="spacer"> </span>Эти<span class="spacer"> </span>два<span class="spacer"> </span>по&shy;ля<span class="spacer"> </span>оп&shy;ре&shy;де&shy;ля&shy;ют<span class="spacer"> </span>от&shy;вет<span class="spacer"> </span>на<span class="spacer"> </span>воп&shy;рос<span class="spacer"> </span>"сколь&shy;ко<span class="spacer"> </span>вир&shy;ту&shy;аль&shy;ных<span class="spacer"> </span>ме&shy;то&shy;дов<span class="spacer"> </span>и<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;сов<span class="spacer"> </span>сущ&shy;ес&shy;тву&shy;ет<span class="spacer"> </span>у<span class="spacer"> </span>ти&shy;па?".<span class="spacer"> </span>В<span class="spacer"> </span>этой<span class="spacer"> </span>струк&shy;ту&shy;ре<span class="spacer"> </span>нет<span class="spacer"> </span>ни&shy;ка&shy;кой<span class="spacer"> </span>ин&shy;фор&shy;ма&shy;ции<span class="spacer"> </span>об<span class="spacer"> </span>обыч&shy;ных<span class="spacer"> </span>ме&shy;то&shy;дах,<span class="spacer"> </span>по&shy;лях,<span class="spacer"> </span>свой&shy;с&shy;твах<span class="spacer"> </span>(ко&shy;то&shy;рые<span class="spacer"> </span>объе&shy;ди&shy;няют<span class="spacer"> </span>ме&shy;то&shy;ды).<span class="spacer"> </span>Т.е.<span class="spacer"> </span>эта<span class="spacer"> </span>струк&shy;ту&shy;ра<span class="spacer"> </span><strong>ни&shy;как<span class="spacer"> </span>не<span class="spacer"> </span>свя&shy;за&shy;на<span class="spacer"> </span>с<span class="spacer"> </span>реф&shy;лек&shy;си&shy;ей</strong>.<span class="spacer"> </span>По<span class="spacer"> </span>сво&shy;ей<span class="spacer"> </span>су&shy;ти<span class="spacer"> </span>и<span class="spacer"> </span>наз&shy;на&shy;че&shy;нию<span class="spacer"> </span>эта<span class="spacer"> </span>струк&shy;ту&shy;ра<span class="spacer"> </span>соз&shy;да&shy;на<span class="spacer"> </span>для<span class="spacer"> </span>ра&shy;бо&shy;ты<span class="spacer"> </span>вы&shy;зо&shy;ва<span class="spacer"> </span>ме&shy;то&shy;дов<span class="spacer"> </span>в<span class="spacer"> </span>CLR<span class="spacer"> </span>(и<span class="spacer"> </span>на<span class="spacer"> </span>са&shy;мом<span class="spacer"> </span>де&shy;ле<span class="spacer"> </span>в<span class="spacer"> </span>лю&shy;бом<span class="spacer"> </span>ООП:<span class="spacer"> </span>будь<span class="spacer"> </span>то<span class="spacer"> </span>Java&shy;,<span class="spacer"> </span>C++,<span class="spacer"> </span>Ruby<span class="spacer"> </span>или<span class="spacer"> </span>же<span class="spacer"> </span>что-то<span class="spacer"> </span>ещё.<span class="spacer"> </span>Прос&shy;то<span class="spacer"> </span>рас&shy;по&shy;ло&shy;же&shy;ние<span class="spacer"> </span>по&shy;лей<span class="spacer"> </span>бу&shy;дет<span class="spacer"> </span>нес&shy;коль&shy;ко<span class="spacer"> </span>дру&shy;гим).<span class="spacer"> </span>Дав&shy;ай&shy;те<span class="spacer"> </span>расс&shy;мот&shy;рим<span class="spacer"> </span>код:</p>
<div class="paragraph-right-side">23</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">public</span> <span style="color:Blue;">class</span> Sample
{
    <span style="color:Blue;">public</span> <span style="color:Blue;">int</span> _x;

    <span style="color:Blue;">public</span> <span style="color:Blue;">void</span> ChangeTo(<span style="color:Blue;">int</span> newValue)
    {
        _x = newValue;
    }

    <span style="color:Blue;">public</span> <span style="color:Blue;">virtual</span> <span style="color:Blue;">int</span> GetValue()
    {
        <span style="color:Blue;">return</span> _x;
    }
}

<span style="color:Blue;">public</span> <span style="color:Blue;">class</span> OverridedSample : Sample
{
    <span style="color:Blue;">public</span> <span style="color:Blue;">override</span> GetValue()
    {
        <span style="color:Blue;">return</span> 666;
    }
}

</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">24</div>
<p>Ка&shy;ки&shy;ми<span class="spacer"> </span>бы<span class="spacer"> </span>бесс&shy;мыс&shy;лен&shy;ны&shy;ми<span class="spacer"> </span>не<span class="spacer"> </span>ка&shy;за&shy;лись<span class="spacer"> </span>эти<span class="spacer"> </span>клас&shy;сы,<span class="spacer"> </span>они<span class="spacer"> </span>нам<span class="spacer"> </span>впол&shy;не<span class="spacer"> </span>сго&shy;дят&shy;ся<span class="spacer"> </span>для<span class="spacer"> </span>опи&shy;са&shy;ния<span class="spacer"> </span>их<span class="spacer"> </span>VMT.<span class="spacer"> </span>А<span class="spacer"> </span>для<span class="spacer"> </span>этого<span class="spacer"> </span>мы<span class="spacer"> </span>дол&shy;ж&shy;ны<span class="spacer"> </span>по&shy;нять,<span class="spacer"> </span>чем<span class="spacer"> </span>от&shy;ли&shy;ча&shy;ют&shy;ся<span class="spacer"> </span>ба&shy;зо&shy;вый<span class="spacer"> </span>тип<span class="spacer"> </span>и<span class="spacer"> </span>унас&shy;ле&shy;дов&shy;ан&shy;ный<span class="spacer"> </span>в<span class="spacer"> </span>воп&shy;ро&shy;се<span class="spacer"> </span>ме&shy;то&shy;дов<span class="spacer"> </span><code>Change&shy;To</code><span class="spacer"> </span>и<span class="spacer"> </span><code>Get&shy;Value</code>.</p>
<div class="paragraph-right-side">24</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">25</div>
<p>Ме&shy;тод<span class="spacer"> </span><code>Change&shy;To</code><span class="spacer"> </span>при&shy;сут&shy;ствует<span class="spacer"> </span>в<span class="spacer"> </span>обоих<span class="spacer"> </span>ти&shy;пах:<span class="spacer"> </span>при<span class="spacer"> </span>этом<span class="spacer"> </span>его<span class="spacer"> </span>нель&shy;зя<span class="spacer"> </span>пе&shy;ре&shy;оп&shy;ре&shy;де&shy;лять.<span class="spacer"> </span>Это<span class="spacer"> </span>зна&shy;чит,<span class="spacer"> </span>что<span class="spacer"> </span>он<span class="spacer"> </span>мо&shy;жет<span class="spacer"> </span>быть<span class="spacer"> </span>пе&shy;ре&shy;пи&shy;сан<span class="spacer"> </span>так,<span class="spacer"> </span>и<span class="spacer"> </span>ни&shy;че&shy;го<span class="spacer"> </span>не<span class="spacer"> </span>по&shy;ме&shy;ня&shy;ет&shy;ся:</p>
<div class="paragraph-right-side">25</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
 <span style="color:Blue;">public</span> <span style="color:Blue;">class</span> Sample
 {
     <span style="color:Blue;">public</span> <span style="color:Blue;">int</span> _x;

     <span style="color:Blue;">public</span> <span style="color:Blue;">static</span> <span style="color:Blue;">void</span> ChangeTo(Sample self, <span style="color:Blue;">int</span> newValue)
     {
         self._x = newValue;
     }

     <span style="color:Green;">// ...</span>
 }

<span style="color:Green;">// Либо в случае если бы он был struc</span>
 <span style="color:Blue;">public</span> <span style="color:Blue;">struct</span> Sample
 {
     <span style="color:Blue;">public</span> <span style="color:Blue;">int</span> _x;

     <span style="color:Blue;">public</span> <span style="color:Blue;">static</span> <span style="color:Blue;">void</span> ChangeTo(<span style="color:Blue;">ref</span> Sample self, <span style="color:Blue;">int</span> newValue)
     {
         self._x = newValue;
     }

     <span style="color:Green;">// ...</span>
 }
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">26</div>
<p>И<span class="spacer"> </span>при<span class="spacer"> </span>этом<span class="spacer"> </span>кро&shy;ме<span class="spacer"> </span>ар&shy;хит&shy;ек&shy;тур&shy;но&shy;го<span class="spacer"> </span>смыс&shy;ла<span class="spacer"> </span>ни&shy;че&shy;го<span class="spacer"> </span>не<span class="spacer"> </span>из&shy;мен&shy;ит&shy;ся:<span class="spacer"> </span>пов&shy;ерь&shy;те,<span class="spacer"> </span>при<span class="spacer"> </span>ком&shy;пи&shy;ля&shy;ции<span class="spacer"> </span>оба<span class="spacer"> </span>ва&shy;ри&shy;ан&shy;та<span class="spacer"> </span>бу&shy;дут<span class="spacer"> </span>ра&shy;бо&shy;тать<span class="spacer"> </span>оди&shy;на&shy;ково,<span class="spacer"> </span>т.к.<span class="spacer"> </span>у<span class="spacer"> </span>эк&shy;земп&shy;ляр&shy;ных<span class="spacer"> </span>ме&shy;то&shy;дов<span class="spacer"> </span><code>this</code><span class="spacer"> </span> &mdash; <span class="spacer"> </span>это<span class="spacer"> </span>все&shy;го<span class="spacer"> </span>лишь<span class="spacer"> </span>пер&shy;вый<span class="spacer"> </span>па&shy;рам&shy;етр<span class="spacer"> </span>ме&shy;то&shy;да,<span class="spacer"> </span>ко&shy;то&shy;рый<span class="spacer"> </span>пе&shy;ре&shy;даётся<span class="spacer"> </span>нам<span class="spacer"> </span>не&shy;яв&shy;но.</p>
<div class="paragraph-right-side">26</div>
</div>
<blockquote>
<p>За&shy;ра&shy;нее<span class="spacer"> </span>по&shy;яс&shy;ню,<span class="spacer"> </span>по&shy;че&shy;му<span class="spacer"> </span>все<span class="spacer"> </span>объя&shy;сне&shy;ния<span class="spacer"> </span>вок&shy;руг<span class="spacer"> </span>нас&shy;ле&shy;до&shy;ва&shy;ния<span class="spacer"> </span>стр&shy;оя&shy;тся<span class="spacer"> </span>вок&shy;руг<span class="spacer"> </span>при&shy;ме&shy;ров<span class="spacer"> </span>на<span class="spacer"> </span>ста&shy;тич&shy;ес&shy;ких<span class="spacer"> </span>ме&shy;то&shy;дах:<span class="spacer"> </span>по<span class="spacer"> </span>су&shy;ти,<span class="spacer"> </span>все<span class="spacer"> </span>ме&shy;то&shy;ды<span class="spacer"> </span> &mdash; <span class="spacer"> </span>ста&shy;тич&shy;ес&shy;кие.<span class="spacer"> </span>И<span class="spacer"> </span>эк&shy;земп&shy;ляр&shy;ные<span class="spacer"> </span>и<span class="spacer"> </span>нет.<span class="spacer"> </span>В<span class="spacer"> </span>па&shy;мя&shy;ти<span class="spacer"> </span>нет<span class="spacer"> </span>по&shy;эк&shy;земп&shy;ляр&shy;но<span class="spacer"> </span>ском&shy;пи&shy;ли&shy;ров&shy;ан&shy;ных<span class="spacer"> </span>ме&shy;то&shy;дов<span class="spacer"> </span>для<span class="spacer"> </span>каж&shy;до&shy;го<span class="spacer"> </span>эк&shy;земп&shy;ля&shy;ра<span class="spacer"> </span>клас&shy;са.<span class="spacer"> </span>Это<span class="spacer"> </span>за&shy;ни&shy;ма&shy;ло<span class="spacer"> </span>бы<span class="spacer"> </span>ог&shy;ром&shy;ное<span class="spacer"> </span>ко&shy;лич&shy;ес&shy;т&shy;во<span class="spacer"> </span>па&shy;мя&shy;ти:<span class="spacer"> </span>про&shy;ще<span class="spacer"> </span>од&shy;но&shy;му<span class="spacer"> </span>и<span class="spacer"> </span>то&shy;му<span class="spacer"> </span>же<span class="spacer"> </span>ме&shy;то&shy;ду<span class="spacer"> </span>каж&shy;дый<span class="spacer"> </span>раз<span class="spacer"> </span>пе&shy;ре&shy;да&shy;вать<span class="spacer"> </span>ссыл&shy;ку<span class="spacer"> </span>на<span class="spacer"> </span>эк&shy;земп&shy;ляр<span class="spacer"> </span>той<span class="spacer"> </span>струк&shy;ту&shy;ры<span class="spacer"> </span>или<span class="spacer"> </span>клас&shy;са,<span class="spacer"> </span>с<span class="spacer"> </span>ко&shy;то&shy;ры&shy;ми<span class="spacer"> </span>он<span class="spacer"> </span>ра&shy;бо&shy;та&shy;ет.</p>
</blockquote>
<div class="paragraph-container">
<div class="paragraph-left-side">27</div>
<p>Для<span class="spacer"> </span>ме&shy;то&shy;да<span class="spacer"> </span><code>Get&shy;Value</code><span class="spacer"> </span>все<span class="spacer"> </span>об&shy;сто&shy;ит<span class="spacer"> </span>сов&shy;ер&shy;шен&shy;но<span class="spacer"> </span>по-дру&shy;го&shy;му.<span class="spacer"> </span>Мы<span class="spacer"> </span>не<span class="spacer"> </span>мо&shy;жем<span class="spacer"> </span>прос&shy;то<span class="spacer"> </span>взять<span class="spacer"> </span>и<span class="spacer"> </span>пе&shy;ре&shy;оп&shy;ре&shy;де&shy;лить<span class="spacer"> </span>ме&shy;тод<span class="spacer"> </span>пе&shy;ре&shy;оп&shy;ре&shy;де&shy;ле&shy;ни&shy;ем<span class="spacer"> </span><em>ста&shy;тич&shy;ес&shy;ко&shy;го</em><span class="spacer"> </span><code>Get&shy;Value</code><span class="spacer"> </span>в<span class="spacer"> </span>унас&shy;ле&shy;дов&shy;ан&shy;ном<span class="spacer"> </span>ти&shy;пе:<span class="spacer"> </span>но&shy;вый<span class="spacer"> </span>ме&shy;тод<span class="spacer"> </span>по&shy;лу&shy;чит<span class="spacer"> </span>толь&shy;ко<span class="spacer"> </span>те<span class="spacer"> </span>учас&shy;тки<span class="spacer"> </span>ко&shy;да,<span class="spacer"> </span>ко&shy;то&shy;рые<span class="spacer"> </span>ра&shy;бо&shy;та&shy;ют<span class="spacer"> </span>с<span class="spacer"> </span>пе&shy;рем&shy;ен&shy;ной<span class="spacer"> </span>как<span class="spacer"> </span>с<span class="spacer"> </span><code>Overrided&shy;Sample</code>,<span class="spacer"> </span>а<span class="spacer"> </span>ес&shy;ли<span class="spacer"> </span>с<span class="spacer"> </span>пе&shy;рем&shy;ен&shy;ной<span class="spacer"> </span>ра&shy;бо&shy;тать<span class="spacer"> </span>как<span class="spacer"> </span>с<span class="spacer"> </span>пе&shy;рем&shy;ен&shy;ной<span class="spacer"> </span>ба&shy;зо&shy;во&shy;го<span class="spacer"> </span>ти&shy;па<span class="spacer"> </span><code>Sample</code>,<span class="spacer"> </span>выз&shy;вать<span class="spacer"> </span>смо&shy;же&shy;те<span class="spacer"> </span>толь&shy;ко<span class="spacer"> </span><code>Get&shy;Value</code><span class="spacer"> </span>ба&shy;зо&shy;во&shy;го<span class="spacer"> </span>ти&shy;па,<span class="spacer"> </span>пос&shy;коль&shy;ку<span class="spacer"> </span>вы<span class="spacer"> </span>по&shy;ня&shy;тия<span class="spacer"> </span>не<span class="spacer"> </span>име&shy;ете,<span class="spacer"> </span>ка&shy;ко&shy;го<span class="spacer"> </span>ти&shy;па<span class="spacer"> </span>на<span class="spacer"> </span>са&shy;мом<span class="spacer"> </span>де&shy;ле<span class="spacer"> </span>объект.<span class="spacer"> </span>Для<span class="spacer"> </span>то&shy;го<span class="spacer"> </span>что&shy;бы<span class="spacer"> </span>по&shy;ни&shy;мать,<span class="spacer"> </span>ка&shy;ко&shy;го<span class="spacer"> </span>ти&shy;па<span class="spacer"> </span>яв&shy;ля&shy;ет&shy;ся<span class="spacer"> </span>пе&shy;рем&shy;ен&shy;ная<span class="spacer"> </span>и,<span class="spacer"> </span>как<span class="spacer"> </span>рез&shy;уль&shy;тат,<span class="spacer"> </span>ка&shy;кой<span class="spacer"> </span>конк&shy;рет&shy;но<span class="spacer"> </span>ме&shy;тод<span class="spacer"> </span>вы&shy;зы&shy;ва&shy;ет&shy;ся,<span class="spacer"> </span>мы<span class="spacer"> </span>мо&shy;жем<span class="spacer"> </span>пос&shy;ту&shy;пить<span class="spacer"> </span>сле&shy;ду&shy;ю&shy;щим<span class="spacer"> </span>об&shy;ра&shy;зом:</p>
<div class="paragraph-right-side">27</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">void</span> Main()
{
    <span style="color:Blue;">var</span> sample = <span style="color:Blue;">new</span> Sample();
    <span style="color:Blue;">var</span> overrided = <span style="color:Blue;">new</span> OverridedSample();

    Console.WriteLine(sample.Virtuals[Sample.GetValuePosition].DynamicInvoke(sample));
    Console.WriteLine(overrided.Virtuals[Sample.GetValuePosition].DynamicInvoke(sample));
}

<span style="color:Blue;">public</span> <span style="color:Blue;">class</span> Sample
{
    <span style="color:Blue;">public</span> <span style="color:Blue;">const</span> <span style="color:Blue;">int</span> GetValuePosition = 0;

    <span style="color:Blue;">public</span> Delegate[] Virtuals;

    <span style="color:Blue;">public</span> <span style="color:Blue;">int</span> _x;

    <span style="color:Blue;">public</span> Sample()
    {
        Virtuals = <span style="color:Blue;">new</span> Delegate[1] { 
            <span style="color:Blue;">new</span> Func&lt;Sample, <span style="color:Blue;">int</span>&gt;(GetValue) 
        };
    }

    <span style="color:Blue;">public</span> <span style="color:Blue;">static</span> <span style="color:Blue;">void</span> ChangeTo(Sample self, <span style="color:Blue;">int</span> newValue)
    {
        self._x = newValue;
    }

    <span style="color:Blue;">public</span> <span style="color:Blue;">static</span> <span style="color:Blue;">int</span> GetValue(Sample self)
    {
        <span style="color:Blue;">return</span> self._x;
    }
}

<span style="color:Blue;">public</span> <span style="color:Blue;">class</span> OverridedSample : Sample
{
    <span style="color:Blue;">public</span> OverridedSample() : <span style="color:Blue;">base</span>()
    {
        Virtuals[0] = <span style="color:Blue;">new</span> Func&lt;Sample, <span style="color:Blue;">int</span>&gt;(GetValue);
    }

    <span style="color:Blue;">public</span> <span style="color:Blue;">static</span> <span style="color:Blue;">new</span> <span style="color:Blue;">int</span> GetValue(Sample self)
    {
        <span style="color:Blue;">return</span> 666;
    }
}
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">28</div>
<p>В<span class="spacer"> </span>этом<span class="spacer"> </span>при&shy;ме&shy;ре<span class="spacer"> </span>мы<span class="spacer"> </span>фак&shy;тич&shy;ес&shy;ки<span class="spacer"> </span>стр&shy;оим<span class="spacer"> </span>таб&shy;ли&shy;цу<span class="spacer"> </span>вир&shy;ту&shy;аль&shy;ных<span class="spacer"> </span>ме&shy;то&shy;дов<span class="spacer"> </span>вруч&shy;ную,<span class="spacer"> </span>а<span class="spacer"> </span>вы&shy;зо&shy;вы<span class="spacer"> </span>де&shy;ла&shy;ем<span class="spacer"> </span>по<span class="spacer"> </span>по&shy;зи&shy;ции<span class="spacer"> </span>ме&shy;то&shy;да<span class="spacer"> </span>в<span class="spacer"> </span>этой<span class="spacer"> </span>таб&shy;ли&shy;це.<span class="spacer"> </span>Если<span class="spacer"> </span>вы<span class="spacer"> </span>по&shy;ня&shy;ли<span class="spacer"> </span>суть<span class="spacer"> </span>при&shy;ме&shy;ра,<span class="spacer"> </span>то<span class="spacer"> </span>вы<span class="spacer"> </span>фак&shy;тич&shy;ес&shy;ки<span class="spacer"> </span>по&shy;ня&shy;ли,<span class="spacer"> </span>как<span class="spacer"> </span>стр&shy;ои&shy;тся<span class="spacer"> </span>нас&shy;ле&shy;до&shy;ва&shy;ние<span class="spacer"> </span>на<span class="spacer"> </span>уровне<span class="spacer"> </span>ском&shy;пи&shy;ли&shy;ров&shy;ан&shy;но&shy;го<span class="spacer"> </span>ко&shy;да:<span class="spacer"> </span>ме&shy;то&shy;ды<span class="spacer"> </span>вы&shy;зы&shy;ва&shy;ют&shy;ся<span class="spacer"> </span>по<span class="spacer"> </span>сво&shy;е&shy;му<span class="spacer"> </span>ин&shy;дек&shy;су<span class="spacer"> </span>в<span class="spacer"> </span>таб&shy;ли&shy;це<span class="spacer"> </span>вир&shy;ту&shy;аль&shy;ных<span class="spacer"> </span>ме&shy;то&shy;дов.<span class="spacer"> </span>Прос&shy;то<span class="spacer"> </span>ког&shy;да<span class="spacer"> </span>вы<span class="spacer"> </span>соз&shy;даёте<span class="spacer"> </span>эк&shy;земп&shy;ляр<span class="spacer"> </span>не&shy;ко&shy;то&shy;ро&shy;го<span class="spacer"> </span>унас&shy;ле&shy;дов&shy;ан&shy;ного<span class="spacer"> </span>ти&shy;па,<span class="spacer"> </span>то<span class="spacer"> </span>в<span class="spacer"> </span>его<span class="spacer"> </span>VMT<span class="spacer"> </span>по<span class="spacer"> </span>мес&shy;там,<span class="spacer"> </span>где<span class="spacer"> </span>у<span class="spacer"> </span>ба&shy;зо&shy;во&shy;го<span class="spacer"> </span>ти&shy;па<span class="spacer"> </span>на&shy;ход&shy;ят&shy;ся<span class="spacer"> </span>вир&shy;ту&shy;аль&shy;ные<span class="spacer"> </span>ме&shy;то&shy;ды,<span class="spacer"> </span>ком&shy;пи&shy;ля&shy;тор<span class="spacer"> </span>рас&shy;по&shy;ло&shy;жит<span class="spacer"> </span>ука&shy;за&shy;тели<span class="spacer"> </span>на<span class="spacer"> </span>пе&shy;ре&shy;оп&shy;ре&shy;делённые<span class="spacer"> </span>ме&shy;то&shy;ды,<span class="spacer"> </span>ско&shy;пи&shy;ро&shy;вав<span class="spacer"> </span>из<span class="spacer"> </span>ба&shy;зо&shy;во&shy;го<span class="spacer"> </span>ти&shy;па<span class="spacer"> </span>ука&shy;за&shy;тели<span class="spacer"> </span>на<span class="spacer"> </span>ме&shy;то&shy;ды,<span class="spacer"> </span>ко&shy;то&shy;рые<span class="spacer"> </span>не<span class="spacer"> </span>пе&shy;ре&shy;оп&shy;ре&shy;де&shy;ля&shy;лись.<span class="spacer"> </span>Та&shy;ким<span class="spacer"> </span>об&shy;ра&shy;зом,<span class="spacer"> </span>от&shy;ли&shy;чие<span class="spacer"> </span>на&shy;ше&shy;го<span class="spacer"> </span>при&shy;ме&shy;ра<span class="spacer"> </span>от<span class="spacer"> </span>ре&shy;аль&shy;ной<span class="spacer"> </span>VMT<span class="spacer"> </span>зак&shy;лю&shy;ча&shy;ет&shy;ся<span class="spacer"> </span>толь&shy;ко<span class="spacer"> </span>в<span class="spacer"> </span>том,<span class="spacer"> </span>что<span class="spacer"> </span>ког&shy;да<span class="spacer"> </span>ком&shy;пи&shy;ля&shy;тор<span class="spacer"> </span>стр&shy;оит<span class="spacer"> </span>эту<span class="spacer"> </span>таб&shy;ли&shy;цу,<span class="spacer"> </span>он<span class="spacer"> </span>за&shy;ра&shy;нее<span class="spacer"> </span>зна&shy;ет,<span class="spacer"> </span>с<span class="spacer"> </span>чем<span class="spacer"> </span>имеет<span class="spacer"> </span>де&shy;ло<span class="spacer"> </span>и<span class="spacer"> </span>соз&shy;даёт<span class="spacer"> </span>таб&shy;ли&shy;цу<span class="spacer"> </span>пра&shy;виль&shy;но&shy;го<span class="spacer"> </span>раз&shy;ме&shy;ра<span class="spacer"> </span>и<span class="spacer"> </span>нап&shy;ол&shy;не&shy;ния<span class="spacer"> </span>сра&shy;зу<span class="spacer"> </span>же:<span class="spacer"> </span>в<span class="spacer"> </span>на&shy;шем<span class="spacer"> </span>при&shy;ме&shy;ре<span class="spacer"> </span>что&shy;бы<span class="spacer"> </span>пос&shy;тро&shy;ить<span class="spacer"> </span>таб&shy;ли&shy;цу<span class="spacer"> </span>для<span class="spacer"> </span>ти&shy;пов,<span class="spacer"> </span>ко&shy;то&shy;рые<span class="spacer"> </span>бу&shy;дут<span class="spacer"> </span>де&shy;лать<span class="spacer"> </span>таб&shy;ли&shy;цу<span class="spacer"> </span>бо&shy;лее<span class="spacer"> </span>круп&shy;ной<span class="spacer"> </span>за<span class="spacer"> </span>счёт<span class="spacer"> </span>доб&shy;ав&shy;ле&shy;ния<span class="spacer"> </span>но&shy;вых<span class="spacer"> </span>ме&shy;то&shy;дов,<span class="spacer"> </span>придётся<span class="spacer"> </span>из&shy;ряд&shy;но<span class="spacer"> </span>по&shy;по&shy;теть.<span class="spacer"> </span>Но<span class="spacer"> </span>на&shy;ша<span class="spacer"> </span>за&shy;да&shy;ча<span class="spacer"> </span>зак&shy;лю&shy;ча&shy;ет&shy;ся<span class="spacer"> </span>в<span class="spacer"> </span>дру&shy;гом,<span class="spacer"> </span>а<span class="spacer"> </span>по&shy;то&shy;му<span class="spacer"> </span>та&shy;ки&shy;ми<span class="spacer"> </span>из&shy;вра&shy;ще&shy;ни&shy;я&shy;ми<span class="spacer"> </span>мы<span class="spacer"> </span>за&shy;ним&shy;ать&shy;ся<span class="spacer"> </span>не<span class="spacer"> </span>ста&shy;нем.</p>
<div class="paragraph-right-side">28</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">29</div>
<p>Вто&shy;рой<span class="spacer"> </span>воп&shy;рос,<span class="spacer"> </span>ко&shy;то&shy;рый<span class="spacer"> </span>воз&shy;ни&shy;ка&shy;ет<span class="spacer"> </span>сра&shy;зу<span class="spacer"> </span>пос&shy;ле<span class="spacer"> </span>от&shy;ве&shy;та<span class="spacer"> </span>на<span class="spacer"> </span>пер&shy;вый:<span class="spacer"> </span>ес&shy;ли<span class="spacer"> </span>с<span class="spacer"> </span>ме&shy;то&shy;да&shy;ми<span class="spacer"> </span>те&shy;перь<span class="spacer"> </span>все<span class="spacer"> </span>яс&shy;но,<span class="spacer"> </span>то<span class="spacer"> </span>за&shy;чем<span class="spacer"> </span>тог&shy;да<span class="spacer"> </span>в<span class="spacer"> </span><code>VMT</code><span class="spacer"> </span>на&shy;ход&shy;ят&shy;ся<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;сы?<span class="spacer"> </span>Интер&shy;фей&shy;сы,<span class="spacer"> </span>ес&shy;ли<span class="spacer"> </span>раз&shy;мыш&shy;лять<span class="spacer"> </span>ло&shy;гич&shy;ес&shy;ки,<span class="spacer"> </span>не<span class="spacer"> </span>вхо&shy;дят<span class="spacer"> </span>в<span class="spacer"> </span>струк&shy;ту&shy;ру<span class="spacer"> </span>пря&shy;мо&shy;го<span class="spacer"> </span>нас&shy;ле&shy;до&shy;ва&shy;ния.<span class="spacer"> </span>Они<span class="spacer"> </span>на&shy;ход&shy;ят&shy;ся<span class="spacer"> </span>как<span class="spacer"> </span>бы<span class="spacer"> </span>сбо&shy;ку,<span class="spacer"> </span>ука&shy;зы&shy;вая,<span class="spacer"> </span>что<span class="spacer"> </span>те<span class="spacer"> </span>или<span class="spacer"> </span>иные<span class="spacer"> </span>ти&shy;пы<span class="spacer"> </span>обя&shy;заны<span class="spacer"> </span>ре&shy;а&shy;ли&shy;зо&shy;вы&shy;вать<span class="spacer"> </span>не&shy;ко&shy;то&shy;рый<span class="spacer"> </span>на&shy;бор<span class="spacer"> </span>ме&shy;то&shy;дов.<span class="spacer"> </span>Иметь,<span class="spacer"> </span>по<span class="spacer"> </span>су&shy;ти,<span class="spacer"> </span>не&shy;ко&shy;то&shy;рый<span class="spacer"> </span>про&shy;то&shy;кол<span class="spacer"> </span>вза&shy;и&shy;мод&shy;е&shy;йствия.<span class="spacer"> </span>Одна&shy;ко,<span class="spacer"> </span>хоть<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;сы<span class="spacer"> </span>и<span class="spacer"> </span>на&shy;ход&shy;ят&shy;ся<span class="spacer"> </span><em>сбо&shy;ку</em><span class="spacer"> </span>от<span class="spacer"> </span>пря&shy;мо&shy;го<span class="spacer"> </span>нас&shy;ле&shy;до&shy;ва&shy;ния,<span class="spacer"> </span>вы&shy;зы&shy;вать<span class="spacer"> </span>ме&shy;то&shy;ды<span class="spacer"> </span>все<span class="spacer"> </span>рав&shy;но<span class="spacer"> </span>мож&shy;но.<span class="spacer"> </span>Причём,<span class="spacer"> </span>зам&shy;еть&shy;те:<span class="spacer"> </span>ес&shy;ли<span class="spacer"> </span>вы<span class="spacer"> </span>ис&shy;поль&shy;зу&shy;е&shy;те<span class="spacer"> </span>пе&shy;рем&shy;ен&shy;ную<span class="spacer"> </span>ин&shy;тер&shy;фейс&shy;но&shy;го<span class="spacer"> </span>ти&shy;па,<span class="spacer"> </span>то<span class="spacer"> </span>за<span class="spacer"> </span>ней<span class="spacer"> </span>мо&shy;гут<span class="spacer"> </span>скры&shy;вать&shy;ся<span class="spacer"> </span>ка&shy;кие<span class="spacer"> </span>угодно<span class="spacer"> </span>клас&shy;сы,<span class="spacer"> </span>ба&shy;зо&shy;вый<span class="spacer"> </span>тип<span class="spacer"> </span>у<span class="spacer"> </span>ко&shy;то&shy;рых<span class="spacer"> </span>мо&shy;жет<span class="spacer"> </span>быть<span class="spacer"> </span>раз&shy;ве<span class="spacer"> </span>что<span class="spacer"> </span><code>System&shy;.Object</code>.<span class="spacer"> </span>Т.е.<span class="spacer"> </span>ме&shy;то&shy;ды<span class="spacer"> </span>в<span class="spacer"> </span>таб&shy;ли&shy;це<span class="spacer"> </span>вир&shy;ту&shy;аль&shy;ных<span class="spacer"> </span>ме&shy;то&shy;дов,<span class="spacer"> </span>ко&shy;то&shy;рые<span class="spacer"> </span>ре&shy;а&shy;ли&shy;зу&shy;ют<span class="spacer"> </span>ин&shy;тер&shy;фейс,<span class="spacer"> </span>мо&shy;гут<span class="spacer"> </span>на&shy;ход&shy;ить&shy;ся<span class="spacer"> </span>сов&shy;ер&shy;шен&shy;но<span class="spacer"> </span>по<span class="spacer"> </span>раз&shy;ным<span class="spacer"> </span>мес&shy;там.<span class="spacer"> </span>Как<span class="spacer"> </span>же<span class="spacer"> </span>вы&shy;зов<span class="spacer"> </span>ме&shy;то&shy;дов<span class="spacer"> </span>ра&shy;бо&shy;та&shy;ет<span class="spacer"> </span>в<span class="spacer"> </span>этом<span class="spacer"> </span>слу&shy;чае?</p>
<div class="paragraph-right-side">29</div>
</div>
<h2 id="virtual-stub-dispatch-vsd-in-progress">Virtual<span class="spacer"> </span>Stub<span class="spacer"> </span>Dispatch<span class="spacer"> </span>(VSD)<span class="spacer"> </span>[In<span class="spacer"> </span>Progress&shy;]</h2>
<div class="paragraph-container">
<div class="paragraph-left-side">30</div>
<p>Что&shy;бы<span class="spacer"> </span>раз&shy;об&shy;рать&shy;ся<span class="spacer"> </span>в<span class="spacer"> </span>этом<span class="spacer"> </span>воп&shy;ро&shy;се,<span class="spacer"> </span>не&shy;об&shy;хо&shy;ди&shy;мо<span class="spacer"> </span>доп&shy;ол&shy;нит&shy;ель&shy;но<span class="spacer"> </span>вспом&shy;нить,<span class="spacer"> </span>что<span class="spacer"> </span>ре&shy;а&shy;ли&shy;зо&shy;вать<span class="spacer"> </span>ин&shy;тер&shy;фейс<span class="spacer"> </span>мож&shy;но<span class="spacer"> </span>дву&shy;мя<span class="spacer"> </span>пу&shy;тя&shy;ми:<span class="spacer"> </span>сде&shy;лать<span class="spacer"> </span>мож&shy;но<span class="spacer"> </span>ли&shy;бо<span class="spacer"> </span><code>implicit</code><span class="spacer"> </span>ре&shy;а&shy;ли&shy;за&shy;цию,<span class="spacer"> </span>ли&shy;бо<span class="spacer"> </span><code>explicit</code>.<span class="spacer"> </span>Причём<span class="spacer"> </span>сде&shy;лать<span class="spacer"> </span>это<span class="spacer"> </span>мож&shy;но<span class="spacer"> </span>час&shy;тич&shy;но:<span class="spacer"> </span>часть<span class="spacer"> </span>ме&shy;то&shy;дов<span class="spacer"> </span>сде&shy;лать<span class="spacer"> </span><code>implicit</code>,<span class="spacer"> </span>а<span class="spacer"> </span>часть<span class="spacer"> </span> &mdash; <span class="spacer"> </span><code>explicit</code>.<span class="spacer"> </span>Эта<span class="spacer"> </span>воз&shy;мож&shy;ность<span class="spacer"> </span>на<span class="spacer"> </span>са&shy;мом<span class="spacer"> </span>де&shy;ле<span class="spacer"> </span> &mdash; <span class="spacer"> </span>след&shy;с&shy;твие<span class="spacer"> </span>ре&shy;а&shy;ли&shy;за&shy;ции<span class="spacer"> </span>и<span class="spacer"> </span>воз&shy;мож&shy;но<span class="spacer"> </span>да&shy;же<span class="spacer"> </span>не<span class="spacer"> </span>яв&shy;ля&shy;ет&shy;ся<span class="spacer"> </span>за&shy;ра&shy;нее<span class="spacer"> </span>про&shy;дум&shy;ан&shy;ной:<span class="spacer"> </span>ре&shy;а&shy;ли&shy;зуя<span class="spacer"> </span>ин&shy;тер&shy;фейс,<span class="spacer"> </span>вы<span class="spacer"> </span>по&shy;ка&shy;зы&shy;ва&shy;е&shy;те<span class="spacer"> </span>яв&shy;но<span class="spacer"> </span>или<span class="spacer"> </span>не&shy;яв&shy;но,<span class="spacer"> </span>что<span class="spacer"> </span>в<span class="spacer"> </span>не&shy;го<span class="spacer"> </span>вхо&shy;дит.<span class="spacer"> </span>Часть<span class="spacer"> </span>ме&shy;то&shy;дов<span class="spacer"> </span>клас&shy;са<span class="spacer"> </span>мо&shy;жет<span class="spacer"> </span>не<span class="spacer"> </span>вхо&shy;дить<span class="spacer"> </span>в<span class="spacer"> </span>ин&shy;тер&shy;фейс,<span class="spacer"> </span>а<span class="spacer"> </span>ме&shy;то&shy;ды,<span class="spacer"> </span>сущ&shy;ес&shy;тву&shy;ю&shy;щие<span class="spacer"> </span>в<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;се,<span class="spacer"> </span>мо&shy;гут<span class="spacer"> </span>не<span class="spacer"> </span>сущ&shy;ес&shy;тво&shy;вать<span class="spacer"> </span>в<span class="spacer"> </span>клас&shy;се<span class="spacer"> </span>(они,<span class="spacer"> </span>кон&shy;еч&shy;но,<span class="spacer"> </span>сущ&shy;ес&shy;тву&shy;ют<span class="spacer"> </span>в<span class="spacer"> </span>клас&shy;се,<span class="spacer"> </span>но<span class="spacer"> </span>син&shy;так&shy;сис<span class="spacer"> </span>по&shy;ка&shy;зы&shy;ва&shy;ет,<span class="spacer"> </span>что<span class="spacer"> </span>ар&shy;хит&shy;ек&shy;тур&shy;но<span class="spacer"> </span>час&shy;тью<span class="spacer"> </span>клас&shy;са<span class="spacer"> </span>они<span class="spacer"> </span>не<span class="spacer"> </span>яв&shy;ля&shy;ют&shy;ся):<span class="spacer"> </span>класс<span class="spacer"> </span>и<span class="spacer"> </span>ин&shy;тер&shy;фейс<span class="spacer"> </span> &mdash; <span class="spacer"> </span>это<span class="spacer"> </span>в<span class="spacer"> </span>не&shy;ко&shy;то&shy;ром,<span class="spacer"> </span>смыс&shy;ле<span class="spacer"> </span> &mdash; <span class="spacer"> </span>пар&shy;ал&shy;лель&shy;ные<span class="spacer"> </span>иера&shy;рхии<span class="spacer"> </span>ти&shy;пов.<span class="spacer"> </span>Так&shy;же,<span class="spacer"> </span>в<span class="spacer"> </span>плюс<span class="spacer"> </span>к<span class="spacer"> </span>этому,<span class="spacer"> </span>ин&shy;тер&shy;фейс<span class="spacer"> </span> &mdash; <span class="spacer"> </span>это<span class="spacer"> </span>от&shy;дель&shy;ный<span class="spacer"> </span>тип,<span class="spacer"> </span>а<span class="spacer"> </span>зна&shy;чит,<span class="spacer"> </span>у<span class="spacer"> </span>каж&shy;до&shy;го<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;са<span class="spacer"> </span>есть<span class="spacer"> </span>собст&shy;венная<span class="spacer"> </span>таб&shy;ли&shy;ца<span class="spacer"> </span>вир&shy;ту&shy;аль&shy;ных<span class="spacer"> </span>ме&shy;то&shy;дов:<span class="spacer"> </span>что&shy;бы<span class="spacer"> </span>каж&shy;дый<span class="spacer"> </span>смог<span class="spacer"> </span>вы&shy;зы&shy;вать<span class="spacer"> </span>ме&shy;то&shy;ды<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;са.</p>
<div class="paragraph-right-side">30</div>
</div>
<p>Дав&shy;ай&shy;те<span class="spacer"> </span>взгл&shy;янем<span class="spacer"> </span>на<span class="spacer"> </span>таб&shy;ли&shy;цу:<span class="spacer"> </span>как<span class="spacer"> </span>бы<span class="spacer"> </span>мог&shy;ли<span class="spacer"> </span>выг&shy;ля&shy;деть<span class="spacer"> </span>VMT<span class="spacer"> </span>раз&shy;лич&shy;ных<span class="spacer"> </span>ти&shy;пов:</p>
<div class="table-container">
<div class="table-width-6 table-cols-3">
<table>
<thead>
<tr>
<th>inter&shy;face<span class="spacer"> </span>IFoo</th>
<th>class<span class="spacer"> </span>A<span class="spacer"> </span>:<span class="spacer"> </span>IFoo</th>
<th>class<span class="spacer"> </span>B<span class="spacer"> </span>:<span class="spacer"> </span>IFoo</th>
</tr>
</thead>
<tbody>
<tr>
<td>-><span class="spacer"> </span>Get&shy;Value&shy;()</td>
<td>Sample&shy;Method&shy;()</td>
<td>Run&shy;Process&shy;()</td>
</tr>
<tr>
<td>-><span class="spacer"> </span>Set&shy;Value&shy;()</td>
<td>Go&shy;()</td>
<td>-><span class="spacer"> </span>Get&shy;Value&shy;()</td>
</tr>
<tr>
<td></td>
<td>-><span class="spacer"> </span>Get&shy;Value&shy;()</td>
<td>-><span class="spacer"> </span>Set&shy;Value&shy;()</td>
</tr>
<tr>
<td></td>
<td>-><span class="spacer"> </span>Set&shy;Value&shy;()</td>
<td>Look&shy;To&shy;Moon&shy;()</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">31</div>
<p>VMT<span class="spacer"> </span>всех<span class="spacer"> </span>трёх<span class="spacer"> </span>ти&shy;пов<span class="spacer"> </span>сод&shy;ер&shy;жат<span class="spacer"> </span>не&shy;об&shy;хо&shy;ди&shy;мые<span class="spacer"> </span>ме&shy;то&shy;ды<span class="spacer"> </span><code>Get&shy;Value</code><span class="spacer"> </span>и<span class="spacer"> </span><code>Set&shy;Value</code>,<span class="spacer"> </span>од&shy;на&shy;ко<span class="spacer"> </span>они<span class="spacer"> </span>на&shy;ход&shy;ят&shy;ся<span class="spacer"> </span>по<span class="spacer"> </span>раз&shy;ным<span class="spacer"> </span>ин&shy;дек&shy;сам:<span class="spacer"> </span>они<span class="spacer"> </span>не<span class="spacer"> </span>мо&shy;гут<span class="spacer"> </span>вез&shy;де<span class="spacer"> </span>быть<span class="spacer"> </span>по<span class="spacer"> </span>од&shy;ним<span class="spacer"> </span>и<span class="spacer"> </span>тем<span class="spacer"> </span>же<span class="spacer"> </span>ин&shy;дек&shy;сам,<span class="spacer"> </span>пос&shy;коль&shy;ку<span class="spacer"> </span>бы&shy;ла<span class="spacer"> </span>бы<span class="spacer"> </span>кон&shy;кур&shy;ен&shy;ция<span class="spacer"> </span>за<span class="spacer"> </span>ин&shy;дек&shy;сы<span class="spacer"> </span>с<span class="spacer"> </span>дру&shy;ги&shy;ми<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;са&shy;ми<span class="spacer"> </span>клас&shy;са.<span class="spacer"> </span>На<span class="spacer"> </span>са&shy;мом<span class="spacer"> </span>де&shy;ле<span class="spacer"> </span>для<span class="spacer"> </span>каж&shy;до&shy;го<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;са<span class="spacer"> </span>соз&shy;даётся<span class="spacer"> </span>ин&shy;тер&shy;фейс<span class="spacer"> </span> &mdash; <span class="spacer"> </span>дубль<span class="spacer"> </span> &mdash; <span class="spacer"> </span>для<span class="spacer"> </span>каж&shy;дой<span class="spacer"> </span>его<span class="spacer"> </span>ре&shy;а&shy;ли&shy;за&shy;ции<span class="spacer"> </span>в<span class="spacer"> </span>каж&shy;дом<span class="spacer"> </span>клас&shy;се.<span class="spacer"> </span>Име&shy;ем<span class="spacer"> </span>633<span class="spacer"> </span>ре&shy;а&shy;ли&shy;за&shy;ции<span class="spacer"> </span><code>IDispos&shy;able</code><span class="spacer"> </span>в<span class="spacer"> </span>клас&shy;сах<span class="spacer"> </span>FCL/BCL?<span class="spacer"> </span>Зна&shy;чит<span class="spacer"> </span>имеем<span class="spacer"> </span>633<span class="spacer"> </span>доп&shy;ол&shy;нит&shy;ель&shy;ных<span class="spacer"> </span><code>IDispos&shy;able</code><span class="spacer"> </span>ин&shy;тер&shy;фей&shy;са<span class="spacer"> </span>что&shy;бы<span class="spacer"> </span>под&shy;дер&shy;жать<span class="spacer"> </span>VMT<span class="spacer"> </span>to<span class="spacer"> </span>VMT<span class="spacer"> </span>транс&shy;ля&shy;цию<span class="spacer"> </span>для<span class="spacer"> </span>каж&shy;до&shy;го<span class="spacer"> </span>из<span class="spacer"> </span>клас&shy;сов<span class="spacer"> </span>+<span class="spacer"> </span>за&shy;пись<span class="spacer"> </span>в<span class="spacer"> </span>каж&shy;дом<span class="spacer"> </span>клас&shy;се<span class="spacer"> </span>с<span class="spacer"> </span>ссыл&shy;кой<span class="spacer"> </span>на<span class="spacer"> </span>его<span class="spacer"> </span>ре&shy;а&shy;ли&shy;за&shy;цию<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;сом.<span class="spacer"> </span>На&shy;зовём<span class="spacer"> </span>та&shy;кие<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;сы<span class="spacer"> </span><strong>част&shy;ны&shy;ми<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;са&shy;ми</strong>.<span class="spacer"> </span>Т.е.<span class="spacer"> </span>каж&shy;дый<span class="spacer"> </span>класс<span class="spacer"> </span>имеет<span class="spacer"> </span>свои<span class="spacer"> </span>собст&shy;венные,<span class="spacer"> </span><strong>час&shy;т&shy;ные<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;сы</strong>,<span class="spacer"> </span>ко&shy;то&shy;рые<span class="spacer"> </span>яв&shy;ля&shy;ют&shy;ся<span class="spacer"> </span>&laquo;сис&shy;тем&shy;ны&shy;ми&raquo;<span class="spacer"> </span>и<span class="spacer"> </span>яв&shy;ля&shy;ют&shy;ся<span class="spacer"> </span>прок&shy;си<span class="spacer"> </span>ти&shy;па&shy;ми<span class="spacer"> </span>до<span class="spacer"> </span>ре&shy;аль&shy;но&shy;го<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;са.</p>
<div class="paragraph-right-side">31</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">32</div>
<p>Та&shy;ким<span class="spacer"> </span>об&shy;ра&shy;зом,<span class="spacer"> </span>по&shy;лу&shy;ча&shy;ет&shy;ся<span class="spacer"> </span>сле&shy;ду&shy;ю&shy;щее:<span class="spacer"> </span>у<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;сов<span class="spacer"> </span>так&shy;же<span class="spacer"> </span>как<span class="spacer"> </span>и<span class="spacer"> </span>у<span class="spacer"> </span>клас&shy;сов<span class="spacer"> </span>есть<span class="spacer"> </span>нас&shy;ле&shy;до&shy;ва&shy;ние<span class="spacer"> </span>вир&shy;ту&shy;аль&shy;ных<span class="spacer"> </span><em>ин&shy;тер&shy;фейс&shy;ных</em><span class="spacer"> </span>ме&shy;то&shy;дов,<span class="spacer"> </span>од&shy;на&shy;ко<span class="spacer"> </span>нас&shy;ле&shy;до&shy;ва&shy;ние<span class="spacer"> </span>это<span class="spacer"> </span>ра&shy;бо&shy;та&shy;ет<span class="spacer"> </span>не<span class="spacer"> </span>толь&shy;ко<span class="spacer"> </span>при<span class="spacer"> </span>нас&shy;ле&shy;до&shy;ва&shy;нии<span class="spacer"> </span>од&shy;но&shy;го<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;са<span class="spacer"> </span>от<span class="spacer"> </span>дру&shy;го&shy;го,<span class="spacer"> </span>но<span class="spacer"> </span>и<span class="spacer"> </span>при<span class="spacer"> </span>ре&shy;а&shy;ли&shy;за&shy;ции<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;са<span class="spacer"> </span>клас&shy;сом.<span class="spacer"> </span>Ког&shy;да<span class="spacer"> </span>класс<span class="spacer"> </span>ре&shy;а&shy;ли&shy;зу&shy;ет<span class="spacer"> </span>не&shy;кий<span class="spacer"> </span>ин&shy;тер&shy;фейс,<span class="spacer"> </span>то<span class="spacer"> </span>соз&shy;даётся<span class="spacer"> </span>доп&shy;ол&shy;нит&shy;ель&shy;ный<span class="spacer"> </span>ин&shy;тер&shy;фейс,<span class="spacer"> </span>уточ&shy;ня&shy;ю&shy;щий<span class="spacer"> </span>ка&shy;кие<span class="spacer"> </span>ме&shy;то&shy;ды<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;са-ро&shy;ди&shy;те&shy;ля<span class="spacer"> </span>на<span class="spacer"> </span>ка&shy;кие<span class="spacer"> </span>ме&shy;то&shy;ды<span class="spacer"> </span>кон&shy;еч&shy;но&shy;го<span class="spacer"> </span>клас&shy;са<span class="spacer"> </span>дол&shy;ж&shy;ны<span class="spacer"> </span>отоб&shy;раж&shy;аться.<span class="spacer"> </span>Вы&shy;зы&shy;вая<span class="spacer"> </span>ме&shy;тод<span class="spacer"> </span>по<span class="spacer"> </span>ин&shy;тер&shy;фейс&shy;ной<span class="spacer"> </span>пе&shy;рем&shy;ен&shy;ной,<span class="spacer"> </span>вы<span class="spacer"> </span>точ&shy;но<span class="spacer"> </span>так&shy;же<span class="spacer"> </span>вы&shy;зы&shy;ва&shy;е&shy;те<span class="spacer"> </span>ме&shy;тод<span class="spacer"> </span>по<span class="spacer"> </span>ин&shy;дек&shy;су<span class="spacer"> </span>из<span class="spacer"> </span>мас&shy;си&shy;ва<span class="spacer"> </span>VMT,<span class="spacer"> </span>как<span class="spacer"> </span>это<span class="spacer"> </span>де&shy;ла&shy;лось<span class="spacer"> </span>в<span class="spacer"> </span>слу&shy;чае<span class="spacer"> </span>с<span class="spacer"> </span>клас&shy;са&shy;ми,<span class="spacer"> </span>од&shy;на&shy;ко<span class="spacer"> </span>для<span class="spacer"> </span>дан&shy;ной<span class="spacer"> </span>ре&shy;а&shy;ли&shy;за&shy;ции<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;са<span class="spacer"> </span>вы<span class="spacer"> </span>по<span class="spacer"> </span>ин&shy;дек&shy;су<span class="spacer"> </span>вы&shy;бе&shy;ри&shy;те<span class="spacer"> </span>слот<span class="spacer"> </span>из<span class="spacer"> </span><em>унас&shy;ле&shy;дов&shy;ан&shy;ного</em>,<span class="spacer"> </span>не&shy;ви&shy;ди&shy;мо&shy;го<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;са,<span class="spacer"> </span>свя&shy;зы&shy;ва&shy;ю&shy;ще&shy;го<span class="spacer"> </span>ори&shy;гин&shy;аль&shy;ный<span class="spacer"> </span>ин&shy;тер&shy;фейс<span class="spacer"> </span><code>IDispos&shy;able</code><span class="spacer"> </span>с<span class="spacer"> </span>на&shy;шим<span class="spacer"> </span>клас&shy;сом,<span class="spacer"> </span>ин&shy;тер&shy;фейс<span class="spacer"> </span>ре&shy;а&shy;ли&shy;зу&shy;ю&shy;щим.</p>
<div class="paragraph-right-side">32</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">33</div>
<p>Дис&shy;пет&shy;че&shy;ри&shy;за&shy;ция<span class="spacer"> </span>вир&shy;ту&shy;аль&shy;ных<span class="spacer"> </span>ме&shy;то&shy;дов<span class="spacer"> </span>че&shy;рез<span class="spacer"> </span>заг&shy;луш&shy;ки<span class="spacer"> </span>или<span class="spacer"> </span><strong>Virtual<span class="spacer"> </span>Stub<span class="spacer"> </span>Dispatch<span class="spacer"> </span>(VSD)</strong><span class="spacer"> </span>бы&shy;ла<span class="spacer"> </span>раз&shy;ра&shy;бо&shy;та&shy;на<span class="spacer"> </span>ещё<span class="spacer"> </span>в<span class="spacer"> </span>2006<span class="spacer"> </span>го&shy;ду<span class="spacer"> </span>как<span class="spacer"> </span>за&shy;ме&shy;на<span class="spacer"> </span>таб&shy;ли&shy;цам<span class="spacer"> </span>вир&shy;ту&shy;аль&shy;ных<span class="spacer"> </span>ме&shy;то&shy;дов<span class="spacer"> </span>в<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;сах.<span class="spacer"> </span>Основ&shy;ная<span class="spacer"> </span>идея<span class="spacer"> </span>этого<span class="spacer"> </span>под&shy;хо&shy;да<span class="spacer"> </span>сос&shy;то&shy;ит<span class="spacer"> </span>в<span class="spacer"> </span>уп&shy;ро&shy;ще&shy;нии<span class="spacer"> </span>ко&shy;до&shy;ге&shy;не&shy;ра&shy;ции<span class="spacer"> </span>и<span class="spacer"> </span>пос&shy;ле&shy;ду&shy;ю&shy;ще&shy;го<span class="spacer"> </span>уп&shy;ро&shy;ще&shy;ния<span class="spacer"> </span>вы&shy;зо&shy;ва<span class="spacer"> </span>ме&shy;то&shy;дов,<span class="spacer"> </span>т.к.<span class="spacer"> </span>пер&shy;вич&shy;ная<span class="spacer"> </span>ре&shy;а&shy;ли&shy;за&shy;ция<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;сов<span class="spacer"> </span>на<span class="spacer"> </span>VMT<span class="spacer"> </span>бы&shy;ла<span class="spacer"> </span>бы<span class="spacer"> </span>очень<span class="spacer"> </span>гро&shy;мозд&shy;кой<span class="spacer"> </span>и<span class="spacer"> </span>тре&shy;бо&shy;ва&shy;ла<span class="spacer"> </span>бы<span class="spacer"> </span>боль&shy;шо&shy;го<span class="spacer"> </span>ко&shy;лич&shy;ес&shy;т&shy;ва<span class="spacer"> </span>ра&shy;бо&shy;ты<span class="spacer"> </span>и<span class="spacer"> </span>вре&shy;ме&shy;ни<span class="spacer"> </span>для<span class="spacer"> </span>пос&shy;тро&shy;е&shy;ния<span class="spacer"> </span>всех<span class="spacer"> </span>струк&shy;тур<span class="spacer"> </span>всех<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;сов.<span class="spacer"> </span>Сам<span class="spacer"> </span>код<span class="spacer"> </span>дис&shy;пет&shy;че&shy;ри&shy;за&shy;ции<span class="spacer"> </span>на&shy;ход&shy;ит&shy;ся,<span class="spacer"> </span>по<span class="spacer"> </span>су&shy;ти,<span class="spacer"> </span>в<span class="spacer"> </span>че&shy;тырёх<span class="spacer"> </span>фай&shy;лах<span class="spacer"> </span>об&shy;щим<span class="spacer"> </span>ве&shy;сом<span class="spacer"> </span>при&shy;мер&shy;но<span class="spacer"> </span>в<span class="spacer"> </span>6400<span class="spacer"> </span>строк,<span class="spacer"> </span>и<span class="spacer"> </span>мы<span class="spacer"> </span>не<span class="spacer"> </span>стр&shy;оим<span class="spacer"> </span>це&shy;лей<span class="spacer"> </span>по&shy;нять<span class="spacer"> </span>его<span class="spacer"> </span>весь.<span class="spacer"> </span>Мы<span class="spacer"> </span>по&shy;пы&shy;та&shy;ем&shy;ся<span class="spacer"> </span>в<span class="spacer"> </span>об&shy;щих<span class="spacer"> </span>сло&shy;вах<span class="spacer"> </span>по&shy;нять<span class="spacer"> </span>суть<span class="spacer"> </span>про&shy;ис&shy;хо&shy;дя&shy;щих<span class="spacer"> </span>про&shy;цес&shy;сов<span class="spacer"> </span>в<span class="spacer"> </span>этом<span class="spacer"> </span>ко&shy;де.</p>
<div class="paragraph-right-side">33</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">34</div>
<p>Всю<span class="spacer"> </span>ло&shy;ги&shy;ку<span class="spacer"> </span>VSD<span class="spacer"> </span>дис&shy;пет&shy;че&shy;ри&shy;за&shy;ции<span class="spacer"> </span>мож&shy;но<span class="spacer"> </span>раз&shy;бить<span class="spacer"> </span>на<span class="spacer"> </span>два<span class="spacer"> </span>боль&shy;ших<span class="spacer"> </span>раз&shy;де&shy;ла:<span class="spacer"> </span>дис&shy;пет&shy;че&shy;ри&shy;за&shy;ция<span class="spacer"> </span>и<span class="spacer"> </span>ме&shy;хан&shy;изм<span class="spacer"> </span>заг&shy;лу&shy;шек<span class="spacer"> </span>(stubs),<span class="spacer"> </span>обес&shy;пе&shy;чи&shy;ва&shy;ю&shy;щих<span class="spacer"> </span>кэ&shy;ши&shy;ро&shy;ва&shy;ние<span class="spacer"> </span>ад&shy;ре&shy;сов<span class="spacer"> </span>вы&shy;зы&shy;ва&shy;е&shy;мых<span class="spacer"> </span>ме&shy;то&shy;дов<span class="spacer"> </span>по<span class="spacer"> </span>па&shy;ре<span class="spacer"> </span>зна&shy;че&shy;ний<span class="spacer"> </span>[тип;<span class="spacer"> </span>но&shy;мер<span class="spacer"> </span>сло&shy;та],<span class="spacer"> </span>ко&shy;то&shy;рые<span class="spacer"> </span>их<span class="spacer"> </span>иден&shy;ти&shy;фи&shy;ци&shy;руют.</p>
<div class="paragraph-right-side">34</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">35</div>
<p>Для<span class="spacer"> </span>пол&shy;но&shy;го<span class="spacer"> </span>по&shy;ни&shy;ма&shy;ния<span class="spacer"> </span>про&shy;те&shy;ка&shy;ю&shy;щих<span class="spacer"> </span>при<span class="spacer"> </span>пос&shy;тро&shy;е&shy;нии<span class="spacer"> </span>VSD<span class="spacer"> </span>про&shy;цес&shy;сов,<span class="spacer"> </span>дав&shy;ай&shy;те<span class="spacer"> </span>расс&shy;мот&shy;рим<span class="spacer"> </span>для<span class="spacer"> </span>на&shy;ча&shy;ла<span class="spacer"> </span>их<span class="spacer"> </span>на<span class="spacer"> </span>очень<span class="spacer"> </span>вы&shy;со&shy;ком<span class="spacer"> </span>уровне,<span class="spacer"> </span>а<span class="spacer"> </span>за&shy;тем<span class="spacer"> </span> &mdash; <span class="spacer"> </span>спус&shy;тим&shy;ся<span class="spacer"> </span>в<span class="spacer"> </span>са&shy;мую<span class="spacer"> </span>глубь.<span class="spacer"> </span>Если<span class="spacer"> </span>го&shy;во&shy;рить<span class="spacer"> </span>про<span class="spacer"> </span>ме&shy;ха&shy;ни&shy;ку<span class="spacer"> </span>дис&shy;пет&shy;че&shy;ри&shy;за&shy;ции,<span class="spacer"> </span>то<span class="spacer"> </span>та<span class="spacer"> </span>от&shy;кла&shy;ды&shy;ва&shy;ет<span class="spacer"> </span>их<span class="spacer"> </span>соз&shy;да&shy;ние<span class="spacer"> </span>на<span class="spacer"> </span>по&shy;том,<span class="spacer"> </span>в<span class="spacer"> </span>си&shy;лу<span class="spacer"> </span>ло&shy;гич&shy;ес&shy;кой<span class="spacer"> </span>пар&shy;ал&shy;лель&shy;нос&shy;ти<span class="spacer"> </span>иера&shy;рхии<span class="spacer"> </span>ин&shy;тер&shy;фейс&shy;ных<span class="spacer"> </span>ти&shy;пов,<span class="spacer"> </span>в<span class="spacer"> </span>си&shy;лу<span class="spacer"> </span>то&shy;го,<span class="spacer"> </span>что<span class="spacer"> </span>их<span class="spacer"> </span>в<span class="spacer"> </span>кон&shy;еч&shy;ном<span class="spacer"> </span>счёте<span class="spacer"> </span>ста&shy;нет<span class="spacer"> </span>очень<span class="spacer"> </span>мно&shy;го,<span class="spacer"> </span>и<span class="spacer"> </span>в<span class="spacer"> </span>си&shy;лу<span class="spacer"> </span>то&shy;го,<span class="spacer"> </span>что<span class="spacer"> </span>боль&shy;шую<span class="spacer"> </span>часть<span class="spacer"> </span>из<span class="spacer"> </span>них<span class="spacer"> </span>JIT<span class="spacer"> </span>ник&shy;ог&shy;да<span class="spacer"> </span>соз&shy;да&shy;вать<span class="spacer"> </span>не<span class="spacer"> </span>бу&shy;дет,<span class="spacer"> </span>т.к.<span class="spacer"> </span>на&shy;ли&shy;чие<span class="spacer"> </span>ти&shy;пов<span class="spacer"> </span>во<span class="spacer"> </span>Framework<span class="spacer"> </span>ещё<span class="spacer"> </span>не<span class="spacer"> </span>оз&shy;на&shy;ча&shy;ет,<span class="spacer"> </span>что<span class="spacer"> </span>их<span class="spacer"> </span>эк&shy;земп&shy;ля&shy;ры<span class="spacer"> </span>бу&shy;дут<span class="spacer"> </span>соз&shy;да&shy;ны.<span class="spacer"> </span>Исполь&shy;зо&shy;ва&shy;ние<span class="spacer"> </span>же<span class="spacer"> </span>тра&shy;ди&shy;ци&shy;он&shy;ной<span class="spacer"> </span>VMT<span class="spacer"> </span>для<span class="spacer"> </span><em>част&shy;ных<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;сов</em><span class="spacer"> </span>соз&shy;да&shy;ло<span class="spacer"> </span>бы<span class="spacer"> </span>си&shy;ту&shy;а&shy;цию,<span class="spacer"> </span>при<span class="spacer"> </span>ко&shy;то&shy;рой<span class="spacer"> </span>JIT<span class="spacer"> </span>приш&shy;лось<span class="spacer"> </span>бы<span class="spacer"> </span>соз&shy;да&shy;вать<span class="spacer"> </span>VMT<span class="spacer"> </span>для<span class="spacer"> </span>каж&shy;до&shy;го<span class="spacer"> </span><em>част&shy;но&shy;го<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;са</em><span class="spacer"> </span>с<span class="spacer"> </span>са&shy;мо&shy;го<span class="spacer"> </span>на&shy;ча&shy;ла.<span class="spacer"> </span>Т.е.<span class="spacer"> </span>соз&shy;да&shy;ние<span class="spacer"> </span>каж&shy;до&shy;го<span class="spacer"> </span>ти&shy;па<span class="spacer"> </span>зам&shy;ед&shy;ли&shy;лось<span class="spacer"> </span>бы<span class="spacer"> </span>как<span class="spacer"> </span>ми&shy;ни&shy;мум<span class="spacer"> </span>в<span class="spacer"> </span>два<span class="spacer"> </span>ра&shy;за.<span class="spacer"> </span>Основ&shy;ным<span class="spacer"> </span>клас&shy;сом,<span class="spacer"> </span>обес&shy;пе&shy;чи&shy;ва&shy;ю&shy;щим<span class="spacer"> </span>дис&shy;пет&shy;че&shy;ри&shy;за&shy;цию,<span class="spacer"> </span>яв&shy;ля&shy;ет&shy;ся<span class="spacer"> </span>класс<span class="spacer"> </span><code>Dispatch&shy;Map</code>,<span class="spacer"> </span>ко&shy;то&shy;рый<span class="spacer"> </span>внут&shy;ри<span class="spacer"> </span>се&shy;бя<span class="spacer"> </span>ин&shy;кап&shy;су&shy;ли&shy;ру&shy;ет<span class="spacer"> </span>таб&shy;ли&shy;цу<span class="spacer"> </span>ти&shy;пов<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;сов,<span class="spacer"> </span>каж&shy;дая<span class="spacer"> </span>из<span class="spacer"> </span>ко&shy;то&shy;рых<span class="spacer"> </span>сос&shy;то&shy;ит<span class="spacer"> </span>из<span class="spacer"> </span>таб&shy;ли&shy;цы<span class="spacer"> </span>ме&shy;то&shy;дов,<span class="spacer"> </span>вхо&shy;дя&shy;щих<span class="spacer"> </span>в<span class="spacer"> </span>эти<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;сы.<span class="spacer"> </span>Каж&shy;дый<span class="spacer"> </span>ме&shy;тод<span class="spacer"> </span>мо&shy;жет<span class="spacer"> </span>быть,<span class="spacer"> </span>в<span class="spacer"> </span>за&shy;ви&shy;сим&shy;ос&shy;ти<span class="spacer"> </span>от<span class="spacer"> </span>ста&shy;дии<span class="spacer"> </span>сво&shy;е&shy;го<span class="spacer"> </span>жиз&shy;нен&shy;но&shy;го<span class="spacer"> </span>цик&shy;ла,<span class="spacer"> </span>в<span class="spacer"> </span>че&shy;тырёх<span class="spacer"> </span>сос&shy;то&shy;я&shy;ни&shy;ях:<span class="spacer"> </span>сос&shy;то&shy;я&shy;ние<span class="spacer"> </span>заг&shy;луш&shy;ки<span class="spacer"> </span>ти&shy;па<span class="spacer"> </span>&laquo;ме&shy;тод<span class="spacer"> </span>ещё<span class="spacer"> </span>не<span class="spacer"> </span>был<span class="spacer"> </span>ни<span class="spacer"> </span>ра&shy;зу<span class="spacer"> </span>выз&shy;ван,<span class="spacer"> </span>его<span class="spacer"> </span>на&shy;до<span class="spacer"> </span>ском&shy;пи&shy;ли&shy;ро&shy;вать<span class="spacer"> </span>и<span class="spacer"> </span>под&shy;ло&shy;жить<span class="spacer"> </span>но&shy;вую<span class="spacer"> </span>заг&shy;луш&shy;ку<span class="spacer"> </span>на<span class="spacer"> </span>мес&shy;то<span class="spacer"> </span>ста&shy;рой&raquo;,<span class="spacer"> </span>сос&shy;то&shy;я&shy;ние<span class="spacer"> </span>заг&shy;луш&shy;ки<span class="spacer"> </span>ти&shy;па<span class="spacer"> </span>&laquo;ме&shy;тод<span class="spacer"> </span>дол&shy;жен<span class="spacer"> </span>быть<span class="spacer"> </span>каж&shy;дый<span class="spacer"> </span>раз<span class="spacer"> </span>най&shy;ден<span class="spacer"> </span>ди&shy;на&shy;мич&shy;ес&shy;ки,<span class="spacer"> </span>т.к.<span class="spacer"> </span>не<span class="spacer"> </span>мо&shy;жет<span class="spacer"> </span>быть<span class="spacer"> </span>оп&shy;ре&shy;делён<span class="spacer"> </span>од&shy;ноз&shy;нач&shy;но&raquo;,<span class="spacer"> </span>сос&shy;то&shy;я&shy;ние<span class="spacer"> </span>заг&shy;луш&shy;ки<span class="spacer"> </span>ти&shy;па<span class="spacer"> </span>&laquo;ме&shy;тод<span class="spacer"> </span>дос&shy;ту&shy;пен<span class="spacer"> </span>по<span class="spacer"> </span>од&shy;ноз&shy;нач&shy;но&shy;му<span class="spacer"> </span>ад&shy;ре&shy;су,<span class="spacer"> </span>а<span class="spacer"> </span>по&shy;то&shy;му<span class="spacer"> </span>вы&shy;зы&shy;ва&shy;ет&shy;ся<span class="spacer"> </span>без<span class="spacer"> </span>ка&shy;ко&shy;го<span class="spacer"> </span>ли&shy;бо<span class="spacer"> </span>по&shy;ис&shy;ка&raquo;,<span class="spacer"> </span>или<span class="spacer"> </span>же<span class="spacer"> </span>пол&shy;ноц&shy;ен&shy;ное<span class="spacer"> </span>те&shy;ло<span class="spacer"> </span>ме&shy;то&shy;да.</p>
<div class="paragraph-right-side">35</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">36</div>
<p>Расс&shy;мот&shy;рим<span class="spacer"> </span>стр&shy;о&shy;ение<span class="spacer"> </span>этих<span class="spacer"> </span>струк&shy;тур<span class="spacer"> </span>с<span class="spacer"> </span>точ&shy;ки<span class="spacer"> </span>зре&shy;ния<span class="spacer"> </span>их<span class="spacer"> </span>ге&shy;не&shy;ри&shy;ро&shy;ва&shy;ния<span class="spacer"> </span>и<span class="spacer"> </span>струк&shy;тур<span class="spacer"> </span>дан&shy;ных,<span class="spacer"> </span>не&shy;об&shy;хо&shy;ди&shy;мых<span class="spacer"> </span>для<span class="spacer"> </span>этого.</p>
<div class="paragraph-right-side">36</div>
</div>
<h3 id="dispatchmap">Dispatch&shy;Map</h3>
<div class="paragraph-container">
<div class="paragraph-left-side">37</div>
<p>Dispatch&shy;Map<span class="spacer"> </span>–<span class="spacer"> </span>это<span class="spacer"> </span>ди&shy;на&shy;мич&shy;ес&shy;ки<span class="spacer"> </span>стр&shy;о&shy;ящ&shy;а&shy;яся<span class="spacer"> </span>струк&shy;ту&shy;ра<span class="spacer"> </span>дан&shy;ных,<span class="spacer"> </span>яв&shy;ля&shy;ю&shy;ща&shy;я&shy;ся<span class="spacer"> </span>по<span class="spacer"> </span>сво&shy;ей<span class="spacer"> </span>су&shy;ти<span class="spacer"> </span>ос&shy;нов&shy;ной<span class="spacer"> </span>струк&shy;ту&shy;рой<span class="spacer"> </span>дан&shy;ных,<span class="spacer"> </span>на<span class="spacer"> </span>ко&shy;то&shy;рую<span class="spacer"> </span>опи&shy;ра&shy;ется<span class="spacer"> </span>ра&shy;бо&shy;та<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;сов<span class="spacer"> </span>в<span class="spacer"> </span>CLR.<span class="spacer"> </span>Струк&shy;ту&shy;ра<span class="spacer"> </span>её<span class="spacer"> </span>выг&shy;ля&shy;дит<span class="spacer"> </span>сле&shy;ду&shy;ю&shy;щим<span class="spacer"> </span>об&shy;ра&shy;зом:</p>
<div class="paragraph-right-side">37</div>
</div>
<pre><code>    DWORD: Количество типов =
    DWORD: Тип №1
    DWORD: Количество слотов для типа №1 = M1
    DWORD: bool: смещения могут быть отрицательными
    DWORD: Слот №1
    DWORD: Целевой слот №1
    ...
    DWORD: Слот №M1
    DWORD: Целевой слот №M1
    ...
    DWORD: Тип №
    DWORD: Количество слотов для типа №1 = M
    DWORD: bool: смещения могут быть отрицательными
    DWORD: Слот №1
    DWORD: Целевой слот №1
    ...
    DWORD: Слот №M
    DWORD: Целевой слот №M
</code></pre>
<div class="paragraph-container">
<div class="paragraph-left-side">38</div>
<p>Т.е.<span class="spacer"> </span>сна&shy;ча&shy;ла<span class="spacer"> </span>за&shy;пи&shy;сы&shy;ва&shy;ет&shy;ся<span class="spacer"> </span>об&shy;щее<span class="spacer"> </span>ко&shy;лич&shy;ес&shy;т&shy;во<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;сов,<span class="spacer"> </span>ре&shy;а&shy;ли&shy;зу&shy;е&shy;мых<span class="spacer"> </span>не&shy;ко&shy;то&shy;ры&shy;ми<span class="spacer"> </span>ти&shy;па&shy;ми.<span class="spacer"> </span>Пос&shy;ле<span class="spacer"> </span>че&shy;го<span class="spacer"> </span>для<span class="spacer"> </span>каж&shy;до&shy;го<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;са<span class="spacer"> </span>за&shy;пи&shy;сы&shy;ва&shy;ет&shy;ся<span class="spacer"> </span>его<span class="spacer"> </span>тип,<span class="spacer"> </span>ко&shy;лич&shy;ес&shy;т&shy;во<span class="spacer"> </span>ре&shy;а&shy;ли&shy;зу&shy;е&shy;мых<span class="spacer"> </span>этим<span class="spacer"> </span>ти&shy;пом<span class="spacer"> </span>сло&shy;тов<span class="spacer"> </span>(для<span class="spacer"> </span>на&shy;ви&shy;га&shy;ции<span class="spacer"> </span>по<span class="spacer"> </span>таб&shy;ли&shy;це),<span class="spacer"> </span>а<span class="spacer"> </span>так&shy;же<span class="spacer"> </span>для<span class="spacer"> </span>каж&shy;до&shy;го<span class="spacer"> </span>сло&shy;та<span class="spacer"> </span> &mdash; <span class="spacer"> </span>ин&shy;фор&shy;ма&shy;ция<span class="spacer"> </span>по<span class="spacer"> </span>этому<span class="spacer"> </span>сло&shy;ту,<span class="spacer"> </span>а<span class="spacer"> </span>так&shy;же<span class="spacer"> </span>це&shy;ле&shy;вой<span class="spacer"> </span>слот<span class="spacer"> </span>в<span class="spacer"> </span><em>част&shy;ном<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;се</em>,<span class="spacer"> </span>ко&shy;то&shy;рый<span class="spacer"> </span>сод&shy;ер&shy;жит<span class="spacer"> </span>ре&shy;а&shy;ли&shy;за&shy;ции<span class="spacer"> </span>ме&shy;то&shy;дов<span class="spacer"> </span>для<span class="spacer"> </span>те&shy;ку&shy;ще&shy;го<span class="spacer"> </span>ти&shy;па.</p>
<div class="paragraph-right-side">38</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">39</div>
<p>Для<span class="spacer"> </span>на&shy;ви&shy;га&shy;ции<span class="spacer"> </span>по<span class="spacer"> </span>этой<span class="spacer"> </span>струк&shy;ту&shy;ре<span class="spacer"> </span>дан&shy;ных<span class="spacer"> </span>пре&shy;дус&shy;мот&shy;рен<span class="spacer"> </span>класс<span class="spacer"> </span><code>Encoded&shy;Map&shy;Iterator</code>,<span class="spacer"> </span>ко&shy;то&shy;рый<span class="spacer"> </span>яв&shy;ля&shy;ет&shy;ся<span class="spacer"> </span>ите&shy;ра&shy;то&shy;ром.<span class="spacer"> </span>Т.е.<span class="spacer"> </span>ни&shy;ка&shy;кой<span class="spacer"> </span>дру&shy;гой<span class="spacer"> </span>дос&shy;туп,<span class="spacer"> </span>кро&shy;ме<span class="spacer"> </span>как<span class="spacer"> </span><code>foreach</code>,<span class="spacer"> </span>к<span class="spacer"> </span><code>Dispatch&shy;Map</code><span class="spacer"> </span>не<span class="spacer"> </span>пре&shy;дус&shy;мот&shy;рен.<span class="spacer"> </span>Ма&shy;ло<span class="spacer"> </span>то&shy;го<span class="spacer"> </span>но&shy;ме&shy;ра<span class="spacer"> </span>сло&shy;тов<span class="spacer"> </span>по&shy;лу&shy;че&shy;ны<span class="spacer"> </span>как<span class="spacer"> </span>раз&shy;ни&shy;ца<span class="spacer"> </span>ре&shy;аль&shy;но&shy;го<span class="spacer"> </span>но&shy;ме&shy;ра<span class="spacer"> </span>сло&shy;та<span class="spacer"> </span>и<span class="spacer"> </span>ра&shy;нее<span class="spacer"> </span>за&shy;ко&shy;ди&shy;ров&shy;ан&shy;но&shy;го<span class="spacer"> </span>но&shy;ме&shy;ра<span class="spacer"> </span>сло&shy;та.<span class="spacer"> </span>Т.е.<span class="spacer"> </span>по&shy;лу&shy;чить<span class="spacer"> </span>но&shy;мер<span class="spacer"> </span>сло&shy;та<span class="spacer"> </span>в<span class="spacer"> </span>се&shy;ре&shy;ди&shy;не<span class="spacer"> </span>таб&shy;ли&shy;цы<span class="spacer"> </span>мож&shy;но,<span class="spacer"> </span>толь&shy;ко<span class="spacer"> </span>прос&shy;мот&shy;рев<span class="spacer"> </span>всю<span class="spacer"> </span>струк&shy;ту&shy;ру<span class="spacer"> </span>с<span class="spacer"> </span>са&shy;мо&shy;го<span class="spacer"> </span>на&shy;ча&shy;ла.<span class="spacer"> </span>Это<span class="spacer"> </span>вы&shy;зы&shy;ва&shy;ет<span class="spacer"> </span>мно&shy;жес&shy;т&shy;во<span class="spacer"> </span>воп&shy;ро&shy;сов<span class="spacer"> </span>ка&shy;сат&shy;ель&shy;но<span class="spacer"> </span>про&shy;из&shy;во&shy;дит&shy;ель&shy;нос&shy;ти<span class="spacer"> </span>ра&shy;бо&shy;ты<span class="spacer"> </span>вы&shy;зо&shy;ва<span class="spacer"> </span>ме&shy;то&shy;дов<span class="spacer"> </span>че&shy;рез<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;сы:<span class="spacer"> </span>ведь<span class="spacer"> </span>ес&shy;ли<span class="spacer"> </span>у<span class="spacer"> </span>нас<span class="spacer"> </span>мас&shy;сив<span class="spacer"> </span>объе&shy;к&shy;тов,<span class="spacer"> </span>ре&shy;а&shy;ли&shy;зу&shy;ю&shy;щих<span class="spacer"> </span>не&shy;кий<span class="spacer"> </span>ин&shy;тер&shy;фейс,<span class="spacer"> </span>то<span class="spacer"> </span>что&shy;бы<span class="spacer"> </span>по&shy;нять,<span class="spacer"> </span>ка&shy;кой<span class="spacer"> </span>ме&shy;тод<span class="spacer"> </span>не&shy;об&shy;хо&shy;ди&shy;мо<span class="spacer"> </span>выз&shy;вать,<span class="spacer"> </span>на&shy;до<span class="spacer"> </span>прос&shy;мот&shy;реть<span class="spacer"> </span>всю<span class="spacer"> </span>таб&shy;ли&shy;цу<span class="spacer"> </span>ре&shy;а&shy;ли&shy;за&shy;ций.<span class="spacer"> </span>Т.е.<span class="spacer"> </span>по<span class="spacer"> </span>сво&shy;ей<span class="spacer"> </span>су&shy;ти<span class="spacer"> </span> &mdash; <span class="spacer"> </span>най&shy;ти<span class="spacer"> </span>нуж&shy;ный.<span class="spacer"> </span>Рез&shy;уль&shy;та&shy;том<span class="spacer"> </span>на<span class="spacer"> </span>каж&shy;дом<span class="spacer"> </span>ша&shy;ге<span class="spacer"> </span>ите&shy;ри&shy;ро&shy;ва&shy;ния<span class="spacer"> </span>бу&shy;дет<span class="spacer"> </span>струк&shy;ту&shy;ра<span class="spacer"> </span><code>Dispatch&shy;Map&shy;Entry</code>,<span class="spacer"> </span>ко&shy;то&shy;рая<span class="spacer"> </span>по&shy;ка&shy;жет,<span class="spacer"> </span>где<span class="spacer"> </span>на&shy;ход&shy;ит&shy;ся<span class="spacer"> </span>це&shy;ле&shy;вой<span class="spacer"> </span>ме&shy;тод:<span class="spacer"> </span>в<span class="spacer"> </span>те&shy;ку&shy;щем<span class="spacer"> </span>ти&shy;пе<span class="spacer"> </span>или<span class="spacer"> </span>нет,<span class="spacer"> </span>и<span class="spacer"> </span>ка&shy;кой<span class="spacer"> </span>слот<span class="spacer"> </span>не&shy;об&shy;хо&shy;ди&shy;мо<span class="spacer"> </span>взять<span class="spacer"> </span>у<span class="spacer"> </span>ти&shy;па,<span class="spacer"> </span>что&shy;бы<span class="spacer"> </span>по&shy;лу&shy;чить<span class="spacer"> </span>нуж&shy;ный<span class="spacer"> </span>ме&shy;тод.</p>
<div class="paragraph-right-side">39</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Green;">// DispatchMapTypeID позволяет делать относительную адресацию методов. Т.е. отвечает на вопрос: относительно текущего типа где </span>
<span style="color:Green;">// находится необходимый метод? В текущем типе или же в другом?</span>
<span style="color:Green;">//</span>
<span style="color:Green;">// Идентификатор типа (Type ID) используется в карте диспетчеризации и хранит внутри себя один из следующих типов данных:</span>
<span style="color:Green;">//   - специальное значение, говорящее, что это - &quot;this&quot; class</span>
<span style="color:Green;">//   - специальное значение, показывающее, что это - тип интерфейса, не реализованный классом</span>
<span style="color:Green;">//   - индекс в InterfaceMap</span>
<span style="color:Blue;">class</span> DispatchMapTypeID
{
<span style="color:Blue;">private</span>:
    <span style="color:Blue;">static</span> <span style="color:Blue;">const</span> UINT32 const_nFirstInterfaceIndex = 1;

    UINT32 m_typeIDVal;

    <span style="color:Green;">// ...</span>
}

<span style="color:Blue;">struct</span> DispatchMapEntry
{
<span style="color:Blue;">private</span>:
    DispatchMapTypeID m_typeID;
    UINT16            m_slotNumber;
    UINT16            m_targetSlotNumber;

    <span style="color:Blue;">enum</span>
    {
        e_IS_VALID = 0x1
    };

    UINT16 m_flags;

    <span style="color:Green;">// ...</span>
}
</pre></div>
</div>
<h4 id="typeid-map">Type&shy;ID<span class="spacer"> </span>Map</h4>
<div class="paragraph-container">
<div class="paragraph-left-side">40</div>
<p>Лю&shy;бой<span class="spacer"> </span>ме&shy;тод<span class="spacer"> </span>в<span class="spacer"> </span>ад&shy;ре&shy;са&shy;ции<span class="spacer"> </span>по<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;сам<span class="spacer"> </span>ко&shy;ди&shy;ру&shy;ет&shy;ся<span class="spacer"> </span>па&shy;рой<span class="spacer"> </span><Type&shy;Id&shy;;Slot&shy;Number&shy;>.<span class="spacer"> </span>Type&shy;Id<span class="spacer"> </span> &mdash; <span class="spacer"> </span>это,<span class="spacer"> </span>как<span class="spacer"> </span>сле&shy;ду&shy;ет<span class="spacer"> </span>из<span class="spacer"> </span>наз&shy;ва&shy;ния,<span class="spacer"> </span>иден&shy;ти&shy;фи&shy;ка&shy;тор<span class="spacer"> </span>ти&shy;па.<span class="spacer"> </span>Дан&shy;ное<span class="spacer"> </span>по&shy;ле<span class="spacer"> </span>от&shy;ве&shy;ча&shy;ет<span class="spacer"> </span>на<span class="spacer"> </span>воп&shy;ро&shy;сы:<span class="spacer"> </span>от&shy;ку&shy;да<span class="spacer"> </span>берётся<span class="spacer"> </span>этот<span class="spacer"> </span>иден&shy;ти&shy;фи&shy;ка&shy;тор,<span class="spacer"> </span>и<span class="spacer"> </span>ка&shy;ким<span class="spacer"> </span>об&shy;ра&shy;зом<span class="spacer"> </span>его<span class="spacer"> </span>от&shy;ра&shy;зить<span class="spacer"> </span>на<span class="spacer"> </span>ре&shy;аль&shy;ный<span class="spacer"> </span>тип.
Класс<span class="spacer"> </span><code>Type&shy;IDMap</code><span class="spacer"> </span>хра&shy;нит<span class="spacer"> </span>кар&shy;ту<span class="spacer"> </span>ти&shy;пов<span class="spacer"> </span>как<span class="spacer"> </span>от&shy;ра&shy;же&shy;ние<span class="spacer"> </span>не&shy;ко&shy;то&shy;ро&shy;го<span class="spacer"> </span>Type&shy;Id<span class="spacer"> </span>на<span class="spacer"> </span><code>Method&shy;Table</code><span class="spacer"> </span>конк&shy;рет&shy;но&shy;го<span class="spacer"> </span>ти&shy;па,<span class="spacer"> </span>а<span class="spacer"> </span>так&shy;же<span class="spacer"> </span> &mdash; <span class="spacer"> </span>доп&shy;ол&shy;нит&shy;ель&shy;но<span class="spacer"> </span> &mdash; <span class="spacer"> </span>в<span class="spacer"> </span>об&shy;рат&shy;ную<span class="spacer"> </span>сто&shy;ро&shy;ну.<span class="spacer"> </span>Сде&shy;ла&shy;но<span class="spacer"> </span>это<span class="spacer"> </span>ис&shy;клю&shy;чит&shy;ель&shy;но<span class="spacer"> </span>из<span class="spacer"> </span>со&shy;об&shy;ра&shy;же&shy;ний<span class="spacer"> </span>про&shy;из&shy;во&shy;дит&shy;ель&shy;нос&shy;ти.<span class="spacer"> </span>Пос&shy;тро&shy;е&shy;ние<span class="spacer"> </span>этих<span class="spacer"> </span>хэш<span class="spacer"> </span>таб&shy;лиц<span class="spacer"> </span>про&shy;ис&shy;хо&shy;дит<span class="spacer"> </span>ди&shy;на&shy;мич&shy;ес&shy;ки:<span class="spacer"> </span>по<span class="spacer"> </span>зап&shy;ро&shy;су<span class="spacer"> </span>Type&shy;Id<span class="spacer"> </span>от&shy;но&shy;сит&shy;ель&shy;но<span class="spacer"> </span>PTR_Method&shy;Table<span class="spacer"> </span>возв&shy;ра&shy;ща&shy;ет&shy;ся<span class="spacer"> </span>ли&shy;бо<span class="spacer"> </span>Fat&shy;Id&shy;,<span class="spacer"> </span>ли&shy;бо<span class="spacer"> </span>прос&shy;то<span class="spacer"> </span>Id&shy;.<span class="spacer"> </span>Это<span class="spacer"> </span>на&shy;до<span class="spacer"> </span>в<span class="spacer"> </span>не&shy;ко&shy;то&shy;ром<span class="spacer"> </span>смыс&shy;ле<span class="spacer"> </span>прос&shy;то<span class="spacer"> </span>пом&shy;нить:<span class="spacer"> </span>Fat&shy;Id<span class="spacer"> </span>и<span class="spacer"> </span>Id<span class="spacer"> </span> &mdash; <span class="spacer"> </span>это<span class="spacer"> </span>прос&shy;то<span class="spacer"> </span>два<span class="spacer"> </span>ви&shy;да<span class="spacer"> </span>Type&shy;Id&shy;.<span class="spacer"> </span>И<span class="spacer"> </span>в<span class="spacer"> </span>не&shy;ко&shy;то&shy;ром<span class="spacer"> </span>смыс&shy;ле<span class="spacer"> </span>это<span class="spacer"> </span>&laquo;ука&shy;за&shy;тель&raquo;<span class="spacer"> </span>на<span class="spacer"> </span>Method&shy;Table&shy;,<span class="spacer"> </span>т.к.<span class="spacer"> </span>од&shy;ноз&shy;нач&shy;но<span class="spacer"> </span>его<span class="spacer"> </span>иден&shy;ти&shy;фи&shy;ци&shy;рует.</p>
<div class="paragraph-right-side">40</div>
</div>
<blockquote>
<p><strong>Type&shy;Id<span class="spacer"> </span>-<span class="spacer"> </span>это<span class="spacer"> </span>иден&shy;ти&shy;фи&shy;ка&shy;тор<span class="spacer"> </span>Method&shy;Table</strong>.<span class="spacer"> </span>Он<span class="spacer"> </span>мо&shy;жет<span class="spacer"> </span>быть<span class="spacer"> </span>двух<span class="spacer"> </span>ви&shy;дов:<span class="spacer"> </span>Id<span class="spacer"> </span>и<span class="spacer"> </span>Fat&shy;Id<span class="spacer"> </span>и<span class="spacer"> </span>по<span class="spacer"> </span>сво&shy;ей<span class="spacer"> </span>су&shy;ти<span class="spacer"> </span>яв&shy;ля&shy;ет&shy;ся<span class="spacer"> </span>обыч&shy;ным<span class="spacer"> </span>чис&shy;лом.</p>
</blockquote>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">class</span> TypeIDMap
{
<span style="color:Blue;">protected</span>:
    HashMap             m_idMap;  <span style="color:Green;">// Хранит map TypeID -&gt; PTR_MethodTable</span>
    HashMap             m_mtMap;  <span style="color:Green;">// Хранит map PTR_MethodTable -&gt; TypeID1</span>
    Crst                m_lock;
    TypeIDProvider      m_idProvider;
    BOOL                m_fUseFatIdsForUniqueness;
    UINT32              m_entryCount;

    <span style="color:Green;">// ...</span>
}
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">41</div>
<p>Одна&shy;ко<span class="spacer"> </span>со<span class="spacer"> </span>все&shy;ми<span class="spacer"> </span>этими<span class="spacer"> </span>труд&shy;нос&shy;тя&shy;ми<span class="spacer"> </span>JIT<span class="spacer"> </span>справ&shy;ля&shy;ет&shy;ся<span class="spacer"> </span>дос&shy;тат&shy;оч&shy;но<span class="spacer"> </span>лег&shy;ко,<span class="spacer"> </span>впи&shy;сы&shy;вая<span class="spacer"> </span>вы&shy;зо&shy;вы<span class="spacer"> </span>конк&shy;рет&shy;ных<span class="spacer"> </span>ме&shy;то&shy;дов<span class="spacer"> </span>в<span class="spacer"> </span>мес&shy;та<span class="spacer"> </span>их<span class="spacer"> </span>вы&shy;зо&shy;ва<span class="spacer"> </span>по<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;су,<span class="spacer"> </span>ког&shy;да<span class="spacer"> </span>это<span class="spacer"> </span>воз&shy;мож&shy;но.<span class="spacer"> </span>Если<span class="spacer"> </span>JIT<span class="spacer"> </span>по&shy;нял,<span class="spacer"> </span>что<span class="spacer"> </span>ни&shy;че&shy;го<span class="spacer"> </span>дру&shy;го&shy;го<span class="spacer"> </span>выз&shy;ва&shy;но<span class="spacer"> </span>быть<span class="spacer"> </span>не<span class="spacer"> </span>мо&shy;жет,<span class="spacer"> </span>он<span class="spacer"> </span>прос&shy;то<span class="spacer"> </span>пос&shy;та&shy;вит<span class="spacer"> </span>вы&shy;зов<span class="spacer"> </span>конк&shy;рет&shy;но&shy;го<span class="spacer"> </span>ме&shy;то&shy;да.<span class="spacer"> </span>Это<span class="spacer"> </span> &mdash; <span class="spacer"> </span>очень<span class="spacer"> </span>и<span class="spacer"> </span>очень<span class="spacer"> </span>силь&shy;ная<span class="spacer"> </span>особ&shy;ен&shy;ность<span class="spacer"> </span>JIT<span class="spacer"> </span>ком&shy;пи&shy;ля&shy;то&shy;ра,<span class="spacer"> </span>ко&shy;то&shy;рый<span class="spacer"> </span>де&shy;ла&shy;ет<span class="spacer"> </span>для<span class="spacer"> </span>нас<span class="spacer"> </span>эту<span class="spacer"> </span>прек&shy;рас&shy;ную<span class="spacer"> </span>оп&shy;ти&shy;ми&shy;за&shy;цию.</p>
<div class="paragraph-right-side">41</div>
</div>
<h3 id="section-4">Вы&shy;во&shy;ды</h3>
<div class="paragraph-container">
<div class="paragraph-left-side">42</div>
<p>То,<span class="spacer"> </span>что<span class="spacer"> </span>для<span class="spacer"> </span>нас,<span class="spacer"> </span>как<span class="spacer"> </span>для<span class="spacer"> </span>прог&shy;рам&shy;мис&shy;тов,<span class="spacer"> </span>на<span class="spacer"> </span>языке<span class="spacer"> </span>C#<span class="spacer"> </span>ста&shy;ло<span class="spacer"> </span>обыд&shy;ен&shy;нос&shy;тью<span class="spacer"> </span>и<span class="spacer"> </span>врос&shy;ло<span class="spacer"> </span>кор&shy;ня&shy;ми<span class="spacer"> </span>в<span class="spacer"> </span>на&shy;ше<span class="spacer"> </span>соз&shy;на&shy;ние<span class="spacer"> </span>нас&shy;толь&shy;ко,<span class="spacer"> </span>что<span class="spacer"> </span>мы<span class="spacer"> </span>да&shy;же<span class="spacer"> </span>не<span class="spacer"> </span>за&shy;ду&shy;мы&shy;ва&shy;ясь<span class="spacer"> </span>по&shy;ни&shy;ма&shy;ем,<span class="spacer"> </span>как<span class="spacer"> </span>де&shy;лить<span class="spacer"> </span>при&shy;ло&shy;же&shy;ние<span class="spacer"> </span>на<span class="spacer"> </span>клас&shy;сы<span class="spacer"> </span>и<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;сы,<span class="spacer"> </span>по&shy;рой<span class="spacer"> </span>ре&shy;а&shy;ли&shy;зо&shy;ва&shy;но<span class="spacer"> </span>так<span class="spacer"> </span>слож&shy;но<span class="spacer"> </span>для<span class="spacer"> </span>по&shy;ни&shy;ма&shy;ния,<span class="spacer"> </span>что<span class="spacer"> </span>тре&shy;бу&shy;ют&shy;ся<span class="spacer"> </span>не&shy;де&shy;ли<span class="spacer"> </span>ана&shy;лиза<span class="spacer"> </span>ис&shy;ход&shy;ных<span class="spacer"> </span>текс&shy;тов<span class="spacer"> </span>для<span class="spacer"> </span>оп&shy;ре&shy;де&shy;ле&shy;ния<span class="spacer"> </span>всех<span class="spacer"> </span>за&shy;ви&shy;сим&shy;ос&shy;тей<span class="spacer"> </span>и<span class="spacer"> </span>ло&shy;ги&shy;ки<span class="spacer"> </span>про&shy;ис&shy;хо&shy;дя&shy;ще&shy;го.<span class="spacer"> </span>То,<span class="spacer"> </span>что<span class="spacer"> </span>для<span class="spacer"> </span>нас<span class="spacer"> </span>нас&shy;толь&shy;ко<span class="spacer"> </span>обыд&shy;енно<span class="spacer"> </span>в<span class="spacer"> </span>ис&shy;поль&shy;зо&shy;ва&shy;нии,<span class="spacer"> </span>что<span class="spacer"> </span>не<span class="spacer"> </span>вы&shy;зы&shy;ва&shy;ет<span class="spacer"> </span>те&shy;ни<span class="spacer"> </span>сом&shy;не&shy;ния<span class="spacer"> </span>в<span class="spacer"> </span>прос&shy;то&shy;те<span class="spacer"> </span>ре&shy;а&shy;ли&shy;за&shy;ции,<span class="spacer"> </span>на<span class="spacer"> </span>са&shy;мом<span class="spacer"> </span>де&shy;ле<span class="spacer"> </span>мо&shy;жет<span class="spacer"> </span>скры&shy;вать<span class="spacer"> </span>эти<span class="spacer"> </span>слож&shy;нос&shy;ти<span class="spacer"> </span>ре&shy;а&shy;ли&shy;за&shy;ции.<span class="spacer"> </span>Это<span class="spacer"> </span>го&shy;во&shy;рит<span class="spacer"> </span>нам<span class="spacer"> </span>о<span class="spacer"> </span>том,<span class="spacer"> </span>что<span class="spacer"> </span>ин&shy;же&shy;не&shy;ры,<span class="spacer"> </span>воп&shy;лот&shy;ив&shy;шие<span class="spacer"> </span>дан&shy;ные<span class="spacer"> </span>идеи,<span class="spacer"> </span>под&shy;хо&shy;ди&shy;ли<span class="spacer"> </span>к<span class="spacer"> </span>ре&shy;ше&shy;нию<span class="spacer"> </span>проб&shy;лем<span class="spacer"> </span>с<span class="spacer"> </span>боль&shy;шим<span class="spacer"> </span>умом,<span class="spacer"> </span>тща&shy;тель&shy;но<span class="spacer"> </span>ана&shy;ли&shy;зи&shy;руя<span class="spacer"> </span>каж&shy;дый<span class="spacer"> </span>шаг.</p>
<div class="paragraph-right-side">42</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">43</div>
<p>То<span class="spacer"> </span>опи&shy;са&shy;ние,<span class="spacer"> </span>ко&shy;то&shy;рое<span class="spacer"> </span>здесь<span class="spacer"> </span>да&shy;но,<span class="spacer"> </span>на<span class="spacer"> </span>са&shy;мом<span class="spacer"> </span>де&shy;ле<span class="spacer"> </span>очень<span class="spacer"> </span>пов&shy;ер&shy;х&shy;нос&shy;т&shy;ное<span class="spacer"> </span>и<span class="spacer"> </span>кор&shy;от&shy;кое:<span class="spacer"> </span>оно<span class="spacer"> </span>очень<span class="spacer"> </span>вы&shy;со&shy;ко&shy;у&shy;ров&shy;не&shy;вое.<span class="spacer"> </span>Да&shy;же<span class="spacer"> </span>не<span class="spacer"> </span>смот&shy;ря<span class="spacer"> </span>на<span class="spacer"> </span>то,<span class="spacer"> </span>что<span class="spacer"> </span>от&shy;но&shy;сит&shy;ель&shy;но<span class="spacer"> </span>лю&shy;бой<span class="spacer"> </span>кни&shy;ги<span class="spacer"> </span>по<span class="spacer"> </span>.NET<span class="spacer"> </span>мы<span class="spacer"> </span>пог&shy;ру&shy;зи&shy;лись<span class="spacer"> </span>очень<span class="spacer"> </span>глу&shy;бо&shy;ко,<span class="spacer"> </span>дан&shy;ное<span class="spacer"> </span>опи&shy;са&shy;ние<span class="spacer"> </span>пос&shy;тро&shy;е&shy;ния<span class="spacer"> </span>VSD<span class="spacer"> </span>и<span class="spacer"> </span>VMT<span class="spacer"> </span>яв&shy;ля&shy;ет&shy;ся<span class="spacer"> </span>очень<span class="spacer"> </span>и<span class="spacer"> </span>очень<span class="spacer"> </span>вы&shy;со&shy;ко&shy;у&shy;ров&shy;не&shy;вым.<span class="spacer"> </span>Ведь<span class="spacer"> </span>код<span class="spacer"> </span>фай&shy;лов,<span class="spacer"> </span>опи&shy;сы&shy;ва&shy;ю&shy;щих<span class="spacer"> </span>эти<span class="spacer"> </span>две<span class="spacer"> </span>струк&shy;ту&shy;ры<span class="spacer"> </span>дан&shy;ных,<span class="spacer"> </span>за&shy;ни&shy;ма&shy;ет<span class="spacer"> </span>в<span class="spacer"> </span>сум&shy;ме<span class="spacer"> </span>около<span class="spacer"> </span>20,000<span class="spacer"> </span>строк<span class="spacer"> </span>ко&shy;да.<span class="spacer"> </span>Это<span class="spacer"> </span>ещё<span class="spacer"> </span>не<span class="spacer"> </span>учи&shy;ты&shy;вая<span class="spacer"> </span>не&shy;ко&shy;то&shy;рые<span class="spacer"> </span>час&shy;ти,<span class="spacer"> </span>от&shy;ве&shy;ча&shy;ю&shy;щие<span class="spacer"> </span>за<span class="spacer"> </span>Generics&shy;.</p>
<div class="paragraph-right-side">43</div>
</div>
<p>Одна&shy;ко,<span class="spacer"> </span>это<span class="spacer"> </span>поз&shy;во&shy;ля&shy;ет<span class="spacer"> </span>нам<span class="spacer"> </span>сде&shy;лать<span class="spacer"> </span>нес&shy;коль&shy;ко<span class="spacer"> </span>вы&shy;во&shy;дов:</p>
<ul>
<li>Вы&shy;зов<span class="spacer"> </span>ста&shy;тич&shy;ных<span class="spacer"> </span>ме&shy;то&shy;дов<span class="spacer"> </span>и<span class="spacer"> </span>эк&shy;земп&shy;ляр&shy;ных<span class="spacer"> </span>прак&shy;тич&shy;ес&shy;ки<span class="spacer"> </span>ни&shy;чем<span class="spacer"> </span>не<span class="spacer"> </span>от&shy;ли&shy;ча&shy;ют&shy;ся.<span class="spacer"> </span>А<span class="spacer"> </span>это<span class="spacer"> </span>зна&shy;чит,<span class="spacer"> </span>что<span class="spacer"> </span>нам<span class="spacer"> </span>не<span class="spacer"> </span>на&shy;до<span class="spacer"> </span>бес&shy;по&shy;ко&shy;ить&shy;ся<span class="spacer"> </span>о<span class="spacer"> </span>том,<span class="spacer"> </span>что<span class="spacer"> </span>ра&shy;бо&shy;та<span class="spacer"> </span>с<span class="spacer"> </span>эк&shy;земп&shy;ляр&shy;ны&shy;ми<span class="spacer"> </span>ме&shy;то&shy;да&shy;ми<span class="spacer"> </span>как-то<span class="spacer"> </span>пов&shy;лияет<span class="spacer"> </span>на<span class="spacer"> </span>про&shy;из&shy;во&shy;дит&shy;ель&shy;ность.<span class="spacer"> </span>Про&shy;из&shy;во&shy;дит&shy;ель&shy;ность<span class="spacer"> </span>обоих<span class="spacer"> </span>ме&shy;то&shy;дов<span class="spacer"> </span>аб&shy;сол&shy;ют&shy;но<span class="spacer"> </span>иден&shy;тична<span class="spacer"> </span>при<span class="spacer"> </span>оди&shy;на&shy;ко&shy;вых<span class="spacer"> </span>ус&shy;ло&shy;ви&shy;ях</li>
<li>Вы&shy;зов<span class="spacer"> </span>вир&shy;ту&shy;аль&shy;ных<span class="spacer"> </span>ме&shy;то&shy;дов<span class="spacer"> </span>хоть<span class="spacer"> </span>и<span class="spacer"> </span>идёт<span class="spacer"> </span>че&shy;рез<span class="spacer"> </span>таб&shy;ли&shy;цу<span class="spacer"> </span>VMT,<span class="spacer"> </span>но<span class="spacer"> </span>из-за<span class="spacer"> </span>то&shy;го,<span class="spacer"> </span>что<span class="spacer"> </span>ин&shy;дек&shy;сы<span class="spacer"> </span>за&shy;ра&shy;нее<span class="spacer"> </span>из&shy;вес&shy;т&shy;ны,<span class="spacer"> </span>на<span class="spacer"> </span>каж&shy;дый<span class="spacer"> </span>вы&shy;зов<span class="spacer"> </span>доп&shy;ол&shy;нит&shy;ель&shy;но<span class="spacer"> </span>при&shy;ход&shy;ит&shy;ся<span class="spacer"> </span>лишь<span class="spacer"> </span>единст&shy;венное<span class="spacer"> </span>ра&shy;зы&shy;ме&shy;но&shy;ва&shy;ние<span class="spacer"> </span>ука&shy;за&shy;теля.<span class="spacer"> </span>Поч&shy;ти<span class="spacer"> </span>во<span class="spacer"> </span>всех<span class="spacer"> </span>слу&shy;ча&shy;ях<span class="spacer"> </span>это<span class="spacer"> </span>ни<span class="spacer"> </span>на<span class="spacer"> </span>что<span class="spacer"> </span>не<span class="spacer"> </span>пов&shy;лияет:<span class="spacer"> </span>про&shy;се&shy;да&shy;ние<span class="spacer"> </span>про&shy;из&shy;во&shy;дит&shy;ель&shy;нос&shy;ти<span class="spacer"> </span>(ес&shy;ли<span class="spacer"> </span>во&shy;об&shy;ще<span class="spacer"> </span>мож&shy;но<span class="spacer"> </span>так<span class="spacer"> </span>вы&shy;раз&shy;ить&shy;ся)<span class="spacer"> </span>бу&shy;дет<span class="spacer"> </span>нас&shy;толь&shy;ко<span class="spacer"> </span>мал&shy;ень&shy;ким,<span class="spacer"> </span>что<span class="spacer"> </span>им<span class="spacer"> </span>в<span class="spacer"> </span>прин&shy;ци&shy;пе<span class="spacer"> </span>мож&shy;но<span class="spacer"> </span>пре&shy;неб&shy;речь</li>
<li>Если<span class="spacer"> </span>го&shy;во&shy;рить<span class="spacer"> </span>об<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;сах,<span class="spacer"> </span>то<span class="spacer"> </span>тут<span class="spacer"> </span>сто&shy;ит<span class="spacer"> </span>пом&shy;нить<span class="spacer"> </span>о<span class="spacer"> </span>дис&shy;пет&shy;че&shy;ри&shy;за&shy;ции<span class="spacer"> </span>и<span class="spacer"> </span>по&shy;ни&shy;мать,<span class="spacer"> </span>что<span class="spacer"> </span>ра&shy;бо&shy;та<span class="spacer"> </span>че&shy;рез<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;сы<span class="spacer"> </span>силь&shy;но<span class="spacer"> </span>ус&shy;лож&shy;ня&shy;ет<span class="spacer"> </span>ре&shy;а&shy;ли&shy;за&shy;цию<span class="spacer"> </span>под&shy;сис&shy;те&shy;мы<span class="spacer"> </span>ти&shy;пов<span class="spacer"> </span>на<span class="spacer"> </span>низ&shy;ком<span class="spacer"> </span>уровне,<span class="spacer"> </span>при&shy;во&shy;дя<span class="spacer"> </span>к<span class="spacer"> </span><em><strong>воз&shy;мож&shy;ным</strong></em><span class="spacer"> </span>про&shy;се&shy;да&shy;ни&shy;ям<span class="spacer"> </span>в<span class="spacer"> </span>про&shy;из&shy;во&shy;дит&shy;ель&shy;нос&shy;ти,<span class="spacer"> </span>ког&shy;да<span class="spacer"> </span>слиш&shy;ком<span class="spacer"> </span>час&shy;то,<span class="spacer"> </span>при<span class="spacer"> </span>вы&shy;зо&shy;ве<span class="spacer"> </span>ме&shy;то&shy;дов,<span class="spacer"> </span>от&shy;сут&shy;ствует<span class="spacer"> </span>оп&shy;ре&shy;делённость<span class="spacer"> </span>в<span class="spacer"> </span>том,<span class="spacer"> </span>ка&shy;кой<span class="spacer"> </span>ме&shy;тод<span class="spacer"> </span>и<span class="spacer"> </span>ка&shy;ко&shy;го<span class="spacer"> </span>клас&shy;са<span class="spacer"> </span>вы&shy;зы&shy;вать<span class="spacer"> </span>у<span class="spacer"> </span>ин&shy;тер&shy;фейс&shy;ной<span class="spacer"> </span>пе&shy;рем&shy;ен&shy;ной.<span class="spacer"> </span>Одна&shy;ко,<span class="spacer"> </span>&laquo;ин&shy;тел&shy;лект&raquo;<span class="spacer"> </span>JIT<span class="spacer"> </span>ком&shy;пи&shy;ля&shy;то&shy;ра<span class="spacer"> </span>поз&shy;во&shy;ля&shy;ет<span class="spacer"> </span>в<span class="spacer"> </span>очень<span class="spacer"> </span>мно&shy;гих<span class="spacer"> </span>слу&shy;ча&shy;ях<span class="spacer"> </span>не<span class="spacer"> </span>про&shy;во&shy;дить<span class="spacer"> </span>вы&shy;зо&shy;вы<span class="spacer"> </span>че&shy;рез<span class="spacer"> </span>дис&shy;пет&shy;че&shy;ри&shy;за&shy;цию,<span class="spacer"> </span>а<span class="spacer"> </span>нап&shy;ря&shy;мую<span class="spacer"> </span>вы&shy;зы&shy;вать<span class="spacer"> </span>ме&shy;тод,<span class="spacer"> </span>ин&shy;тер&shy;фейс<span class="spacer"> </span>ре&shy;а&shy;ли&shy;зу&shy;ю&shy;ще&shy;го</li>
<li>Если<span class="spacer"> </span>вспом&shy;нить<span class="spacer"> </span>об<span class="spacer"> </span>обоб&shy;ще&shy;ниях,<span class="spacer"> </span>то<span class="spacer"> </span>тут<span class="spacer"> </span>воз&shy;ни&shy;ка&shy;ет<span class="spacer"> </span>ещё<span class="spacer"> </span>один<span class="spacer"> </span>слой<span class="spacer"> </span>абстр&shy;акции,<span class="spacer"> </span>ко&shy;то&shy;рый<span class="spacer"> </span>вно&shy;сит<span class="spacer"> </span>слож&shy;ность<span class="spacer"> </span>в<span class="spacer"> </span>по&shy;иск<span class="spacer"> </span>не&shy;об&shy;хо&shy;ди&shy;мых<span class="spacer"> </span>для<span class="spacer"> </span>вы&shy;зо&shy;ва<span class="spacer"> </span>ме&shy;то&shy;дов<span class="spacer"> </span>у<span class="spacer"> </span>ти&shy;пов,<span class="spacer"> </span>ре&shy;а&shy;ли&shy;зу&shy;ю&shy;щих<span class="spacer"> </span>generic<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;сы.</li>
</ul>
<h2 id="section-5">Раз&shy;дел<span class="spacer"> </span>воп&shy;ро&shy;сов<span class="spacer"> </span>по<span class="spacer"> </span>те&shy;ме</h2>
<blockquote>
<p>Воп&shy;рос:<span class="spacer"> </span>по&shy;че&shy;му<span class="spacer"> </span>ес&shy;ли<span class="spacer"> </span>каж&shy;дый<span class="spacer"> </span>класс<span class="spacer"> </span>мо&shy;жет<span class="spacer"> </span>ре&shy;а&shy;ли&shy;зо&shy;вать<span class="spacer"> </span>ин&shy;тер&shy;фейс,<span class="spacer"> </span>то<span class="spacer"> </span>нель&shy;зя<span class="spacer"> </span>вы&shy;та&shy;щить<span class="spacer"> </span>конк&shy;рет&shy;ную<span class="spacer"> </span>ре&shy;а&shy;ли&shy;за&shy;цию<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;са<span class="spacer"> </span>у<span class="spacer"> </span>объе&shy;кта?</p>
</blockquote>
<div class="paragraph-container">
<div class="paragraph-left-side">44</div>
<p>Ответ<span class="spacer"> </span>прост:<span class="spacer"> </span>это<span class="spacer"> </span>неп&shy;ок&shy;ры&shy;тая<span class="spacer"> </span>воз&shy;мож&shy;ность<span class="spacer"> </span>CLR<span class="spacer"> </span>при<span class="spacer"> </span>про&shy;ек&shy;ти&shy;ро&shy;ва&shy;нии<span class="spacer"> </span>языка,<span class="spacer"> </span>CLR<span class="spacer"> </span>этот<span class="spacer"> </span>воп&shy;рос<span class="spacer"> </span>ни&shy;как<span class="spacer"> </span>не<span class="spacer"> </span>ог&shy;ра&shy;ни&shy;чи&shy;ва&shy;ет.<span class="spacer"> </span>Ма&shy;ло<span class="spacer"> </span>то&shy;го,<span class="spacer"> </span>это<span class="spacer"> </span>с<span class="spacer"> </span>вы&shy;со&shy;кой<span class="spacer"> </span>до&shy;лей<span class="spacer"> </span>ве&shy;ро&shy;ят&shy;нос&shy;ти<span class="spacer"> </span>бу&shy;дет<span class="spacer"> </span>доб&shy;ав&shy;ле&shy;но<span class="spacer"> </span>в<span class="spacer"> </span>бли&shy;жай&shy;ших<span class="spacer"> </span>вер&shy;си&shy;ях<span class="spacer"> </span>C#,<span class="spacer"> </span>бла&shy;го<span class="spacer"> </span>они<span class="spacer"> </span>вы&shy;хо&shy;дят<span class="spacer"> </span>дос&shy;тат&shy;оч&shy;но<span class="spacer"> </span>быс&shy;т&shy;ро.<span class="spacer"> </span>Расс&shy;мот&shy;рим<span class="spacer"> </span>при&shy;мер:</p>
<div class="paragraph-right-side">44</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">void</span> Main()
{
    <span style="color:Blue;">var</span> foo = <span style="color:Blue;">new</span> Foo();
    <span style="color:Blue;">var</span> boo = <span style="color:Blue;">new</span> Boo();

    ((IDisposable)foo).Dispose();
    foo.Dispose();
    ((IDisposable)boo).Dispose();
    boo.Dispose();
}

<span style="color:Blue;">class</span> Foo : IDisposable
{
    <span style="color:Blue;">void</span> IDisposable.Dispose()
    {
        Console.WriteLine(<span style="color:#A31515;">&quot;Foo.IDisposable::Dispose&quot;</span>);
    }

    <span style="color:Blue;">public</span> <span style="color:Blue;">void</span> Dispose()
    {
        Console.WriteLine(<span style="color:#A31515;">&quot;Foo::Dispose()&quot;</span>);
    }
}

<span style="color:Blue;">class</span> Boo : Foo, IDisposable
{
    <span style="color:Blue;">void</span> IDisposable.Dispose()
    {
        Console.WriteLine(<span style="color:#A31515;">&quot;Boo.IDisposable::Dispose&quot;</span>);
    }

    <span style="color:Blue;">public</span> <span style="color:Blue;">new</span> <span style="color:Blue;">void</span> Dispose()
    {
        Console.WriteLine(<span style="color:#A31515;">&quot;Boo::Dispose()&quot;</span>);
    }
}
</pre></div>
</div>
<p>Здесь<span class="spacer"> </span>мы<span class="spacer"> </span>вы&shy;зы&shy;ва&shy;ем<span class="spacer"> </span>че&shy;ты&shy;ре<span class="spacer"> </span>раз&shy;лич&shy;ных<span class="spacer"> </span>ме&shy;то&shy;да<span class="spacer"> </span>и<span class="spacer"> </span>рез&shy;уль&shy;тат<span class="spacer"> </span>их<span class="spacer"> </span>вы&shy;зо&shy;ва<span class="spacer"> </span>бу&shy;дет<span class="spacer"> </span>та&shy;ким:</p>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
Foo.IDisposable::Dispose
Foo::Dispose()
Boo.IDisposable::Dispose
Boo::Dispose()
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">45</div>
<p>Причём,<span class="spacer"> </span>нес&shy;мот&shy;ря<span class="spacer"> </span>на<span class="spacer"> </span>то,<span class="spacer"> </span>что<span class="spacer"> </span>мы<span class="spacer"> </span>имеем<span class="spacer"> </span><em>explicit</em><span class="spacer"> </span>ре&shy;а&shy;ли&shy;за&shy;цию<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;са<span class="spacer"> </span>в<span class="spacer"> </span>обоих<span class="spacer"> </span>клас&shy;сах,<span class="spacer"> </span>в<span class="spacer"> </span>клас&shy;се<span class="spacer"> </span><code>Boo</code><span class="spacer"> </span><em>explicit</em><span class="spacer"> </span>ре&shy;а&shy;ли&shy;за&shy;цию<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;са<span class="spacer"> </span><code>IDispos&shy;able</code><span class="spacer"> </span>для<span class="spacer"> </span><code>Foo</code><span class="spacer"> </span>по&shy;лу&shy;чить<span class="spacer"> </span>не<span class="spacer"> </span>по&shy;луч&shy;ит&shy;ся.<span class="spacer"> </span>Да&shy;же<span class="spacer"> </span>ес&shy;ли<span class="spacer"> </span>мы<span class="spacer"> </span>на&shy;пи&shy;шем<span class="spacer"> </span>так:</p>
<div class="paragraph-right-side">45</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
((IDisposable)(Foo)boo).Dispose();
</pre></div>
</div>
<p>Все<span class="spacer"> </span>рав&shy;но<span class="spacer"> </span>мы<span class="spacer"> </span>по&shy;лу&shy;чим<span class="spacer"> </span>на<span class="spacer"> </span>эк&shy;ра&shy;не<span class="spacer"> </span>все<span class="spacer"> </span>то<span class="spacer"> </span>же<span class="spacer"> </span>рез&shy;уль&shy;тат:</p>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
Boo.IDisposable::Dispose
</pre></div>
</div>
<h2 id="section-6">Что<span class="spacer"> </span>пло&shy;хо&shy;го<span class="spacer"> </span>в<span class="spacer"> </span>не&shy;яв&shy;ных<span class="spacer"> </span>и<span class="spacer"> </span>мно&shy;жест&shy;вен&shy;ных<span class="spacer"> </span>ре&shy;а&shy;ли&shy;за&shy;ци&shy;ях<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;сов?</h2>
<div class="paragraph-container">
<div class="paragraph-left-side">46</div>
<p>В<span class="spacer"> </span>кач&shy;ес&shy;т&shy;ве<span class="spacer"> </span>при&shy;ме&shy;ра<span class="spacer"> </span>&laquo;нас&shy;ле&shy;до&shy;ва&shy;ния<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;сов&raquo;,<span class="spacer"> </span>что<span class="spacer"> </span>ана&shy;лог&shy;ично<span class="spacer"> </span>нас&shy;ле&shy;до&shy;ва&shy;нию<span class="spacer"> </span>клас&shy;сов,<span class="spacer"> </span>мож&shy;но<span class="spacer"> </span>при&shy;вес&shy;ти<span class="spacer"> </span>сле&shy;ду&shy;ю&shy;щий<span class="spacer"> </span>код:</p>
<div class="paragraph-right-side">46</div>
</div>
<div class="lang-vb editor-colors"><div style="color:Black;background-color:White;"><pre>
    <span style="color:Blue;">Class</span> Foo
        <span style="color:Blue;">Implements</span> IDisposable

        <span style="color:Blue;">Public</span> <span style="color:Blue;">Overridable</span> <span style="color:Blue;">Sub</span> DisposeImp() <span style="color:Blue;">Implements</span> IDisposable.Dispose
            Console.WriteLine(<span style="color:#A31515;">&quot;Foo.IDisposable::Dispose&quot;</span>)
        <span style="color:Blue;">End</span> <span style="color:Blue;">Sub</span>

        <span style="color:Blue;">Public</span> <span style="color:Blue;">Sub</span> Dispose()
            Console.WriteLine(<span style="color:#A31515;">&quot;Foo::Dispose()&quot;</span>)
        <span style="color:Blue;">End</span> <span style="color:Blue;">Sub</span>

    <span style="color:Blue;">End</span> <span style="color:Blue;">Class</span>

    <span style="color:Blue;">Class</span> Boo
        <span style="color:Blue;">Inherits</span> Foo
        <span style="color:Blue;">Implements</span> IDisposable

        <span style="color:Blue;">Public</span> <span style="color:Blue;">Sub</span> DisposeImp() <span style="color:Blue;">Implements</span> IDisposable.Dispose
            Console.WriteLine(<span style="color:#A31515;">&quot;Boo.IDisposable::Dispose&quot;</span>)
        <span style="color:Blue;">End</span> <span style="color:Blue;">Sub</span>

        <span style="color:Blue;">Public</span> <span style="color:Blue;">Shadows</span> <span style="color:Blue;">Sub</span> Dispose()
            Console.WriteLine(<span style="color:#A31515;">&quot;Boo::Dispose()&quot;</span>)
        <span style="color:Blue;">End</span> <span style="color:Blue;">Sub</span>

    <span style="color:Blue;">End</span> <span style="color:Blue;">Class</span>

    <span style="color:Green;">&#39;&#39;&#39; &lt;summary&gt;</span>
    <span style="color:Green;">&#39;&#39;&#39; Неявно реализует интерфейс</span>
    <span style="color:Green;">&#39;&#39;&#39; &lt;/summary&gt;</span>
    <span style="color:Blue;">Class</span> Doo
        <span style="color:Blue;">Inherits</span> Foo

        <span style="color:Green;">&#39;&#39;&#39; &lt;summary&gt;</span>
        <span style="color:Green;">&#39;&#39;&#39; Переопределение явной реализации</span>
        <span style="color:Green;">&#39;&#39;&#39; &lt;/summary&gt;</span>
        <span style="color:Blue;">Public</span> <span style="color:Blue;">Overrides</span> <span style="color:Blue;">Sub</span> DisposeImp()
            Console.WriteLine(<span style="color:#A31515;">&quot;Doo.IDisposable::Dispose&quot;</span>)
        <span style="color:Blue;">End</span> <span style="color:Blue;">Sub</span>

        <span style="color:Green;">&#39;&#39;&#39; &lt;summary&gt;</span>
        <span style="color:Green;">&#39;&#39;&#39; Неявное перекрытие</span>
        <span style="color:Green;">&#39;&#39;&#39; &lt;/summary&gt;</span>
        <span style="color:Blue;">Public</span> <span style="color:Blue;">Sub</span> Dispose()
            Console.WriteLine(<span style="color:#A31515;">&quot;Doo::Dispose()&quot;</span>)
        <span style="color:Blue;">End</span> <span style="color:Blue;">Sub</span>

    <span style="color:Blue;">End</span> <span style="color:Blue;">Class</span>

    <span style="color:Blue;">Sub</span> Main()
        <span style="color:Blue;">Dim</span> foo <span style="color:Blue;">As</span> <span style="color:Blue;">New</span> Foo
        <span style="color:Blue;">Dim</span> boo <span style="color:Blue;">As</span> <span style="color:Blue;">New</span> Boo
        <span style="color:Blue;">Dim</span> doo <span style="color:Blue;">As</span> <span style="color:Blue;">New</span> Doo

        <span style="color:Blue;">CType</span>(foo, IDisposable).Dispose()
        foo.Dispose()
        <span style="color:Blue;">CType</span>(boo, IDisposable).Dispose()
        boo.Dispose()
        <span style="color:Blue;">CType</span>(doo, IDisposable).Dispose()
        doo.Dispose()
    <span style="color:Blue;">End</span> <span style="color:Blue;">Sub</span>
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">47</div>
<p>В<span class="spacer"> </span>нем<span class="spacer"> </span>вид&shy;но,<span class="spacer"> </span>что<span class="spacer"> </span><code>Doo</code>,<span class="spacer"> </span>нас&shy;ле&shy;ду&shy;ясь<span class="spacer"> </span>от<span class="spacer"> </span><code>Foo</code>,<span class="spacer"> </span>не&shy;яв&shy;но<span class="spacer"> </span>ре&shy;а&shy;ли&shy;зу&shy;ет<span class="spacer"> </span><code>IDispos&shy;able</code>,<span class="spacer"> </span>но<span class="spacer"> </span>при<span class="spacer"> </span>этом<span class="spacer"> </span>пе&shy;ре&shy;оп&shy;ре&shy;де&shy;ля&shy;ет<span class="spacer"> </span>яв&shy;ную<span class="spacer"> </span>ре&shy;а&shy;ли&shy;за&shy;цию<span class="spacer"> </span><code>IDisposable&shy;.Dispose</code>,<span class="spacer"> </span>что<span class="spacer"> </span>при&shy;ведёт<span class="spacer"> </span>к<span class="spacer"> </span>вы&shy;зо&shy;ву<span class="spacer"> </span>пе&shy;ре&shy;оп&shy;ре&shy;де&shy;ле&shy;ния<span class="spacer"> </span>при<span class="spacer"> </span>вы&shy;зо&shy;ве<span class="spacer"> </span>по<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;су,<span class="spacer"> </span>тем<span class="spacer"> </span>са&shy;мым<span class="spacer"> </span>по&shy;ка&shy;зы&shy;вая<span class="spacer"> </span>&laquo;нас&shy;ле&shy;до&shy;ва&shy;ние<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;сов&raquo;<span class="spacer"> </span>клас&shy;сов<span class="spacer"> </span><code>Foo</code><span class="spacer"> </span>и<span class="spacer"> </span><code>Doo</code>.</p>
<div class="paragraph-right-side">47</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">48</div>
<p>С<span class="spacer"> </span>од&shy;ной<span class="spacer"> </span>сто&shy;ро&shy;ны,<span class="spacer"> </span>это<span class="spacer"> </span>во&shy;об&shy;ще<span class="spacer"> </span>не<span class="spacer"> </span>проб&shy;ле&shy;ма:<span class="spacer"> </span>ес&shy;ли<span class="spacer"> </span>бы<span class="spacer"> </span>C#<span class="spacer"> </span>+<span class="spacer"> </span>CLR<span class="spacer"> </span>поз&shy;во&shy;ля&shy;ли<span class="spacer"> </span>та&shy;кие<span class="spacer"> </span>шал&shy;ос&shy;ти,<span class="spacer"> </span>мы<span class="spacer"> </span>бы,<span class="spacer"> </span>в<span class="spacer"> </span>не&shy;ко&shy;то&shy;ром,<span class="spacer"> </span>смыс&shy;ле<span class="spacer"> </span>по&shy;лу&shy;чи&shy;ли<span class="spacer"> </span>на&shy;ру&shy;ше&shy;ние<span class="spacer"> </span>кон&shy;сис&shy;тент&shy;нос&shy;ти<span class="spacer"> </span>в<span class="spacer"> </span>стр&shy;о&shy;ении<span class="spacer"> </span>ти&shy;пов.<span class="spacer"> </span>Са&shy;ми<span class="spacer"> </span>по&shy;дум&shy;ай&shy;те:<span class="spacer"> </span>вы<span class="spacer"> </span>сде&shy;ла&shy;ли<span class="spacer"> </span>кру&shy;тую<span class="spacer"> </span>ар&shy;хит&shy;ек&shy;ту&shy;ру,<span class="spacer"> </span>все<span class="spacer"> </span>хо&shy;ро&shy;шо.<span class="spacer"> </span>Но<span class="spacer"> </span>кто-то<span class="spacer"> </span>по&shy;че&shy;му-то<span class="spacer"> </span>вы&shy;зы&shy;ва&shy;ет<span class="spacer"> </span>ме&shy;то&shy;ды<span class="spacer"> </span>не<span class="spacer"> </span>так,<span class="spacer"> </span>как<span class="spacer"> </span>вы<span class="spacer"> </span>за&shy;ду&shy;ма&shy;ли.<span class="spacer"> </span>Это<span class="spacer"> </span>бы&shy;ло<span class="spacer"> </span>бы<span class="spacer"> </span>ужасно.<span class="spacer"> </span>С<span class="spacer"> </span>дру&shy;гой<span class="spacer"> </span>сто&shy;ро&shy;ны,<span class="spacer"> </span>в<span class="spacer"> </span>C++<span class="spacer"> </span>по&shy;хо&shy;жая<span class="spacer"> </span>воз&shy;мож&shy;ность<span class="spacer"> </span>сущ&shy;ес&shy;тву&shy;ет,<span class="spacer"> </span>и<span class="spacer"> </span>там<span class="spacer"> </span>не<span class="spacer"> </span>силь&shy;но<span class="spacer"> </span>жа&shy;лу&shy;ют&shy;ся<span class="spacer"> </span>на<span class="spacer"> </span>это.<span class="spacer"> </span>По&shy;че&shy;му<span class="spacer"> </span>я<span class="spacer"> </span>го&shy;во&shy;рю,<span class="spacer"> </span>что<span class="spacer"> </span>это<span class="spacer"> </span>мо&shy;жет<span class="spacer"> </span>быть<span class="spacer"> </span>доб&shy;ав&shy;ле&shy;но<span class="spacer"> </span>в<span class="spacer"> </span>C#?<span class="spacer"> </span>По&shy;то&shy;му<span class="spacer"> </span>что<span class="spacer"> </span>не<span class="spacer"> </span>ме&shy;нее<span class="spacer"> </span>ужас&shy;ный<span class="spacer"> </span>фун&shy;кци&shy;о&shy;нал<span class="spacer"> </span><a href="https://github.com/dotnet/csharplang/issues/52">уже<span class="spacer"> </span>об&shy;суж&shy;да&shy;ет&shy;ся</a><span class="spacer"> </span>и<span class="spacer"> </span>выг&shy;ля&shy;деть<span class="spacer"> </span>он<span class="spacer"> </span>дол&shy;жен<span class="spacer"> </span>при&shy;мер&shy;но<span class="spacer"> </span>так:</p>
<div class="paragraph-right-side">48</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">interface</span> IA
{
    <span style="color:Blue;">void</span> M() { WriteLine(<span style="color:#A31515;">&quot;IA.M&quot;</span>); }
}

<span style="color:Blue;">interface</span> IB : IA
{
    <span style="color:Blue;">override</span> <span style="color:Blue;">void</span> IA.M() { WriteLine(<span style="color:#A31515;">&quot;IB.M&quot;</span>); } <span style="color:Green;">// explicitly named</span>
}

<span style="color:Blue;">interface</span> IC : IA
{
    <span style="color:Blue;">override</span> <span style="color:Blue;">void</span> M() { WriteLine(<span style="color:#A31515;">&quot;IC.M&quot;</span>); } <span style="color:Green;">// implicitly named</span>
}
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">49</div>
<p>По&shy;че&shy;му<span class="spacer"> </span>это<span class="spacer"> </span>ужасно?<span class="spacer"> </span>Ведь<span class="spacer"> </span>на<span class="spacer"> </span>са&shy;мом<span class="spacer"> </span>де&shy;ле<span class="spacer"> </span>это<span class="spacer"> </span>пор&shy;ож&shy;да&shy;ет<span class="spacer"> </span>це&shy;лый<span class="spacer"> </span>класс<span class="spacer"> </span>воз&shy;мож&shy;нос&shy;тей.<span class="spacer"> </span>Те&shy;перь<span class="spacer"> </span>нам<span class="spacer"> </span>не<span class="spacer"> </span>нуж&shy;но<span class="spacer"> </span>бу&shy;дет<span class="spacer"> </span>каж&shy;дый<span class="spacer"> </span>раз<span class="spacer"> </span>ре&shy;а&shy;ли&shy;зо&shy;вы&shy;вать<span class="spacer"> </span>ка&shy;кие-то<span class="spacer"> </span>ме&shy;то&shy;ды<span class="spacer"> </span>ин&shy;тер&shy;фей&shy;сов,<span class="spacer"> </span>ко&shy;то&shy;рые<span class="spacer"> </span>вез&shy;де<span class="spacer"> </span>ре&shy;а&shy;ли&shy;зо&shy;вы&shy;ва&shy;лись<span class="spacer"> </span>оди&shy;на&shy;ково.<span class="spacer"> </span>Зву&shy;чит<span class="spacer"> </span>прек&shy;рас&shy;но.<span class="spacer"> </span>Но<span class="spacer"> </span>толь&shy;ко<span class="spacer"> </span>зву&shy;чит.<span class="spacer"> </span>Ведь<span class="spacer"> </span>ин&shy;тер&shy;фейс<span class="spacer"> </span> &mdash; <span class="spacer"> </span>это<span class="spacer"> </span>про&shy;то&shy;кол<span class="spacer"> </span>вза&shy;и&shy;мод&shy;е&shy;йствия.<span class="spacer"> </span>Про&shy;то&shy;кол<span class="spacer"> </span> &mdash; <span class="spacer"> </span>это<span class="spacer"> </span>на&shy;бор<span class="spacer"> </span>пра&shy;вил,<span class="spacer"> </span>рам&shy;ки.<span class="spacer"> </span>В<span class="spacer"> </span>нем<span class="spacer"> </span>нель&shy;зя<span class="spacer"> </span>доп&shy;ус&shy;кать<span class="spacer"> </span>сущ&shy;ес&shy;тво&shy;ва&shy;ние<span class="spacer"> </span>ре&shy;а&shy;ли&shy;за&shy;ций.<span class="spacer"> </span>Здесь<span class="spacer"> </span>же<span class="spacer"> </span>идёт<span class="spacer"> </span>пря&shy;мое<span class="spacer"> </span>на&shy;ру&shy;ше&shy;ние<span class="spacer"> </span>этого<span class="spacer"> </span>прин&shy;ци&shy;па<span class="spacer"> </span>и<span class="spacer"> </span>вве&shy;де&shy;ние<span class="spacer"> </span>ещё<span class="spacer"> </span>од&shy;но&shy;го:<span class="spacer"> </span>мно&shy;жест&shy;вен&shy;но&shy;го<span class="spacer"> </span>нас&shy;ле&shy;до&shy;ва&shy;ния.<span class="spacer"> </span>Я,<span class="spacer"> </span>чес&shy;т&shy;но,<span class="spacer"> </span>силь&shy;но<span class="spacer"> </span>про&shy;тив<span class="spacer"> </span>та&shy;ких<span class="spacer"> </span>до&shy;ра&shy;бо&shy;ток,<span class="spacer"> </span>но&hellip;<span class="spacer"> </span>Я<span class="spacer"> </span>что-то<span class="spacer"> </span>ушёл<span class="spacer"> </span>в<span class="spacer"> </span>сто&shy;ро&shy;ну.</p>
<div class="paragraph-right-side">49</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">50</div>
<p><a href="https://github.com/dotnet/coreclr/blob/master/src/vm/contractimpl.cpp#L295-L460">Dispatch&shy;Map::Create&shy;Encoded&shy;Mapping</a></p>
<div class="paragraph-right-side">50</div>
</div>
<blockquote>
<p>Да&shy;лее:<span class="spacer"> </span><a href="./3-MemorySpan.html">Memory&lt;T&gt;<span class="spacer"> </span>и<span class="spacer"> </span>Span&lt;T&gt;</a></p>
</blockquote>

        </div>
    </div>
    <footer>
        <div class="footer-container">
            <div class="footer-wrap">
                <img src="../../../ru/res/img/logo-w-noindex.svg">
                <p>
                    <a class="footer-link" target="_blank" href="mailto:sidristij@clrium.ru"><i class="far fa-envelope" aria-hidden="true"></i></a>
                    <a class="footer-link" target="_blank" href="https://vk.com/clrium"><i class="fab fa-vk" aria-hidden="true"></i></a>
                    <a class="footer-link" target="_blank" href="https://youtube.com/clrium"><i class="fab fa-youtube" aria-hidden="true"></i></a>
                    <a class="footer-link" target="_blank" href="https://github.com/clrium"><i class="fab fa-github" aria-hidden="true"></i></a>
                    <a class="footer-link" target="_blank" href="skype:stanislav.sidristyi"><i class="fab fa-skype" aria-hidden="true"></i></a>
                    <a class="footer-link" target="_blank" href="https://t.me/clrium_group"><i class="fab fa-telegram" aria-hidden="true"></i></a>
                </p>
            </div>
        </div>
    </footer>
</body>
</html>