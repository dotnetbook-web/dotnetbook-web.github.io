<!DOCTYPE html>
<html lang="ru">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>.NET Platform Architecture</title>
</head>
<body>
    <link rel="stylesheet" href="../../res/bootstrap.css">
    <link rel="stylesheet" href="../../res/awesome.css">
    <style>
        body {
    font-family: PF Regal,Georgia,serif;
    font-size: 16pt;
    font-weight: 300;
    padding-top: 4em;
}

.book-title-container {
    width: 100%;
    text-align: center;
    margin: 73px 0 110px 0;
}

.book-title {
    font-size: 57pt;
    margin: 50px 0 70px 0;
    user-select: none;
}
.book-part-title-block {
    display: inline-block;
}
.book-part-title {
    font-size: 21pt;
    color: #656ab6;
    margin: 0 7px;
}

.book-part-title:hover {
    box-shadow: inset 0 -1px #007bff;
    text-decoration: none;
}

.book-superheading-title {
    font-size: 15pt;
    margin: 0 7px;
    color: #656ab6;
}

.article-container
{
    width: 62%;
}

strong {
    font-weight: 500;
}

p, li {
    margin: 0 0 1em;
    line-height: 1.5em;
    font-family: inherit;
}

ol, li {
    margin-top: 1em;
    margin-bottom: 1em;
}

ol {
    padding-left: 1.21em;
}

ul  {
    padding-left: 1em;
}

ol li, ul li {
    padding-left: 0.5em;	
    font-family: inherit;
    text-align: justify;
}

table {
    margin: 30px 0;
    width: 100%;
}

thead {
    background-color: aliceblue;
}

table th {
    font-weight: 400;
}

table td, table th {
    padding: 7px;
    border-top: solid darkgrey 1px;
    border-bottom: solid darkgrey 1px;
    border-right: dotted darkgray 1px;
    border-left: dotted darkgray 1px;
    font-size: smaller;
}

code, *[class*='lang-'] span, *[class*='lang-'] pre {
    font-family: JB Mono, monospace !important;
}

*[class*='lang-'] {
    padding: 0px 0px 25px 0px;
    font-size: 0.75em;
}


*[class*='lang-'] > div, pre > code {
    border-left-color: #eee;
    border-left-style: dotted;
    border-left-width: 3px;
    padding-left: 25px;
    display: block;
    padding-top: 20px;
    padding-bottom: 20px;
}

*[class*='lang-'] > div pre, pre > code pre {
    margin-bottom: 0;
}

p code:not(.highlight), li code:not(.highlight) {
    font-size: 0.7em;
    border: gainsboro;
    border-width: 1px;
    border-style: solid;
    padding: 3px;
    color: darkslateblue;
}

code.highlight {
    font-family: inherit !important;
    font-size: inherit;
    font-weight: inherit;
    color: inherit;
}

p code.highlight, li code.highlight {
    padding: 4px;
    background-color: #ffffa1;
}

.wide {
    width:140%;
}

p a, li a {
    text-decoration: none;
    color: inherit;
    box-shadow: inset 0 -1px #b88b59;
}

p a:hover, li a:hover {
    text-decoration: none;
    color: inherit;
    box-shadow: inset 0 -1px #0056b3;
}

blockquote h5 {
    background-color: aquamarine;
    margin: 16px 0 16px -20px;
    padding: 15px 30px 15px;
}

p img {
    width: 95%;
}

blockquote 
{
    padding-left: 0.4em;
    border-left: 0.5em solid rgba(0,0,0,.08);
    font-style: italic;
}

blockquote.big-quote, 
blockquote.breadcrumbs 
{
    background-color: transparent;
    padding: 0;
    border-left: none;
    font-style: normal;
}

blockquote.breadcrumbs, blockquote.breadcrumbs  p
{
    margin: 0;
    padding: 0;
}

blockquote p {
    padding: 1em 1em 1em 0.6em;
    font-family: inherit;
}

blockquote p code {
    font-family: consolas, monospace;
    font-size: 17px;
    padding: 4px 6px;
}

blockquote p em {
    font-weight: 400;
}

blockquote.big-quote > p {
    margin: 0.7em 0 0.7em 0;
    font-family: Charter;
    font-size: 2.5em;
    padding: 0;
    width: 130%;
    line-height: 1em;
}

h1, h2, h3, h4, h5, h6 {
    margin: 0;
    padding: 0;
    font-weight: 400;
    font-family: inherit;
}

h1 {
    font-size: 2.2em;
    font-family: Charter,Georgia,serif;
    font-weight: 300;
    margin: 1.8em 0 1.8em 0;
    text-align: center;
    width: 140%;
}

h2 {
    margin-top: 2em;
    font-family: Charter,Arial,Helvetica Neue,sans-serif;
    font-size: 1.25em;
    width: 70%;
}

h3 {
    margin: 30px 0 15px 0;
    font-size: 17pt;
    font-weight: 500;
}

h4 {
    margin: 20px 0 10px 0;
    font-size: 16pt;
    font-weight: 500;
    font-style: italic;
}

/* Sidenotes */

.aside-container {
    position: relative;
}
.aside-container p {
    position: relative;
    top: 9px;
}

.aside-container > .aside-side-container {
    display: block;
    position: absolute;
    top: 12px;
    left: 96%;
    width: 34%;
    font-size: 12pt;
    line-height: 20px;
    margin-left: 100px;
    z-index: 1000;
}

.aside-container > .aside-side-container p {
    line-height: 24px;
    font-size: 13pt;
    margin: 0 0 13px 0;
}

.side-regular-block p {
    top: 0;
}

/* Music side player */
.aside-side-container .music-player {
    width: 100%;
    height: 400px;
}

/* media block after h1 */
.aside-container h1 + .aside-side-container.side-media-block h2 {
    margin: 7em 0 1em 0;
    font-family: Proxima Nova,Arial,Helvetica Neue,sans-serif;
    font-weight: 600;
}

.aside-side-container > li {
    display: block;
    font-family: Charter;
}

.aside-side-container > li ul, .aside-side-container > li ol {
    padding-left: 30px;
    margin-top: 0.5em;
    margin-bottom: 0.5em;
}
.aside-side-container > li li {
    padding-left: 6px;
    margin: 0 0 6px;
    line-height: 22px;

    font-family: Charter;
}

.aside-side-container p {
    line-height: 25px;
    font-size: 13pt;
    margin: 0 0 15px 0;
}

.aside-side-container blockquote {
    border: aliceblue;
    border-left-style: solid;
}

/* Paragraphs numbering */
.paragraph-container {
    position: relative;
}
.paragraph-container p {
    position: relative;
    top: 9px;
}

.paragraph-container p, .aside-container > p {
    text-align: justify;
}

.paragraph-container > .paragraph-left-side, .paragraph-container > .paragraph-right-side  {
    font-family: JB Mono, consolas;
    display: block;
    position: absolute;
    top: 17px;
    font-size: 10pt;
    line-height: 20px;
    color: #86abc473;
    z-index: 1000;
}
.paragraph-container > .paragraph-left-side {
    display: none;
    left: -2.1cm;
    width: 35px;
    user-select: none;
}

.paragraph-container > .paragraph-right-side  {
    display: none;
    left: 100%;
    width: 35px;
    padding-left: 45px;
    user-select: none;
}

.article-container
{
    width: 70%;
}

.menu-title {
    text-align: center;
    margin: 35px 50px 35px 50px;
    font-size: 24pt;
    font-family: Charter;
}

.menu-container ol {
    margin: 0;
    padding: 0;
}

.menu-container ol li {
    margin: 0;
    padding: 0;
}

.header {
    height: 4em;
    background-color: white;
    position: relative;
    z-index: 1500;
    width: 100%;
    display: flex;
    justify-content: space-between;
    transition: all 1s;
    top: 0;
    box-shadow: 1px -4px 20px rgba(0, 0, 0, .1);
}

.fixed {
    position: fixed !important;
}

.header > .menu {
    pointer-events: auto;
    float: right;
    height: 40px;
    font-family: Charter, 'Helvetica Neue', Arial, sans-serif;
    font-size: 1em;
    color: #fff;
    margin-top:40px;
    margin-right:40px;
}

.menu a {
    color: #fff;
}
.menu a:hover {
    text-decoration: none;
    color: #fff;
}

#menu__toggle {
    opacity: 0;
}

#menu__toggle:checked ~ .menu__btn > span {
    transform: rotate(45deg);
}
#menu__toggle:checked ~ .menu__btn > span::before {
    top: 0;
    transform: rotate(0);
    background-color: black
}
#menu__toggle:checked ~ .menu__btn > span::after {
    top: 0;
    transform: rotate(90deg);
    background-color: black
}
#menu__toggle:checked ~ .menu__box {
    visibility: visible;
    right: 0;
}

.menu__btn {
    display: flex;
    align-items: center;
    position: fixed;
    top: 0;
    right: 0;
    width: 1.4em;
    height: 1.0em;
    cursor: pointer;
    z-index: 1;
    margin: 1.5em;
}

.menu__btn > span,
.menu__btn > span::before,
.menu__btn > span::after {
    display: block;
    position: absolute;

    width: 100%;
    height: 1px;

    background-color: black;

    transition-duration: .25s;
}
.menu__btn > span::before {
    content: '';
    top: -8px;
}
.menu__btn > span::after {
    content: '';
    top: 8px;
}

.menu__box {
    display: block;
    position: fixed;
    visibility: hidden;
    top: 0;
    right: -100%;

    width: 100%;
    height: 100%;

    margin: 0;
    padding: 80px 0;

    list-style: none;

    background-color: white;
    box-shadow: 1px 0px 6px rgba(0, 0, 0, .2);

    transition-duration: .25s;
}
.menu__box li a:hover {
    text-decoration: none;
    color: inherit;
}
.menu__item {
    display: block;
    padding: 12px 24px;

    color: #333;

    font-family: 'Gotham Pro','Roboto', sans-serif;
    font-size: 20px;
    font-weight: 600;

    text-decoration: none;

    transition-duration: .25s;
}
.menu__item:hover {
    background-color: #CFD8DC;
}


.conflogo {
    height: 1.2em;
    margin: 0.95em 0 0 1em;
    font-size: 1.5em;
    font-family: Charter;
}

.invisible {
    display: none;
}

.header > .menu > div {
    display: inline;
    margin-left: 10px;
    margin-right: 10px;
}

footer {
    margin-top: 2em;
    background-color: black;
    height: 4em;
}

.footer-container {
    height: 100%;
}

.footer-wrap {
    color: #fff;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 25px 0;
}

.footer-wrap p {
    margin: 0;
    padding: 0px;
    line-height: 1em;
}

.footer-container img {
    height: 1.6em;
    margin-top: auto;
    margin-bottom: auto;
}

.footer-link {
    color: white;
    margin: 0 7px;
    font-size: 1em;
    box-shadow: none;
}
.footer-link:hover {
    color: salmon;
    box-shadow: none;
}

/* MEDIA */
/* XXL */
@media (min-width: 1601px) {
    .book-container
    {
        max-width: 1200px;
        margin-left: auto;
        margin-right: auto;
    }
}

/* XL */
@media (max-width: 1600px) {
    .book-container
    {
        margin-left: 4cm;
        margin-right: 4cm;
    }
}

/* LG */
@media (max-width: 1400px) {
    .book-container
    {
        margin-left: 4cm;
        margin-right: 4cm;
    }

    blockquote.big-quote > p {
        font-size: 2em;
    }
}

/* > MD */
@media (min-width: 992px) {
    .hamburger-menu {
        display: none;
    }
}

/* MD */
@media (max-width: 991px) {
    
    h2 {
        width:80%;
    }

    .book-container
    {
        margin-left: 3cm;
        margin-right: 3cm;
    }
    
    .book-title-container {
        margin: 73px 0 110px 0;
    }

    .book-title {
        font-size: 50pt;
        margin: 50px 0 70px 0;
    }

    .book-part-title {
        font-size: 19pt;
    }

    .book-part-title:hover {
        box-shadow: inset 0 -1px #007bff;
    }

    .book-superheading-title {
        font-size: 15pt;
    }                                     

    .article-container, h1 {
        width: 100%;
    }

    .aside-container p {
        top: 0;
    }

    .aside-container h1 + .aside-side-container.side-media-block h2 {
        display: none;
    }

    .wide {
        width: 100%;     
    }

    .side-regular-block {
        margin: 40px 10px;
        padding-left: 100px;
    }
    .aside-side-container .music-player {
        width: 100%;
        height: 100px;
    }
    .aside-side-container.side-media-block {
        padding: 17px 0;
    }
    .aside-side-container.side-media-block h2 {
        margin-top: 20px;
        font-size: 13pt;
        border: none;
    }

    .aside-container > .aside-side-container
    {
        position: relative;
        top: auto;
        left: auto;
        width: auto;
        height: auto;
        margin: 0;
        padding: 17px;
    }

    blockquote.big-quote > p {
        width: 100%;
        font-size: 2em;
    }

    .paragraph-container .paragraph-left-side {
        left: -55px;
    }

    body {
        font-size: 15pt;
    }

    p code:not(.highlight), li code:not(.highlight) {
        font-size: 11pt;
    }

    p, li {
        line-height: 30px;
    }
    
    li {
        margin: 0 0 10px 0;
    }

    .side-regular-block {
        border-radius: 5px;
        background-image: linear-gradient(180deg,hsla(0,0%,100%,0) 60%,#fff),linear-gradient(70deg,#dbedff 32%,#ebfff0);
        padding: 22px;
    }    
}

/* Smartphone horizontal - SM */
@media (max-width: 767px) {
    .book-title-container {
        margin: 73px 0 110px 0;
    }

    h1 {
        margin: 1.8em 0em 1.8em 0.3em;
    }

    .book-title {
        font-size: 40pt;
        margin: 50px 0 70px 0;
    }

    .book-part-title {
        font-size: 19pt;
    }

    .book-part-title:hover {
        box-shadow: inset 0 -1px #007bff;
    }

    .book-superheading-title {
        font-size: 17pt;
    }

    .book-container {
        margin: 0 2.5cm;
    }
    ul {
        margin-left: 30px;
        margin-right: 30px;
        padding-left: 25px;
    }
    .paragraph-container > .paragraph-left-side {
	    display: block;
        top: 14px;
        font-size: 9pt;
    }
    .paragraph-container > .paragraph-right-side {
    	display: block;
        padding-left: 40px;
        top: 14px;
        font-size: 9pt;
    }
    .footer-container img {
        height: 1.3em;
    } 
}

@media (max-width: 630px) {
    .book-container {
        margin: 0 1.5cm;
    }
    .paragraph-container > .paragraph-left-side {
        left: -33px;
    }
    .paragraph-container > .paragraph-right-side {
        padding-left: 24px;
    }
}
/* Smartphone - XS */
@media (max-width: 575px) {
    .book-container {
        margin: 0 50px 0 30px;
    }
    ul {
        margin: 0;
        padding-left: 20px;
    }

    body {
        font-size: 13pt;
    }

    p code:not(.highlight), li code:not(.highlight) 
    {
        font-size: 10pt;
        padding: 3px;
    }
   
    p, li {
        line-height: 24px;
    }    
    
    .paragraph-container .paragraph-left-side 
    {
        display: none;        
    }
    .paragraph-container .paragraph-right-side 
    {
        padding-left: 21px;
        top: 14px;
	    font-size: 8pt;
    }
    .footer-container img {
        height: 1em;
    } 
}

/* Fonts */

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-Bold.eot');
    src: local('../../res/fonts/PFRegalTextPro-Bold'),
        url('../../res/fonts/PFRegalTextPro-Bold.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-Bold.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-Bold.ttf') format('truetype');
    font-weight: bold;
    font-style: normal;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-Medium.eot');
    src: local('../../res/fonts/PFRegalTextPro-Medium'),
        url('../../res/fonts/PFRegalTextPro-Medium.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-Medium.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-Medium.ttf') format('truetype');
    font-weight: 500;
    font-style: normal;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-BlackItalic.eot');
    src: local('../../res/fonts/PFRegalTextPro-BlackItalic'),
        url('../../res/fonts/PFRegalTextPro-BlackItalic.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-BlackItalic.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-BlackItalic.ttf') format('truetype');
    font-weight: 900;
    font-style: italic;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-Black.eot');
    src: local('../../res/fonts/PFRegalTextPro-Black'),
        url('../../res/fonts/PFRegalTextPro-Black.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-Black.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-Black.ttf') format('truetype');
    font-weight: 900;
    font-style: normal;
}

@font-face {
    font-family: 'PF Regal UBlack';
    src: url('../../res/fonts/PFRegalTextPro-UBlack.eot');
    src: local('../../res/fonts/PFRegalTextPro-UBlack'),
        url('../../res/fonts/PFRegalTextPro-UBlack.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-UBlack.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-UBlack.ttf') format('truetype');
    font-weight: 900;
    font-style: normal;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-MediumItalic.eot');
    src: local('../../res/fonts/PFRegalTextPro-MediumItalic'),
        url('../../res/fonts/PFRegalTextPro-MediumItalic.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-MediumItalic.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-MediumItalic.ttf') format('truetype');
    font-weight: 500;
    font-style: italic;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-UBlackItalic.eot');
    src: local('../../res/fonts/PFRegalTextPro-UBlackItalic'),
        url('../../res/fonts/PFRegalTextPro-UBlackItalic.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-UBlackItalic.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-UBlackItalic.ttf') format('truetype');
    font-weight: 900;
    font-style: italic;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-RegularAItalic.eot');
    src: local('../../res/fonts/PFRegalTextPro-RegularAItalic'),
        url('../../res/fonts/PFRegalTextPro-RegularAItalic.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-RegularAItalic.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-RegularAItalic.ttf') format('truetype');
    font-weight: 300;
    font-style: italic;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-BoldItalic.eot');
    src: local('../../res/fonts/PFRegalTextPro-BoldItalic'),
        url('../../res/fonts/PFRegalTextPro-BoldItalic.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-BoldItalic.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-BoldItalic.ttf') format('truetype');
    font-weight: bold;
    font-style: italic;
}

@font-face {
    font-family: 'Charter';
    src: url('../../res/fonts/charter-regular.woff2') format('woff2');
    font-weight: normal;
    font-style: normal;
}

/*  Regular B */
@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-RegularBItalic.eot');
    src: local('../../res/fonts/PFRegalTextPro-RegularBItalic'),
        url('../../res/fonts/PFRegalTextPro-RegularBItalic.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-RegularBItalic.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-RegularBItalic.ttf') format('truetype');
    font-weight: 300;
    font-style: italic;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-RegularB.eot');
    src: local('../../res/fonts/PFRegalTextPro-RegularB'),
        url('../../res/fonts/PFRegalTextPro-RegularB.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-RegularB.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-RegularB.ttf') format('truetype');
    font-weight: 300;
    font-style: normal;
}

@font-face {
    font-family: 'JB Mono';
    src: url('../../res/fonts/JetBrainsMono-Regular.eot');
    src: local('../../res/fonts/JetBrainsMono-Regular'),
        url('../../res/fonts/JetBrainsMono-Regular.woff2') format('woff2'),
        url('../../res/fonts/JetBrainsMono-Regular.woff') format('woff'),
        url('../../res/fonts/JetBrainsMono-Regular.ttf') format('truetype');
    font-weight: 300;
    font-style: normal;
}
@font-face {
    font-family: 'JB Mono';
    src: url('../../res/fonts/JetBrainsMono-Italic.eot');
    src: local('../../res/fonts/JetBrainsMono-Italic'),
        url('../../res/fonts/JetBrainsMono-Italic.woff2') format('woff2'),
        url('../../res/fonts/JetBrainsMono-Italic.woff') format('woff'),
        url('../../res/fonts/JetBrainsMono-Italic.ttf') format('truetype');
    font-weight: 300;
    font-style: italic;
}

@font-face {
    font-family: 'JB Mono';
    src: url('../../res/fonts/JetBrainsMono-Medium.eot');
    src: local('../../res/fonts/JetBrainsMono-Medium'),
        url('../../res/fonts/JetBrainsMono-Medium.woff2') format('woff2'),
        url('../../res/fonts/JetBrainsMono-Medium.woff') format('woff'),
        url('../../res/fonts/JetBrainsMono-Medium.ttf') format('truetype');
    font-weight: 500;
    font-style: normal;
}
@font-face {
    font-family: 'JB Mono';
    src: url('../../res/fonts/JetBrainsMono-Medium-Italic.eot');
    src: local('../../res/fonts/JetBrainsMono-Medium-Italic'),
        url('../../res/fonts/JetBrainsMono-Medium-Italic.woff2') format('woff2'),
        url('../../res/fonts/JetBrainsMono-Medium-Italic.woff') format('woff'),
        url('../../res/fonts/JetBrainsMono-Medium-Italic.ttf') format('truetype');
    font-weight: 500;
    font-style: italic;
}
@font-face {
    font-family: 'Font Awesome 5 Free';
    font-style: normal;
    font-weight: 400;
    font-display: swap;
    src: url("../../res/fonts/webfonts/fa-regular-400.eot");
    src: url("../../res/fonts/webfonts/fa-regular-400.eot?#iefix") format("embedded-opentype"), 
         url("../../res/fonts/webfonts/fa-regular-400.woff2") format("woff2"), 
         url("../../res/fonts/webfonts/fa-regular-400.woff") format("woff"), 
         url("../../res/fonts/webfonts/fa-regular-400.ttf") format("truetype"), 
         url("../../res/fonts/webfonts/fa-regular-400.svg#fontawesome") format("svg"); 
    font-display: swap;
}
    
.fa {
    font-family: 'Font Awesome 5 Free';
    font-weight: 400;
    font-display: swap;
}
@font-face {
  font-family: 'Font Awesome 5 Brands';
  font-style: normal;
  font-weight: 400;
  font-display: auto;
  src: url("../../res/fonts/fa-brands-400.eot");
  src: url("../../res/fonts/fa-brands-400.eot?#iefix") format("embedded-opentype"), url("../../res/fonts/fa-brands-400.woff2") format("woff2"), url("../../res/fonts/fa-brands-400.woff") format("woff"), url("../../res/fonts/fa-brands-400.ttf") format("truetype"), url("../../res/fonts/fa-brands-400.svg#fontawesome") format("svg"); 
}

.fab {
  font-family: 'Font Awesome 5 Brands';
  font-weight: 400; 
}

@font-face {
  font-family: 'Font Awesome 5 Free';
  font-style: normal;
  font-weight: 400;
  font-display: auto;
  src: url("../../res/fonts/fa-regular-400.eot");
  src: url("../../res/fonts/fa-regular-400.eot?#iefix") format("embedded-opentype"), url("../../res/fonts/fa-regular-400.woff2") format("woff2"), url("../../res/fonts/fa-regular-400.woff") format("woff"), url("../../res/fonts/fa-regular-400.ttf") format("truetype"), url("../../res/fonts/fa-regular-400.svg#fontawesome") format("svg"); 
}

.far {
  font-family: 'Font Awesome 5 Free';
  font-weight: 400; 
}

@font-face {
  font-family: 'Font Awesome 5 Free';
  font-style: normal;
  font-weight: 900;
  font-display: auto;
  src: url("../../res/fonts/fa-solid-900.eot");
  src: url("../../res/fonts/fa-solid-900.eot?#iefix") format("embedded-opentype"), url("../../res/fonts/fa-solid-900.woff2") format("woff2"), url("../../res/fonts/fa-solid-900.woff") format("woff"), url("../../res/fonts/fa-solid-900.ttf") format("truetype"), url("../../res/fonts/fa-solid-900.svg#fontawesome") format("svg"); 
}
  
    </style>
    <!--
    <div class="book-title-container d-none d-md-block">
        <div class="book-title">Knowledge Base</div>
        <div class="book-part-title-block">pt.1 <a href="../..//ru/Memory/01-00-MemoryManagement-Intro.html" class="book-part-title">Управление памятью</a></div>
        <div class="book-part-title-block">pt.2 <a href="../..//ru/Execution/02-00-ExecutionFlow-Intro.html" class="book-part-title">Поток исполнения команд</a></div>
        <br><a href="#" class="book-superheading-title">Обоснование выбора</a>
        / <a href="#" class="book-superheading-title">Упрощенное описание</a>
        / <a href="#" class="book-superheading-title">Подробное описание</a>
    </div>
    -->
    <header class="header fixed">
        <p class="conflogo">KB</p> 
        <div class="menu">
            <div><a href="index.html">О конференции</a></div>
            <div><a href="mentor.html">Ментор</a></div>
            <div><a href="practice.html">Практика</a></div>
            <div><a href="matrix.html">Доклады</a></div>
            <a href="register.html" class="register_button">РЕГИСТРАЦИЯ</a>
        </div>

        <!-- mobile-menu -->

        <div class="hamburger-menu">
            <input id="menu__toggle" type="checkbox" />
            <label class="menu__btn" for="menu__toggle">
              <span></span>
            </label>
        
            <div class="menu__box">
                <!-- меню мобильного вида -->
            </div>
        </div>
    </header>

    <div class="book-container">
        <div class="article-container">
            <!--<p class="d-xs-block d-sm-none">XS</p>
            <p class="d-none d-xs-block d-sm-none">SM</p>
            <p class="d-none d-sm-block d-md-none">MD</p>
            <p class="d-none d-lg-block d-xl-none">LG</p>
            <p class="d-none d-xl-block">XL</p> -->
            <blockquote class="breadcrumbs">
<p >
 <a href="../readme.html">Содержание</a> / <a href="./01-00-MemoryManagement-Intro.html">Основы управления памятью</a></p>
</blockquote>
<h2 id="section">Выделение памяти под объект</h2>
<blockquote class="big-quote">
<p >
 Адап&shy;та&shy;ция кур&shy;са в про&shy;цес&shy;се</p>
</blockquote>
<div class="paragraph-container">
<div class="paragraph-left-side">01</div>
<p >
Мы толь&shy;ко что по&shy;го&shy;во&shy;ри&shy;ли про GC с вы&shy;со&shy;ты птич&shy;ьего по&shy;ле&shy;та. Сей&shy;час бу&shy;дем ухо&shy;дить в под&shy;роб&shy;нос&shy;ти. В пер&shy;вую оче&shy;редь, хо&shy;чет&shy;ся по&shy;об&shy;щать&shy;ся про ал&shy;го&shy;ритм вы&shy;де&shy;ле&shy;ния па&shy;мя&shy;ти.</p>
<div class="paragraph-right-side">01</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">02</div>
<p >
Управ&shy;ле&shy;ние па&shy;мятью .NET раз&shy;ра&shy;бот&shy;чи&shy;ка ин&shy;те&shy;ре&shy;су&shy;ет со сто&shy;ро&shy;ны двух ос&shy;нов&shy;ных про&shy;цес&shy;сов: пер&shy;вое  - это вы&shy;де&shy;лить па&shy;мять, вто&shy;рое - ос&shy;во&shy;бо&shy;дить. Про вы&shy;де&shy;ле&shy;ние па&shy;мя&shy;ти мы сей&shy;час и по&shy;го&shy;во&shy;рим.</p>
<div class="paragraph-right-side">02</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">03</div>
<p >
С точ&shy;ки зре&shy;ния про&shy;цес&shy;со&shy;ра па&shy;мять выг&shy;ля&shy;дит нес&shy;коль&shy;ко слож&shy;нее. Если го&shy;во&shy;рит про ар&shy;хи&shy;тек&shy;ту&shy;ру уп&shy;рав&shy;ле&shy;ния па&shy;мя&shy;ти, я бы ска&shy;зал, что она раз&shy;де&shy;ле&shy;на на слои. Пер&shy;вый слой, ко&shy;то&shy;рый ви&shy;дим мы, слой .NET дос&shy;та&shy;точ&shy;но слож&shy;ный, но вер&shy;хо&shy;уров&shy;не&shy;вый. То есть он в лю&shy;бом слу&shy;чае опи&shy;ра&shy;ет&shy;ся на что-то дру&shy;гое, а имен&shy;но на слои уп&shy;рав&shy;ле&shy;ния па&shy;мятью Windows, ко&shy;то&shy;рый в свою оче&shy;редь за&shy;пу&shy;щен на ка&shy;ком-то про&shy;цес&shy;со&shy;ре. Про&shy;цес&shy;сор по-сво&shy;ему ин&shy;терп&shy;ре&shy;ти&shy;ру&shy;ет эту па&shy;мять. Та&shy;ким об&shy;ра&shy;зом, у нас фак&shy;ти&shy;чес&shy;ки су&shy;щес&shy;тву&shy;ет три слоя уп&shy;рав&shy;ле&shy;ния па&shy;мятью.</p>
<div class="paragraph-right-side">03</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">04</div>
<p >
Па&shy;мять с точ&shy;ки зре&shy;ния про&shy;цес&shy;со&shy;ра - это план&shy;ка, фи&shy;зи&shy;чес&shy;кая па&shy;мять, RAM. Сколь&shy;ко пла&shy;нок мы пос&shy;та&shy;ви&shy;ли, столь&shy;ко он и ви&shy;дит. Но у нас есть зна&shy;ния, что каж&shy;дый за&shy;пу&shy;щен&shy;ный в сис&shy;те&shy;ме Windows про&shy;цесс изо&shy;ли&shy;ро&shy;ван. И кро&shy;ме се&shy;бя он боль&shy;ше ни&shy;че&shy;го не ви&shy;дит. Есть сам про&shy;цесс, winapi и боль&shy;ше ни&shy;че&shy;го во&shy;об&shy;ще. Word не ви&shy;дит Exel. Exel не ви&shy;дит каль&shy;ку&shy;ля&shy;тор. Все они изо&shy;ли&shy;ро&shy;ва&shy;ны пол&shy;ностью. По&shy;то&shy;му что на ар&shy;хи&shy;тек&shy;ту&shy;ре Intel сде&shy;ла&shy;на вир&shy;ту&shy;а&shy;ли&shy;за&shy;ция па&shy;мя&shy;ти.</p>
<div class="paragraph-right-side">04</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">05</div>
<p >
Как она ра&shy;бо&shy;та&shy;ет. Есть таб&shy;ли&shy;цы гло&shy;баль&shy;ных деск&shy;рип&shy;то&shy;ров, ко&shy;то&shy;рые мы не ви&shy;дим, есть таб&shy;ли&shy;цы ло&shy;каль&shy;ных деск&shy;рип&shy;то&shy;ров, ко&shy;то&shy;рые ку&shy;да-то от&shy;сы&shy;ла&shy;ют&shy;ся. И все вмес&shy;те это ссы&shy;ла&shy;ет&shy;ся на Page Frame.</p>
<div class="paragraph-right-side">05</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">06</div>
<p >
У лю&shy;бо&shy;го про&shy;цес&shy;са есть не&shy;кий ди&shy;а&shy;па&shy;зон па&shy;мя&shy;ти от ну&shy;ля и до, нап&shy;ри&shy;мер, 4Гб на x32 сис&shy;те&shy;ме и до ус&shy;лов&shy;ной бес&shy;ко&shy;неч&shy;нос&shy;ти на x64. Это ди&shy;а&shy;па&shy;зон вир&shy;ту&shy;альной па&shy;мя&shy;ти. Про&shy;цес&shy;сор соз&shy;да&shy;ет для конк&shy;рет&shy;ной прог&shy;рам&shy;мы не&shy;кий вир&shy;ту&shy;альный ку&shy;сок, где есть толь&shy;ко она. Эта об&shy;ласть по&shy;де&shy;ле&shy;на на стра&shy;ни&shy;цы: на ку&shy;соч&shy;ки по 4Кб. Каж&shy;дый их них оз&shy;на&shy;ча&shy;ет, что па&shy;мять в этом мес&shy;те ли&shy;бо су&shy;щес&shy;тву&shy;ет, ли&shy;бо ее там не су&shy;щес&shy;тву&shy;ет, т.е. она фи&shy;зи&shy;чес&shy;ки в этом мес&shy;те от&shy;сут&shy;ствует пол&shy;ностью. Адрес есть, а па&shy;мя&shy;ти там нет. Это воз&shy;ни&shy;ка&shy;ет в си&shy;ту&shy;а&shy;ци&shy;ях, ког&shy;да план&shy;ка, нап&shy;ри&shy;мер на 4Гб, встав&shy;ле&shy;на в ма&shy;те&shy;рин&shy;с&shy;кую пла&shy;ту, а про&shy;цес&shy;сов у нас за&shy;пу&shy;ще&shy;на сот&shy;ня и Windows 32х раз&shy;ряд&shy;ный. Зна&shy;чит, что у каж&shy;дой прог&shy;рам&shy;мы 4Гб па&shy;мя&shy;ти, но при этом они друг от дру&shy;га изо&shy;ли&shy;ро&shy;ва&shy;ны.</p>
<div class="paragraph-right-side">06</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">07</div>
<p >
Как 4 Гб  по&shy;де&shy;лить на сто и по&shy;лу&shy;чить 4 каж&shy;до&shy;му? Ни&shy;как. Это зна&shy;чит, что у каж&shy;дой прог&shy;рам&shy;мы на че&shy;ты&shy;рех&shy;ги&shy;га&shy;байт&shy;ном учас&shy;тке есть мес&shy;та, где па&shy;мя&shy;ти не во&shy;об&shy;ще, там толь&shy;ко вы&shy;де&shy;ле&shy;ны ку&shy;соч&shy;ки ад&shy;ре&shy;сов. Но где-то па&shy;мять есть и она за&shy;мап&shy;ле&shy;на на план&shy;ку фи&shy;зи&shy;чес&shy;кую. А ес&shy;ли не за&shy;мап&shy;ле&shy;на - па&shy;мя&shy;ти нет. Если ту&shy;да об&shy;ра&shy;тить&shy;ся, что-то по&shy;пы&shy;тать&shy;ся счи&shy;тать, вы по&shy;лу&shy;чи&shy;те не ноль, а AccessViolationException. Искл&shy;юч&shy;ение, ко&shy;то&shy;рое го&shy;во&shy;рит о том, что вы пы&shy;та&shy;е&shy;тесь ра&shy;бо&shy;тать с кус&shy;ком, ко&shy;то&shy;рый не су&shy;щес&shy;тву&shy;ет, ли&shy;бо на ко&shy;то&shy;рый у вас нет прав. На дан&shy;ном уров&shy;не ис&shy;клю&shy;че&shy;ние раз&shy;ли&shy;чий не де&shy;ла&shy;ет.</p>
<div class="paragraph-right-side">07</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">08</div>
<p >
Точ&shy;но так&shy;же ра&shy;бо&shy;тать с Wap. (см. слайд 06:30). На изоб&shy;ра&shy;же&shy;нии вы&shy;де&shy;ле&shy;ны про&shy;цес&shy;сы в ви&shy;де стол&shy;би&shy;ков. Там, где бе&shy;лый шум - па&shy;мять вы&shy;де&shy;ле&shy;на и за&shy;пол&shy;не&shy;на. А там, где про&shy;пус&shy;ки - па&shy;мя&shy;ти нет. Вы&shy;де&shy;лен&shy;ные об&shy;лас&shy;ти мо&shy;гут быть за&shy;мап&shy;ле&shy;ны как на фи&shy;зи&shy;чес&shy;кую па&shy;мять, так и на жест&shy;кий диск.</p>
<div class="paragraph-right-side">08</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">09</div>
<p >
Если, нап&shy;ри&shy;мер, прог&shy;рам&shy;ма мно&shy;го па&shy;мя&shy;ти вы&shy;де&shy;ли&shy;ла, но ей не поль&shy;зу&shy;ет&shy;ся, а со&shy;сед&shy;ней прог&shy;рам&shy;ме па&shy;мять нуж&shy;на, при этом план&shy;ка ма&shy;лень&shy;кая, то Windows не&shy;ис&shy;поль&shy;зу&shy;е&shy;мую па&shy;мять от&shy;гру&shy;жа&shy;ет на жест&shy;кий диск, а этот ку&shy;сок от&shy;да&shy;ет ко&shy;му-то дру&shy;го&shy;му.</p>
<div class="paragraph-right-side">09</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">10</div>
<p >
Итак, в на&shy;шем .NET при&shy;ло&shy;же&shy;нии часть па&shy;мя&shy;ти ис&shy;поль&shy;зу&shy;ет&shy;ся, а часть - нет. Как это мож&shy;но пос&shy;мот&shy;реть? Мож&shy;но за&shy;пус&shy;тить ути&shy;ли&shy;ту, нап&shy;ри&shy;мер есть Procmon. Они по&shy;ка&shy;зы&shy;ва&shy;ют, как при&shy;ло&shy;же&shy;ние рас&shy;хо&shy;ду&shy;ет па&shy;мять. Там вид&shy;но строч&shy;ки - это как раз вы&shy;де&shy;лен&shy;ные учас&shy;тки. Пер&shy;вый стол&shy;бец - это ад&shy;рес учас&shy;тка, вто&shy;рой ука&shy;зы&shy;ва&shy;ет хип, тре&shy;тий - раз&shy;мер учас&shy;тка. И еще один стол&shy;бик - это commited. Что это зна&shy;чит? Если прог&shy;рам&shy;ма ре&shy;ши&shy;ла, что ей ну&shy;жен хип, и пы&shy;та&shy;ет&shy;ся оп&shy;ре&shy;де&shy;лить ка&shy;кой имен&shy;но ей соз&shy;да&shy;вать. Она ре&shy;зер&shy;ви&shy;ру&shy;ет па&shy;мять под хип, и часть ее ре&shy;ша&shy;ет за&shy;ком&shy;ми&shy;тить. Вир&shy;ту&shy;альное ад&shy;рес&shy;ное прост&shy;ранство раз&shy;де&shy;ле&shy;но на стра&shy;ни&shy;цы. У стра&shy;ниц есть три ста&shy;ту&shy;са. Пер&shy;вый - сво&shy;бод&shy;ная стра&shy;ни&shy;ца, на ко&shy;то&shy;рой ни&shy;че&shy;го нет. Ее мож&shy;но брать и ис&shy;поль&shy;зо&shy;вать как нуж&shy;но. Вто&shy;рой ста&shy;тус - стра&shy;ни&shy;ца за&shy;ре&shy;зер&shy;ви&shy;ро&shy;ва&shy;на. Это зна&shy;чит, что ка&shy;кая-то часть прог&shy;рам&shy;мы под се&shy;бя эту стра&shy;ни&shy;цу за&shy;ре&shy;зер&shy;ви&shy;ро&shy;ва&shy;ла, но там все еще нет па&shy;мя&shy;ти, она там от&shy;сут&shy;ствует. Но стра&shy;ни&shy;ца за&shy;ре&shy;зер&shy;ви&shy;ро&shy;ва&shy;на для бу&shy;ду&shy;щих нужд. Это де&shy;ла&shy;ет&shy;ся для то&shy;го, что&shy;бы в ал&shy;ло&shy;ци&shy;ро&shy;ва&shy;ном хи&shy;пе ник&shy;то дру&shy;гой по се&shy;ре&shy;ди&shy;не се&shy;бе ни&shy;че&shy;го не вы&shy;де&shy;лил.</p>
<div class="paragraph-right-side">10</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">11</div>
<p >
Мо&shy;жет по&shy;ка&shy;зать&shy;ся, что вы как хо&shy;зя&shy;ин сво&shy;его при&shy;ло&shy;же&shy;ния, как хо&shy;ти&shy;те, так и  вы&shy;де&shy;ля&shy;ете па&shy;мять. На са&shy;мом де&shy;ле нет. Если вы чис&shy;то в .NET - то мо&shy;жет быть да. А во&shy;об&shy;ще го&shy;во&shy;ря, .NET час&shy;то вы&shy;зы&shy;ва&shy;ет Managed code, ко&shy;то&shy;ро&shy;му в свою оче&shy;редь то&shy;же нуж&shy;на па&shy;мять. И он не бу&shy;дет вы&shy;де&shy;лять па&shy;мять в хи&shy;пах от .NET - SOH и LOH. Он о них не име&shy;ет по&shy;ня&shy;тия.</p>
<div class="paragraph-right-side">11</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">12</div>
<p >
Он вы&shy;де&shy;ля&shy;ет па&shy;мять в сво&shy;их хи&shy;пах. Если это С++, то это C++ Runtime Library. Но там есть свои ме&shy;ха&shy;низ&shy;мы пос&shy;тро&shy;е&shy;ния хи&shy;пов. По&shy;лу&shy;ча&shy;ет&shy;ся, что вы не пол&shy;ностью конт&shy;ро&shy;ли&shy;ру&shy;ете вир&shy;ту&shy;альный ад&shy;рес&shy;ный ди&shy;а&shy;па&shy;зон, ко&shy;то&shy;рый вам вы&shy;да&shy;ли. Что&shy;бы обе&shy;зо&shy;па&shy;сить се&shy;бя, вы сра&shy;зу ре&shy;зер&shy;ви&shy;ру&shy;ете ад&shy;рес&shy;ное прост&shy;ранство и внут&shy;ри не&shy;го уже на&shy;чи&shy;на&shy;ете ал&shy;ло&shy;ци&shy;ро&shy;вать па&shy;мять - ком&shy;ми&shy;тить ее, что&shy;бы она ста&shy;ла су&shy;щест&shy;во&shy;вать, что&shy;бы ту&shy;да мож&shy;но бы&shy;ло что-то пи&shy;сать.</p>
<div class="paragraph-right-side">12</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">13</div>
<p >
На слай&shy;де 11:50 вид&shy;ны сво&shy;бод&shy;ные мес&shy;та и есть неп&shy;ре&shy;рыв&shy;ный учас&shy;ток, час&shy;тич&shy;но за&shy;ре&shy;зер&shy;ви&shy;ро&shy;ван&shy;ный, час&shy;тич&shy;но - за&shy;ком&shy;ми&shy;чен&shy;ный. Это мес&shy;то мо&shy;жет быть в опе&shy;ра&shy;тив&shy;ной па&shy;мя&shy;ти, ли&shy;бо на&shy;хо&shy;дит&shy;ся на жест&shy;ком диск, по&shy;то&shy;му что им дав&shy;но не поль&shy;зо&shy;ва&shy;лись. Если вы об&shy;ра&shy;ща&shy;е&shy;тесь к кус&shy;ку, ко&shy;то&shy;рый на&shy;хо&shy;дит&shy;ся на жест&shy;ком дис&shy;ке, то он ав&shy;то&shy;ма&shy;ти&shy;чес&shy;ки подг&shy;ру&shy;жа&shy;ет&shy;ся и ста&shy;но&shy;вит&shy;ся кус&shy;ком из опе&shy;ра&shy;тив&shy;ной па&shy;мя&shy;ти. Но вам это знать уже не на&shy;до.</p>
<div class="paragraph-right-side">13</div>
</div>
<p >
Зная все это, раз&shy;бе&shy;рем как ра&shy;бо&shy;та&shy;ет <code>var x = new A();</code></p>
<div class="paragraph-container">
<div class="paragraph-left-side">14</div>
<p >
Вер&shy;нем&shy;ся к ба&shy;зо&shy;вым зна&shy;ни&shy;ям, то, что мы обыч&shy;но расс&shy;ка&shy;зы&shy;ва&shy;ем на со&shy;бе&shy;се&shy;до&shy;ва&shy;ни&shy;ях. Ког&shy;да мы об&shy;ща&shy;ем&shy;ся с прог&shy;рам&shy;мис&shy;та&shy;ми, нас спра&shy;ши&shy;ва&shy;ют, как все ра&shy;бо&shy;та&shy;ет. Мы расс&shy;ка&shy;зы&shy;ва&shy;ем, что есть три по&shy;ко&shy;ле&shy;ния. Как па&shy;мять вы&shy;де&shy;ля&shy;ет&shy;ся? Ука&shy;за&shy;тель смот&shy;рит на сво&shy;бод&shy;ный учас&shy;ток и ког&shy;да де&shy;ла&shy;ет&shy;ся опе&shy;ра&shy;ция new, то мы этот ад&shy;рес от&shy;да&shy;ем а ука&shy;за&shy;тель пе&shy;ре&shy;ме&shy;ща&shy;ем на раз&shy;мер вы&shy;де&shy;лен&shy;но&shy;го бло&shy;ка. А ког&shy;да про&shy;ис&shy;хо&shy;дит GC, ку&shy;ча сжи&shy;ма&shy;ет&shy;ся и этот ука&shy;за&shy;тель ока&shy;зы&shy;ва&shy;ет&shy;ся рань&shy;ше, по&shy;то&shy;му что ку&shy;ча сжа&shy;лась. При&shy;мер&shy;но так и про&shy;ис&shy;хо&shy;дит. На слай&shy;де 13:31 у нас есть за&shy;ком&shy;ми&shy;чен&shy;ная часть - сле&shy;ва до вер&shy;ти&shy;каль&shy;ной чер&shy;ты. Эта па&shy;мять су&shy;щес&shy;тву&shy;ет фи&shy;зи&shy;чес&shy;ки. Спра&shy;ва от чер&shy;ты - это за&shy;ре&shy;зер&shy;ви&shy;ро&shy;ван&shy;ная за хи&shy;пом часть, но ее по&shy;ка не су&shy;щес&shy;тву&shy;ет. Даль&shy;ше мы дол&shy;жны вспом&shy;нить о та&shy;ком по&shy;ня&shy;тии как allocation context. Это не&shy;кое сколь&shy;зя&shy;щее ок&shy;но, внут&shy;ри ко&shy;то&shy;ро&shy;го в дан&shy;ный мо&shy;мент ме&shy;нед&shy;жер па&shy;мя&shy;ти вы&shy;де&shy;ля&shy;ет па&shy;мять под объ&shy;ек&shy;ты. И уже внут&shy;ри не&shy;го у нас есть ука&shy;за&shy;те&shy;ли на на&shy;ча&shy;ло сво&shy;бод&shy;но&shy;го мес&shy;та. Сле&shy;ва уже пош&shy;ли объ&shy;ек&shy;ты.</p>
<div class="paragraph-right-side">14</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">15</div>
<p >
Ког&shy;да идет опе&shy;ра&shy;ция new A(), мы за&shy;по&shy;ми&shy;на&shy;ем этот ад&shy;рес, раз&shy;ме&shy;ща&shy;ем там объ&shy;ект и пе&shy;ред&shy;ви&shy;га&shy;ем ад&shy;рес на&shy;ча&shy;ла сво&shy;бод&shy;но&shy;го мес&shy;та, от&shy;да&shy;вая ад&shy;рес в пе&shy;ре&shy;мен&shy;ную x. Наш код выг&shy;ля&shy;дит при&shy;мер&shy;но сле&shy;ду&shy;ю&shy;щим об&shy;ра&shy;зом (см.слайд 14:39). У нас есть ме&shy;тод Allocate(), мы поп&shy;ро&shy;си&shy;ли у не&shy;го не&shy;кий amount па&shy;мя&shy;ти. Он про&shy;ве&shy;ря&shy;ет, есть ли у нас бу&shy;ду&shy;щий ад&shy;рес сво&shy;бод&shy;но&shy;го мес&shy;та (ад&shy;рес на&shy;ча&shy;ла мес&shy;та плюс этот amount). Если он пре&shy;вы&shy;сит heap size, у нас ни&shy;как не по&shy;лу&shy;чит&shy;ся но&shy;вую па&shy;мять вы&shy;де&shy;лить, то мы бро&shy;са&shy;ем OutOfMemoryException. Ина&shy;че мы спо&shy;кой&shy;но от&shy;да&shy;ем этот ад&shy;рес зап&shy;ра&shy;ши&shy;ва&shy;ю&shy;щей сто&shy;ро&shy;не, об&shy;нов&shy;ляя весь ди&shy;а&shy;па&shy;зон па&shy;мя&shy;ти, что&shy;бы  там не бы&shy;ло лиш&shy;них дан&shy;ных.</p>
<div class="paragraph-right-side">15</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">16</div>
<p >
Но мо&shy;жет быть так, что allocation context у нас уже кон&shy;ча&shy;ет&shy;ся. Тог&shy;да бу&shy;дет про&shy;мах ми&shy;мо это&shy;го кон&shy;тек&shy;ста. Как дейс&shy;твовать в этом слу&shy;чае? Алло&shy;ка&shy;тор мо&shy;жет дейс&shy;твовать дву&shy;мя пу&shy;тя&shy;ми. Пер&shy;вый - это вы&shy;де&shy;лить, нап&shy;ри&shy;мер, по-ми&shy;ни&shy;му&shy;му, вто&shy;рой - вы&shy;де&shy;лить сколь&shy;ко-то до не&shy;ко&shy;его мак&shy;си&shy;му&shy;ма. Этот раз&shy;мер мо&shy;жет быть от 1 до 8Кб. И вы&shy;би&shy;ра&shy;ет&shy;ся он ис&shy;хо&shy;дя из ин&shy;тен&shy;сив&shy;нос&shy;ти вы&shy;де&shy;ле&shy;ния па&shy;мя&shy;ти. Если на дан&shy;ном по&shy;то&shy;ке вы&shy;де&shy;ля&shy;ет&shy;ся мно&shy;го па&shy;мя&shy;ти, то нам нет ни&shy;ка&shy;ко&shy;го смыс&shy;ла вы&shy;де&shy;лять ма&shy;лень&shy;кий ку&shy;сок. То есть allocation context рас&shy;ши&shy;ря&shy;ет&shy;ся ис&shy;хо&shy;дя из те&shy;ку&shy;щих зап&shy;ро&shy;сов.</p>
<div class="paragraph-right-side">16</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">17</div>
<p >
Но су&shy;щес&shy;тву&shy;ет еще и мно&shy;го&shy;по&shy;точ&shy;ность. Если она при&shy;сут&shy;ствует, мо&shy;жет так по&shy;лу&shy;чит&shy;ся, что нес&shy;коль&shy;ко по&shy;то&shy;ков од&shy;нов&shy;ре&shy;мен&shy;но на&shy;чи&shy;на&shy;ют зап&shy;ра&shy;ши&shy;вать вы&shy;де&shy;ле&shy;ния па&shy;мя&shy;ти. Зна&shy;чит, опе&shy;ра&shy;тор new у нас дол&shy;жен быть по&shy;то&shy;ко-бе&shy;зо&shy;пас&shy;ным, а зна&shy;чит и мед&shy;лен&shy;ным. Сам по се&shy;бе он быст&shy;рый, но ес&shy;ли он вы&shy;де&shy;ля&shy;ет&shy;ся без кон&shy;ку&shy;рен&shy;ции с дру&shy;ги&shy;ми по&shy;то&shy;ка&shy;ми, то по&shy;лу&shy;ча&shy;ет&shy;ся, что он ра&shy;бо&shy;та&shy;ет не&shy;оп&shy;рав&shy;дан&shy;но мед&shy;лен&shy;но. Что&shy;бы сде&shy;лать new  по&shy;то&shy;ко-бе&shy;зо&shy;пас&shy;ным, на&shy;до что&shy;бы каж&shy;дый по&shy;ток вы&shy;де&shy;лял па&shy;мять в ка&shy;ком-то сво&shy;ем мес&shy;те. По&shy;э&shy;то&shy;му в .NET су&shy;щес&shy;тву&shy;ет по од&shy;но&shy;му allocation context на каж&shy;дый по&shy;ток.</p>
<div class="paragraph-right-side">17</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">18</div>
<p >
Отсю&shy;да мож&shy;но сде&shy;лать еще один вы&shy;вод - не сто&shy;ит де&shy;лать мно&shy;го лиш&shy;них по&shy;то&shy;ков. Вы де&shy;ла&shy;ете очень жир&shy;ный хип ну&shy;ле&shy;во&shy;го по&shy;ко&shy;ле&shy;ния бла&shy;го&shy;да&shy;ря это&shy;му.</p>
<div class="paragraph-right-side">18</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">19</div>
<p >
Итак, мно&shy;го по&shy;то&shy;ков у нас уже су&shy;щес&shy;тву&shy;ет и каж&shy;дый из них что-то вы&shy;де&shy;ля&shy;ет. А еще у нас есть три по&shy;ко&shy;ле&shy;ния. По&shy;лу&shy;ча&shy;ет&shy;ся, что ну&shy;ле&shy;вое по&shy;ко&shy;ле&shy;ние, в ко&shy;то&shy;ром идет вы&shy;де&shy;ле&shy;ние, на&shy;чи&shy;на&shy;ет рас&shy;ти бла&shy;го&shy;да&shy;ря то&shy;му, что у нас рас&shy;тет ко&shy;ли&shy;чес&shy;тво по&shy;то&shy;ков. Это пло&shy;хо.</p>
<div class="paragraph-right-side">19</div>
</div>
<p >
Обра&shy;тим&shy;ся к идее спис&shy;ка сво&shy;бод&shy;ных участ&shy;ков.</p>
<div class="paragraph-container">
<div class="paragraph-left-side">20</div>
<p >
Если мы го&shy;во&shy;рим про клас&shy;си&shy;ку, как вез&shy;де heap ус&shy;тро&shy;ен, то .NET - не ис&shy;клю&shy;че&shy;ние. Ког&shy;да про&shy;ис&shy;хо&shy;дит sweep collection вмес&shy;то сжа&shy;тия ку&shy;чи, у нас по&shy;яв&shy;ля&shy;ют&shy;ся сво&shy;бод&shy;ные учас&shy;тки. Ими на&shy;до как-то уп&shy;рав&shy;лять.</p>
<div class="paragraph-right-side">20</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">21</div>
<p >
Есть два ал&shy;го&shy;рит&shy;ма ме&shy;недж&shy;мен&shy;та сво&shy;бод&shy;ных участ&shy;ков. Пер&shy;вый - best-fit. Ког&shy;да вы&shy;де&shy;ля&shy;ет&shy;ся па&shy;мять, сре&shy;ди всех сво&shy;бод&shy;ных участ&shy;ков вы&shy;де&shy;ля&shy;ет&shy;ся тот, ко&shy;то&shy;рый име&shy;ет ли&shy;бо та&shy;кой же раз&shy;мер, ли&shy;бо мак&shy;си&shy;маль&shy;но приб&shy;ли&shy;жен&shy;ный по раз&shy;ме&shy;ру к то&shy;му, ко&shy;то&shy;рый про&shy;си&shy;ли. Это best-fit.</p>
<div class="paragraph-right-side">21</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">22</div>
<p >
Ког&shy;да мы ис&shy;поль&shy;зу&shy;ем best-fit, нам нуж&shy;но най&shy;ти на&shy;илуч&shy;ший учас&shy;ток. Мы про&shy;бе&shy;га&shy;ем по всем участ&shy;кам, и за&shy;по&shy;ми&shy;на&shy;ем то, что мы прош&shy;ли. Вы&shy;пол&shy;ня&shy;ет&shy;ся ли&shy;ней&shy;ный по&shy;иск и наш учас&shy;ток мо&shy;жет ока&shy;зать&shy;ся в кон&shy;це. Но за&shy;то на вы&shy;хо&shy;де мы по&shy;лу&shy;ча&shy;ем ми&shy;ни&shy;маль&shy;ную фраг&shy;мен&shy;та&shy;цию - это здо&shy;ро&shy;во. Вто&shy;рой ал&shy;го&shy;ритм - это first-fit. Это аль&shy;те&shy;рн&shy;атива. Мы идем впе&shy;ред по спис&shy;ку и бе&shy;рем пер&shy;вый же учас&shy;ток, ко&shy;то&shy;рый нам по&shy;до&shy;шел. Он мо&shy;жет быть та&shy;ким же по раз&shy;ме&shy;ру, ли&shy;бо боль&shy;ше или су&shy;щест&shy;вен&shy;но боль&shy;ше тре&shy;бу&shy;е&shy;мо&shy;го. Ра&shy;бо&shy;та&shy;ет это быс&shy;тро, но мо&shy;жет силь&shy;но фраг&shy;мен&shy;ти&shy;ро&shy;вать па&shy;мять. В .NET ис&shy;поль&shy;зу&shy;ет&shy;ся смесь этих под&shy;хо&shy;дов, ор&shy;га&shy;ни&shy;зу&shy;ет&shy;ся спи&shy;сок сво&shy;бод&shy;ных участ&shy;ков че&shy;рез кор&shy;зи&shy;ны - ба&shy;ке&shy;ты. У каж&shy;до&shy;го по&shy;ко&shy;ле&shy;ния есть спи&shy;сок ба&shy;ке&shy;тов. Они груп&shy;пи&shy;ру&shy;ют па&shy;мять по раз&shy;ме&shy;ру от ма&shy;ло&shy;го к боль&shy;шо&shy;му. Ба&shy;кет ссы&shy;ла&shy;ет&shy;ся на од&shy;нос&shy;вя&shy;за&shy;ный спи&shy;сок сво&shy;бод&shy;ных участ&shy;ков. Если пос&shy;мот&shy;реть вниз, то от Head на сво&shy;бод&shy;ный учас&shy;ток вста&shy;ли и даль&shy;ше по од&shy;нос&shy;вяз&shy;но&shy;му спис&shy;ку мо&shy;жем ид&shy;ти даль&shy;ше, пе&shy;ре&shy;чис&shy;ляя все сво&shy;бод&shy;ные учас&shy;тки, ко&shy;то&shy;рые от&shy;но&shy;сят&shy;ся к это&shy;му ба&shy;ке&shy;ту. На&shy;пом&shy;ню, они ор&shy;га&shy;ни&shy;зо&shy;ва&shy;ны по раз&shy;ме&shy;ру. И в дан&shy;ном ба&shy;ке&shy;те на&shy;хо&shy;дят&shy;ся учас&shy;тки с оп&shy;ре&shy;де&shy;лен&shy;ным ди&shy;а&shy;па&shy;зо&shy;ном раз&shy;ме&shy;ров. В сле&shy;ду&shy;ю&shy;щем ба&shy;ке&shy;те бу&shy;дут свои ди&shy;а&shy;па&shy;зо&shy;ны.</p>
<div class="paragraph-right-side">22</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">23</div>
<p >
Ба&shy;кет - это first-fit, сре&shy;ди ба&shy;ке&shy;тов вы&shy;би&shy;ра&shy;ем пер&shy;вый, ко&shy;то&shy;рый под&shy;хо&shy;дит, ухо&shy;дим внутрь этой кор&shy;зи&shy;ны и там, по од&shy;ноз&shy;вяз&shy;но&shy;му спис&shy;ку мы идем по best-fit. Та&shy;ким об&shy;ра&shy;зом мы де&shy;ла&shy;ем очень хо&shy;ро&shy;шую оп&shy;ти&shy;ми&shy;за&shy;цию.</p>
<div class="paragraph-right-side">23</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">24</div>
<p >
Что та&shy;кое ба&shy;ке&shy;ты? Эта таб&shy;лич&shy;ка (см. слайд 22:05) нам раск&shy;ры&shy;ва&shy;ет гла&shy;за. Тут вспом&shy;ним раз&shy;ни&shy;цу меж&shy;ду SOH и LOH: LOH ор&shy;га&shy;ни&shy;зо&shy;ван толь&shy;ко по прин&shy;ци&shy;пу sweep collection, сжа&shy;тие ку&shy;чи там про&shy;ис&shy;хо&shy;дит толь&shy;ко по зап&shy;ро&shy;су. Са&shy;мо по се&shy;бе сжа&shy;тие ку&shy;чи там не за&shy;пус&shy;тит&shy;ся ни&shy;ког&shy;да. В SOH идет смесь.</p>
<div class="paragraph-right-side">24</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">25</div>
<p >
Пос&shy;мот&shy;рим на LOH и вто&shy;рое по&shy;ко&shy;ле&shy;ние, ко&shy;то&shy;рое яв&shy;ля&shy;ет&shy;ся са&shy;мым боль&shy;шим. Исхо&shy;дя из это&shy;го мож&shy;но лег&shy;ко по&shy;нять со&shy;дер&shy;жи&shy;мое таб&shy;ли&shy;цы. Ну&shy;ле&shy;вое и пер&shy;вое по&shy;ко&shy;ле&shy;ние име&shy;ют ко&shy;ли&shy;чес&shy;тво ба&shy;ке&shy;тов -  1. По&shy;то&shy;му что в ну&shy;ле&shy;вом и пер&shy;вом по&shy;ко&shy;ле&shy;нии у нас нет та&shy;ко&shy;го, что при sweep об&shy;ра&shy;зу&shy;ет&shy;ся ку&shy;ча сво&shy;бод&shy;ных боль&shy;ших участ&shy;ков, ку&shy;да мож&shy;но раз&shy;мес&shy;тить но&shy;вые кон&shy;тек&shy;сты. Нам этот фун&shy;кци&shy;о&shy;нал ба&shy;ке&shy;тов там не ну&shy;жен, по&shy;э&shy;то&shy;му ба&shy;кет там один.</p>
<div class="paragraph-right-side">25</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">26</div>
<p >
А во вто&shy;ром по&shy;ко&shy;ле&shy;нии, ко&shy;то&shy;рое мо&shy;жет за&shy;ни&shy;мать ги&shy;га&shy;бай&shy;ты мел&shy;ких объ&shy;ек&shy;тов и в LOH,  ба&shy;ке&shy;ты уже при&shy;сут&shy;ствуют, бла&shy;го&shy;да&shy;ря че&shy;му па&shy;мять там ор&shy;га&shy;ни&shy;зо&shy;ва&shy;на по расс&shy;ка&shy;зан&shy;ной ра&shy;нее струк&shy;ту&shy;ре.</p>
<div class="paragraph-right-side">26</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">27</div>
<p >
Как про&shy;ис&shy;хо&shy;дит вы&shy;де&shy;ле&shy;ние па&shy;мя&shy;ти в этом слу&shy;чае? Сна&shy;ча&shy;ла мы ска&shy;ни&shy;ру&shy;ем ба&shy;ке&shy;ты, в по&shy;ис&shy;ках пер&shy;во&shy;го, ко&shy;то&shy;рый под&shy;хо&shy;дит по раз&shy;ме&shy;ру участ&shy;ков, на&shy;хо&shy;дя&shy;щих&shy;ся внут&shy;ри не&shy;го. Ког&shy;да мы выб&shy;ра&shy;ли ба&shy;кет, идем по од&shy;нос&shy;вяз&shy;но&shy;му спис&shy;ку и в нем ищем луч&shy;ший из тех, ко&shy;то&shy;рые там при&shy;сут&shy;ствуют - тот, ко&shy;то&shy;рый луч&shy;ше всех по&shy;дой&shy;дет нам по раз&shy;ме&shy;ру. Но есть од&shy;на осо&shy;бен&shy;ность. Мо&shy;жет так по&shy;лу&shy;чит&shy;ся, что мы про&shy;си&shy;ли не так мно&shy;го мес&shy;та, а име&shy;ю&shy;щи&shy;еся учас&shy;тки слиш&shy;ком боль&shy;шие. В этом слу&shy;чае мы вы&shy;де&shy;лим сколь&shy;ко не&shy;об&shy;хо&shy;ди&shy;мо, а ос&shy;та&shy;ток вер&shy;нем в спи&shy;сок сво&shy;бод&shy;ных участ&shy;ков.</p>
<div class="paragraph-right-side">27</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">28</div>
<p >
Итак, мы наш&shy;ли нуж&shy;ный учас&shy;ток. В этом мес&shy;те ле&shy;жит эму&shy;ля&shy;ция объ&shy;ек&shy;та. Пер&shy;вое по&shy;ле - это по&shy;ле undo. Это - ос&shy;во&shy;бо&shy;див&shy;ший&shy;ся учас&shy;ток, там ле&shy;жал объ&shy;ект или груп&shy;па объ&shy;ек&shy;тов. Со&shy;от&shy;ветст&shy;венно, пер&shy;вое по&shy;ле это aSyncBlockIndex, по&shy;том - таб&shy;ли&shy;ца вир&shy;ту&shy;альных ме&shy;то&shy;дов, по&shy;том дан&shy;ные. Ког&shy;да этот учас&shy;ток стал участ&shy;ком сво&shy;бод&shy;ной па&shy;мя&shy;ти, то пер&shy;вое по&shy;ле ста&shy;ло опе&shy;ра&shy;ци&shy;ей undo. Ког&shy;да мы этот учас&shy;ток от&shy;лин&shy;ку&shy;ем и сох&shy;ра&shy;ним ссыл&shy;ку на сле&shy;ду&shy;ю&shy;щий учас&shy;ток в опе&shy;ра&shy;ции undo, что&shy;бы мож&shy;но бы&shy;ло от&shy;ме&shy;нить, ес&shy;ли что-то пой&shy;дет не так.</p>
<div class="paragraph-right-side">28</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">29</div>
<p >
Даль&shy;ше таб&shy;ли&shy;ца вир&shy;ту&shy;альных ме&shy;то&shy;дов сво&shy;бод&shy;но&shy;го учас&shy;тка, что&shy;бы GC по&shy;ни&shy;мал, с чем он име&shy;ет де&shy;ло и size - раз&shy;мер сво&shy;бод&shy;но&shy;го учас&shy;тка.</p>
<div class="paragraph-right-side">29</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">30</div>
<p >
Пос&shy;ле это&shy;го вы&shy;де&shy;ле&shy;ния мы прос&shy;тав&shy;ля&shy;ем aSyncBlockIndex. Таб&shy;ли&shy;ца вир&shy;ту&shy;альных ме&shy;то&shy;дов ста&shy;но&shy;вит&shy;ся та, что на&shy;до и вы&shy;зы&shy;ва&shy;ет&shy;ся конст&shy;руктор. Все. Вот так ра&shy;бо&shy;та&shy;ет вы&shy;де&shy;ле&shy;ние па&shy;мя&shy;ти. \</p>
<div class="paragraph-right-side">30</div>
</div>
<h2 id="soh">Выделение памяти в SOH</h2>
<div class="paragraph-container">
<div class="paragraph-left-side">31</div>
<p >
По&shy;лу&shy;ча&shy;ет&shy;ся, что для то&shy;го, что&shy;бы вы&shy;де&shy;лить па&shy;мять сна&shy;ча&shy;ла от&shy;ра&shy;ба&shy;ты&shy;ва&shy;ет са&shy;мый прос&shy;той спо&shy;соб. Если объ&shy;ект вле&shy;за&shy;ет в allocation context, мы вы&shy;де&shy;ля&shy;ем и от&shy;да&shy;ем. Это са&shy;мый быст&shy;рый спо&shy;соб. Мы вы&shy;хо&shy;дим мо&shy;мен&shy;таль&shy;но, у нас нет ни&shy;ка&shy;ких до&shy;пол&shy;ни&shy;тель&shy;ных действий: вош&shy;ли и выш&shy;ли, и пе&shy;ред&shy;ви&shy;нуть ука&shy;за&shy;тель нам ни&shy;че&shy;го не сто&shy;ит.</p>
<div class="paragraph-right-side">31</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">32</div>
<p >
Если не вле&shy;за&shy;ем в кон&shy;текст, то идет пер&shy;вое ус&shy;лож&shy;не&shy;ние. Кон&shy;текст не&shy;об&shy;хо&shy;ди&shy;мо уве&shy;ли&shy;чить. Что&shy;бы уве&shy;ли&shy;чить, мы ис&shy;поль&shy;зу&shy;ем бо&shy;лее прод&shy;ви&shy;ну&shy;тый спо&shy;соб, он на&shy;хо&shy;дит&shy;ся в JIT_NEW helper.</p>
<div class="paragraph-right-side">32</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">33</div>
<p >
Мы пы&shy;та&shy;ем&shy;ся най&shy;ти не&shy;ис&shy;поль&shy;зу&shy;е&shy;мую часть в эфе&shy;мер&shy;ном сег&shy;мен&shy;те. Ког&shy;да у нас allocation context за&shy;кан&shy;чи&shy;ва&shy;ет&shy;ся, мы дол&shy;жны его ку&shy;да-то пе&shy;ре&shy;та&shy;щить. Это до&shy;ро&shy;го. По&shy;э&shy;то&shy;му мы сна&shy;ча&shy;ла пы&shy;та&shy;ем&shy;ся его уве&shy;ли&shy;чить, на&shy;рас&shy;тить. Если это не по&shy;лу&shy;чи&shy;лось, то на&shy;до пе&shy;ре&shy;та&shy;щить.</p>
<div class="paragraph-right-side">33</div>
</div>
<p >
Ку&shy;да мы дол&shy;жны его пе&shy;ре&shy;мес&shy;тить и ка&shy;кие дан&shy;ные у нас для это&shy;го есть?</p>
<div class="paragraph-container">
<div class="paragraph-left-side">34</div>
<p >
Нуж&shy;но по&shy;ис&shy;кать сво&shy;бод&shy;ный учас&shy;ток в спис&shy;ке че&shy;рез ба&shy;ке&shy;ты, ку&shy;да вле&shy;зет наш кон&shy;текст. Если учас&shy;ток есть, мы его пе&shy;ред&shy;ви&shy;га&shy;ем ту&shy;да и пы&shy;та&shy;ем&shy;ся пер&shy;вым спо&shy;со&shy;бом вы&shy;де&shy;лить там па&shy;мять.</p>
<div class="paragraph-right-side">34</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">35</div>
<p >
Если по&shy;лу&shy;чи&shy;лось - за&shy;ме&shy;ча&shy;тель&shy;но. Если не влез, мы пы&shy;та&shy;ем&shy;ся под&shy;ком&shy;ми&shy;тить боль&shy;ше за&shy;ре&shy;зер&shy;ви&shy;ро&shy;ван&shy;ной па&shy;мя&shy;ти: сдви&shy;нуть вер&shy;ти&shy;каль&shy;ную чер&shy;ту впра&shy;во. Мес&shy;то за&shy;ре&shy;зер&shy;ви&shy;ро&shy;ва&shy;но, но па&shy;мя&shy;ти там еще не су&shy;щес&shy;тву&shy;ет. Нам нуж&shy;но рас&shy;ши&shy;рить ку&shy;чу и мы ком&shy;ми&shy;тим па&shy;мять. Сра&shy;зу же мы не де&shy;ла&shy;ем это&shy;го, по&shy;то&shy;му что commitment - опе&shy;ра&shy;ция дос&shy;та&shy;точ&shy;но дол&shy;гая, как и ре&shy;зер&shy;ви&shy;ро&shy;ва&shy;ние. Она мо&shy;жет за&shy;ни&shy;мать сот&shy;ню мил&shy;ли&shy;се&shy;кунд. Это про&shy;ис&shy;хо&shy;дит по&shy;то&shy;му, что для ее осу&shy;щест&shy;вления, не&shy;об&shy;хо&shy;ди&shy;мо об&shy;ра&shy;тить&shy;ся к Windows. А опе&shy;ра&shy;ци&shy;он&shy;ная сис&shy;те&shy;ма мак&shy;си&shy;маль&shy;но не до&shy;ве&shy;ря&shy;ет то&shy;му, что в ней на&shy;хо&shy;дит&shy;ся. Он от&shy;го&shy;ра&shy;жи&shy;ва&shy;ет для нас пе&shy;соч&shy;ни&shy;цу, и ког&shy;да мы вы&shy;зы&shy;ва&shy;ем winapi ме&shy;тод, то мы не прос&shy;то его вы&shy;зы&shy;ва&shy;ем, а с по&shy;вы&shy;ше&shy;ни&shy;ем уров&shy;ня при&shy;ви&shy;ле&shy;гий. Что&shy;бы это бе&shy;зо&shy;пас&shy;но это сде&shy;лать, не&shy;об&shy;хо&shy;ди&shy;мо, что&shy;бы Windows ско&shy;пи&shy;ро&shy;вал фрейм ме&shy;то&shy;да, ко&shy;то&shy;рый вы&shy;зы&shy;ва&shy;ет&shy;ся из уров&shy;ня при&shy;ло&shy;же&shy;ния в уро&shy;вень яд&shy;ра, что&shy;бы слу&shy;чай&shy;но не подх&shy;ва&shy;тить чу&shy;жие ин&shy;фи&shy;ци&shy;ро&shy;ван&shy;ные дан&shy;ные. По&shy;том winapi фун&shy;к&shy;ция от&shy;ра&shy;ба&shy;ты&shy;ва&shy;ет и про&shy;ис&shy;хо&shy;дит возв&shy;рат. В этот мо&shy;мент идет об&shy;рат&shy;ное ко&shy;пи&shy;ро&shy;ва&shy;ние ку&shy;соч&shy;ка сте&shy;ка и идет пе&shy;ре&shy;ход из kernel час&shy;ти в user space. Вся эта опе&shy;ра&shy;ция за&shy;ни&shy;ма&shy;ет мно&shy;го вре&shy;ме&shy;ни, по&shy;э&shy;то&shy;му GC мак&shy;си&shy;маль&shy;но ста&shy;ра&shy;ет&shy;ся ис&shy;поль&shy;зо&shy;вать те&shy;ку&shy;щее прост&shy;ранство. И на каж&shy;дом эта&shy;пе он де&shy;ла&shy;ет GC ну&shy;ле&shy;во&shy;го по&shy;ко&shy;ле&shy;ния: ес&shy;ли что-то подс&shy;жи&shy;мать, воз&shy;мож&shy;но, allocation context об&shy;рат&shy;но вы&shy;рас&shy;тет. Ког&shy;да кон&shy;текст кон&shy;чил&shy;ся, GC пы&shy;та&shy;ет&shy;ся его разд&shy;ви&shy;нуть впра&shy;во, а там уже что-то есть, зна&shy;чит на&shy;до по&shy;ис&shy;кать сво&shy;бод&shy;ные учас&shy;тки. Если не по&shy;лу&shy;чи&shy;лось, де&shy;ла&shy;ет&shy;ся сбор&shy;ка му&shy;со&shy;ра, мо&shy;жет быть сво&shy;бод&shy;ные учас&shy;тки все же по&shy;явят&shy;ся и по&shy;лу&shy;чит&shy;ся раз&shy;мес&shy;тить сре&shy;ди них но&shy;вые дан&shy;ные. Ког&shy;да ни&shy;че&shy;го не по&shy;лу&shy;чи&shy;лось и все за&shy;би&shy;то, то при&shy;хо&shy;дит&shy;ся ком&shy;ми&shy;тить даль&shy;ше па&shy;мять. А ес&shy;ли па&shy;мять кон&shy;чи&shy;лась, то вы&shy;ле&shy;та&shy;ет OutOfMemoryException.</p>
<div class="paragraph-right-side">35</div>
</div>
<h2 id="loh">Выделение памяти в LOH</h2>
<div class="paragraph-container">
<div class="paragraph-left-side">36</div>
<p >
В хи&shy;пе боль&shy;ших объ&shy;ек&shy;тов мы пы&shy;та&shy;ем&shy;ся най&shy;ти не&shy;ис&shy;поль&shy;зу&shy;е&shy;мую па&shy;мять, пов&shy;то&shy;ряя для каж&shy;до&shy;го эфе&shy;мер&shy;но&shy;го сег&shy;мен&shy;та LOH, по&shy;то&shy;му что тут их мо&shy;жет быть нес&shy;коль&shy;ко, в за&shy;ви&shy;си&shy;мос&shy;ти от то&shy;го, в ка&shy;ком ре&shy;жи&shy;ме ра&shy;бо&shy;та&shy;ет пла&shy;то&shy;фор&shy;ма .NET. Пос&shy;коль&shy;ку в LOH по умол&shy;ча&shy;нию у нас нет сжа&shy;тия ку&shy;чи, то уп&shy;рав&shy;ле&shy;ние па&shy;мятью тут уп&shy;ро&shy;ще&shy;но. Сжа&shy;тие ку&shy;чи - это очень жир&shy;ная опе&shy;ра&shy;ция, ко&shy;то&shy;рая тре&shy;бу&shy;ет боль&shy;ших вы&shy;чис&shy;ли&shy;тель&shy;ных про&shy;цес&shy;сов. Но в LOH эта опе&shy;ра&shy;ция про&shy;во&shy;дит&shy;ся толь&shy;ко по зап&shy;ро&shy;су, а зна&shy;чит прог&shy;рам&shy;мист ис&shy;хо&shy;дя из зна&shy;ний о ра&shy;бо&shy;те ал&shy;го&shy;рит&shy;мов собст&shy;венной прог&shy;рам&shy;мы, ре&shy;шил, что в дан&shy;ное вре&shy;мя он го&shy;тов пот&shy;ра&shy;тить не&shy;из&shy;вес&shy;тно сколь&shy;ко вре&shy;ме&shy;ни на сжа&shy;тие ог&shy;ром&shy;но&shy;го прост&shy;ранства. А зна&shy;чит, мож&shy;но силь&shy;но уп&shy;рос&shy;тить ал&shy;го&shy;рит&shy;мы по ра&shy;бо&shy;те с LOH.</p>
<div class="paragraph-right-side">36</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">37</div>
<p >
Для каж&shy;до&shy;го эфе&shy;мер&shy;но&shy;го сег&shy;мен&shy;та мы ищем учас&shy;ток па&shy;мя&shy;ти в спис&shy;ке сво&shy;бод&shy;ных, пы&shy;та&shy;ем&shy;ся уве&shy;ли&shy;чить, ес&shy;ли не по&shy;лу&shy;чи&shy;лось най&shy;ти. Если не по&shy;лу&shy;чи&shy;лось уве&shy;ли&shy;чить - пы&shy;та&shy;ем&shy;ся под&shy;ком&shy;ми&shy;тить за&shy;ре&shy;зер&shy;ви&shy;ро&shy;ван&shy;ную часть. Сле&shy;ду&shy;ю&shy;щим ша&shy;гом за&shy;пус&shy;ка&shy;ем GC, воз&shy;мож&shy;но нес&shy;коль&shy;ко раз. И ес&shy;ли сов&shy;сем ни&shy;че&shy;го не вы&shy;хо&shy;дит - дер&shy;га&shy;ем OutOfMemoryException. В дан&shy;ном под&shy;хо&shy;де нет сло&shy;ва &laquo;сжа&shy;тие&raquo;, мы идем по прос&shy;то&shy;му пу&shy;ти.</p>
<div class="paragraph-right-side">37</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">38</div>
<p >
Мно&shy;го&shy;по&shy;точ&shy;ность. Есть та&shy;кое по&shy;ня&shy;тие как ба&shy;ланс хи&shy;пов. Нап&shy;ри&shy;мер, GC за&shy;пу&shy;щен в сер&shy;вер&shy;ном ре&shy;жи&shy;ме. Это зна&shy;чит, что у не&shy;го по нес&shy;коль&shy;ко SOH и LOH и эти па&shy;ры наз&shy;на&shy;че&shy;ны к конк&shy;рет&shy;но&shy;му про&shy;цес&shy;сор&shy;но&shy;му яд&shy;ру. У каж&shy;до&shy;го яд&shy;ра есть своя па&shy;ра хи&shy;пов и свои тре&shy;ды.</p>
<div class="paragraph-right-side">38</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">39</div>
<p >
Предс&shy;та&shy;вим, что на ка&shy;ком-то яд&shy;ре ба&shy;ланс на&shy;ру&shy;шил&shy;ся. Оно на&shy;ча&shy;ло ал&shy;ло&shy;ци&shy;ро&shy;вать слиш&shy;ком мно&shy;го па&shy;мя&shy;ти и пе&shy;рес&shy;та&shy;ло по&shy;ме&shy;щать&shy;ся в те&shy;ку&shy;щие сег&shy;мен&shy;ты. Расс&shy;мот&shy;рим, что мо&shy;жет сде&shy;лать сис&shy;те&shy;ма уп&shy;рав&shy;ле&shy;ния па&shy;мятью в дан&shy;ном слу&shy;чае.</p>
<div class="paragraph-right-side">39</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">40</div>
<p >
Ей мо&shy;жет по&shy;ка&shy;зать&shy;ся, что ес&shy;ли дан&shy;ное яд&shy;ро за&shy;ни&shy;ма&shy;ет&shy;ся очень плот&shy;ной ал&shy;ло&shy;ка&shy;ци&shy;ей, то мож&shy;но взять и пе&shy;ре&shy;ки&shy;нуть кон&shy;текст на со&shy;сед&shy;нее яд&shy;ро и ал&shy;ло&shy;ци&shy;ро&shy;вать там. Одно яд&shy;ро сто&shy;ит, а дру&shy;гое вы&shy;жа&shy;то по мак&shy;си&shy;му&shy;му. Это по&shy;мо&shy;жет из&shy;бе&shy;жать та&shy;ких до&shy;ро&shy;гих опе&shy;ра&shy;ций, как ком&shy;мит&shy;мент па&shy;мя&shy;ти. Но при из&shy;ме&shy;не&shy;нии кон&shy;тек&shy;ста, вмес&shy;те с этим участ&shy;ком, в дру&shy;гое яд&shy;ро пе&shy;ре&shy;но&shy;сит&shy;ся и по&shy;ток.</p>
<div class="paragraph-right-side">40</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">41</div>
<p >
Это де&shy;ла&shy;ет&shy;ся не толь&shy;ко по&shy;то&shy;му, что за&shy;кон&shy;чи&shy;лась па&shy;мять. Есть и дру&shy;гая при&shy;чи&shy;на. У каж&shy;до&shy;го про&shy;цес&shy;со&shy;ра есть кеш яд&shy;ра. Ког&shy;да при&shy;ло&shy;же&shy;ние от&shy;ра&shy;ба&shy;ты&shy;ва&shy;ет на ка&shy;ком-то учас&shy;тке па&shy;мя&shy;ти, весь он на&shy;хо&shy;дит&shy;ся в этом ке&shy;ше. Ког&shy;да вы на&shy;чи&shy;на&shy;ете ра&shy;бо&shy;тать с дру&shy;гим участ&shy;ком и про&shy;ма&shy;хи&shy;ва&shy;е&shy;тесь ми&shy;мо ке&shy;ша, при&shy;хо&shy;дит&shy;ся вы&shy;ка&shy;чи&shy;вать дру&shy;гой учас&shy;ток па&shy;мя&shy;ти под кеш. Если пе&shy;рек&shy;лю&shy;чать&shy;ся ту&shy;да-сю&shy;да, бу&shy;дет са&shy;мая худ&shy;шая си&shy;ту&shy;а&shy;ция. Все бу&shy;дет ра&shy;бо&shy;тать очень-очень дол&shy;го.</p>
<div class="paragraph-right-side">41</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">42</div>
<p >
Ког&shy;да те&shy;ку&shy;щий allocation context яд&shy;ра за&shy;кан&shy;чи&shy;ва&shy;ет&shy;ся, а на со&shy;сед&shy;нем яд&shy;ре ни&shy;че&shy;го в это вре&shy;мя не про&shy;ис&shy;хо&shy;дит и про&shy;ще ту&shy;да пе&shy;ре&shy;ки&shy;нуть кон&shy;текст, чем ал&shy;ло&shy;ци&shy;ро&shy;вать но&shy;вый ку&shy;сок па&shy;мя&shy;ти, то он вмес&shy;те с этим кон&shy;текс&shy;том вы&shy;нуж&shy;ден ту&shy;да пе&shy;ре&shy;ки&shy;нуть те&shy;ку&shy;щий по&shy;ток. Те&shy;перь он бу&shy;дет ра&shy;бо&shy;тать на дру&shy;гом ди&shy;а&shy;па&shy;зо&shy;не па&shy;мя&shy;ти. Ему нуж&shy;но, что&shy;бы дру&shy;гой ди&shy;а&shy;па&shy;зон па&shy;мя&shy;ти на&shy;хо&shy;дил&shy;ся в его ке&shy;ше. По&shy;э&shy;то&shy;му вмес&shy;те с кон&shy;текс&shy;том пе&shy;ре&shy;ме&shy;ща&shy;ет&shy;ся и те&shy;ку&shy;щий по&shy;ток.</p>
<div class="paragraph-right-side">42</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">43</div>
<p >
Ка&shy;кие вы&shy;во&shy;ды мож&shy;но тут сде&shy;лать. Во-пер&shy;вых, на&shy;до пом&shy;нить как вы&shy;де&shy;ля&shy;ет&shy;ся па&shy;мять.  Во-вто&shy;рых, что&shy;бы оп&shy;ти&shy;ми&shy;зи&shy;ро&shy;вать ра&shy;бо&shy;ту GC, на&shy;до по&shy;ни&shy;мать, что вам по&shy;на&shy;до&shy;бить&shy;ся сколь&shy;ко-то объ&shy;ек&shy;тов оп&shy;ре&shy;де&shy;лен&shy;но&shy;го ти&shy;па. И пос&shy;ле вы&shy;зо&shy;ва new, за&shy;пол&shy;ни&shy;ли па&shy;мять, ал&shy;го&shy;ритм у вас от&shy;ра&shy;бо&shy;тал. А по&shy;том у вас соз&shy;да&shy;ет&shy;ся еще один объ&shy;ект та&shy;ко&shy;го ти&shy;па, нап&shy;ри&shy;мер уже в цик&shy;ле. И это пло&shy;хо. Алго&shy;ритм от&shy;ра&shy;ба&shy;ты&shy;ва&shy;ет не&shy;ко&shy;то&shy;рое вре&shy;мя, в па&shy;рал&shy;лель&shy;ных по&shy;то&shy;ках в это вре&shy;мя мо&shy;жет быть про&shy;из&shy;ве&shy;де&shy;на и дру&shy;гая ал&shy;ло&shy;ка&shy;ция. И в том же ал&shy;го&shy;рит&shy;ме вы мо&shy;же&shy;те вы&shy;де&shy;лять дру&shy;гую па&shy;мять. Со&shy;от&shy;ветст&shy;венно, вы фраг&shy;мен&shy;ти&shy;ру&shy;ете па&shy;мять по ти&shy;пу. Во вре&shy;мя GC вам нуж&shy;ны объ&shy;ек&shy;ты пер&shy;во&shy;го ти&shy;па как объ&shy;ек&shy;ты ну&shy;ле&shy;во&shy;го по&shy;ко&shy;ле&shy;ния, ко&shy;то&shy;рые быс&shy;тро ис&shy;чез&shy;нут. Но в ал&shy;го&shy;рит&shy;ме вы ал&shy;ло&shy;ци&shy;ру&shy;ете веч&shy;ные объ&shy;ек&shy;ты. GC вы&shy;нуж&shy;ден про&shy;во&shy;дить фа&shy;зу сжа&shy;тия ку&shy;чи, т.к. эти са&shy;мые объ&shy;ек&shy;ты, ко&shy;то&shy;рые быс&shy;тро уш&shy;ли на по&shy;кой, об&shy;ра&shy;зо&shy;ва&shy;ли ма&shy;лень&shy;кие учас&shy;тки сво&shy;бод&shy;ной па&shy;мя&shy;ти, ку&shy;да боль&shy;ше ни&shy;че&shy;го не раз&shy;мес&shy;тить. В про&shy;тив&shy;ном слу&shy;чае GC мог бы обой&shy;тись обыч&shy;ным sweep: ес&shy;ли бы учас&shy;ток был боль&shy;шой, он бы по&shy;пал в спи&shy;сок сво&shy;бод&shy;ных участ&shy;ков.</p>
<div class="paragraph-right-side">43</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">44</div>
<p >
Как луч&shy;ше сде&shy;лать. Если есть ал&shy;го&shy;ритм на де&shy;сять ты&shy;сяч ите&shy;ра&shy;ций, и там нуж&shy;ны объ&shy;ек&shy;ты ти&shy;па A, луч&shy;ше вы&shy;де&shy;лить их сра&shy;зу груп&shy;пой, а по&shy;том ис&shy;поль&shy;зо&shy;вать. И ког&shy;да GC от&shy;ра&shy;бо&shy;та&shy;ет, у не&shy;го по&shy;лу&shy;чит&shy;ся ог&shy;ром&shy;ный учас&shy;ток, где эти объ&shy;ек&shy;ты бы&shy;ли вы&shy;де&shy;ле&shy;ны. И он весь его от&shy;даст в спи&shy;сок сво&shy;бод&shy;ных участ&shy;ков. Если же в ва&shy;шем ал&shy;го&shy;рит&shy;ме вам каж&shy;дый раз ну&shy;жен все&shy;го лишь один эк&shy;земп&shy;ляр объ&shy;ек&shy;та ти&shy;па A, то пе&shy;ре&shy;ис&shy;поль&shy;зуй&shy;те его, сде&shy;лай&shy;те ме&shy;тод init вмес&shy;то конст&shy;ру&shy;ктора. По&shy;лу&shy;чит&shy;ся, что вы во&shy;об&shy;ще не фраг&shy;мен&shy;ти&shy;ру&shy;ете па&shy;мять, а ра&shy;бо&shy;та&shy;ете на од&shy;ном объ&shy;ек&shy;те.</p>
<div class="paragraph-right-side">44</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">45</div>
<p >
Если вам нуж&shy;но од&shy;нов&shy;ре&shy;мен&shy;но сто объ&shy;ек&shy;тов де&shy;лай&shy;те пул объ&shy;ек&shy;тов, и дос&shy;та&shy;вай&shy;те их от&shy;ту&shy;да, что&shy;бы не фраг&shy;мен&shy;ти&shy;ро&shy;вать па&shy;мять ко&shy;рот&shy;ко&shy;жи&shy;ву&shy;щи&shy;ми объ&shy;ек&shy;та&shy;ми внут&shy;ри ал&shy;го&shy;рит&shy;ма, что&shy;бы не де&shy;лать дли&shy;тель&shy;ное сжа&shy;тие ку&shy;чи.</p>
<div class="paragraph-right-side">45</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">46</div>
<p >
Пер&shy;вая кни&shy;га выш&shy;ла не&shy;дав&shy;но. Ее на&shy;пи&shy;сал Кон&shy;рад Ко&shy;ко&shy;са. Кни&shy;га о ме&shy;недж&shy;мен&shy;те па&shy;мя&shy;ти объ&shy;е&shy;мом в ты&shy;ся&shy;чу стра&shy;ниц. Ког&shy;да я ее в пер&shy;вый раз по&shy;лу&shy;чил, я ожи&shy;дал уви&shy;деть неч&shy;то дру&shy;гое. От раз&shy;ме&shy;ра то&shy;ма у ме&shy;ня был шок. На са&shy;мом де&shy;ле ав&shy;тор мо&shy;ло&shy;дец. Он на&shy;пи&shy;сал ее для лю&shy;бо&shy;го уров&shy;ня под&shy;го&shy;тов&shy;ки. Это зна&shy;чит, мож&shy;но вы&shy;ре&shy;зать во&shy;об&shy;ще все, что лиш&shy;нее. Нап&shy;ри&shy;мер, уро&shy;вень уп&shy;рав&shy;ле&shy;ния па&shy;мятью про&shy;цес&shy;со&shy;ром, Windows, спи&shy;сок инст&shy;рум&shy;ентов, ко&shy;то&shy;ры&shy;ми удоб&shy;но поль&shy;зо&shy;вать&shy;ся для ди&shy;аг&shy;нос&shy;ти&shy;ки - ес&shy;ли вы хо&shy;ти&shy;те по&shy;чи&shy;тать прос&shy;то про ме&shy;недж&shy;мент па&shy;мя&shy;ти, то мож&shy;но взять вто&shy;рую по&shy;ло&shy;ви&shy;ну кни&shy;ги. Пер&shy;вая по&shy;ло&shy;ви&shy;на кни&shy;ги - это прос&shy;то под&shy;го&shy;тов&shy;ка ко вто&shy;рой. А вто&shy;рая по&shy;ло&shy;ви&shy;на - как раз ме&shy;недж&shy;мент па&shy;мя&shy;ти. Взять этот ме&shy;недж&shy;мент па&shy;мя&shy;ти. Там очень лег&shy;ким язы&shy;ком все на&shy;пи&shy;са&shy;но, пос&shy;то&shy;ян&shy;но де&shy;ла&shy;ют&shy;ся от&shy;сыл&shy;ки к пре&shy;ды&shy;ду&shy;щим гла&shy;вам.</p>
<div class="paragraph-right-side">46</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">47</div>
<p >
Если кни&shy;гу ужать, по&shy;лу&shy;чит&shy;ся стра&shy;ниц 300. А это уже подъ&shy;ем&shy;ный объ&shy;ем, то, что воз&shy;мож&shy;но про&shy;чи&shy;тать.</p>
<div class="paragraph-right-side">47</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">48</div>
<p >
Вто&shy;рая кни&shy;га - Under the Hood of .NET Memory Management  - для ме&shy;ня уже клас&shy;си&shy;ка. Она не пе&shy;ре&shy;ве&shy;де&shy;на на русс&shy;кий и расп&shy;рост&shy;ра&shy;ня&shy;ет&shy;ся толь&shy;ко че&shy;рез сайт Red Gate, ко&shy;то&shy;рый де&shy;ла&shy;ет раз&shy;ные инст&shy;рум&shy;енты для ре&shy;фак&shy;то&shy;рин&shy;га и ра&shy;бо&shy;ты с ба&shy;за&shy;ми дан&shy;ных. В том чис&shy;ле у них есть тул&shy;за для ана&shy;ли&shy;за па&shy;мя&shy;ти, они бы&shy;ли вы&shy;нуж&shy;де&shy;ны ис&shy;сле&shy;до&shy;вать как эта па&shy;мять ра&shy;бо&shy;та&shy;ет. Там в очень ко&shy;рот&shy;ком сти&shy;ле, дос&shy;та&shy;точ&shy;ном для то&shy;го, что&shy;бы при&shy;ят&shy;но уди&shy;вить лю&shy;дей на со&shy;бе&shy;се&shy;до&shy;ва&shy;нии в ком&shy;па&shy;нию, это все опи&shy;са&shy;но. В ра&shy;йо&shy;не 200 стра&shy;ниц за&shy;ни&shy;ма&shy;ет. И моя кни&shy;га.</p>
<div class="paragraph-right-side">48</div>
</div>
<p >
Ка&shy;кие у вас воп&shy;ро&shy;сы воз&shy;ник&shy;ли?</p>
<ul>
<li>
<p >
.&hellip; (воп&shy;рос не слы&shy;шен на за&shy;пи&shy;си)</p>
</li>
<li>
<p >
По&shy;лу&shy;ча&shy;ет&shy;ся на&shy;до. По кар&shy;тин&shy;кам час&shy;тич&shy;но На&shy;талья от&shy;ве&shy;тит на этот воп&shy;рос, как пра&shy;виль&shy;но вы&shy;ка&shy;чи&shy;вать это, что&shy;бы лиш&shy;нее не рас&shy;хо&shy;до&shy;вать и что&shy;бы все бы&shy;ло удоб&shy;но. Испол&shy;ьз&shy;овать на&shy;до в лю&shy;бом слу&shy;чае од&shy;ни и те же мас&shy;си&shy;вы, ис&shy;поль&shy;зо&shy;вать пу&shy;лы, ко&shy;то&shy;рые по&shy;я&shy;ви&shy;лись. Мож&shy;но на&shy;пи&shy;сать свои или но&shy;вые, ко&shy;то&shy;рые по&shy;я&shy;ви&shy;лись. Что&shy;бы с этим гра&shy;мот&shy;но ра&shy;бо&shy;тать мож&shy;но ис&shy;поль&shy;зо&shy;вать то, о чем расс&shy;ка&shy;жет На&shy;талья.</p>
</li>
<li>
<p >
... (воп&shy;рос не слы&shy;шен на за&shy;пи&shy;си)</p>
</li>
<li>
<p >
Мас&shy;сив - это мас&shy;сив ссы&shy;лок. Вы не мо&shy;же&shy;те сде&shy;лать мас&shy;сив кар&shy;ти&shy;нок. Мас&shy;сив ссы&shy;лок на кар&shy;тин&shy;ки.</p>
</li>
<li>
<p >
... (воп&shy;рос не слы&shy;шен на за&shy;пи&shy;си)</p>
</li>
<li>
<p >
Испол&shy;ьзу&shy;йте это в ка&shy;чес&shy;тве клю&shy;ча GUI.</p>
</li>
<li>
<p >
... (воп&shy;рос не слы&shy;шен на за&shy;пи&shy;си)</p>
</li>
<li>
<p >
Воп&shy;рос о том, нас&shy;коль&shy;ко ло&shy;гич&shy;но пе&shy;ре&shy;ки&shy;ды&shy;вать по&shy;ток с яд&shy;ра на яд&shy;ро без уче&shy;та ис&shy;поль&shy;зо&shy;ва&shy;ния па&shy;мя&shy;ти конк&shy;рет&shy;ным яд&shy;ром. Ка&shy;кая по&shy;лу&shy;ча&shy;ет&shy;ся клас&shy;си&shy;фи&shy;ка&shy;ция в дан&shy;ном слу&shy;чае.</p>
</li>
</ul>
<div class="paragraph-container">
<div class="paragraph-left-side">49</div>
<p >
У нас есть пер&shy;вое яд&shy;ро. Оно что-то де&shy;ла&shy;ет, за ним за&shy;би&shy;то два по&shy;то&shy;ка. Ког&shy;да на не&shy;го пе&shy;ре&shy;ки&shy;ды&shy;ва&shy;ет&shy;ся со вто&shy;ро&shy;го яд&shy;ра, то в рам&shy;ках пер&shy;во&shy;го яд&shy;ра все в по&shy;ряд&shy;ке: оно как ра&shy;бо&shy;та&shy;ло со сво&shy;ей па&shy;мятью, так и ра&shy;бо&shy;та&shy;ет. Это сце&shy;на&shy;рий один. Сце&shy;на&shy;рий но&shy;мер два. Пе&shy;ре&shy;ки&shy;ды&shy;ва&shy;е&shy;мый по&shy;ток, со вто&shy;ро&shy;го на пер&shy;вое. Ког&shy;да мы это де&shy;ла&shy;ем, то мы его пе&shy;ре&shy;но&shy;сим не прос&shy;то так, а по&shy;то&shy;му, что он в дан&shy;ный мо&shy;мент ак&shy;тив&shy;но ал&shy;ло&shy;ци&shy;ру&shy;ет па&shy;мять. Все это де&shy;ла&shy;ет&shy;ся ис&shy;хо&shy;дя из ста&shy;тис&shy;ти&shy;ки. Из ста&shy;тис&shy;ти&shy;ки, ви&shy;ди&shy;мо, де&shy;ла&shy;ет&shy;ся сле&shy;ду&shy;ю&shy;щий вы&shy;вод: при&shy;ло&shy;же&shy;ние  ча&shy;ще ра&shy;бо&shy;та&shy;ет с па&shy;мятью, ко&shy;то&shy;рую оно толь&shy;ко что вы&shy;де&shy;ли&shy;ло.</p>
<div class="paragraph-right-side">49</div>
</div>
<ul>
<li>
<p >
... (воп&shy;рос не слы&shy;шен на за&shy;пи&shy;си)</p>
</li>
<li>
<p >
На це&shy;ле&shy;вом яд&shy;ре?</p>
</li>
</ul>
<div class="paragraph-container">
<div class="paragraph-left-side">50</div>
<p >
•	... (воп&shy;рос не слы&shy;шен на за&shy;пи&shy;си)
•	Ни&shy;че&shy;го не ля&shy;жет, там все в по&shy;ряд&shy;ке бу&shy;дет. Они что-то счи&shy;та&shy;ют, па&shy;мять не вы&shy;де&shy;ля&shy;ют, кон&shy;текст им не ну&shy;жен. У пер&shy;во&shy;го яд&shy;ра как бы&shy;ли па&shy;ра хи&shy;пов, так они там и ос&shy;та&shy;нут&shy;ся. Они на&shy;хо&shy;дят&shy;ся в про&shy;цес&shy;сор&shy;ном ке&shy;ше. И ког&shy;да ту&shy;да пе&shy;ре&shy;ез&shy;жа&shy;ет тред с дру&shy;го&shy;го яд&shy;ра и на&shy;чи&shy;на&shy;ет ал&shy;ло&shy;ци&shy;ро&shy;вать, кеш не зат&shy;ро&shy;нут. И с ра&shy;бо&shy;той то&shy;же са&shy;мое.</p>
<div class="paragraph-right-side">50</div>
</div>
<p >
•	 ... (воп&shy;рос не слы&shy;шен на за&shy;пи&shy;си)</p>
<ul>
<li>
<p >
Воз&shy;мож&shy;но, там нес&shy;коль&shy;ко все слож&shy;нее. Но на уров&shy;не, ко&shy;то&shy;рый нам дос&shy;ту&shy;пен на дан&shy;ный мо&shy;мент, объ&shy;яс&shy;не&shy;ние та&shy;кое.</p>
</li>
<li>
<p >
...(воп&shy;рос не слы&shy;шен на за&shy;пи&shy;си)</p>
</li>
</ul>
<div class="paragraph-container">
<div class="paragraph-left-side">51</div>
<p >
•	Где пос&shy;мот&shy;реть, как жи&shy;вет Linux?  Если вы хо&shy;ти&shy;те пос&shy;мот&shy;реть, как все то&shy;же са&shy;мое про&shy;ис&shy;хо&shy;дит в Linux, то мож&shy;но об&shy;ра&shy;тить&shy;ся к ре&shy;пор&shy;зи&shy;то&shy;рию CoreCLR, там в раз&shy;де&shy;ле до&shy;ку&shy;мен&shy;та&shy;ции есть botr - Book of the Runtime. Это веб-кни&shy;га, где раз&shy;ра&shy;бот&shy;чи&shy;ки яд&shy;ра пи&shy;шут до&shy;ку&shy;мен&shy;та&shy;цию, как это ра&shy;бо&shy;та&shy;ет. Это пер&shy;вый путь. Вто&shy;рой путь - это ис&shy;ход&shy;ни&shy;ки. Но я не со&shy;ве&shy;тую ту&shy;да смот&shy;реть, ес&shy;ли не хо&shy;ти&shy;те ужас&shy;нуть&shy;ся. Тре&shy;тий путь - это зай&shy;ти в Book of the Runtime, пос&shy;мот&shy;реть, кто  ту&shy;да пи&shy;шет текст и свя&shy;зать&shy;ся.</p>
<div class="paragraph-right-side">51</div>
</div>
<p >
•	 ...(воп&shy;рос не слы&shy;шен на за&shy;пи&shy;си)</p>
<ul>
<li>
<p >
Есть .NET стан&shy;дарт, есть раз&shy;ные плат&shy;фор&shy;мы. Как пи&shy;сать, что&shy;бы все ра&shy;бо&shy;та&shy;ло хо&shy;ро&shy;шо вез&shy;де. Ответ та&shy;кой. И .NET Core, и .NET framework ра&shy;бо&shy;та&shy;ют на ос&shy;но&shy;ве RED  JIT 57:05. Это не&shy;кая сис&shy;те&shy;ма джит&shy;тин&shy;га и GC. Ко&shy;до&shy;вая ба&shy;за у них од&shy;на. Отли&shy;чий ма&shy;ло. Нап&shy;ри&shy;мер, в ме&shy;то&shy;де кар&shy;точ&shy;но&shy;го сто&shy;ла есть от&shy;ли&shy;чия. В Windows прос&shy;тав&shy;ле&shy;ние фла&shy;гов как Bundle Table идет ав&shy;то&shy;ма&shy;ти&shy;чес&shy;ки на ос&shy;но&shy;ве триг&shy;ге&shy;ра и со стра&shy;ни&shy;цы па&shy;мя&shy;ти. В Linux это бу&shy;дет руч&shy;ная прос&shy;та&shy;нов&shy;ка. Но вас это вол&shy;но&shy;вать не дол&shy;жно, это низ&shy;ко&shy;уров&shy;не&shy;вая под&shy;роб&shy;ность, ко&shy;то&shy;рая ни на что не влияет. Основ&shy;ной слой, ко&shy;то&shy;рый влияет - уни&shy;фи&shy;ци&shy;ро&shy;ван, а дру&shy;гих осо&shy;бен&shy;нос&shy;тей я по&shy;ка не встр&shy;ечал.</p>
</li>
<li>
<p >
...(воп&shy;рос не слы&shy;шен на за&shy;пи&shy;си)</p>
</li>
<li>
<p >
Да, этой ли&shy;те&shy;ра&shy;ту&shy;ры впол&shy;не дос&shy;та&shy;точ&shy;но.</p>
</li>
</ul>
<p >
-&hellip; (воп&shy;рос не слы&shy;шен на за&shy;пи&shy;си)</p>
<ul>
<li>
<p >
Тут есть ба&shy;ланс. На счет то&shy;го, что есть кеш.</p>
</li>
</ul>
<div class="paragraph-container">
<div class="paragraph-left-side">52</div>
<p >
Кеш - это цент&shy;ра&shy;ли&shy;зо&shy;ван&shy;ное хра&shy;не&shy;ние. В том пла&shy;не, что все ссыл&shy;ки на млад&shy;шее по&shy;ко&shy;ле&shy;ние там бу&shy;дут хра&shy;нит&shy;ся ря&shy;дом - это клю&shy;че&shy;вое. В этом слу&shy;чае есть стоп&shy;ро&shy;цен&shy;т&shy;ная ве&shy;ро&shy;ят&shy;ность, что од&shy;но ма&shy;шин&shy;ное сло&shy;во в 32 би&shy;та пе&shy;рек&shy;ро&shy;ет весь кеш. Там не важ&shy;но, сколь&shy;ко ссы&shy;лок, бу&shy;дет выс&shy;тав&shy;ле&shy;на прос&shy;то од&shy;на еди&shy;ни&shy;ца.</p>
<div class="paragraph-right-side">52</div>
</div>
<ul>
<li>
<p >
... (воп&shy;рос не слы&shy;шен на за&shy;пи&shy;си)</p>
</li>
<li>
<p >
Если они ря&shy;дом хра&shy;нят&shy;ся, то это хо&shy;ро&shy;шо. Пло&shy;хая си&shy;ту&shy;а&shy;ция, ес&shy;ли у вас вто&shy;рое по&shy;ко&shy;ле&shy;ние боль&shy;шое и вы в разб&shy;рос по все&shy;му по&shy;ко&shy;ле&shy;нию в ка&shy;ком-то ал&shy;го&shy;рит&shy;ме пос&shy;то&shy;ян&shy;но прос&shy;тав&shy;ля&shy;ете ссыл&shy;ки на млад&shy;шее. Это ред&shy;кая си&shy;ту&shy;а&shy;ция. По&shy;э&shy;то&shy;му кар&shy;точ&shy;ный стол и при&shy;ду&shy;ман. При&shy;ло&shy;же&shy;ние бу&shy;дет прос&shy;тав&shy;лять ссыл&shy;ки на млад&shy;шее по&shy;ко&shy;ле&shy;ние из стар&shy;ше&shy;го в разб&shy;рос по всей па&shy;мя&shy;ти. Если та&shy;кое про&shy;ис&shy;хо&shy;дит - это очень пло&shy;хо, по&shy;то&shy;му что ему при&shy;дет&shy;ся прос&shy;мат&shy;ри&shy;вать ме&shy;га&shy;бай&shy;ты объ&shy;ек&shy;тов, в ка&shy;ких из них по&shy;ля ухо&shy;дят на млад&shy;шее по&shy;ко&shy;ле&shy;ние.</p>
</li>
</ul>
<div class="paragraph-container">
<div class="paragraph-left-side">53</div>
<p >
Все мес&shy;та, ко&shy;то&shy;рые ссы&shy;ла&shy;ют&shy;ся на бо&shy;лее млад&shy;шее по&shy;ко&shy;ле&shy;ние, по воз&shy;мож&shy;нос&shy;ти дол&shy;жны быть сгруп&shy;пи&shy;ро&shy;ва&shy;ны.</p>
<div class="paragraph-right-side">53</div>
</div>
<ul>
<li>
<p >
... (воп&shy;рос не слы&shy;шен на за&shy;пи&shy;си)</p>
</li>
<li>
<p >
Груп&shy;пи&shy;руя мес&shy;та ссы&shy;лок на млад&shy;шее по&shy;ко&shy;ле&shy;ние, вы уп&shy;ро&shy;ща&shy;ете ра&shy;бо&shy;ту GC. Если на&shy;об&shy;рорт, то он, встр&shy;ечая кар&shy;ту с еди&shy;ни&shy;цей, вы&shy;нуж&shy;ден прос&shy;мот&shy;реть ог&shy;ром&shy;ный ди&shy;а&shy;па&shy;зон па&shy;мя&shy;ти, ко&shy;то&shy;рая вся не ссы&shy;ла&shy;ет&shy;ся в млад&shy;шее по&shy;ко&shy;ле&shy;ние кро&shy;ме од&shy;но&shy;го по&shy;ля. Если раз&shy;ре&shy;же&shy;но ссы&shy;лать&shy;ся на млад&shy;шее по&shy;ко&shy;ле&shy;ние - это худ&shy;шая си&shy;ту&shy;а&shy;ция. Если все это раз&shy;мес&shy;тить ря&shy;дом, то он схо&shy;дит по кар&shy;точ&shy;но&shy;му сто&shy;лу один раз. Кеш - это хо&shy;ро&shy;шо.</p>
</li>
<li>
<p >
... (воп&shy;рос не слы&shy;шен на за&shy;пи&shy;си)</p>
</li>
<li>
<p >
Если мно&shy;го ке&shy;шей, то бу&shy;дет, ско&shy;рее все&shy;го, нес&shy;коль&shy;ко кар&shy;точ&shy;ных сто&shy;лов. Ког&shy;да у вас мно&shy;го не ке&shy;ши&shy;ро&shy;ва&shy;но, а прос&shy;то раз&shy;ре&shy;жен&shy;ная па&shy;мять и есть еди&shy;нич&shy;ные ссыл&shy;ки, ко&shy;то&shy;рые пос&shy;то&shy;ян&shy;но выс&shy;тав&shy;ля&shy;ют&shy;ся - это пло&shy;хо. - ... (воп&shy;рос не слы&shy;шен на за&shy;пи&shy;си)</p>
</li>
<li>
<p >
Async/await во&shy;об&shy;ще не пред&shy;по&shy;ла&shy;га&shy;ет зна&shy;ний о том, на ка&shy;ких по&shy;то&shy;ках это вы&shy;пол&shy;ня&shy;ет&shy;ся. Это син&shy;так&shy;си&shy;чес&shy;кий са&shy;хар. На счет син&shy;так&shy;си&shy;чес&shy;ко&shy;го са&shy;ха&shy;ра в даль&shy;ней&shy;ших док&shy;ла&shy;дах сде&shy;лан вы&shy;вод, что в наг&shy;ру&shy;жен&shy;ных участ&shy;ках при&shy;ло&shy;же&shy;ния, его ис&shy;поль&shy;зо&shy;вать нель&shy;зя. По&shy;то&shy;му что син&shy;так&shy;си&shy;чес&shy;кий са&shy;хар по&shy;рож&shy;да&shy;ет час&shy;то ал&shy;ло&shy;ци&shy;ро&shy;ва&shy;ние объ&shy;ек&shy;тов там, где вы не уви&shy;ди&shy;те это&shy;го по тек&shy;сту прог&shy;рам&shy;мы, это бу&shy;дет соп&shy;ро&shy;вож&shy;дать&shy;ся тра&shy;фи&shy;ком па&shy;мя&shy;ти, тра&shy;фи&shy;ком GC. По&shy;э&shy;то&shy;му ес&shy;ли у вас есть учас&shy;тки па&shy;мя&shy;ти, ко&shy;то&shy;рые ра&shy;бо&shy;та&shy;ют наг&shy;ру&shy;же&shy;но, там от син&shy;так&shy;си&shy;чес&shy;ко&shy;го са&shy;ха&shy;ра при&shy;дет&shy;ся от&shy;ка&shy;зать&shy;ся.</p>
</li>
<li>
<p >
... (воп&shy;рос не слы&shy;шен на за&shy;пи&shy;си)</p>
</li>
<li>
<p >
А это яв&shy;ля&shy;ет&shy;ся ре&shy;зуль&shy;та&shy;том син&shy;так&shy;си&shy;чес&shy;ко&shy;го са&shy;ха&shy;ра. По&shy;то&shy;му что async/await, это все та&shy;ки по&shy;мощь нам пи&shy;сать код удоб&shy;но. На&shy;до что&shy;бы наг&shy;ру&shy;жен&shy;ный код, ког&shy;да что-то вы&shy;де&shy;ля&shy;ет, де&shy;лал это в од&shy;ном конк&shy;рет&shy;ном по&shy;нят&shy;ном мес&shy;те, без ис&shy;поль&shy;зо&shy;ва&shy;ния до&shy;пол&shy;ни&shy;тель&shy;ных конст&shy;рукций. Тог&shy;да вы конт&shy;ро&shy;ли&shy;ру&shy;ете си&shy;ту&shy;а&shy;цию. Ког&shy;да вы де&shy;ла&shy;ете async/await, forEach, лям&shy;бды, вы на&shy;чи&shy;на&shy;ете ис&shy;поль&shy;зо&shy;вать до&shy;пол&shy;ни&shy;тель&shy;ные ал&shy;ло&shy;ка&shy;ции. Так соз&shy;да&shy;ет&shy;ся до&shy;пол&shy;ни&shy;тель&shy;ный тра&shy;фик. Это удоб&shy;но, но в пра&shy;виль&shy;ных про&shy;пор&shy;ци&shy;ях.</p>
</li>
</ul>

        </div>
    </div>
    <footer>
        <div class="book-container footer-container">
            <div class="footer-wrap">
                <img src="../../res/img/logo-w-noindex.svg">
                <p>
                    <a class="footer-link" target="_blank" href="mailto:sidristij@clrium.ru"><i class="far fa-envelope" aria-hidden="true"></i></a>
                    <a class="footer-link" target="_blank" href="https://vk.com/clrium"><i class="fab fa-vk" aria-hidden="true"></i></a>
                    <a class="footer-link" target="_blank" href="https://youtube.com/clrium"><i class="fab fa-youtube" aria-hidden="true"></i></a>
                    <a class="footer-link" target="_blank" href="https://github.com/clrium"><i class="fab fa-github" aria-hidden="true"></i></a>
                    <a class="footer-link" target="_blank" href="skype:stanislav.sidristyi"><i class="fab fa-skype" aria-hidden="true"></i></a>
                    <a class="footer-link" target="_blank" href="https://t.me/clrium_group"><i class="fab fa-telegram" aria-hidden="true"></i></a>
                </p>
            </div>
        </div>
    </footer>
</body>
</html>