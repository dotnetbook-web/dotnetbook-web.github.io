<!DOCTYPE html>
<html lang="ru">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>.NET Platform Architecture</title>
</head>
<body>
    <script src="../../res/jquery.js"></script>
    <link rel="stylesheet" href="../../res/bootstrap.css">
    <link rel="stylesheet" href="../../res/awesome.css">
    <style>

body {
    font-family: PF Regal,Georgia,serif;
    font-size: 16pt;
    font-weight: 300;
    padding-top: 4em;
    background-color: #fdfdfd;
}

.book-title-container {
    width: 100%;
    text-align: center;
    margin: 73px 0 110px 0;
}

.book-title {
    font-size: 57pt;
    margin: 50px 0 70px 0;
    user-select: none;
}
.book-part-title-block {
    display: inline-block;
}
.book-part-title {
    font-size: 21pt;
    color: #656ab6;
    margin: 0 7px;
}

.book-part-title:hover {
    box-shadow: inset 0 -1px #007bff;
    text-decoration: none;
}

.book-superheading-title {
    font-size: 15pt;
    margin: 0 7px;
    color: #656ab6;
}

.article-container
{
    width: 62%;
}

strong {
    font-weight: 500;
}

p, li {
    margin: 0 0 1em;
    line-height: 1.5em;
    font-family: inherit;
}

ol, li {
    margin-top: 1em;
    margin-bottom: 1em;
}

ol {
    padding-left: 1.21em;
}

ul  {
    padding-left: 1em;
}

ol li, ul li {
    padding-left: 0.5em;	
    font-family: inherit;
    text-align: justify;
}

table {
    margin: 30px 0;
    width: 100%;
}

thead {
    background-color: aliceblue;
}

table th {
    font-weight: 400;
}

table td, table th {
    padding: 7px;
    border-top: solid darkgrey 1px;
    border-bottom: solid darkgrey 1px;
    border-right: dotted darkgray 1px;
    border-left: dotted darkgray 1px;
    font-size: smaller;
}

code, *[class*='lang-'] span, *[class*='lang-'] pre {
    font-family: JB Mono, monospace !important;
}

*[class*='lang-'] {
    padding: 0px 0px 25px 0px;
    font-size: 0.75em;
}


*[class*='lang-'] > div, pre > code {
    border-left-color: #eee;
    border-left-style: dotted;
    border-left-width: 3px;
    padding-left: 25px;
    display: block;
    padding-top: 20px;
    padding-bottom: 20px;
}

*[class*='lang-'] > div pre, pre > code pre {
    margin-bottom: 0;
}

p code:not(.highlight), li code:not(.highlight) {
    font-size: 0.7em;
    border: gainsboro;
    border-width: 1px;
    border-style: solid;
    padding: 3px;
    color: darkslateblue;
}

code.highlight {
    font-family: inherit !important;
    font-size: inherit;
    font-weight: inherit;
    color: inherit;
}

p code.highlight, li code.highlight {
    padding: 4px;
    background-color: #ffffa1;
}

.wide {
    width:140%;
}

p a, li a {
    text-decoration: none;
    color: inherit;
    box-shadow: inset 0 -1px #b88b59;
}

p a:hover, li a:hover {
    text-decoration: none;
    color: inherit;
    box-shadow: inset 0 -1px #0056b3;
}

blockquote h5 {
    background-color: aquamarine;
    margin: 16px 0 16px -20px;
    padding: 15px 30px 15px;
}

p img {
    width: 95%;
}

blockquote 
{
    padding-left: 0.4em;
    border-left: 0.5em solid rgba(0,0,0,.08);
    font-style: italic;
}

blockquote.big-quote, 
blockquote.breadcrumbs 
{
    background-color: transparent;
    padding: 0;
    border-left: none;
    font-style: normal;
}

blockquote.breadcrumbs, blockquote.breadcrumbs  p
{
    margin: 0;
    padding: 0;
}

blockquote p {
    padding: 1em 1em 1em 0.6em;
    font-family: inherit;
}

blockquote p code {
    font-family: consolas, monospace;
    font-size: 17px;
    padding: 4px 6px;
}

blockquote p em {
    font-weight: 400;
}

blockquote.big-quote > p {
    margin: 0.7em 0 0.7em 0;
    font-family: Charter;
    font-size: 2.5em;
    padding: 0;
    width: 130%;
    line-height: 1em;
}

h1, h2, h3, h4, h5, h6 {
    margin: 0;
    padding: 0;
    font-weight: 400;
    font-family: inherit;
}

h1 {
    font-size: 2.2em;
    font-family: Charter,Georgia,serif;
    font-weight: 300;
    margin: 1.8em 0 1.8em 0;
    text-align: center;
    width: 140%;
}

h2 {
    margin-top: 2em;
    font-family: Charter, Arial, Helvetica Neue, sans-serif;
    font-size: 1.25em;
    width: 70%;
}

h3 {
    margin: 1.5em 0 0 0;
    font-size: 1.3em;
    font-weight: 300;
    font-style: italic;
}

h4 {
    margin: 20px 0 10px 0;
    font-size: 16pt;
    font-weight: 500;
    font-style: italic;
}

/* Sidenotes */

.aside-container {
    position: relative;
}
.aside-container p {
    position: relative;
    top: 9px;
}

.aside-container > .aside-side-container {
    display: block;
    position: absolute;
    top: 12px;
    left: 96%;
    width: 34%;
    font-size: 12pt;
    line-height: 20px;
    margin-left: 100px;
    z-index: 1000;
}

.aside-container > .aside-side-container p {
    line-height: 24px;
    font-size: 13pt;
    margin: 0 0 13px 0;
}

.side-regular-block p {
    top: 0;
}

/* Music side player */
.aside-side-container .music-player {
    width: 100%;
    height: 400px;
}

/* media block after h1 */
.aside-container h1 + .aside-side-container.side-media-block h2 {
    margin: 7em 0 1em 0;
    font-family: Proxima Nova,Arial,Helvetica Neue,sans-serif;
    font-weight: 600;
}

.aside-side-container > li {
    display: block;
    font-family: Charter;
}

.aside-side-container > li ul, .aside-side-container > li ol {
    padding-left: 30px;
    margin-top: 0.5em;
    margin-bottom: 0.5em;
}
.aside-side-container > li li {
    padding-left: 6px;
    margin: 0 0 6px;
    line-height: 22px;

    font-family: Charter;
}

.aside-side-container p {
    line-height: 25px;
    font-size: 13pt;
    margin: 0 0 15px 0;
}

.aside-side-container blockquote {
    border: aliceblue;
    border-left-style: solid;
}

/* Paragraphs numbering */
.paragraph-container {
    position: relative;
}
.paragraph-container p {
    position: relative;
    top: 9px;
}

.paragraph-container p, .aside-container > p {
    text-align: justify;
}

.paragraph-container > .paragraph-left-side, .paragraph-container > .paragraph-right-side  {
    font-family: JB Mono, consolas;
    display: block;
    position: absolute;
    top: 17px;
    font-size: 10pt;
    line-height: 20px;
    color: #86abc473;
    z-index: 1000;
}
.paragraph-container > .paragraph-left-side {
    display: none;
    left: -2.1cm;
    width: 35px;
    user-select: none;
}

.paragraph-container > .paragraph-right-side  {
    display: none;
    left: 100%;
    width: 35px;
    padding-left: 45px;
    user-select: none;
}

.article-container
{
    width: 70%;
}

/* X_MENU */
.menu-title {
    text-align: center;
    margin: 35px 50px 35px 50px;
    font-size: 24pt;
    font-family: Charter;
}

.menu-container ol {
    margin: 0;
    padding: 0;
}

.menu-container ol li {
    margin: 0;
    padding: 0;
}

.header {
    height: 4em;
    background-color: white;
    position: relative;
    z-index: 1500;
    width: 100%;
    display: flex;
    justify-content: space-between;
    transition: all 1s;
    top: 0;
    box-shadow: 1px -4px 20px rgba(0, 0, 0, .1);
}

.fixed {
    position: fixed !important;
}

.header > .menu {
    pointer-events: auto;
    float: right;
    height: 40px;
    font-family: Charter, 'Helvetica Neue', Arial, sans-serif;
    font-size: 1em;
    color: #fff;
    margin-top:40px;
    margin-right:40px;
}

.menu a {
    color: #fff;
}
.menu a:hover {
    text-decoration: none;
    color: #fff;
}

#menu__toggle {
    opacity: 0;
}

#menu__toggle:checked ~ .menu__btn > span {
    transform: rotate(45deg);
}
#menu__toggle:checked ~ .menu__btn > span::before {
    top: 0;
    transform: rotate(0);
    background-color: black
}
#menu__toggle:checked ~ .menu__btn > span::after {
    top: 0;
    transform: rotate(90deg);
    background-color: black
}
#menu__toggle:checked ~ .menu__box {
    visibility: visible;
    right: 0;
}

.menu__btn {
    display: flex;
    align-items: center;
    position: fixed;
    top: 0;
    right: 0;
    width: 1.4em;
    height: 1.0em;
    cursor: pointer;
    z-index: 1;
    margin: 1.5em;
}

.menu__btn > span,
.menu__btn > span::before,
.menu__btn > span::after {
    display: block;
    position: absolute;

    width: 100%;
    height: 1px;

    background-color: black;

    transition-duration: .25s;
}
.menu__btn > span::before {
    content: '';
    top: -8px;
}
.menu__btn > span::after {
    content: '';
    top: 8px;
}

.menu__box {
    display: block;
    position: fixed;
    visibility: hidden;
    top: 0;
    right: -100%;

    width: 100%;
    height: 100%;

    margin: 0;
    padding: 80px 0;

    list-style: none;

    background-color: white;
    box-shadow: 1px 0px 6px rgba(0, 0, 0, .2);

    transition-duration: .25s;

    overflow-y: auto;
}
.menu__box li a:hover {
    text-decoration: none;
    color: inherit;
}
.menu__list {
    font-size: 0.9em;
    margin: 0 2em 0 2em;
}
.menu__list li {
    text-align: left;
}

/* X_HEADER */

.conflogo {
    height: 1.2em;
    margin: 0.95em 0 0 1em;
    font-size: 1.5em;
    font-family: Charter;
    user-select: none;
}

.invisible {
    display: none;
}

.header > .menu > div {
    display: inline;
    margin-left: 10px;
    margin-right: 10px;
}

.menu__header_current
{
    text-align: center;
    font-size: 2em;
    margin: 0 0 1em 0;
}

.menu__header_total
{
    text-align: center;
    font-size: 2.4em;
    margin: 1.7em 0 0.3em 0;
}
.menu__header_list 
{
    padding: 0;
    margin-top: 0;
    margin-left: 0;
    margin-right: 0;
}
.menu__header_list > li 
{
    display: inline-block;
    width: 100%;
    margin: 0;
    text-align: center;
    font-family: charter;
}
.menu__header_total_sub
{
    font-size: 1.4em;
    margin: 2em 0 1em 0;
}
.menu__header_total_sub2
{
    font-size: 1.1em;
    margin: 1.5em 0 0.6em 1em;
    text-align: left;
}
/* X_FOOTER */

footer {
    margin-top: 2em;
    background-color: black;
    height: 4em;
}

footer > div {
    box-shadow: 0px 2px 2px rgb(0, 0, 0);
}

.footer-container {
    height: 100%;
}

.footer-wrap {
    color: #fff;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 25px 0;
}

.footer-wrap p {
    margin: 0;
    padding: 0px;
    line-height: 1em;
}

.footer-container img {
    height: 1.6em;
    margin-top: auto;
    margin-bottom: auto;
}

.footer-link {
    color: white;
    margin: 0 7px;
    font-size: 1em;
    box-shadow: none;
}

.footer-link:hover {
    color: salmon;
    box-shadow: none;
}

/* MEDIA */
/* XXL */
@media (min-width: 1601px) {
    .book-container
    {
        max-width: 1200px;
        margin-left: auto;
        margin-right: auto;
    }
}

/* XL */
@media (max-width: 1600px) {
    .book-container
    {
        margin-left: 4cm;
        margin-right: 4cm;
    }
}

/* LG */
@media (max-width: 1400px) {
    .book-container
    {
        margin-left: 4cm;
        margin-right: 4cm;
    }

    blockquote.big-quote > p {
        font-size: 2em;
    }
}

/* > MD */
@media (min-width: 992px) {
    .hamburger-menu {
        display: none;
    }
}

/* MD */
@media (max-width: 991px) {
    
    h2 {
        width:80%;
    }

    .book-container
    {
        margin-left: 3cm;
        margin-right: 3cm;
    }
    
    .book-title-container {
        margin: 73px 0 110px 0;
    }

    .book-title {
        font-size: 50pt;
        margin: 50px 0 70px 0;
    }

    .book-part-title {
        font-size: 19pt;
    }

    .book-part-title:hover {
        box-shadow: inset 0 -1px #007bff;
    }

    .book-superheading-title {
        font-size: 15pt;
    }                                     

    .article-container, h1 {
        width: 100%;
    }

    .aside-container p {
        top: 0;
    }

    .aside-container h1 + .aside-side-container.side-media-block h2 {
        display: none;
    }

    .wide {
        width: 100%;     
    }

    .side-regular-block {
        margin: 40px 10px;
        padding-left: 100px;
    }
    .aside-side-container .music-player {
        width: 100%;
        height: 100px;
    }
    .aside-side-container.side-media-block {
        padding: 17px 0;
    }
    .aside-side-container.side-media-block h2 {
        margin-top: 20px;
        font-size: 13pt;
        border: none;
    }

    .aside-container > .aside-side-container
    {
        position: relative;
        top: auto;
        left: auto;
        width: auto;
        height: auto;
        margin: 0;
        padding: 17px;
    }

    blockquote.big-quote > p {
        width: 100%;
        font-size: 2em;
    }

    .paragraph-container .paragraph-left-side {
        left: -55px;
    }

    body {
        font-size: 15pt;
    }

    p code:not(.highlight), li code:not(.highlight) {
        font-size: 11pt;
    }

    p, li {
        line-height: 30px;
    }
    
    li {
        margin: 0 0 10px 0;
    }

    .side-regular-block {
        border-radius: 5px;
        background-image: linear-gradient(180deg,hsla(0,0%,100%,0) 60%,#fff),linear-gradient(70deg,#dbedff 32%,#ebfff0);
        padding: 22px;
    }    

    .menu__list
    {
        margin-top: 0;
        margin-bottom: 0;
    }

    .menu__list, .menu__header_total_sub2
    {
        margin-left: auto;
        margin-right: auto;
        max-width: 800px;
        width: 80%;
    }

    .book-container 
    {
        position: absolute;
        padding: 0 3cm 0 3cm;
        overflow: scroll;
        overflow-x: auto;
        top: 4em;
        bottom: 0;
        width: 100%;
        margin: 0;
    }

    footer {
        margin-top: 2em;
        background-color: black;
        height: 4em;
    }

    footer > div {
        position: relative;
        margin: 0 -3cm;
        background: black;
        padding: 0 3cm;
    }
}

/* Smartphone horizontal - SM */
@media (max-width: 767px) {
    .book-title-container {
        margin: 73px 0 110px 0;
    }

    h1 {
        margin: 1.8em 0em 1.8em 0.3em;
    }

    .book-title {
        font-size: 40pt;
        margin: 50px 0 70px 0;
    }

    .book-part-title {
        font-size: 19pt;
    }

    .book-part-title:hover {
        box-shadow: inset 0 -1px #007bff;
    }

    .book-superheading-title {
        font-size: 17pt;
    }

    .book-container {
        padding: 0 2.5cm;
    }
    ul {
        margin-left: 30px;
        margin-right: 30px;
        padding-left: 25px;
    }
    .paragraph-container > .paragraph-left-side {
	    display: block;
        top: 14px;
        font-size: 9pt;
    }
    .paragraph-container > .paragraph-right-side {
    	display: block;
        padding-left: 40px;
        top: 14px;
        font-size: 9pt;
    }
    .footer-container img {
        height: 1.3em;
    } 
}

@media (max-width: 630px) {
    .book-container {
        padding: 0 1.5cm;
    }
    .paragraph-container > .paragraph-left-side {
        left: -33px;
    }
    .paragraph-container > .paragraph-right-side {
        padding-left: 24px;
    }
}
/* Smartphone - XS */
@media (max-width: 575px) {
    .book-container {
        padding: 0 50px 0 30px;
    }
    ul {
        margin: 0;
        padding-left: 20px;
    }

    body {
        font-size: 13pt;
    }

    p code:not(.highlight), li code:not(.highlight) 
    {
        font-size: 10pt;
        padding: 3px;
    }
   
    p, li {
        line-height: 24px;
    }    
    
    .paragraph-container .paragraph-left-side 
    {
        display: none;        
    }
    .paragraph-container .paragraph-right-side 
    {
        padding-left: 21px;
        top: 14px;
	    font-size: 8pt;
    }
    .footer-container img {
        height: 1em;
    } 
    .menu__list {
        margin: 0 1em 0 1em;
    }
    .menu__header_total_sub2
    {
        margin: 1.5em 0 0.6em 1em;
    }
}

/* Fonts */

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-Bold.eot');
    src: local('../../res/fonts/PFRegalTextPro-Bold'),
        url('../../res/fonts/PFRegalTextPro-Bold.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-Bold.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-Bold.ttf') format('truetype');
    font-weight: bold;
    font-style: normal;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-Medium.eot');
    src: local('../../res/fonts/PFRegalTextPro-Medium'),
        url('../../res/fonts/PFRegalTextPro-Medium.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-Medium.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-Medium.ttf') format('truetype');
    font-weight: 500;
    font-style: normal;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-BlackItalic.eot');
    src: local('../../res/fonts/PFRegalTextPro-BlackItalic'),
        url('../../res/fonts/PFRegalTextPro-BlackItalic.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-BlackItalic.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-BlackItalic.ttf') format('truetype');
    font-weight: 900;
    font-style: italic;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-Black.eot');
    src: local('../../res/fonts/PFRegalTextPro-Black'),
        url('../../res/fonts/PFRegalTextPro-Black.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-Black.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-Black.ttf') format('truetype');
    font-weight: 900;
    font-style: normal;
}

@font-face {
    font-family: 'PF Regal UBlack';
    src: url('../../res/fonts/PFRegalTextPro-UBlack.eot');
    src: local('../../res/fonts/PFRegalTextPro-UBlack'),
        url('../../res/fonts/PFRegalTextPro-UBlack.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-UBlack.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-UBlack.ttf') format('truetype');
    font-weight: 900;
    font-style: normal;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-MediumItalic.eot');
    src: local('../../res/fonts/PFRegalTextPro-MediumItalic'),
        url('../../res/fonts/PFRegalTextPro-MediumItalic.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-MediumItalic.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-MediumItalic.ttf') format('truetype');
    font-weight: 500;
    font-style: italic;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-UBlackItalic.eot');
    src: local('../../res/fonts/PFRegalTextPro-UBlackItalic'),
        url('../../res/fonts/PFRegalTextPro-UBlackItalic.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-UBlackItalic.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-UBlackItalic.ttf') format('truetype');
    font-weight: 900;
    font-style: italic;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-RegularAItalic.eot');
    src: local('../../res/fonts/PFRegalTextPro-RegularAItalic'),
        url('../../res/fonts/PFRegalTextPro-RegularAItalic.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-RegularAItalic.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-RegularAItalic.ttf') format('truetype');
    font-weight: 300;
    font-style: italic;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-BoldItalic.eot');
    src: local('../../res/fonts/PFRegalTextPro-BoldItalic'),
        url('../../res/fonts/PFRegalTextPro-BoldItalic.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-BoldItalic.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-BoldItalic.ttf') format('truetype');
    font-weight: bold;
    font-style: italic;
}

@font-face {
    font-family: 'Charter';
    src: url('../../res/fonts/charter-regular.woff2') format('woff2');
    font-weight: normal;
    font-style: normal;
}

/*  Regular B */
@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-RegularBItalic.eot');
    src: local('../../res/fonts/PFRegalTextPro-RegularBItalic'),
        url('../../res/fonts/PFRegalTextPro-RegularBItalic.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-RegularBItalic.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-RegularBItalic.ttf') format('truetype');
    font-weight: 300;
    font-style: italic;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-RegularB.eot');
    src: local('../../res/fonts/PFRegalTextPro-RegularB'),
        url('../../res/fonts/PFRegalTextPro-RegularB.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-RegularB.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-RegularB.ttf') format('truetype');
    font-weight: 300;
    font-style: normal;
}

@font-face {
    font-family: 'JB Mono';
    src: url('../../res/fonts/JetBrainsMono-Regular.eot');
    src: local('../../res/fonts/JetBrainsMono-Regular'),
        url('../../res/fonts/JetBrainsMono-Regular.woff2') format('woff2'),
        url('../../res/fonts/JetBrainsMono-Regular.woff') format('woff'),
        url('../../res/fonts/JetBrainsMono-Regular.ttf') format('truetype');
    font-weight: 300;
    font-style: normal;
}
@font-face {
    font-family: 'JB Mono';
    src: url('../../res/fonts/JetBrainsMono-Italic.eot');
    src: local('../../res/fonts/JetBrainsMono-Italic'),
        url('../../res/fonts/JetBrainsMono-Italic.woff2') format('woff2'),
        url('../../res/fonts/JetBrainsMono-Italic.woff') format('woff'),
        url('../../res/fonts/JetBrainsMono-Italic.ttf') format('truetype');
    font-weight: 300;
    font-style: italic;
}

@font-face {
    font-family: 'JB Mono';
    src: url('../../res/fonts/JetBrainsMono-Medium.eot');
    src: local('../../res/fonts/JetBrainsMono-Medium'),
        url('../../res/fonts/JetBrainsMono-Medium.woff2') format('woff2'),
        url('../../res/fonts/JetBrainsMono-Medium.woff') format('woff'),
        url('../../res/fonts/JetBrainsMono-Medium.ttf') format('truetype');
    font-weight: 500;
    font-style: normal;
}
@font-face {
    font-family: 'JB Mono';
    src: url('../../res/fonts/JetBrainsMono-Medium-Italic.eot');
    src: local('../../res/fonts/JetBrainsMono-Medium-Italic'),
        url('../../res/fonts/JetBrainsMono-Medium-Italic.woff2') format('woff2'),
        url('../../res/fonts/JetBrainsMono-Medium-Italic.woff') format('woff'),
        url('../../res/fonts/JetBrainsMono-Medium-Italic.ttf') format('truetype');
    font-weight: 500;
    font-style: italic;
}
@font-face {
    font-family: 'Font Awesome 5 Free';
    font-style: normal;
    font-weight: 400;
    font-display: swap;
    src: url("../../res/fonts/webfonts/fa-regular-400.eot");
    src: url("../../res/fonts/webfonts/fa-regular-400.eot?#iefix") format("embedded-opentype"), 
         url("../../res/fonts/webfonts/fa-regular-400.woff2") format("woff2"), 
         url("../../res/fonts/webfonts/fa-regular-400.woff") format("woff"), 
         url("../../res/fonts/webfonts/fa-regular-400.ttf") format("truetype"), 
         url("../../res/fonts/webfonts/fa-regular-400.svg#fontawesome") format("svg"); 
    font-display: swap;
}
    
.fa {
    font-family: 'Font Awesome 5 Free';
    font-weight: 400;
    font-display: swap;
}
@font-face {
  font-family: 'Font Awesome 5 Brands';
  font-style: normal;
  font-weight: 400;
  font-display: auto;
  src: url("../../res/fonts/fa-brands-400.eot");
  src: url("../../res/fonts/fa-brands-400.eot?#iefix") format("embedded-opentype"), url("../../res/fonts/fa-brands-400.woff2") format("woff2"), url("../../res/fonts/fa-brands-400.woff") format("woff"), url("../../res/fonts/fa-brands-400.ttf") format("truetype"), url("../../res/fonts/fa-brands-400.svg#fontawesome") format("svg"); 
}

.fab {
  font-family: 'Font Awesome 5 Brands';
  font-weight: 400; 
}

@font-face {
  font-family: 'Font Awesome 5 Free';
  font-style: normal;
  font-weight: 400;
  font-display: auto;
  src: url("../../res/fonts/fa-regular-400.eot");
  src: url("../../res/fonts/fa-regular-400.eot?#iefix") format("embedded-opentype"), url("../../res/fonts/fa-regular-400.woff2") format("woff2"), url("../../res/fonts/fa-regular-400.woff") format("woff"), url("../../res/fonts/fa-regular-400.ttf") format("truetype"), url("../../res/fonts/fa-regular-400.svg#fontawesome") format("svg"); 
}

.far {
  font-family: 'Font Awesome 5 Free';
  font-weight: 400; 
}

@font-face {
  font-family: 'Font Awesome 5 Free';
  font-style: normal;
  font-weight: 900;
  font-display: auto;
  src: url("../../res/fonts/fa-solid-900.eot");
  src: url("../../res/fonts/fa-solid-900.eot?#iefix") format("embedded-opentype"), url("../../res/fonts/fa-solid-900.woff2") format("woff2"), url("../../res/fonts/fa-solid-900.woff") format("woff"), url("../../res/fonts/fa-solid-900.ttf") format("truetype"), url("../../res/fonts/fa-solid-900.svg#fontawesome") format("svg"); 
}
</style>  
    <div class="book-title-container d-none d-lg-block">
        <div class="book-title">Knowledge Base</div>
        <div class="book-part-title-block">pt.1 <a href="../..//ru/Memory/01-00-MemoryManagement-Intro.html" class="book-part-title">Управление памятью</a></div>
        <div class="book-part-title-block">pt.2 <a href="../..//ru/Execution/02-00-ExecutionFlow-Intro.html" class="book-part-title">Поток исполнения команд</a></div>
        <br><a href="#" class="book-superheading-title">Обоснование выбора</a>
        / <a href="#" class="book-superheading-title">Упрощенное описание</a>
        / <a href="#" class="book-superheading-title">Подробное описание</a>
    </div>
    <header class="header fixed d-block d-lg-none">
        <p class="conflogo">KB</p> 

        <!-- mobile-menu -->

        <div class="hamburger-menu">
            <input id="menu__toggle" type="checkbox" />
            <label class="menu__btn" for="menu__toggle">
              <span></span>
            </label>
        
            <div class="menu__box">
                <p class="menu__header_current">На странице</p>
                <ol class="menu__list">
                    <li><a href="#x86" onclick="$('#menu__toggle').click(); return true;">
Базовая структура, платформа x86</a></li>
<li><a href="#x86-1" onclick="$('#menu__toggle').click(); return true;">
Немного про исключения на платформе x86</a></li>
<li><a href="#x64-amd64-in-progress" onclick="$('#menu__toggle').click(); return true;">
Базовые сведения про платформы x64, AMD64 </a></li>
<li><a href="#x64-amd64-in-progress-1" onclick="$('#menu__toggle').click(); return true;">
Исключения на платформах x64, AMD64 </a></li>
<li><a href="#section-1" onclick="$('#menu__toggle').click(); return true;">
Совсем немного про несовершенство стека потока</a></li>
<li><a href="#section-2" onclick="$('#menu__toggle').click(); return true;">
Большой пример: клонирование потока на платформе х86</a></li>
<li><a href="#stackalloc-1" onclick="$('#menu__toggle').click(); return true;">
Выводы к stackalloc</a></li>

                </ol>
                <p class="menu__header_total">Содержание</p>
                <ul class="menu__header_list">
                    <li>
                        <p class="menu__header_total_sub">
                            Управление памятью
                        </p>
                        <p class="menu__header_total_sub2">
                            Теоретические вопросы:
                        </p>
                        <ol class="menu__list">
                            <li><p><a href="../..//ru/Memory/01-00-MemoryManagement-Intro.html">
                                Общие слова
                            </a></p></li>
                            <li>
                                <p>
                                <a href="../..//ru/Memory/01-02-MemoryManagement-Basics.html">Введение в управление памятью</a></p>
                            </li>
                            <li>
                                <p>
                                <a href="../..//ru/Memory/01-04-MemoryManagement-ThreadStack.html">Стек потока</a></p>
                            </li>
                            <li>
                                <p>
                                <a href="../..//ru/Memory/01-06-MemoryManagement-EntitiesLifetime.html">Время жизни сущности</a></p>
                            </li>
                            <li>
                                <p>
                                <a href="../..//ru/Memory/01-08-MemoryManagement-RefVsValueTypes.html">RefTypes, ValueTypes, Boxing &amp; Unboxing</a></p>
                            </li>
                            <li>
                                <p>
                                <a href="../..//ru/Memory/01-10-MemoryManagement-IDisposable.html">Шаблон Disposable</a></p>
                            </li>
                            <li>
                                <p>
                                <a href="../..//ru/Memory/01-12-MemoryManagement-Finalizer.html">Финализация</a></p>
                            </li>
                            <li>
                                <p>
                                <a href="../..//ru/Memory/01-14-MemoryManagement-Results.html">Выводы</a></p>
                            </li>
                        </ol>
                        <p class="menu__header_total_sub2">
                            Практические вопросы:
                        </p>
                        <ol class="menu__list" start="9">
                            <li><p><a href="../..//ru/Memory/02-02-MemoryManagement-MemorySpan.html">
                                Memory&lt;T&gt;, Span&lt;T&gt;
                            </a></p></li>
                        </ol> 
                    </li>
                    <li>
                        <p class="menu__header_total_sub">
                            Поток исполнения команд
                        </p>
                        <p class="menu__header_total_sub2">
                            Многопоточность:
                        </p>
                        <ol class="menu__list">
                            <li><p><a href="../..//ru/Execution/1-Threads/1-OS/1-threadsScheduling.html">
                                Потоки и планирование потоков
                            </a></p></li>
                        </ol>
                        <p class="menu__header_total_sub2">
                            Искл­юч­ител­ьные си­ту­а­ции:
                        </p>
                        <ol class="menu__list" start="2">
                            <li><p><a href="../..//ru/Execution/2-ExceptionalFlow/1-Exceptions-Intro.html">
                                Введение в исключительные ситуации
                            </a></p></li>
                            <li><p><a href="../..//ru/Execution/2-ExceptionalFlow/2-Exceptions-Architecture.html">
                                Архитектура исключительной ситуации
                            </a></p></li>
                            <li><p><a href="../..//ru/Execution/2-ExceptionalFlow/3-Exceptions-Events.html">
                                События об исключительных ситуациях
                            </a></p></li>
                            <li><p><a href="../..//ru/Execution/2-ExceptionalFlow/4-Exceptions-Types.html">
                                Виды исключительных ситуаций
                            </a></p></li>
                        </ol>
                    </li>
                </ul>
            </div>
        </div>
    </header>

    <div class="book-container">
        <div class="article-container">
            <!--<p class="d-xs-block d-sm-none">XS</p>
            <p class="d-none d-xs-block d-sm-none">SM</p>
            <p class="d-none d-sm-block d-md-none">MD</p>
            <p class="d-none d-lg-block d-xl-none">LG</p>
            <p class="d-none d-xl-block">XL</p> -->
            <blockquote class="breadcrumbs">
<p >
 <a href="../readme.html">Содержание</a> / <a href="./01-00-MemoryManagement-Intro.html">Основы управления памятью</a></p>
</blockquote>
<h1 id="section">Стек потока</h1>
<h2 id="x86">Базовая структура, платформа x86</h2>
<div class="paragraph-container">
<div class="paragraph-left-side">01</div>
<p >
Су&shy;щес&shy;тву&shy;ет об&shy;ласть па&shy;мя&shy;ти, про ко&shy;то&shy;рую ред&shy;ко за&shy;хо&shy;дит раз&shy;го&shy;вор. Одна&shy;ко эта об&shy;ласть яв&shy;ля&shy;ет&shy;ся, воз&shy;мож&shy;но, ос&shy;нов&shy;ной в ра&shy;бо&shy;те при&shy;ло&shy;же&shy;ния. Са&shy;мой час&shy;то ис&shy;поль&shy;зу&shy;е&shy;мой, дос&shy;та&shy;точ&shy;но ог&shy;ра&shy;ни&shy;чен&shy;ной с мо&shy;мен&shy;таль&shy;ным вы&shy;де&shy;ле&shy;ни&shy;ем и ос&shy;во&shy;бож&shy;де&shy;ни&shy;ем па&shy;мя&shy;ти. Область эта на&shy;зы&shy;ва&shy;ет&shy;ся &laquo;стек по&shy;то&shy;ка&raquo;. Причём пос&shy;коль&shy;ку ука&shy;за&shy;тель на не&shy;го ко&shy;ди&shy;ру&shy;ет&shy;ся по сво&shy;ей су&shy;ти ре&shy;гист&shy;ра&shy;ми про&shy;цес&shy;со&shy;ра, ко&shy;то&shy;рые вхо&shy;дят в кон&shy;текст по&shy;то&shy;ка, то в рам&shy;ках ис&shy;пол&shy;не&shy;ния лю&shy;бо&shy;го по&shy;то&shy;ка стек по&shy;то&shy;ка свой. За&shy;чем он не&shy;об&shy;хо&shy;дим?</p>
<div class="paragraph-right-side">01</div>
</div>
<p >
Итак, раз&shy;берём эле&shy;мен&shy;тар&shy;ный при&shy;мер ко&shy;да:</p>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">void</span> Method1()
{
    Method2(123);
}

<span style="color:Blue;">void</span> Method2(<span style="color:Blue;">int</span> arg)
{
    <span style="color:Green;">// ...</span>
}
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">02</div>
<p >
В дан&shy;ном ко&shy;де не про&shy;ис&shy;хо&shy;дит ни&shy;че&shy;го при&shy;ме&shy;ча&shy;тель&shy;но&shy;го, од&shy;на&shy;ко не бу&shy;дем его про&shy;пус&shy;кать, а на&shy;о&shy;бо&shy;рот: пос&shy;мот&shy;рим на не&shy;го мак&shy;си&shy;маль&shy;но вни&shy;ма&shy;тель&shy;но. Ког&shy;да лю&shy;бой <code>Method1</code> вы&shy;зы&shy;ва&shy;ет лю&shy;бой <code>Method2</code>, то аб&shy;со&shy;лют&shy;но лю&shy;бой та&shy;кой вы&shy;зов (и не толь&shy;ко в .NET, но и в дру&shy;гих плат&shy;фор&shy;мах) осу&shy;щес&shy;твляет сле&shy;ду&shy;ю&shy;щие опе&shy;ра&shy;ции:</p>
<div class="paragraph-right-side">02</div>
</div>
<ol>
<li>
<p >
Пер&shy;вое, что де&shy;ла&shy;ет код, ском&shy;пи&shy;ли&shy;ро&shy;ван&shy;ный JIT'ом: он сох&shy;ра&shy;ня&shy;ет па&shy;ра&shy;мет&shy;ры ме&shy;то&shy;да в стек (на&shy;чи&shy;ная с трет&shy;ьего). При этом пер&shy;вые два пе&shy;ре&shy;да&shy;ют&shy;ся че&shy;рез ре&shy;гис&shy;тры. Тут важ&shy;но пом&shy;нить, что пер&shy;вым па&shy;ра&shy;мет&shy;ром эк&shy;земп&shy;ляр&shy;ных ме&shy;то&shy;дов пе&shy;ре&shy;даётся ука&shy;за&shy;тель на тот объ&shy;ект, с ко&shy;то&shy;рым ра&shy;бо&shy;та&shy;ет ме&shy;тод. Т.е. ука&shy;за&shy;тель <code>this</code>. Так что в этих (поч&shy;ти всех) слу&shy;ча&shy;ях для ре&shy;гист&shy;ров ос&shy;таётся все&shy;го один па&shy;ра&shy;метр, а для всех ос&shy;таль&shy;ных - стек;</p>
</li>
<li>
<p >
Да&shy;лее ком&shy;пи&shy;ля&shy;тор ста&shy;вит инстр&shy;укцию вы&shy;зо&shy;ва ме&shy;то&shy;да <code>call</code>, ко&shy;то&shy;рая по&shy;ме&shy;ща&shy;ет в стек ад&shy;рес возв&shy;ра&shy;та из ме&shy;то&shy;да: ад&shy;рес сле&shy;ду&shy;ю&shy;щей за <code>call</code> инстр&shy;ук&shy;цией. Та&shy;ким об&shy;ра&shy;зом лю&shy;бой ме&shy;тод зна&shy;ет, ку&shy;да ему не&shy;об&shy;хо&shy;ди&shy;мо вер&shy;нуть&shy;ся, что&shy;бы вы&shy;зы&shy;ва&shy;ю&shy;щий код смог про&shy;дол&shy;жить ра&shy;бо&shy;ту;</p>
</li>
<li>
<p >
Пос&shy;ле то&shy;го как все па&shy;ра&shy;мет&shy;ры пе&shy;ре&shy;да&shy;ны, а ме&shy;тод выз&shy;ван, нам на&shy;до как-то по&shy;нять, как стек восс&shy;та&shy;но&shy;вить в слу&shy;чае вы&shy;хо&shy;да из ме&shy;то&shy;да, ес&shy;ли мы не хо&shy;тим за&shy;бо&shy;тить&shy;ся о подсчёте за&shy;ни&shy;ма&shy;е&shy;мых на&shy;ми в сте&shy;ке бай&shy;тов. Для это&shy;го мы сох&shy;ра&shy;ня&shy;ем зна&shy;че&shy;ние ре&shy;гис&shy;тра EBP, ко&shy;то&shy;рый всег&shy;да хра&shy;нит ука&shy;за&shy;тель на на&shy;ча&shy;ло те&shy;ку&shy;ще&shy;го кад&shy;ра сте&shy;ка (т.е. учас&shy;тка, где хра&shy;нит&shy;ся ин&shy;фор&shy;ма&shy;ция для конк&shy;рет&shy;но&shy;го выз&shy;ван&shy;но&shy;го ме&shy;то&shy;да). Сох&shy;ра&shy;няя при каж&shy;дом вы&shy;зо&shy;ве зна&shy;че&shy;ние это&shy;го ре&shy;гис&shy;тра, мы тем са&shy;мым фак&shy;ти&shy;чес&shy;ки соз&shy;даём од&shy;нос&shy;вяз&shy;ный спи&shy;сок сте&shy;ко&shy;вых кад&shy;ров. Но про&shy;шу за&shy;ме&shy;тить, что по фак&shy;ту они идут чётко друг за дру&shy;гом, без ка&shy;ких-ли&shy;бо про&shy;бе&shy;лов. Одна&shy;ко для уп&shy;ро&shy;ще&shy;ния ос&shy;во&shy;бож&shy;де&shy;ния па&shy;мя&shy;ти из-под кад&shy;ра и для от&shy;лад&shy;ки при&shy;ло&shy;же&shy;ния (от&shy;лад&shy;чик ис&shy;поль&shy;зу&shy;ет эти ука&shy;за&shy;те&shy;ли, что&shy;бы отоб&shy;ра&shy;зить Stack Trace) стр&shy;ои&shy;тся од&shy;нос&shy;вяз&shy;ный спи&shy;сок;</p>
</li>
<li>
<p >
Пос&shy;лед&shy;нее, что на&shy;до сде&shy;лать при вы&shy;зо&shy;ве ме&shy;то&shy;да, - вы&shy;де&shy;лить учас&shy;ток па&shy;мя&shy;ти под ло&shy;каль&shy;ные пе&shy;ре&shy;мен&shy;ные. Пос&shy;коль&shy;ку ком&shy;пи&shy;ля&shy;тор за&shy;ра&shy;нее зна&shy;ет, сколь&shy;ко её по&shy;на&shy;до&shy;бит&shy;ся, то де&shy;ла&shy;ет он это сра&shy;зу, сдви&shy;гая ука&shy;за&shy;тель на вер&shy;ши&shy;ну сте&shy;ка (SP/ESP/RSP) на не&shy;об&shy;хо&shy;ди&shy;мое ко&shy;ли&shy;чес&shy;тво байт;</p>
</li>
<li>
<p >
И на&shy;ко&shy;нец, на пя&shy;том эта&shy;пе вы&shy;пол&shy;ня&shy;ет&shy;ся код ме&shy;то&shy;да, по&shy;лез&shy;ные опе&shy;ра&shy;ции;</p>
</li>
<li>
<p >
Ког&shy;да про&shy;ис&shy;хо&shy;дит вы&shy;ход из ме&shy;то&shy;да, то вер&shy;ши&shy;на сте&shy;ка восс&shy;та&shy;нав&shy;ли&shy;ва&shy;ет&shy;ся из EBP - мес&shy;та, где хра&shy;нит&shy;ся на&shy;ча&shy;ло те&shy;ку&shy;ще&shy;го сте&shy;ко&shy;во&shy;го кад&shy;ра;</p>
</li>
<li>
<p >
Да&shy;лее, пос&shy;лед&shy;ним эта&shy;пом осу&shy;щес&shy;тв&shy;ляется вы&shy;ход из ме&shy;то&shy;да че&shy;рез инстр&shy;укцию <code>ret</code>. Она за&shy;би&shy;ра&shy;ет со сте&shy;ка ад&shy;рес возв&shy;ра&shy;та, за&shy;бот&shy;ли&shy;во ос&shy;тав&shy;лен&shy;ный ра&shy;нее инстр&shy;ук&shy;цией <code>call</code> и де&shy;ла&shy;ет <code>jmp</code> по это&shy;му ад&shy;ре&shy;су.</p>
</li>
</ol>
<p >
Те же са&shy;мые про&shy;цес&shy;сы мож&shy;но пос&shy;мот&shy;реть на изоб&shy;ра&shy;же&shy;нии:</p>
<p >
<img src="./imgs/ThreadStack/AnyMethodCall.png" alt="" /></p>
<div class="paragraph-container">
<div class="paragraph-left-side">03</div>
<p >
Так&shy;же за&shy;ме&shy;чу, что стек &laquo;растёт&raquo;, на&shy;чи&shy;ная со стар&shy;ших ад&shy;ре&shy;сов и за&shy;кан&shy;чи&shy;вая млад&shy;ши&shy;ми, т.е. в об&shy;рат&shy;ную сто&shy;ро&shy;ну.</p>
<div class="paragraph-right-side">03</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">04</div>
<p >
Гля&shy;дя на все это, не&shy;воль&shy;но при&shy;хо&shy;дишь к вы&shy;во&shy;ду, что ес&shy;ли не боль&shy;шинство, то ми&shy;ни&shy;мум по&shy;ло&shy;ви&shy;на всех опе&shy;ра&shy;ций, ко&shy;то&shy;ры&shy;ми за&shy;ни&shy;ма&shy;ет&shy;ся про&shy;цес&shy;сор - это об&shy;слу&shy;жи&shy;ва&shy;ние струк&shy;ту&shy;ры прог&shy;рам&shy;мы, а не её по&shy;лез&shy;ной наг&shy;руз&shy;ки. Т.е. об&shy;слу&shy;жи&shy;ва&shy;ние вы&shy;зо&shy;вов ме&shy;то&shy;дов, про&shy;вер&shy;ки ти&shy;пов на воз&shy;мож&shy;ность при&shy;вес&shy;ти один к дру&shy;го&shy;му, ком&shy;пи&shy;ля&shy;цию Generic ва&shy;ри&shy;а&shy;ций, по&shy;иск ме&shy;то&shy;дов в таб&shy;ли&shy;цах ин&shy;тер&shy;фей&shy;сов&hellip; Осо&shy;бен&shy;но ес&shy;ли мы вспом&shy;ним, что боль&shy;шинство сов&shy;ре&shy;мен&shy;но&shy;го ко&shy;да на&shy;пи&shy;са&shy;но с под&shy;хо&shy;дом ра&shy;бо&shy;ты че&shy;рез ин&shy;тер&shy;фей&shy;сы, раз&shy;бив&shy;ку на мно&shy;жес&shy;тво пусть ма&shy;лень&shy;ких, но вы&shy;пол&shy;ня&shy;ю&shy;щих каж&shy;дый - своё - ме&shy;то&shy;дов… А ра&shy;бо&shy;та при этом час&shy;то идёт с ба&shy;зо&shy;вы&shy;ми ти&shy;па&shy;ми и при&shy;ве&shy;де&shy;ни&shy;ем ти&shy;пов то к ин&shy;тер&shy;фей&shy;су, то к нас&shy;лед&shy;ни&shy;ку. При всех та&shy;ких вхо&shy;дя&shy;щих ус&shy;ло&shy;ви&shy;ях вы&shy;вод о рас&shy;то&shy;чи&shy;тель&shy;нос&shy;ти ин&shy;ф&shy;раст&shy;рук&shy;тур&shy;но&shy;го ко&shy;да впол&shy;не мо&shy;жет наз&shy;реть. Един&shy;ствен&shy;ное, что я мо&shy;гу вам на это все ска&shy;зать: ком&shy;пи&shy;ля&shy;то&shy;ры, в том чис&shy;ле и JIT, об&shy;ла&shy;да&shy;ют мно&shy;жест&shy;вом тех&shy;ник, поз&shy;во&shy;ля&shy;ю&shy;щим им де&shy;лать бо&shy;лее про&shy;дук&shy;тив&shy;ный код. Где мож&shy;но - вмес&shy;то вы&shy;зо&shy;ва ме&shy;то&shy;да встав&shy;ля&shy;ет&shy;ся его те&shy;ло це&shy;ли&shy;ком, а где воз&shy;мож&shy;но вмес&shy;то по&shy;ис&shy;ка ме&shy;то&shy;да в VSD ин&shy;тер&shy;фей&shy;са осу&shy;щес&shy;тв&shy;ляется его пря&shy;мой вы&shy;зов. Что са&shy;мое грус&shy;т&shy;ное, ин&shy;ф&shy;раст&shy;рук&shy;тур&shy;ную наг&shy;руз&shy;ку очень слож&shy;но за&shy;ме&shy;рить: на&shy;до что&shy;бы JITter ли&shy;бо ка&shy;кой-ли&shy;бо ком&shy;пи&shy;ля&shy;тор встав&shy;лял бы ка&shy;кие-то мет&shy;ри&shy;ки до и пос&shy;ле мест ра&shy;бо&shy;ты ин&shy;ф&shy;раст&shy;рук&shy;тур&shy;но&shy;го ко&shy;да. Т.е. до вы&shy;зо&shy;ва ме&shy;то&shy;да, а внут&shy;ри ме&shy;то&shy;да - пос&shy;ле ини&shy;ци&shy;а&shy;ли&shy;за&shy;ции кад&shy;ра сте&shy;ка. До вы&shy;хо&shy;да из ме&shy;то&shy;да, пос&shy;ле вы&shy;хо&shy;да из ме&shy;то&shy;да. До ком&shy;пи&shy;ля&shy;ции, пос&shy;ле ком&shy;пи&shy;ля&shy;ции. И так да&shy;лее. Одна&shy;ко, да&shy;вай&shy;те не бу&shy;дем о груст&shy;ном, а по&shy;го&shy;во&shy;рим луч&shy;ше о том, что мы мо&shy;жем с ва&shy;ми сде&shy;лать с по&shy;лу&shy;чен&shy;ной ин&shy;фор&shy;ма&shy;ци&shy;ей.</p>
<div class="paragraph-right-side">04</div>
</div>
<h2 id="x86-1">Немного про исключения на платформе x86</h2>
<div class="paragraph-container">
<div class="paragraph-left-side">05</div>
<p >
Если мы пос&shy;мот&shy;рим внутрь ко&shy;да ме&shy;то&shy;дов, то мы за&shy;ме&shy;тим ещё од&shy;ну струк&shy;ту&shy;ру, ра&shy;бо&shy;та&shy;ю&shy;щую со сте&shy;ком по&shy;то&shy;ка. По&shy;су&shy;ди&shy;те са&shy;ми:</p>
<div class="paragraph-right-side">05</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">void</span> Method1()
{
    <span style="color:Blue;">try</span>
    {
        Method2(123);
    } <span style="color:Blue;">catch</span> {
        <span style="color:Green;">// ...</span>
    }
}

<span style="color:Blue;">void</span> Method2(<span style="color:Blue;">int</span> arg)
{
    Method3();
}

<span style="color:Blue;">void</span> Method3()
{
    <span style="color:Blue;">try</span>
    {
        <span style="color:Green;">//...</span>
    } <span style="color:Blue;">catch</span> {
        <span style="color:Green;">//...</span>
    }
}
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">06</div>
<p >
Если ис&shy;клю&shy;че&shy;ние воз&shy;ник&shy;нет в лю&shy;бом из ме&shy;то&shy;дов, выз&shy;ван&shy;ных из <code>Method3</code>, то уп&shy;рав&shy;ле&shy;ние бу&shy;дет возв&shy;ра&shy;ще&shy;но в блок <code>catch</code> ме&shy;то&shy;да <code>Method3</code>. При этом ес&shy;ли ис&shy;клю&shy;че&shy;ние об&shy;ра&shy;бо&shy;та&shy;но не бу&shy;дет, то его об&shy;ра&shy;бот&shy;ка начнётся в ме&shy;то&shy;де <code>Method1</code>. Одна&shy;ко ес&shy;ли ни&shy;че&shy;го не слу&shy;чит&shy;ся, то <code>Method3</code> за&shy;вер&shy;шит свою ра&shy;бо&shy;ту, уп&shy;рав&shy;ле&shy;ние пе&shy;рейдёт в ме&shy;тод <code>Method2</code>, где так&shy;же мо&shy;жет воз&shy;ник&shy;нуть ис&shy;клю&shy;че&shy;ние. Одна&shy;ко по ес&shy;тест&shy;вен&shy;ным при&shy;чи&shy;нам об&shy;ра&shy;бо&shy;та&shy;но оно бу&shy;дет не в <code>Method3</code>, а в <code>Method1</code>. Воп&shy;рос та&shy;ко&shy;го удоб&shy;но&shy;го ав&shy;то&shy;ма&shy;тиз&shy;ма зак&shy;лю&shy;ча&shy;ет&shy;ся в том, что струк&shy;ту&shy;ры дан&shy;ных, об&shy;ра&shy;зу&shy;ю&shy;щие це&shy;поч&shy;ки об&shy;ра&shy;бот&shy;чи&shy;ков ис&shy;клю&shy;че&shy;ний, так&shy;же на&shy;хо&shy;дят&shy;ся в сте&shy;ко&shy;вом кад&shy;ре ме&shy;то&shy;да, где они объ&shy;яв&shy;ле&shy;ны. Про са&shy;ми ис&shy;клю&shy;че&shy;ния мы по&shy;го&shy;во&shy;рим от&shy;дель&shy;но, а здесь ска&shy;жу толь&shy;ко, что мо&shy;дель ис&shy;клю&shy;че&shy;ний в .NET Framework CLR и в Core CLR от&shy;ли&shy;ча&shy;ет&shy;ся. CoreCLR вы&shy;нуж&shy;де&shy;на быть раз&shy;ной на раз&shy;ных плат&shy;фор&shy;мах, а по&shy;то&shy;му мо&shy;дель ис&shy;клю&shy;че&shy;ний там дру&shy;гая и предс&shy;тав&shy;ля&shy;ет&shy;ся в за&shy;ви&shy;си&shy;мос&shy;ти от плат&shy;фор&shy;мы че&shy;рез прос&shy;лой&shy;ку PAL (Platform Adaption Layer) раз&shy;лич&shy;ны&shy;ми им&shy;пле&shy;мен&shy;та&shy;ци&shy;ями. Боль&shy;шо&shy;му .NET Framework CLR это не нуж&shy;но: он живёт в эко&shy;сис&shy;те&shy;ме плат&shy;фор&shy;мы Windows, в ко&shy;то&shy;рой есть уже мно&shy;го лет об&shy;ще&shy;из&shy;вест&shy;ный ме&shy;ха&shy;низм об&shy;ра&shy;бот&shy;ки ис&shy;клю&shy;че&shy;ний, ко&shy;то&shy;рый на&shy;зы&shy;ва&shy;ет&shy;ся SEH (Structured Exception Handling). Этот ме&shy;ха&shy;низм ис&shy;поль&shy;зу&shy;ет&shy;ся прак&shy;ти&shy;чес&shy;ки все&shy;ми язы&shy;ка&shy;ми прог&shy;рам&shy;ми&shy;ро&shy;ва&shy;ния (при ко&shy;неч&shy;ной ком&shy;пи&shy;ля&shy;ции), по&shy;то&shy;му что обес&shy;пе&shy;чи&shy;ва&shy;ет сквоз&shy;ную об&shy;ра&shy;бот&shy;ку ис&shy;клю&shy;че&shy;ний меж&shy;ду мо&shy;ду&shy;ля&shy;ми, на&shy;пи&shy;сан&shy;ны&shy;ми на раз&shy;лич&shy;ных язы&shy;ках прог&shy;рам&shy;ми&shy;ро&shy;ва&shy;ния. Ра&shy;бо&shy;та&shy;ет это при&shy;мер&shy;но так:</p>
<div class="paragraph-right-side">06</div>
</div>
<ol>
<li>
<p >
При вхож&shy;де&shy;нии в блок try на стек кладётся струк&shy;ту&shy;ра, ко&shy;то&shy;рая пер&shy;вым по&shy;лем ука&shy;зы&shy;ва&shy;ет на пре&shy;ды&shy;ду&shy;щий блок об&shy;ра&shy;бот&shy;ки ис&shy;клю&shy;че&shy;ний (нап&shy;ри&shy;мер, вы&shy;зы&shy;ва&shy;ю&shy;щий ме&shy;тод, у ко&shy;то&shy;ро&shy;го так&shy;же есть try-catch), тип бло&shy;ка, код ис&shy;клю&shy;че&shy;ния и ад&shy;рес об&shy;ра&shy;бот&shy;чи&shy;ка;</p>
</li>
<li>
<p >
В TEB по&shy;то&shy;ка (Thread Environment Block, по су&shy;ти - кон&shy;текст по&shy;то&shy;ка) ме&shy;ня&shy;ет&shy;ся ад&shy;рес те&shy;ку&shy;щей вер&shy;ши&shy;ны це&shy;поч&shy;ки об&shy;ра&shy;бот&shy;чи&shy;ков ис&shy;клю&shy;че&shy;ний на тот, что мы соз&shy;да&shy;ли. Та&shy;ким об&shy;ра&shy;зом, мы до&shy;ба&shy;ви&shy;ли в це&shy;поч&shy;ку наш блок.</p>
</li>
<li>
<p >
Ког&shy;да try за&shy;кон&shy;чил&shy;ся, про&shy;из&shy;во&shy;дит&shy;ся об&shy;рат&shy;ная опе&shy;ра&shy;ция: в TEB за&shy;пи&shy;сы&shy;ва&shy;ет&shy;ся ста&shy;рая вер&shy;ши&shy;на, сни&shy;мая та&shy;ким об&shy;ра&shy;зом наш об&shy;ра&shy;бот&shy;чик из це&shy;поч&shy;ки;</p>
</li>
<li>
<p >
Если воз&shy;ни&shy;ка&shy;ет ис&shy;клю&shy;че&shy;ние, то из TEB за&shy;би&shy;ра&shy;ет&shy;ся вер&shy;ши&shy;на и по оче&shy;ре&shy;ди по це&shy;поч&shy;ке вы&shy;зы&shy;ва&shy;ют&shy;ся об&shy;ра&shy;бот&shy;чи&shy;ки, ко&shy;то&shy;рые про&shy;ве&shy;ря&shy;ют, под&shy;хо&shy;дит ли ис&shy;клю&shy;че&shy;ние конк&shy;рет&shy;но им. Если да, вы&shy;пол&shy;ня&shy;ет&shy;ся блок об&shy;ра&shy;бот&shy;ки (нап&shy;ри&shy;мер, catch).</p>
</li>
<li>
<p >
В TEB восс&shy;та&shy;нав&shy;ли&shy;ва&shy;ет&shy;ся тот ад&shy;рес струк&shy;ту&shy;ры SEH, ко&shy;то&shy;рый на&shy;хо&shy;дит&shy;ся в сте&shy;ке ДО ме&shy;то&shy;да, об&shy;ра&shy;бо&shy;тав&shy;ше&shy;го ис&shy;клю&shy;че&shy;ние.</p>
</li>
</ol>
<p >
Как ви&shy;ди&shy;те, сов&shy;сем не слож&shy;но. Одна&shy;ко вся эта ин&shy;фор&shy;ма&shy;ция так&shy;же на&shy;хо&shy;дит&shy;ся в сте&shy;ке.</p>
<h2 id="x64-amd64-in-progress">Базовые сведения про платформы x64, AMD64 [In Progress]</h2>
<p >
TODO</p>
<h2 id="x64-amd64-in-progress-1">Исключения на платформах x64, AMD64 [In Progress]</h2>
<p >
TODO</p>
<h2 id="section-1">Совсем немного про несовершенство стека потока</h2>
<div class="paragraph-container">
<div class="paragraph-left-side">07</div>
<p >
Да&shy;вай&shy;те нем&shy;но&shy;го по&shy;ду&shy;ма&shy;ем о воп&shy;ро&shy;се бе&shy;зо&shy;пас&shy;нос&shy;ти и воз&shy;мож&shy;ных проб&shy;ле&shy;мах, ко&shy;то&shy;рые чис&shy;то те&shy;о&shy;ре&shy;ти&shy;чес&shy;ки мо&shy;гут воз&shy;ник&shy;нуть. Для это&shy;го да&shy;вай&shy;те ещё раз гля&shy;нем на струк&shy;ту&shy;ру сте&shy;ка по&shy;то&shy;ка, ко&shy;то&shy;рая по сво&shy;ей су&shy;ти - обыч&shy;ный мас&shy;сив. Ди&shy;а&shy;па&shy;зон па&shy;мя&shy;ти, в ко&shy;то&shy;ром стр&shy;оя&shy;тся фрей&shy;мы, ор&shy;га&shy;ни&shy;зо&shy;ван так, что он растёт с кон&shy;ца в на&shy;ча&shy;ло. Т.е. бо&shy;лее поз&shy;д&shy;ние фрей&shy;мы рас&shy;по&shy;ла&shy;га&shy;ют&shy;ся по бо&shy;лее ран&shy;ним ад&shy;ре&shy;сам. Так же, как уже бы&shy;ло ска&shy;за&shy;но, фрей&shy;мы свя&shy;за&shy;ны од&shy;нос&shy;вяз&shy;ным спис&shy;ком. Это сде&shy;ла&shy;но по&shy;то&shy;му, что раз&shy;мер фрей&shy;ма не яв&shy;ля&shy;ет&shy;ся фик&shy;си&shy;ро&shy;ван&shy;ным и дол&shy;жен быть &laquo;счи&shy;тан&raquo; лю&shy;бым от&shy;лад&shy;чи&shy;ком. Про&shy;цес&shy;сор при этом не разг&shy;ра&shy;ни&shy;чи&shy;ва&shy;ет фрей&shy;мы меж&shy;ду со&shy;бой: лю&shy;бой ме&shy;тод по сво&shy;ему же&shy;ла&shy;нию мо&shy;жет счи&shy;тать всю об&shy;ласть па&shy;мя&shy;ти це&shy;ли&shy;ком. А ес&shy;ли учесть при этом, что мы на&shy;хо&shy;дим&shy;ся в вир&shy;ту&shy;альной па&shy;мя&shy;ти, ко&shy;то&shy;рая по&shy;де&shy;ле&shy;на на учас&shy;тки, яв&shy;ля&shy;ю&shy;щи&shy;еся ре&shy;ально вы&shy;де&shy;лен&shy;ной па&shy;мятью, то мож&shy;но при по&shy;мо&shy;щи спе&shy;ци&shy;альной фун&shy;к&shy;ции WinAPI по лю&shy;бо&shy;му ад&shy;ре&shy;су со сте&shy;ка по&shy;лу&shy;чить ди&shy;а&shy;па&shy;зон вы&shy;де&shy;лен&shy;ной па&shy;мя&shy;ти, в ко&shy;то&shy;рой этот ад&shy;рес на&shy;хо&shy;дит&shy;ся. Ну а ра&shy;зоб&shy;рать од&shy;нос&shy;вяз&shy;ный спи&shy;сок - де&shy;ло тех&shy;ни&shy;ки:</p>
<div class="paragraph-right-side">07</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
    <span style="color:Green;">// переменная находится в стеке</span>
    <span style="color:Blue;">int</span> x;

    <span style="color:Green;">// Забрать информацию об участке памяти, выделенной под стек</span>
    MEMORY_BASIC_INFORMATION *stackData = <span style="color:Blue;">new</span> MEMORY_BASIC_INFORMATION();
    VirtualQuery((<span style="color:Blue;">void</span> *)&amp;x, stackData, <span style="color:Blue;">sizeof</span>(MEMORY_BASIC_INFORMATION));
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">08</div>
<p >
Это даёт нам воз&shy;мож&shy;ность по&shy;лу&shy;чить и мо&shy;ди&shy;фи&shy;ци&shy;ро&shy;вать все дан&shy;ные, ко&shy;то&shy;рые на&shy;хо&shy;дят&shy;ся в ка&shy;чес&shy;тве ло&shy;каль&shy;ных пе&shy;ре&shy;мен&shy;ных у ме&shy;то&shy;дов, ко&shy;то&shy;рые нас выз&shy;ва&shy;ли. Если при&shy;ло&shy;же&shy;ние ни&shy;как не нас&shy;тра&shy;и&shy;ва&shy;ет пе&shy;соч&shy;ни&shy;цу, в рам&shy;ках ко&shy;то&shy;рой вы&shy;зы&shy;ва&shy;ют&shy;ся сто&shy;рон&shy;ние биб&shy;ли&shy;о&shy;те&shy;ки, рас&shy;ши&shy;ря&shy;ю&shy;щие фун&shy;кци&shy;о&shy;нал при&shy;ло&shy;же&shy;ния, то сто&shy;рон&shy;няя биб&shy;ли&shy;о&shy;те&shy;ка смо&shy;жет ута&shy;щить дан&shy;ные, да&shy;же ес&shy;ли тот API, ко&shy;то&shy;рый вы ей от&shy;даёте, это&shy;го не пред&shy;по&shy;ла&shy;га&shy;ет. Ме&shy;то&shy;ди&shy;ка эта мо&shy;жет по&shy;ка&shy;зать&shy;ся вам на&shy;ду&shy;ман&shy;ной, од&shy;на&shy;ко в ми&shy;ре C/C++, где нет та&shy;кой прек&shy;рас&shy;ной ве&shy;щи как AppDomain с нас&shy;тро&shy;ен&shy;ны&shy;ми пра&shy;ва&shy;ми ата&shy;ка по сте&shy;ку - это са&shy;мое ти&shy;пич&shy;ное, что толь&shy;ко мож&shy;но встр&shy;етить из взло&shy;ма при&shy;ло&shy;же&shy;ний. Ма&shy;ло то&shy;го, мож&shy;но че&shy;рез реф&shy;лек&shy;сию пос&shy;мот&shy;реть на тип, ко&shy;то&shy;рый нам не&shy;об&shy;хо&shy;дим, пов&shy;то&shy;рить его струк&shy;ту&shy;ру у се&shy;бя, и, прой&shy;дя по ссыл&shy;ке со сте&shy;ка на объ&shy;ект, за&shy;ме&shy;нить ад&shy;рес VMT на наш, пе&shy;ре&shy;нап&shy;ра&shy;вив та&shy;ким об&shy;ра&shy;зом всю ра&shy;бо&shy;ту с конк&shy;рет&shy;ным эк&shy;земп&shy;ля&shy;ром к нам. SEH, кста&shy;ти го&shy;во&shy;ря, так&shy;же вов&shy;сю ис&shy;поль&shy;зу&shy;ет&shy;ся для взло&shy;ма при&shy;ло&shy;же&shy;ний. Че&shy;рез не&shy;го вы так&shy;же мо&shy;же&shy;те, ме&shy;няя ад&shy;рес об&shy;ра&shy;бот&shy;чи&shy;ка ис&shy;клю&shy;че&shy;ния, зас&shy;тав&shy;лять ОС вы&shy;пол&shy;нить вре&shy;до&shy;нос&shy;ный код. Но вы&shy;вод из все&shy;го это&shy;го очень прос&shy;той: всег&shy;да нас&shy;тра&shy;ивай&shy;те пе&shy;соч&shy;ни&shy;цу, ког&shy;да хо&shy;ти&shy;те ра&shy;бо&shy;тать с биб&shy;ли&shy;о&shy;те&shy;ка&shy;ми, рас&shy;ши&shy;ря&shy;ю&shy;щи&shy;ми фун&shy;кци&shy;о&shy;нал ва&shy;ше&shy;го при&shy;ло&shy;же&shy;ния. Я, ко&shy;неч&shy;но же, имею вви&shy;ду вся&shy;чес&shy;кие пла&shy;ги&shy;ны, ад&shy;до&shy;ны и про&shy;чие рас&shy;ши&shy;ре&shy;ния.</p>
<div class="paragraph-right-side">08</div>
</div>
<h2 id="section-2">Большой пример: клонирование потока на платформе х86</h2>
<div class="paragraph-container">
<div class="paragraph-left-side">09</div>
<p >
Что&shy;бы за&shy;пом&shy;нить все, что мы про&shy;чи&shy;та&shy;ли до мель&shy;чай&shy;ших под&shy;роб&shy;нос&shy;тей, на&shy;до зай&shy;ти к воп&shy;ро&shy;су ос&shy;ве&shy;ще&shy;ния ка&shy;кой-ли&shy;бо те&shy;мы с нес&shy;коль&shy;ких сто&shy;рон. Ка&shy;за&shy;лось бы, ка&shy;кой при&shy;мер мож&shy;но пос&shy;тро&shy;ить для сте&shy;ка по&shy;то&shy;ка? Выз&shy;вать ме&shy;тод из дру&shy;го&shy;го? Ма&shy;гия&hellip; Ко&shy;неч&shy;но же, нет: это мы де&shy;ла&shy;ем ежед&shy;нев&shy;но по мно&shy;го раз. Вмес&shy;то это&shy;го мы скло&shy;ни&shy;ру&shy;ем по&shy;ток ис&shy;пол&shy;не&shy;ния. Т.е. сде&shy;ла&shy;ем так, что&shy;бы пос&shy;ле вы&shy;зо&shy;ва оп&shy;ре&shy;делённо&shy;го ме&shy;то&shy;да у нас вмес&shy;то од&shy;но&shy;го по&shy;то&shy;ка ока&shy;за&shy;лось бы два: наш и но&shy;вый, но про&shy;дол&shy;жа&shy;ю&shy;щий вы&shy;пол&shy;нять код с точ&shy;ки вы&shy;зо&shy;ва ме&shy;то&shy;да кло&shy;ни&shy;ро&shy;ва&shy;ния так, как буд&shy;то он сам ту&shy;да дошёл. А выг&shy;ля&shy;деть это бу&shy;дет так:</p>
<div class="paragraph-right-side">09</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">void</span> MakeFork()
{
    <span style="color:Green;">// Для уверенности что все склонировалось мы делаем локальные переменные:</span>
    <span style="color:Green;">// В новом потоке их значения обязаны быть такими же как и в родительском</span>
    <span style="color:Blue;">var</span> sameLocalVariable = 123;
    <span style="color:Blue;">var</span> sync = <span style="color:Blue;">new</span> <span style="color:Blue;">object</span>();

    <span style="color:Green;">// Замеряем время</span>
    <span style="color:Blue;">var</span> stopwatch = Stopwatch.StartNew();

    <span style="color:Green;">// Клонируем поток</span>
    <span style="color:Blue;">var</span> forked = Fork.CloneThread();

    <span style="color:Green;">// С этой точки код исполняется двумя потоками.</span>
    <span style="color:Green;">// forked = true для дочернего потока, false для родительского</span>
    <span style="color:Blue;">lock</span>(sync)
    {
        Console.WriteLine(<span style="color:#A31515;">&quot;in {0} thread: {1}, local value: {2}, time to enter = {3} ms&quot;</span>,
            forked ? <span style="color:#A31515;">&quot;forked&quot;</span> : <span style="color:#A31515;">&quot;parent&quot;</span>,
            Thread.CurrentThread.ManagedThreadId,
            sameLocalVariable,
            stopwatch.ElapsedMilliseconds);
    }

    <span style="color:Green;">// При выходе из метода родительский вернёт управления в метод,</span>
    <span style="color:Green;">// который вызвал MakeFork(), т.е. продолжит работу как ни в чем ни бывало,</span>
    <span style="color:Green;">// а дочерний завершит исполнение.</span>
}

<span style="color:Green;">// Примерный вывод:</span>
<span style="color:Green;">// in forked thread: 2, local value: 123, time to enter = 2 ms</span>
<span style="color:Green;">// in parent thread: 1, local value: 123, time to enter = 2 ms</span>
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">10</div>
<p >
Сог&shy;ла&shy;си&shy;тесь, кон&shy;цепт ин&shy;те&shy;рес&shy;ный. Ко&shy;неч&shy;но же, тут мож&shy;но мно&shy;го спо&shy;рить про це&shy;ле&shy;со&shy;об&shy;раз&shy;ность та&shy;ких действий, но за&shy;да&shy;ча это&shy;го при&shy;ме&shy;ра - пос&shy;та&shy;вить жир&shy;ную точ&shy;ку в по&shy;ни&shy;ма&shy;нии ра&shy;бо&shy;ты этой струк&shy;ту&shy;ры дан&shy;ных. Как же сде&shy;лать кло&shy;ни&shy;ро&shy;ва&shy;ние? Для от&shy;ве&shy;та на дан&shy;ный воп&shy;рос на&shy;до от&shy;ве&shy;тить на дру&shy;гой воп&shy;рос: что во&shy;об&shy;ще оп&shy;ре&shy;де&shy;ля&shy;ет по&shy;ток? А по&shy;ток оп&shy;ре&shy;де&shy;ля&shy;ют сле&shy;ду&shy;ю&shy;щие струк&shy;ту&shy;ры и об&shy;лас&shy;ти дан&shy;ных:</p>
<div class="paragraph-right-side">10</div>
</div>
<ol>
<li>
<p >
На&shy;бор ре&shy;гист&shy;ров про&shy;цес&shy;со&shy;ра. Все ре&shy;гис&shy;тры оп&shy;ре&shy;де&shy;ля&shy;ют сос&shy;то&shy;я&shy;ние по&shy;то&shy;ка ис&shy;пол&shy;не&shy;ния инстр&shy;укций: от ад&shy;ре&shy;са те&shy;ку&shy;щей инстр&shy;укции ис&shy;пол&shy;не&shy;ния до ад&shy;ре&shy;сов сте&shy;ка по&shy;то&shy;ка и дан&shy;ных, ко&shy;то&shy;ры&shy;ми он опе&shy;ри&shy;ру&shy;ет;</p>
</li>
<li>
<p >
<a href="https://en.wikipedia.org/wiki/Win32_Thread_Information_Block">Thread Environment Block</a> или TIB/TEB, ко&shy;то&shy;рый хра&shy;нит сис&shy;тем&shy;ную ин&shy;фор&shy;ма&shy;цию по по&shy;то&shy;ку, вклю&shy;чая ад&shy;ре&shy;са об&shy;ра&shy;бот&shy;чи&shy;ков ис&shy;клю&shy;че&shy;ний;</p>
</li>
<li>
<p >
Стек по&shy;то&shy;ка, ад&shy;рес ко&shy;то&shy;ро&shy;го оп&shy;ре&shy;де&shy;ля&shy;ет&shy;ся ре&shy;гист&shy;ра&shy;ми SS:ESP;</p>
</li>
<li>
<p >
Плат&shy;фор&shy;мен&shy;ный кон&shy;текст по&shy;то&shy;ка, ко&shy;то&shy;рый со&shy;дер&shy;жит ло&shy;каль&shy;ные для по&shy;то&shy;ка дан&shy;ные (ссыл&shy;ка идёт из TIB)</p>
</li>
</ol>
<div class="paragraph-container">
<div class="paragraph-left-side">11</div>
<p >
Ну и на&shy;вер&shy;ня&shy;ка что-то ещё, о чем мы мо&shy;жем не знать. Да и знать нам все&shy;го для при&shy;ме&shy;ра нет ни&shy;ка&shy;кой на&shy;доб&shy;нос&shy;ти: в про&shy;мыш&shy;лен&shy;ное ис&shy;поль&shy;зо&shy;ва&shy;ние дан&shy;ный код не пойдёт, а ско&shy;рее бу&shy;дет слу&shy;жить нам от&shy;лич&shy;ным при&shy;ме&shy;ром, ко&shy;то&shy;рый по&shy;мо&shy;жет ра&shy;зоб&shy;рать&shy;ся в те&shy;ме. А по&shy;то&shy;му он не бу&shy;дет учи&shy;ты&shy;вать все&shy;го, а толь&shy;ко са&shy;мое ос&shy;нов&shy;ное. А для то&shy;го что&shy;бы он за&shy;ра&shy;бо&shy;тал в ба&shy;зо&shy;вом ви&shy;де, нам по&shy;на&shy;до&shy;бит&shy;ся ско&shy;пи&shy;ро&shy;вать в но&shy;вый по&shy;ток на&shy;бор ре&shy;гист&shy;ров (ис&shy;пра&shy;вив SS:ESP, т.к. стек бу&shy;дет но&shy;вым), а так&shy;же под&shy;ре&shy;дак&shy;ти&shy;ро&shy;вать сам стек, что&shy;бы он со&shy;дер&shy;жал ров&shy;но то что нам на&shy;до.</p>
<div class="paragraph-right-side">11</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">12</div>
<p >
Итак. Если стек по&shy;то&shy;ка оп&shy;ре&shy;де&shy;ля&shy;ет, по су&shy;ти, ка&shy;кие ме&shy;то&shy;ды бы&shy;ли выз&shy;ва&shy;ны и ка&shy;ки&shy;ми дан&shy;ны&shy;ми они опе&shy;ри&shy;ру&shy;ют, то по&shy;лу&shy;ча&shy;ет&shy;ся что по идее, ме&shy;няя эти струк&shy;ту&shy;ры, мож&shy;но по&shy;ме&shy;нять как ло&shy;каль&shy;ные пе&shy;ре&shy;мен&shy;ные ме&shy;то&shy;дов, так и вы&shy;ре&shy;зать из сте&shy;ка вы&shy;зов ка&shy;ко&shy;го-то ме&shy;то&shy;да, по&shy;ме&shy;нять ме&shy;тод на дру&shy;гой или же до&shy;ба&shy;вить в лю&shy;бое мес&shy;то це&shy;поч&shy;ки свой. Хо&shy;ро&shy;шо, с этим оп&shy;ре&shy;де&shy;ли&shy;лись. Те&shy;перь да&shy;вай&shy;те пос&shy;мот&shy;рим на не&shy;кий псев&shy;до&shy;код:</p>
<div class="paragraph-right-side">12</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">void</span> RootMethod()
{
    MakeFork();
}
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">13</div>
<p >
Ког&shy;да вы&shy;зо&shy;вет&shy;ся MakeFork(), что мы ожи&shy;да&shy;ем с точ&shy;ки зре&shy;ния стек трей&shy;сов? Что в ро&shy;ди&shy;т&shy;ельском по&shy;то&shy;ке все ос&shy;та&shy;нет&shy;ся без из&shy;ме&shy;не&shy;ний, а до&shy;чер&shy;ний бу&shy;дет взят из пу&shy;ла по&shy;то&shy;ков (для ско&shy;рос&shy;ти), в нем бу&shy;дет сы&shy;ми&shy;ти&shy;ро&shy;ван вы&shy;зов ме&shy;то&shy;да <code>MakeFork</code> вмес&shy;те с его ло&shy;каль&shy;ны&shy;ми пе&shy;ре&shy;мен&shy;ны&shy;ми, а код про&shy;дол&shy;жит вы&shy;пол&shy;не&shy;ние не с на&shy;ча&shy;ла ме&shy;то&shy;да, а с точ&shy;ки, сле&shy;ду&shy;ю&shy;щей пос&shy;ле вы&shy;зо&shy;ва <code>CloneThread</code>. Т.е. стек трейс в на&shy;ших фан&shy;та&shy;зи&shy;ях бу&shy;дет выг&shy;ля&shy;деть при&shy;мер&shy;но так:</p>
<div class="paragraph-right-side">13</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Green;">// Parent Thread</span>
RootMethod -&gt; MakeFork

<span style="color:Green;">// Child Thread</span>
ThreadPool -&gt; MakeFork
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">14</div>
<p >
Что у нас есть из&shy;на&shy;чаль&shy;но? Есть наш по&shy;ток. Так&shy;же есть воз&shy;мож&shy;ность соз&shy;дать но&shy;вый по&shy;ток ли&shy;бо зап&shy;ла&shy;ни&shy;ро&shy;вать за&shy;да&shy;чу в пул по&shy;то&shy;ков, вы&shy;пол&shy;нив там свой код. Так&shy;же мы по&shy;ни&shy;ма&shy;ем, что ин&shy;фор&shy;ма&shy;ция по вло&shy;жен&shy;ным вы&shy;зо&shy;вам хра&shy;нит&shy;ся в сте&shy;ке вы&shy;зо&shy;вов и что при же&shy;ла&shy;нии мы мо&shy;жем ею ма&shy;ни&shy;пу&shy;ли&shy;ро&shy;вать (нап&shy;ри&shy;мер, ис&shy;поль&shy;зуя C++/CLI). Причём, ес&shy;ли сле&shy;до&shy;вать сог&shy;ла&shy;ше&shy;ни&shy;ям и впи&shy;сать в вер&shy;хуш&shy;ку сте&shy;ка ад&shy;рес возв&shy;ра&shy;та для инстр&shy;укции ret, зна&shy;че&shy;ние ре&shy;гис&shy;тра EBP и вы&shy;де&shy;лить мес&shy;то под ло&shy;каль&shy;ные (ес&shy;ли не&shy;об&shy;хо&shy;ди&shy;мо), то мож&shy;но ими&shy;ти&shy;ро&shy;вать вы&shy;зов ме&shy;то&shy;да. Руч&shy;ную за&shy;пись в стек по&shy;то&shy;ка воз&shy;мож&shy;но сде&shy;лать из C#, од&shy;на&shy;ко нам по&shy;на&shy;до&shy;бят&shy;ся ре&shy;гис&shy;тры и их очень ак&shy;ку&shy;рат&shy;ное ис&shy;поль&shy;зо&shy;ва&shy;ние, а по&shy;то&shy;му без ухо&shy;да в C++ нам не обой&shy;тись. Тут к нам на по&shy;мощь впер&shy;вые в жиз&shy;ни (лич&shy;но у ме&shy;ня) при&shy;хо&shy;дит CLI/C++, ко&shy;то&shy;рый поз&shy;во&shy;ля&shy;ет пи&shy;сать сме&shy;шан&shy;ный код: часть инстр&shy;укций - на .NET, часть - на C++, а иног&shy;да да&shy;же ухо&shy;дить на уро&shy;вень ас&shy;семб&shy;ле&shy;ра. Имен&shy;но то, что нам на&shy;до.</p>
<div class="paragraph-right-side">14</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">15</div>
<p >
Итак, как бу&shy;дет выг&shy;ля&shy;деть стек по&shy;то&shy;ка, ког&shy;да наш код вы&shy;зо&shy;вет MakeFork, ко&shy;то&shy;рый вы&shy;зо&shy;вет CloneThread, ко&shy;то&shy;рый уйдёт в unmanaged мир CLI/C++ и вы&shy;зо&shy;вет ме&shy;тод кло&shy;ни&shy;ро&shy;ва&shy;ние (са&shy;му ре&shy;а&shy;ли&shy;за&shy;цию) - там? Да&shy;вай&shy;те пос&shy;мот&shy;рим на схе&shy;му (ещё раз на&shy;пом&shy;ню, что стек растёт от стар&shy;ших ад&shy;ре&shy;сов к млад&shy;шим. Спра&shy;ва на&shy;ле&shy;во):</p>
<div class="paragraph-right-side">15</div>
</div>
<p >
<img src="./imgs/ThreadStack/step1.png" alt="" /></p>
<div class="paragraph-container">
<div class="paragraph-left-side">16</div>
<p >
Ну а для то&shy;го что&shy;бы не та&shy;щить всю прос&shy;ты&shy;ню со схе&shy;мы на схе&shy;му, уп&shy;рос&shy;тим, от&shy;бро&shy;сив то, что нам не нуж&shy;но:</p>
<div class="paragraph-right-side">16</div>
</div>
<p >
<img src="./imgs/ThreadStack/step2.png" alt="" /></p>
<div class="paragraph-container">
<div class="paragraph-left-side">17</div>
<p >
Ког&shy;да мы соз&shy;да&shy;дим по&shy;ток ли&shy;бо возьмём го&shy;то&shy;вый из пу&shy;ла по&shy;то&shy;ков, в на&shy;шей схе&shy;ме по&shy;яв&shy;ля&shy;ет&shy;ся ещё один стек, по&shy;ка ещё ни&shy;чем не про&shy;и&shy;ни&shy;ци&shy;а&shy;ли&shy;зи&shy;ро&shy;ван&shy;ный:</p>
<div class="paragraph-right-side">17</div>
</div>
<p >
<img src="./imgs/ThreadStack/step3.png" alt="" /></p>
<div class="paragraph-container">
<div class="paragraph-left-side">18</div>
<p >
Те&shy;перь на&shy;ша за&shy;да&shy;ча - сы&shy;ми&shy;ти&shy;ро&shy;вать за&shy;пуск ме&shy;то&shy;да <code>Fork.CloneThread()</code> в но&shy;вом по&shy;то&shy;ке. Для это&shy;го мы дол&shy;жны в ко&shy;нец его сте&shy;ка по&shy;то&shy;ка до&shy;пи&shy;сать се&shy;рию кад&shy;ров: как буд&shy;то из де&shy;ле&shy;га&shy;та, пе&shy;ре&shy;дан&shy;но&shy;го ThreadPool'у был выз&shy;ван <code>Fork.CloneThread()</code>, из ко&shy;то&shy;ро&shy;го че&shy;рез врап&shy;пер C++ ко&shy;да managed обёрткой был выз&shy;ван CLI/C++ ме&shy;тод. Для это&shy;го мы прос&shy;то ско&shy;пи&shy;ру&shy;ем не&shy;об&shy;хо&shy;ди&shy;мый учас&shy;ток сте&shy;ка в мас&shy;сив (за&shy;ме&shy;чу, что со скло&shy;ни&shy;ро&shy;ван&shy;но&shy;го учас&shy;тка на ста&shy;рый &laquo;смот&shy;рят&raquo; ко&shy;пии ре&shy;гист&shy;ров EBP, обес&shy;пе&shy;чи&shy;ва&shy;ю&shy;щих пос&shy;тро&shy;е&shy;ние це&shy;поч&shy;ки кад&shy;ров):</p>
<div class="paragraph-right-side">18</div>
</div>
<p >
<img src="./imgs/ThreadStack/step4.png" alt="" /></p>
<div class="paragraph-container">
<div class="paragraph-left-side">19</div>
<p >
Да&shy;лее что&shy;бы обес&shy;пе&shy;чить це&shy;лост&shy;ность сте&shy;ка пос&shy;ле опе&shy;ра&shy;ции ко&shy;пи&shy;ро&shy;ва&shy;ния скло&shy;ни&shy;ро&shy;ван&shy;но&shy;го на пре&shy;ды&shy;ду&shy;щем ша&shy;ге учас&shy;тка, мы за&shy;ра&shy;нее расс&shy;чи&shy;ты&shy;ва&shy;ем, по ка&shy;ким ад&shy;ре&shy;сам бу&shy;дут на&shy;хо&shy;дить&shy;ся по&shy;ля <code>EBP</code> на но&shy;вом мес&shy;те, и сра&shy;зу же ис&shy;прав&shy;ля&shy;ем их, пря&shy;мо на ко&shy;пии:</p>
<div class="paragraph-right-side">19</div>
</div>
<p >
<img src="./imgs/ThreadStack/step5.png" alt="" /></p>
<div class="paragraph-container">
<div class="paragraph-left-side">20</div>
<p >
Пос&shy;лед&shy;ним ша&shy;гом, очень ак&shy;ку&shy;рат&shy;но, за&shy;д&shy;ействуя ми&shy;ни&shy;маль&shy;ное ко&shy;ли&shy;чес&shy;тво ре&shy;гист&shy;ров, ко&shy;пи&shy;ру&shy;ем наш мас&shy;сив в ко&shy;нец сте&shy;ка до&shy;чер&shy;не&shy;го по&shy;то&shy;ка, пос&shy;ле че&shy;го сдви&shy;га&shy;ем ре&shy;гис&shy;тры ESP и EBP на но&shy;вые мес&shy;та. С точ&shy;ки зре&shy;ния сте&shy;ка мы сы&shy;ми&shy;ти&shy;ро&shy;ва&shy;ли вы&shy;зов всех этих ме&shy;то&shy;дов:</p>
<div class="paragraph-right-side">20</div>
</div>
<p >
<img src="./imgs/ThreadStack/step6.png" alt="" /></p>
<div class="paragraph-container">
<div class="paragraph-left-side">21</div>
<p >
Но по&shy;ка не с точ&shy;ки зре&shy;ния ко&shy;да. С точ&shy;ки зре&shy;ния ко&shy;да нам на&shy;до по&shy;пасть в те ме&shy;то&shy;ды, ко&shy;то&shy;рые толь&shy;ко что соз&shy;да&shy;ли. Са&shy;мое прос&shy;тое - прос&shy;то сы&shy;ми&shy;ти&shy;ро&shy;вать вы&shy;ход из ме&shy;то&shy;да: восс&shy;та&shy;но&shy;вить <code>ESP</code> до <code>EBP</code>, в <code>EBP</code> по&shy;ло&shy;жить то, на что он ука&shy;зы&shy;ва&shy;ет и выз&shy;вать инстр&shy;укцию <code>ret</code>, ини&shy;ци&shy;и&shy;ро&shy;вав вы&shy;ход из яко&shy;бы выз&shy;ван&shy;но&shy;го C++ ме&shy;то&shy;да кло&shy;ни&shy;ро&shy;ва&shy;ния по&shy;то&shy;ка, что при&shy;ведёт к возв&shy;ра&shy;ту в ре&shy;альный wrapper CLI/C++ вы&shy;зо&shy;ва, ко&shy;то&shy;рый вернёт уп&shy;рав&shy;ле&shy;ние в <code>MakeFork()</code>, но в до&shy;чер&shy;нем по&shy;то&shy;ке. Тех&shy;ни&shy;ка сра&shy;бо&shy;та&shy;ла.</p>
<div class="paragraph-right-side">21</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">22</div>
<p >
Те&shy;перь да&shy;вай&shy;те взгл&shy;янем на код. Пер&shy;вое что мы сде&shy;ла&shy;ем - это воз&shy;мож&shy;ность для CLI/C++ ко&shy;да соз&shy;дать .NET по&shy;ток. Для это&shy;го мы его дол&shy;жны соз&shy;дать в .NET:</p>
<div class="paragraph-right-side">22</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">extern</span> <span style="color:#A31515;">&quot;C&quot;</span> __declspec(dllexport)
<span style="color:Blue;">void</span> __stdcall MakeManagedThread(AdvancedThreading_Unmanaged *helper, StackInfo *stackCopy)
{
    AdvancedThreading::Fork::MakeThread(helper, stackCopy);
}
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">23</div>
<p >
На ти&shy;пы па&shy;ра&shy;мет&shy;ров по&shy;ка не об&shy;ра&shy;щай&shy;те вни&shy;ма&shy;ния. Они нуж&shy;ны для пе&shy;ре&shy;да&shy;чи ин&shy;фор&shy;ма&shy;ции о том, ка&shy;кой учас&shy;ток сте&shy;ка не&shy;об&shy;хо&shy;ди&shy;мо у се&shy;бя ри&shy;со&shy;вать из ро&shy;ди&shy;тел&shy;ьского по&shy;то&shy;ка в до&shy;чер&shy;ний. Ме&shy;тод соз&shy;да&shy;ния по&shy;то&shy;ка обо&shy;ра&shy;чи&shy;ва&shy;ет в де&shy;ле&shy;гат вы&shy;зов unmanaged ме&shy;то&shy;да, пе&shy;ре&shy;даёт дан&shy;ные и ста&shy;вит де&shy;ле&shy;гат в оче&shy;редь на об&shy;ра&shy;бот&shy;ку пу&shy;лом по&shy;то&shy;ков.</p>
<div class="paragraph-right-side">23</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
[MethodImpl(MethodImplOptions::NoInlining | MethodImplOptions::NoOptimization | MethodImplOptions::PreserveSig)]
<span style="color:Blue;">static</span> <span style="color:Blue;">void</span> MakeThread(AdvancedThreading_Unmanaged *helper, StackInfo *stackCopy)
{
    ForkData^ data = gcnew ForkData();
    data-&gt;helper = helper;
    data-&gt;info = stackCopy;

    ThreadPool::QueueUserWorkItem(gcnew WaitCallback(&amp;InForkedThread), data);
}

[MethodImpl(MethodImplOptions::NoInlining | MethodImplOptions::NoOptimization | MethodImplOptions::PreserveSig)]
<span style="color:Blue;">static</span> <span style="color:Blue;">void</span> InForkedThread(Object^ state)
{
    ForkData^ data = (ForkData^)state;
    data-&gt;helper-&gt;InForkedThread(data-&gt;info);
}
</pre></div>
</div>
<p >
И, на&shy;ко&shy;нец, сам ме&shy;тод кло&shy;ни&shy;ро&shy;ва&shy;ния (вер&shy;нее, его .NET часть):</p>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
[MethodImpl(MethodImplOptions::NoInlining | MethodImplOptions::NoOptimization | MethodImplOptions::PreserveSig)]
<span style="color:Blue;">static</span> <span style="color:Blue;">bool</span> CloneThread()
{
    ManualResetEvent^ resetEvent = gcnew ManualResetEvent(<span style="color:Blue;">false</span>);
    AdvancedThreading_Unmanaged *helper = <span style="color:Blue;">new</span> AdvancedThreading_Unmanaged();
    <span style="color:Blue;">int</span> somevalue;

    <span style="color:Green;">// *</span>
    helper-&gt;stacktop = (<span style="color:Blue;">int</span>)(<span style="color:Blue;">int</span> *)&amp;somevalue;
    <span style="color:Blue;">int</span> forked = helper-&gt;ForkImpl();
    <span style="color:Blue;">if</span> (!forked)
    {
        resetEvent-&gt;WaitOne();
    }
    <span style="color:Blue;">else</span>
    {
        resetEvent-&gt;Set();
    }
    <span style="color:Blue;">return</span> forked;
}
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">24</div>
<p >
Что&shy;бы по&shy;ни&shy;мать, где в це&shy;поч&shy;ке кад&shy;ров сте&shy;ка на&shy;хо&shy;дит&shy;ся дан&shy;ный ме&shy;тод, мы сох&shy;ра&shy;ня&shy;ем се&shy;бе ад&shy;рес сте&shy;ко&shy;вой пе&shy;ре&shy;мен&shy;ной (*). Испол&shy;ьз&shy;овать этот ад&shy;рес мы бу&shy;дем в ме&shy;то&shy;де кло&shy;ни&shy;ро&shy;ва&shy;ния, речь о ко&shy;то&shy;ром пойдёт чуть ни&shy;же. Так&shy;же, что&shy;бы вы по&shy;ни&shy;ма&shy;ли, о чем идёт речь, при&shy;ве&shy;ду код струк&shy;ту&shy;ры, не&shy;об&shy;хо&shy;ди&shy;мой для хра&shy;не&shy;ния ин&shy;фор&shy;ма&shy;ции о ко&shy;пии сте&shy;ка:</p>
<div class="paragraph-right-side">24</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">public</span> <span style="color:Blue;">class</span> StackInfo
{
<span style="color:Blue;">public</span>:
    <span style="color:Green;">// Копия значений регистров</span>
    <span style="color:Blue;">int</span> EAX, EBX, ECX, EDX;
    <span style="color:Blue;">int</span> EDI, ESI;
    <span style="color:Blue;">int</span> ESP;
    <span style="color:Blue;">int</span> EBP;
    <span style="color:Blue;">int</span> EIP;
    <span style="color:Blue;">short</span> CS;

    <span style="color:Green;">// Адрес копии стека</span>
    <span style="color:Blue;">void</span> *frame;

    <span style="color:Green;">// Размер копии</span>
    <span style="color:Blue;">int</span> size;

    <span style="color:Green;">// Диапазоны адресов оригинального стека нужны,</span>
    <span style="color:Green;">// чтобы поправить адреса на стеке если они есть на новые</span>
    <span style="color:Blue;">int</span> origStackStart, origStackSize;
};
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">25</div>
<p >
Ра&shy;бо&shy;та же са&shy;мо&shy;го ал&shy;го&shy;рит&shy;ма раз&shy;де&shy;ле&shy;на на две час&shy;ти: в ро&shy;ди&shy;т&shy;ельском по&shy;то&shy;ке мы под&shy;го&shy;тав&shy;ли&shy;ва&shy;ем дан&shy;ные для то&shy;го, что&shy;бы в до&shy;чер&shy;нем по&shy;то&shy;ке от&shy;ри&shy;со&shy;вать нуж&shy;ные кад&shy;ры сте&shy;ка. Вто&shy;рым же эта&shy;пом восс&shy;та&shy;нав&shy;ли&shy;ва&shy;ют&shy;ся дан&shy;ные в до&shy;чер&shy;нем по&shy;то&shy;ке, нак&shy;ла&shy;ды&shy;ва&shy;ясь на свой собст&shy;венный стек по&shy;то&shy;ка ис&shy;пол&shy;не&shy;ния, ими&shy;ти&shy;руя, та&shy;ким об&shy;ра&shy;зом, вы&shy;зо&shy;вы ме&shy;то&shy;дов, ко&shy;то&shy;рые в ре&shy;аль&shy;ности выз&shy;ва&shy;ны не бы&shy;ли.</p>
<div class="paragraph-right-side">25</div>
</div>
<h3 id="section-3">Метод подготовки к копированию</h3>
<div class="paragraph-container">
<div class="paragraph-left-side">26</div>
<p >
Опи&shy;са&shy;ние ко&shy;да я бу&shy;ду де&shy;лать бло&shy;ка&shy;ми. Т.е. еди&shy;ный код бу&shy;дет раз&shy;бит на час&shy;ти, и каж&shy;дая из час&shy;тей бу&shy;дет от&shy;дель&shy;но про&shy;ком&shy;мен&shy;ти&shy;ро&shy;ва&shy;на. Итак, прис&shy;ту&shy;пим. Ког&shy;да внеш&shy;ний код вы&shy;зы&shy;ва&shy;ет <code>Fork.CloneThread()</code>, то че&shy;рез внут&shy;рен&shy;нюю обёртку над не&shy;уп&shy;рав&shy;ля&shy;е&shy;мым ко&shy;дом и че&shy;рез ряд до&shy;пол&shy;ни&shy;тель&shy;ных ме&shy;то&shy;дов, ес&shy;ли код ра&shy;бо&shy;та&shy;ет под от&shy;лад&shy;кой (так на&shy;зы&shy;ва&shy;е&shy;мые debugger assistants). Имен&shy;но по&shy;э&shy;то&shy;му мы в .NET час&shy;ти за&shy;пом&shy;ни&shy;ли ад&shy;рес пе&shy;ре&shy;мен&shy;ной в сте&shy;ке: для C++ ме&shy;то&shy;да этот ад&shy;рес яв&shy;ля&shy;ет&shy;ся сво&shy;еоб&shy;разной мет&shy;кой: те&shy;перь мы точ&shy;но зна&shy;ем, ка&shy;кой учас&shy;ток сте&shy;ка мы мо&shy;жем спо&shy;кой&shy;но ко&shy;пи&shy;ро&shy;вать.</p>
<div class="paragraph-right-side">26</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">int</span> AdvancedThreading_Unmanaged::ForkImpl()
{
    StackInfo copy;
    StackInfo* info;
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">27</div>
<p >
Пер&shy;вым де&shy;лом, до то&shy;го как про&shy;и&shy;зойдёт хоть ка&shy;кая-то опе&shy;ра&shy;ция, что&shy;бы не по&shy;лу&shy;чить за&shy;пор&shy;чен&shy;ные ре&shy;гис&shy;тры, мы их ко&shy;пи&shy;ру&shy;ем ло&shy;каль&shy;но. Так&shy;же до&shy;пол&shy;ни&shy;тель&shy;но не&shy;об&shy;хо&shy;ди&shy;мо сох&shy;ра&shy;нить ад&shy;рес ко&shy;да, ку&shy;да бу&shy;дет сде&shy;лан <code>goto</code>, ког&shy;да в до&shy;чер&shy;нем по&shy;то&shy;ке стек бу&shy;дет сы&shy;ми&shy;ти&shy;ро&shy;ван, и не&shy;об&shy;хо&shy;ди&shy;мо бу&shy;дет про&shy;из&shy;вес&shy;ти про&shy;це&shy;ру&shy;ду вы&shy;хо&shy;да из <code>CloneThread</code> из до&shy;чер&shy;не&shy;го по&shy;то&shy;ка. В ка&shy;чес&shy;тве &laquo;точ&shy;ки вы&shy;хо&shy;да&raquo; мы вы&shy;би&shy;ра&shy;ем <code>JmpPointOnMethodsChainCallEmulation</code> и не прос&shy;то так: пос&shy;ле опе&shy;ра&shy;ции сох&shy;ра&shy;не&shy;ния это&shy;го ад&shy;ре&shy;са &laquo;на бу&shy;ду&shy;щее&raquo; мы до&shy;пол&shy;ни&shy;тель&shy;но зак&shy;ла&shy;ды&shy;ва&shy;ем в стек чис&shy;ло 0.</p>
<div class="paragraph-right-side">27</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
    <span style="color:Green;">// Save ALL registers</span>
    _asm
    {
        mov copy.EAX, EAX
        mov copy.EBX, EBX
        mov copy.ECX, ECX
        mov copy.EDX, EBX
        mov copy.EDI, EDI
        mov copy.ESI, ESI
        mov copy.EBP, EBP
        mov copy.ESP, ESP

        <span style="color:Green;">// Save CS:EIP for far jmp</span>
        mov copy.CS, CS
        mov copy.EIP, offset JmpPointOnMethodsChainCallEmulation

        <span style="color:Green;">// Save mark for this method, from what place it was called</span>
        push 0
    }
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">28</div>
<p >
Пос&shy;ле че&shy;го, пос&shy;ле <code>JmpPointOnMethodsChainCallEmulation</code> мы дос&shy;таём это чис&shy;ло из сте&shy;ка и про&shy;ве&shy;ря&shy;ем: там ле&shy;жит <code>0</code>? Если да, мы на&shy;хо&shy;дим&shy;ся в том же са&shy;мом по&shy;то&shy;ке: а зна&shy;чит у нас ещё мно&shy;го дел, и мы пе&shy;ре&shy;хо&shy;дим на <code>NonClonned</code>. Если же там не <code>0</code>, а по фак&shy;ту <code>1</code>, это зна&shy;чит, что до&shy;чер&shy;ний по&shy;ток за&shy;кон&shy;чил &laquo;до&shy;ри&shy;сов&shy;ку&raquo; сте&shy;ка по&shy;то&shy;ка до не&shy;об&shy;хо&shy;ди&shy;мо&shy;го сос&shy;то&shy;я&shy;ния, по&shy;ло&shy;жил на стек чис&shy;ло <code>1</code> и сде&shy;лал goto в эту точ&shy;ку (за&shy;ме&shy;чу, что goto он де&shy;ла&shy;ет из дру&shy;го&shy;го ме&shy;то&shy;да). А это зна&shy;чит, что нас&shy;та&shy;ло вре&shy;мя для вы&shy;хо&shy;да из <code>CloneThread</code> в до&shy;чер&shy;нем по&shy;то&shy;ке, вы&shy;зов ко&shy;то&shy;ро&shy;го был сы&shy;ми&shy;ти&shy;ро&shy;ван.</p>
<div class="paragraph-right-side">28</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
JmpPointOnMethodsChainCallEmulation:

    _asm
    {
        pop EAX
        cmp EAX, 0
        je NonClonned

        pop EBP
        mov EAX, 1
        ret
    }
NonClonned:
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">29</div>
<p >
Хо&shy;ро&shy;шо, мы убе&shy;ди&shy;лись, что мы все ещё мы, а зна&shy;чит на&shy;до под&shy;го&shy;то&shy;вить дан&shy;ные для до&shy;чер&shy;не&shy;го по&shy;то&shy;ка. Что&shy;бы бо&shy;лее не спус&shy;кать&shy;ся на уро&shy;вень ас&shy;семб&shy;ле&shy;ра, ра&shy;бо&shy;тать мы бу&shy;дем со струк&shy;ту&shy;рой ра&shy;нее сох&shy;ранённых ре&shy;гист&shy;ров. Дос&shy;та&shy;нем из неё зна&shy;че&shy;ние ре&shy;гис&shy;тра EBP: он по су&shy;ти яв&shy;ля&shy;ет&shy;ся по&shy;лем &laquo;Next&raquo; в од&shy;нос&shy;вяз&shy;ном спис&shy;ке кар&shy;дов сте&shy;ка. Пе&shy;рей&shy;дя по ад&shy;ре&shy;су, ко&shy;то&shy;рый там со&shy;дер&shy;жит&shy;ся, мы очу&shy;тим&shy;ся в кад&shy;ре ме&shy;то&shy;да, ко&shy;то&shy;рый нас выз&shy;вал. Если и там возьмём пер&shy;вое по&shy;ле и пе&shy;рейдём по то&shy;му ад&shy;ре&shy;су, то ока&shy;жем&shy;ся в ещё бо&shy;лее ран&shy;нем кад&shy;ре. Так мы смо&shy;жем дой&shy;ти до managed час&shy;ти <code>CloneThread</code>: ведь мы сох&shy;ра&shy;ни&shy;ли ад&shy;рес пе&shy;ре&shy;мен&shy;ной в её сте&shy;ко&shy;вом кад&shy;ре, а зна&shy;чит, прек&shy;рас&shy;но зна&shy;ем, где ос&shy;та&shy;но&shy;вить&shy;ся. Этой за&shy;да&shy;чей и за&shy;ни&shy;ма&shy;ет&shy;ся цикл, при&shy;ведённый ни&shy;же.</p>
<div class="paragraph-right-side">29</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
    <span style="color:Blue;">int</span> *curptr = (<span style="color:Blue;">int</span> *)copy.EBP;
    <span style="color:Blue;">int</span> frames = 0;

    <span style="color:Green;">//</span>
    <span style="color:Green;">//  Calculate frames count between current call and Fork.CloneTherad() call</span>
    <span style="color:Green;">//</span>
    <span style="color:Blue;">while</span> ((<span style="color:Blue;">int</span>)curptr &lt; stacktop)
    {
        curptr = (<span style="color:Blue;">int</span>*)*curptr;
        frames++;
    }
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">30</div>
<p >
По&shy;лу&shy;чив ад&shy;рес на&shy;ча&shy;ла кад&shy;ра managed ме&shy;то&shy;да <code>CloneThread</code>, мы те&shy;перь зна&shy;ем, сколь&shy;ко на&shy;до ко&shy;пи&shy;ро&shy;вать для ими&shy;та&shy;ции вы&shy;зо&shy;ва <code>CloneThread</code> из <code>MakeFork</code>. Одна&shy;ко пос&shy;коль&shy;ку нам <code>MakeFork</code> так&shy;же ну&shy;жен (на&shy;ша за&shy;да&shy;ча вый&shy;ти имен&shy;но в не&shy;го), то мы де&shy;ла&shy;ем до&shy;пол&shy;ни&shy;тель&shy;но ещё один пе&shy;ре&shy;ход по од&shy;нос&shy;вяз&shy;но&shy;му спис&shy;ку: <code>*(int *)curptr</code>. Пос&shy;ле че&shy;го соз&shy;даём мас&shy;сив под сох&shy;ра&shy;не&shy;ние сте&shy;ка и сох&shy;ра&shy;ня&shy;ем его прос&shy;тым ко&shy;пи&shy;ро&shy;ва&shy;ни&shy;ем.</p>
<div class="paragraph-right-side">30</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
    <span style="color:Green;">//</span>
    <span style="color:Green;">//  We need to copy stack part from our method to user code method including its locals in stack</span>
    <span style="color:Green;">//</span>
    <span style="color:Blue;">int</span> localsStart = copy.EBP;                             <span style="color:Green;">// our EBP points to EBP value for parent method + saved ESI, EDI</span>
    <span style="color:Blue;">int</span> localsEnd = *(<span style="color:Blue;">int</span> *)curptr;                         <span style="color:Green;">// points to end of user&#39;s method&#39;s locals (additional leave)</span>

    <span style="color:Blue;">byte</span> *arr = <span style="color:Blue;">new</span> <span style="color:Blue;">byte</span>[localsEnd - localsStart];
    memcpy(arr, (<span style="color:Blue;">void</span>*)localsStart, localsEnd - localsStart);
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">31</div>
<p >
Ещё од&shy;на за&shy;да&shy;ча, ко&shy;то&shy;рую на&shy;до бу&shy;дет ре&shy;шить, - это ис&shy;прав&shy;ле&shy;ние ад&shy;ре&shy;сов пе&shy;ре&shy;мен&shy;ных, ко&shy;то&shy;рые по&shy;па&shy;ли на стек и при этом ука&shy;зы&shy;ва&shy;ю&shy;щих на стек. Для ре&shy;ше&shy;ния этой проб&shy;ле&shy;мы мы по&shy;лу&shy;ча&shy;ем ди&shy;а&shy;па&shy;зон ад&shy;ре&shy;сов, ко&shy;то&shy;рые нам вы&shy;де&shy;ли&shy;ла опе&shy;ра&shy;ци&shy;он&shy;ная сис&shy;те&shy;ма под стек по&shy;то&shy;ка. Сох&shy;ра&shy;ня&shy;ем по&shy;лу&shy;чен&shy;ную ин&shy;фор&shy;ма&shy;цию и за&shy;пу&shy;ка&shy;ем вто&shy;рую часть про&shy;цес&shy;са кло&shy;ни&shy;ро&shy;ва&shy;ния, зап&shy;ла&shy;ни&shy;ро&shy;вав де&shy;ле&shy;гат в пул по&shy;то&shy;ков:</p>
<div class="paragraph-right-side">31</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
    <span style="color:Green;">// Get information about stack pages</span>
    MEMORY_BASIC_INFORMATION *stackData = <span style="color:Blue;">new</span> MEMORY_BASIC_INFORMATION();
    VirtualQuery((<span style="color:Blue;">void</span> *)copy.EBP, stackData, <span style="color:Blue;">sizeof</span>(MEMORY_BASIC_INFORMATION));

    <span style="color:Green;">// fill StackInfo structure</span>
    info = <span style="color:Blue;">new</span> StackInfo(copy);
    info-&gt;origStackStart = (<span style="color:Blue;">int</span>)stackData-&gt;BaseAddress;
    info-&gt;origStackSize = (<span style="color:Blue;">int</span>)stackData-&gt;RegionSize;
    info-&gt;frame = arr;
    info-&gt;size = (localsEnd - localsStart);

    <span style="color:Green;">// call managed ThreadPool.QueueUserWorkitem to make fork</span>
    MakeManagedThread(<span style="color:Blue;">this</span>, info);

    <span style="color:Blue;">return</span> 0;
}
</pre></div>
</div>
<h3 id="section-4">Метод восстановления из копии</h3>
<div class="paragraph-container">
<div class="paragraph-left-side">32</div>
<p >
Этот ме&shy;тод вы&shy;зы&shy;ва&shy;ет&shy;ся как ре&shy;зуль&shy;тат ра&shy;бо&shy;ты пре&shy;ды&shy;ду&shy;ще&shy;го: нам пе&shy;ре&shy;да&shy;ны ко&shy;пия учас&shy;тка сте&shy;ка ро&shy;ди&shy;тел&shy;ьского по&shy;то&shy;ка, а так&shy;же пол&shy;ный на&shy;бор его ре&shy;гист&shy;ров. На&shy;ша за&shy;да&shy;ча в на&shy;шем по&shy;то&shy;ке, взя&shy;том из пу&shy;ла по&shy;то&shy;ков, до&shy;ри&shy;со&shy;вать все вы&shy;зо&shy;вы, ско&shy;пи&shy;ро&shy;ван&shy;ные из ро&shy;ди&shy;тел&shy;ьского по&shy;то&shy;ка та&shy;ким об&shy;ра&shy;зом, как буд&shy;то мы са&shy;ми их осу&shy;щест&shy;ви&shy;ли. За&shy;вер&shy;шив ра&shy;бо&shy;ту, MakeFork до&shy;чер&shy;не&shy;го по&shy;то&shy;ка по&shy;падёт об&shy;рат&shy;но в этот ме&shy;тод, ко&shy;то&shy;рый, за&shy;вер&shy;шив ра&shy;бо&shy;ту, ос&shy;во&shy;бо&shy;дит по&shy;ток и вернёт его в пул по&shy;то&shy;ков.</p>
<div class="paragraph-right-side">32</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">void</span> AdvancedThreading_Unmanaged::InForkedThread(StackInfo * stackCopy)
{
    StackInfo copy;
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">33</div>
<p >
Пер&shy;вым де&shy;лом мы сох&shy;ра&shy;ня&shy;ем зна&shy;че&shy;ния ра&shy;бо&shy;чих ре&shy;гист&shy;ров, что&shy;бы, ког&shy;да <code>MakeFork</code> за&shy;вер&shy;шит свою ра&shy;бо&shy;ту, мы смог&shy;ли их без&shy;бо&shy;лез&shy;нен&shy;но восс&shy;тав&shy;но&shy;вить. Что&shy;бы в даль&shy;ней&shy;шем ми&shy;ни&shy;маль&shy;но вли&shy;ять на ре&shy;гис&shy;тры, мы выг&shy;ру&shy;жа&shy;ем пе&shy;ре&shy;дан&shy;ные нам па&shy;ра&shy;мет&shy;ры к се&shy;бе на стек. Дос&shy;туп к ним бу&shy;дет ид&shy;ти толь&shy;ко че&shy;рез <code>SS:ESP</code>, что для нас бу&shy;дет предс&shy;ка&shy;зу&shy;е&shy;мым.</p>
<div class="paragraph-right-side">33</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
    <span style="color:Blue;">short</span> CS_EIP[3];

    <span style="color:Green;">// Save original registers to restore</span>
    __asm pushad

    <span style="color:Green;">// safe copy w-out changing registers</span>
    <span style="color:Blue;">for</span>(<span style="color:Blue;">int</span> i = 0; i &lt; <span style="color:Blue;">sizeof</span>(StackInfo); i++)
        ((<span style="color:Blue;">byte</span> *)&amp;copy)[i] = ((<span style="color:Blue;">byte</span> *)stackCopy)[i];

    <span style="color:Green;">// Setup FWORD for far jmp</span>
    *(<span style="color:Blue;">int</span>*)CS_EIP = copy.EIP;
    CS_EIP[2] = copy.CS;
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">34</div>
<p >
На&shy;ша сле&shy;ду&shy;ю&shy;щая за&shy;да&shy;ча - это ис&shy;пра&shy;вить в ко&shy;пии сте&shy;ка зна&shy;че&shy;ния <code>EBP</code>, ко&shy;то&shy;рые об&shy;ра&shy;зу&shy;ют од&shy;нос&shy;вяз&shy;ный спи&shy;сок кад&shy;ров на их бу&shy;ду&shy;щие но&shy;вые по&shy;ло&shy;же&shy;ния. Для это&shy;го мы расс&shy;чи&shy;ты&shy;ва&shy;ем дель&shy;ту меж&shy;ду ад&shy;ре&shy;сом на&shy;ше&shy;го сте&shy;ка по&shy;то&shy;ка и ро&shy;ди&shy;тел&shy;ьского сте&shy;ка по&shy;то&shy;ка, дель&shy;ту меж&shy;ду ко&shy;пи&shy;ей ди&shy;а&shy;па&shy;зо&shy;на сте&shy;ка ро&shy;ди&shy;тел&shy;ьского по&shy;то&shy;ка и са&shy;мим ро&shy;ди&shy;т&shy;ельским по&shy;то&shy;ком.</p>
<div class="paragraph-right-side">34</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
    <span style="color:Green;">// calculate ranges</span>
    <span style="color:Blue;">int</span> beg = (<span style="color:Blue;">int</span>)copy.frame;
    <span style="color:Blue;">int</span> size = copy.size;
    <span style="color:Blue;">int</span> baseFrom = (<span style="color:Blue;">int</span>) copy.origStackStart;
    <span style="color:Blue;">int</span> baseTo = baseFrom + (<span style="color:Blue;">int</span>)copy.origStackSize;
    <span style="color:Blue;">int</span> ESPr;

    __asm mov ESPr, ESP

    <span style="color:Green;">// target = EBP[ - locals - EBP - ret - whole stack frames copy]</span>
    <span style="color:Blue;">int</span> targetToCopy = ESPr - 8 - size;

    <span style="color:Green;">// offset between parent stack and current stack;</span>
    <span style="color:Blue;">int</span> delta_to_target = (<span style="color:Blue;">int</span>)targetToCopy - (<span style="color:Blue;">int</span>)copy.EBP;

    <span style="color:Green;">// offset between parent stack start and its copy;</span>
    <span style="color:Blue;">int</span> delta_to_copy = (<span style="color:Blue;">int</span>)copy.frame - (<span style="color:Blue;">int</span>)copy.EBP;
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">35</div>
<p >
Испол&shy;ьзуя эти дан&shy;ные, мы в цик&shy;ле идём по ко&shy;пии сте&shy;ка и ис&shy;прав&shy;ля&shy;ем ад&shy;ре&shy;са на их бу&shy;ду&shy;щие но&shy;вые по&shy;ло&shy;же&shy;ния.</p>
<div class="paragraph-right-side">35</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
    <span style="color:Green;">// In stack copy we have many saved EPBs, which where actually one-way linked list.</span>
    <span style="color:Green;">// we need to fix copy to make these pointers correct for our thread&#39;s stack.</span>
    <span style="color:Blue;">int</span> ebp_cur = beg;
    <span style="color:Blue;">while</span>(<span style="color:Blue;">true</span>)
    {
        <span style="color:Blue;">int</span> val = *(<span style="color:Blue;">int</span>*)ebp_cur;

        <span style="color:Blue;">if</span>(baseFrom &lt;= val &amp;&amp; val &lt; baseTo)
        {
            <span style="color:Blue;">int</span> localOffset = val + delta_to_copy;
            *(<span style="color:Blue;">int</span> *)ebp_cur += delta_to_target;
            ebp_cur = localOffset;
        }
        <span style="color:Blue;">else</span>
            <span style="color:Blue;">break</span>;
    }
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">36</div>
<p >
Ког&shy;да прав&shy;ка од&shy;нос&shy;вяз&shy;но&shy;го спис&shy;ка за&shy;вер&shy;ше&shy;на, мы дол&shy;жны ис&shy;пра&shy;вить зна&shy;че&shy;ния ре&shy;гист&shy;ров в их ко&shy;пии, что&shy;бы, ес&shy;ли там при&shy;сут&shy;ствуют ссыл&shy;ки на стек, они бы&shy;ли бы ис&shy;прав&shy;ле&shy;ны. Тут на са&shy;мом де&shy;ле ал&shy;го&shy;ритм сов&shy;сем не то&shy;чен. Ведь ес&shy;ли там по не&shy;ко&shy;то&shy;рой слу&shy;чай&shy;нос&shy;ти ока&shy;жет&shy;ся не удач&shy;ное чис&shy;ло из ди&shy;а&shy;па&shy;зо&shy;на ад&shy;ре&shy;сов сте&shy;ка, то оно бу&shy;дет ис&shy;прав&shy;ле&shy;но по ошиб&shy;ке. Но на&shy;ша за&shy;да&shy;ча не для про&shy;дук&shy;та кон&shy;цепт на&shy;пи&shy;сать, а прос&shy;то по&shy;нять ра&shy;бо&shy;ту сте&shy;ка по&shy;то&shy;ка. По&shy;то&shy;му для этих це&shy;лей нам дан&shy;ная ме&shy;то&shy;ди&shy;ка по&shy;дойдёт.</p>
<div class="paragraph-right-side">36</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
    CHECKREF(EAX);
    CHECKREF(EBX);
    CHECKREF(ECX);
    CHECKREF(EDX);

    CHECKREF(ESI);
    CHECKREF(EDI);
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">37</div>
<p >
Те&shy;перь, ос&shy;нов&shy;ная и са&shy;мая от&shy;ветст&shy;венная часть. Ког&shy;да мы ско&shy;пи&shy;ру&shy;ем в ко&shy;нец на&shy;ше&shy;го сте&shy;ка ко&shy;пию ди&shy;а&shy;па&shy;зо&shy;на ро&shy;ди&shy;тел&shy;ьского, все бу&shy;дет хо&shy;ро&shy;шо до мо&shy;мен&shy;та, ког&shy;да <code>MakeFork</code> в до&shy;чер&shy;нем по&shy;то&shy;ке за&shy;хо&shy;чет вый&shy;ти (сде&shy;лать <code>return</code>). Нам на&shy;до ука&shy;зать ему, ку&shy;да он дол&shy;жен вый&shy;ти. Для это&shy;го мы так&shy;же ими&shy;ти&shy;ру&shy;ем вы&shy;зов са&shy;мо&shy;го &lsquo;MakeFork&rsquo; из это&shy;го ме&shy;то&shy;да. Мы зак&shy;ла&shy;ды&shy;ва&shy;ем в стек ад&shy;рес мет&shy;ки <code>RestorePointAfterClonnedExited</code>, как буд&shy;то инстр&shy;укция про&shy;цес&shy;со&shy;ра <code>call</code> за&shy;ло&shy;жи&shy;ла в стек ад&shy;рес возв&shy;ра&shy;та, а так&shy;же по&shy;ло&shy;жи&shy;ли те&shy;ку&shy;щий <code>EBP</code>, сы&shy;ми&shy;ти&shy;ро&shy;вав пос&shy;тро&shy;е&shy;ние од&shy;нос&shy;вяз&shy;но&shy;го спис&shy;ка це&shy;по&shy;чек кад&shy;ров ме&shy;то&shy;дов. Пос&shy;ле че&shy;го зак&shy;ла&shy;ды&shy;ва&shy;ем в стек обыч&shy;ной опе&shy;ра&shy;ци&shy;ей <code>push</code> ко&shy;пию ро&shy;ди&shy;тел&shy;ьского сте&shy;ка тем са&shy;мым от&shy;ри&shy;со&shy;вав все ме&shy;то&shy;ды, ко&shy;то&shy;рые бы&shy;ли выз&shy;ва&shy;ны в ро&shy;ди&shy;т&shy;ельском сте&shy;ке из ме&shy;то&shy;да <code>MakeFork</code>, вклю&shy;чая его са&shy;мо&shy;го. Стек го&shy;тов!</p>
<div class="paragraph-right-side">37</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
    <span style="color:Green;">// prepare for __asm nret</span>
    __asm push offset RestorePointAfterClonnedExited
    __asm push EBP

    <span style="color:Blue;">for</span>(<span style="color:Blue;">int</span> i = (size &gt;&gt; 2) - 1; i &gt;= 0; i--)
    {
        <span style="color:Blue;">int</span> val = ((<span style="color:Blue;">int</span> *)beg)[i];
        __asm push val;
    };
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">38</div>
<p >
Да&shy;лее пос&shy;коль&shy;ку мы так&shy;же дол&shy;жны восс&shy;та&shy;но&shy;вить и ре&shy;гис&shy;тры, восс&shy;та&shy;нав&shy;ли&shy;ва&shy;ем и их са&shy;мих.</p>
<div class="paragraph-right-side">38</div>
</div>
<pre><code>    // restore registers, push 1 for Fork() and jmp
    _asm {
        push copy.EAX
        push copy.EBX
        push copy.ECX
        push copy.EDX
        push copy.ESI
        push copy.EDI
        pop EDI
        pop ESI
        pop EDX
        pop ECX
        pop EBX
        pop EAX
</code></pre>
<div class="paragraph-container">
<div class="paragraph-left-side">39</div>
<p >
А вот те&shy;перь са&shy;мое вре&shy;мя вспом&shy;нить тот стран&shy;ный код с зак&shy;ла&shy;ды&shy;ва&shy;ни&shy;ем <code>0</code> в стек и про&shy;вер&shy;ки на <code>0</code>. В этом по&shy;то&shy;ке мы зак&shy;ла&shy;ды&shy;ва&shy;ем <code>1</code> и де&shy;ла&shy;ем даль&shy;ний jmp в код ме&shy;то&shy;да <code>ForkImpl</code>. Ведь по сте&shy;ку мы на&shy;хо&shy;дим&shy;ся имен&shy;но там, а ре&shy;ально все ещё тут. Ког&shy;да мы ту&shy;да по&shy;падём, то <code>ForkImpl</code> рас&shy;поз&shy;на&shy;ет сме&shy;ну по&shy;то&shy;ка и осу&shy;щест&shy;вит вы&shy;ход в ме&shy;тод <code>MakeFork</code>, ко&shy;то&shy;рый, за&shy;вер&shy;шив ра&shy;бо&shy;ту, по&shy;падёт в точ&shy;ку <code>RestorePointAfterClonnedExited</code>, т.к. нем&shy;но&shy;го ра&shy;нее мы сым&shy;ти&shy;ро&shy;ва&shy;ли вы&shy;зов <code>MakeFork</code> из этой точ&shy;ки. Восс&shy;та&shy;но&shy;вив ре&shy;гис&shy;тры до сос&shy;то&shy;я&shy;ния &laquo;толь&shy;ко что выз&shy;ва&shy;ны из TheadPool&raquo;, мы за&shy;вер&shy;ша&shy;ем ра&shy;бо&shy;ту, от&shy;да&shy;вая по&shy;ток в пул по&shy;то&shy;ков.</p>
<div class="paragraph-right-side">39</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
        push 1
        jmp fword ptr CS_EIP
    }

RestorePointAfterClonnedExited:

    <span style="color:Green;">// Restore original registers</span>
    __asm popad
    <span style="color:Blue;">return</span>;
 }
</pre></div>
</div>
<p >
Про&shy;ве&shy;рим? Это - скрин&shy;шот до вы&shy;зо&shy;ва кло&shy;ни&shy;ро&shy;ва&shy;ния по&shy;то&shy;ка:</p>
<p >
<img src="./imgs/ThreadStack/ForkBeforeEnter.png" alt="" /></p>
<p >
И пос&shy;ле:</p>
<p >
<img src="./imgs/ThreadStack/ForkAfterEnter.png" alt="" /></p>
<div class="paragraph-container">
<div class="paragraph-left-side">40</div>
<p >
Как мы ви&shy;дим, те&shy;перь вмес&shy;то од&shy;но&shy;го по&shy;то&shy;ка внут&shy;ри ForkImpl мы ви&shy;дим два. И оба - выш&shy;ли из это&shy;го ме&shy;то&shy;да.</p>
<div class="paragraph-right-side">40</div>
</div>
<h1 id="section-5">Пара слов об уровне пониже</h1>
<div class="paragraph-container">
<div class="paragraph-left-side">41</div>
<p >
Если мы заг&shy;ля&shy;нем кра&shy;ем гла&shy;за на ещё бо&shy;лее низ&shy;кий уро&shy;вень, то уз&shy;на&shy;ем или же вспом&shy;ним, что па&shy;мять на са&shy;мом де&shy;ле яв&shy;ля&shy;ет&shy;ся вир&shy;ту&shy;альной и что она по&shy;де&shy;ле&shy;на на стра&shy;ни&shy;цы объёмом 8 или 4 Кб. Каж&shy;дая та&shy;кая стра&shy;ни&shy;ца мо&shy;жет фи&shy;зи&shy;чес&shy;ки су&shy;щест&shy;во&shy;вать или же нет. А ес&shy;ли она су&shy;щес&shy;тву&shy;ет, то мо&shy;жет быть отоб&shy;ра&shy;же&shy;на на файл или же ре&shy;альную опе&shy;ра&shy;тив&shy;ную па&shy;мять. Имен&shy;но этот ме&shy;ха&shy;низм вир&shy;ту&shy;а&shy;ли&shy;за&shy;ции поз&shy;во&shy;ля&shy;ет при&shy;ло&shy;же&shy;ни&shy;ям иметь раз&shy;дель&shy;ную друг от дру&shy;га па&shy;мять и обес&shy;пе&shy;чи&shy;ва&shy;ет уров&shy;ни бе&shy;зо&shy;пас&shy;нос&shy;ти меж&shy;ду при&shy;ло&shy;же&shy;ни&shy;ем и опе&shy;ра&shy;ци&shy;он&shy;ной сис&shy;те&shy;мой. При чем же здесь стек по&shy;то&shy;ка? Как и лю&shy;бая дру&shy;гая опе&shy;ра&shy;тив&shy;ная па&shy;мять при&shy;ло&shy;же&shy;ния стек по&shy;то&shy;ка яв&shy;ля&shy;ет&shy;ся её частью и так&shy;же сос&shy;то&shy;ит из стра&shy;ниц объёмом 4 или 8 Кб. По кра&shy;ям от вы&shy;де&shy;лен&shy;но&shy;го для сте&shy;ка прост&shy;ранства на&shy;хо&shy;дят&shy;ся две стра&shy;ни&shy;цы, дос&shy;туп к ко&shy;то&shy;рым при&shy;во&shy;дит к сис&shy;тем&shy;но&shy;му ис&shy;клю&shy;че&shy;нию, но&shy;ти&shy;фи&shy;ци&shy;ру&shy;ю&shy;ще&shy;му опе&shy;ра&shy;ци&shy;он&shy;ную сис&shy;те&shy;му о том, что при&shy;ло&shy;же&shy;ние пы&shy;та&shy;ет&shy;ся об&shy;ра&shy;тить&shy;ся в не&shy;вы&shy;де&shy;лен&shy;ный учас&shy;ток па&shy;мя&shy;ти. Внут&shy;ри это&shy;го ре&shy;ги&shy;она ре&shy;ально вы&shy;де&shy;лен&shy;ны&shy;ми участ&shy;ка&shy;ми яв&shy;ля&shy;ют&shy;ся толь&shy;ко те стра&shy;ни&shy;цы, к ко&shy;то&shy;рым об&shy;ра&shy;ти&shy;лось при&shy;ло&shy;же&shy;ние: т.е. ес&shy;ли при&shy;ло&shy;же&shy;ние ре&shy;зер&shy;ви&shy;ру&shy;ет под по&shy;ток 2Мб па&shy;мя&shy;ти, это не зна&shy;чит, что они бу&shy;дут вы&shy;де&shy;ле&shy;ны сра&shy;зу же. Отнюдь, они бу&shy;дут вы&shy;де&shy;ле&shy;ны по тре&shy;бо&shy;ва&shy;нию: ес&shy;ли стек по&shy;то&shy;ка вы&shy;рас&shy;тет до 1 Мб, это бу&shy;дет оз&shy;на&shy;чать, что при&shy;ло&shy;же&shy;ние по&shy;лу&shy;чи&shy;ло имен&shy;но 1 Мб опе&shy;ра&shy;тив&shy;ной па&shy;мя&shy;ти под стек.</p>
<div class="paragraph-right-side">41</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">42</div>
<p >
Ког&shy;да при&shy;ло&shy;же&shy;ние ре&shy;зер&shy;ви&shy;ру&shy;ет па&shy;мять под ло&shy;каль&shy;ные пе&shy;ре&shy;мен&shy;ные, то про&shy;ис&shy;хо&shy;дят две ве&shy;щи: на&shy;ра&shy;щи&shy;ва&shy;ет&shy;ся зна&shy;че&shy;ние ре&shy;гис&shy;тра ESP и за&shy;ну&shy;ля&shy;ет&shy;ся па&shy;мять под са&shy;ми пе&shy;ре&shy;мен&shy;ные. По&shy;э&shy;то&shy;му, ког&shy;да вы на&shy;пи&shy;ше&shy;те ре&shy;кур&shy;сив&shy;ный ме&shy;тод, ко&shy;то&shy;рый ухо&shy;дит в бес&shy;ко&shy;неч&shy;ную ре&shy;кур&shy;сию, вы по&shy;лу&shy;чи&shy;те StackOverflowException: за&shy;няв всю вы&shy;де&shy;лен&shy;ную под стек па&shy;мять (весь дос&shy;туп&shy;ный ре&shy;ги&shy;он), вы на&shy;по&shy;ри&shy;тесь на спе&shy;ци&shy;альную стра&shy;ни&shy;цу, Guard Page, дос&shy;туп к ко&shy;то&shy;рой вы&shy;зо&shy;вет но&shy;ти&shy;фи&shy;ка&shy;цию опе&shy;ра&shy;ци&shy;он&shy;ной сис&shy;те&shy;мы, ко&shy;то&shy;рая ини&shy;ци&shy;и&shy;ру&shy;ет StackOverflow уров&shy;ня ОС, ко&shy;то&shy;рое уйдёт в .NET, бу&shy;дет пе&shy;рех&shy;ва&shy;че&shy;но и выб&shy;ро&shy;сет&shy;ся ис&shy;клю&shy;че&shy;ние StackOverflowException для .NET при&shy;ло&shy;же&shy;ния.</p>
<div class="paragraph-right-side">42</div>
</div>
<h1 id="stackalloc">Выделение памяти на стеке: stackalloc</h1>
<div class="paragraph-container">
<div class="paragraph-left-side">43</div>
<p >
В C# су&shy;щес&shy;тву&shy;ет дос&shy;та&shy;точ&shy;но ин&shy;те&shy;рес&shy;ное и очень ред&shy;ко ис&shy;поль&shy;зу&shy;е&shy;мое клю&shy;че&shy;вое сло&shy;во <code>stackalloc</code>. Оно нас&shy;толь&shy;ко ред&shy;ко встр&shy;еч&shy;ае&shy;тся в ко&shy;де (тут я да&shy;же со сло&shy;вом &laquo;нем&shy;но&shy;го&raquo; пре&shy;у&shy;мень&shy;шил. Ско&shy;рее, &laquo;ни&shy;ког&shy;да&raquo;), что най&shy;ти под&shy;хо&shy;дя&shy;щий при&shy;мер его ис&shy;поль&shy;зо&shy;ва&shy;ния дос&shy;та&shy;точ&shy;но труд&shy;но, а уж при&shy;ду&shy;мать тем бо&shy;лее труд&shy;но: ведь ес&shy;ли что-то ред&shy;ко ис&shy;поль&shy;зу&shy;ет&shy;ся, то и опыт ра&shy;бо&shy;ты с ним слиш&shy;ком мал. А все по&shy;че&shy;му? По&shy;то&shy;му что для тех, кто на&shy;ко&shy;нец ре&shy;ша&shy;ет&shy;ся вы&shy;яс&shy;нить, что де&shy;ла&shy;ет эта ко&shy;ман&shy;да, <code>stackalloc</code> ста&shy;но&shy;вит&shy;ся бо&shy;лее пу&shy;га&shy;ю&shy;щим чем по&shy;лез&shy;ным: тёмная сто&shy;ро&shy;на <code>stackalloc</code> - unsafe код. Тот ре&shy;зуль&shy;тат, что он возв&shy;ра&shy;ща&shy;ет не яв&shy;ля&shy;ет&shy;ся managed ука&shy;за&shy;те&shy;лем: зна&shy;че&shy;ние - обыч&shy;ный ука&shy;за&shy;тель на учас&shy;ток не за&shy;щищённой па&shy;мя&shy;ти. Причём ес&shy;ли по это&shy;му ад&shy;ре&shy;су сде&shy;лать за&shy;пись уже пос&shy;ле то&shy;го, как ме&shy;тод за&shy;вер&shy;шил ра&shy;бо&shy;ту, вы начнёте пи&shy;сать в ло&shy;каль&shy;ные пе&shy;ре&shy;мен&shy;ные не&shy;ко&shy;то&shy;ро&shy;го ме&shy;то&shy;да или же во&shy;об&shy;ще пе&shy;ретрёте ад&shy;рес возв&shy;ра&shy;та из ме&shy;то&shy;да, пос&shy;ле че&shy;го при&shy;ло&shy;же&shy;ние за&shy;кон&shy;чит ра&shy;бо&shy;ту с ошиб&shy;кой. Одна&shy;ко на&shy;ша за&shy;да&shy;ча - про&shy;ник&shy;нуть в са&shy;мые угол&shy;ки и ра&shy;зоб&shy;рать&shy;ся, что в них скры&shy;то. И по&shy;нять, в част&shy;нос&shy;ти, что ес&shy;ли нам да&shy;ли этот инст&shy;румент, то не прос&shy;то же так, что&shy;бы мы смог&shy;ли най&shy;ти сек&shy;рет&shy;ные граб&shy;ли и нас&shy;ту&shy;пить на них со все&shy;го ма&shy;ху. На&shy;о&shy;бо&shy;рот: нам да&shy;ли этот инст&shy;румент что&shy;бы мы смог&shy;ли им вос&shy;поль&shy;зо&shy;вать&shy;ся и де&shy;лать по&shy;ис&shy;ти&shy;не быст&shy;рый софт. Я, на&shy;де&shy;юсь, вдох&shy;но&shy;вил вас? Тог&shy;да начнём.</p>
<div class="paragraph-right-side">43</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">44</div>
<p >
Что&shy;бы най&shy;ти пра&shy;виль&shy;ные при&shy;ме&shy;ры ис&shy;поль&shy;зо&shy;ва&shy;ния это&shy;го клю&shy;че&shy;во&shy;го сло&shy;ва на&shy;до прос&shy;ле&shy;до&shy;вать преж&shy;де все&shy;го к его ав&shy;то&shy;рам: ком&shy;па&shy;нии Microsoft и пос&shy;мот&shy;реть как его ис&shy;поль&shy;зу&shy;ют они. Сде&shy;лать это мож&shy;но по&shy;ис&shy;кав пол&shy;но&shy;текс&shy;то&shy;вым по&shy;ис&shy;ком по ре&shy;по&shy;зи&shy;то&shy;рию <a href="https://github.com/dotnet/coreclr">coreclr</a>. По&shy;ми&shy;мо раз&shy;лич&shy;ных тес&shy;тов са&shy;мо&shy;го клю&shy;че&shy;во&shy;го сло&shy;ва мы найдём не бо&shy;лее 25 ис&shy;поль&shy;зо&shy;ва&shy;ний это&shy;го клю&shy;че&shy;во&shy;го сло&shy;ва по ко&shy;ду биб&shy;ли&shy;о&shy;те&shy;ки. Я на&shy;де&shy;юсь, что в пре&shy;ды&shy;ду&shy;щем аб&shy;за&shy;це я дос&shy;та&shy;точ&shy;но силь&shy;но вас мо&shy;ти&shy;ви&shy;ро&shy;вал, что&shy;бы вы не ос&shy;та&shy;но&shy;ви&shy;ли чте&shy;ние, уви&shy;дев эту ма&shy;лень&shy;кую циф&shy;ру, и не зак&shy;ры&shy;ли мой труд. Ска&shy;жу чес&shy;тно: ко&shy;ман&shy;да CLR ку&shy;да бо&shy;лее даль&shy;но&shy;вид&shy;ная и про&shy;фес&shy;си&shy;о&shy;наль&shy;ная чем ко&shy;ман&shy;да .NET Framework. И ес&shy;ли она что-то сде&shy;ла&shy;ла, то это нам силь&shy;но в чем-то дол&shy;жно по&shy;мочь. А ес&shy;ли это не ис&shy;поль&shy;зо&shy;ва&shy;но в .NET Framework&hellip; Ну, тут мож&shy;но пред&shy;по&shy;ло&shy;жить, что там не все ин&shy;же&shy;не&shy;ры в кур&shy;се, что есть та&shy;кой мощ&shy;ный инст&shy;румент оп&shy;ти&shy;ми&shy;за&shy;ции. Ина&shy;че бы объёмы его ис&shy;поль&shy;зо&shy;ва&shy;ния бы&shy;ли бы го&shy;раз&shy;до боль&shy;ше.</p>
<div class="paragraph-right-side">44</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">45</div>
<p >
<strong>Класс Interop.ReadDir</strong>
<a href="https://github.com/dotnet/coreclr/blob/b29f6328510207970763580d6f4db864e4b198af/src/mscorlib/shared/Interop/Unix/System.Native/Interop.ReadDir.cs#L71-L83">/src/mscorlib/shared/Interop/Unix/System.Native/Interop.ReadDir.cs</a></p>
<div class="paragraph-right-side">45</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">unsafe</span>
{
    <span style="color:Green;">// s_readBufferSize is zero when the native implementation does not support reading into a buffer.</span>
    <span style="color:Blue;">byte</span>* buffer = <span style="color:Blue;">stackalloc</span> <span style="color:Blue;">byte</span>[s_readBufferSize];
    InternalDirectoryEntry temp;
    <span style="color:Blue;">int</span> ret = ReadDirR(dir.DangerousGetHandle(), buffer, s_readBufferSize, <span style="color:Blue;">out</span> temp);
    <span style="color:Green;">// We copy data into DirectoryEntry to ensure there are no dangling references.</span>
    outputEntry = ret == 0 ?
                <span style="color:Blue;">new</span> DirectoryEntry() { InodeName = GetDirectoryEntryName(temp), InodeType = temp.InodeType } :
                <span style="color:Blue;">default</span>(DirectoryEntry);

    <span style="color:Blue;">return</span> ret;
}
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">46</div>
<p >
Для че&shy;го здесь ис&shy;поль&shy;зу&shy;ет&shy;ся <code>stackalloc</code>? Как мы ви&shy;дим, пос&shy;ле вы&shy;де&shy;ле&shy;ния па&shy;мя&shy;ти код ухо&shy;дит в unsafe ме&shy;тод для за&shy;пол&shy;не&shy;ния соз&shy;дан&shy;но&shy;го бу&shy;фе&shy;ра дан&shy;ны&shy;ми. Т.е. unsafe ме&shy;тод, ко&shy;то&shy;ро&shy;му не&shy;об&shy;хо&shy;дим учас&shy;ток для за&shy;пи&shy;си, вы&shy;де&shy;ля&shy;ет&shy;ся мес&shy;то пря&shy;мо на сте&shy;ке: ди&shy;на&shy;ми&shy;чес&shy;ки. Это от&shy;лич&shy;ная оп&shy;ти&shy;ми&shy;за&shy;ция, ес&shy;ли учесть, что аль&shy;те&shy;рн&shy;ативы: зап&shy;ро&shy;сить учас&shy;ток па&shy;мя&shy;ти у Windows или fixed (pinned) мас&shy;сив .NET, ко&shy;то&shy;рый по&shy;ми&shy;мо наг&shy;руз&shy;ки на ку&shy;чу наг&shy;ру&shy;жа&shy;ет GC тем, что мас&shy;сив при&shy;би&shy;ва&shy;ет&shy;ся гвоз&shy;дя&shy;ми, что&shy;бы GC его не по&shy;дод&shy;ви&shy;нул во вре&shy;мя дос&shy;ту&shy;па к его дан&shy;ным. Вы&shy;де&shy;ляя па&shy;мять на сте&shy;ке, мы не рис&shy;ку&shy;ем ни&shy;чем: вы&shy;де&shy;ле&shy;ние про&shy;ис&shy;хо&shy;дит поч&shy;ти мо&shy;мен&shy;таль&shy;но, и мы мо&shy;жем со&shy;вер&shy;шен&shy;но спо&shy;кой&shy;но за&shy;пол&shy;нить его дан&shy;ны&shy;ми и вый&shy;ти из ме&shy;то&shy;да. А вмес&shy;те с вы&shy;хо&shy;дом из ме&shy;то&shy;да ис&shy;чез&shy;нет и stack frame ме&shy;то&shy;да. В об&shy;щем, эко&shy;но&shy;мия вре&shy;ме&shy;ни зна&shy;чи&shy;тель&shy;ней&shy;шая.</p>
<div class="paragraph-right-side">46</div>
</div>
<p >
Да&shy;вай&shy;те расс&shy;мот&shy;рим ещё один при&shy;мер:</p>
<div class="paragraph-container">
<div class="paragraph-left-side">47</div>
<p >
<strong>Класс Number.Formatting::FormatDecimal</strong>
<a href="https://github.com/dotnet/coreclr/blob/efebb38f3c18425c57f94ff910a50e038d13c848/src/mscorlib/shared/System/Number.Formatting.cs#L287-L311">/src/mscorlib/shared/System/Number.Formatting.cs</a></p>
<div class="paragraph-right-side">47</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">public</span> <span style="color:Blue;">static</span> <span style="color:Blue;">string</span> FormatDecimal(<span style="color:Blue;">decimal</span> value, ReadOnlySpan&lt;<span style="color:Blue;">char</span>&gt; format, NumberFormatInfo info)
{
    <span style="color:Blue;">char</span> fmt = ParseFormatSpecifier(format, <span style="color:Blue;">out</span> <span style="color:Blue;">int</span> digits);

    NumberBuffer number = <span style="color:Blue;">default</span>;
    DecimalToNumber(value, <span style="color:Blue;">ref</span> number);

    ValueStringBuilder sb;
    <span style="color:Blue;">unsafe</span>
    {
        <span style="color:Blue;">char</span>* stackPtr = <span style="color:Blue;">stackalloc</span> <span style="color:Blue;">char</span>[CharStackBufferSize];
        sb = <span style="color:Blue;">new</span> ValueStringBuilder(<span style="color:Blue;">new</span> Span&lt;<span style="color:Blue;">char</span>&gt;(stackPtr, CharStackBufferSize));
    }

    <span style="color:Blue;">if</span> (fmt != 0)
    {
        NumberToString(<span style="color:Blue;">ref</span> sb, <span style="color:Blue;">ref</span> number, fmt, digits, info, isDecimal:<span style="color:Blue;">true</span>);
    }
    <span style="color:Blue;">else</span>
    {
        NumberToStringFormat(<span style="color:Blue;">ref</span> sb, <span style="color:Blue;">ref</span> number, format, info);
    }

    <span style="color:Blue;">return</span> sb.ToString();
}
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">48</div>
<p >
Это - при&shy;мер фор&shy;ма&shy;ти&shy;ро&shy;ва&shy;ния чи&shy;сел, опи&shy;ра&shy;ющий&shy;ся на ещё бо&shy;лее ин&shy;те&shy;рес&shy;ный при&shy;мер клас&shy;са <a href="https://github.com/dotnet/coreclr/blob/efebb38f3c18425c57f94ff910a50e038d13c848/src/mscorlib/shared/System/Text/ValueStringBuilder.cs">ValueStringBuilder</a>, ра&shy;бо&shy;та&shy;ю&shy;щий на ос&shy;но&shy;ве <code>Span&lt;T&gt;</code>. Суть дан&shy;но&shy;го учас&shy;тка ко&shy;да в том, что для то&shy;го что&shy;бы соб&shy;рать текс&shy;то&shy;вое предс&shy;тав&shy;ле&shy;ние фор&shy;ма&shy;ти&shy;ро&shy;ван&shy;но&shy;го чис&shy;ла мак&shy;си&shy;маль&shy;но быс&shy;тро, код не ис&shy;поль&shy;зу&shy;ет вы&shy;де&shy;ле&shy;ния па&shy;мя&shy;ти под бу&shy;фер на&shy;коп&shy;ле&shy;ния сим&shy;во&shy;лов. Этот прек&shy;рас&shy;ный код вы&shy;де&shy;ля&shy;ет па&shy;мять пря&shy;мо в сте&shy;ко&shy;вом кад&shy;ре ме&shy;то&shy;да, обес&shy;пе&shy;чи&shy;вая тем са&shy;мым от&shy;с&shy;утствие ра&shy;бо&shy;ты сбор&shy;щи&shy;ка му&shy;со&shy;ра по эк&shy;земп&shy;ля&shy;рам StringBuilder, ес&shy;ли бы ме&shy;тод ра&shy;бо&shy;тал на его ос&shy;но&shy;ве. Плюс умень&shy;ша&shy;ет&shy;ся вре&shy;мя ра&shy;бо&shy;ты са&shy;мо&shy;го ме&shy;то&shy;да: вы&shy;де&shy;ле&shy;ние па&shy;мя&shy;ти в ку&shy;че то&shy;же вре&shy;мя за&shy;ни&shy;ма&shy;ет. А ис&shy;поль&shy;зо&shy;ва&shy;ние ти&shy;па <code>Span&lt;T&gt;</code> вмес&shy;то го&shy;лых ука&shy;за&shy;те&shy;лей вно&shy;сит чувство бе&shy;зо&shy;пас&shy;нос&shy;ти в ра&shy;бо&shy;ту ко&shy;да, ос&shy;но&shy;ван&shy;но&shy;го на stackalloc.</p>
<div class="paragraph-right-side">48</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">49</div>
<p >
Так&shy;же, пе&shy;ред тем как пе&shy;рей&shy;ти к вы&shy;во&shy;дам, сто&shy;ит упо&shy;мя&shy;нуть, как де&shy;лать нель&shy;зя. Дру&shy;ги&shy;ми сло&shy;ва&shy;ми, ка&shy;кой код мо&shy;жет ра&shy;бо&shy;тать хо&shy;ро&shy;шо, но в один прек&shy;рас&shy;ный мо&shy;мент выст&shy;ре&shy;лит в са&shy;мый не под&shy;хо&shy;дя&shy;щий мо&shy;мент. Опять же, расс&shy;мот&shy;рим при&shy;мер:</p>
<div class="paragraph-right-side">49</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">void</span> GenerateNoise(<span style="color:Blue;">int</span> noiseLength)
{
    <span style="color:Blue;">var</span> buf = <span style="color:Blue;">new</span> Span(<span style="color:Blue;">stackalloc</span> <span style="color:Blue;">int</span>[noiseLength]);
    <span style="color:Green;">// generate noise</span>
}
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">50</div>
<p >
Код мал да удал: нель&shy;зя вот так брать и пе&shy;ре&shy;да&shy;вать раз&shy;мер для вы&shy;де&shy;ле&shy;ния па&shy;мя&shy;ти на сте&shy;ке из&shy;вне. Если вам так ну&shy;жен за&shy;дан&shy;ный сна&shy;ру&shy;жи раз&shy;мер, при&shy;ми&shy;те сам бу&shy;фер:</p>
<div class="paragraph-right-side">50</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">void</span> GenerateNoise(Span&lt;<span style="color:Blue;">int</span>&gt; noiseBuf)
{
    <span style="color:Green;">// generate noise</span>
}
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">51</div>
<p >
Этот код го&shy;раз&shy;до ин&shy;фор&shy;ма&shy;тив&shy;нее, т.к. зас&shy;тав&shy;ля&shy;ет поль&shy;зо&shy;ва&shy;те&shy;ля за&shy;ду&shy;мать&shy;ся и быть ак&shy;ку&shy;рат&shy;ным при вы&shy;бо&shy;ре чи&shy;сел. Пер&shy;вый ва&shy;ри&shy;ант при не&shy;удач&shy;но сло&shy;жив&shy;ших&shy;ся об&shy;сто&shy;я&shy;т&shy;ельствах мо&shy;жет выб&shy;ро&shy;сить <code>StackOverflowException</code> при дос&shy;та&shy;точ&shy;но нег&shy;лу&shy;бо&shy;ком по&shy;ло&shy;же&shy;нии ме&shy;то&shy;да в сте&shy;ке по&shy;то&shy;ка: дос&shy;та&shy;точ&shy;но пе&shy;ре&shy;дать боль&shy;шое чис&shy;ло в ка&shy;чес&shy;тве па&shy;ра&shy;мет&shy;ра. Вто&shy;рой ва&shy;ри&shy;ант, ког&shy;да раз&shy;мер при&shy;ни&shy;мать всё-та&shy;ки мож&shy;но - это ког&shy;да этот ме&shy;тод вы&shy;зы&shy;ва&shy;ет&shy;ся в конк&shy;рет&shy;ных слу&shy;ча&shy;ях и при этом вы&shy;зы&shy;ва&shy;ю&shy;щий код &laquo;зна&shy;ет&raquo; ал&shy;го&shy;ритм ра&shy;бо&shy;ты это&shy;го ме&shy;то&shy;да. Без зна&shy;ния о внут&shy;рен&shy;нем ус&shy;трой&shy;стве ме&shy;то&shy;да нет конк&shy;рет&shy;но&shy;го по&shy;ни&shy;ма&shy;ния воз&shy;мож&shy;но&shy;го ди&shy;а&shy;па&shy;зо&shy;на для noiseLength и как след&shy;с&shy;твие - воз&shy;мож&shy;ны ошиб&shy;ки</p>
<div class="paragraph-right-side">51</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">52</div>
<p >
Вто&shy;рая проб&shy;ле&shy;ма, ко&shy;то&shy;рую я ви&shy;жу: ес&shy;ли нам слу&shy;чай&shy;ным об&shy;ра&shy;зом не уда&shy;лось по&shy;пасть в раз&shy;мер то&shy;го бу&shy;фе&shy;ра, ко&shy;то&shy;рый мы са&shy;ми се&shy;бе вы&shy;де&shy;ли&shy;ли на сте&shy;ке, а те&shy;рять ра&shy;бо&shy;тос&shy;по&shy;соб&shy;ность мы не хо&shy;тим, то, ко&shy;неч&shy;но, мож&shy;но пой&shy;ти нес&shy;коль&shy;ки&shy;ми пу&shy;тя&shy;ми: ли&shy;бо до&shy;вы&shy;де&shy;лить па&shy;мя&shy;ти, опять же на сте&shy;ке, ли&shy;бо вы&shy;де&shy;лить её в ку&shy;че. Причём, ско&shy;рее все&shy;го вто&shy;рой ва&shy;ри&shy;ант в боль&shy;шинстве слу&shy;ча&shy;ев ока&shy;жет&shy;ся бо&shy;лее пред&shy;поч&shy;ти&shy;тель&shy;ным (так и пос&shy;ту&shy;пи&shy;ли в слу&shy;чае <code>ValueStringBuffer</code>), т.к. бо&shy;лее бе&shy;зо&shy;па&shy;сен с точ&shy;ки зре&shy;ния по&shy;лу&shy;че&shy;ния <code>StackOverflowException</code>.</p>
<div class="paragraph-right-side">52</div>
</div>
<h2 id="stackalloc-1">Выводы к stackalloc</h2>
<p >
Итак, для че&shy;го же луч&shy;ше все&shy;го ис&shy;поль&shy;зо&shy;вать <code>stackalloc</code>?</p>
<ul>
<li>
<p >
Для ра&shy;бо&shy;ты с не&shy;уп&shy;рав&shy;ля&shy;е&shy;мым ко&shy;дом, ког&shy;да не&shy;об&shy;хо&shy;ди&shy;мо за&shy;пол&shy;нить не&shy;уп&shy;рав&shy;ля&shy;е&shy;мым ме&shy;то&shy;дом не&shy;ко&shy;то&shy;рый бу&shy;фер дан&shy;ных или же при&shy;нять от не&shy;уп&shy;рав&shy;ля&shy;е&shy;мо&shy;го ме&shy;то&shy;да не&shy;кий бу&shy;фер дан&shy;ных, ко&shy;то&shy;рый бу&shy;дет ис&shy;поль&shy;зо&shy;вать&shy;ся в рам&shy;ках жиз&shy;ни те&shy;ла ме&shy;то&shy;да;</p>
</li>
<li>
<p >
Для ме&shy;то&shy;дов, ко&shy;то&shy;рым ну&shy;жен мас&shy;сив, но опять же на вре&shy;мя ра&shy;бо&shy;ты са&shy;мо&shy;го ме&shy;то&shy;да. При&shy;мер с фор&shy;ма&shy;ти&shy;ро&shy;ва&shy;ни&shy;ем очень хо&shy;ро&shy;ший: этот ме&shy;тод мо&shy;жет вы&shy;зы&shy;вать&shy;ся слиш&shy;ком час&shy;то что&shy;бы он вы&shy;де&shy;лял вре&shy;мен&shy;ные мас&shy;си&shy;вы в ку&shy;че;</p>
</li>
</ul>
<div class="paragraph-container">
<div class="paragraph-left-side">53</div>
<p >
Испол&shy;ьз&shy;ов&shy;ание дан&shy;но&shy;го ал&shy;ло&shy;ка&shy;то&shy;ра мо&shy;жет силь&shy;но по&shy;вы&shy;сить про&shy;из&shy;во&shy;ди&shy;тель&shy;ность ва&shy;ших при&shy;ло&shy;же&shy;ний.</p>
<div class="paragraph-right-side">53</div>
</div>
<h1 id="section-6">Выводы к разделу</h1>
<div class="paragraph-container">
<div class="paragraph-left-side">54</div>
<p >
Ко&shy;неч&shy;но же, в об&shy;щем ви&shy;де нам нет на&shy;доб&shy;нос&shy;ти ре&shy;дак&shy;ти&shy;ро&shy;вать стек в про&shy;дук&shy;то&shy;вом ко&shy;де: толь&shy;ко ес&shy;ли за&shy;хо&shy;чет&shy;ся за&shy;нять своё сво&shy;бод&shy;ное вре&shy;мя ин&shy;те&shy;рес&shy;ной за&shy;дач&shy;кой. Одна&shy;ко по&shy;ни&shy;ма&shy;ние его струк&shy;ту&shy;ры даёт нам ви&shy;ди&shy;мость прос&shy;то&shy;ты за&shy;да&shy;чи по&shy;лу&shy;че&shy;ния дан&shy;ных из не&shy;го и его ре&shy;дак&shy;ти&shy;ро&shy;ва&shy;ния. Т.е. ес&shy;ли вы раз&shy;ра&shy;бо&shy;та&shy;ете API для рас&shy;ши&shy;ре&shy;ния фун&shy;кци&shy;о&shy;на&shy;ла ва&shy;ше&shy;го при&shy;ло&shy;же&shy;ния и ес&shy;ли это API не пре&shy;дос&shy;тав&shy;ля&shy;ет дос&shy;ту&shy;па к ка&shy;ким-ли&shy;бо дан&shy;ным это не зна&shy;чит что эти дан&shy;ные не&shy;воз&shy;мож&shy;но по&shy;лу&shy;чить. По&shy;то&shy;му всег&shy;да про&shy;ве&shy;ряй&shy;те ва&shy;ше при&shy;ло&shy;же&shy;ние на ус&shy;той&shy;чи&shy;вость к взло&shy;мам.</p>
<div class="paragraph-right-side">54</div>
</div>

        </div>
        <footer>
            <div class="footer-container">
                <div class="footer-wrap">
                    <img src="../../res/img/logo-w-noindex.svg">
                    <p>
                        <a class="footer-link" target="_blank" href="mailto:sidristij@clrium.ru"><i class="far fa-envelope" aria-hidden="true"></i></a>
                        <a class="footer-link" target="_blank" href="https://vk.com/clrium"><i class="fab fa-vk" aria-hidden="true"></i></a>
                        <a class="footer-link" target="_blank" href="https://youtube.com/clrium"><i class="fab fa-youtube" aria-hidden="true"></i></a>
                        <a class="footer-link" target="_blank" href="https://github.com/clrium"><i class="fab fa-github" aria-hidden="true"></i></a>
                        <a class="footer-link" target="_blank" href="skype:stanislav.sidristyi"><i class="fab fa-skype" aria-hidden="true"></i></a>
                        <a class="footer-link" target="_blank" href="https://t.me/clrium_group"><i class="fab fa-telegram" aria-hidden="true"></i></a>
                    </p>
                </div>
            </div>
        </footer>
    </div>
</body>
</html>