<!DOCTYPE html>
<html lang="ru">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>.NET Platform Architecture</title>
</head>
<body>
    <script src="../../res/jquery.js"></script>
    <link rel="stylesheet" href="../../res/bootstrap.css">
    <link rel="stylesheet" href="../../res/awesome.css">
    <style>

body {
    font-family: PF Regal,Georgia,serif;
    font-size: 16pt;
    font-weight: 300;
    padding-top: 4em;
    background-color: #fdfdfd;
}

.book-title-container {
    width: 100%;
    text-align: center;
    margin: 73px 0 110px 0;
}

.book-title {
    font-size: 57pt;
    margin: 50px 0 70px 0;
    user-select: none;
}
.book-part-title-block {
    display: inline-block;
}
.book-part-title {
    font-size: 21pt;
    color: #656ab6;
    margin: 0 7px;
}

.book-part-title:hover {
    box-shadow: inset 0 -1px #007bff;
    text-decoration: none;
}

.book-superheading-title {
    font-size: 15pt;
    margin: 0 7px;
    color: #656ab6;
}

.article-container
{
    width: 62%;
}

strong {
    font-weight: 500;
}

p, li {
    margin: 0 0 1em;
    line-height: 1.5em;
    font-family: inherit;
}

ol, li {
    margin-top: 1em;
    margin-bottom: 1em;
}

ol {
    padding-left: 1.21em;
}

ul  {
    padding-left: 1em;
}

ol li, ul li {
    padding-left: 0.5em;	
    font-family: inherit;
    text-align: justify;
}

table {
    margin: 30px 0;
    width: 100%;
}

thead {
    background-color: aliceblue;
}

table th {
    font-weight: 400;
}

table td, table th {
    padding: 7px;
    border-top: solid darkgrey 1px;
    border-bottom: solid darkgrey 1px;
    border-right: dotted darkgray 1px;
    border-left: dotted darkgray 1px;
    font-size: smaller;
}

code, *[class*='lang-'] span, *[class*='lang-'] pre {
    font-family: JB Mono, monospace !important;
}

*[class*='lang-'] {
    padding: 0px 0px 25px 0px;
    font-size: 0.75em;
}


*[class*='lang-'] > div, pre > code {
    border-left-color: #eee;
    border-left-style: dotted;
    border-left-width: 3px;
    padding-left: 25px;
    display: block;
    padding-top: 20px;
    padding-bottom: 20px;
}

*[class*='lang-'] > div pre, pre > code pre {
    margin-bottom: 0;
}

p code:not(.highlight), li code:not(.highlight) {
    font-size: 0.7em;
    padding: 3px;
    color: darkslateblue;
}

/* style for manual selecting */
.box {
    border: gainsboro;
    border-width: 1px;
    border-style: solid;
}

code.highlight {
    font-family: inherit !important;
    font-size: inherit;
    font-weight: inherit;
    color: inherit;
}

p code.highlight, li code.highlight {
    padding: 4px;
    background-color: #ffffa1;
}

.wide {
    width:140%;
}

p a, li a {
    text-decoration: none;
    color: inherit;
    box-shadow: inset 0 -1px #b88b59;
}

p a:hover, li a:hover {
    text-decoration: none;
    color: inherit;
    box-shadow: inset 0 -1px #0056b3;
}

blockquote h5 {
    background-color: aquamarine;
    margin: 16px 0 16px -20px;
    padding: 15px 30px 15px;
}

p img {
    width: 95%;
}

blockquote 
{
    padding-left: 0.4em;
    border-left: 0.5em solid rgba(0,0,0,.08);
    font-style: italic;
}

blockquote.big-quote, 
blockquote.breadcrumbs 
{
    background-color: transparent;
    padding: 0;
    border-left: none;
    font-style: normal;
}

blockquote.breadcrumbs, blockquote.breadcrumbs  p
{
    margin: 0;
    padding: 0;
}

blockquote p {
    padding: 1em 1em 1em 0.6em;
    font-family: inherit;
}

blockquote p code {
    font-family: consolas, monospace;
    font-size: 17px;
    padding: 4px 6px;
}

blockquote p em {
    font-weight: 400;
}

blockquote.big-quote > p {
    margin: 0.7em 0 0.7em 0;
    font-family: Charter;
    font-size: 2.5em;
    padding: 0;
    width: 130%;
    line-height: 1em;
}

h1, h2, h3, h4, h5, h6 {
    margin: 0;
    padding: 0;
    font-weight: 400;
    font-family: inherit;
}

h1 {
    font-size: 2.2em;
    font-family: Charter,Georgia,serif;
    font-weight: 300;
    margin: 1.8em 0 1.8em 0;
    text-align: center;
    width: 140%;
}

h2 {
    padding-top: 1.5em;
    font-family: Charter, Arial, Helvetica Neue, sans-serif;
    font-size: 1.25em;
    width: 70%;
}

h3 {
    padding-top: 1em;
    font-size: 1.3em;
    font-weight: 300;
    font-style: italic;
}

h4 {
    margin: 20px 0 10px 0;
    font-size: 16pt;
    font-weight: 500;
    font-style: italic;
}

/* Sidenotes */

.aside-container {
    position: relative;
}
.aside-container p {
    position: relative;
    top: 9px;
}

.aside-container > .aside-side-container {
    display: block;
    position: absolute;
    top: 12px;
    left: 96%;
    width: 34%;
    font-size: 12pt;
    line-height: 20px;
    margin-left: 100px;
    z-index: 1000;
}

.aside-container > .aside-side-container p {
    line-height: 24px;
    font-size: 13pt;
    margin: 0 0 13px 0;
}

.side-regular-block p {
    top: 0;
}

/* Music side player */
.aside-side-container .music-player {
    width: 100%;
    height: 400px;
}

/* media block after h1 */
.aside-container h1 + .aside-side-container.side-media-block h2 {
    margin: 7em 0 1em 0;
    font-family: Proxima Nova,Arial,Helvetica Neue,sans-serif;
    font-weight: 600;
}

.aside-side-container > li {
    display: block;
    font-family: Charter;
}

.aside-side-container > li ul, .aside-side-container > li ol {
    padding-left: 30px;
    margin-top: 0.5em;
    margin-bottom: 0.5em;
}
.aside-side-container > li li {
    padding-left: 6px;
    margin: 0 0 6px;
    line-height: 22px;

    font-family: Charter;
}

.aside-side-container p {
    line-height: 25px;
    font-size: 13pt;
    margin: 0 0 15px 0;
}

.aside-side-container blockquote {
    border: aliceblue;
    border-left-style: solid;
}

/* Paragraphs numbering */
.paragraph-container {
    position: relative;
}
.paragraph-container p {
    position: relative;
    top: 9px;
}

.paragraph-container p, .aside-container > p {
    text-align: justify;
}

.paragraph-container > .paragraph-left-side, .paragraph-container > .paragraph-right-side  {
    font-family: JB Mono, consolas;
    display: block;
    position: absolute;
    top: 17px;
    font-size: 10pt;
    line-height: 20px;
    color: #86abc473;
    z-index: 1000;
}
.paragraph-container > .paragraph-left-side {
    display: none;
    left: -2.1cm;
    width: 35px;
    user-select: none;
}

.paragraph-container > .paragraph-right-side  {
    display: none;
    left: 100%;
    width: 35px;
    padding-left: 45px;
    user-select: none;
}

.article-container
{
    width: 70%;
}

/* X_MENU */
.menu-title {
    text-align: center;
    margin: 35px 50px 35px 50px;
    font-size: 24pt;
    font-family: Charter;
}

.menu-container ol {
    margin: 0;
    padding: 0;
}

.menu-container ol li {
    margin: 0;
    padding: 0;
}

.header {
    height: 2.5em;
    background-color: white;
    position: relative;
    z-index: 1500;
    width: 100%;
    display: flex;
    justify-content: space-between;
    transition: all 1s;
    top: 0;
    box-shadow: 1px -4px 20px rgba(0, 0, 0, .1);
}

.fixed {
    position: fixed !important;
}

.header > .menu {
    pointer-events: auto;
    float: right;
    height: 40px;
    font-family: Charter, 'Helvetica Neue', Arial, sans-serif;
    font-size: 1em;
    color: #fff;
    margin-top:40px;
    margin-right:40px;
}

.menu a {
    color: #fff;
}
.menu a:hover {
    text-decoration: none;
    color: #fff;
}

#menu__toggle {
    opacity: 0;
}

#menu__toggle:checked ~ .menu__btn > span {
    transform: rotate(45deg);
}
#menu__toggle:checked ~ .menu__btn > span::before {
    top: 0;
    transform: rotate(0);
    background-color: black
}
#menu__toggle:checked ~ .menu__btn > span::after {
    top: 0;
    transform: rotate(90deg);
    background-color: black
}
#menu__toggle:checked ~ .menu__box {
    visibility: visible;
    right: 0;
}

.menu__btn {
    display: flex;
    align-items: center;
    position: fixed;
    top: 0;
    right: 0;
    width: 2.5em;
    height: 2.5em;
    cursor: pointer;
    z-index: 1;
    margin: 0;
    padding: 0.7em;
}

.menu__btn > span,
.menu__btn > span::before,
.menu__btn > span::after {
    display: block;
    position: absolute;

    width: 1.1em;
    height: 1px;

    border-bottom: 1px black solid;

    transition-duration: .25s;
}
.menu__btn > span::before {
    content: '';
    top: -7px;
}
.menu__btn > span::after {
    content: '';
    top: 7px;
}

.menu__box {
    display: block;
    position: fixed;
    visibility: hidden;
    top: 0;
    right: -100%;

    width: 100%;
    height: 100%;

    margin: 0;
    padding: 80px 0;

    list-style: none;

    background-color: white;
    box-shadow: 1px 0px 6px rgba(0, 0, 0, .2);

    transition-duration: .25s;

    overflow-y: auto;
}
.menu__box li a:hover {
    text-decoration: none;
    color: inherit;
}
.menu__list {
    font-size: 0.9em;
    margin: 0 2em 0 2em;
}
.menu__list li {
    text-align: left;
}

/* X_HEADER */

.conflogo {
    margin: 0.5em 0 0 0.8em;
    font-size: 1.1em;
    font-family: Charter;
    user-select: none;
}

.invisible {
    display: none;
}

.header > .menu > div {
    display: inline;
    margin-left: 10px;
    margin-right: 10px;
}

.menu__header_current
{
    text-align: center;
    font-size: 2em;
    margin: 0 0 1em 0;
}

.menu__header_total
{
    text-align: center;
    font-size: 2.4em;
    margin: 1.7em 0 0.3em 0;
}
.menu__header_list 
{
    padding: 0;
    margin-top: 0;
    margin-left: 0;
    margin-right: 0;
}
.menu__header_list > li 
{
    display: inline-block;
    width: 100%;
    margin: 0;
    text-align: center;
    font-family: charter;
}
.menu__header_total_sub
{
    font-size: 1.4em;
    margin: 2em 0 1em 0;
}
.menu__header_total_sub2
{
    font-size: 1.1em;
    margin: 1.5em 0 0.6em 1em;
    text-align: left;
}
/* X_FOOTER */

footer {
    margin-top: 2em;
    background-color: black;
    height: 4em;
}

footer > div {
    box-shadow: 0px 2px 2px rgb(0, 0, 0);
}

.footer-container {
    height: 100%;
}

.footer-wrap {
    color: #fff;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 25px 0;
}

.footer-wrap p {
    margin: 0;
    padding: 0px;
    line-height: 1em;
}

.footer-container img {
    height: 1.6em;
    margin-top: auto;
    margin-bottom: auto;
}

.footer-link {
    color: white;
    margin: 0 7px;
    font-size: 1em;
    box-shadow: none;
}

.footer-link:hover {
    color: salmon;
    box-shadow: none;
}

/* MEDIA */
/* XXL */
@media (min-width: 1601px) {
    .book-container
    {
        max-width: 1200px;
        margin-left: auto;
        margin-right: auto;
    }
}

/* XL */
@media (max-width: 1600px) {
    .book-container
    {
        margin-left: 4cm;
        margin-right: 4cm;
    }
}

/* LG */
@media (max-width: 1400px) {
    .book-container
    {
        margin-left: 4cm;
        margin-right: 4cm;
    }

    blockquote.big-quote > p {
        font-size: 2em;
    }
}

/* > MD */
@media (min-width: 992px) {
    .hamburger-menu {
        display: none;
    }
}

/* MD */
@media (max-width: 991px) {
    
    h2 {
        width:80%;
    }

    .book-container
    {
        margin-left: 3cm;
        margin-right: 3cm;
    }
    
    .book-title-container {
        margin: 73px 0 110px 0;
    }

    .book-title {
        font-size: 50pt;
        margin: 50px 0 70px 0;
    }

    .book-part-title {
        font-size: 19pt;
    }

    .book-part-title:hover {
        box-shadow: inset 0 -1px #007bff;
    }

    .book-superheading-title {
        font-size: 15pt;
    }                                     

    .article-container, h1 {
        width: 100%;
    }

    .aside-container p {
        top: 0;
    }

    .aside-container h1 + .aside-side-container.side-media-block h2 {
        display: none;
    }

    .wide {
        width: 100%;     
    }

    .side-regular-block {
        margin: 40px 10px;
        padding-left: 100px;
    }
    .aside-side-container .music-player {
        width: 100%;
        height: 100px;
    }
    .aside-side-container.side-media-block {
        padding: 17px 0;
    }
    .aside-side-container.side-media-block h2 {
        margin-top: 20px;
        font-size: 13pt;
        border: none;
    }

    .aside-container > .aside-side-container
    {
        position: relative;
        top: auto;
        left: auto;
        width: auto;
        height: auto;
        margin: 0;
        padding: 17px;
    }

    blockquote.big-quote > p {
        width: 100%;
        font-size: 2em;
    }

    .paragraph-container .paragraph-left-side {
        left: -55px;
    }

    body {
        font-size: 15pt;
    }

    p code:not(.highlight), li code:not(.highlight) {
        font-size: 11pt;
    }

    p, li {
        line-height: 30px;
    }
    
    li {
        margin: 0 0 10px 0;
    }

    .side-regular-block {
        border-radius: 5px;
        background-image: linear-gradient(180deg,hsla(0,0%,100%,0) 60%,#fff),linear-gradient(70deg,#dbedff 32%,#ebfff0);
        padding: 22px;
    }    

    .menu__list
    {
        margin-top: 0;
        margin-bottom: 0;
    }

    .menu__list, .menu__header_total_sub2
    {
        margin-left: auto;
        margin-right: auto;
        max-width: 800px;
        width: 80%;
    }

    .book-container 
    {
        position: absolute;
        padding: 0 3cm 0 3cm;
        overflow: scroll;
        overflow-x: auto;
        top: 2.5em;
        bottom: 0;
        width: 100%;
        margin: 0;
    }

    footer {
        margin-top: 2em;
        background-color: black;
        height: 4em;
    }

    footer > div {
        position: relative;
        margin: 0 -3cm;
        background: black;
        padding: 0 3cm;
    }
}

/* Smartphone horizontal - SM */
@media (max-width: 767px) {
    .book-title-container {
        margin: 73px 0 110px 0;
    }

    h1 {
        margin: 1.8em 0em 1.8em 0.3em;
    }

    .book-title {
        font-size: 40pt;
        margin: 50px 0 70px 0;
    }

    .book-part-title {
        font-size: 19pt;
    }

    .book-part-title:hover {
        box-shadow: inset 0 -1px #007bff;
    }

    .book-superheading-title {
        font-size: 17pt;
    }

    .book-container {
        padding: 0 2.5cm;
    }
    ul {
        margin-left: 30px;
        margin-right: 30px;
        padding-left: 25px;
    }
    .paragraph-container > .paragraph-left-side {
	    display: block;
        top: 14px;
        font-size: 9pt;
    }
    .paragraph-container > .paragraph-right-side {
    	display: block;
        padding-left: 40px;
        top: 14px;
        font-size: 9pt;
    }
    .footer-container img {
        height: 1.3em;
    } 
}

@media (max-width: 630px) {
    .book-container {
        padding: 0 1.5cm;
    }
    .paragraph-container > .paragraph-left-side {
        left: -33px;
    }
    .paragraph-container > .paragraph-right-side {
        padding-left: 24px;
    }
}
/* Smartphone - XS */
@media (max-width: 575px) {
    .book-container {
        padding: 0 50px 0 30px;
    }
    ul {
        margin: 0;
        padding-left: 20px;
    }

    body {
        font-size: 13pt;
    }

    p code:not(.highlight), li code:not(.highlight) 
    {
        font-size: 10pt;
        padding: 3px;
    }
   
    p, li {
        line-height: 24px;
    }    
    
    .paragraph-container .paragraph-left-side 
    {
        display: none;        
    }
    .paragraph-container .paragraph-right-side 
    {
        padding-left: 21px;
        top: 14px;
	    font-size: 8pt;
    }
    .footer-container img {
        height: 1em;
    } 
    .menu__list {
        margin: 0 1em 0 1em;
    }
    .menu__header_total_sub2
    {
        margin: 1.5em 0 0.6em 1em;
    }
}

/* Fonts */

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-Bold.eot');
    src: local('../../res/fonts/PFRegalTextPro-Bold'),
        url('../../res/fonts/PFRegalTextPro-Bold.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-Bold.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-Bold.ttf') format('truetype');
    font-weight: bold;
    font-style: normal;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-Medium.eot');
    src: local('../../res/fonts/PFRegalTextPro-Medium'),
        url('../../res/fonts/PFRegalTextPro-Medium.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-Medium.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-Medium.ttf') format('truetype');
    font-weight: 500;
    font-style: normal;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-BlackItalic.eot');
    src: local('../../res/fonts/PFRegalTextPro-BlackItalic'),
        url('../../res/fonts/PFRegalTextPro-BlackItalic.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-BlackItalic.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-BlackItalic.ttf') format('truetype');
    font-weight: 900;
    font-style: italic;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-Black.eot');
    src: local('../../res/fonts/PFRegalTextPro-Black'),
        url('../../res/fonts/PFRegalTextPro-Black.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-Black.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-Black.ttf') format('truetype');
    font-weight: 900;
    font-style: normal;
}

@font-face {
    font-family: 'PF Regal UBlack';
    src: url('../../res/fonts/PFRegalTextPro-UBlack.eot');
    src: local('../../res/fonts/PFRegalTextPro-UBlack'),
        url('../../res/fonts/PFRegalTextPro-UBlack.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-UBlack.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-UBlack.ttf') format('truetype');
    font-weight: 900;
    font-style: normal;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-MediumItalic.eot');
    src: local('../../res/fonts/PFRegalTextPro-MediumItalic'),
        url('../../res/fonts/PFRegalTextPro-MediumItalic.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-MediumItalic.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-MediumItalic.ttf') format('truetype');
    font-weight: 500;
    font-style: italic;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-UBlackItalic.eot');
    src: local('../../res/fonts/PFRegalTextPro-UBlackItalic'),
        url('../../res/fonts/PFRegalTextPro-UBlackItalic.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-UBlackItalic.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-UBlackItalic.ttf') format('truetype');
    font-weight: 900;
    font-style: italic;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-RegularAItalic.eot');
    src: local('../../res/fonts/PFRegalTextPro-RegularAItalic'),
        url('../../res/fonts/PFRegalTextPro-RegularAItalic.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-RegularAItalic.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-RegularAItalic.ttf') format('truetype');
    font-weight: 300;
    font-style: italic;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-BoldItalic.eot');
    src: local('../../res/fonts/PFRegalTextPro-BoldItalic'),
        url('../../res/fonts/PFRegalTextPro-BoldItalic.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-BoldItalic.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-BoldItalic.ttf') format('truetype');
    font-weight: bold;
    font-style: italic;
}

@font-face {
    font-family: 'Charter';
    src: url('../../res/fonts/charter-regular.woff2') format('woff2');
    font-weight: normal;
    font-style: normal;
}

/*  Regular B */
@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-RegularBItalic.eot');
    src: local('../../res/fonts/PFRegalTextPro-RegularBItalic'),
        url('../../res/fonts/PFRegalTextPro-RegularBItalic.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-RegularBItalic.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-RegularBItalic.ttf') format('truetype');
    font-weight: 300;
    font-style: italic;
}

@font-face {
    font-family: 'PF Regal';
    src: url('../../res/fonts/PFRegalTextPro-RegularB.eot');
    src: local('../../res/fonts/PFRegalTextPro-RegularB'),
        url('../../res/fonts/PFRegalTextPro-RegularB.woff2') format('woff2'),
        url('../../res/fonts/PFRegalTextPro-RegularB.woff') format('woff'),
        url('../../res/fonts/PFRegalTextPro-RegularB.ttf') format('truetype');
    font-weight: 300;
    font-style: normal;
}

@font-face {
    font-family: 'JB Mono';
    src: url('../../res/fonts/JetBrainsMono-Regular.eot');
    src: local('../../res/fonts/JetBrainsMono-Regular'),
        url('../../res/fonts/JetBrainsMono-Regular.woff2') format('woff2'),
        url('../../res/fonts/JetBrainsMono-Regular.woff') format('woff'),
        url('../../res/fonts/JetBrainsMono-Regular.ttf') format('truetype');
    font-weight: 300;
    font-style: normal;
}
@font-face {
    font-family: 'JB Mono';
    src: url('../../res/fonts/JetBrainsMono-Italic.eot');
    src: local('../../res/fonts/JetBrainsMono-Italic'),
        url('../../res/fonts/JetBrainsMono-Italic.woff2') format('woff2'),
        url('../../res/fonts/JetBrainsMono-Italic.woff') format('woff'),
        url('../../res/fonts/JetBrainsMono-Italic.ttf') format('truetype');
    font-weight: 300;
    font-style: italic;
}

@font-face {
    font-family: 'JB Mono';
    src: url('../../res/fonts/JetBrainsMono-Medium.eot');
    src: local('../../res/fonts/JetBrainsMono-Medium'),
        url('../../res/fonts/JetBrainsMono-Medium.woff2') format('woff2'),
        url('../../res/fonts/JetBrainsMono-Medium.woff') format('woff'),
        url('../../res/fonts/JetBrainsMono-Medium.ttf') format('truetype');
    font-weight: 500;
    font-style: normal;
}
@font-face {
    font-family: 'JB Mono';
    src: url('../../res/fonts/JetBrainsMono-Medium-Italic.eot');
    src: local('../../res/fonts/JetBrainsMono-Medium-Italic'),
        url('../../res/fonts/JetBrainsMono-Medium-Italic.woff2') format('woff2'),
        url('../../res/fonts/JetBrainsMono-Medium-Italic.woff') format('woff'),
        url('../../res/fonts/JetBrainsMono-Medium-Italic.ttf') format('truetype');
    font-weight: 500;
    font-style: italic;
}
@font-face {
    font-family: 'Font Awesome 5 Free';
    font-style: normal;
    font-weight: 400;
    font-display: swap;
    src: url("../../res/fonts/webfonts/fa-regular-400.eot");
    src: url("../../res/fonts/webfonts/fa-regular-400.eot?#iefix") format("embedded-opentype"), 
         url("../../res/fonts/webfonts/fa-regular-400.woff2") format("woff2"), 
         url("../../res/fonts/webfonts/fa-regular-400.woff") format("woff"), 
         url("../../res/fonts/webfonts/fa-regular-400.ttf") format("truetype"), 
         url("../../res/fonts/webfonts/fa-regular-400.svg#fontawesome") format("svg"); 
    font-display: swap;
}
    
.fa {
    font-family: 'Font Awesome 5 Free';
    font-weight: 400;
    font-display: swap;
}
@font-face {
  font-family: 'Font Awesome 5 Brands';
  font-style: normal;
  font-weight: 400;
  font-display: auto;
  src: url("../../res/fonts/fa-brands-400.eot");
  src: url("../../res/fonts/fa-brands-400.eot?#iefix") format("embedded-opentype"), url("../../res/fonts/fa-brands-400.woff2") format("woff2"), url("../../res/fonts/fa-brands-400.woff") format("woff"), url("../../res/fonts/fa-brands-400.ttf") format("truetype"), url("../../res/fonts/fa-brands-400.svg#fontawesome") format("svg"); 
}

.fab {
  font-family: 'Font Awesome 5 Brands';
  font-weight: 400; 
}

@font-face {
  font-family: 'Font Awesome 5 Free';
  font-style: normal;
  font-weight: 400;
  font-display: auto;
  src: url("../../res/fonts/fa-regular-400.eot");
  src: url("../../res/fonts/fa-regular-400.eot?#iefix") format("embedded-opentype"), url("../../res/fonts/fa-regular-400.woff2") format("woff2"), url("../../res/fonts/fa-regular-400.woff") format("woff"), url("../../res/fonts/fa-regular-400.ttf") format("truetype"), url("../../res/fonts/fa-regular-400.svg#fontawesome") format("svg"); 
}

.far {
  font-family: 'Font Awesome 5 Free';
  font-weight: 400; 
}

@font-face {
  font-family: 'Font Awesome 5 Free';
  font-style: normal;
  font-weight: 900;
  font-display: auto;
  src: url("../../res/fonts/fa-solid-900.eot");
  src: url("../../res/fonts/fa-solid-900.eot?#iefix") format("embedded-opentype"), url("../../res/fonts/fa-solid-900.woff2") format("woff2"), url("../../res/fonts/fa-solid-900.woff") format("woff"), url("../../res/fonts/fa-solid-900.ttf") format("truetype"), url("../../res/fonts/fa-solid-900.svg#fontawesome") format("svg"); 
}
</style>  
    <div class="book-title-container d-none d-lg-block">
        <div class="book-title">Knowledge Base</div>
        <div class="book-part-title-block">pt.1 <a href="../..//ru/Memory/01-00-MemoryManagement-Intro.html" class="book-part-title">Управление памятью</a></div>
        <div class="book-part-title-block">pt.2 <a href="../..//ru/Execution/02-00-ExecutionFlow-Intro.html" class="book-part-title">Поток исполнения команд</a></div>
        <br><a href="#" class="book-superheading-title">Обоснование выбора</a>
        / <a href="#" class="book-superheading-title">Упрощенное описание</a>
        / <a href="#" class="book-superheading-title">Подробное описание</a>
    </div>
    <header class="header fixed d-block d-lg-none">
        <p class="conflogo">KB</p> 

        <!-- mobile-menu -->

        <div class="hamburger-menu">
            <input id="menu__toggle" type="checkbox" />
            <label class="menu__btn" for="menu__toggle">
              <span></span>
            </label>
        
            <div class="menu__box">
                <p class="menu__header_current">На странице</p>
                <ol class="menu__list">
                    <li><a href="#section-1" onclick="$('#menu__toggle').click(); return true;">
Аудиокнига</a></li>
<li><a href="#section-2" onclick="$('#menu__toggle').click(); return true;">
Введение в управление памятью</a></li>
<li><a href="#section-3" onclick="$('#menu__toggle').click(); return true;">
Возможные классификации памяти исходя из логики</a></li>
<li><a href="#section-4" onclick="$('#menu__toggle').click(); return true;">
Как это работает у нас. Обоснование выбора архитекторов</a></li>
<li><a href="#section-5" onclick="$('#menu__toggle').click(); return true;">
Как это работает у нас</a></li>

                </ol>
                <p class="menu__header_total">Содержание</p>
                <ul class="menu__header_list">
                    <li>
                        <p class="menu__header_total_sub">
                            Управление памятью
                        </p>
                        <p class="menu__header_total_sub2">
                            Теоретические вопросы:
                        </p>
                        <ol class="menu__list">
                            <li><p><a href="../..//ru/Memory/01-00-MemoryManagement-Intro.html">
                                Общие слова
                            </a></p></li>
                            <li>
                                <p>
                                <a href="../..//ru/Memory/01-02-MemoryManagement-Basics.html">Введение в управление памятью</a></p>
                            </li>
                            <li>
                                <p>
                                <a href="../..//ru/Memory/01-04-MemoryManagement-ThreadStack.html">Стек потока</a></p>
                            </li>
                            <li>
                                <p>
                                <a href="../..//ru/Memory/01-06-MemoryManagement-EntitiesLifetime.html">Время жизни сущности</a></p>
                            </li>
                            <li>
                                <p>
                                <a href="../..//ru/Memory/01-08-MemoryManagement-RefVsValueTypes.html">RefTypes, ValueTypes, Boxing &amp; Unboxing</a></p>
                            </li>
                            <li>
                                <p>
                                <a href="../..//ru/Memory/01-10-MemoryManagement-IDisposable.html">Шаблон Disposable</a></p>
                            </li>
                            <li>
                                <p>
                                <a href="../..//ru/Memory/01-12-MemoryManagement-Finalizer.html">Финализация</a></p>
                            </li>
                            <li>
                                <p>
                                <a href="../..//ru/Memory/01-14-MemoryManagement-Results.html">Выводы</a></p>
                            </li>
                        </ol>
                        <p class="menu__header_total_sub2">
                            Практические вопросы:
                        </p>
                        <ol class="menu__list" start="9">
                            <li><p><a href="../..//ru/Memory/02-02-MemoryManagement-MemorySpan.html">
                                Memory&lt;T&gt;, Span&lt;T&gt;
                            </a></p></li>
                        </ol> 
                    </li>
                    <li>
                        <p class="menu__header_total_sub">
                            Поток исполнения команд
                        </p>
                        <p class="menu__header_total_sub2">
                            Многопоточность:
                        </p>
                        <ol class="menu__list">
                            <li><p><a href="../..//ru/Execution/1-Threads/1-OS/1-threadsScheduling.html">
                                Потоки и планирование потоков
                            </a></p></li>
                        </ol>
                        <p class="menu__header_total_sub2">
                            Искл­юч­ител­ьные си­ту­а­ции:
                        </p>
                        <ol class="menu__list" start="2">
                            <li><p><a href="../..//ru/Execution/2-ExceptionalFlow/1-Exceptions-Intro.html">
                                Введение в исключительные ситуации
                            </a></p></li>
                            <li><p><a href="../..//ru/Execution/2-ExceptionalFlow/2-Exceptions-Architecture.html">
                                Архитектура исключительной ситуации
                            </a></p></li>
                            <li><p><a href="../..//ru/Execution/2-ExceptionalFlow/3-Exceptions-Events.html">
                                События об исключительных ситуациях
                            </a></p></li>
                            <li><p><a href="../..//ru/Execution/2-ExceptionalFlow/4-Exceptions-Types.html">
                                Виды исключительных ситуаций
                            </a></p></li>
                        </ol>
                    </li>
                </ul>
            </div>
        </div>
    </header>

    <div class="book-container">
        <div class="article-container">
            <!--<p class="d-xs-block d-sm-none">XS</p>
            <p class="d-none d-xs-block d-sm-none">SM</p>
            <p class="d-none d-sm-block d-md-none">MD</p>
            <p class="d-none d-lg-block d-xl-none">LG</p>
            <p class="d-none d-xl-block">XL</p> -->
            <div class="aside-container"><h1 id="section" class="wide">Управление памятью</h1>
<div class="aside-side-container side-media-block">
<h2 id="section-1">Аудиокнига</h2>
<p >
<iframe src="https://music.yandex.ru/iframe/#album/9613103" width="400px" height="102px" class="music-player" frameborder="0"></iframe></p>
</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">01</div>
<p >
Когда я раз&shy;го&shy;ва&shy;ри&shy;вал с раз&shy;лич&shy;ными людьми и расс&shy;ка&shy;зы&shy;вал, как рабо&shy;тает Garbage Collector (для меня по началу это было боль&shy;шим и стран&shy;ным увле&shy;че&shy;нием), то весь расс&shy;каз уме&shy;щался мак&shy;си&shy;мум минут на 15. После чего, мне зада&shy;вали один воп&shy;рос: «а зачем это знать? Ведь рабо&shy;тает как-то и рабо&shy;тает». После чего в голове начи&shy;на&shy;лась пута&shy;ница: с одной сто&shy;роны я пони&shy;мал, что они в боль&shy;шинстве слу&shy;чаев правы. И расс&shy;ка&shy;зы&shy;вал про то самое мень&shy;шинство слу&shy;чаев, где эти зна&shy;ния прек&shy;расно себя чув&shy;ствуют и исполь&shy;зу&shy;ются. Но пос&shy;кольку таких слу&shy;чаев было всё-таки мень&shy;шинство, в гла&shy;зах собе&shy;сед&shy;ника оста&shy;ва&shy;лось неко&shy;то&shy;рое чувство недо&shy;ве&shy;рия.</p>
<div class="paragraph-right-side">01</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">02</div>
<p >
На уровне тех зна&shy;ний, кото&shy;рые нам давали раньше в нем&shy;но&shy;го&shy;чис&shy;лен&shy;ных источ&shy;ни&shy;ках, люди, кото&shy;рых собе&shy;се&shy;дуют на пози&shy;цию раз&shy;ра&shy;бот&shy;чика обычно гово&shy;рят: есть три поко&shy;ле&shy;ния, пара хипов боль&shy;ших и малых объ&shy;ек&shy;тов. Еще мак&shy;си&shy;мум можно услы&shy;шать  &mdash;  про нали&shy;чие неких сег&shy;мен&shy;тов и таб&shy;лицы карт. Но обычно дальше поко&shy;ле&shy;ний и хипов люди не ухо&shy;дят. И все почему? Ведь <strong>вовсе не потому</strong>, что чего-то не знают, а потому, что дейс&shy;твит&shy;ельно <strong>не понятно, зачем это знать</strong>. Ведь та инфор&shy;ма&shy;ция, кото&shy;рая нам дава&shy;лась, выг&shy;ля&shy;дела как рек&shy;лам&shy;ный бук&shy;лет к чему-то боль&shy;шому и зак&shy;ры&shy;тому. Ну знаем мы про три поко&shy;ле&shy;ния, ну и что?.. Всё это, сог&shy;ла&shy;си&shy;тесь, какое-то эфе&shy;мер&shy;ное.</p>
<div class="paragraph-right-side">02</div>
</div>
<div class="aside-container">
<p >
Сей&shy;час же, когда Micro&shy;soft открыли исход&shy;ники, я ожи&shy;дал нес&shy;коль&shy;ких бене&shy;фи&shy;тов от этого. Пер&shy;вый бене&shy;фит  &mdash;  это то, что сооб&shy;щес&shy;тво наки&shy;нется и нач&shy;нет какие-то баги исправ&shy;лять. И оно наки&shy;ну&shy;лось! И испра&shy;вило все грам&shy;ма&shy;ти&shy;чес&shy;кие ошибки в ком&shy;мен&shy;та&shy;риях. Много запя&shy;тых исправ&shy;лено и опе&shy;ча&shy;ток. Иногда даже напи&shy;сано, что, нап&shy;ри&shy;мер, свой&shy;ство <code>IsEnabled</code> возв&shy;ра&shy;щает приз&shy;нак того, что что-то вклю&shy;чено. Можно даже подать на член&shy;ство в .NET Foun&shy;da&shy;tion, опи&shy;ра&shy;ясь на мно&shy;жес&shy;тво вот таких вот ком&shy;мен&shy;та&shy;риев (и, понят&shy;ное дело, не полу&shy;чить). Сей&shy;час же можно: дорога открыта для грам&shy;мар-наци. Вто&shy;рой бене&shy;фит, кото&shy;рый ожи&shy;дался  &mdash;  это пред&shy;ло&shy;же&shy;ние нового и полез&shy;ного фун&shy;кци&shy;о&shy;нала в гото&shy;вом виде. Этот бене&shy;фит, нас&shy;колько я знаю, время от вре&shy;мени также сра&shy;ба&shy;ты&shy;вает, но это очень ред&shy;кие кейсы. Нап&shy;ри&shy;мер, один раз&shy;ра&shy;бот&shy;чик очень уско&shy;рил полу&shy;че&shy;ние сим&shy;вола по индексу в строке. Как выяс&shy;ни&shy;лось, ранее это рабо&shy;тало не очень эффек&shy;тивно.</p>
<div class="aside-side-container side-regular-block">
<p >
Член&shy;ство в .NET Foun&shy;da&shy;tion сей&shy;час зара&shy;ба&shy;ты&shy;ва&shy;ется плот&shy;ной рабо&shy;той и инте&shy;рес&shy;ными ком&shy;ми&shy;тами. Хоро&shy;шее дело можно зате&shy;ять, обра&shy;тив&shy;шись в код ком&shy;пи&shy;ля&shy;тора мето&shy;дов (JIT) и опти&shy;ми&shy;зи&shy;ро&shy;вать какой-либо поль&shy;зо&shy;ва&shy;т&shy;ельский слу&shy;чай. Нап&shy;ри&shy;мер, авто&shy;ма&shy;ти&shy;чес&shy;кая век&shy;то&shy;ри&shy;за&shy;ция каких-то расчётов.</p>
</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">03</div>
<p >
Наш расс&shy;каз про менедж&shy;мент памяти будет идти от общего к част&shy;ному. Т.е. для начала мы пос&shy;мот&shy;рим на алго&shy;ритмы с высоты птич&shy;ьего полёта не сильно вда&shy;ва&shy;ясь в под&shy;роб&shy;ности. Ведь если мы нач&shy;нем сразу с под&shy;роб&shy;нос&shy;тей, придётся делать отсылки к буду&shy;щим гла&shy;вам, а оттуда  &mdash;  обратно в ран&shy;ние главы. Это крайне не удобно как для напи&shy;са&shy;ния, так и в чте&shy;нии. Нап&shy;ро&shy;тив: сде&shy;лав ввод&shy;ную мы пой&shy;мем все основы. А потом  &mdash;  нач&shy;нем пог&shy;ру&shy;жаться в детали.</p>
<div class="paragraph-right-side">03</div>
</div>
<h2 id="section-2">Введение в управление памятью</h2>
<div class="paragraph-container">
<div class="paragraph-left-side">04</div>
<p >
Мы пишем раз&shy;ные прог&shy;раммы: кон&shy;соль&shy;ные, сер&shy;висы, web-сер&shy;висы и дру&shy;гие. Все они рабо&shy;тают при&shy;мерно оди&shy;на&shy;ково. Но есть очень важ&shy;ное отли&shy;чие  &mdash;  это стиль работы с памятью. Кон&shy;соль&shy;ные при&shy;ло&shy;же&shy;ния, ско&shy;рее всего, рабо&shy;тают в рам&shy;ках базо&shy;вой, выде&shy;лен&shy;ной при старте при&shy;ло&shy;же&shy;ния, памяти. Такое при&shy;ло&shy;же&shy;ние всю или час&shy;тично ее исполь&shy;зует и больше ничего не зап&shy;ро&shy;сит: запус&shy;ти&shy;лось и вышло. Иногда речь идет о сер&shy;ви&shy;сах, кото&shy;рые долго рабо&shy;тают, пере&shy;ра&shy;ба&shy;ты&shy;вают память пос&shy;то&shy;янно. И делают это не по изо&shy;ли&shy;ро&shy;ван&shy;ным зап&shy;ро&shy;сам, в отли&shy;чие от сер&shy;ви&shy;сов ASP.NET и WCF (кото&shy;рые мы выз&shy;вали, из базы что-то дос&shy;тали и забыли). А именно как какой-то расчётный сер&shy;вис: есть поток дан&shy;ных на вход, с кото&shy;рыми сер&shy;вис рабо&shy;тает и так может рабо&shy;тать очень долго, выде&shy;ляя и осво&shy;бож&shy;дая память. И это уже совер&shy;шенно дру&shy;гой стиль рас&shy;хода памяти: ведь в этом слу&shy;чае память необ&shy;хо&shy;димо конт&shy;ро&shy;ли&shy;ро&shy;вать, смот&shy;реть как она рас&shy;хо&shy;ду&shy;ется, течет или не течет.</p>
<div class="paragraph-right-side">04</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">05</div>
<p >
А если это ASP.NET, то это уже тре&shy;тий спо&shy;соб управ&shy;ле&shy;ния памятью. Надо пони&shy;мать, что нас выз&shy;вал внеш&shy;ний код, мы отра&shy;бо&shy;таем дос&shy;та&shy;точно быс&shy;тро и исчез&shy;нем. Отсюда, если мы во время зап&shy;роса выде&shy;ляем неко&shy;то&shy;рую память, можно сде&shy;лать всё так, чтобы не вол&shy;но&shy;ваться по поводу её осво&shy;бож&shy;де&shy;ния: ведь метод завер&shy;шит свою работу и все объ&shy;екты поте&shy;ряют свои корни: локаль&shy;ные пере&shy;мен&shy;ные метода, обра&shy;ба&shy;ты&shy;ва&shy;ю&shy;щего зап&shy;рос. Но и рас&shy;то&shy;чи&shy;т&shy;ельством зани&shy;маться не стоит: при высо&shy;кой наг&shy;рузке вы полу&shy;чите траф&shy;фик объ&shy;ек&shy;тов. Воз&shy;можно, часть объ&shy;ек&shy;тов стоит сде&shy;лать струк&shy;ту&shy;рами?</p>
<div class="paragraph-right-side">05</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">06</div>
<p >
Как же этим всем управ&shy;лять? С точки зре&shy;ния раз&shy;ра&shy;ботки Garbage Collector'а, с точки зре&shy;ния сис&shy;темы менедж&shy;мента памяти у нас есть совер&shy;шенно раз&shy;ные стили и мы дол&shy;жны в них иде&shy;ально хорошо рабо&shy;тать. У нас же может быть машина, на кото&shy;рой запус&shy;ти&shy;лось кон&shy;соль&shy;ное при&shy;ло&shy;же&shy;ние, а есть машина, на кото&shy;рой при&shy;ло&shy;же&shy;ние заби&shy;рает 256 Гб. Эти сис&shy;темы помимо раз&shy;ли&shy;чия в объёме пожи&shy;ра&shy;е&shy;мой памяти также отли&shy;ча&shy;ются по ряду дру&shy;гих приз&shy;на&shy;ков: нап&shy;ри&shy;мер, в стиле её выде&shy;ле&shy;ния и осво&shy;бож&shy;де&shy;ния путём обну&shy;ле&shy;ния ссы&shy;лок (или их ненуж&shy;ности. при выходе из метода локаль&shy;ные пере&shy;мен&shy;ные более не нужны, но они не обну&shy;ля&shy;ются). Поэ&shy;тому, для начала надо как-то клас&shy;си&shy;фи&shy;ци&shy;ро&shy;вать эту память: а от клас&shy;си&shy;фи&shy;ка&shy;ции памяти тан&shy;це&shy;вать в сто&shy;рону опти&shy;ми&shy;за&shy;ции её выде&shy;ле&shy;ния и осво&shy;бож&shy;де&shy;ния в зави&shy;си&shy;мости от того, с каким клас&shy;сом памяти мы в дан&shy;ный момент рабо&shy;таем.</p>
<div class="paragraph-right-side">06</div>
</div>
<h2 id="section-3">Возможные классификации памяти исходя из логики</h2>
<div class="paragraph-container">
<div class="paragraph-left-side">07</div>
<p >
Как можно клас&shy;си&shy;фи&shy;ци&shy;ро&shy;вать память? Чисто инту&shy;итивно можно раз&shy;де&shy;лять выде&shy;ля&shy;е&shy;мые учас&shy;тки памяти исходя из раз&shy;ме&shy;ров объ&shy;екта, кото&shy;рый выде&shy;ля&shy;ется. Нап&shy;ри&shy;мер, понятно, что если мы гово&shy;рим о боль&shy;ших струк&shy;ту&shy;рах дан&shy;ных, то управ&shy;лять ими надо совер&shy;шенно по-дру&shy;гому, нежели малень&shy;кими: потому что они тяже&shy;лые и их трудно пере&shy;ме&shy;щать при надоб&shy;ности. А малень&shy;кие, соот&shy;ветст&shy;венно, зани&shy;мают мало места и из-за того, что они обра&shy;зуют группы, пере&shy;ме&shy;щать легко. Однако из-за того что их нам&shy;ного больше, ими тяже&shy;лее управ&shy;лять: знать о поло&shy;же&shy;нии в памяти каж&shy;дого из них. А зна&shy;чит, для них без вся&shy;кой ста&shy;тис&shy;тики и так понятно, что дол&shy;жен быть дру&shy;гой под&shy;ход.</p>
<div class="paragraph-right-side">07</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">08</div>
<p >
Если раз&shy;де&shy;лять по вре&shy;мени жизни, то тут тоже воз&shy;ни&shy;кают идеи. Нап&shy;ри&shy;мер, если объ&shy;екты корот&shy;ко&shy;жи&shy;ву&shy;щие, то, воз&shy;можно, к ним надо чаще прис&shy;мат&shy;ри&shy;ваться, чтобы побыс&shy;т&shy;рее от них избав&shy;ляться (жела&shy;тельно, сразу, как только они стали не нужны). Если объ&shy;екты дол&shy;го&shy;жи&shy;ву&shy;щие, то можно уже пос&shy;мот&shy;реть на ста&shy;тис&shy;тику. Нап&shy;ри&shy;мер, можно пофан&shy;та&shy;зи&shy;ро&shy;вать и решить, что эту область памяти ана&shy;ли&shy;зи&shy;ро&shy;вать на пред&shy;мет ненуж&shy;ных объ&shy;ек&shy;тов можно и пореже: ведь боль&shy;шие объ&shy;екты редко соз&shy;дают траф&shy;фик в памяти. А если смот&shy;реть редко, это сок&shy;ра&shy;щает время на сборку мусора сумме, но уве&shy;ли&shy;чи&shy;вает  &mdash;  каж&shy;дый вызов GC.</p>
<div class="paragraph-right-side">08</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">09</div>
<p >
Или же по типу дан&shy;ных. Можно легко пред&shy;по&shy;ло&shy;жить, что все типы, кото&shy;рые отнас&shy;ле&shy;до&shy;ваны от типа <code>Attribute</code> или в зоне <code>Reflection</code>, будут жить почти всегда вечно. Или строки, кото&shy;рые предс&shy;тав&shy;ляют собой мас&shy;сив сим&shy;во&shy;лов: к ним тоже может быть свой под&shy;ход.</p>
<div class="paragraph-right-side">09</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">10</div>
<p >
Видов может быть сколько угодно много и в зави&shy;си&shy;мости от клас&shy;си&shy;фи&shy;ка&shy;ций может ока&shy;заться, что управ&shy;ле&shy;ние памятью для конк&shy;рет&shy;ной клас&shy;си&shy;фи&shy;ка&shy;ции может быть более эффек&shy;тивно, если учи&shy;ты&shy;вать её осо&shy;бен&shy;ности.</p>
<div class="paragraph-right-side">10</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">11</div>
<p >
Когда соз&shy;да&shy;вали архи&shy;тек&shy;туру нашего GC, то выб&shy;рали пер&shy;вые два вида клас&shy;си&shy;фи&shy;ка&shy;ций: раз&shy;мер и время жизни (хотя, если прис&shy;мот&shy;реться к деле&shy;нию типов на классы и струк&shy;туры, то можно поду&shy;мать, что клас&shy;си&shy;фи&shy;ка&shy;ции на самом деле три. Однако, раз&shy;ли&shy;чие свойств клас&shy;сов и струк&shy;тур можно свести к раз&shy;меру и вре&shy;мени жизни).</p>
<div class="paragraph-right-side">11</div>
</div>
<h2 id="section-4">Как это работает у нас. Обоснование выбора архитекторов</h2>
<div class="paragraph-container">
<div class="paragraph-left-side">12</div>
<p >
Если мы с вами будем дос&shy;ко&shy;нально раз&shy;би&shy;раться, почему были выб&shy;раны именно эти два алго&shy;ритма управ&shy;ле&shy;ния памятью: <em>Sweep</em> и <em>Compact</em>, нам для этого придётся расс&shy;мат&shy;ри&shy;вать десятки алго&shy;рит&shy;мов управ&shy;ле&shy;ния памятью, кото&shy;рые сущес&shy;твуют в мире: начи&shy;ная обыч&shy;ными сло&shy;ва&shy;рями, закан&shy;чи&shy;вая очень слож&shy;ными lock-free струк&shy;ту&shy;рами. Вместо этого, оста&shy;вив голову мыс&shy;лям о полез&shy;ном, мы просто <em>обоснуем</em> выбор и тем самым <em>поймём</em>, почему выбор был сде&shy;лан именно таким. Мы более не смот&shy;рим в рек&shy;лам&shy;ный бук&shy;лет ракеты-носи&shy;теля: у нас на руках пол&shy;ный набор доку&shy;мен&shy;та&shy;ции.</p>
<div class="paragraph-right-side">12</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">13</div>
<p >
<a id="fnref:0" href="#fn:" class="footnote-ref"><sup></sup></a> Я выб&shy;рал фор&shy;мат рас&shy;суж&shy;де&shy;ния чтобы вы почувс&shy;тв&shy;овали себя архи&shy;тек&shy;то&shy;рами плат&shy;формы и сами пришли к тем же самым выво&shy;дам, к каким пришли реальные архи&shy;тек&shy;торы в штаб-квар&shy;тире Micro&shy;soft в Рэд&shy;монде.</p>
<div class="paragraph-right-side">13</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">14</div>
<p >
Опре&shy;де&shy;лимся с тер&shy;ми&shy;но&shy;ло&shy;гией: менедж&shy;мент памяти  &mdash;  это струк&shy;тура дан&shy;ных и ряд алго&shy;рит&shy;мов, кото&shy;рые поз&shy;во&shy;ляют &laquo;выде&shy;лять&raquo; память и отда&shy;вать её внеш&shy;нему пот&shy;ре&shy;би&shy;телю и осво&shy;бож&shy;дать её, регист&shy;ри&shy;руя как сво&shy;бод&shy;ный учас&shy;ток. Т.е. если взять, нап&shy;ри&shy;мер, какой-то мас&shy;сив байт (линей&shy;ный кусок памяти), напи&shy;сать алго&shy;ритмы раз&shy;метки мас&shy;сива на объ&shy;екты .NET (зап&shy;ро&shy;сили новый объ&shy;ект: мы подс&shy;чи&shy;тали его раз&shy;мер, поме&shy;тили у себя что этот вот кусок и есть новый объ&shy;ект, отдали ука&shy;за&shy;тель на объ&shy;ект внеш&shy;ней сто&shy;роне) и алго&shy;ритмы осво&shy;бож&shy;де&shy;ния памяти (когда нам гово&shy;рят, что объ&shy;ект более не нужен, а потому память из-под него можно выдать кому-то дру&shy;гому).</p>
<div class="paragraph-right-side">14</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">15</div>
<p >
Исходя из клас&shy;си&shy;фи&shy;ка&shy;ции выде&shy;ля&shy;е&shy;мых объ&shy;ек&shy;тов на осно&shy;ва&shy;нии их раз&shy;мера можно раз&shy;де&shy;лить места под выде&shy;ле&shy;ние памяти на два боль&shy;ших раз&shy;дела: на место с объ&shy;ек&shy;тами раз&shy;ме&shy;ром ниже опре&shy;де&shy;лен&shy;ного порога и на место с раз&shy;ме&shy;ром выше этого порога и пос&shy;мот&shy;реть, какую раз&shy;ницу можно внести в управ&shy;ле&shy;ние этими груп&shy;пами (исходя из их раз&shy;мера) и что из этого вый&shy;дет. Расс&shy;мот&shy;рим каж&shy;дую кате&shy;го&shy;рию в отдель&shy;ности.</p>
<div class="paragraph-right-side">15</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">16</div>
<p >
Если расс&shy;мат&shy;ри&shy;вать воп&shy;росы <strong>управления условно</strong> &laquo;<em>маленьких</em>&raquo; объ&shy;ек&shy;тов, то можно заме&shy;тить, что если при&shy;дер&shy;жи&shy;ваться идеи сох&shy;ра&shy;не&shy;ния инфор&shy;ма&shy;ции о каж&shy;дом объ&shy;екте, нам будет очень дорого под&shy;дер&shy;жи&shy;вать струк&shy;туры дан&shy;ных управ&shy;ле&shy;ния памятью, кото&shy;рые будут хра&shy;нить в себе ссылки на каж&shy;дый такой объ&shy;ект. В конеч&shy;ном счёте может ока&shy;заться, что для того, чтобы хра&shy;нить инфор&shy;ма&shy;цию об одном объ&shy;екте пона&shy;до&shy;бится столько же памяти, сколько зани&shy;мает сам объ&shy;ект. Вместо этого стоит поду&shy;мать: если при сборке мусора мы будем поме&shy;чать дос&shy;ти&shy;жи&shy;мые объ&shy;екты обхо&shy;дом графа объ&shy;ек&shy;тов (понять это легко, зная, откуда начи&shy;нать обход графа), а линей&shy;ный про&shy;ход по куче нам пона&shy;до&shy;бится <em>только</em> для иден&shy;ти&shy;фи&shy;ка&shy;ции всех осталь&shy;ных, т.е. мусор&shy;ных объ&shy;ек&shy;тов, так ли нам необ&shy;хо&shy;димо в алго&shy;рит&shy;мах менедж&shy;мента памяти хра&shy;нить инфор&shy;ма&shy;цию о каж&shy;дом объ&shy;екте? Ответ оче&shy;ви&shy;ден: надоб&shy;ности в этом нет ника&shy;кой. Ведь если мы будем раз&shy;ме&shy;щать объ&shy;екты друг за дру&shy;гом и при этом сде&shy;лать воз&shy;мож&shy;ным узнать раз&shy;мер каж&shy;дого из них, сде&shy;лать ите&shy;ра&shy;тор кучи очень просто:</p>
<div class="paragraph-right-side">16</div>
</div>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">var</span> current = memory_start;

<span style="color:Blue;">while</span>(current &lt; memory_end)
{
    <span style="color:Blue;">var</span> size = current.typeInfo.size;
    current += size;
}
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">17</div>
<p >
А зна&shy;чит, можно поп&shy;ро&shy;бо&shy;вать исхо&shy;дить из того, что такую инфор&shy;ма&shy;цию мы хра&shy;нить не дол&shy;жны: пройти кучу мы можем линейно, зная раз&shy;мер каж&shy;дого объ&shy;екта и сме&shy;щая ука&shy;за&shy;тель каж&shy;дый раз на раз&shy;мер оче&shy;ред&shy;ного объ&shy;екта.</p>
<div class="paragraph-right-side">17</div>
</div>
<blockquote>
<p >
В куче нет допол&shy;ни&shy;тель&shy;ных струк&shy;тур дан&shy;ных, кото&shy;рые хра&shy;нят ука&shy;за&shy;тели на каж&shy;дый объ&shy;ект, кото&shy;рым управ&shy;ляет куча.</p>
</blockquote>
<div class="paragraph-container">
<div class="paragraph-left-side">18</div>
<p >
Однако, тем не менее, когда память нам более не нужна, мы дол&shy;жны её осво&shy;бож&shy;дать. А при осво&shy;бож&shy;де&shy;нии памяти нам ста&shy;но&shy;вится трудно пола&shy;гаться на линей&shy;ное про&shy;хож&shy;де&shy;ние кучи: это долго и не эффек&shy;тивно. Как след&shy;с&shy;твие, мы при&shy;хо&shy;дим к мысли, что надо как-то хра&shy;нить инфор&shy;ма&shy;цию о сво&shy;бод&shy;ных участ&shy;ках памяти.</p>
<div class="paragraph-right-side">18</div>
</div>
<blockquote>
<p >
В куче есть списки сво&shy;бод&shy;ных участ&shy;ков памяти: набор ука&shy;за&shy;те&shy;лей на их начала + раз&shy;мер.</p>
</blockquote>
<div class="paragraph-container">
<div class="paragraph-left-side">19</div>
<p >
Если, как мы решили, хра&shy;нить инфор&shy;ма&shy;цию о сво&shy;бод&shy;ных участ&shy;ках, и при этом при осво&shy;бож&shy;де&shy;нии памяти из под объ&shy;ек&shy;тов эти учас&shy;тки ока&shy;за&shy;лись слиш&shy;ком малы для раз&shy;ме&shy;ще&shy;ния в них чего-либо полез&shy;ного, то во-пер&shy;вых мы при&shy;хо&shy;дим к той-же проб&shy;леме хра&shy;не&shy;ния инфор&shy;ма&shy;ции о сво&shy;бод&shy;ных участ&shy;ках, с кото&shy;рой столк&shy;ну&shy;лись при расс&shy;мот&shy;ре&shy;нии заня&shy;тых: хра&shy;нить инфор&shy;ма&shy;цию о таких малы&shy;шах может ока&shy;заться слиш&shy;ком дорого. Это снова зву&shy;чит рас&shy;то&shy;чи&shy;тельно, сог&shy;ла&shy;си&shy;тесь: не всегда выпа&shy;дает удача осво&shy;бож&shy;де&shy;ния группы объ&shy;ек&shy;тов, сле&shy;ду&shy;ю&shy;щих друг за дру&shy;гом. Обычно они осво&shy;бож&shy;да&shy;ются в хаотич&shy;ном порядке, обра&shy;зуя неболь&shy;шие прос&shy;веты сво&shy;бод&shy;ной памяти, где сложно выде&shy;лить что-либо ещё. Но всё-таки в отли&shy;чии от заня&shy;тых участ&shy;ков, кото&shy;рые нам нет надоб&shy;ности линейно искать, искать сво&shy;бод&shy;ные учас&shy;тки нам необ&shy;хо&shy;димо потому что при выде&shy;ле&shy;нии памяти они нам снова могут пона&shy;до&shy;биться. А потому воз&shy;ни&shy;кает вполне естест&shy;вен&shy;ное жела&shy;ние умень&shy;шить фраг&shy;мен&shy;та&shy;цию и сжать кучу, пере&shy;мес&shy;тив все заня&shy;тые учас&shy;тки на места сво&shy;бод&shy;ных, обра&shy;зо&shy;вав тем самым боль&shy;шую зону сво&shy;бод&shy;ного учас&shy;тка, где можно совер&shy;шенно спо&shy;койно выде&shy;лять память.</p>
<div class="paragraph-right-side">19</div>
</div>
<blockquote>
<p >
Отсюда рож&shy;да&shy;ется идея алго&shy;ритма сжа&shy;тия кучи Compac&shy;ting.</p>
</blockquote>
<div class="paragraph-container">
<div class="paragraph-left-side">20</div>
<p >
Но, подож&shy;дите, ска&shy;жите вы. Ведь эта опе&shy;ра&shy;ция может быть очень тяжёлой. Предс&shy;тавьте только, что вы осво&shy;бо&shy;дили объ&shy;ект в самом начале кучи. И что, ска&shy;жете вы, надо дви&shy;гать вообще всё?? Ну конечно, можно пофан&shy;та&shy;зи&shy;ро&shy;вать на тему век&shy;тор&shy;ных инстр&shy;укций CPU, кото&shy;рыми можно вос&shy;поль&shy;зо&shy;ваться для копи&shy;ро&shy;ва&shy;ния огром&shy;ного заня&shy;того учас&shy;тка памяти. Но это ведь только начало работы. Надо ещё испра&shy;вить все ука&shy;за&shy;тели с полей объ&shy;ек&shy;тов на объ&shy;екты, кото&shy;рые под&shy;верг&shy;лись перед&shy;ви&shy;же&shy;ниям. Эта опе&shy;ра&shy;ция может занять дичайше дли&shy;тель&shy;ное время. Нет, надо исхо&shy;дить из чего-то дру&shy;гого. Нап&shy;ри&shy;мер, раз&shy;де&shy;лив весь отре&shy;зок памяти кучи на сек&shy;тора и рабо&shy;тать с ними по отдель&shy;ности. Если рабо&shy;тать отдельно в каж&shy;дом сек&shy;торе (для предс&shy;ка&shy;зу&shy;емости вре&shy;мени работы алго&shy;рит&shy;мов и масш&shy;та&shy;би&shy;ро&shy;ва&shy;ния этой предс&shy;каз&shy;му&shy;емости  &mdash;  жела&shy;тельно, фик&shy;си&shy;ро&shy;ван&shy;ных раз&shy;ме&shy;ров), идея сжа&shy;тия уже не кажется такой уж тяжёлой: дос&shy;та&shy;точно сжать отдельно взя&shy;тый сек&shy;тор и тогда можно даже начать рас&shy;суж&shy;дать о вре&shy;мени, кото&shy;рое необ&shy;хо&shy;димо для сжа&shy;тия одного такого сек&shy;тора.</p>
<div class="paragraph-right-side">20</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">21</div>
<p >
Теперь оста&shy;лось понять, на осно&shy;ва&shy;нии чего делить на сек&shy;тора. Тут надо обра&shy;титься ко вто&shy;рой клас&shy;си&shy;фи&shy;ка&shy;ции, кото&shy;рая вве&shy;дена на плат&shy;форме: раз&shy;де&shy;ле&shy;ние памяти, исходя из вре&shy;мени жизни отдель&shy;ных её эле&shy;мен&shy;тов.</p>
<div class="paragraph-right-side">21</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">22</div>
<p >
Деле&shy;ние прос&shy;тое: если учесть, что выде&shy;лять память мы будем по мере воз&shy;рас&shy;та&shy;ния адре&shy;сов, то пер&shy;вые выде&shy;лен&shy;ные объ&shy;екты (в млад&shy;ших адре&shy;сах) ста&shy;но&shy;вятся самыми ста&shy;рыми, а те, что нахо&shy;дятся в стар&shy;ших адре&shy;сах  &mdash;  самыми моло&shy;дыми. Далее, про&shy;я&shy;вив сме&shy;калку, можно прийти к выво&shy;дам, что в при&shy;ло&shy;же&shy;ниях объ&shy;екты делятся на две группы: те, что соз&shy;дали для дол&shy;гой жизни и те, кото&shy;рые были соз&shy;даны жить очень мало. Нап&shy;ри&shy;мер, для вре&shy;мен&shy;ного хра&shy;не&shy;ния ука&shy;за&shy;те&shy;лей на дру&shy;гие объ&shy;екты в виде кол&shy;лек&shy;ции. Или те же DTO объ&shy;екты. Соот&shy;ветст&shy;венно, время от вре&shy;мени сжи&shy;мая кучу мы полу&shy;чаем ряд дол&shy;го&shy;жи&shy;ву&shy;щих объ&shy;ек&shy;тов  &mdash;  в млад&shy;ших адре&shy;сах и ряд корот&shy;ко&shy;жи&shy;ву&shy;щих  &mdash;  в стар&shy;ших.</p>
<div class="paragraph-right-side">22</div>
</div>
<blockquote>
<p >
Таким обра&shy;зом мы полу&shy;чили <em>поколения</em>.</p>
</blockquote>
<div class="paragraph-container">
<div class="paragraph-left-side">23</div>
<p >
Раз&shy;де&shy;лив память на поко&shy;ле&shy;ния, мы полу&shy;чаем воз&shy;мож&shy;ность реже заг&shy;ля&shy;ды&shy;вать за сбор&shy;кой мусора в объ&shy;екты стар&shy;шего поко&shy;ле&shy;ния, кото&shy;рых ста&shy;но&shy;вится всё больше и больше.</p>
<div class="paragraph-right-side">23</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">24</div>
<p >
Но воз&shy;ни&shy;кает еще один воп&shy;рос: если мы будем иметь всего два поко&shy;ле&shy;ния, мы полу&shy;чим проб&shy;лемы:</p>
<div class="paragraph-right-side">24</div>
</div>
<ul>
<li>
<p >
Либо мы будем ста&shy;раться, чтобы GC отра&shy;ба&shy;ты&shy;вал мак&shy;си&shy;мально быс&shy;тро: тогда раз&shy;мер <em>младшего поколения мы будем стараться делать минимальных размеров</em>. Как резуль&shy;тат  &mdash;  недавно соз&shy;дан&shy;ные объ&shy;екты при вызове GC будут слу&shy;чайно ухо&shy;дить в стар&shy;шее поко&shy;ле&shy;ние (если GC сра&shy;бо&shy;тал &laquo;прям вот сей&shy;час, во время ярост&shy;ного выде&shy;ле&shy;ния памяти под мно&shy;жес&shy;тво объ&shy;ек&shy;тов&raquo;), хотя если бы он сра&shy;бо&shy;тал чуть позже, они бы оста&shy;лись в млад&shy;шем, где были бы соб&shy;раны за корот&shy;кие сроки.</p>
</li>
<li>
<p >
Либо, чтобы мини&shy;ми&shy;зи&shy;ро&shy;вать такое слу&shy;чай&shy;ное &laquo;про&shy;ва&shy;ли&shy;ва&shy;ние&raquo;, мы <em>увеличим размер младшего поколения</em>. Однако, в этом слу&shy;чае GC на млад&shy;шем поко&shy;ле&shy;нии будет рабо&shy;тать дос&shy;та&shy;точно долго, замед&shy;ляя и под&shy;тор&shy;ма&shy;жи&shy;вая тем самым всё при&shy;ло&shy;же&shy;ние.</p>
</li>
</ul>
<div class="paragraph-container">
<div class="paragraph-left-side">25</div>
<p >
Выход  &mdash;  вве&shy;де&shy;ние &laquo;сред&shy;него&raquo; поко&shy;ле&shy;ния. Под&shy;рост&shy;ко&shy;вого. Суть его вве&shy;де&shy;ния сво&shy;дится к полу&shy;че&shy;нию баланса между <em>получением минимального по размеру младшего поколения</em> и <em>максимально-стабильного старшего поколения</em>, где лучше ничего не тро&shy;гать. Это  &mdash;  зона, где судьба объ&shy;ек&shy;тов еще не решена. Пер&shy;вое (не забы&shy;ваем, что мы счи&shy;таем с нуля) поко&shy;ле&shy;ние соз&shy;да&shy;ется также неболь&shy;шим, но чуть круп&shy;нее, чем млад&shy;шее и потому GC туда заг&shy;ля&shy;ды&shy;вает реже. Он тем самым дает воз&shy;мож&shy;ность объ&shy;ек&shy;там, кото&shy;рые нахо&shy;дятся во вре&shy;мен&shy;ном, &laquo;под&shy;рост&shy;ко&shy;вом&raquo; поко&shy;ле&shy;нии, не уйти в стар&shy;шее поко&shy;ле&shy;ние, кото&shy;рое соби&shy;рать крайне тяжело.</p>
<div class="paragraph-right-side">25</div>
</div>
<blockquote>
<p >
Так мы полу&shy;чили идею трёх поко&shy;ле&shy;ний.</p>
</blockquote>
<div class="paragraph-container">
<div class="paragraph-left-side">26</div>
<p >
Сле&shy;ду&shy;ю&shy;щий слой опти&shy;ми&shy;за&shy;ции  &mdash;  попытка отка&shy;заться от сжа&shy;тия. Ведь если его не делать, мы избав&shy;ля&shy;емся от огром&shy;ного пласта работы. Вер&shy;немся к воп&shy;росу сво&shy;бод&shy;ных участ&shy;ков.</p>
<div class="paragraph-right-side">26</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">27</div>
<p >
Если после того, как мы израс&shy;хо&shy;до&shy;вали всю дос&shy;туп&shy;ную в куче память и был выз&shy;ван GC, воз&shy;ни&shy;кает естест&shy;вен&shy;ное жела&shy;ние отка&shy;заться от сжа&shy;тия в пользу даль&shy;ней&shy;шего выде&shy;ле&shy;ния памяти внутри осво&shy;бо&shy;див&shy;шихся участ&shy;ков, если их раз&shy;мер дос&shy;та&shy;то&shy;чен для раз&shy;ме&shy;ще&shy;ния неко&shy;то&shy;рого коли&shy;чес&shy;тва объ&shy;ек&shy;тов. Тут мы при&shy;хо&shy;дим к идее вто&shy;рого алго&shy;ритма осво&shy;бож&shy;де&shy;ния памяти в GC, кото&shy;рый назы&shy;ва&shy;ется <code>Sweep</code>: память не сжи&shy;маем, для раз&shy;ме&shy;ще&shy;ния новых объ&shy;ек&shy;тов исполь&shy;зуем пус&shy;тоты от осво&shy;бож&shy;ден&shy;ных объ&shy;ек&shy;тов.</p>
<div class="paragraph-right-side">27</div>
</div>
<blockquote>
<p >
Так мы опи&shy;сали и обос&shy;но&shy;вали все основы алго&shy;рит&shy;мов GC.</p>
</blockquote>
<div class="paragraph-container">
<div class="paragraph-left-side">28</div>
<p >
Далее спус&shy;каться мы не будем, иначе я не оставлю себе почвы для раз&shy;мыш&shy;ле&shy;ний. Замечу только, что мы расс&shy;мот&shy;рели все пред&shy;по&shy;сылки и выводы к сущес&shy;тву&shy;ю&shy;щим алго&shy;рит&shy;мам менедж&shy;мента памяти.</p>
<div class="paragraph-right-side">28</div>
</div>
<h2 id="section-5">Как это работает у нас</h2>
<div class="paragraph-container">
<div class="paragraph-left-side">29</div>
<p >
Теперь мы зайдём с дру&shy;гой сто&shy;роны. Я буду выпо&shy;ли&shy;ро&shy;вы&shy;вать факты так, что даже если у вас пло&shy;хая память на вычитке тек&shy;ста, вы всё равно запом&shy;ните, как рабо&shy;тает менедж&shy;мент памяти в .NET.</p>
<div class="paragraph-right-side">29</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">30</div>
<p >
Итак, мы знаем, что у нас сущес&shy;твует два спо&shy;соба клас&shy;си&shy;фи&shy;ци&shy;ро&shy;вать память: исходя из вре&shy;мени жизни сущ&shy;нос&shy;тей и исходя из их раз&shy;мера. Поду&shy;маем, что мы имеем, исходя из раз&shy;ме&shy;ров объ&shy;ек&shy;тов. Если у нас объ&shy;екты имеют боль&shy;шие раз&shy;меры, то нам не выгодно часто делать <code>Сompact</code>. Потому что в этом слу&shy;чае мы все объ&shy;екты пере&shy;тас&shy;ки&shy;ваем на осво&shy;бо&shy;див&shy;ши&shy;еся учас&shy;тки. То есть копи&shy;руем их. А если объ&shy;ект огро&shy;мен, то копи&shy;ро&shy;вать дорого и каж&shy;дый раз при&shy;бе&shy;гая к сжа&shy;тию кучи можно сильно про&shy;сесть по про&shy;из&shy;во&shy;ди&shy;тель&shy;ности. В дан&shy;ной ситу&shy;а&shy;ции удо&shy;бен только <code>Sweep</code>. Об этом спо&shy;собе мы под&shy;робно пого&shy;во&shy;рим позже, но если сов&shy;сем коротко, то память осво&shy;бож&shy;да&shy;ется и сво&shy;бод&shy;ный кусок сох&shy;ра&shy;ня&shy;ется в спи&shy;сок сво&shy;бод&shy;ных участ&shy;ков и дальше пере&shy;ис&shy;поль&shy;зу&shy;ется при выде&shy;ле&shy;нии объ&shy;ек&shy;тов. Вызов <code>Compact</code> может быть выго&shy;ден в ред&shy;ких слу&shy;чаях: когда <em>есть понимание</em>, что из-за <code>Sweep</code> и траф&shy;фика буфе&shy;ров боль&shy;шого раз&shy;мера сущес&shy;твует неко&shy;то&shy;рая фраг&shy;мен&shy;та&shy;ция в зоне круп&shy;ных объ&shy;ек&shy;тов (Large Objects Heap. Давайте уже начнём назы&shy;вать вещи сво&shy;ими име&shy;нами). И руч&shy;ной вызов GC с ука&shy;за&shy;нием метода сбора мусора <code>Compact</code> в этом слу&shy;чае может нам помочь. Однако, давайте не будем углуб&shy;ляться: у нас для этого есть очень много вре&shy;мени.</p>
<div class="paragraph-right-side">30</div>
</div>
<blockquote>
<p >
Оста&shy;но&shy;вимся лишь на том, что в <code>LOH</code> метод сбора мусора <code>Sweep</code> имеет абсо&shy;лют&shy;ное пре&shy;и&shy;му&shy;щес&shy;тво перед <code>Compact</code></p>
</blockquote>
<div class="paragraph-container">
<div class="paragraph-left-side">31</div>
<p >
А если объ&shy;екты малень&shy;кие, то нао&shy;бо&shy;рот: хоть и не всегда, но удо&shy;бен <code>Compact</code>. Нап&shy;ри&shy;мер, у нас была куча объ&shy;ек&shy;тов и мы поте&shy;ряли ссылку на объ&shy;екты через одного, и полу&shy;ча&shy;ется, что заня&shy;тые учас&shy;тки и сво&shy;бод&shy;ные чере&shy;ду&shy;ются, нап&shy;ри&shy;мер по 24 байта. И может так ока&shy;заться, что такими малень&shy;кими участ&shy;ками мы вос&shy;поль&shy;зо&shy;ваться не смо&shy;жем потому что дальше мы будем выде&shy;лять более круп&shy;ные объ&shy;екты. Воз&shy;ни&shy;кает дилемма: либо нара&shy;щи&shy;вать кучу либо изба&shy;виться от фраг&shy;мен&shy;та&shy;ции. Поэ&shy;тому тут, воз&shy;можно, стоит сжать кучу. Однако, если объ&shy;екты ушли на покой груп&shy;пой, то нам в дан&shy;ном слу&shy;чае по-преж&shy;нему выго&shy;ден <code>Sweep</code>, пос&shy;кольку тот не сжи&shy;мает кучу, а исполь&shy;зует для даль&shy;ней&shy;шего выде&shy;ле&shy;ния памяти осво&shy;бо&shy;див&shy;ше&shy;еся место.</p>
<div class="paragraph-right-side">31</div>
</div>
<blockquote>
<p >
Отсюда можно сде&shy;лать прос&shy;той вывод: в обоих кучах память управ&shy;ля&shy;ется оди&shy;на&shy;ково. Но в LOH в отли&shy;чии от SOH отклю&shy;чен авто&shy;ма&shy;ти&shy;чес&shy;кий вызов <code>Compact</code>. Он дос&shy;ту&shy;пен только для пря&shy;мого вызова.</p>
</blockquote>
<div class="paragraph-container">
<div class="paragraph-left-side">32</div>
<p >
Тут воз&shy;ни&shy;кает проб&shy;лема: у нас есть хип малень&shy;ких объ&shy;ек&shy;тов и хип боль&shy;ших. Они, соот&shy;ветст&shy;венно, раз&shy;де&shy;лены. Но по факту мы всегда выде&shy;ляем малень&shy;кие объ&shy;екты. Их в любом слу&shy;чае будет больше: воз&shy;можно, мил&shy;ли&shy;оны. GC про&shy;хо&shy;дит через раз&shy;ные ста&shy;дии: ста&shy;дия пла&shy;ни&shy;ро&shy;ва&shy;ния, ста&shy;дия мар&shy;ки&shy;ровки, сбора мусора. На 200 Гб памяти, если так полу&shy;чится, любая из ста&shy;дий будет очень доро&shy;гой, а потому память надо как-то допол&shy;ни&shy;тельно сег&shy;мен&shy;ти&shy;ро&shy;вать, чтобы опти&shy;ми&shy;зи&shy;ро&shy;вать работу с ними.</p>
<div class="paragraph-right-side">32</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">33</div>
<p >
Поэ&shy;тому, вто&shy;рой тип сег&shy;мен&shy;та&shy;ции рабо&shy;тает исходя из вре&shy;мени жизни объ&shy;ек&shy;тов. Куча рас&shy;тет у нас в одном нап&shy;рав&shy;ле&shy;нии. Выде&shy;ле&shy;ние памяти дви&shy;жется от млад&shy;ших адре&shy;сов к стар&shy;шим. Соот&shy;ветст&shy;венно, при выде&shy;ле&shy;нии памяти берется ука&shy;за&shy;тель на пер&shy;вый сво&shy;бод&shy;ный учас&shy;ток и затем он сдви&shy;га&shy;ется на раз&shy;мер выде&shy;лен&shy;ного объ&shy;екта и всё: куча рас&shy;тет в одном нап&shy;рав&shy;ле&shy;нии. Отсюда, исполь&shy;зуя наши ран&shy;ние рас&shy;суж&shy;де&shy;ния можно сде&shy;лать вывод о том, как легко поде&shy;лить на три поко&shy;ле&shy;ния. Нуле&shy;вое поко&shy;ле&shy;ние  &mdash;  место, где объ&shy;екты выде&shy;ля&shy;ются. Пер&shy;вое поко&shy;ле&shy;ние  &mdash;  это место, где объ&shy;екты не были соб&shy;раны Garbage Collector, но в них пока еще нет уве&shy;рен&shy;ности: мы хотим сох&shy;ра&shy;нить ста&shy;биль&shy;ность во вто&shy;ром поко&shy;ле&shy;нии и даём объ&shy;ек&shy;там еще один шанс быть соб&shy;ран&shy;ными. И, соот&shy;ветст&shy;венно, вто&shy;рое поко&shy;ле&shy;ние, где объ&shy;екты в иде&shy;але будут нахо&shy;диться без сборки мусора.</p>
<div class="paragraph-right-side">33</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">34</div>
<p >
Как я уже гово&shy;рил, если объ&shy;екты живут долго, то туда можно реже заг&shy;ля&shy;ды&shy;вать, чтобы запус&shy;кать GC. Поэ&shy;тому, если мы сде&shy;лаем нуле&shy;вое поко&shy;ле&shy;ние опре&shy;де&shy;лен&shy;ных, малых и зара&shy;нее извест&shy;ных раз&shy;ме&shy;ров, мы смо&shy;жем обхо&shy;дить его за <em>гарантированно короткий</em> про&shy;ме&shy;жу&shy;ток вре&shy;мени. И Micro&shy;soft гаран&shy;ти&shy;рует, что нуле&shy;вое поко&shy;ле&shy;ние будет соби&shy;раться за какие-то опре&shy;де&shy;лен&shy;ные мил&shy;ли&shy;се&shy;кунды. Т.е. GC быс&shy;тро что-то сде&shy;лал и дальше пошел, а никто даже и не заме&shy;тил, что он отра&shy;бо&shy;тал.</p>
<div class="paragraph-right-side">34</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">35</div>
<p >
<code>LOH</code> имеет дру&shy;гую струк&shy;туру. Сюда попа&shy;дает все, что больше или равно 85 тыся&shy;чам байт. Цифра стран&shy;ная, но нам полезно ее знать: её можно исполь&shy;зо&shy;вать, нап&shy;ри&shy;мер, чтобы опре&shy;де&shy;лить раз&shy;мер для выде&shy;ля&shy;е&shy;мого мас&shy;сива, чтобы он не ушел в кучу боль&shy;ших объ&shy;ек&shy;тов. Если выде&shy;ля&shy;ете мас&shy;сив int-ов, то нужно грубо поде&shy;лить на четыре и полу&shy;чится при&shy;мерно 20 тысяч int-ов, кото&shy;рые туда прек&shy;расно лягут и не уйдут в LOH. Также инте&shy;ресно, что в LOH ухо&shy;дят мас&shy;сивы double от тысячи эле&shy;мен&shy;тов и выше.</p>
<div class="paragraph-right-side">35</div>
</div>
<p >
Про&shy;ве&shy;рить это все очень легко. Можно напи&shy;сать такой код:</p>
<div class="lang-csharp editor-colors"><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">var</span> arr1 = <span style="color:Blue;">new</span> <span style="color:Blue;">double</span>[999];  <span style="color:Green;">// -&gt; Gen 0</span>
<span style="color:Blue;">var</span> arr2 = <span style="color:Blue;">new</span> <span style="color:Blue;">double</span>[1000]; <span style="color:Green;">// -&gt; Gen 2</span>
</pre></div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">36</div>
<p >
и пер&shy;вый мас&shy;сив пой&shy;дет в нуле&shy;вое, а вто&shy;рой  &mdash;  во вто&shy;рое поко&shy;ле&shy;ние. Какие еще клас&shy;си&shy;фи&shy;ка&shy;ции типов сущес&shy;твуют для GC? У нас есть две основ&shy;ных, кото&shy;рые мы только что расс&shy;мот&shy;рели. Однако, хоть эта клас&shy;си&shy;фи&shy;ка&shy;ция в общем смысле нам и не дос&shy;тупна, она нам дос&shy;тупна в узком смысле: клас&shy;си&shy;фи&shy;ка&shy;ция по типу. Все мы знаем про интер&shy;ни&shy;ро&shy;ван&shy;ные строки. Если мы пред&shy;по&shy;ла&shy;гаем, что какая-то строка будет часто встр&shy;ечат&shy;ься, то ее стоит интер&shy;ни&shy;ро&shy;вать, тогда мы сэко&shy;но&shy;мим на памяти.</p>
<div class="paragraph-right-side">36</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">37</div>
<p >
Как они хра&shy;нятся? Если строка интер&shy;ни&shy;ро&shy;вана, то она хра&shy;нится как обыч&shy;ная строка в куче. Но ее надо как-то найти, чтобы про&shy;ве&shy;рить, что точно такая же строка уже сущес&shy;твует. Куча иногда может дос&shy;ти&shy;гать нес&shy;коль&shy;ких сотен гига&shy;байт и поиск будет очень доро&shy;гим реше&shy;нием. Поэ&shy;тому интер&shy;ни&shy;ро&shy;ван&shy;ные строки хра&shy;нятся отдельно (пред&shy;по&shy;ла&shy;га&shy;ется, что их будет не так много).</p>
<div class="paragraph-right-side">37</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">38</div>
<p >
У каж&shy;дого домена при этом (сис&shy;тем&shy;ного или с базо&shy;вым типом Base&shy;Domain) есть внут&shy;рен&shy;ние таб&shy;лицы, кото&shy;рая нам не дос&shy;тупны. Среди про&shy;чих сущес&shy;твует Large Heap Handle Table. Сущес&shy;твует два типа внут&shy;рен&shy;них мас&shy;си&shy;вов, осно&shy;ван&shy;ных на bucket-ах. Это мас&shy;сив ста&shy;ти&shy;ков. Име&shy;ются ввиду ста&shy;ти&shy;чес&shy;кие члены клас&shy;сов, кото&shy;рые хра&shy;нятся в мас&shy;си&shy;вах. У каж&shy;дого домена есть ссылка на мас&shy;сив ста&shy;ти&shy;ков. И дальше ячей&shy;ками явля&shy;ются ссылки на зна&shy;че&shy;ния. И еще одна  &mdash;  pinning han&shy;dles. Это таб&shy;лица запи&shy;нен&shy;ных эле&shy;мен&shy;тов. Для тех слу&shy;чаев, когда вы пину&shy;ете объ&shy;ект в памяти, можете сде&shy;лать это двумя путями. Пер&shy;вый  &mdash;  это через API, а вто&shy;рой  &mdash;  через клю&shy;че&shy;вое слово fixed в C#. Это два совер&shy;шенно раз&shy;ных меха&shy;низма.</p>
<div class="paragraph-right-side">38</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">39</div>
<p >
Соот&shy;ветст&shy;венно, исходя из вре&shy;мени жизни, из-за боль&shy;шого коли&shy;чес&shy;тва объ&shy;ек&shy;тов, SOH раз&shy;де&shy;лен на части, чтобы им было проще управ&shy;лять. Запол&shy;не&shy;ние SOH идет линейно, поэ&shy;тому ста&shy;рые объ&shy;екты живут в млад&shy;ших адре&shy;сах, све&shy;жие  &mdash;  в стар&shy;ших. Ста&shy;рые объ&shy;екты, как пра&shy;вило, живут долго. Чем дольше объ&shy;ект сущес&shy;твует, тем больше веро&shy;ят&shy;ность того, что он будет сущест&shy;во&shy;вать все время работы при&shy;ло&shy;же&shy;ния. Поэ&shy;тому сущес&shy;твует три поко&shy;ле&shy;ния. Нуле&shy;вое поко&shy;ле&shy;ние  &mdash;  это между вре&shy;ме&shy;нем соз&shy;да&shy;ния объ&shy;екта и бли&shy;жай&shy;шим GC. Объектов не успе&shy;вает нако&shy;пится слиш&shy;ком много и GC успе&shy;вает их быс&shy;тро убрать, не зале&shy;зая в осталь&shy;ную кучу.</p>
<div class="paragraph-right-side">39</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">40</div>
<p >
Пер&shy;вое поко&shy;ле&shy;ние живет между пер&shy;вым и вто&shy;рым GC. Соот&shy;ветст&shy;венно, для тех, кто не ушел во вто&shy;рое. Опти&shy;ми&shy;за&shy;ция какая: нуле&shy;вое соби&shy;рать быс&shy;тро, пер&shy;вое  &mdash;  чуть подольше. Это пос&shy;лед&shy;няя воз&shy;мож&shy;ность GC соб&shy;рать объ&shy;ект, прежде чем он ушел во вто&shy;рое, огром&shy;ное, поко&shy;ле&shy;ние. Если объ&shy;ект ушел во вто&shy;рое поко&shy;ле&shy;ние, то, ско&shy;рее всего, он будет жить долго. Туда можно редко обра&shy;щаться. А пер&shy;вое  &mdash;  для объ&shy;екта, кото&shy;рый слу&shy;чайно ушел в пер&shy;вое поко&shy;ле&shy;ние, но на самом деле он корот&shy;ко&shy;жи&shy;ву&shy;щий. Это такая опти&shy;ми&shy;за&shy;ция, чтобы его во вто&shy;ром не ловить. И вто&shy;рое поко&shy;ле&shy;ние для тех, кто решил пожить подольше и если GC туда при&shy;шел, то он там оста&shy;нется рабо&shy;тать надолго.</p>
<div class="paragraph-right-side">40</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">41</div>
<p >
Оран&shy;же&shy;вые кубики  &mdash;  это руты. Руты  &mdash;  это точки, отно&shy;си&shy;тельно кото&shy;рых, если обхо&shy;дить граф, то гаран&shy;ти&shy;ро&shy;ванно вы обой&shy;дете все объ&shy;екты, кото&shy;рыми поль&shy;зу&shy;ется прог&shy;рамма. Если бы фаза мар&shy;ки&shy;ровки рабо&shy;тала на всех поко&shy;ле&shy;ниях, то она бы рабо&shy;тала долго. Поэ&shy;тому она рабо&shy;тает мак&shy;си&shy;мально на самых млад&shy;ших. Если мы решили, что соби&shy;раем нуле&shy;вое поко&shy;ле&shy;ние, то она только там и будет рабо&shy;тать. Поэ&shy;тому есть три типа ссы&shy;лок.  Пер&shy;вый тип  &mdash;  ссылка внутри одного поко&shy;ле&shy;ния. Нап&shy;ри&shy;мер, если мы с рута пришли в нуле&shy;вое поко&shy;ле&shy;ние, а дальше у нас ссылка из этого объ&shy;екта, но опять в нуле&shy;вое поко&shy;ле&shy;ние. Это внут&shy;рен&shy;няя ссылка.   Вто&shy;рой тип ссы&shy;лок  &mdash;  это ссылка из более стар&shy;шего поко&shy;ле&shy;ния в более млад&shy;шее поко&shy;ле&shy;ние. Older-to-younger. Он харак&shy;те&shy;ри&shy;зу&shy;ется тем, что объ&shy;ект, на кото&shy;рый мы ссы&shy;ла&shy;емся из пер&shy;вого поко&shy;ле&shy;ния нет имеет ссылки с рута в нуле&shy;вом поко&shy;ле&shy;нии. Это зна&shy;чит, что если мы будем мар&shy;ки&shy;ро&shy;вать только нуле&shy;вое поко&shy;ле&shy;ние, чтобы на нем GC отра&shy;бо&shy;тал, то мы про&shy;пус&shy;тим этот объ&shy;ект. Мы дол&shy;жны знать о сущест&shy;во&shy;ва&shy;нии ссылки с более стар&shy;шего поко&shy;ле&shy;ния.</p>
<div class="paragraph-right-side">41</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">42</div>
<p >
Тре&shy;тий вид ссы&shy;лок  &mdash;  это ссылка из млад&shy;шего в стар&shy;шее поко&shy;ле&shy;ние. Для нас она не важна. Если мы соби&shy;раем нуле&shy;вое поко&shy;ле&shy;ние   &mdash;  она не имеет зна&shy;че&shy;ние. При сборке более стар&shy;ших поко&shy;ле&shy;ний, млад&shy;шие тоже соби&shy;ра&shy;ются. Почему? Если соби&shy;раем, нап&shy;ри&shy;мер, пер&shy;вое  &mdash;  оно больше, круп&shy;нее. И, пос&shy;кольку, нуле&shy;вое поко&shy;ле&shy;ние соби&shy;ра&shy;ется нам&shy;ного чаще, то есть высо&shy;кая сте&shy;пень веро&shy;ят&shy;ности, что после сборки пер&shy;вого будет соб&shy;рано и нуле&shy;вое. И GC опять запус&shy;тится. Для того, чтобы два раза не ходить за одним и тем же, пере&shy;со&shy;би&shy;ра&shy;ются и более млад&shy;шие поко&shy;ле&shy;ния. В этом слу&shy;чае нам нужно знать ссылку из млад&shy;шего в стар&shy;шие? Нам это без раз&shy;ницы, она и так есть. При сборке вто&shy;рого поко&shy;ле&shy;ния та же самая ситу&shy;а&shy;ция. С точки зре&shy;ния фазы мар&shy;ки&shy;ровки нам важны ссылки внутри поко&shy;ле&shy;ния и ссылки с более стар&shy;ших на наше поко&shy;ле&shy;ние.</p>
<div class="paragraph-right-side">42</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">43</div>
<p >
Если мы нахо&shy;димся в нуле&shy;вом поко&shy;ле&shy;нии  &mdash;  как узнать о том, что на нас есть ссылка с более стар&shy;шего поко&shy;ле&shy;ния. Есть меха&shy;низм, кото&shy;рый в начале изу&shy;че&shy;ния начи&shy;нает нем&shy;ного пугать. Есть такой код (см. слайд) 35:19.</p>
<div class="paragraph-right-side">43</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">44</div>
<p >
Кстати, такие сце&shy;на&shy;рии работы GC можно про&shy;ве&shy;рять таким спо&shy;со&shy;бом: мы соз&shy;даем объ&shy;ект, делаем GC.Collect(), отправ&shy;ляем его в пер&shy;вое поко&shy;ле&shy;ние. Мы знаем, что он туда уйдет. Дальше соз&shy;даем ссылку и тем самым фак&shy;ти&shy;чески соз&shy;даем ссылку из стар&shy;шего поко&shy;ле&shy;ния в млад&shy;шее. Если дома захо&shy;чется с чем-то поиг&shy;рать, то с помощью метода GC.Collect() можно смо&shy;де&shy;ли&shy;ро&shy;вать такие ситу&shy;а&shy;ции.</p>
<div class="paragraph-right-side">44</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">45</div>
<p >
Что мы здесь видим? У нас есть x, GC.Collect(), инс&shy;танс класса Foo ухо&shy;дит в поко&shy;ле&shy;ние один из нуле&shy;вого. И дальше x.field прис&shy;ва&shy;и&shy;ваем new Boo(). Это зна&shy;чит, что объ&shy;ект типа Foo начи&shy;нает ссы&shy;латься на новый инс&shy;танс объ&shy;екта типа Boo. То есть из пер&shy;вого в нуле&shy;вого. Это у нас older-to-younger link.</p>
<div class="paragraph-right-side">45</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">46</div>
<p >
Что про&shy;ис&shy;хо&shy;дит в .NET. В месте прис&shy;ва&shy;и&shy;ва&shy;ния, джит&shy;тер, то есть там не просто прис&shy;ва&shy;и&shy;ва&shy;ние, а прис&shy;ва&shy;и&shy;ва&shy;ние с про&shy;вер&shy;кой. Эта тех&shy;ника назы&shy;ва&shy;ется Write Barrier и Remem&shy;bered Set. В .NET она назы&shy;ва&shy;ется нем&shy;ного по-дру&shy;гому. Если у нас звезды сош&shy;лись, что нужно запом&shy;нить эту ссылку, то мы запо&shy;ми&shy;наем ее во внут&shy;рен&shy;ней струк&shy;туре джита.</p>
<div class="paragraph-right-side">46</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">47</div>
<p >
Что это за усло&shy;вие? Зна&shy;че&shy;ние  &mdash;  это ссылка на экземп&shy;ляр .NET класса. Точка прис&shy;ва&shy;и&shy;ва&shy;ния нахо&shy;дится в управ&shy;ля&shy;е&shy;мой куче и имеет более стар&shy;шее поко&shy;ле&shy;ние, чем адрес прис&shy;ва&shy;и&shy;ва&shy;е&shy;мого объ&shy;екта. Когда мы делаем вот так (см. слайд 37:29), джит&shy;тер допол&shy;ни&shy;тельно про&shy;ве&shy;ряет, что слева поко&shy;ле&shy;ние старше, чем справа. Если старше, то он запо&shy;ми&shy;нает адреса во внут&shy;рен&shy;них струк&shy;ту&shy;рах, убеж&shy;да&shy;ется, что с левой части на пра&shy;вую есть ссылка. Это нужно для даль&shy;ней&shy;шей сборки мусора. На фазе мар&shy;ки&shy;ровки отме&shy;ча&shy;ется выб&shy;ран&shy;ное поко&shy;ле&shy;ние и если у нас есть ссылки в Remem&shy;bered Set, если мы запом&shy;нили, что где-то сох&shy;ра&shy;няли ссылку из пер&shy;вого в нуле&shy;вое поко&shy;ле&shy;ние, они тоже ста&shy;но&shy;вятся кор&shy;нями, чтобы пройти мар&shy;ки&shy;ровку. Но хип полу&shy;ча&shy;ется в итоге огром&shy;ный и ста&shy;но&shy;вится страш&shy;но&shy;вато.</p>
<div class="paragraph-right-side">47</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">48</div>
<p >
Поэ&shy;тому исполь&shy;зу&shy;ется более опти&shy;ми&shy;зи&shy;ро&shy;ван&shy;ный спо&shy;соб. Он назы&shy;ва&shy;ется меха&shy;низм кар&shy;точ&shy;ного стола. Зна&shy;ния об этом меха&shy;низме не так расп&shy;рост&shy;ра&shy;нены. Как он рабо&shy;тает? Если взять адрес&shy;ное прост&shy;ранство всего огром&shy;ного хипа, весь кусок памяти, то сбоку есть кар&shy;точ&shy;ный стол. Это, грубо говоря, мас&shy;сив чисел. Где каж&shy;дый бит мас&shy;сива отве&shy;чает за опре&shy;де&shy;лен&shy;ный диа&shy;па&shy;зон памяти. Если бит выс&shy;тав&shy;лен в еди&shy;ницу, зна&shy;чит в этом диа&shy;па&shy;зоне памяти есть ссылка на млад&shy;шее поко&shy;ле&shy;ние. То есть это мас&shy;сив приз&shy;на&shy;ков ссы&shy;лок на млад&shy;шее поко&shy;ле&shy;ние. См. слайд  &mdash;  40:12</p>
<div class="paragraph-right-side">48</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">49</div>
<p >
У нас есть память, внизу кар&shy;точ&shy;ный стол. У нас поя&shy;ви&shy;лась ссылка, слева на право. Это зна&shy;чит, что бит дол&shy;жен быть выс&shy;тав&shy;лен в еди&shy;ницу. Потому что от более стар&shy;шего поко&shy;ле&shy;ния пошла ссылка в более млад&shy;шее.   Каж&shy;дый бит кар&shy;точ&shy;ного стола отве&shy;чает за 128 байт в x86 и за 256 байт в x64. Это, по сути, 32 машин&shy;ных слова. Машин&shy;ное слово  &mdash;  это то, с чем рабо&shy;тает про&shy;цес&shy;сор.</p>
<div class="paragraph-right-side">49</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">50</div>
<p >
Если учесть, что каж&shy;дый пус&shy;той объ&shy;ект, мак&shy;си&shy;мально малень&shy;кий (нап&shy;ри&shy;мер, new Object) зани&shy;мает четыре машин&shy;ных слова в сред&shy;нем, то полу&shy;ча&shy;ется, что один бит кар&shy;точ&shy;ного стола перек&shy;ры&shy;вает десять объ&shy;ек&shy;тов. И если хотя бы с одного из них есть ссылка в млад&shy;шее поко&shy;ле&shy;ние, то GC дол&shy;жен при обходе в фазе мар&shy;ки&shy;ровки зайти по этому адресу и прос&shy;мот&shy;реть все десять объ&shy;ек&shy;тов и найти те, кото&shy;рые ссы&shy;ла&shy;ются на млад&shy;шее поко&shy;ле&shy;ние. Один байт перек&shy;ры&shy;вает уже 1,2 КБ опе&shy;ра&shy;тив&shy;ной памяти. Или 80 объ&shy;ек&shy;тов. Четыре байта  &mdash;  320 объ&shy;ек&shy;тов. Это x86 архи&shy;тек&shy;тура. Полу&shy;ча&shy;ется жир&shy;но&shy;вато, если ссылка поя&shy;ви&shy;лась.</p>
<div class="paragraph-right-side">50</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">51</div>
<p >
Как это рабо&shy;тает. Можно пос&shy;мот&shy;реть код, кото&shy;рый будет выз&shy;ван при прис&shy;ва&shy;и&shy;ва&shy;нии (см. слайд 43:24) по этому адресу на github. Там ассемб&shy;ле&shy;ровс&shy;кий код, он дос&shy;та&shy;точно прос&shy;той, разоб&shy;раться в нем легко. Есть много ком&shy;мен&shy;та&shy;риев, гораздо больше, чем кода.</p>
<div class="paragraph-right-side">51</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">52</div>
<p >
Реа&shy;ли&shy;за&shy;ция сильно зави&shy;сит от осо&shy;бен&shy;нос&shy;тей. У нас есть Work&shy;st&shy;ation GC, есть сер&shy;вер&shy;ный GC. У Work&shy;st&shy;ation есть две вер&shy;сии: до и после роста кучи. Как след&shy;с&shy;твие, пере&shy;ме&shy;ща&shy;ется gen_1 gen_0. И Server GC: есть нес&shy;колько хипов для SOH и нес&shy;колько для LOH. Там свои реа&shy;ли&shy;за&shy;ции этих мето&shy;дов прис&shy;ва&shy;и&shy;ва&shy;ния, потому что при&shy;дется пара&shy;мет&shy;ри&shy;зо&shy;вать для какой кучи идет вызов. А так он просто гене&shy;ри&shy;рует ставку для новой кучи и все хорошо. Плюс две реа&shy;ли&shy;за&shy;ции под x64. Если смот&shy;реть базо&shy;вую, то будет при&shy;мерно так (см. слайд 44:36). Регистр RCX  &mdash;  это адрес filed. Адрес тар&shy;гета, куда мы прис&shy;ва&shy;и&shy;ваем. RDX  &mdash;  это ссылка на объ&shy;ект. Когда мы прис&shy;ва&shy;и&shy;вали, дол&shy;жна быть сос&shy;тав&shy;лена эта инстр&shy;укция и больше ничего. Но на самом деле нет. Прис&shy;во&shy;или и дальше этим кодом мы про&shy;ве&shy;ряем, нахо&shy;дится ли пра&shy;вая часть прис&shy;ва&shy;и&shy;ва&shy;ния внутри эфе&shy;мер&shy;ного сег&shy;мента (gen_0, gen_1). И если нахо&shy;дится, то мы берем кар&shy;точ&shy;ный стол, делим на 2048, полу&shy;чаем адрес ячейки и если флаг не выс&shy;тав&shy;лен, то выс&shy;та&shy;вить.</p>
<div class="paragraph-right-side">52</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">53</div>
<p >
Здесь есть две осо&shy;бен&shy;ности. Пер&shy;вая   &mdash;  почему просто не выс&shy;та&shy;вить? Это будет очень долго. Опе&shy;ра&shy;ция записи нам&shy;ного дольше, чем чте&shy;ния. Чте&shy;ние про&shy;ис&shy;хо&shy;дит из кеша, а чтобы запи&shy;сать надо запи&shy;сать кроме кеша еще и в опе&shy;ра&shy;тив&shy;ную память. Поэ&shy;тому их про&shy;ве&shy;ряем. Инте&shy;ресна про&shy;це&shy;дура выс&shy;тав&shy;ле&shy;ния флага. Он выс&shy;тав&shy;ля&shy;ется сразу же 0FF. То есть мы выс&shy;тав&shy;ляем не один флаг, а сразу груп&shy;пой. Почему? Когда мы будем дальше про&shy;ве&shy;рять ссылку из стар&shy;шего поко&shy;ле&shy;ния в млад&shy;шее, нам поби&shy;тово будет долго про&shy;ве&shy;рять. Проще сразу сло&shy;вами делать про&shy;верку. Вместо того, чтобы смот&shy;реть, на каком бите ссылка и какие 2 КБ смот&shy;реть, все рабо&shy;тает проще, сис&shy;тема опе&shy;ри&shy;рует более зна&shy;чи&shy;тель&shy;ными диа&shy;па&shy;зо&shy;нами.</p>
<div class="paragraph-right-side">53</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">54</div>
<p >
Код, полу&shy;ча&shy;ется, про&shy;ве&shy;ряет только поко&shy;ле&shy;ние object, но не target. Target не инте&shy;ре&shy;сует. Мы про&shy;ве&shy;ряем только то, что мы попали в нуле&shy;вое или пер&shy;вое поко&shy;ле&shy;ние. В любом этом слу&shy;чае выс&shy;тав&shy;ля&shy;ется бит в кар&shy;точ&shy;ном столе. Когда мы про&shy;ве&shy;ряем нуле&shy;вое поко&shy;ле&shy;ние, будем про&shy;хо&shy;дится по кар&shy;точ&shy;ному столу, кото&shy;рый отно&shy;сится и к пер&shy;вому, и ко вто&shy;рому поко&shy;ле&shy;нию. Нас устроит, что биты выс&shy;тав&shy;лены. Если пер&shy;вое поко&shy;ле&shy;ние будем прос&shy;мат&shy;ри&shy;вать с нуле&shy;вым, соби&shy;рать там мусор и у пер&shy;вого и вто&shy;рого, то мы будем прос&shy;мат&shy;ри&shy;вать кар&shy;точ&shy;ный стол вто&shy;рого поко&shy;ле&shy;ния. Там тоже эти биты будут выс&shy;тав&shy;лены. Поэ&shy;тому мы левую часть смот&shy;рим, и не имеет зна&shy;че&shy;ния пер&shy;вого или вто&shy;рого поко&shy;ле&shy;ния. Дальше фил&shy;ьтрация уже идет на ста&shy;дии про&shy;верки.</p>
<div class="paragraph-right-side">54</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">55</div>
<p >
Однако, кар&shy;точ&shy;ный стол в слу&shy;чае боль&shy;шого хипа (у LOH он может быть фее&shy;ри&shy;чес&shy;ких раз&shy;ме&shy;ров) тоже будет огром&shy;ным. И по нему точно так же будет идти ска&shy;ни&shy;ро&shy;ва&shy;ние. Мы соби&shy;раем нуле&shy;вое поко&shy;ле&shy;ние и дол&shy;жны уло&shy;житься в нес&shy;колько мил&shy;ли&shy;се&shy;кунд, а у нас хип в нес&shy;колько сотен ГБ. Нап&shy;ри&shy;мер, это сер&shy;вер. Кар&shy;точ&shy;ный стол при&shy;дется ска&shy;ни&shy;ро&shy;вать весь, а это долго. Выход  &mdash;  дву&shy;ху&shy;ров&shy;не&shy;вый кар&shy;точ&shy;ный стол. Назы&shy;ва&shy;ется это Cards Bundle Table. Это еще один мас&shy;сив, где бит отве&shy;чает за 32 слова карт. Этот мас&shy;сив опе&shy;ри&shy;рует огром&shy;ными диа&shy;па&shy;зо&shy;нами. Полу&shy;ча&shy;ется, 1 бит Cards Bundle Table отве&shy;чает за 128 Кб на x86 и за 256 Кб на x64. Одна ячейка   &mdash;  4 байта, это 8 Мб карт целе&shy;вой памяти.</p>
<div class="paragraph-right-side">55</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">56</div>
<p >
Когда мы будем делать GC, соби&shy;рая нуле&shy;вое поко&shy;ле&shy;ние, надо пос&shy;мот&shy;реть, что с пер&shy;вого и вто&shy;рого есть что-то полез&shy;ное и далее мы ухо&shy;дим в Cards Bundle Table. Ска&shy;ни&shy;руем, и если где-то не ноль, то пере&shy;хо&shy;дим на кар&shy;точ&shy;ный стол, в соот&shy;вет&shy;с&shy;твующий его диа&shy;па&shy;зон и ищем нену&shy;ле&shy;вую ячейку. И потом уже пере&shy;хо&shy;дим в нуж&shy;ный диа&shy;па&shy;зон памяти и ска&shy;ни&shy;руем объ&shy;екты, кото&shy;рые там нахо&shy;дятся, в поис&shy;ках ссылки со стар&shy;шего на млад&shy;шее поко&shy;ле&shy;ние. И только тогда мы эту ссылку добав&shy;ляем в руты и мар&shy;ки&shy;руем все объ&shy;екты, на кото&shy;рые эта ссылка ведет.</p>
<div class="paragraph-right-side">56</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">57</div>
<p >
Есть малень&shy;кая опти&shy;ми&shy;за&shy;ция для Windows. Эта сис&shy;тема пос&shy;тро&shy;ена, в пер&shy;вую оче&shy;редь, на архи&shy;тек&shy;туре x86, где исполь&shy;зу&shy;ются меха&shy;низмы вир&shy;ту&shy;а&shy;ли&shy;за&shy;ции памяти про&shy;цес&shy;сора, кото&shy;рая осно&shy;вана на стра&shy;ни&shy;цах памяти. Она поде&shy;лена на зоны, на стра&shy;нички. Можно выс&shy;та&shy;вить флаг <code>MEM_WRITE_WATCH</code>. Это озна&shy;чает, что если кто-то будет писать по задан&shy;ному диа&shy;па&shy;зону, то можно под&shy;пи&shy;саться на обнов&shy;ле&shy;ния. Мы сде&shy;лали мас&shy;сив и если туда кто-то будет писать, у нас будет дер&shy;гаться метод из <em>WinApi</em>. Почему мы не видим этого когда в ассемб&shy;ле&shy;ровс&shy;ком методе расс&shy;та&shy;новки  карт? Когда мы запи&shy;сы&shy;ваем, выс&shy;тав&shy;ляя карты, Windows полу&shy;чает ноти&shy;фи&shy;ка&shy;цию от стра&shy;ницы, куда мы пишем, и исходя из этого прос&shy;тав&shy;ляет бит в <code>Cards Bundle Table</code>.</p>
<div class="paragraph-right-side">57</div>
</div>
<div class="paragraph-container">
<div class="paragraph-left-side">58</div>
<p >
Базо&shy;вый вывод, кото&shy;рый можно сде&shy;лать уже сей&shy;час, осно&shy;вы&shy;ва&shy;ясь на кар&shy;точ&shy;ных сто&shy;лах, что если вы хотите, чтобы GC про&shy;те&shy;кал быс&shy;тро и как по маслу, не стоит делать ссы&shy;лок из стар&shy;ших поко&shy;ле&shy;ний. Не надо делать вечно живу&shy;щие мас&shy;сивы, выде&shy;лять объ&shy;екты и ссылки на них скла&shy;ды&shy;вать в эти древ&shy;ние мас&shy;сивы. Но если вы так дела&shy;ете, надо конт&shy;ро&shy;ли&shy;ро&shy;вать, чтобы эти мас&shy;сивы рас&shy;по&shy;ла&shy;га&shy;лись рядом, чтобы их выде&shy;лять друг за дру&shy;гом. Не расп&shy;ре&shy;де&shy;лять их по памяти. Самое неудач&shy;ное, что можно сде&shy;лать  &mdash;  это иметь кучу объ&shy;ек&shy;тов стар&shy;шего поко&shy;ле&shy;ния и по какой-то при&shy;чине выс&shy;та&shy;вить ссылки на млад&shy;шее поко&shy;ле&shy;ние, но не груп&shy;пой, а вразб&shy;рос через всю память. Это самый тяже&shy;лый сце&shy;на&shy;рий, потому что кар&shy;точ&shy;ный стол будет забит еди&shy;ни&shy;цами. А GC, соби&shy;рая нуле&shy;вое поко&shy;ле&shy;ние, будет вынуж&shy;ден про&shy;хо&shy;дить все вто&shy;рое, все пер&shy;вое и искать, что там добав&shy;лено. Если вы дела&shy;ете ссылку из стар&shy;ших поко&shy;ле&shy;ний в млад&shy;шие, то необ&shy;хо&shy;димо эти ссылки груп&shy;пи&shy;ро&shy;вать: мас&shy;сив, кото&shy;рый ссы&shy;ла&shy;ется на объ&shy;ект млад&shy;шего поко&shy;ле&shy;ния. Пос&shy;кольку это мас&shy;сив, кото&shy;рый ссы&shy;ла&shy;ется на объ&shy;екты млад&shy;шего поко&shy;ле&shy;ния, все ячейки рядом и в кар&shy;точ&shy;ном столе в иде&shy;але это будет просто еди&shy;ница. Дальше мы будем изу&shy;чать более под&shy;робно.</p>
<div class="paragraph-right-side">58</div>
</div>

        </div>
        <footer>
            <div class="footer-container">
                <div class="footer-wrap">
                    <img src="../../res/img/logo-w-noindex.svg">
                    <p>
                        <a class="footer-link" target="_blank" href="mailto:sidristij@clrium.ru"><i class="far fa-envelope" aria-hidden="true"></i></a>
                        <a class="footer-link" target="_blank" href="https://vk.com/clrium"><i class="fab fa-vk" aria-hidden="true"></i></a>
                        <a class="footer-link" target="_blank" href="https://youtube.com/clrium"><i class="fab fa-youtube" aria-hidden="true"></i></a>
                        <a class="footer-link" target="_blank" href="https://github.com/clrium"><i class="fab fa-github" aria-hidden="true"></i></a>
                        <a class="footer-link" target="_blank" href="skype:stanislav.sidristyi"><i class="fab fa-skype" aria-hidden="true"></i></a>
                        <a class="footer-link" target="_blank" href="https://t.me/clrium_group"><i class="fab fa-telegram" aria-hidden="true"></i></a>
                    </p>
                </div>
            </div>
        </footer>
    </div>
</body>
</html>